define(["backbone","model/token-data","view/content","view/popup","model/quest/actionpoint-model","model/data","model/quest/create-quest-model","util/navigate","util/language-message","constant/event"],function(a,b,c,d,e,f,g,h,i,j){var k=[712914,712924,712934,712954,713061,744514,744524,744534,744544,744554,744681],l=0,m=23,n=27,o=21,p=c.extend({isProgress:!1,isRiddle:!1,questType:null,sceneId:null,raidId:null,returnPoint:null,QUEST_TYPE_MULTI:1,isGetTreasureQuest:!1,isGetDropItem:!1,isOpenEvent:!1,CAUTION_FLAGMENT_OVER_LIMIT:"overLimit",CAUTION_FLAGMENT_RETURN_COLLECT_ITEM:"returnCollectItem",init:function(a){var b=null;"undefined"!=typeof a&&(b=a),this.questListInitModel=new(f.extend({urlRoot:Game.baseUri+"quest/init_list/"+b}))},actionpointCheck:function(a,b){var c=$(a.currentTarget);this.questId=c.data("quest-id"),this.questType=c.data("type"),this.quest_ap=c.data("ap"),this.title=c.find(".txt-quest-title").text(),this.synopsis=c.find("#synopsis").val(),this.sceneId=c.data("arcarum-character-id")?this.sceneId:c.data("scene-id"),this.isRiddle=!!c.data("is-riddle"),this.isClear=!!c.data("is-clear"),this.isSkipResult=!!c.data("is-result-skip"),this.isSceneOnly=c.data("scene-only")||0,this.isWithoutSummon=c.data("without-summon")||0;var d=c.data("quest-name")||c.data("chapter-name");window.questIsStartAtOnce=this.isStartAtOnce=c.data("start-at-once")||0,this.isStartAtOnce&&(window.startAtOnceCreateQuest=function(){g.startAtOnceCreateQuest()}),this.progressQuestidsArr=this.questListInitModel.get("progress_quest_ids");var f=null;if(0<=this.progressQuestidsArr.indexOf(String(this.questId))&&(f=this.isProgress?1:null),this.actionpointModel=new e({quest_id:this.questId,progress:f,type:this.questType,quest_ap:this.quest_ap,chapter_name:d}),this.isRetryQuest===!0)this.actionpointModel.check_quest(b),this.listenEventAndCall("completeUseRecoveryItems",$("#wrapper"),b);else{var g=this;this.setReturnPoint(this.questId,function(){g.actionpointModel.check_quest(b),g.listenEventAndCall("completeUseRecoveryItems",$("#wrapper"),b)})}},locationSupporter:function(){if(this.isSceneOnly||(this.isSceneOnly=0),this.isStartAtOnce||(this.isStartAtOnce=0),this.isWithoutSummon||(this.isWithoutSummon=0),1==this.isSceneOnly)if(+this.quest_ap>0){this.popView=new d({className:"pop-use-ap-scene",title:i.getMessage("quest_abstract_1"),body:i.replaceMessage("quest_abstract_3",[this.quest_ap]),flagBtnCancel:1,flagBtnOk:1});var b=this;if(this.popView.off("ok"),this.popView.on("ok",function(){b.sceneOnlyCreateQuest()}),this.popView.off("cancel"),this.popView.on("cancel",function(){b.popRemove(),b.trigger("cancelPopUseApScene")}),this.popView.render().popShow(),0!=$(".prt-event-quest-intro").length){var c=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-use-ap-scene").css("top"));$(".pop-use-ap-scene").css("top",c+"px")}}else Game.loading.xhrStart(),this.sceneOnlyCreateQuest();else if(1==this.isStartAtOnce)if(+this.quest_ap>0){var e=0===+this.isWithoutSummon?"quest_abstract_2":"quest_without_summon_1",f=this.isRetryQuest===!0?"retry-quest":null;this.popView=new d({className:"pop-startatonce",title:i.getMessage("quest_abstract_1"),body:i.replaceMessage(e,[this.quest_ap]),flagBtnCancel:1,flagBtnOk:1,btnOkClassName:f});var b=this;if(this.popView.off("ok"),this.popView.on("ok",function(){b.startAtOnceCreateQuest()}),this.popView.off("cancel"),this.popView.on("cancel",function(){b.popRemove()}),this.popView.render().popShow(),0!=$(".prt-event-quest-intro").length){var c=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-startatonce").css("top"));$(".pop-startatonce").css("top",c+"px")}}else if(this.isRetryQuest===!0&&0===+this.isWithoutSummon){var b=this,g=new d({className:"pop-startatonce",title:i.getMessage("quest_abstract_1"),body:i.getMessage("pop_startatonce_no_ap_1"),flagBtnCancel:1,flagBtnOk:1,btnOkClassName:"retry-quest"});g.render().popShow(),g.listenToOnce(g,"ok",function(){b.stopListening(g,"cancel"),b.startAtOnceCreateQuest()}),g.listenToOnce(g,"cancel",function(){b.stopListening(g,"ok"),g.popRemove()})}else Game.loading.xhrStart(),this.startAtOnceCreateQuest();else if(this.content_close(),this.isGetTreasureQuest&&this.supporterHashName&&this.supporterHashParam){var h="quest/supporter/"+this.supporterHashName+"/"+this.questId+"/"+this.questType+this.supporterHashParam;this.treasureId&&(h+="/"+this.treasureId),a.history.navigate(h,!0)}else this.treasureId?a.history.navigate("quest/supporter/"+this.questId+"/"+this.questType+"/0/"+this.treasureId,!0):this.jobDomain?a.history.navigate("quest/supporter/"+this.questId+"/"+this.questType+"/0/0/"+this.jobDomain,!0):a.history.navigate("quest/supporter/"+this.questId+"/"+this.questType,!0)},setReturnPoint:function(a,c){this.returnPointModel=new(b.extend({urlRoot:Game.baseUri+"quest/set_return_point"})),this.stopListening(this.returnPointModel,"sync"),this.listenToOnce(this.returnPointModel,"sync",function(){c()}),this.returnPointModel.set({returnPoint:this.returnPoint,questId:a,page:+$("#bookmark_page_current").val()||1}),this.returnPointModel.save()},startAtOnceCreateQuest:function(){var a=$("#cnt-quest").data("duplicate-key"),b={deck_id:null,quest_id:this.questId,quest_type:this.questType,supporter_user_id:"",supporter_attribute_id:"",duplicate_key:a},c=new g;this.stopListening(c,"sync"),this.listenToOnce(c,"sync",this.locationDirectQuest),c.set(b),c.save()},sceneOnlyCreateQuest:function(){var a=$("#cnt-quest").data("duplicate-key")||$("#cnt-detail").data("duplicate-key"),b={deck_id:null,quest_id:this.questId,quest_type:this.questType,supporter_user_id:"",supporter_attribute_id:"",duplicate_key:a},c=new g;this.stopListening(c,"sync"),this.listenToOnce(c,"sync",this.locationSceneOnlyQuest),c.set(b),c.save()},locationDirectQuest:function(a){"ok"==a.get("result")?(window.questIsStartAtOnce&&(delete window.questIsStartAtOnce,delete window.startAtOnceCreateQuest),this.content_close(),h.hash("quest/stage",{refresh:!0})):(Game.loading.xhrEnd(),this.faildCreateQuestPop(a))},locationSceneOnlyQuest:function(b){if(1===this.isSceneSkipFlg&&this.isRiddle===!0&&this.isClear===!0)return this.content_close(),void a.history.navigate("quest/stage",!0);if(this.isSkipResult===!0)return this.content_close(),void h.hash("quest/scene/"+this.sceneId+"/"+n,{refresh:!0});if("ok"==b.get("result")&&this.sceneId){this.content_close();var c=this.isRiddle===!0?l:m;h.hash("quest/scene/"+this.sceneId+"/"+c,{refresh:!0})}else Game.loading.xhrEnd(),this.faildCreateQuestPop(b)},faildCreateQuestPop:function(a){var b="",c=i.getMessage("quest_12"),e="",f=a.get("ng_attribute_names");if(f){b=i.getMessage("quest_13");var g=f.split(",");_.each(g,function(a){e+=a+i.replaceMessage("quest_14",[values])})}var h=a.get("ng_npc_names");if(h){b=i.getMessage("quest_15");var j=h.split(",");_.each(j,function(a){e+=a+"<br>"})}var k=a.get("ng_summon_names");if(k){b=i.getMessage("quest_limitation_summon_1"),c=i.getMessage("quest_limitation_summon_2");var l=k.split(",");_.each(l,function(a){e+=a+"<br>"})}var m=a.get("equipped_material_weapon_names");m&&(b=i.getMessage("quest_limitation_weapon_1"),c=i.getMessage("quest_limitation_weapon_2"),e=m.join("<br>"));var n=0,o=a.get("start_attribute_names");o&&(b=i.getMessage("quest_16"),o=o.split(","),_.each(o,function(a){e+=a+i.replaceMessage("quest_14",[values])}),n++);var p=a.get("start_npc_names");if(p){b=i.getMessage("quest_18");var q=p.split(",");_.each(q,function(a){e+=a+"<br>"}),n++}var r=a.get("start_rarity_names");if(r){b=i.getMessage("quest_19");var s=r.split(",");_.each(s,function(a){e+=a+"<br>"}),n++}var t=a.get("start_tribe_names");if(t){b=i.getMessage("quest_20");var u=t.split(",");_.each(u,function(a){e+=a+"<br>"}),n++}var v=a.get("start_job_names");v&&(b=i.getMessage("quest_limitation_job_1"),e+=v+"<br>",n++),1==a.get("quest_once_flag")&&"undefined"==a.get("ng_npc_time_over")&&(e+=i.getMessage("quest_21")),n>0&&(c=i.getMessage("quest_22")),n>1&&(b=i.getMessage("quest_23"));var w=a.get("ng_use_item");1==w&&(b=i.getMessage("quest_24"));var x=a.get("ng_use_deck");1==x&&(b=i.getMessage("quest_25"));var y=new d({className:"pop_ng_attribute",title:i.getMessage("quest_135"),body:_.template($("#tpl-pop-caution").html(),{condition:c,errMessage:b,ngNames:e,ngUseDeck:x}),flagBtnCancel:0,flagBtnClose:m?1:0,flagBtnOk:1});if(y.on("ok",function(){y.popRemove()}),this.listenToOnce(y,"close",function(){y.popRemove()}),y.render(),m&&y.$el.find(".btn-usual-ok").addClass("btn-usual-party").removeClass("btn-usual-ok").attr("data-href","party/index/0/weapon/0"),y.popShow(),1==w&&y.$el.find(".prt-np .txt-ng").css("display","none"),0!=$("#cnt-progress").find(".prt-event-quest-intro").length){var z=y.$el.find(".pop_ng_attribute"),A=-$(".prt-event-fv").outerHeight()+parseInt(z.css("top"));z.css("top",A+"px")}$("#cnt-quest").attr("data-duplicate-key",a.get("duplicate_key"))},startQuestCheck:function(a,b,c){Game.loading.xhrStart();var e=this,g=$(a.currentTarget),h=g.data("type"),j=g.hasClass("ico-progress")||g.hasClass("type-treasureraid-hell")&&!!g.data("is-progress"),k=g.data("chapter-id"),l=g.data("rank"),m=g.data("use_money"),n=g.data("type"),o=g.data("quest-id")||0,p=1,q=g.data("no-skill-battle")||0,r=g.hasClass("check-event-id"),s=g.data("is-pair-quest")||!1;if(this.isRetryQuest=!!g.data("retry-quest"),7==h&&(p=g.data("set-user")),j)return Game.loading.xhrEnd(),void b();var t=Game.baseUri+"quest/check_quest_start/"+k+"/"+n+"/"+o;r&&(t=t+"/"+g.data("event-id"));var u=new(f.extend({urlRoot:t}));this.stopListening(u,"sync"),this.listenToOnce(u,"sync",function(f){if(Game.loading.xhrEnd(),f.has("unopened_popup"))return void e.popUnopenedQuest(f.get("unopened_popup"));if(f.has("result")!==!1){var k=f.toJSON(),n={id:f.get("use_item_id"),name:f.get("use_item_name"),num:f.get("use_item_num"),consume:f.get("use_item_consume"),quest_ap:g.data("ap"),quest_name:g.parent(".prt-list-contents").data("quest-name"),enable:f.get("use_item_enable")};if("error_level"===f.get("result")&&0!=p)this.cautionPop(i.replaceMessage("quest_99",[l]));else if("error_cnt_not_reset"===f.get("result"))this.cautionPop(i.getMessage("quest_100"),e.CAUTION_FLAGMENT_OVER_LIMIT);else if("error_cnt"===f.get("result")&&0!=p)this.cautionPop(i.getMessage("quest_101"),e.CAUTION_FLAGMENT_OVER_LIMIT);else if("error_money"===f.get("result")&&0!=p)1==m?this.cautionPop(i.replaceMessage("quest_139",[m])):this.cautionPop(i.replaceMessage("quest_102",[m]));else if("error_unconfirmed"===f.get("result"))this.cautionPop(i.replaceMessage("quest_8",[f.get("limit_battle_count")]),"unconfirmed");else if("error_event_skip"===f.get("result"))this.cautionPop(i.getMessage("quest_71"));else if("error_start_attribute"===f.get("result")&&f.get("condition")){var o=i.getMessage("quest_69"),r=k.condition.split(",");for(var t in r)o+="<br>"+r[t];o+="</div>",this.showChapterMessageFlg=_.isUndefined(k.message)===!1&&""!==k.message,this.showChapterMessageFlg&&(o+='<div class="txt-chapter-msg">'+i.replaceMessage("pop_can_not_multi_battle_1",{"%s1":k.message,"%s2":k.condition})+"</div>"),this.cautionPop(o)}else if("other_quest_progress"===f.get("result"))this.comfirmRestartQuest(h);else if("error_deal_lock"===f.get("result")||"error_deal_unconfirmed"===f.get("result"))this.cautionPopTitle=i.getMessage("deal_rock_popup_1"),this.cautionPop(i.getMessage("deal_rock_popup_2"),"deal_unconfirmed");else if("error_job_quest_start"===f.get("result"))this.cautionPop(i.getMessage("quest_143"));else if("error_weight"===k.result){var v=g.data("difficulty");e.popDisabledReason(v)}else if(j||0==p||""===f.get("use_money")&&""===f.get("limited_count")||s!==!1)b();else{var w="",x="",y="",z=null;if(n.id)y="pop-confirm-battle pop-use-item",x=i.getMessage("quest_70"),w=_.template($("#tpl-quest-use-item").html(),n);else if(""!==f.get("use_money"))y="pop-confirm-battle",x=i.getMessage("quest_10"),w=1==f.get("use_money")?i.replaceMessage("quest_139",[f.get("use_money")])+"<br><br>"+i.getMessage("quest_103")+f.get("money"):i.replaceMessage("quest_102",[f.get("use_money")])+"<br><br>"+i.getMessage("quest_103")+f.get("money");else if(""!==f.get("limited_count")){if("undefined"!=typeof c&&c===!0)return b(),void u.fetch();y="pop-confirm-battle",x=i.getMessage("quest_10"),""!==w&&(w+="<br><br>"),w+=1<f.get("limited_count")?i.replaceMessage("quest_140",[f.get("limited_count")]):i.replaceMessage("quest_104",[f.get("limited_count")]),q&&1===+q&&(w+="<br><br>"+i.getMessage("quest_no_skill")),e.isRetryQuest&&(z="retry-quest"),g.data("popup-style-type")&&(y+=" pop-season-event"+g.data("popup-style-type"))}this.popView=new d({className:y,title:x,body:w,flagBtnCancel:1,flagBtnOk:1,btnOkClassName:z}),this.popView.render(),n.id&&!n.enable&&this.popView.$el.find(".btn-usual-ok").removeClass().addClass("prt-usual-ng"),this.popView.popShow(),_e=a,e.listenToOnce(e.popView,"ok",function(){e.stopListening(e.popView),e.trigger("popConfirmBattleOnTapOk")}),e.listenToOnce(e.popView,"cancel",function(){e.stopListening(e.popView),e.trigger("popConfirmBattleOnTapCancel")})}}}),u.fetch()},popUnopenedQuest:function(a){this.popView&&this.popRemove(),this.popView=new d({className:"pop-unopened-quest",title:a.title,body:_.template($("#tpl-pop-unopened-quest").html(),a),flagBtnClose:1}),this.popView.render().popShow(),this.popView.$el.find(".prt-popup-footer").append(_.template($("#tpl-pop-unopened-quest-button").html(),a))},cautionPop:function(a,b){var c=this,e=_.isUndefined(this.showChapterMessageFlg)===!1&&this.showChapterMessageFlg===!0;this.popView=new d({className:"pop-can-not-multi-battle",title:this.cautionPopTitle?this.cautionPopTitle:i.getMessage("quest_135"),body:a,flagBtnCancel:b===this.CAUTION_FLAGMENT_RETURN_COLLECT_ITEM?0:1,flagBtnOk:e?1:0,showStartCallback:function(){e&&c.popView.$el.find(".btn-usual-ok").addClass("to-quest-index").attr("data-href","quest/index")}}),this.popView.render(),this.popView.$el.find(".btn-usual-cancel").removeClass().addClass("btn-usual-close");var f=null;switch(b){case"multi":f=$("#tpl-btn-multi-list").html();break;case"unconfirmed":f=$("#tpl-btn-unconfirmed-list").html();break;case"deal_lock":case"deal_unconfirmed":f=$("#tpl-buttons-deal").html();break;case"fate":f=$("#tpl-btn-start-fate").html();break;case this.CAUTION_FLAGMENT_RETURN_COLLECT_ITEM:f=_.template($("#tpl-btn-return-collect-item").html(),{hash:this.collectItemData.url})}if(null!=f&&this.popView.$el.find(".prt-popup-footer").append(f),this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var g=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-can-not-multi-battle").css("top"));$(".pop-can-not-multi-battle").css("top",g+"px")}var h=this;$(".pop-can-not-multi-battle .btn-usual-close").on("tap",function(){h.popRemove()})},comfirmRestartQuest:function(a){this.popView&&this.popRemove(),this.progressQuestInfo=this.get_progress_quest_info(a);var b=1,c=0,e="",f=i.getMessage("quest_105"),g={title:this.progressQuestInfo.chapter_name};if(12==this.progressQuestInfo.quest_type)switch(+this.progressQuestInfo.quest_id){case 706811:g.title=i.getMessage("arcade_mode_1")+" NORMAL";break;case 706821:g.title=i.getMessage("arcade_mode_1")+" HARD";break;case 706831:g.title=i.getMessage("arcade_mode_1")+" EXTREME";break;default:g.title=i.getMessage("arcade_mode_1")}e=_.template($("#tpl-restart-quest").html(),g),this.progressQuestInfo.is_hostage_dead?(b=0,f=i.getMessage("quest_46")):_.isUndefined(this.questListInitModel.get("isInLobby"))===!1&&this.questListInitModel.get("isInLobby")===!0&&(b=0,c=1,f=i.getMessage("quest_lobby_pop_1"),e=$("#tpl-pop-restart-quest-lobby").html());var h=!!this.progressQuestInfo.arcarum,l=!!this.progressQuestInfo.board;h||l?(this.progressArcarumInfo=this.progressQuestInfo[h?"arcarum":"board"],g.arcarum=this.progressArcarumInfo,e=_.template($("#tpl-restart-quest-arcarum").html(),g)):+this.progressQuestInfo.quest_type===o&&(f=i.getMessage("sequencequest_progress_1"),this.isOpenEvent=g.isOpenEvent=+this.progressQuestInfo.event_status===j.EVENT_STATUS.START,e=_.template($("#tpl-restart-quest-sequence").html(),g)),this.popView=new d({className:"popRestartQuest",title:f,body:e,flagBtnCancel:b,flagBtnOk:c}),this.popView.render();var m=this.popView.$el.find(".btn-withdraw");if(7==this.progressQuestInfo.quest_type?m.text(i.getMessage("quest_106")):_.contains(k,+this.progressQuestInfo.quest_id)&&m.html(i.getMessage("riddle_text_1")),this.progressQuestInfo.is_hostage_dead){var n=i.replaceMessage("quest_retire_pop",{"%s1":this.progressQuestInfo.reason_force_retire,"%s2":g.title});this.popView.$el.find(".txt-restart").html(n),this.popView.$el.find(".prt-select .btn-usual-ok").remove(),this.popView.$el.find(".prt-popup-footer").css("height","20px")}if(this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var p=-$(".prt-event-fv").outerHeight()+parseInt($(".popRestartQuest").css("top"));$(".popRestartQuest").css("top",p+"px"),$("#tab-progress").hasClass("active")||($(".prt-3tabs div").removeClass("active"),this.$el.find(".btn-tabs").add(".cnt-event-layout").removeClass("active"),$("#tab-progress").addClass("active"),this.$el.find("#tab-progress").add("#cnt-progress").addClass("active"))}this.progressQuestInfo.is_dungeon&&1!=this.progressQuestInfo.transfer&&($(".popRestartQuest .prt-select").css("display","close"),$(".popRestartQuest .prt-popup-footer").append('<div class="btn-usual-ok restart"></div>'))},questRetire:function(){var a=new(b.extend({urlRoot:Game.baseUri+"quest/retire"}));a.set("quest_id",this.progressQuestInfo.quest_id),a.set("quest_type",this.progressQuestInfo.quest_type),this.stopListening(a,"sync"),this.listenToOnce(a,"sync",this.popQuestRetire),a.save()},questArcarumRetire:function(){this.popView&&this.popRemove(),this.popView=new d({className:"pop-arcarum-retire",title:i.getMessage("quest_107"),body:i.getMessage("arcarum_quest_4"),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow()},getRrewardInfo:function(){var a=this.progressQuestInfo,b=a.arcarum&&a.arcarum.is_tutorial,c=a.board&&a.board.is_tutorial;if(b||c)return void this.popCannotWithdrawTutorial();var d=new(f.extend({urlRoot:Game.baseUri+"quest/quest_reward_info/"+a.quest_id+"/"+a.quest_type}));this.stopListening(d,"sync"),this.listenToOnce(d,"sync",this.withdrawConfirm),d.fetch()},withdrawConfirm:function(a){this.popView&&this.popRemove();var b=a.get("lupi"),c=a.get("treasure"),e=a.get("article"),f=a.get("dungeon_point"),g=i.getMessage("quest_107");7==this.progressQuestInfo.quest_type&&(g=i.getMessage("quest_108"));var h={lupi:b,treasure1:c.wooden_box,treasure2:c.silver_box,treasure3:c.gold_box,treasure5:e,quest_type:this.progressQuestInfo.quest_type,dungeon_point:f,use_ap:a.get("use_ap"),arcarum:this.progressArcarumInfo},j="pop-result-withdraw",l=_.template($("#tpl-pop-withdraw").html(),h);!_.isUndefined(this.progressQuestInfo.arcarum)&&this.progressQuestInfo.arcarum?(j+=" arcarum",this.progressQuestInfo.arcarum.has_retire_tp===!1&&(j+=" retire")):+this.progressQuestInfo.quest_type===o&&(h.isOpenEvent=this.isOpenEvent,l=_.template($("#tpl-pop-withdraw-sequence").html(),h)),this.popView=new d({className:j,title:g,body:l,flagBtnCancel:1,flagBtnOk:1}),this.popView.render();var m=this.popView.$el.find(".btn-usual-ok");if(7==this.progressQuestInfo.quest_type?m.addClass("coop"):_.contains(k,+this.progressQuestInfo.quest_id)&&m.addClass("riddle"),this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var n=".pop-result-withdraw",p=-$(".prt-event-fv").outerHeight()+parseInt($(n).css("top"));$(n).css("top",p+"px")}},popQuestRetire:function(a){this.popView&&this.popRemove();var b=i.getMessage("quest_46"),c=i.getMessage("quest_109");7==this.progressQuestInfo.quest_type&&(b=i.getMessage("quest_110"),c=i.getMessage("quest_111")),_.isUndefined(this.progressQuestInfo.arcarum)||this.progressQuestInfo.arcarum.has_retire_tp!==!1||(b=i.getMessage("arcarum_quest_5"),c=i.getMessage("arcarum_quest_6"));var e=a.get("before"),f=a.get("after");if("undefined"!=typeof e&&(c+=i.replaceMessage("quest_42",[f-e,e,f])),this.popView=new d({className:"pop-retire",title:b,body:c,flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var g=".pop-retire",h=-$(".prt-event-fv").outerHeight()+parseInt($(g).css("top"));$(g).css("top",h+"px")}},questRestartPopupOk:function(){var a=this.progressQuestInfo,b=null,c=a.quest_id,d=a.quest_type,e=a.scene_id,f=a.raid_id,g=a.is_progress,h=a.is_multi,i=a.is_only_scene_scenario?1:0,j=a.start_at_once?1:0;this.questRestart(b,c,d,e,f,g,h,i,j)},popCannotWithdrawTutorial:function(){var a=this,b=new d({className:"pop-cannot-withdraw",title:i.getMessage("arcarum_tutorial_quest_1"),body:i.getMessage("arcarum_tutorial_quest_2"),flagBtnClose:1});b.render().popShow(),this.listenToOnce(b,"close",function(){b.popDelete(),a.removeConfirmRetire()})},questRestart:function(a,c,d,e,f,g,h,i,j,k){Game.loading.xhrStart(),this.questId=c,this.questType=d,this.sceneId=e,this.isMulti=h,this.isSceneOnly=i||0,this.isStartAtOnce=j||0;var l=this;if(g){var m=b.extend({urlRoot:Game.baseUri+"quest/update_quest_updated_at/"+this.questId}),n=new m;this.stopListening(n,"sync"),this.listenToOnce(n,"sync",function(){l.locationStage()}),n.save()}else if("undefined"!=typeof k&&k===!0)Game.loading.xhrEnd(),l.locationSupporter();else{var o=function(a){"undefined"!=typeof a&&1==a.ap_over?l.popShortageAp():l.locationSupporter()};this.actionpointCheck(a,o)}},popShortageAp:function(){var a=this;if(a.popView=new d({className:"pop-ap-notenough",title:i.getMessage("quest_38"),body:i.getMessage("quest_39"),flagBtnCancel:0,flagBtnOk:1}),a.popView.render(),a.popView.popShow(),0!=$(".prt-event-quest-intro").length){var b=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-ap-notenough").css("top"));$(".pop-ap-notenough").css("top",b+"px")}$(".pop-ap-notenough .btn-usual-ok").on("tap",function(){a.popRemove()})},popRemove:function(){this.popView.popRemove()},locationStage:function(){var a=this,b=this.questListInitModel.attributes.progress_quest_info[0];_.each(this.questListInitModel.attributes.progress_quest_info,function(c,d){a.selectedQuestId==c.quest_id&&(b=c)}),b.is_dungeon?1==b.transfer?h.hash("raid/"+b.current_raid_id,{refresh:!0}):2==b.transfer?h.hash("result/"+b.current_raid_id,{refresh:!0}):h.hash("result_dungeon/"+b.current_raid_id,{refresh:!0}):(this.content_close(),h.hash("quest/stage",{refresh:!0}))},locationRaid:function(b){this.content_close(),a.history.navigate("raid/"+b,!0)},get_progress_quest_info:function(a){var b=this.questListInitModel.get("progress_quest_info"),c=b[0];if(_.isUndefined(a)===!1&&b.length>1){var d=this;_.each(b,function(b){(+a===d.QUEST_TYPE_MULTI&&b.is_multi===!0||+a!==d.QUEST_TYPE_MULTI&&b.is_multi===!1)&&(c=b)})}return c},btnBookmarkInfo:function(a){var b=$(a.currentTarget);this.locationId=b.data("location-id"),this.questId=b.data("quest-id"),this.popupStyleType=b.data("popup-style-type"),this.isGetDropItem=!!b.data("get-drop-item"),this.bookmarkInfo()},bookmarkInfo:function(a,b,c){if(this.bookmarkLocationId=a||this.locationId,this.bookmarkQuestId=b||this.questId,this.isBookmarkExtend=c||!1,this.bookmarkLocationId&&this.bookmarkQuestId){5!==+this.bookmarkLocationId.length&&(this.bookmarkLocationId=this.bookmarkLocationId.toString().substr(0,5));var d=new(f.extend({urlRoot:Game.baseUri+"rest/bookmark/bookmark_info/"+this.bookmarkLocationId+"/"+this.bookmarkQuestId}));this.stopListening(d,"sync"),this.listenToOnce(d,"sync",this.renderBookmarkInfo),d.fetch()}},renderBookmarkInfo:function(a){var b=a.toJSON().result;if(b!==!1){this.bookmarId=b.bookmark_id,this.bookmarkChapterId=b.chapter_id,this.bookmarkCount=+b.bookmark_count,this.bookmarkMaxCount=+b.bookmark_max_count;var c={};this.popupStyleType&&(c.popupStyleType=this.popupStyleType),this.isBookmarkExtend===!0?this.popBookmarkExtend(b):this.popBookmarkInfo(b,c)}},popBookmarkInfo:function(a){this.popView&&this.popRemove(),this.popView=new d({className:"pop-bookmark-info",title:a.chapter_name,body:_.template($("#tpl-bookmark-register").html(),{bookmark:a,isGetDropItem:this.isGetDropItem,questId:this.bookmarkQuestId}),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()},popBookmarkExtend:function(a){var b=this.$el.find(".prt-bookmark-register");b.append(_.template($("#tpl-bookmark-register").html(),{bookmark:a}));var c=this.$el.find(".pop-synopsis, .pop-cleared-quest-comfirm"),d=parseInt(c.css("top"))-b.height();d>50&&c.css("top",d+"px")},btnBookmarkRegisterResult:function(){this.insertBookmarkQuest()},insertBookmarkQuest:function(){Game.loading.xhrStart();var a=new(b.extend({urlRoot:Game.baseUri+"rest/bookmark/insert_bookmark_quest"}));this.stopListening(a,"sync"),this.listenToOnce(a,"sync",this.renderInsertBookmarkQuest),a.set({location_id:+this.bookmarkLocationId,chapter_id:+this.bookmarkChapterId}),a.save()},renderInsertBookmarkQuest:function(a){var b=a.toJSON().result;b!==!1&&(this.bookmarId=b.bookmark_id,this.bookmarkCount=+b.bookmark_count,this.bookmarkMaxCount=+b.bookmark_max_count,this.updateBookmarkButton())},btnBookmarkReleaseResult:function(){this.deleteBookmarkQuest()},deleteBookmarkQuest:function(){Game.loading.xhrStart();var a=new(b.extend({urlRoot:Game.baseUri+"rest/bookmark/delete_bookmark_quest"}));this.stopListening(a,"sync"),this.listenToOnce(a,"sync",this.renderDeleteBookmarkQuest),a.set("bookmark_id",+this.bookmarId),a.save()},renderDeleteBookmarkQuest:function(a){var b=a.toJSON().result;b!==!1&&(this.bookmarId=null,this.bookmarkCount=+b.bookmark_count,this.bookmarkMaxCount=+b.bookmark_max_count,this.updateBookmarkButton())},updateBookmarkButton:function(){var a=this;this.clearTimeoutOne("updateBookmarkButton"),this.setNamedTimeout("updateBookmarkButton",function(){a.bookmarkCount>=a.bookmarkMaxCount&&!a.bookmarId?a.$el.find(".prt-bookmark-register-box").html('<div class="txt-bookmark-register">'+i.getMessage("bookmark_quest_2")+"</div>"):a.$el.find(".prt-bookmark-register-box .btn-bookmark-register").toggleClass("enable"),a.$el.find(".prt-bookmark-register-inner .txt-count").text(a.bookmarkCount),Game.loading.xhrEnd()},500)},popDisabledReason:function(a){this.popView&&this.popView.popDelete();var b=i.getMessage("quest_difficulty_"+a);this.cautionPop(i.replaceMessage("caution_pop_2",[b,b]))}});return p});