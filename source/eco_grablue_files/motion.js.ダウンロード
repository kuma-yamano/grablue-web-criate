define(["lib/raid/timeline","model/sound","constant"],function(a,b,c){var d=/idl_.+_._01/,e=/spt_.+_._01/,f={SUMMON:"duplicate_type_summon",DOWN:"duplicate_type_down",WIN:"duplicate_type_win"},g={player:["down","down2_motion","pf","pf_1","pf_2","pf_3","pf_4","pf_5","ability","stbwait","wait","summon"],boss:["wait","wait_2","wait_3"]},h=["setin","setin_2","setin_3","dead","attack","attack_2","attack_3","form_change"],i="invisible",j=["wait","stbwait"],k={KEEP_KNOCK_BACK:1},l={isPlayedDownPos:[],pDownTarget:["stbwait","wait"],pDownLabel:"down",pDown2Label:"down2_motion",pDownThreshold:.25,mWaitAll:function(a,b){b.playtime=b.playtime?b.playtime:10;for(var c=0,d=a.length-1;d>=c;c++)for(var e=0,f=a[c].timeline.length-1;f>=e;e++)a[c].timeline[e].wait(b.playtime);return!0},mSetTo:function(a,b,c){c.x=c.x?c.x:0,c.y=c.y?c.y:0;var d={};c.x&&(d.x=c.x,b.beforeX[c.index]=d.x),c.y&&(d.y=c.y,b.beforeY[c.index]=d.y),b.timeline[c.index].to(d)},mMoveToInstantry:function(a,b){b.x=b.x?b.x:0,b.y=b.y?b.y:0,b.playtime=b.playtime?b.playtime:0,b.ease=b.ease?b.ease:"linear";var c={};b.x&&(c.x=a.x+b.x),b.y&&(c.y=a.y+b.y),createjs.Tween.get(a).to(c,b.playtime,createjs.Ease[b.ease])},mMoveTo:function(b,c,d,e){var f;d.x=d.x?d.x:0,d.y=d.y?d.y:0,d.playtime=d.playtime?d.playtime:0,d.ease=d.ease?d.ease:"linear",e.wait=e.wait?e.wait:0;for(var g=0,h=b.length-1;h>=g;g++){if(d.index==g){c.beforeX[g]||(c.beforeX[g]=b[g].x),c.beforeY[g]||(c.beforeY[g]=b[g].y);var i={};d.x&&(i.x=c.beforeX[g]+d.x,c.beforeX[g]=i.x),d.y&&(i.y=c.beforeY[g]+d.y,c.beforeY[g]=i.y),c.timeline[g].wait(e.wait).to(i,d.playtime,createjs.Ease[d.ease]),f=parseInt(d.playtime)}d.index!=g&&c.timeline[g].wait(d.playtime+e.adjust)}return e&&a.mAdjust(e,f),f},mChangeMotionAll:function(b,c,d,e){var g=this;d.motion=d.motion?d.motion:"",d.is_alive=d.is_alive?d.is_alive:"",d.type=d.type?d.type:"",d.is_replace=d.is_replace?d.is_replace:"",d.wait=d.wait?d.wait:0,d.current_hp=d.current_hp?d.current_hp:"";for(var i=stage.gGameStatus[d.type].param,j=!0,k=0,m="",n="",o=null,p=null,q=0,r=c.length-1;r>=q;q++){var s="boss"===d.type&&"setin"===d.motion&&_.isUndefined(i[q].force_setin)===!1&&1===+i[q].force_setin;if("on"!==d.is_alive||0!=i[q].alive||s!==!1){j=!1;"player"===d.type?1==stage.gGameStatus.player.param[q].leader?"job":"npc":"enemy";if(m="","player"===d.type&&(n=d.current_hp?d.current_hp:stage.gGameStatus.player.param[q].hp),!d.is_replace&&_.contains(l.pDownTarget,d.motion)&&"player"===d.type&&n/stage.gGameStatus.player.param[q].hpmax<=l.pDownThreshold){var t=this.mCheckDuplicateLyria({type:d.type,pos:q,motion:l.pDownLabel})===f.DOWN;m=t?l.pDown2Label:l.pDownLabel}else m=d.motion;this.mIsSpecialMotion({type:d.type,pos:q,motion:m})&&(m=stage.gGameStatus.player.param[q].condition.special_motion),_.isNull(o)===!0&&(o=q,p=m),c[q].wait(d.wait).call(function(a,b,c){("on"!==d.is_alive||i[a].alive>0||c.forceSetin===!0)&&l.mShouldPlayMotion(c.motion,d.type,a)===!0&&(b[a][d.mc[a].cjs].gotoAndPlay(c.motion),"boss"===d.type&&_.contains(h,d.motion)===!0&&g.mPlayVoiceSelection(d.motion,d.mc[a]))},[q,b,{motion:m,forceSetin:s}])}}if(!j&&_.isNull(o)===!1){var u=d.mc[o].cjs+"_"+p;k=b[o][d.mc[o].cjs][u].timeline.duration}return e&&a.mAdjust(e,k),k},mChangeMotion:function(c,d,e){d.motion=d.motion?d.motion:"",d.type=d.type?d.type:"",d.delay=d.delay?d.delay*(1e3/createjs.Ticker.getFPS()):0,d.is_alive=d.is_alive?d.is_alive:"",d.is_replace=d.is_replace?d.is_replace:"",d.current_hp=d.current_hp?d.current_hp:"",d.synchronizePos=d.synchronizePos||null,d.stopVoiceFunc=d.stopVoiceFunc||null,d.isAttackStbwait=d.isAttackStbwait||!1,d.isReplay=d.isReplay||!1,d.notUndoLinkMotion=d.notUndoLinkMotion||!1;var g=this,j="player"===d.type?stage.gAryRootAvatar[d.pos]:"boss"===d.type?stage.gAryRootBoss[d.pos]:"",k=stage.gGameStatus[d.type].param,m=("player"===d.type?1==stage.gGameStatus.player.param[d.pos].leader?"job":"npc":"enemy",d.originalBossWaitMode||stage.gGameStatus.waitmode),n="boss"===d.type?m[d.pos]:"",o="",p="";if("player"===d.type&&(p=d.current_hp?d.current_hp:stage.gGameStatus.player.param[d.pos].hp),!d.is_replace&&_.contains(l.pDownTarget,d.motion)&&"player"===d.type&&p/stage.gGameStatus.player.param[d.pos].hpmax<=l.pDownThreshold){var q=this.mCheckDuplicateLyria({type:d.type,pos:d.pos,motion:l.pDownLabel})===f.DOWN;o=q?l.pDown2Label:l.pDownLabel}else o=this.mCheckDuplicateLyria({type:d.type,pos:d.pos,motion:d.motion})===f.WIN?i:d.motion;this.mIsSpecialMotion({type:d.type,pos:d.pos,motion:o})&&(o=stage.gGameStatus.player.param[d.pos].condition.special_motion),c.call(function(){if("on"!==d.is_alive||0!=k[d.pos].alive){var a="player"===d.type?stage.gAryRootAvatar[d.pos]:"boss"===d.type?stage.gAryRootBoss[d.pos]:"";setTimeout(function(){d.se&&b.playSE(d.se),d.voice&&"player"===d.type&&(_.isNull(d.stopVoiceFunc)===!1&&_.isFunction(d.stopVoiceFunc)===!0&&d.stopVoiceFunc(),b.playVoice(d.voice)),"boss"!==d.type||"attack"!==o&&"damage"!==o||(o=g._getMotionIrregular(n,o,d.pos));var c=a[k[d.pos].cjs];c&&_.isFunction(c.gotoAndPlay)&&l.mShouldPlayMotion(o,d.type,d.pos,d.isReplay)===!0&&("boss"===d.type&&o===l.pDownLabel&&_.contains(l.isPlayedDownPos,+d.pos)===!1&&(window.play_down_se=!0,l.isPlayedDownPos.push(+d.pos)),c.gotoAndPlay(o),"boss"===d.type&&_.contains(h,o)===!0&&g.mPlayVoiceSelection(o,d),"boss"===d.type&&k[d.pos].motion_link_list&&g.mPlayEnemyMotionTogether(d.pos,o,n||null,d.notUndoLinkMotion)),d.isAttackStbwait===!0&&(stage.gGameStatus.player.attackMotionWait[d.pos]=0),"boss"===d.type&&_.isArray(d.synchronizePos)===!0&&d.synchronizePos.length>0&&_.each(d.synchronizePos,function(a){var b=k[a];if(0!==+b.alive){var c=stage.gAryRootBoss[a][b.cjs];c&&_.isFunction(c.gotoAndPlay)&&c.gotoAndPlay(o)}})},d.delay)}});var r=0;if("on"!==d.is_alive||0!=k[d.pos].alive){if(o!==i){var s=k[d.pos].cjs+"_"+o;r=j[k[d.pos].cjs][s].timeline.duration}e&&a.mAdjust(e,r)}return r},mResetMotion:function(a,b){var c=this,d=createjs.denaVersion?createjs.Ticker.getInterval():stage.gGameParam.spf;b.delay=b.delay?b.delay*d:0,b.motion=b.motion?b.motion:"",b.type=b.type?b.type:"",b.is_replace=b.is_replace?b.is_replace:"",b.current_hp=b.current_hp?b.current_hp:"",b.isReplay=b.isReplay||!1;var e="boss"===b.type?stage.gGameStatus.waitmode[b.pos]:"",g=("player"===b.type?1==stage.gGameStatus.player.param[b.pos].leader?"job":"npc":"enemy",""),h="";if("player"===b.type&&(h=b.current_hp?b.current_hp:stage.gGameStatus.player.param[b.pos].hp),!b.is_replace&&_.contains(l.pDownTarget,b.motion)&&"player"===b.type&&h/stage.gGameStatus.player.param[b.pos].hpmax<=l.pDownThreshold){var i=this.mCheckDuplicateLyria({type:b.type,pos:b.pos,motion:l.pDownLabel})===f.DOWN;g=i?l.pDown2Label:l.pDownLabel}else g=b.motion;this.mIsSpecialMotion({type:b.type,pos:b.pos,motion:g})&&(g=stage.gGameStatus.player.param[b.pos].condition.special_motion),a.call(function(a){var b="player"===a.type?stage.gAryRootAvatar[a.pos]:"boss"===a.type?stage.gAryRootBoss[a.pos]:"",d=stage.gGameStatus[a.type].param[a.pos].cjs;setTimeout(function(){stage.gGameStatus.motion_lock===!1&&l.mShouldPlayMotion(g,a.type,a.pos,a.isReplay)===!0&&(b[d].gotoAndPlay(g),"boss"===a.type&&stage.gGameStatus[a.type].param[a.pos].motion_link_list&&c.mPlayEnemyMotionTogether(a.pos,g,e||null,!1))},a.delay)},[b])},mChangeMotionInstantly:function(a){a.motion=a.motion?a.motion:"",a.type=a.type?a.type:"";var b=createjs.denaVersion?createjs.Ticker.getInterval():stage.gGameParam.spf;a.delay=a.delay?a.delay*b:0,a.is_replace=a.is_replace?a.is_replace:"",a.current_hp=a.current_hp?a.current_hp:"",a.is_alive=a.is_alive?a.is_alive:"",a.synchronizePos=a.synchronizePos||null;var c=this,d="player"===a.type?stage.gAryRootAvatar[a.pos]:"boss"===a.type?stage.gAryRootBoss[a.pos]:"",e=stage.gGameStatus[a.type].param,g=stage.gGameStatus[a.type].param[a.pos].cjs,h="boss"===a.type?stage.gGameStatus.waitmode[a.pos]:"",i=("player"===a.type?1==stage.gGameStatus.player.param[a.pos].leader?"job":"npc":"enemy",""),j="";if("player"===a.type&&(j=a.current_hp?a.current_hp:stage.gGameStatus.player.param[a.pos].hp),!a.is_replace&&_.contains(l.pDownTarget,a.motion)&&"player"===a.type&&j/stage.gGameStatus.player.param[a.pos].hpmax<=l.pDownThreshold){var k=this.mCheckDuplicateLyria({type:a.type,pos:a.pos,motion:l.pDownLabel})===f.DOWN;i=k?l.pDown2Label:l.pDownLabel}else i=a.motion;this.mIsSpecialMotion({type:a.type,pos:a.pos,motion:i})&&(i=stage.gGameStatus.player.param[a.pos].condition.special_motion);var m=0;if("on"!==a.is_alive||0!=e[a.pos].alive){var n=g+"_"+i;if(_.isUndefined(d[g][n])===!0)return m;m=d[g][n].timeline.duration,setTimeout(function(){"boss"!==a.type||"attack"!==i&&"damage"!==i||(i=c._getMotionIrregular(stage.gGameStatus.waitmode[a.pos],i,a.pos)),l.mShouldPlayMotion(i,a.type,a.pos)===!0&&("boss"===a.type&&i===l.pDownLabel&&_.contains(l.isPlayedDownPos,+a.pos)===!1&&(window.play_down_se=!0,l.isPlayedDownPos.push(+a.pos)),d[g].gotoAndPlay(i),"boss"===a.type&&stage.gGameStatus[a.type].param[a.pos].motion_link_list&&c.mPlayEnemyMotionTogether(a.pos,i,h||null,!1)),"boss"===a.type&&_.isArray(a.synchronizePos)===!0&&a.synchronizePos.length>0&&_.each(a.synchronizePos,function(a){var b=e[a];if(0!==+b.alive){var c=stage.gAryRootBoss[a][b.cjs];c&&_.isFunction(c.gotoAndPlay)&&c.gotoAndPlay(i)}})},a.delay)}return m},_getMotionIrregular:function(a,b,c){var d=b,e=stage.gGameStatus.boss.param[c];return"wait_2"==a&&1===+e.runaway_motion_flg?d+="_2":"wait_3"==a&&1===+e.fatigue_motion_flg&&(d+="_3"),d},mIsSpecialMotion:function(a){return"player"!==a.type||0!=stage.gGameStatus.attacking&&"stbwait"!==a.motion&&"wait"!==a.motion&&"down"!==a.motion&&"ability"!==a.motion&&"setup"!==a.motion||"undefined"==typeof stage.gGameStatus.player.param[a.pos].condition.special_motion?!1:!0},mCheckDuplicateLyria:function(a){var b=_.indexOf(stage.pJsnData.formation,"0");if(stage.pJsnData.lyria_pos<0||0>b)return!1;if(!stage.gGameStatus.player.param[stage.pJsnData.lyria_pos]||!stage.gGameStatus.player.param[b])return!1;if(0==stage.gGameStatus.player.param[stage.pJsnData.lyria_pos].alive||0==stage.gGameStatus.player.param[b].alive)return!1;switch(a.motion){case"down":return a.pos==b&&e.test(stage.gGameStatus.player.param[b].cjs)?f.DOWN:!1;case"win":return a.pos==stage.pJsnData.lyria_pos&&d.test(stage.gGameStatus.player.param[b].cjs)?f.WIN:!1;default:return!1}},mPlayEnemyMotionTogether:function(a,b,c,d){var e=stage.gGameStatus.boss.param,f=e[a].motion_link_list,c=c||null,g="down";_.each(f,function(a){var f=a.target_pos;if(_.has(a.motion_link,b)!==!1&&(c=-1!==b.indexOf("damage")?c:null,1===+a.target_dead_link_flag||1===+e[f].alive)){var h=e[f].cjs,i=stage.gAryRootBoss[f][h],j=a.motion_link[b],k="",m=0;i&&_.isFunction(i.gotoAndPlay)&&(i.gotoAndPlay(j),1===+e[f].alive?c=c||stage.gGameStatus.waitmode[f]:1===+a.target_dead_link_flag&&stage.pJsnData.key_enemy_mode===stage.gGameParam.key_enemy.mode_3&&(c=g),null!==c&&(k=h+"_"+j,"mortal_C_link"===j&&"enemy_8100983"===h&&(m=-2),d===!1&&_.isUndefined(i[k])===!1&&createjs.Tween.get({},{useTicks:!0}).wait(i[k].timeline.duration+m).call(function(){stage.gGameStatus.boss.all_dead===!1&&(c===g&&window.play_down_se!==!1&&_.contains(l.isPlayedDownPos,+f)===!0&&(window.play_down_se=!1),i.gotoAndPlay(c))})))}})},mShouldPlayMotion:function(a,b,c,d){var e=stage.gGameStatus[b].motion[c],f=d||!1;return"player"===b&&_.contains(j,a)===!1&&null!==stage.gGameStatus.player.posSizeL&&+stage.gGameStatus.player.posSizeL!==+c?!1:_.isUndefined(e)||e!==a||_.contains(g[b],e)!==!0||f!==!1?(stage.gGameStatus[b].motion[c]=a,!0):!1},mPlayVoiceSelection:function(a,b){var c="setin"===a?b.setin_voice:b.voice;if(_.isNull(c)!==!0&&""!==c){var d=+b.voice_wait||0;this.mVoicePlayAfterWait({voice:c,wait:d})}},mVoicePlayAfterWait:function(a){createjs.Tween.get({},{useTicks:!0}).wait(a.wait).call(function(){b.playVoice(a.voice,{alias:c.VOICE_ENEMY_ALIAS})})}};return Object.defineProperties(l,{CHARA_MOTION_TYPE:{get:function(){return k}}}),l});