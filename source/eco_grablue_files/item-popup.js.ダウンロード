define(["backbone","model/quest/user-item","model/data","model/token-data","model/user/money-model","model/sound","model/quest/user-battlepoint","view/content","view/popup","util/language-message"],function(a,b,c,d,e,f,g,h,i,j){var k=h.extend({SendControlFlg:!1,exe_flg:!1,events:{"tap .pop-stamina .btn-usual-cancel":"popRemove","tap .pop-stamina .btn-shop":"locationShop","tap .pop-stamina .btn-use-full:not(.disable)":"use_item","change .pop-stamina .use-item-num":"changeUseItemNum","tap .pop-ap-notenough .btn-usual-ok":"popRemove","tap #pop .pop-result:not('.start-coopraid') .btn-usual-ok:not(.select-num)":"checkEventBeforeLocation","tap .cnt-event .prt-event-contents .pop-result:not('.start-coopraid') .btn-usual-ok:not(.select-num)":"locationSupporter","tap #pop-third .pop-result:not('.start-coopraid') .btn-usual-ok:not(.select-num)":"popRemove","tap .pop-result .btn-usual-ok.select-num":"popRemove","tap #pop .pop-result-unnecessary:not('.start-coopraid') .btn-usual-ok":"locationSupporter","tap #pop-third .pop-result-unnecessary .btn-usual-ok":"popRemove","tap .pop-item-num .btn-pop-close":"popRemove","tap .pop-item-num .btn-use-item":"use_item","tap .btn-stone:not(.disable)":"popShowExchange","tap .pop-exchange .btn-usual-exchange":"buyItem","tap .pop-exchange .btn-usual-ok":"re_render_pre","change .num-set.exchange":"setBuyNum","tap .pop-empty-item .btn-shop":"locationShop","tap .pop-empty-item .btn-usual-cancel":"popRemove","tap .pop-exchange .btn-usual-cancel":"popRemove"},initialize:function(a){this.recoveryType=a.recovery,this.quest_id=a.quest_id,this.raid_id=a.raid_id,this.type=a.type,this.quest_ap=a.quest_ap,this.chapter_name=a.chapter_name,this.cjs_id=a.cjs_id,this.pop_z_position=a.pop_z_position,this.popViewVar=this.popView,this.is_semi=a.is_semi,this.isDefendOrderMulti=a.is_semi||!1,this.pointData=a.pointData,this.eventType=this.$el.find(".cnt-event").data("event-type")||"",this.isPageTreasureraid="treasureraid"===this.eventType,this.handleSetInitialData(!0,this.pointData)},re_render_pre:function(){this.popViewVar.popRemove(),this.handleSetInitialData(!1,this.pointData)},handleSetInitialData:function(a,b){this.isRequested=!1,2===+this.recoveryType&&a?this.getBpData():this.setRecoveryValues(b)},getBpData:function(){var a=this,b=new g;b.fetch().done(function(b){a.setRecoveryValues(b)})},setRecoveryValues:function(a){switch(this.pointData=a,+this.recoveryType){case 1:this.pointData.current_point=+this.pointData.action_point,this.pointData.max_point=+this.pointData.max_action_point,this.recoveryLimitValue=this.pointData.action_point_limit,this.recoveryPointsObj={1:this.pointData.elixir_recover_value,2:this.pointData.elixir_half_recover_value};break;case 2:this.pointData.current_point=+this.pointData.battle_point,this.pointData.max_point=+this.pointData.max_battle_point,this.recoveryLimitValue=this.pointData.battle_point_limit,this.recoveryPointsObj={3:this.pointData.soul_powder_recover_value,5:this.pointData.soul_seed_recover_value}}this.getNormalItemList()},getNormalItemList:function(){this.itemListModel=new(c.extend({urlRoot:Game.baseUri+"item/normal_item_list"})),this.stopListening(this.itemListModel,"sync"),this.listenToOnce(this.itemListModel,"sync",this.render_pre),this.itemListModel.fetch()},render_pre:function(a){this.recover_items=[],this.item_enough=!1;var b=this;_.each(a.attributes,function(a,c){a.recovery==b.recoveryType&&a.item_id<1e3&&(b.recover_items[c]=a,b.recover_items[c].recoveryPoint=b.recoveryPointsObj[a.item_id],a.number>0&&(b.item_enough=!0))}),this.pop_stamina_render()},pop_stamina_render:function(){if(1==this.recoveryType){this.point_name="AP";var a={0:2,1:1}}else if(2==this.recoveryType){this.point_name=j.getMessage("quest_138");var a={0:5,1:3}}this.param=_.clone(this.pointData),this.item_shortage=!1,this.item_shortage_name="",this.item_shortage_num=0;var b={1:10,2:20,3:20,5:99};this.overLimitkeys=[];var c=this;_.each(this.recover_items,function(a,d){var e=+a.recoveryPoint;if(a.number<1)c.recover_items[d].use_num=0,c.recover_items[d].after_point=c.param.current_point;else if((2==a.item_id||5==a.item_id)&&a.number>0){c.recover_items[d].use_num=1;var f=Math.floor(e+c.param.current_point);if(c.recover_items[d].after_point=f,c.param.current_point+e*a.number<c.quest_ap)c.item_shortage=!0,c.item_shortage_name=a.name,c.item_shortage_num=a.number;else for(var g=!0,h=0;h<=a.number;h++)f=Math.floor(e*h+c.param.current_point),f>=c.quest_ap&&g&&(c.recover_items[d].use_num=h,c.recover_items[d].after_point=f,g=!1)}else c.recover_items[d].use_num=1,c.recover_items[d].after_point=Number(c.param.current_point)+e;c.recoveryLimitValue<c.recover_items[d].after_point&&c.overLimitkeys.push(d);var i=+c.recoveryLimitValue-c.param.current_point;c.recover_items[d].canUseNum=Math.ceil(i/+e),c.recover_items[d].canUseNum>b[a.item_id]&&(c.recover_items[d].canUseNum=b[a.item_id]),c.recover_items[d].canUseNum>c.recover_items[d].number&&(c.recover_items[d].canUseNum=c.recover_items[d].number)}),0==Object.keys(this.itemListModel).length&&(this.item_enough=!1),this.data={recover_items:this.recover_items,point_name:this.point_name,sp:this.param.current_point,max_sp:this.param.max_point,item_enough:this.item_enough,chapter_name:this.chapter_name,quest_ap:this.quest_ap,item_shortage:this.item_shortage,item_shortage_name:this.item_shortage_name,item_shortage_num:this.item_shortage_num,recover_item_ids:a,cjs_id:this.cjs_id,recoveryLimitValue:this.recoveryLimitValue,recoveryType:this.recoveryType,isOverLimitPoint:this.overLimitkeys.length>0,isDefendOrderMulti:this.isDefendOrderMulti},this.pop_el="#pop",3==this.pop_z_position&&(this.pop_el="#pop-third"),1==this.recoveryType&&parseInt(this.data.max_sp)<parseInt(this.quest_ap)?this.pop_ap_notenough():this.item_enough?this.pop_use_item_render():this.money_model_check()},pop_use_item_render:function(){return this.exe_flg?!1:(this.exe_flg=!0,this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:"pop-stamina",title:j.replaceMessage("quest_48",[this.point_name]),body:_.template($("#pop-stamina").html(),this.data),flagBtnCancel:1,flagBtnOk:0}),this.popViewVar.render(),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.adjustPoupPositionIfBiography("pop-stamina"),void(this.exe_flg=!1))},pop_ap_notenough:function(){return this.exe_flg?!1:(this.exe_flg=!0,this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:"pop-ap-notenough",title:j.getMessage("quest_38"),body:j.getMessage("quest_39"),flagBtnCancel:0,flagBtnOk:1}),this.popViewVar.render(),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.exe_flg=!1,void this.adjustPoupPositionIfBiography("pop-ap-notenough"))},changeUseItemNum:function(a){var b=$(a.currentTarget),c=b.find("option:selected").val(),d=b.data("index"),e=+b.data("current-point"),f=+b.data("recovery-point"),g=+b.data("current-num"),h=e+f*+c;this.data.recoveryLimitValue<h?(h=this.data.recoveryLimitValue,_.contains(this.overLimitkeys,d)||this.overLimitkeys.push(d)):_.contains(this.overLimitkeys,d)&&(this.overLimitkeys=_.reject(this.overLimitkeys,function(a){return a==d}));var i=this.popViewVar.$el.find(".pop-stamina");i.find(".txt-after-point.index-"+d).html(h),i.find(".txt-after-num.index-"+d).html(g-+c),i.find(".btn-use-full.index-"+d).data({"use-num":c,"after-sp":h}).attr({"data-use-num":c,"data-after-sp":h});var j=$("#prt-over-limit-message");1>this.overLimitkeys.length?j.hasClass("show")&&j.removeClass("show"):!j.hasClass("show")&&j.addClass("show")},use_item:function(a){if(this.exe_flg)return!1;if(Game.view.trigger("xhrStart"),this.exe_flg=!0,!this.isRequested){this.isRequested=!0,this.use_duplicateKey=$(".cnt-quest").attr("data-duplicate-key")?$(".cnt-quest").attr("data-duplicate-key"):$(".cnt-coopraid").attr("data-duplicate-key"),this.use_duplicateKey||(this.use_duplicateKey=$(".cnt-coopraid .btn-quest-start").attr("data-duplicate-key")||$("#cnt-detail").data("duplicate-key"));var b=$(a.currentTarget),c=b.data("item-id"),d=b.data("use-num"),e=b.data("item-num"),f=b.data("after-sp"),g=b.data("recovery-percent"),h=b.data("recovery-point");this.result_data={item_id:c,point_name:this.point_name,sp:this.param.current_point,after_sp:f,max_sp:this.param.max_point,use_num:d,recovery_percent:g,item_num:e,change_use_num:0,recoveryPoint:h},this.getCurrentPointInfo()}},getCurrentPointInfo:function(){var a=this,b=1===+this.recoveryType?"ap_info":"bp_info",d=new(c.extend({urlRoot:Game.baseUri+"quest/"+b}));d.fetch().done(function(b){a.use_item_check(b.current_point)})},use_item_check:function(a){var b=this,c=+a,d=this.quest_ap-c;if(1>d)return this.pop_unnecessary(this.result_data);var e=this.result_data.after_sp;(2==this.result_data.item_id||5==this.result_data.item_id)&&e<this.quest_ap&&(this.item_shortage=!0);var f=setTimeout(function(){b.use_item_exe(),clearTimeout(f)},301)},use_item_exe:function(){this.userItemModel=new b({item_id:this.result_data.item_id,num:this.result_data.use_num,duplicate_key:this.use_duplicateKey});var a=this;this.userItemModel.setCompleteCallBack(function(){a.pop_result(a.result_data)}),this.userItemModel.getSecurityToke()},pop_result:function(a){var b="pop-result";if(7==this.type){var c=$(".prt-quest-set").data("next-type");2!=c||$(".btn-quest-start").hasClass("disable")||(b="pop-result start-coopraid")}this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:b,title:j.getMessage("quest_50"),body:_.template($("#pop-result").html(),a),flagBtnCancel:0,flagBtnOk:1,showEndCallback:function(){f.playRecoverySE()}}),this.popViewVar.render(),this.item_shortage&&1!=a.item_id&&3!=a.item_id&&this.popViewVar.$el.find(".btn-usual-ok").addClass("select-num"),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.exe_flg=!1,this.adjustPoupPositionIfBiography("pop-result"),1==this.recoveryType?$(".prt-user-status").length&&this._change_num_ap(a):2==this.recoveryType&&$(".prt-user-bp-value").length&&this._change_num_bp(a),Game.view.trigger("xhrEnd")},_change_num_bp:function(a){var b=$("#wrapper"),c=b.find(".prt-user-bp-value"),d=b.find(".prt-additional-bp"),e=a.after_sp>5?5:a.after_sp,f="",g=" over-limit",h=0;switch(c.attr({title:a.after_sp,"data-current-bp":a.after_sp}).html(""),!0){case+a.after_sp>=10:h=5;break;case+a.after_sp<=5:break;default:h=a.after_sp-5}for(var i=0;e>i;i++)f=h>i?g:"",c.append("<span class='ico-bp"+f+"'></span>");d.removeClass().addClass("prt-additional-bp bp-"+a.after_sp)},_change_num_ap:function(a){var b=a.after_sp+"/"+a.max_sp;$(".prt-user-status .txt-stamina-value").attr("title",b);var c=Math.floor(a.after_sp/a.max_sp*100);c>100&&(c=100),$(".prt-user-status .prt-stamina-gauge-inner").css("width",c+"%");var d=$(".prt-user-status .txt-stamina-value");d.html("");for(var e=0;e<b.length;e++)"/"==b[e]?d.append("<span class='num-stamina-slash'></span>"):d.append("<span class='num-stamina"+b[e]+"'></span>");var f=a.max_sp-a.after_sp;if(1>f)$(".prt-user-status .txt-stamina-remaining").css("display","none");else{var g=5*f,h=Math.floor(g/60),i=Math.floor(g%60),k=h>0?j.replaceMessage("quest_51",[h,i]):j.replaceMessage("quest_52",[i]);$(".prt-user-status .txt-stamina-remaining").text(k)}},pop_unnecessary:function(a){var b="pop-result-unnecessary";7!=this.type||$(".btn-quest-start").hasClass("disable")||(b="pop-result-unnecessary start-coopraid"),this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:b,title:j.getMessage("quest_53"),body:j.replaceMessage("quest_54",[a.point_name]),flagBtnCancel:0,flagBtnOk:1}),this.popViewVar.render(),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.exe_flg=!1,Game.view.trigger("xhrEnd")},checkEventBeforeLocation:function(){(0==$(".prt-event-quest-intro").length||this.isPageTreasureraid)&&this.locationSupporter()},locationSupporter:function(){var a=[703471,703481,703491,703501,703251,703451];return _.some(a,function(a){return a==this.quest_id})?void this.popViewVar.popRemove():($("#wrapper").trigger("completeUseRecoveryItems"),void this.content_close(!0))},locationShop:function(){this.content_close(),a.history.navigate("shop",!0)},money_model_check:function(){return this.exe_flg?!1:(this.exe_flg=!0,this.money_model=new e,this.stopListening(this.money_model,"change"),this.listenTo(this.money_model,"change",this.exchange_data),void this.money_model.fetch())},exchange_data:function(){if(1==this.recoveryType)var a=7;else if(2==this.recoveryType)var a=8;this.article=new(c.extend({urlRoot:Game.baseUri+"shop/article/"+a})),this.stopListening(this.article,"change"),this.listenTo(this.article,"change",this.pop_empty_item_render),this.article.fetch()},pop_empty_item_render:function(){this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:"pop-empty-item",title:j.replaceMessage("quest_55",[this.point_name]),body:_.template($("#pop-empty-item").html(),this.data),flagBtnCancel:1,flagBtnOk:0}),this.popViewVar.render();var a=this.article.attributes,b=this.money_model.attributes;this.before_stone=b.amount,Number(this.before_stone)<Number(a.price)&&$(".btn-stone").addClass("disable"),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.exe_flg=!1,this.adjustPoupPositionIfBiography("pop-empty-item")},popShowExchange:function(){return this.SendControlFlg?!1:(this.SendControlFlg=!0,void this.renderPopShowConfirm())},renderPopShowConfirm:function(){var a=this.article.attributes;this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:"pop-exchange",title:j.getMessage("quest_56"),body:_.template($("#tpl-pop-exchange").html(),a),flagBtnCancel:1,flagBtnOk:0}),this.popViewVar.render(),$(".pop-exchange .prt-popup-footer").append("<div class='btn-usual-exchange' data-article-id='"+a.id+"'></div>"),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.setBuyNum(),this.adjustPoupPositionIfBiography("pop-exchange"),this.SendControlFlg=!1},buyItem:function(a){if(Game.loading.xhrStart(),this.exe_flg)return!1;this.exe_flg=!0;var b=$(".num-set").children(":selected").val(),c=$(a.currentTarget).data("article-id");this.confirm_pop_html=$(".pop-exchange .txt-popup-body").html(),this.popViewVar.popRemove(),this.purchase=new(d.extend({urlRoot:Game.baseUri+"shop/purchase/"})),this.purchase.set({article_id:c,num:b}),this.stopListening(this.purchase,"sync"),this.stopListening(this.purchase,"error"),this.listenTo(this.purchase,"sync",this.render_result),this.listenTo(this.purchase,"error",this.error_message),this.purchase.save()},error_message:function(){this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:"pop-exchange",title:j.getMessage("quest_57"),body:j.getMessage("quest_58"),flagBtnCancel:1,flagBtnOk:0}),this.popViewVar.render(),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.adjustPoupPositionIfBiography("pop-exchange"),this.exe_flg=!1,Game.loading.xhrEnd()},adjustPoupPositionIfBiography:function(a){if(0!=$(".prt-event-quest-intro").length&&!this.isPageTreasureraid){var b=$(a),c=-$(".prt-event-fv").outerHeight()+parseInt(b.css("top"));b.css("top",c+"px")}},render_result:function(){this.popViewVar&&this.popViewVar.popDelete(),this.popViewVar=new i({el:this.pop_el,className:"pop-exchange",title:j.getMessage("quest_59"),body:this.confirm_pop_html,flagBtnCancel:0,flagBtnOk:1}),this.popViewVar.render(),$(".pop-result .item-explain").css("display","none"),$(".pop-exchange .cnt-confirm").children("div").slice(2,5).css("display","none"),$(".pop-exchange .btn-usual-cancel").css("display","none"),$(".pop-exchange .result").html(j.replaceMessage("quest_60",[this.purchase.attributes.num])),this.popViewVar.popShow(),3==this.pop_z_position&&this.main_pop_position(1),this.adjustPoupPositionIfBiography("pop-exchange"),this.exe_flg=!1,Game.loading.xhrEnd()},setBuyNum:function(){var a=$(".pop-exchange .item-price").attr("price");$(".before-money").html(this.before_stone),$(".after-money").html(this.before_stone-a*$(".num-set").children(":selected").val())},main_pop_position:function(a){var b=$("#pop-second .pop-usual");1==a?b.css("z-index",99999):b.css("z-index",15e4)},popRemove:function(){this.exe_flg&&(this.exe_flg=!1),3==this.pop_z_position?(this.popViewVar.popRemove(1),this.main_pop_position(2)):this.popViewVar.popRemove(),this.off(),this.undelegateEvents(),this.stopListening()},popDelete:function(){this.popViewVar.popDelete(),this.off(),this.undelegateEvents(),this.stopListening(),this.content_close()}});return k});