define(["jquery","underscore","backbone","model/data","util/ajax"],function(a,b,c,d,e){var f=d.extend({defaults:function(){return{special_token:null}},initialize:function(){d.prototype.initialize.apply(this)},setToken:function(){this.set(this.security.attributes),this.set({special_token:Math.floor(1e4*Math.random())})},save:function(c,e,f){var g;null==c||"object"==typeof c?(g=c,f=e):(g={},g[c]=e),f=f||{},f.url=f.url||this.url(),f.url=f.url+"?_="+(new Date).getTime();var h=b.bind(d.prototype.save,this,g,f);if(this._cflExists()){var i=this;this.func=h;var j=this.saveDeferred=new a.Deferred,k=this.saveDeferred.promise();return k.abort=function(){delete i.func,j.reject(),j=null,k.abort=function(){}},this.security=new(d.extend({urlRoot:Game.baseUri+"security/csrf"})),this.listenToOnce(this,"change:special_token",this._check),this.listenToOnce(this.security,"change",this.setToken),this.security.fetch(),k}return h()},_check:function(){var a=this;if(void 0==this.func);else{var b=this.func();b.done(function(){a.saveDeferred.resolve(a)}).fail(function(){a.saveDeferred.reject()}),a.saveDeferred.fail(function(){e.abortXHR(b)}).always(function(){a.saveDeferred=null})}},_cflExists:function(){var a=this._getSegment(this.url()),c=new Function("return "+b.unescape(Game.cfl))();return c[a]?!0:!1},_getSegment:function(a){var b=Game.baseUri.length-1,c=a.indexOf("?");return 0>c&&(c=a.length),a.substring(b,c).replace(/(\/$|.json)/,"")}});return f});