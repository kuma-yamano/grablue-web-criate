define(["backbone","model/content","view/content","view/popup","view/common/evo_star","view/detail/common_func","view/detail/_sub_fate_quest","model/data","model/token-data","model/user/npc","view/archive/story/event-scene-app","view/common/season_message","model/sound","util/language-message","util/navigate"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p=4,q=1,r=0,s={LIST:1,PUSHED_NPC:2,PROFILE:3,PARTY_TOP:4,PARTY_LIST:5,EVOLUTION_NPC:6,ENHANCEMENT_NPC:7},t=c.extend({content_model:null,event_popup_info:null,event_name:null,attr:null,parentPage:null,exPoseOpen:null,events:{"tap .btn-char-zoom":"popZoom","tap #pop-zoom .btn-close":"popZoomClose","tap #pop-zoom .img-zoom":"popZoomClose","touchstart #pop-zoom .prt-zoom-image":"zoomImageMove","mousedown #pop-zoom .prt-zoom-image":"zoomImageMove","tap .location-href":"location_href","tap .btn-event-whiteday":"valentine_story","tap .pop-event-reward .btn-usual-close":"popEventRemove","tap .prt-set-filter .btn-set-filter":"setFilter","tap .prt-set-filter .btn-unset-filter":"setFilter","success_set_filter .cnt-detail":"checkFilteredStatus","tap .pop-result-filter .btn-usual-ok":"popRemoveInitialize","tap .pop-result-filter-none .btn-usual-ok":"triggerBack","tap .btn-bonus-reset":"bonusResetConfirm","tap .pop-bonus-reset .btn-usual-cancel":"popRemove","tap .pop-bonus-reset .btn-usual-exchange":"bonusReset","tap .pop-bonus-reset-complete .btn-usual-ok":"reload","tap .prt-zenith-box .btn-zenith.disable":"popUnopen","tap .pop-lb-unopen .btn-usual-close":"popRemove","tap .prt-detail-action .btn-ability-effect-info":"popAbilityEffect","tap .pop-ability-effect .btn-usual-ok":"popRemove","tap .btn-set-pushed":"confirmSetPushedNpc","tap .btn-unset-pushed":"floatPushedNpc","tap .pop-pushed-confirm       .btn-usual-ok":"setPushedNpc","tap .pop-pushed-confirm       .btn-usual-cancel":"popRemove","tap .pop-pushed-result        .btn-usual-close":"locationSetPushedNpcAfter","tap .pop-pushed-cancel        .btn-usual-close":"popRemove","tap .pop-pushed-float-result  .btn-usual-close":"locationSetPushedNpcAfter","tap .prt-box .btn-bgm-setting":"postSpecialSkillBgmSetting","tap .pop-ex-pose-open .btn-usual-close":"popRemoveExPose","tap .prt-location-buttons .btn-location-poses":"locationPoses","tap .prt-set-poses .btn-set-poses":"locationPoses","tap .prt-poses .btn-poses":"locationPoses","tap .pop-combo-npc .btn-usual-close":"popRemove"},detail_initialize:function(a,c){this.content_bind(),this.attr=a;var d=c.head,e=c.back;_.isFunction(c.head)||(c.head=function(){return d}),_.isFunction(c.back)||(c.back=function(){return e}),this.tmp_set=c,this.deck_num=a.deck_num,this.param_id=a.param_id,this.content_model=new b({controller:"detail",action:"detail"}),this.listenTo(this.content_model,"change",this.data_initialize),this.content_model.fetch()},data_initialize:function(){this.set={head:this.tmp_set.head(),back:this.tmp_set.back(),cnt:this.tmp_set.cnt,set_num:this.tmp_set.set_num},this.render_pre()},render_pre:function(){var b=this;if(1!=b.$el.length)return void a.history.navigate("enhancement/npc/base",!0);b.content_render(b.content_model),b.npc_model=new j,b.npc_model.id=b.param_id,b.npc_candidate_model=new(h.extend({urlRoot:Game.baseUri+"party/candidate_npc/"+b.param_id}));var c=$.Deferred(),d=$.Deferred();$.when(c,d).done(function(){b.render()}),b.listenTo(b.npc_model,"change",function(){b.npcId=b.npc_model.get("master").id,c.resolve()}),b.listenTo(b.npc_candidate_model,"change",function(){d.resolve()}),b.npc_model.fetch(),b.npc_candidate_model.fetch()},render:function(){var a=this.npc_model.attributes;a.param.is_plus_material=!1;var b=this.$el,c=this.npc_candidate_model.toJSON(),f=c.list.length>=2||a.master.awakening1<=a.param.evolution||a.has_combination||a.has_additional_pose,g=this.set,h=/\[.*?\]/;_.isUndefined(a.master.evo_name)||(a.param.another_name=h.test(a.master.evo_name)?a.master.evo_name.match(h)[0]:null),this.destroySubViews(),this.seasonMessageSubView=new l({model:this.npc_model}),this.addSubView(this.seasonMessageSubView),this._shouldSetFateSubView(a)===!0&&this.setFateQuestSubView(),a.rank=(a.rank+"").split(""),b.find(".cnt-detail").html(_.template($("#tpl-cnt-detail").html(),{type:"npc",data:a,cnt:g.cnt,enable_birthday_voice:a.birthday&&a.birthday.has_present,obj:{isViewPoseButton:_.contains(["party","listall","profile","pushed_npc"],g.cnt)&&f},seasonMessageArray:this.seasonMessageSubView.seasonMessageArray})),$(".cnt-global-header").add(".cnt-global-footer").attr("style",""),$(".prt-head-current").html(g.head),b.find(".atx-lead-link").html(g.back),b.find(".cnt-detail").addClass("npc");var j=b.find(".btn-change"),k=b.find(".btn-remove");this.set.set_num=Number(this.set.set_num),"enhancement"===g.cnt||"evolution"===g.cnt?1===g.set_num?(j.addClass("btn-base-change").removeClass("btn-change"),k.addClass("btn-back-cancel").removeClass("btn-remove")):2===g.set_num?(j.addClass("btn-material-change").removeClass("btn-change"),k.addClass("btn-back-cancel").removeClass("btn-remove")):3===g.set_num?(j.addClass("btn-base-change").removeClass("btn-change"),k.addClass("btn-back-cancel result-base").removeClass("btn-remove")):"enhancement"===g.cnt?(j.addClass("btn-usual-text enhancement").removeClass("btn-change").html(n.getMessage("detail_1")),k.addClass("btn-remove-cancel").removeClass("btn-remove")):"evolution"===g.cnt&&(j.addClass("btn-usual-text evolution").removeClass("btn-change").html(n.getMessage("detail_2")),k.addClass("btn-remove-cancel").removeClass("btn-remove")):"listall"===g.cnt&&b.find(".prt-buttons").remove();var m=+a.master.max_evolution_level,o=+a.master.release_max_evolution_level,p=+a.param.evolution;e.renderDetailStar(this.$el.find(".prt-evolution-star"),"prt-star","prt-ultimate-star","prt-archaic-star","prt-temporary-summon-star",p,m,o,0,0,"npc"),this.after_process(),this.trigger("loadEnd"),this.event_popup_info&&(this.popView=new d({className:"pop-event-reward "+this.event_name,title:n.getMessage("detail_17"),body:_.template($("#tpl-get-reward").html(),this.event_popup_info),flagBtnClose:1}),this.popView.render(),this.popView.popShow()),this.exPoseOpen=a.open_additional_pose;var q=a.open_npc_combination;if(_.isNull(this.exPoseOpen)){if(q){var r=new(i.extend({urlRoot:Game.baseUri+"npc/save_npc_combination_notify"}));r.set({user_npc_id:+a.id}).save(),this.popComboNPCAnnounce(q)}}else{var s=new(i.extend({urlRoot:Game.baseUri+"npc/save_expose_notify"})),t=_.pluck(a.open_additional_pose,"awakening_level");s.set({user_npc_id:+a.id,awakening_level_list:t}).save(),this.popExPoseOpen()}return this},popZoom:function(a){var b=$(a.currentTarget).data("image-id");$(".mask").css("display","block"),window.scrollTo(0,1),$("#pop-zoom").html(_.template($("#tpl-char-zoom").html(),{image_id:b}))},popZoomClose:function(){$("#pop-zoom").empty(),$(".mask").css("display","none")},zoomImageMove:function(a){if("mousedown"===a.type&&!Game.ua.isPcPlatformHasTouch)return void a.preventDefault();var b=this,c=$(a.currentTarget),d=b.$el.find(".prt-zoom-image"),e=function(a){a.preventDefault(),"mousedown"===a.type?b.touchStartX=a.originalEvent.pageX:b.touchStartX=a.originalEvent.changedTouches[0].pageX,b.rightStartX=d.css("right")},f=function(a){a.preventDefault();var c;c="mousemove"===a.type?a.originalEvent.pageX:a.originalEvent.changedTouches[0].pageX;var e=b.touchStartX-c,f=b.rightStartX.replace("px",""),g=Math.floor(+f+ +e);g>160?g=160:0>g&&(g=0),d.css("right",g+"px")};c.off(),"mousedown"===a.type&&Game.ua.isPcPlatformHasTouch?(e(a),c.on("mousemove",f),c.one("mouseup mouseleave",function(){c.off()})):"touchstart"===a.type&&(e(a),c.on("touchmove",f),c.one("touchend",function(){c.off()}))},after_process:function(){},setFilter:function(){var a=this.npc_model.toJSON();if(a.param.is_used&&!a.is_exclude){var b=f.getFilterResultData(2,"npc");return this.popFilterResult(b),!1}var c=0;a.is_exclude&&(c=1),f.postFilter(this.param_id,"npc",c,".cnt-detail")},checkFilteredStatus:function(a,b){0===b.status?this.popRemoveInitialize():this.popFilterResult(b)},popFilterResult:function(a){var b=n.getMessage("detail_7"),c="pop-result-filter";1===a.status&&(c="pop-result-filter-none"),this.popView=new d({className:c,title:b,body:a.popBody,flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow()},triggerBack:function(){this.$el.find(".prt-lead-link").trigger("tap")},location_href:function(b){var c=$(b.currentTarget).data("location-href");this.content_close(),a.history.navigate(c,!0)},bonusResetConfirm:function(){var a=new(h.extend({urlRoot:Game.baseUri+"npc/bonus_reset_data/"+this.param_id}));this.listenToOnce(a,"sync",this.popBonusReset),a.fetch()},popBonusReset:function(a){a.attributes.name=$(".txt-item-name").html(),a.attributes.category="npc",this.popView=new d({className:"pop-bonus-reset",title:n.getMessage("detail_8"),body:_.template($("#tpl-pop-bonus-reset").html(),a.attributes),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.popView.popShow(),a.attributes.need_lupi<=a.attributes.lupi?$(".pop-bonus-reset .prt-popup-footer").append('<div class="btn-usual-exchange"></div>'):$(".pop-bonus-reset .prt-popup-footer").append('<div class="onm-usual-text">'+n.getMessage("detail_9")+"</div>")},bonusReset:function(){var a=new(i.extend({urlRoot:Game.baseUri+"npc/bonus_reset"}));this.listenTo(a,"sync",this.popBonusResetComplete),a.set({weapon_param_id:this.param_id}),a.save()},popBonusResetComplete:function(a){a.attributes.category="weapon",this.popView=new d({className:"pop-bonus-reset-complete",title:n.getMessage("detail_10"),body:_.template($("#tpl-pop-bonus-reset-complete").html(),a.attributes),flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow()},reload:function(){this.popRemove(),this.popRemoveInitialize()},popRemoveInitialize:function(){this.popView&&this.popView.popRemove(),"listall"==this.set.cnt?this.initialize({deck_num:this.deck_num,set_num:this.set_num,param_id:this.param_id,active_tab:this.active_tab}):this.initialize({deck_num:this.deck_num,set_num:this.set_num,param_id:this.param_id})},popRemove:function(){this.popView.popRemove()},sceneAllEnd:function(){this.content_close(),this.delegateEvents(this.events),this.initialize(this.attr)},popEventRemove:function(){this.popView&&(this.popView.popRemove(),this.event_popup_info=null)},loadStart:function(){Game.loading.loadStart()},confirmSetPushedNpc:function(){this.npc_model.get("pushed_npc").npc?this.ConfirmSetPop():this.setPushedNpc()},ConfirmSetPop:function(){this.popView=new d({className:"pop-pushed-confirm",title:n.getMessage("datail_pushed_npc_1"),body:_.template($("#tpl-pop-pushed-npc-confirm").html(),{currentPushedNpcName:this.npc_model.get("pushed_npc").npc.master.name,selectNpcName:this.npc_model.get("master").name}),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow()},setPushedNpc:function(){var a=$("#duplicate_key").val(),b=new(i.extend({urlRoot:Game.baseUri+"npc_pushed/set_pushed_npc"}));this.listenToOnce(b,"sync",this.setPushedNpcResult),b.set({npc_id:this.npc_model.id,duplicate_key:a}),b.save()},floatPushedNpc:function(){var a=$("#duplicate_key").val(),b=new(i.extend({urlRoot:Game.baseUri+"npc_pushed/unset_pushed_npc"}));this.listenToOnce(b,"sync",this.floatPushedNpcResult),b.set({npc_id:this.npc_model.id,duplicate_key:a}),b.save()},setPushedNpcResult:function(a){if(a.get("result"))var b=_.template($("#tpl-pop-pushed-npc-result").html(),{selectNpcName:this.npc_model.get("master").name}),c="pop-pushed-result";else var b=n.replaceMessage("datail_pushed_npc_3",[a.get("change_possible_date")]),c="pop-pushed-cancel";this.popView=new d({className:c,title:n.getMessage("datail_pushed_npc_1"),body:b,flagBtnClose:1,flagBtnOk:0}),this.popView.render().popShow()},floatPushedNpcResult:function(a){if(a.get("result"))var b=n.getMessage("datail_pushed_npc_4"),c="pop-pushed-float-result";else var b=n.replaceMessage("datail_pushed_npc_3",[a.get("change_possible_date")]),c="pop-pushed-cancel";this.popView=new d({className:c,title:n.getMessage("datail_pushed_npc_1"),body:b,flagBtnClose:1,flagBtnOk:0}),this.popView.render().popShow()},locationSetPushedNpcAfter:function(){"listall"==this.set.cnt||"party"===this.set.cnt?this.reload():(this.content_close(),a.history.navigate("profile",!0))},popUnopen:function(){this.popView&&this.popView.popRemove();var a=this.npc_model.toJSON();this.popView=new d({className:"pop-lb-unopen",title:n.getMessage("datail_to_npc_zenith_1"),body:_.template($("#tpl-pop-lb-unopen").html(),{npcName:a.master.name}),flagBtnClose:1}),this.popView.render().popShow()},_shouldSetFateSubView:function(a){for(var b,c=!1,d=1;p>=d&&(b=a["action_ability"+d],c=_.isNull(b)===!1&&_.isUndefined(b.quest)===!1&&b.quest.is_cross_fate===!1&&b.quest.is_clear===!1&&b.quest.open_npc_level<=+a.param.level,c!==!0);d++);return c},postSpecialSkillBgmSetting:function(a){var b=$(a.currentTarget),c=this.$el.find(".btn-bgm-setting"),d=new(i.extend({urlRoot:Game.baseUri+"setting/save"}));this.stopListening(d,"sync"),this.listenToOnce(d,"sync",function(){b.hasClass("active")?b.removeClass("active").attr("data-bgm-change-ability",r):b.addClass("active").attr("data-bgm-change-ability",q)}),d.save({setting_id:+c.attr("data-setting-id"),bgm_change_ability:+c.attr("data-bgm-change-ability")===q?r:q})},setFateQuestSubView:function(){this.fateQuestSubView=new g,this.addSubView(this.fateQuestSubView)},popAbilityEffect:function(a){var b=this,c=this.npc_model.toJSON(),e=$(a.currentTarget).data("abilityKeyname"),f=c[e].ability_detail;this.popView=new d({className:"pop-ability-effect",title:n.getMessage("ability_effect_1"),body:_.template($("#tpl-condition-list").html(),{condition:f,isIOS:Game.ua.isIOS()}),flagBtnOk:1}),this.popView.render(),_.reduce(f,function(a,b){return a+=b.length},0)>8&&this.popView.$el.find(".prt-condition-list").flexslider({selector:".prt-condition-wrapper > .lis-condition-slider",animation:"slide",animationLoop:!1,slideshow:!1,prevText:"",nextText:"",start:function(){b.onFlexSliderStart()}}),this.popView.popShow()},onFlexSliderStart:function(){var a;this.popView.$el.find(".prt-condition-wrapper .lis-condition-slider").css("display","block"),a=this.popView.$el.find(".flex-viewport").height(),this.popView.$el.find(".flex-direction-nav").height(a),this.popView.$el.find(".flex-nav-next").css("opacity",1)},popExPoseOpen:function(){var a=this.exPoseOpen[0];a.showButtonFlag=!0,a.backLocationPath=this.getLocationPath(),this.popView=new d({className:"pop-ex-pose-open",title:n.getMessage("pop_ex_pose_open_1"),body:_.template($("#tpl-pop-ex-pose-open").html(),a),flagBtnClose:1,showEndCallback:function(){m.playSE("se/journal_se.mp3")}}),this.popView.render().popShow()},getLocationPath:function(){var a="";switch(this.set.cnt){case"party":a="list"===location.hash.split("/")[1]?s.PARTY_LIST:+s.PARTY_TOP,this.attr.deck_num&&this.attr.set_num&&(a+="/"+this.attr.deck_num+"/"+this.attr.set_num);break;case"profile":a=s.PROFILE;break;case"pushed_npc":a=s.PUSHED_NPC;break;case"evolution":a=s.EVOLUTION_NPC;break;case"enhancement":a=s.ENHANCEMENT_NPC;break;default:a=s.LIST}return a},popRemoveExPose:function(){this.popRemove(),this.exPoseOpen.shift(),this.exPoseOpen.length>0&&this.popExPoseOpen()},popComboNPCAnnounce:function(a){this.popView=new d({className:"pop-combo-npc",title:n.getMessage("pop_combo_npc_title"),body:_.template($("#tpl-pop-combo-npc").html(),a),flagBtnClose:1}),this.popView.render().popShow()},locationPoses:function(){var a=this.set.cnt,b=this.npc_model.toJSON(),c="party/set_poses/"+b.id+"/"+b.master.id;switch(a){case"party":var d="list"===location.hash.split("/")[1]?s.PARTY_LIST:+s.PARTY_TOP;c+="/"+d+"/"+this.deck_num+"/"+this.set_num,d===s.PARTY_LIST&&(c+="/"+this.attr.page);break;case"profile":c+="/"+s.PROFILE;break;case"pushed_npc":c+="/"+s.PUSHED_NPC;break;default:c+="/"+s.LIST}this.content_close(),o.hash(c,{refresh:!1})}});return t});