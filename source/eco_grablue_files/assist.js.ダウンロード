define(["backbone","model/token-data","model/content","model/quest/battlepoint-model","view/quest/item-popup","view/quest/abstract-view","view/popup","model/data","lib/jquery.tabs","util/language-message","view/quest/sub/_sub_multi_owner_list","util/navigate"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m={TYPE_ARRAY:["MULTI_BATTLE"],SUBVIEW_READY_EVENT:"readyTutorialMovie",LOWEST_RANK:10},n=1e3,o=9,p="enemy_name_render_wait",q=100,r=f.extend({quest_id:null,active_page_model:null,setAssistAdventData:null,setEventFilterData:{},lastSetAssistAdventTimeMs:0,isQuestAssist:!0,isMultiOwnerDisp:!1,events:{"tap .prt-raid-list .btn-multi-raid":"multiStartCheck","tap #tab-multi":"showMultiList","tap #tab-event":"showEventList","tap .btn-assist-priority-disable":"EnableEventPriority","tap .btn-assist-priority":"DisableEventPriority","tap .popAssistRaidMax .btn-usual-cancel":"popRemove","tap .popAssistRaidMax .btn-usual-ok":"popRemove","tap .pop-select-point .btn-join-battle":"selectBattlePoint","tap .pop-select-point .btn-usual-cancel":"popRemove","tap .pop-can-not-multi-battle .btn-usual-close":"popRemove","tap .popResearch .btn-usual-ok":"popRemove","tap .btn-post-key:not(.disable)":"battle_key_check","tap .btn-post-key.disable":"popRestriction","focus .frm-battle-key":"input_type_change","tap .prt-assist-raid-setting .btn-usual-setting":"popAssistRaidSetting","tap .pop-assist-raid-setting .btn-usual-ok":"postAssistRaidSetting","tap .pop-assist-raid-setting .btn-usual-cancel":"popRemove","tap .prt-assist-raid-setting .btn-set-assist-advent":"popSetAssistAdvent","tap .pop-set-assist-advent .btn-usual-ok":"postAssistInviteEventSelecter","tap .pop-set-assist-advent .btn-usual-cancel":"popRemove","tap .prt-assist-raid-setting .btn-set-event-filter":"popSetEventFilter","tap .pop-set-event-filter .btn-usual-ok":"postSetEventFilter","tap .pop-set-event-filter .btn-usual-cancel":"popRemove","tap .prt-attention-box .prt-list-title":"toggleAccordion","tap .btn-toggle-assist-owner":"onTapToggleAssistOwner"},initialize:function(a){this.content_bind(),this.BP_USE_TYPE_NORMAL=1,this.BP_USE_TYPE_SELECTED=2,this.tabFlag=a.tabFlag,this.isEventList="event"===this.tabFlag?1:0,this.isMultiOwnerDisp=_.isUndefined(a.assistPageType)?!1:1===+a.assistPageType,this.fromPage=a.fromPage||0,this.getInitialData(),this.setInitialModels()},getInitialData:function(){var a=new c({controller:"quest",action:"newassist",param:{is_event:this.isEventList}});this.stopListening(a,"sync"),this.listenToOnce(a,"sync",this.render),a.fetch()},setInitialModels:function(){var a=this;this.multi_list_model=new(h.extend({urlRoot:Game.baseUri+"rest/quest/assist_list/0"})),this.stopListening(this.multi_list_model,"sync"),this.listenTo(this.multi_list_model,"sync",function(b){a.multiListRender(b.toJSON()),a.multi_list_model.clear({silent:!0})}),this.event_list_model=new(h.extend({urlRoot:Game.baseUri+"rest/quest/assist_list/1"})),this.stopListening(this.event_list_model,"sync"),this.listenTo(this.event_list_model,"sync",function(b){a.eventListRender(b.toJSON()),a.event_list_model.clear({silent:!0})}),this.event_priority_model=new(b.extend({urlRoot:Game.baseUri+"rest/quest/assist_event_flag"}))},showMultiList:function(){this.trigger("xhrStart");var a=$(".onm-assist-priority").hasClass("btn-assist-priority");"event"!=this.tabFlag||a?(this.active_page_model=this.multi_list_model,this.multi_list_model.fetch()):this.locationAssistMulti()},showEventList:function(){this.trigger("xhrStart"),this.active_page_model=this.event_list_model,this.event_list_model.fetch()},render:function(a){var b=this;this.content_render(a);var c=a.toJSON().option;$(".prt-head-current").text(j.getMessage("quest_1")),this.$el.find(".prt-3tabs").tabs({tabClass:"btn-tabs",tabTarg:"prt-assist-contents"}),$(".btn-multi-raid").each(function(){return 700921==$(this).data("quest-id")||700931==$(this).data("quest-id")||700941==$(this).data("quest-id")||700951==$(this).data("quest-id")?($(".txt-baloon").html(j.getMessage("quest_2")),!1):void 0});var d=this.$el.find(".onm-assist-priority").hasClass("btn-assist-priority")||1===this.isEventList?"event":"multi";return this.renderControl(d,c.quest.assist_list,this.isMultiOwnerDisp),this.status_render(c.user_status),+Game.userRank>=m.LOWEST_RANK&&this.isQuestAssist===!0&&this.setTutorialMovieSubView(m,function(){b._showTutorialMoviePopup()===!0&&b.tutorialMovieSubView.popNoticeMovie(m.TYPE_ARRAY[0])}),this.trigger("loadEnd"),this},status_render:function(a){this.$el.find(".prt-user-status").html(_.template($("#status").html(),a)),this.numRepStatus($(".txt-stamina-value"),"num-stamina"),this.bp_replace($(".prt-user-bp-value"),$(".prt-user-bp-value").attr("title"))},ap_replace:function(a){a.html(""),a.each(function(){var a=Number($(this).attr("data-ap")),b=Number($(this).attr("data-ap-max"));if(0==a)$(this).html(j.getMessage("quest_3")).addClass("bp0");else if(b>a)for(var c=0;b>c;c++)a>c?$(this).append("<span class='ico-ap' />"):$(this).append("<span class='ico-ap-none' />");else for(var c=0;a>c;c++)$(this).append("<span class='ico-ap' />")})},multiListRender:function(a){var b=this.$el.find("#prt-multi-list");b.empty(),""==b.html()&&(b.html(_.template($("#tpl-multi-raid").html(),{item:a,is_event:!1})),this.ap_replace($(".prt-use-ap")),this.adjustEnemyName()),this.trigger("xhrEnd")},eventListRender:function(a){var b=this.$el.find("#prt-event-list");b.empty(),""==b.html()&&(b.html(_.template($("#tpl-multi-raid").html(),{item:a,is_event:!0})),this.ap_replace($(".prt-use-ap")),this.adjustEnemyName()),this.trigger("xhrEnd")},adjustEnemyName:function(){function a(){d.height()>0?i.resolve():h.setNamedTimeout(p,a,q)}function b(a){var b=0;return _.each($(a).find(".prt-boost-icon"),function(a){b+=$(a).width()}),b}var c=this.$el.find(".prt-assist-contents.active .prt-raid-list .lis-raid");if(0!==c.length){var d=c.eq(0).find(".txt-raid-name"),e=d.html(),f=parseInt(d.css("font-size"),10);d.html("A");var g=d.height();if(d.html(e),0===g){var h=this,i=$.Deferred();return i.done(function(){h.adjustEnemyName()}),void this.setNamedTimeout(p,a,q)}var j=f;_.each(c,function(a){var c=$(a).find(".txt-raid-name");c.width(c.width()-b(a));for(var d=!1,e=f;e>o;){if(!(c.height()>g)){d=!0;break}e--,c.css("font-size",e+"px")}d||c.css("width","auto"),j=Math.min(e,j)}),c.find(".txt-raid-name").css({fontSize:j+"px",height:g+"px",lineHeight:g+"px"})}},renderControl:function(a,b,c){switch(this.$el.find(".btn-tabs").removeClass("active"),this.$el.find(".prt-assist-contents").removeClass("active"),a){case"multi":this.$el.find("#tab-multi").addClass("active"),this.$el.find("#prt-assist-multi").addClass("active"),c||this.multiListRender(b);break;case"event":this.$el.find("#tab-event").addClass("active"),this.$el.find("#prt-assist-event").addClass("active"),c||this.eventListRender(b)}this.toggleAssistOwner(c,!0)},EnableEventPriority:function(){$(".onm-assist-priority").removeClass("btn-assist-priority-disable").addClass("btn-assist-priority"),this.event_priority_model.set({assist_event_flag:1}),this.event_priority_model.save()},DisableEventPriority:function(){$(".onm-assist-priority").removeClass("btn-assist-priority").addClass("btn-assist-priority-disable"),this.event_priority_model.set({assist_event_flag:0}),this.event_priority_model.save()},_showTutorialMoviePopup:function(){return this.enableTutorialMovie===!0&&this.tutorialMovieSubView.isShowedPopup(m.TYPE_ARRAY[0])===!1},checkJoinAssisRaidRequest:function(){var a=h.extend({urlRoot:Game.baseUri+"quest/check_join_assist_raid/"+this.quest_id}),b=new a;this.stopListening(b,"sync"),this.stopListening(b,"error"),this.listenToOnce(b,"sync",this.joinAssistRaidResult),this.listenToOnce(b,"error",this.error),Game.loading.xhrStart(),b.fetch()},joinAssistRaidResult:function(a){Game.loading.xhrEnd(),a.get("result")?this.battlePointCheckRequest():(this.popView&&this.popView.popDelete(),this.popView=new g({className:"popAssistRaidMax",title:j.getMessage("quest_6"),body:j.getMessage("quest_7"),flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow())},checkTimeAndDefeat:function(a){this.quest_id=$(a.currentTarget).attr("data-quest-id"),this.quest_type=$(a.currentTarget).attr("data-quest-type"),this.raid_type=$(a.currentTarget).attr("data-raid-type"),this.raid_id=$(a.currentTarget).attr("data-raid-id"),this.chapter_name=$(a.currentTarget).attr("data-chapter-name");var b=h.extend({urlRoot:Game.baseUri+"quest/check_time_and_defeat/"+this.raid_id}),c=new b;this.stopListening(c,"sync"),this.stopListening(c,"error"),this.listenToOnce(c,"sync",this.timeAndDefeatResult),this.listenToOnce(c,"error",this.error),c.fetch()},timeAndDefeatResult:function(b){b.get("result")?this.battle_select(b.get("is_raid_host"),b.get("quest_id")):(this.content_close(),a.history.navigate("raid_multi/"+this.raid_id,!0))},popRemove:function(){this.popView&&this.popView.popRemove()},battlePointCheckRequest:function(){var a=this;if(this.bp_select_type==this.BP_USE_TYPE_SELECTED)var b=function(b,c,d,e){a.popSelectPoint()};else var b=function(b,c,d,e,f,g){a.deck_select(b,c,d,e,f,g)};var c=new d({quest_id:this.quest_id,quest_type:this.quest_type,raid_type:this.raid_type,raid_id:this.raid_id,used_bp:this.used_bp,chapter_name:this.chapter_name,cjs_id:this.cjs_id,is_semi:this.is_semi});c.check_quest(b),this.listenEventAndCall("completeUseRecoveryItems",$("#wrapper"),function(){a.deck_select(a.quest_id,a.quest_type,a.raid_type,a.raid_id,a.used_bp,a.is_semi)})},deck_select:function(b,c,d,e,f,g){this.content_close(),"1"===g?a.history.navigate("quest/supporter_raid/"+e+"/"+b+"/"+c+"/"+f+"/0/"+g,!0):"1"===d&&a.history.navigate("quest/supporter_raid/"+e+"/"+b+"/"+c+"/"+f,!0)},multiStartCheck:function(a){var b=this,c=this.$el.find(a.currentTarget),d=c.data("quest-id"),e=c.data("raid-id"),f=c.data("timeline-id"),g=new(h.extend({urlRoot:Game.baseUri+"quest/check_multi_start"}));this.stopListening(g,"sync"),this.listenToOnce(g,"sync",function(d){var e=d.get("result");switch(e){case"error_unconfirmed":b.cautionPop(j.replaceMessage("quest_8",[d.get("limit_battle_count")]),"unconfirmed");break;case"error_deal_lock":case"error_deal_unconfirmed":0===+c.data("raid-type")?b.multi_raid(a):(b.cautionPopTitle=j.getMessage("deal_rock_popup_1"),b.cautionPop(j.getMessage("deal_rock_popup_2"),"deal_unconfirmed"));break;default:b.multi_raid(a)}}),g.set({quest_id:d,raid_id:e,timeline_id:f}),g.save()},multi_raid:function(a){this.quest_id=$(a.currentTarget).attr("data-quest-id"),this.quest_type=$(a.currentTarget).attr("data-quest-type"),this.raid_type=$(a.currentTarget).attr("data-raid-type"),this.raid_id=$(a.currentTarget).attr("data-raid-id"),this.chapter_name=$(a.currentTarget).attr("data-chapter-name"),this.cjs_id=$(a.currentTarget).attr("data-cjs-id"),this.is_semi=$(a.currentTarget).attr("data-is-semi");var b=this.$(a.currentTarget).data("raid-type");if(this.bp_select_type=this.$(a.currentTarget).data("bp-select-type"),this.used_bp=this.$(a.currentTarget).data("bp"),this.bp_select_type==this.BP_USE_TYPE_SELECTED){var c=this.used_bp.split(",");this.select_bp=this.used_bp,this.used_bp=c[0]}this.buff_name=this.$(a.currentTarget).data("buff-name"),0===b?this.checkTimeAndDefeat(a):1===b&&(this.bp_select_type==this.BP_USE_TYPE_SELECTED?this.popSelectPoint():this.checkJoinAssisRaidRequest())},battle_select:function(c,d){if(this.content_close(),1==c){var e=b.extend({urlRoot:Game.baseUri+"quest/update_quest_updated_at/"+d}),f=new e;this.stopListening(f,"sync"),this.listenToOnce(f,"sync",function(){a.history.navigate("quest/stage",!0)}),f.save()}else a.history.navigate("raid_multi/"+this.raid_id,!0)},selectBattlePoint:function(a){this.popRemove();var b=$(a.currentTarget).data("bp");this.bp_select_type=this.BP_USE_TYPE_NORMAL,this.used_bp=b,this.checkJoinAssisRaidRequest()},popSelectPoint:function(){var a=this.select_bp.split(","),b={bp1:a[0],bp2:a[1],addAbility:j.getMessage("quest_9")};this.popView&&this.popView.popDelete(),this.popView=new g({className:"pop-select-point",title:j.getMessage("quest_10"),body:_.template($("#tpl-point-select").html(),b),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.ap_replace($(".prt-choice-bp")),this.popView.popShow()},cautionPop:function(a,b){this.popView&&this.popView.popDelete(),this.popView=new g({className:"pop-can-not-multi-battle",title:this.cautionPopTitle?this.cautionPopTitle:j.getMessage("quest_135"),body:a,flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.popView.$el.find(".btn-usual-cancel").removeClass().addClass("btn-usual-close");var c=null;switch(b){case"unconfirmed":c=$("#tpl-btn-unconfirmed-list").html();break;case"deal_lock":case"deal_unconfirmed":c=$("#tpl-buttons-deal").html()}null!=c&&this.popView.$el.find(".prt-popup-footer").append(c),this.popView.popShow()},battle_key_check:function(){var a=$(".frm-battle-key").val();a=a.replace(/[Ａ-Ｚａ-ｚ０-９]/g,function(a){return String.fromCharCode(a.charCodeAt(0)-65248)}),this.post_battle_join(a)},post_battle_join:function(a){var c=new(b.extend({urlRoot:Game.baseUri+"quest/battle_key_check"}));this.stopListening(c),this.listenToOnce(c,"sync",this.checkBattleKeyResult),c.set({battle_key:a}),c.save()},checkBattleKeyResult:function(a){var b=a.toJSON();if("error_unconfirmed"===b.error)this.cautionPop("未確認バトルが"+b.count+"件以上あるため、<br>クエストの開始・マルチバトルへの<br>参加ができません。<br><br>未確認バトルを確認して下さい。","unconfirmed");else if(!b.battle_point_check){var c=(new e({recovery:2,raid_id:b.raid.multi_raid_id,chapter_name:b.chapter_name,quest_ap:b.used_battle_point,quest_id:b.raid.quest_id,type:b.raid.quest_type,cjs_id:b.cjs_id,is_semi:b.is_semi}),this);this.listenEventAndCall("completeUseRecoveryItems",$("#wrapper"),function(){c.deck_select(b.raid.quest_id,b.raid.quest_type,"1",b.raid.multi_raid_id,b.used_battle_point,b.is_semi)})}},input_type_change:function(a){setTimeout(function(){$(".frm-battle-key").attr("type","text")},100)},locationAssistMulti:function(){this.content_close(),a.history.navigate("quest/assist/multi/"+this.fromPage,!0)},popAssistRaidSetting:function(a){var b=$(a.currentTarget),c=b.data("title"),d=b.data("id"),e=b.data("target-columns"),f=j.replaceMessage("quest_assist_pop_2",{"%s":c});this.popView&&this.popView.popDelete(),this.popView=new g({className:"pop-assist-raid-setting",title:j.getMessage("quest_assist_pop_1"),body:f,flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),this.popView.$el.find(".btn-usual-ok").attr({"data-id":d,"data-target-columns":e}),this.popView.popShow()},postAssistRaidSetting:function(a){var c=$(a.currentTarget),d=this,e=_.isUndefined(c.data("set-flag"))?null:c.data("set-flag"),f={event_id:c.data("id"),target_columns:c.data("target-columns"),set_flag:e};this.trigger("xhrStart"),this.set_multi_join=new(b.extend({urlRoot:Game.baseUri+"quest/set_multi_join"})),this.set_multi_join.save(f,{success:function(){d.event_list_model.fetch(),d.popRemove()}})},popSetAssistAdvent:function(a){if(this.canSetAssistAdvent()){var b=$(a.currentTarget),c=0;this.$el.find(".btn-set-assist-advent").each(function(){1===+$(this).data("current-setting")&&c++});var d={currentSettingType:b.data("current-setting"),chapterName:b.data("chapter-name"),showExBossFlag:3===+c&&0===+b.data("current-setting")?!0:!1};this.setAssistAdventData={event_id:b.data("event-id"),target_columns:b.data("target-columns"),set_flag:1==b.data("current-setting")?0:1},this.popView=new g({className:"pop-set-assist-advent",title:j.getMessage("quest_assist_pop_1"),body:_.template($("#tpl-pop-set-assist-advent").html(),d),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow()}},postAssistInviteEventSelecter:function(){var a=this,c=new(b.extend({urlRoot:Game.baseUri+"quest/assist_invite_event_selecter"}));this.stopListening(c,"sync"),this.listenTo(c,"sync",function(){a.setAssistAdventData=null,a.lastSetAssistAdventTimeMs=a.getCurrentTime(),a.popRemove(),a.showEventList()}),this.postAssistInviteEventSelecter=function(){a.setAssistAdventData&&(a.trigger("xhrStart"),c.set(a.setAssistAdventData),c.save())},this.postAssistInviteEventSelecter()},popSetEventFilter:function(a){var b=$(a.currentTarget),c=b.data("event-id"),d=b.data("event-name"),e=b.data("current-setting"),f=0===+e?1:0;this.setEventFilterData={event_id:c,filter:f};var h=0===+e?"set_assist_event_2":"set_assist_event_1",i=j.replaceMessage(h,{"%s":d});this.popView=new g({className:"pop-set-event-filter",title:j.getMessage("quest_assist_pop_1"),body:i,flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow()},postSetEventFilter:function(){var a=this,c=new(b.extend({urlRoot:Game.baseUri+"rest/quest/set_event_filter"}));this.stopListening(c,"sync"),this.listenToOnce(c,"sync",this.resultEventFilter),this.postSetEventFilter=function(){a.trigger("xhrStart"),c.set(a.setEventFilterData).save()},this.postSetEventFilter()},resultEventFilter:function(a){var b=a.toJSON();this.setEventFilterData={},this.popRemove(),this.eventListRender(b)},getCurrentTime:function(){return(new Date).getTime()},canSetAssistAdvent:function(){return this.getCurrentTime()-this.lastSetAssistAdventTimeMs>n},toggleAccordion:function(a){var b=$(a.currentTarget),c=b.hasClass("open"),d=this.$el.find("."+b.data("target-class"));c||b.toggleClass("open"),d.stop().slideToggle(200,function(){c&&b.toggleClass("open")})},onTapToggleAssistOwner:function(){this.isMultiOwnerDisp=!this.isMultiOwnerDisp,this.toggleAssistOwner(this.isMultiOwnerDisp)},toggleAssistOwner:function(a,b){var c=$(".prt-head-current"),d=this.$el.find(".btn-toggle-assist-owner"),e=this.$el.find(".prt-assist-list"),f=this.$el.find(".prt-owner-list");if(b||l.hash(this.createCurrHash(),{refresh:!1,trigger:!1}),a)c.text(j.getMessage("quest_1")),d.removeClass("owner").addClass("assist"),e.removeClass("active"),f.addClass("active"),this.subMultiOwnerListView?this.subMultiOwnerListView.getStageList():(this.subMultiOwnerListView=new k,this.addSubView(this.subMultiOwnerListView),this.subMultiOwnerListView.subViewRender());else if(c.text(j.getMessage("quest_148")),!b){d.removeClass("assist").addClass("owner"),e.addClass("active"),f.removeClass("active");var g=this.$el.find(".prt-3tabs").children(".active");switch(g.attr("id")){case"tab-multi":this.showMultiList();break;case"tab-event":this.showEventList()}}this.setFlowBtnHash()},createCurrHash:function(){return this.isMultiOwnerDisp?"quest/multi/"+this.fromPage:"event"===this.tabFlag?"quest/assist/event"+(1!==this.fromPage?"/"+this.fromPage:""):"quest/assist/multi/"+this.fromPage},setFlowBtnHash:function(){var a=(this.isMultiOwnerDisp?"1":"0")+"/"+this.fromPage,b="quest/assist/unclaimed/"+a,c="quest/assist/history/1/"+a;this.$el.find(".flow-unclaimed").attr("data-href",b).data("href",b),this.$el.find(".btn-battle-history").attr("data-href",c).data("href",c)}});return r});