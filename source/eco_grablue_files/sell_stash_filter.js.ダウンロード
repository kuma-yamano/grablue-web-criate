define(["jquery","underscore","backbone","view/content","view/popup","view/common/filter_config","lib/shellapp","model/data","model/token-data","model/sound","constant/inventory","util/language-message"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m={PRESENT:"present",LIST_ALL:"listall",CONTAINER:"container"},n=d.extend({popOpenedFlg:!1,containerCategory:"",isWeapon:!0,itemKindName:"",sellCategory:"",listName:"",containerId:"",targetResult:{},listUpdateFunc:{},sendType:1,sellSendParams:{},moveSendParams:{},moveEndPointUrl:"",sellConfirmEndPointUrl:"",sellExecuteEndPointUrl:"",moveFilter:[],events:{"tap .prt-order-button .btn-order-sell":"onOrderSell","tap .prt-order-button .btn-order-container":"onOrderPerform","tap .pop-allocation-selecter.sell .btn-usual-ok:not(.disabled)":"sellAllocationSelector","tap .pop-allocation-selecter.perform .btn-usual-ok:not(.disabled)":"moveAllocationSelector","tap .pop-allocation-selecter .btn-usual-cancel":"popUpRemove","tap .pop-allocation-selecter .btn-reset-selecter":"popUpRemove","tap .pop-rarity-confarm .btn-usual-ok":"popOrderItemConfirm","tap .pop-rarity-confarm .btn-usual-cancel":"popUpRemove","tap .pop-order-item-empty .btn-usual-close":"popUpRemove","tap .pop-order-item-confarm .btn-usual-ok":"orderItemConfirm","tap .pop-order-item-confarm .btn-usual-cancel":"popUpRemove","tap .pop-order-sell-result .btn-usual-ok":"listUpdate","tap .pop-container-empty .btn-usual-ok":"locationShop","tap .pop-container-empty .btn-usual-cancel":"popUpRemove","tap .pop-container-list.sell-stash .btn-usual-cancel":"popUpRemove",'tap .pop-container-list.sell-stash .lis-container:not(".disabled")':"selectMoveContainer","tap .pop-container-list.sell-stash .lis-container.disabled":"errorSelectContainer","tap .prt-reset-filter .btn-reset-filter":"onAllocationReset","tap .pop-move-container-error .btn-usual-ok":"errorMoveContainer","tap .pop-move-container-result .btn-usual-ok":"listUpdate","change .pop-allocation-selecter.perform .prt-check-list.other input":"changeAllocationOther","tap .pop-ng-sell .btn-usual-ok":"popUpRemove","change .pop-allocation-selecter:not(.sell) input[data-radio-category]":"onChangeResettableRadioBtn","change .pop-allocation-selecter.sell input[data-radio-category]":"onChangeChooseOneCheckBox"},popUpRemove:function(){this.popView.popRemove(),this.popOpenedFlg&&(this.popOpenedFlg=!1)},onAllocationReset:function(){this.$el.find(".pop-allocation-selecter .prt-check-one input").removeAttr("checked"),this.$el.find(".pop-allocation-selecter.sell").find("#has-not-skill, #no-bonus").prop("checked",!0)},changeAllocationOther:function(a){var b=this.$el.find(".prt-check-list.other"),c=this.$el.find(a.currentTarget).prop("id");b.find("input:not(."+c+")").removeAttr("checked")},locationShop:function(){this.content_close(),c.history.navigate("shop",!0)},onOrderSell:function(a){this.sellCategory=this.$el.find(a.currentTarget).data("category"),this.isWeapon=this.sellCategory===k.ITEM_KIND_NAME.WEAPON,this.itemKindName=this.isWeapon?l.getMessage("sell_stash_filter_7"):l.getMessage("sell_stash_filter_8"),a.preventDefault(),this.popAllocationSelector("sell",this.sellCategory)},setSellListParams:function(){switch(this.listName){case m.CONTAINER:this.sellConfirmEndPoint="rest/container/"+this.sellCategory+"/tidy/sell_list",this.sellSendParams={filter:this.loadAllocationSetting("sell",this.sellCategory),container_id:this.containerId};break;default:this.sellConfirmEndPoint="distribution_sell/list",this.sellSendParams={filter:this.loadAllocationSetting("sell",this.sellCategory),type:this.sendType,is_term:this.$el.find(".btn-tabs.infinite").hasClass("active")?0:1,item_kind:this.isWeapon?1:2}}},sellAllocationSelector:function(){var a=this;this.setSellListParams(),this.trigger("xhrStart"),this.getSellTargetItem(this.sellSendParams).done(function(b){a.resultTargetItem(b)})},resultTargetItem:function(a){return this.trigger("xhrEnd"),!a.can_sold&&a.filter_check?void this.popOverLimitRupie(a):(this.sellSendParams.ids=a.rewards,this.targetResult=a,a.rarity.length<=0?void this.popOrderItemEmpty():a.rarity[3]>0?void this.popRarityConfirm():void this.popOrderItemConfirm())},orderItemConfirm:function(){var a=this;switch(this.listName){case m.CONTAINER:this.sellExecuteEndPoint="rest/container/"+this.sellCategory+"/tidy/sell_execute";break;default:this.sellExecuteEndPoint="distribution_sell/execute"}this.trigger("xhrStart"),this.saveOrderSell(this.sellSendParams).done(function(b){a.resultOrderSell(b)})},resultOrderSell:function(a){this.trigger("xhrEnd"),this.popOrderSellResult(a)},setListUpdate:function(a){this.listUpdateFunc=a},setSendType:function(a){this.sendType=a},setListName:function(a){this.listName=a},setContainerId:function(a){this.containerId=a},listUpdate:function(){this.popUpRemove(),"function"==typeof this.listUpdateFunc&&this.listUpdateFunc()},loadAllocationSetting:function(a,b){var c=this,d=[],e={weapon:[f.DATA_ID.RARITY,f.DATA_ID.ATTRIBUTE,f.DATA_ID.WEAPON_TYPE,f.DATA_ID.BONUS,f.DATA_ID.HAS_SKILL,f.DATA_ID.NO_SKILL,f.DATA_ID.ANGEL,f.DATA_ID.NO_BONUS,f.DATA_ID.ELEMENT],summon:[f.DATA_ID.RARITY,f.DATA_ID.ATTRIBUTE,f.DATA_ID.BONUS,f.DATA_ID.ANGEL,f.DATA_ID.NO_BONUS,f.DATA_ID.ELEMENT]};return e[b].forEach(function(b){switch(b){case f.DATA_ID.RARITY:d[b]=c.getFilterParams("rarity"),"sell"===a&&(d[b]+="00");break;case f.DATA_ID.ATTRIBUTE:d[b]=c.getFilterParams("attribute");break;case f.DATA_ID.WEAPON_TYPE:d[b]=c.getFilterParams("weapon-kind");break;case f.DATA_ID.BONUS:d[b]=c.getFilterParams("has-bonus");break;case f.DATA_ID.HAS_SKILL:d[b]=c.getFilterParams("has-skill");break;case f.DATA_ID.NO_SKILL:d[b]=c.getFilterParams("has-not-skill");break;case f.DATA_ID.ANGEL:d[b]=c.getFilterParams("is-angel");break;case f.DATA_ID.NO_BONUS:d[b]=c.getFilterParams("no-bonus");break;case f.DATA_ID.ELEMENT:d[b]=c.getFilterParams("is-element")}}),d},getFilterParams:function(a){var b=this.popView.$el.find(".pop-allocation-selecter");if(!b.hasClass("pop-show"))return!1;var c="",d=b.find(".prt-check-list."+a+" input").length;if(d>1)for(var e=1;d>=e;e++)c+=b.find("input."+a+"-"+e).prop("checked")?1:0;else c=b.find("input."+a).prop("checked")?1:0;return c},onOrderPerform:function(a){var b=this;this.containerCategory=this.$el.find(a.currentTarget).data("category"),this.isWeapon=this.containerCategory===k.ITEM_KIND_NAME.WEAPON,this.itemKindName=this.isWeapon?l.getMessage("sell_stash_filter_7"):l.getMessage("sell_stash_filter_8"),this.trigger("xhrStart"),a.preventDefault(),this.getPossessContainer().done(function(a){""!==b.containerId&&delete a.list[b.containerId],b.resultPossessContainer(a)})},resultPossessContainer:function(a){return this.resultContainer=a,this.trigger("xhrEnd"),a.list?void this.popAllocationSelector("perform",this.containerCategory):void this.popContainerEmpty()},moveAllocationSelector:function(){this.moveFilter=this.loadAllocationSetting("perform",this.containerCategory),this.popContainerList()},errorSelectContainer:function(){this.popMoveContainerError()},errorMoveContainer:function(){this.popView.off(),this.popContainerList()},setMoveContainerParams:function(a){switch(this.listName){case m.CONTAINER:this.moveEndPoint="rest/container/"+this.containerCategory+"/tidy/move_execute",this.moveSendParams={filter:this.moveFilter,container_id:this.containerId,to:+a===k.LIST_ID?"list":"container"},"container"===this.moveSendParams.to&&(this.moveSendParams.to_container_id=a);break;default:this.moveEndPoint="distribution_container/execute",this.moveSendParams={filter:this.moveFilter,type:this.sendType,is_term:this.$el.find(".btn-tabs.infinite").hasClass("active")?0:1,item_kind:this.isWeapon?1:2,no:a}}},selectMoveContainer:function(a){var b=this,c=this.$el.find(a.currentTarget),d=c.data("id");this.setMoveContainerParams(d),this.trigger("xhrStart"),this.saveMoveContainer(this.moveSendParams).done(function(a){b.resultMoveContainer(a,c)})},resultMoveContainer:function(a,b){var c=b.find(".txt-container-name").html();this.trigger("xhrEnd"),this.popMoveContainerResult(c,a)},popOrderItemEmpty:function(){var a="present"===this.listName?l.getMessage("sell_stash_filter_2"):this.isWeapon?l.getMessage("sell_stash_filter_22"):l.getMessage("sell_stash_filter_23");this.popView=new e({className:"pop-order-item-empty",title:l.getMessage("sell_stash_filter_31"),body:a+"<br><br>",flagBtnClose:1}),this.popView.render().popShow()},popRarityConfirm:function(){this.popView=new e({className:"pop-rarity-confarm",title:l.getMessage("sell_stash_filter_3"),body:l.getMessage("sell_stash_filter_4"),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow()},popAllocationSelector:function(c,d){var f,g=this.isWeapon?l.getMessage("sell_stash_filter_32"):l.getMessage("sell_stash_filter_33");this.popView=new e({className:"pop-allocation-selecter "+c,title:l.replaceMessage("sell"===c?"sell_stash_filter_5":"sell_stash_filter_6",[g]),body:b.template(a("#tpl-allocation-filter-sell-stash").html(),{target:d,action:c}),flagBtnOk:1,flagBtnCancel:1,btnOkClassName:"disabled",showEndCallback:function(){f.removeClass("disabled")}}),this.popView.render(),f=this.popView.$el.find(".btn-usual-ok"),f.html("sell"===c?l.getMessage("sell_stash_filter_9"):l.getMessage("sell_stash_filter_10")),this.popView.popShow()},popOrderItemConfirm:function(){var c=this.targetResult.price,d=this.targetResult.memorial_bonus,f=parseInt(this.targetResult.money,10),g=c+d+f,h=l.replaceMessage("sell_stash_filter_26",{"%s":d},d),i=l.replaceMessage("sell_stash_filter_27",{"%s1":f,"%s2":g},g),j={item:this.targetResult,bonusRupiTxt:h,changeLupiTxt:i,target:this.isWeapon?l.getMessage("sell_stash_filter_34"):l.getMessage("sell_stash_filter_35")};this.popView=new e({className:"pop-order-item-confarm",title:l.getMessage("sell_stash_filter_31"),body:b.template(a("#tpl-order-sell-confarm").html(),j),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow()},getPopOrderSellResultMessage:function(){switch(this.listName){case m.PRESENT:return l.getMessage("sell_stash_filter_21");case m.LIST_ALL:return l.getMessage("sell_stash_filter_20");case m.CONTAINER:return l.getMessage("container_22")}},popOrderSellResult:function(c){var d=c.lupi+c.price,f=l.replaceMessage("sell_stash_filter_28",{"%s":d},d),g={item:c,sellResultLupi:f,target:this.itemKindName,listName:this.getPopOrderSellResultMessage()};this.popView=new e({className:"pop-order-sell-result",title:l.getMessage("sell_stash_filter_11"),body:b.template(a("#tpl-order-sell-result").html(),g),flagBtnOk:1}),this.popView.render().popShow()},popContainerEmpty:function(){this.popView=new e({className:"pop-container-empty",title:l.getMessage("sell_stash_filter_12"),body:a("#tpl-no-container").html(),flagBtnOk:1,flagBtnCancel:1}),this.popView.render(),this.popView.$el.find(".pop-container-empty .btn-usual-ok").html(l.getMessage("sell_stash_filter_16")),this.popView.popShow()},popContainerList:function(){this.popView=new e({className:"pop-container-list sell-stash",title:l.getMessage("sell_stash_filter_1"),body:b.template(a("#tpl-container-list").html(),{list:this.resultContainer.list,itemKindName:this.itemKindName}),flagBtnCancel:1}),this.popView.render().popShow()},popMoveContainerError:function(){this.popView=new e({className:"pop-move-container-error",title:l.getMessage("sell_stash_filter_17"),body:l.getMessage("sell_stash_filter_18"),flagBtnOk:1}),this.popView.render().popShow()},popMoveContainerResult:function(c,d){var f=parseInt(d.count,10)>0,g=this.isWeapon?l.pluralMessage(l.getMessage("sell_stash_filter_36"),d.count):l.pluralMessage(l.getMessage("sell_stash_filter_37"),d.count),h="",i="";f?(h=l.getMessage("sell_stash_filter_19"),i=l.replaceMessage("sell_stash_filter_29",{"%s1":g,"%s2":d.count},d.count)):(h=l.getMessage("sell_stash_filter_1"),i=l.replaceMessage("sell_stash_filter_30",{"%s":this.itemKindName}));var n={name:c,isContainer:this.listName===m.CONTAINER,isMoved:f,result:d,resultMoveTxt:i};this.popView=new e({className:"pop-move-container-result",title:h,body:b.template(a("#tpl-move-container-result").html(),n),flagBtnOk:1,showEndCallback:function(){f&&j.playSE(k.SE.MOVE_ITEM)}}),this.popView.render().popShow()},popOverLimitRupie:function(c){this.popView=new e({className:"pop-ng-sell",title:l.getMessage("sell_stash_filter_24"),body:b.template(a("#pop-ng-sell").html(),{heldRupie:l.replaceMessage("sell_stash_filter_25",{"%s":c.money},c.money)}),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()},getSellTargetItem:function(b){var c=null,d=new(i.extend({urlRoot:Game.baseUri+this.sellConfirmEndPoint}));return this.stopListening(d,"sync"),this.listenTo(d,"sync",function(a){c.resolve(a.toJSON())}),this.getSellTargetItem=function(b){return c=a.Deferred(),d.set(b),d.save(),c},this.getSellTargetItem(b)},saveOrderSell:function(b){var c=null,d=new(i.extend({urlRoot:Game.baseUri+this.sellExecuteEndPoint}));return this.stopListening(d,"sync"),this.listenTo(d,"sync",function(a){c.resolve(a.toJSON())}),this.saveOrderSell=function(b){return c=a.Deferred(),d.set(b),d.save(),c},this.saveOrderSell(b)},getPossessContainer:function(){var b,c=null;return b=this.listName===m.CONTAINER?new(i.extend({urlRoot:Game.baseUri+"rest/container/popup_move_list/"+this.containerCategory})):new(i.extend({urlRoot:Game.baseUri+"container/containers/"+this.containerCategory})),b.listenToOnce(b,"sync",function(a){c.resolve(a.toJSON())}),c=a.Deferred(),b.fetch(),c},saveMoveContainer:function(b){var c=null,d=new(i.extend({urlRoot:Game.baseUri+this.moveEndPoint}));return this.stopListening(d,"sync"),this.listenTo(d,"sync",function(a){c.resolve(a.toJSON())}),this.saveMoveContainer=function(b){return c=a.Deferred(),d.set(b),d.save(),c},this.saveMoveContainer(b)},onChangeResettableRadioBtn:function(c){var d=a(c.target).data("radio-category"),e=this.popView.$el.find('input[data-radio-category="'+d+'"]');b.each(e,function(b){b!==c.target&&a(b).prop("checked",!1)})},onChangeChooseOneCheckBox:function(b){this.onChangeResettableRadioBtn(b),a(b.target).prop("checked",!0)}});return n});