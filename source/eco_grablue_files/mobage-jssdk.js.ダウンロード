define(["jquery","underscore","util/navigate","model/token-data","util/language-message"],function(a,b,c,d,e){function f(c,d,e,f){function g(a){function g(a,b,d){var e="[JSSDK] response status "+a.status,f=0===a.status?"F":"B";e+=" error Type "+f+" random code "+j,h.reportError(e,c,null,null,null,function(){d&&d(a,b,j)})}var j=("0000"+b.random(1,99999)).slice(-5),k="t="+(new Date).getTime()+"&uid="+h.userId+"&code="+j;c+=(c.indexOf("?")>=0?"&":"?")+k;var l=new XMLHttpRequest;if(l.open("POST",c),l.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.shellAppFlag&&(l.setRequestHeader("X-MOBAGE-SHELLAPP",1),a)){var m=a.getVersionName(),n=Number(a.getVersionCode());"1.0"===m&&n&&n>0&&(m+=".0."+n),l.setRequestHeader("X-MOBAGE-SHELLAPP-VERSION",m)}l.setRequestHeader("X-VERSION",h.version),l.onreadystatechange=function(){if(4===l.readyState){if(200<=l.status&&l.status<300){var a=l.response;i.resolve(a),e&&e(a)}else{var b=l.statusText;i.reject(b),g(l,b,f)}l.onreadystatechange=new Function}},l.send(JSON.stringify(d))}var h=window.Game,i=new a.Deferred;return h.shellAppFlag?require(["lib/shellapp"],function(a){g(a)}):g(),i.promise()}function g(a){if(a!==i){var b=0===a.indexOf("#")?a:j;c.hash(b,{refresh:!0})}}var h="mobage",i="null",j="#top",k="grbl",l="1",m=!1,n=!1,o=null,p=null,q=null,r=null,s={},t={},u=t.callAfterReady=function(a){a&&(n?a():document.addEventListener("mobageReady",function(){n=!0,a()}))};t.requireOnceJSSDKClient=function(a){if(a&&!m){m=!0;var b=document.createElement("script");b.type="text/javascript",b.async=!0,b.src=a,document.getElementsByTagName("script")[0].parentNode.appendChild(b)}},t.mobageInit=function(a){return a?void u(function(){if(o!==a.clientId||p!==a.redirectUri){o=a.clientId,p=a.redirectUri;try{window.mobage.init(a)}catch(b){o=null,p=null}}}):null},t.mobageGetConnectedStatus=function(b,c,d){var e=new a.Deferred;return u(function(){window.mobage.oauth.getConnectedStatus(b,function(a,b){b?(e.resolve(b),c&&c(b)):(e.reject(a),d&&d(a))})}),e.promise()};var v=t.mobageConnect=function(c,d,e){var f=new a.Deferred;return c=b.defaults(c,{customTheme:k,appearanceVersion:l}),u(function(){window.mobage.oauth.connect(c,function(a,b){a?(f.reject(a),e&&e(a)):(f.resolve(b),d&&d(b))})}),f.promise()},w=t.login=function(a,c,d,e){var h=window.Game,i=c&&c.response||{},j={code:i.code,state:i.state,session_state:i.session_state},k=a&&a.redirectUri||p;return b.isUndefined(d)&&(d=g),b.isUndefined(e)&&(e=function(a,b,c){if(h.view)h.view.trigger("data_error",[a.status,c]);else{var d=h.message.connectionError;alert(d)}}),f(k,j,d,e)},x=t.tryLogin=function(c,d,e,f){b.isUndefined(e)&&(e=g);var h=new a.Deferred;return w(c,d,function(a){"#authentication/failed_empty"===a||"#authentication/failed_exist"===a?(h.reject(),f&&f()):(h.resolve(),e&&e(a))},function(a,b,c){h.reject(),f&&f()}),h.promise()},y=(t.singleLogin=function(b,c,d){var e=new a.Deferred;return window.ignoreResize=!0,v(b,function(a){w(b,a,c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}).always(function(){window.ignoreResize=!1;var b=a&&a.response&&a.response.session_state;b&&B(b)})},function(a){e.reject(a)}),e.promise()},t.trySingleLogin=function(b,c,d){var e=new a.Deferred;return v(b,function(a){x(b,a,c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}).always(function(){var b=a&&a.response&&a.response.session_state;b&&B(b)})},function(a){e.reject(a)}),e.promise()}),z=t.mobageLogout=function(b,c,d){C().done(function(){var e=new a.Deferred;return u(function(){window.mobage.oauth.logout(b,function(a,b){a?(e.reject(a),d&&d(a)):(e.resolve(b),c&&c(b))})}),e.promise()})},A=t.logout=function(a,c,d){C().done(function(){return b.isUndefined(c)&&(c=g),b.isUndefined(d)&&(d=null),f("logout",a,c,d)})};t.singleLogout=function(b,c,d){var e=new a.Deferred;return z(b,function(a){A(b,c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)})},function(a){e.reject(a)}),e.promise()};t.mobageSubscribeLogin=function(a,c){b.isUndefined(c)&&(c=function(b){y({state:a})}),u(function(){if(q!==a){q=a;var b="oauth.loginRequired",d=s[b];d&&window.mobage.event.unsubscribe(d),s[b]=window.mobage.event.subscribe(b,function(){c&&c(b)})}})};var B=t.mobageSubscribeLogout=function(a,c){b.isUndefined(c)&&(c=function(b){A({platform:h,session_state:a})}),u(function(){if(r!==a){r=a;var b="oauth.sessionStateChange",d=s[b];d&&window.mobage.event.unsubscribe(d),s[b]=window.mobage.event.subscribe(b,a,function(a){"changed"===a&&c&&c(b)})}})},C=t.checkAbilityToLogout=function(){function b(a){a.get("result")?c.resolve():(require(["view/popup"],function(a){var b=new a({className:"pop-cannot-logout",title:e.getMessage("logout_error_01"),body:e.getMessage("logout_error_02"),flagBtnClose:1,flagBtnOk:0});b.render().popShow()}),c.reject())}var c=a.Deferred();if(Game.ua.isMbga()){var f=new(d.extend({urlRoot:Game.baseUri+"logout/logout_check"}));return f.stopListening(f,"sync"),f.listenToOnce(f,"sync",b),f.fetch(),c.promise()}return c.resolve().promise()};return t});