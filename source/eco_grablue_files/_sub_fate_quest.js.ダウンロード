define(["model/content","model/data","model/token-data","view/quest/fate","view/popup","util/language-message"],function(a,b,c,d,e,f){var g=2,h={MAIN_QUEST:0,SIDESTORY:1,FATE:2},i=d.extend({events:{"tap .prt-detail-action .btn-quest":"getNpcAbilityQuest","tap .btn-condition-locate.fate-episode":"handleFateEpisodeData","tap .pop-fate-quest .btn-start-quest":"onSelectQuest","tap .pop-fate-quest .btn-usual-close":"popRemove"},initialize:function(a){_.extend(this.events,d.prototype.events),this.content_bind(),this.init(g),this.questListInitModel.fetch(),a&&(this.evolutionCondition=a.evolutionCondition)},getNpcAbilityQuest:function(a){var c=this,d=this.$el.find(a.currentTarget),e=new(b.extend({urlRoot:Game.baseUri+"npc/npc_ability_quest/"+d.data("quest-id")}));this.listenToOnce(e,"sync",function(a){c.resultData=a.toJSON(),c.popFateQuest(c.resultData)}),e.fetch()},handleFateEpisodeData:function(){this.evolutionCondition&&this.popFateQuest(this.evolutionCondition)},popFateQuest:function(a){var b=a.quest_list,c="normal-size",d="min-size",g={ja:12,en:22},i=this;_.each(b,function(a,b){a.quest_name.length>=+g[Game.lang]&&(c=d),a.questNameAddClass=c});var j=0,k="",l="";if(this.evolutionCondition&&0===b[0].is_quest_open)switch(j=1,+a.popup_button_type){case h.MAIN_QUEST:k=f.getMessage("detail_btn_quest"),l="quest";break;case h.FATE:k=f.getMessage("detail_fate_pop"),l="quest/fate";break;case h.SIDESTORY:k=f.getMessage("detail_btn_sidestory"),l="sidestory"}this.popView=new e({className:"pop-fate-quest",title:f.getMessage("detail_fate_pop"),body:_.template($("#tpl-pop-fate-quest").html(),{fateQuestDataArr:b,duplicateKey:a.duplicate_key}),showStartCallback:function(){0!==j&&i.popView.$el.find(".btn-usual-ok").removeClass("btn-usual-ok").addClass("btn-usual-text").attr("data-href",l).text(k)},flagBtnClose:1,flagBtnOk:j}),this.popView.render().popShow()},popRequirement:function(a){this.popView.popDelete();var b=$(a.currentTarget).data("index"),c=this.resultData.quest_list[b];this.popView=new e({className:"pop-quest-requirement",title:f.getMessage("detail_fate_pop_2"),body:_.template($("#tpl-pop-quest-requirement").html(),{fateQuestData:c}),flagBtnClose:1,flagBtnOk:0}),this.popView.render().popShow()},popRemove:function(){this.popView.popRemove()}});return i});