define(["jquery","underscore","backbone","model/raid/setup","lib/raid/draw","lib/raid/motion","lib/raid/timeline","lib/raid/effect","lib/raid/display","lib/raid/cutin","lib/raid/destroy","model/cjs-loader","model/manifest-loader","lib/shellapp","lib/sound","model/sound","model/raid/condition","model/socket","view/help","view/popup","model/token-data","view/content","util/navigate","model/data","util/local-storage","flexslider","util/sprite-sheet-manager","view/raid/ui","util/cjs_weapon","util/language-message","catalog/ua","constant","constant/event"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G){var H="raid_ui_1",I=5,J=3,K=1,L=12,M=Math.round(1e3/L*100)/100,N=30,O=99,P=9999,Q=20,R="miss",S="resist",T="noeffect",U="dodge",V={EMPTY:"target_isEmpty",ALIVE:"target_isAlive",DEAD:"target_isDead",SUBMEMBER:"target_isSubMember",FULLHP:"target_isFullHP",FULLGAUGE:"target_isFullGauge",SELF:"target_isSelf",DIFFERENT_ATTR:"target_isDifferentAttr",CAN_NOT_REVIVE:"target_canNotRevive"},W="withdrawHideMaskTimeout",X=["70670","70950","80000","72830"],Y={1:10,2:15,3:20},Z="bgm/100_sfvcollabo_congratulations_loop.mp3",$=[1055,1056],_=3,aa=1e4,ba=3,ca={712954:{className:"img-riddle-splash",filePath:"quest/riddle/assets/bg/bg_22.jpg"},744554:{className:"img-riddle-splash",filePath:"quest/riddle/assets/bg/bg_22.jpg"}},da={712954:{getMessageId:"riddle_battle_1"},744554:{getMessageId:"riddle_battle_1"}},ea="Chrome"===Game.ua.browser.name&&+Game.ua.browser.major>=56,fa=document.getElementsByTagName("body")[0],ga="display-off";(n.isShellAppAndroid()&&0===Game.ua.versionCompare(Game.ua.os.version,"4.4.2")||E.isExceptionBattleChatButtonModel()===!0)&&(ga="display-off-opacity btn-silent-se");var ha,ia,ja="hide-hp",ka=9999,la=1,ma={},na=300,oa=20,pa=10,qa=Game.imgUri+"/sp/assets/npc/raid_normal/3999999999.jpg",ra=1,sa="setCss",ta="setVisibleCjs",ua="setIndexCjs",va="saveIndexCjs",wa="applySavedIndexCjs",xa="replace_bg",ya=[722611],za={7300393:{visibility:"hidden"},7300403:{visibility:"hidden"},7300413:{visibility:"hidden"},9101273:{visibility:"hidden"},9101353:{visibility:"hidden"}},Aa="raid:setup:COMPLETE_POST_PROCESS",Ba=!0,Ca=!1,Da=1254,Ea="prt-silent-se",Fa="se/btn_se/btn_se_03.mp3",Ga={CHARA_SINGLE:1,CHARA_ALL:2,GAME_PARAM:3},Ha={NONE:0,WAIT:1,FINISHED:2},Ia={REQUEST_ASSIST:"requestAssist",REQUEST_ASSIST_OVER:"requestAssistOver",UNAUTHORIZED_ASSIST:"unauthorizedAssist",TRIAL_BATTLE_NOTICE:"trialBattleNotice",NAVI_INFORMATION:"naviInfomation",BATTLE_CONDITION:"battleCondition",ARCARUM_TUTORIAL:"arcarum_tutorial",ARCARUM_STAGE_EFFECT:"arcarumStageEffect",REVENGE_BONUS:"revengeBonus",RARE_ENEMY_APPER:"rareEnemyApper",SUDDENLY_ATTACK:"suddenlyAttack"},Ja={SEAL_CHARGE_ATTACK:"1007",POISON:"1008",DOUBLE_ATTACK_DOWN:"1106",TRIPPLE_ATTACK_DOWN:"1107",SEAL_ABILITY:"1111"},Ka={RESURRECTION:1,SINGLE_HEALING:2,NINJA_JITSU:3,SINGLE_BUFF:4,CHARGE_BAR_ASSIGNMENT:5,SECRET_GEAR:6,HOSTILITY_ASSIGNMENT:7,USE_LUPIE:8,SWITCH_POSITION:9,ATTRIBUTE_SINGLE:10,ATTRIBUTE_SINGLE_EXCEPT_OWN:11,MAGIC_CIRCLE:12,SWITCH_SPECIAL:14},La="raid_union_summon",Ma=["raid_union_summon_summon1","raid_union_summon_summon2"],Na=-1,Oa=10104,Pa=20206,Qa={ON:1,SMALL:2,OFF:3},Ra=[[{x:30,y:-97},{x:-53,y:41}],[{x:30,y:6},{x:-44,y:-100}],[{x:15,y:39},{x:-2,y:-98}]],Sa=1,Ta="ab_all_3030267000_01",Ua={DAMAGE:1,STRENGTHEN:3,WEAKEN:4},Va={NORMAL:1,FULL:2},Wa=[{selector:".pop-summon-detail",popHideFunctionName:"popHideSummon"},{selector:".prt-ability-dialog",popHideFunctionName:"popHideAbility"},{selector:".pop-select-member",popHideFunctionName:"popHideSelectMember"},{selector:".prt-ability-stamped",popHideFunctionName:"popHideAbilityStamped"},{selector:".pop-ability-mark",popHideFunctionName:"popHideAbilityMark"},{selector:".pop-ability-hiddenweapon",popHideFunctionName:"popHideAbilityHiddenweapon"},{selector:".pop-ability-lupiflip",popHideFunctionName:"popHideAbilityLupiFlip"},{selector:".pop-ability-orderchange",popHideFunctionName:"popHideOrderChange"},{selector:".pop-raid-item",popHideFunctionName:"CancelTempItemUse"}],Xa=function(a,c,d,e){b.isFunction(d)&&(e=d,d=!1),(!ma[a]||Number(ma[a])<Number(c))&&(d||(ma[a]=c),e&&e())},Ya=function(a,b,c){return Xa("members",a,b,c)},Za=function(a,b,c,d){return Xa("member_log_"+a,b,c,d)},$a=function(a,b,c){return Xa("mvp",a,b,c)},_a=function(a,b,c){return Xa("user_param",a,b,c)},ab=function(a,b,c){return Xa("user_condition",a,b,c)},bb=function(a,b,c){return Xa("boss_recast",a,b,c)},cb=function(a,b,c){return Xa("boss_param",a,b,c)},db=function(a,b,c){return Xa("summon_update",a,b,c)},eb=function(a,b,c){return Xa("battle_status",a,b,c)},fb=function(a,b,c){return Xa("bgm",a,b,c)},gb=function(a,b,c){return Xa("field_effect",a,b,c)};!function(){var a={};ha=function(b){if(b){a[b]=!0;var c=window.stage;c&&c.pJsnData&&(c.pJsnData.bgm=b),p.playBGM(b)}},ia=function(c){b.has(a,c)||ha(c)}}();var hb,ib,jb;!function(){var a={};hb=function(b,c){c=0|c;var d=c-(0|a[b]);return 0>=d?0:d},ib=function(b,c){c=0|c,a[b]=c},jb=function(){a={}}}();var kb,lb=function(a){var b=a.lastIndexOf("/");return 0>b?"":a.substr(0,b)},mb=function(a){var b=a.lastIndexOf("/");return 0>b?a:a.substr(b+1)},nb=function(a){var b=a.lastIndexOf(".");return 0>b?"":a.substr(b+1)},ob=function(a){return{dirname:lb(a),basename:mb(a),extension:nb(a)}},pb=function(a,b){var c=ob(a),d=c.dirname?c.dirname+"/":"",e=c.extension?"."+c.extension:"";return d+b+e},qb=["ab_0004","ab_3000","ab_all_3020","ab_start","raid_win","quest_clear","quest_failed",La,"treasure_get","item_get","raid_parts_attack","raid_parts_back","raid_parts_turn","raid_parts_next","raid_cutin","raid_cutine","raid_reload","raid_chain","raid_effect_heal","raid_effect_buff","raid_effect_debuff","ab_all_70","raid_parts_auto","raid_parts_full_auto","raid_parts_chat_s","raid_parts_stamp_s","ab_enemy_action","ef_all_2000","ef_2000","raid_mortal_skip","raid_parts_turn_waiting"],rb=["usf_win","usf_lose","usf_arcade_1","usf_arcade_2"],sb=["usf_bonus","usf_perfect","usf_timeover"],tb=["sfv_win","sfv_lose"],ub=["raid_appear_round_1","raid_appear_round_2","raid_appear_round_final","raid_appear_ready_fight","raid_appear_stage_final","sfv_survival_start","sfv_congratulations","sfv_game_over","sfv_suvival_result"],vb=["vs_finish","vs_lose"],wb=["vs_start","vs_result","vs_lose","vs_congratulation"],xb=["trialbattle_game_end"],yb=["samurai_game_over","samurai_ippon","samurai_win"],zb=["arcarum_battle_end","arcarum_battle_win"],Ab=["arcarum_battle_end","arcarum_battle_win"],Bb=["arcarum_battle_end","arcarum_battle_win"],Cb="se/arcarm_tp_recover.mp3",Db="se/arcarum_battleend.mp3",Eb=Db,Fb=Db,Gb=function(){return{interval:{multilog:1e4,condition:1500,raidstate:1e3,balloon:2e3,chatlog:1e4,watching:1e3},cjs:{win:"raid_win",quest_clear:"quest_clear",quest_failed:"quest_failed",raid_union_summon:La,parts:["raid_parts_attack","raid_parts_back","raid_parts_turn","raid_parts_auto","raid_parts_next","raid_parts_chat_s","raid_parts_stamp_s","raid_parts_turn_waiting","raid_parts_full_auto"],raid_cutin:"raid_cutin",raid_cutine:"raid_cutine",raid_reload:"raid_reload",raid_chain:"raid_chain",arcade_quest_clear:"usf_win",arcade_quest_failed:"usf_lose",bonus_stage_quest_clear:"usf_perfect",bonus_stage_quest_failed:"usf_timeover",sfv_quest_clear:"sfv_win",sfv_quest_failed:"sfv_lose",sfv_congratulations:"sfv_congratulations",sfv_game_over:"sfv_game_over",sfv_suvival_result:"sfv_suvival_result",vs_result:"vs_result",vs_finish:"vs_finish",vs_lose:"vs_lose",vs_congratulation:"vs_congratulation",trialbattle_game_end:"trialbattle_game_end",samurai_game_over:"samurai_game_over",samurai_ippon:"samurai_ippon",samurai_win:"samurai_win",arcarum_battle_end:"arcarum_battle_end",arcarum_battle_win:"arcarum_battle_win",board_battle_end:"arcarum_battle_end",board_battle_win:"arcarum_battle_win",sequence_battle_end:"arcarum_battle_end",sequence_battle_win:"arcarum_battle_win"},grid:{parts:{raid_parts_attack:{x:350,y:475},raid_parts_back:{x:0,y:487},raid_parts_turn:{x:113,y:520},raid_parts_auto:{x:0,y:540},raid_parts_full_auto:{x:0,y:540},raid_parts_next:{x:640,y:487},raid_parts_chat_s:{x:2===+stage.pJsnData.mini_chat_stamp?150:515,y:540},raid_parts_stamp_s:{x:2===+stage.pJsnData.mini_chat_stamp?215:575,y:540},raid_parts_turn_waiting:{x:0,y:150}},player:[{x:430,y:360},{x:540,y:390},{x:465,y:485},{x:570,y:525}],playerFixed:[{x:430,y:360},{x:540,y:390},{x:465,y:485},{x:570,y:525}],playerL:{x:465,y:485},tutorial:[{x:465,y:485},{x:540,y:390}],s:{s1:[{x:150,y:520}],s2:[{x:215,y:440},{x:105,y:555}],s3:[{x:190,y:430},{x:150,y:625},{x:70,y:515}]},m:{m1:[{x:150,y:550}],m2:[{x:240,y:510},{x:100,y:575}],m3:[{x:190,y:430},{x:150,y:625},{x:70,y:515}]},l:{l1:[{x:110,y:660}],l2:[{x:110,y:660},{x:110,y:660}],l3:[{x:110,y:660},{x:110,y:660},{x:110,y:660}]},hit:{player:{x:0,y:0},boss:{s:{x:0,y:0},m:{x:-20,y:-40},l:{x:80,y:-120}}},effect:{player:{x:0,y:0},boss:{s:{x:0,y:0},m:{x:-20,y:-40},l:{x:80,y:-120}}},message:{player:{x:80,y:-170},boss:{s:{x:-60,y:-230},m:{x:-60,y:-230},l:{x:-75,y:-370}}},damage_position_plus:{boss:{s:{x:0,y:0},m:{x:0,y:0},l:{x:0,y:0}}}},relative:{offscreen:{player:350},summon:{x:0,y:0},summon_simple:{x:360,y:200},summon_union:{x:0},raid_cutin:{x:0},raid_cutine:{x:0},win:{x:0,y:-70},lose:{x:0,y:-70},turnbar:{x:70},treasure:{s:{x:30,y:-70},m:{x:60,y:-70},l:{x:120,y:-120}},treasure_multiple:{2:[{x:190,y:-220},{x:50,y:-155}],3:[{x:110,y:-300},{x:70,y:-105},{x:-10,y:-215}]},item:{s:{x:30,y:-70},m:{x:60,y:-70},l:{x:120,y:-120}}},timing:{0:0,1:3,2:6,3:9,4:12,5:15},key_enemy:{mode_1:1,mode_2:2,mode_3:3}}},Hb=function(){return{lock:0,target:0,attacking:0,replacehit:[],waitmode:["wait","wait","wait"],balloon:"wait",finish:!1,retire:!1,lose:!1,clear:!1,motion:!1,menu:!1,menuBeforeRematch:!1,attack_action:null,last_drop:null,raid_union_summon_name:"",is_summon_simple:"",tutorial_state:!1,rep:0,btn_lock:!1,defaultmotion:["stbwait","stbwait","stbwait","stbwait","stbwait","stbwait"],doneSetupMotionPlayer:[!1,!1,!1,!1,!1,!1],dropped:[],attack_count:0,$use_ability:null,already_finish:!1,node_finish:!1,cheer_compleate:!1,is_clear:!1,serif:1,ability_popup:1,ability_pick:null,ability_sub_param:[],pop_limit:!1,pop_revival:!1,battle_end:!1,is_normal_attack:!1,auto_attack:!1,enable_auto_button:!1,chat_category:1,stampPage:0,stampGet:0,key_enemy_dead:!1,union_enemy:!1,player:{param:[],condition:[],number:0,all_dead:!1,isPlayingDeadMotion:[!1,!1,!1,!1],attackMotionWait:[0,0,0,0],stbwaitAfterAttack2:[!1,!1,!1,!1],posSizeL:null,motion:[]},boss:{param:[],condition:[],last_die:null,all_dead:!1,form_change_tween:!1,form_change_command:!1,motion:[]},field:{hasFieldEffect:!1,tmpFieldNum:0,tmpPersonalField:{}},defend_order:{hasAssistUnitEffect:!1},timer:{},action:{ab_select:""},assist:{all:1,friend:1,guild:1},temporary:{small:0,large:0},potion:{count:0,limit_flg:!1,limit_number:0,limit_remain:0,isNoLongerAllowedElixir:!1},command_slide:{state:0,now_pos:0},bossmode:{looks:{mode:[],gauge:[]},already_changed:[]},finishAfterContribution:!1,is_escorted_character_dead:0,isVersusView:!1,isShowBossGauge:!0,logtimer:0,motion_lock:!1,remain_turn:0,hide_ability_pos:void 0,hide_ability_all:!1,isDrawBgImgByCjs:!1,backImage:{},isBackImageUpdated:!1,preemptiveDeferred:null,cutinDeferred:null,attackQueue:{queue:[],$useAbilityTmp:null,attackButtonPushed:!1,abilityRailUI:null,charaChangeFlag:!1,pause:!1,itemNumTmp:{Potion:null,TemporarySmall:null,TemporaryLarge:null,EventItem:{},ArcarumItem:{}},gUseAbility:[],gUseSummon:[]},isPlayingScenariosImmediately:!1,form_change_frame:{},pfMotion:["pf","pf_1","pf_2","pf_3","pf_4","pf_5"],defaultNpcSkipFrame:40,defaultWeaponSkipFrame:40,loadedStampVoice:[],arcarumStageEffectDeferred:null,naviInfoDeferred:null,suddenlyAttackDeferred:null,isNodeBossKillScenarios:!1,tnum:0,teamraidBossHp:"",assignHpSuperDamageSoon:!1,avmAbilityFlag:!1,avmSummonFlag:!1,hasHandlerScenariosImmediatelyFinished:!1}},Ib={s:{s1:[{x:220,y:110}],s2:[{x:70,y:110},{x:350,y:110}],s3:[{x:10,y:110},{x:430,y:110},{x:220,y:110}]},m:{m1:[{x:220,y:110}],m2:[{x:70,y:110},{x:350,y:110}],m3:[{x:10,y:110},{x:430,y:110},{x:220,y:110}]},l:{l1:[{x:75,y:86}],l2:[{x:70,y:110},{x:350,y:110}],l3:[{x:10,y:110},{x:430,y:110},{x:220,y:110}]}},Jb={LUCILIUS:1},Kb=500,Lb="xhrStart",Mb="xhrEnd",Nb=!1,Ob=null,Pb=null,Qb=11010,Rb=3e3,Sb=!1,Tb=10101,Ub=3e3,Vb=!1,Wb=function(b,c){if(stage&&stage.gGameStatus&&Sb!==!0){b=b||"",c=c||{},c.u=Game.userId;var d="ob/"+b,e={contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(c),url:Game.baseUri+d};a.ajax(e),Sb=!0,setTimeout(function(){Sb=!1},Rb)}},Xb=function(b,c){if(Vb!==!0){b=b||"",c=c||{},c.u=Game.userId;var d="oc/"+b,e={contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(c),url:Game.baseUri+d};a.ajax(e),Vb=!0,setTimeout(function(){Vb=!1},Ub)}},Yb=function(a,b){var c=b.playtime?b.playtime:10,d=a[0].timeline[0],e=4,g=c-e,h=!1,i=!1;if(e>c||!d)return f.mWaitAll(a,b);d.call(function(){createjs.Tween.get({},{useTicks:!0}).wait(g).call(function(){h=!0})}),f.mWaitAll(a,b);for(var j=0,k=a.length-1;k>=j;j++)for(var l=0,m=a[j].timeline.length-1;m>=l;l++)a[j].timeline[l].call(function(){if(h===!1&&i===!1){var a={c:{}};a.c[Qb]=1,Wb("r",a);var b={c:{}};b.c[Tb]=1,Xb("s",b),i=!0}});return!0},Zb=[],$b=v.extend({el:a(".contents"),stage:null,baseFps:12,currentFps:12,attackCount:20,use_ap:null,loadIconQueue:[],isRunningLoadIcon:!1,isDestroyed:!1,playingOthersCjsList:[],popScrollHeightDelta:0,naviInfoCompleteFlag:!1,attackDisableComment:"",hideRecoverAtMenu:!1,beforeAutoattackStatus:{},showArcarumStageEffect:!1,currentDamageSequencePoint:0,currentBonusSequencePoint:0,doAttackWhenCompleteNavi:!1,isForceAttackNavi:!1,isRematchAtAllDead:!1,abilityRailTurnWaiting:0,tmpCjsIndex:null,isHiddenweaponSkip:!1,naviEmphasis:null,abilityEmphasis:!1,initialize:function(c){this.content_bind(),this.trigger(Lb);var e=this,f=new d,g=c;this.assist_flg=!1,this.preemptiveDeferred=new a.Deferred,this.cutinDeferred=new a.Deferred,this.arcarumStageEffectDeferred=new a.Deferred,this.revengeBonusPUDeferred=new a.Deferred,window.play_down_se=!0,this.tmpAutoBtnDisplayFlg=!1;var h=a("#opaque-mask");h.show(),window.ignoreSkipAttackFrame={},g.time=Date.now(),f.save(g,{url:f.urlRoot(c.action,c.mode,c.is_multi,c.is_semi),silent:!0,error:function(){},success:function(){e.trigger(Mb),i.reqStartTime=parseInt(new Date/1e3);var d=f.toJSON();e.use_ap=d.use_ap,e.pJsnData=d;var j=Date.now()-g.time,k=d.turn_waiting+j;d.is_sequence=d.is_sequence||!1,e.isTrainingBattle=!!d.special_condition,d.base_fps>0&&(b.isUndefined(c.speed)?(12==d.base_fps&&(d.base_fps=18),e.currentFps=d.base_fps):2==c.speed?e.currentFps=1.5*e.baseFps:e.currentFps=2*e.baseFps);for(var l=!1,m=0,n=d.boss.param.length;n>m;++m)if(1==d.boss.param[m].alive&&0==d.boss.param[m].is_hostage){l=!0;break}if(l===!0)for(m=0,n=d.boss.param.length;n>m;++m)if(1==d.boss.param[m].is_hostage&&0==d.boss.param[m].alive){l=!1;break}if(b.isNull(d.special_condition_quest_result)||0!==+d.special_condition_quest_result?1===+d.special_condition_quest_result&&(location.hash="#result/"+d.raid_id):l=!1,1!=d.multi&&!l){if(!d.is_dungeon||!d.dungeon.dungeon_item)return void w.hash("#quest",{refresh:!0});e.dungeonItems=d.dungeon.dungeon_item;var o=new t({className:"pop-dungeon-item",title:D.getMessage("raid_2"),body:b.template(a("#tpl-dungeon-item").html(),{name:d.dungeon.drop_enemy,items:d.dungeon.dungeon_item}),flagBtnCancel:0,flagBtnOk:0});o.render().popShow(!0,50)}var q=new a.Deferred;q.done(function(){e.render(c)}),!d.bgm||d.is_arcade||d.is_survival||p.playBGM(d.bgm),d.is_dungeon&&(window.dungeonTransition=!0);var r=b.some(X,function(a){return a==d.location_id});Game.chatView&&Game.chatView.on("commentReady",function(a,b){a.channel===Game.chatView.CHANNEL_RAID&&e.notifyFirstChat(b)}),e.subArcarumTutorialRaidView=null;var s=d.arcarum||d.board||null;d.is_arcarum!==!0&&d.is_board!==!0||s.is_tutorial!==!0||(require(["view/raid/_sub_arcarum_tutorial"],function(a){e.subArcarumTutorialRaidView=new a({arcarumData:s}),e.addSubView(e.subArcarumTutorialRaidView)}),b.size(s.tutorial.start_battle_comment)>0&&e.updateBeforeAutoAttackStatus(Ia.ARCARUM_TUTORIAL,Ha.WAIT));var u=new a.Deferred;e.prepareLoading(d,r,function(){u.resolve()}),1==d.invite_enable&&e.activateMask();var v=new a.Deferred,x=new a.Deferred;u.done(function(){e.loadCJS(d,r,function(){v.resolve()}),e.loadSpriteSheet(function(){x.resolve()})});var y=new a.Deferred,z=e.$el.find(".prt-start-direction");a.when(v,x).done(function(){if(1>=d.battle.total||d.is_dungeon===!0)y.resolve();else if(d.is_arcade)z.css("display","none"),h.css("display","none"),y.resolve();else{var b=181/(d.battle.total-1);z.find(".prt-be").css({"-webkit-transform":"translate3d(-"+b+"px, 0, 0)",transform:"translate3d(-"+b+"px, 0, 0)"}).oneTransitionEnd(function(){z.off("transitionend webkitTransitionEnd"),e.$el.find(".prt-black-bg").css("display","none"),i.mSlideIn(),y.resolve(),a("body").hasClass("android2")&&setTimeout(function(){e.$el.find(".cnt-raid-stage").removeClass("anim-slide-in"),e.$el.find(".prt-slide-mask").removeClass("slide-in").css("display","none"),z.css("display","none"),h.css("display","none")},400)},600)}}),y.done(function(){var f=document.getElementById("canvas");if(null!==f){if(f.setAttribute("cjs-noclip","1"),a(f).on(sa,function(b,c,d){a(c).css(d)}).on(ta,function(a,b,c){switch(b){case"player":stage.gPlayerContainer.visible=c;break;case"enemy":stage.gBossContainer.visible=c}}).on(ua,function(a,c){b.each(c,function(a){var b=null;switch(a.target){case"player":b=stage.gPlayerContainer;break;case"enemy":b=stage.gBossContainer;break;case"nsp":b=stage.gNspContainer}b&&stage.gMasterContainer.setChildIndex(b,a.index)})}).on(va,function(a){e.tmpCjsIndex={player:stage.gMasterContainer.getChildIndex(stage.gPlayerContainer),enemy:stage.gMasterContainer.getChildIndex(stage.gBossContainer),nsp:stage.gMasterContainer.getChildIndex(stage.gNspContainer)}}).on(wa,function(a){e.tmpCjsIndex&&(stage.gMasterContainer.setChildIndex(stage.gPlayerContainer,e.tmpCjsIndex.player),stage.gMasterContainer.setChildIndex(stage.gBossContainer,e.tmpCjsIndex.enemy),stage.gMasterContainer.setChildIndex(stage.gNspContainer,e.tmpCjsIndex.nsp))}),window.CreateJsShell?1==Game.setting.cjs_mode&&f.setAttribute("cjs-context","shell"):1==Game.setting.cjs_mode&&(Game.ua.isChromeApp()||Game.ua.isAndApp()||Game.ua.isPcPlatform())&&0==navigator.platform.indexOf("Win")&&f.setAttribute("cjs-context","2d"),stage=new createjs.Stage(f,!0),window.CreateJsShell&&1==Game.setting.cjs_mode){var g=f.getAttribute("dena-context");if("shell"==g){for(var i=f.parentElement;i;i=i.parentElement)i.style.backgroundColor="transparent";e.$el.find(".prt-bg-effect-brightness, .prt-bg-effect-color").css("display","none")}}if(stage.clear(),createjs.denaVersion)createjs.Ticker.setFPS(e.currentFps),createjs.Ticker.addEventListener("tick",stage);else{if(a("body").hasClass("android4")){var j=f.getContext("2d");stage.funcUpdate=function(){j.clearRect(0,0,640,654),stage.Stage_originalUpdate()}}else stage.funcUpdate=function(){stage.Stage_originalUpdate()};createjs.Ticker.setFPS(e.currentFps),createjs.Ticker.addEventListener("tick",stage.funcUpdate)}stage.pJsnData=d,stage.gMasterContainer=new createjs.Container,stage.gSkipContainer=new createjs.Container,stage.gNspContainer=new createjs.Container,stage.gPlayerContainer=new createjs.Container,stage.gBossContainer=new createjs.Container,stage.gPartsContainer=new createjs.Container,stage.gAryRootAvatar=[],stage.gAryCntnAvatar=[],stage.gAryRootBoss=[],stage.gAryCntnBoss=[],stage.gAryRootParts=[],stage.gAryCntnParts=[],stage.gAryInterval=[],stage.gGameParam=b.defaults({fps:e.currentFps,spf:Math.round(1e3/e.currentFps*100)/100},Gb()),stage.gGameStatus=b.defaults({turn:d.turn,reload_flg:c.reload_flg||!1},Hb()),b.isUndefined(d.ability_turn)===!1&&(stage.gGameStatus.abilityTurn=d.ability_turn),+d.quest_id===Da?(Ca=!0,stage.gGameStatus.assignHpSuperDamageSoon=!0,e.switchAttackStatus(!1)):d.is_attack_disable&&e.switchAttackStatus(!1),stage.gGameStatus.isVersusView=r,stage.gGameStatus.isVersusView?X[0]==d.location_id?d.arcade&&d.arcade.is_bonus?(stage.gGameParam.cjs.win=stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.bonus_stage_quest_clear,stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.bonus_stage_quest_failed,stage.gGameStatus.remain_turn=+d.arcade.bonus_maxtrun-+d.turn+1):(stage.gGameParam.cjs.win=stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.arcade_quest_clear,stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.arcade_quest_failed):X[1]==d.location_id?d.is_survival?(stage.gGameParam.cjs.win=stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.sfv_congratulations,stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.sfv_game_over):(stage.gGameParam.cjs.win=stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.sfv_quest_clear,stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.sfv_quest_failed):X[3]==d.location_id&&(d.is_survival?(stage.gGameParam.cjs.win=stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.vs_congratulation,stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.vs_lose):(stage.gGameParam.cjs.win=stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.vs_finish,stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.vs_lose)):+d.collabo_type===ra?(stage.gGameParam.cjs.win=stage.gGameParam.cjs.samurai_ippon,stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.samurai_win,stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.samurai_game_over):d.is_trialbattle?stage.gGameParam.cjs.quest_failed=stage.gGameParam.cjs.trialbattle_game_end:stage.pJsnData.is_arcarum?(stage.gGameParam.cjs.win=stage.gGameParam.cjs.arcarum_battle_win,stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.arcarum_battle_win,e.arcarumRestTp=+stage.pJsnData.arcarum.rest_tp,Nb=0===e.arcarumRestTp,Pb=b.find(stage.pJsnData.arcarum.item,function(a){return 1===+a.item_type}),Ob=b.find(stage.pJsnData.arcarum.item,function(a){return 1===+a.is_resurrection})):stage.pJsnData.is_board?(stage.gGameParam.cjs.win=stage.gGameParam.cjs.board_battle_win,stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.board_battle_win,e.restTp=+stage.pJsnData.board.rest_tp,Nb=0===e.restTp):stage.pJsnData.is_sequence?(stage.gGameParam.cjs.win=stage.gGameParam.cjs.sequence_battle_win,stage.gGameParam.cjs.quest_clear=stage.gGameParam.cjs.sequence_battle_win,e.updateSequencePoint(stage.pJsnData.sequence.point)):e.isTrainingBattle&&(e.setSpecialConditionInfo(),e.updateSpecialConditionTurn(stage.pJsnData.turn)),stage.pJsnData.win_cutin_cjs&&(stage.gGameParam.cjs.quest_clear=stage.pJsnData.win_cutin_cjs),stage.pJsnData.lose_cutin_cjs&&(stage.gGameParam.cjs.quest_failed=stage.pJsnData.lose_cutin_cjs),stage.gGameStatus.summon_speed=d.summon_speed,stage.gGameStatus.serif=d.serif;var l=stage.gGameParam,m=stage.gGameStatus;b.each(d.boss.param,function(a,c){m.bossmode.looks.mode[c]=a.modechange,m.bossmode.looks.gauge[c]=a.modegauge,m.bossmode.already_changed[c]=!1,(b.isUndefined(a.message_position)||""===a.message_position.x)&&(stage.pJsnData.boss.param[c].message_position={x:l.grid.message.boss[d.boss.type].x,y:l.grid.message.boss[d.boss.type].y}),stage.pJsnData.boss.param[c].damage_position_plus?(""===stage.pJsnData.boss.param[c].damage_position_plus.x&&(stage.pJsnData.boss.param[c].damage_position_plus.x=l.grid.damage_position_plus.boss[d.boss.type].x),""===stage.pJsnData.boss.param[c].damage_position_plus.y&&(stage.pJsnData.boss.param[c].damage_position_plus.y=l.grid.damage_position_plus.boss[d.boss.type].y)):stage.pJsnData.boss.param[c].damage_position_plus={x:l.grid.damage_position_plus.boss[d.boss.type].x,y:l.grid.damage_position_plus.boss[d.boss.type].y}}),m.lock=b.isUndefined(d.special_skill_flag)?0:parseInt(d.special_skill_flag),e.$el.find(".btn-lock").addClass("lock"+m.lock),m.shouldPlayFixedBGM=d.fix_bgm?d.fix_bgm:!1,stage.pJsnData.tutorial_flag&&(l.grid.player[0].x=l.grid.tutorial[0].x,l.grid.player[0].y=l.grid.tutorial[0].y,l.grid.player[1].x=l.grid.tutorial[1].x,l.grid.player[1].y=l.grid.tutorial[1].y);var n=a.extend(!0,{},stage.pJsnData);stage.pJsnData.player.number=stage.pJsnData.player.number||stage.pJsnData.player.param.length,m.player.number=stage.pJsnData.player.number-1<=3?stage.pJsnData.player.number-1:3;for(var o=0,p=m.player.number;p>=o;++o)m.player.param.push(n.player.param[n.formation[o]]);m.is_escorted_character_dead=d.is_escorted_character_dead,e.checkPlayerAllDead(),e.$el.find('[class^="lis-character"]').children("img").attr("src",qa);for(var o=0,p=stage.pJsnData.boss.param.length;p>o;++o)m.boss.param.push(n.boss.param[o]);if(stage.pJsnData.battle.count>1)for(var o=0,p=l.grid.player.length;p>o;++o)e._getLsizePlayerPos()===o?l.grid.player[o].x=l.grid.playerL.x+l.relative.offscreen.player:l.grid.player[o].x+=l.relative.offscreen.player;if(1==stage.pJsnData.battle.count&&1==m.turn)for(var o=0,s=stage.pJsnData.player.param.length;s>o;++o)m.defaultmotion[o]="wait";if("l"===d.boss.type&&d.boss.param.length>=2&&(m.union_enemy=!0),window.CreateJsShell&&1==Game.setting.cjs_mode){var f=document.getElementById("canvas");if(f){var g=f.getAttribute("dena-context");"shell"==g&&(m.isDrawBgImgByCjs=!0)}}if(stage.gGameStatus.arcarumStageEffectDeferred=new a.Deferred,stage.gGameStatus.preemptiveDeferred=new a.Deferred,stage.gGameStatus.cutinDeferred=new a.Deferred,stage.gGameStatus.naviInfoDeferred=new a.Deferred,stage.gGameStatus.suddenlyAttackDeferred=new a.Deferred,stage.gGameStatus.backImage.firstImg=new createjs.Bitmap(Game.imgUri+stage.pJsnData.background),b.each(stage.pJsnData.background_image_object,function(a,b){stage.gGameStatus.isBackImageUpdated=!0;var c=a.replace(/.*\/([^.]*)\..*/,"$1");stage.gGameStatus.backImage[c]=new createjs.Bitmap(Game.imgUri+a)}),m.isDrawBgImgByCjs===!0?stage.addChild(stage.gGameStatus.backImage.firstImg):e.$el.find(".prt-bg-stage-distant").css("background-image","url("+Game.imgUri+stage.pJsnData.background+")"),e.TutorialPreRender(),e.rareEnemyAppearEffectDeferred=new a.Deferred,1==stage.pJsnData.battle.count&&stage.pJsnData.is_rare?(e.updateBeforeAutoAttackStatus(Ia.RARE_ENEMY_APPER,Ha.WAIT),setTimeout(function(){z.css("display","none"),h.css("display","none"),e.$el.find(".prt-rare-direction").show().addClass("anim-rare-direction").oneAnimationEnd(function(){a(this).css("display","none"),e.updateBeforeAutoAttackStatus(Ia.RARE_ENEMY_APPER,Ha.FINISHED),e.startAutoAttackIfCompletePreparation(!1),e.rareEnemyAppearEffectDeferred.resolve()},1600)},800)):e.rareEnemyAppearEffectDeferred.resolve(),1===d.battle.total||d.is_dungeon===!0){if(1===+d.battle.count&&b.has(ca,d.quest_id)){var t=a("#prt-image-over-stage");t.html(b.template(a("#tpl-img-assign").html(),ca[d.quest_id])).addClass("show");var u=t.find("."+ca[d.quest_id].className);u.one("tap",function(){t.addClass("fadeout").oneTransitionEnd(function(){t.removeClass("show fadeout")},600)})}setTimeout(function(){z.css("display","none"),h.css("display","none"),b.isNull(e.subArcarumTutorialRaidView)===!1&&(e.subArcarumTutorialRaidView.trigger("battleRaedy"),e.listenToOnce(e.subArcarumTutorialRaidView,"endArcarumTutorialText",function(){e.updateBeforeAutoAttackStatus(Ia.ARCARUM_TUTORIAL,Ha.FINISHED),e.startAutoAttackIfCompletePreparation(!1)}))},800)}kb=stage.gEnemyStatus=[];var v=d.boss.type+d.boss.number,w=Ib[d.boss.type][v],x=d.overdrive_image,y=d.is_semi;b.each(d.boss.param,function(a,c){var f,g=a.cjs.split("_")[1];a.enemy_id=g,a.overdrive_image=x,a.is_semi=y,a.isSamurai=+d.collabo_type===ra,a.switching_hp_gauge=d.switching_hp_gauge||!1,a.condition=b.defaults(a.condition,{debuff:[],buff:[]}),m.union_enemy&&(a.type="s"),f=kb[c]=new B.components.EnemyStatus(e.spriteSheetManager.getById(H),a,c,e.pJsnData.disp_hp_percent_disp),f.x=w[c].x,f.y=w[c].y,"l"!=a.type&&0!==parseInt(a.modeflag,10)&&e.$el.find(".prt-enemy-percent[target="+(c+1)+"]").addClass("has-mode-gauge")}),e.setTmpPersonalField(d.field_effect),e.createFieldConditionComponent(d.boss.param.length),d.is_defendorder&&e.createAssistUnitConditionComponent();var A=Date.now();if(e.abilityRailTurnWaiting=k>A?k-A:0,+e.abilityRailTurnWaiting>0){var C="turnWaitingEnd";e.clearTimeoutOne(C),e.setNamedTimeout(C,function(){e.abilityRailTurnWaiting=0,stage.gGameStatus.hasHandlerScenariosImmediatelyFinished||e.cjsTurnWaitingHide(),stage.gGameStatus.attackQueue.queue[0]&&"itemUse"!==stage.gGameStatus.attackQueue.queue[0].index?e.InvokeAttackQueue():e.isFullAutoAttacking()&&0===stage.gGameStatus.attackQueue.queue.length&&e.runFullAuto()},+e.abilityRailTurnWaiting)}y?e.requireIndividual("model/chat/semiraid").done(function(a){e.chatSemiraidModel=new a,q.resolve()}):q.resolve()}})}})},prepareLoading:function(c,d,e){var f=this.$el.find(".prt-start-direction"),g=0;if(this.isShowAutoattackSettingText=c.is_show_autoattack_setting_text,p.loadSE("se/treasure_se_6.mp3"),c.tutorial_flag!==!0&&this.isShowAutoattackSettingText!==g&&(this.$el.find(".prt-start-direction").removeClass("disable-ready-auto-setting"),this.renderReadyAutoSetting(!0)),c.is_arcarum?(this.$el.find(".cnt-raid-header .prt-battle-num .txt-battle").addClass("arcarum"),this.$el.find(".prt-start-direction .prt-battle-num .txt-battle").addClass("arcarum")):c.is_board?(this.$el.find(".cnt-raid-header .prt-battle-num .txt-battle").addClass("board"),this.$el.find(".prt-start-direction .prt-battle-num .txt-battle").addClass("board")):c.is_survival?(this.$el.find(".cnt-raid-header .prt-battle-num .txt-battle").addClass("stage"),this.$el.find(".prt-start-direction .prt-battle-num .txt-battle").addClass("stage")):d&&(this.$el.find(".cnt-raid-header .prt-battle-num .txt-battle").addClass("round"),this.$el.find(".prt-start-direction .prt-battle-num .txt-battle").addClass("round")),c.is_survival&&"undefined"!=typeof c.survival&&c.survival.is_score_buff)p.playBGM(c.bgm),this.popBattleService(c);else if(c.is_survival&&"undefined"!=typeof c.survival&&1==c.survival.stage_number){var h={cjsName:"vs_start",fpsNum:24,canvasElem:"canvas-vs-start",canvasWidth:640,canvasHeight:920};c.survival.playerCjsId=c.player.param[0].cjs,this.requireIndividual("view/raid/_play_pre_battle_sfv").done(function(a){a.setParams(h,c.survival)});var j=a("#"+h.canvasElem);j.addClass("sfv"),j.one("endPreBattleCjs",function(){a(this).off(),p.playBGM(c.bgm),e()})}else if(c.is_survival)p.playBGM(c.bgm),e();else if(c.is_arcade&&c.arcade.arcade_skip)p.playBGM(c.bgm),e();else if(c.is_arcade){var k={cjsName:"",fpsNum:24,canvasElem:"canvas-pre-battle",canvasWidth:640,canvasHeight:960,isBonus:c.arcade.is_bonus},l=c.player.param[0].cjs;if(c.arcade.is_bonus){k.cjsName="usf_bonus";var m={grp_me_0_01:1,kun_me_0_01:2,ogr_me_0_01:3,nnj_me_0_01:4,nnj_kt_0_01:4,stf_me_0_01:5,grp_me_1_01:6,kun_me_1_01:7,ogr_me_1_01:8,nnj_me_1_01:9,nnj_kt_1_01:9,stf_me_1_01:10}[l];m||(m=""),window.cjs_usf_bounus_mainchara=m}else{var n="usf_arcade_1";1<+c.arcade.stage_number&&(n="usf_arcade_2"),k.cjsName=n,c.arcade.special_skill=c.player.param[0].special_skill,c.arcade.playerCjsId=l}this.requireIndividual("view/raid/_play_pre_battle").done(function(a){a.setParams(k,c.arcade)}),a("#"+k.canvasElem).one("endPreBattleCjs",function(){a(this).off(),p.playBGM(c.bgm),e()})}else if(c.is_dungeon===!0){var o=c.battle.count.split(""),q="";b.each(o,function(a){q+='<div class="num-battle'+a+'"></div>'}),f.append('<div class="prt-battle-count"><div class="battle"></div>'+q+"</div>"),p.playSE("se/ready_se_1.mp3"),e()}else 1!==c.battle.total?(!b.isUndefined(c.move_background)&&c.move_background&&this.$el.find(".prt-progress-bg").find("img").attr("src",Game.imgUri+c.move_background),i.mBattleProgress(c,function(){e()})):(f.append('<div class="prt-ready"></div>'),c.is_arcarum?p.playSE("se/arcarum_ready.mp3"):p.playBattleReadySE(),e())},loadCJS:function(a,c,d){var e=[].concat(qb);c?X[0]==a.location_id?e=a.arcade&&a.arcade.is_bonus?b.union(e,sb):b.union(e,rb):X[1]==a.location_id?e=a.is_survival?b.union(e,ub):b.union(e,tb):X[3]==a.location_id&&(e=a.is_survival?b.union(e,wb):b.union(e,vb)):+a.collabo_type===ra?e=b.union(e,yb):a.is_trialbattle?e=b.union(e,xb):a.is_arcarum?e=b.union(e,zb):a.is_board?e=b.union(e,Ab):a.is_sequence&&(e=b.union(e,Bb)),
b.isUndefined(a.lose_cutin_cjs)||(e=b.union(e,[a.lose_cutin_cjs])),b.isUndefined(a.win_cutin_cjs)||(e=b.union(e,[a.win_cutin_cjs])),b.each(a.player.param,function(a){e.push(a.cjs),e.push(a.effect),a.companion_effect&&a.companion_effect!==a.effect&&e.push(a.companion_effect)}),b.each(a.boss.param,function(a){e.push(a.cjs),e.push(a.effect)}),b.isUndefined(a.is_boss)||""==a.is_boss||e.push(a.is_boss);var f=this,g=null;b.isUndefined(a.scenario)||(b.each(a.scenario,function(a){"arcarum_stage_effect"===a.cmd&&(g=a.arcarum_stage_effect)}),b.isNull(g)||(b.each(g,function(a){switch(a){case Ja.POISON:f.arcarumBattleStart={cjs:"arcarum_battle_start_1",msg:D.getMessage("arcarum_stage_effect_2")};break;case Ja.SEAL_CHARGE_ATTACK:f.arcarumBattleStart="arcarum_battle_start_2",f.arcarumBattleStart={cjs:"arcarum_battle_start_2",msg:D.getMessage("arcarum_stage_effect_3")};break;case Ja.SEAL_ABILITY:case"1111_2":f.arcarumBattleStart={cjs:"arcarum_battle_start_3",msg:D.getMessage("arcarum_stage_effect_4")};break;case Ja.DOUBLE_ATTACK_DOWN:case Ja.TRIPPLE_ATTACK_DOWN:f.arcarumBattleStart={cjs:"arcarum_battle_start_4",msg:D.getMessage("arcarum_stage_effect_5")};break;default:f.arcarumBattleStart={cjs:"arcarum_battle_start_1",msg:D.getMessage("arcarum_stage_effect_2")}}}),e.push(this.arcarumBattleStart.cjs)));var h=function(){var c=b.flatten(b.map(e,function(a){var c=l.manifest(a);return a===La&&(c=b.reject(c,function(a){return b.contains(Ma,a.id)})),c})),f=a.weapon_kind||{};c=C.addWeaponManifest(a.weapon,c,f.weapon2||null),m.once("complete",function(){d()}),m.loadManifest(c,!0)};1===Game.isSandbox&&this.listenToOnce(l,"failed",function(a){f.stopListening(l),f.popUnloadCjs(a,h)}),this.listenToOnce(l,"complete",function(){f.stopListening(l),h()}),l.loadFiles(e)},popUnloadCjs:function(c,d){if(1===Game.isSandbox){var e=new t({className:"pop-unload-cjs",title:"確認",body:b.template(a("#tpl-pop-unload-cjs").html(),{unloadedFiles:c}),flagBtnCancel:1,flagBtnOk:1});this.listenToOnce(e,"ok",function(){e.popRemove(),e.stopListening(),d()}),this.listenToOnce(e,"cancel",function(){w.hash("#quest",{refresh:!0})}),e.render().popShow()}},loadSpriteSheet:function(a){var b=Game.version?"?version="+Game.version:"";this.spriteSheetManager=new A([{id:H,src:B.utils.getImagePath()+"atlas/"+H+".json"+b}]),this.spriteSheetManager.addEventListener("complete",function(){a()}),this.spriteSheetManager.load()},showAttackButton:function(){stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),this._controlDomAttackButton(!0)},hideAttackButton:function(){stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"),this._controlDomAttackButton(!1)},showAttackCancelButton:function(){this.clearTimeoutOne("hideAttackCancelButton"),this.$el.find(".btn-attack-cancel").removeClass("display-off").addClass("display-on"),stage.gAttackCancelButton.show()},hideAttackCancelButton:function(a){var b=this.$el.find(".btn-attack-cancel");a=a||function(){},this.clearTimeoutOne("hideAttackCancelButton"),b.hasClass("display-on")?(b.removeClass("display-on").addClass("display-off"),stage.gAttackCancelButton.hide(),this.setNamedTimeout("hideAttackCancelButton",a,150)):a()},render:function(c){var j=this,k=this.$el.find(".prt-bg-stage-distant"),l=this.$el.find(".prt-enemy-gauge"),m=this.$el.find(".btn-assist"),n=this.$el.find(".img-diagram");stage.gMasterContainer.addChild(stage.gSkipContainer),stage.gMasterContainer.addChild(stage.gNspContainer);var o=stage.gGameParam,p=stage.gGameStatus,q=stage.pJsnData,r=stage.gPlayerContainer;if(stage.gAryRootAvatar=e.mAdd(p.player.param),stage.gAryCntnAvatar=e.mSet(q.player,stage.gAryRootAvatar,o,r),1==q.tutorial_flag&&stage.gAryRootAvatar.length>=2&&r.swapChildrenAt(1,0),e.mShow(stage.gAryCntnAvatar,p.player.param),stage.gMasterContainer.addChild(r),stage.gAryRootBoss=e.mAdd(p.boss.param),stage.gAryCntnBoss=e.mSet(q.boss,stage.gAryRootBoss,o,stage.gBossContainer),stage.gBossContainer.swapChildrenAt(2,1),p.union_enemy===!0){var s=stage.gBossContainer.children.length;b.each(p.boss.param,function(a,c){0==b.isEmpty(a.cjs_index)&&+a.cjs_index<s&&stage.gBossContainer.setChildIndex(stage.gAryCntnBoss[c],+a.cjs_index)})}stage.gMasterContainer.addChild(stage.gBossContainer),stage.addChild(stage.gMasterContainer),stage.gMasterContainer.setChildIndex(stage.gSkipContainer,0),stage.gMasterContainer.setChildIndex(stage.gNspContainer,0),stage.gMasterContainer.setChildIndex(stage.gBossContainer,0),stage.gMasterContainer.setChildIndex(r,1);var t=this;b.each(kb,function(a,b){stage.addChild(a)}),b.each(o.cjs.parts,function(a){stage.gAryRootParts.push(new lib[a])});for(var u=stage.gAryRootParts,v=stage.gAryCntnParts,w=o.grid,x=0,z=u.length;z>x;x++)v[x]=new createjs.Container,v[x].addChild(u[x]),stage.gPartsContainer.addChild(v[x]),v[x].x=w.parts[o.cjs.parts[x]].x,v[x].y=w.parts[o.cjs.parts[x]].y,v[x].visible=!1;stage.addChild(stage.gPartsContainer);for(var A=stage.gAryCntnAvatar.length,C=stage.gAryCntnBoss.length,E=g.mInit("avatar"),x=0,z=A;z>x;x++)E.timeline[x]=createjs.Tween.get(stage.gAryCntnAvatar[x],{override:!0,paused:!0});for(var F=g.mInit("boss"),x=0,z=C;z>x;x++)F.timeline[x]=createjs.Tween.get(stage.gAryCntnBoss[x],{override:!0,paused:!0});var G=g.mInit("common");G.timeline[0]=createjs.Tween.get({},{override:!0,paused:!0}),j.oTweenCommon=G,f.mWaitAll([E,F,G],{playtime:1}),G.timeline[0].call(function(){for(var a=0,b=A;b>a;a++)stage.gAryCntnAvatar[a].x-=9999}),f.mWaitAll([E,F,G],{playtime:1}),G.timeline[0].call(function(){for(var a=0,b=A;b>a;a++)stage.gAryCntnAvatar[a].x+=9999});var H=[];b.isUndefined(q.is_boss)||""==q.is_boss||G.timeline[0].call(function(){j.activateMask()}),f.mChangeMotionAll(stage.gAryRootAvatar,E.timeline,{motion:"hide",mc:p.player.param,type:"player"}),b.isUndefined(q.force_formation_pos)===!1&&(E.beforeX=[],b.each(q.force_formation_pos,function(a,c){var d=b.indexOf(stage.pJsnData.formation,""+c);E.beforeX[d]=stage.gGameParam.grid.player[+a-1].x})),G.timeline[0].call(function(){var a=j._getLsizePlayerPos();null!==a&&(i.visiblePlayerDisplay(a),i.setLsizePlayerDisplay(a)),b.isUndefined(q.force_formation_pos)===!1&&b.each(q.force_formation_pos,function(a,c){i.changePlayerCjsPos(b.indexOf(stage.pJsnData.formation,""+c),+a-1)}),b.isUndefined(q.force_special_skill_type)!==!1||1!==+q.force_special_skill_type&&2!==+q.force_special_skill_type||j._removeSubCommand(),j.renewCharaList(24)}),l.css("display","none");for(var I={},x=0,z=A;z>x;x++)i.mPlayerGaugeHp(E.timeline[x],{pos:x,param:p.player.param[x]}),i.mPlayerGaugeRecast(E.timeline[x],{pos:x,param:p.player.param[x]}),i.mPlayerGaugeAttr(E.timeline[x],{pos:x,param:p.player.param[x]}),I=q.player.param[q.formation[x]],1===+I.alive&&i.mSetSpecialSkip(I.skip_flag===!0,!1,x,!1);var J=this.getRemainEnemyPosIdList();if(C>1&&1===J.length)this.changeEnemyStatusSize(J[0],"l1",0,!0),i.mBossGaugeName(F.timeline[J[0]],q.boss.type,{pos:J[0],param:p.boss.param[J[0]]});else{for(var x=0,z=C;z>x;x++)i.mBossGaugeHp(F.timeline[x],kb,q.boss.type,{pos:x,param:p.boss.param[x]}),i.mBossGaugeRecast(F.timeline[x],kb,q.boss.type,{pos:x,param:p.boss.param[x]}),i.mBossGaugeName(F.timeline[x],q.boss.type,{pos:x,param:p.boss.param[x]});this.changeEnemyStatusLayout(q.hud_layout_type,J)}if(b.each(J,function(a){kb[a].hide()}),a("#prt-sub-command-group").find(".btn-set-skip-special-all").addClass(this._getSkipSpecialAllClassName()),this.$el.find(".prt-command-summon").find(".prt-list-top").addClass("summon-off"),q.summon)for(var K=q.summon,x=0,z=K.length;z>x;x++){var L=this.$el.find(".lis-summon").eq(x);if(L.addClass("off"),K[x].id){var M={"summon-id":x+1,"summon-name":K[x].name,"summon-attribute":K[x].attribute,"summon-skill-name":K[x].skill,"summon-comment":K[x].comment,"summon-recast":K[x].recast,"summon-start-recast":K[x].start_recast,"summon-once-flg":K[x].special_once_flag,"summon-require":K[x].require,"summon-code":K[x].id,"summon-protection-name":K[x].protection_name||D.getMessage("raid_3"),"summon-protection":K[x].protection||"","summon-quality":K[x].quality||0,"summon-evolution-flag":K[x].evolution_flag,"summon-evolution":K[x].evolution};1==K[x].sub_skill_flag&&(M["summon-sub-skill-flag"]=!0),L.attr(M).append('<div class="ico-summon-recast txt-recast"><span class="num-recast-s'+K[x].recast+'"></span></div>').children("img").attr("src",Game.imgUri+"/sp/assets/summon/raid_normal/"+K[x].image_id+".jpg"),K[x].summon_skin_flag===!0&&(L.addClass("is-skin"),L.find(".img-summon-skin").attr("src",Game.imgUri+"/sp/assets/summon/raid_normal/"+K[x].summon_skin_id+".jpg"),L.find(".prt-summon-attribute").addClass("attribute-"+K[x].attribute))}else L.children("img").attr("src",Game.imgUri+"/sp/assets/summon/raid_normal/empty.jpg")}if(q.supporter){var N=q.supporter,O=this.$el.find(".lis-summon.supporter");if(O.addClass("off"),N.id){var P={"summon-id":"supporter","summon-name":N.name,"summon-attribute":N.attribute,"summon-skill-name":N.skill,"summon-comment":N.comment,"summon-recast":N.recast,"summon-start-recast":N.start_recast,"summon-once-flg":N.special_once_flag,"summon-require":N.require,"summon-code":N.id,"summon-protection-name":N.protection_name||D.getMessage("raid_3"),"summon-protection":N.protection||"","summon-quality":N.quality||0,"summon-evolution-flag":N.evolution_flag,"summon-evolution":N.evolution};O.attr(P).append('<div class="ico-summon-recast txt-recast"><span class="num-recast-s'+N.recast+'"></span></div>').children("img").attr("src",Game.imgUri+"/sp/assets/summon/raid_normal/"+N.image_id+".jpg")}else O.children("img").attr("src",Game.imgUri+"/sp/assets/summon/raid_normal/empty.jpg")}q.ability&&b.each(q.ability,function(a){var c=b.indexOf(q.formation,""+a.pos);i.mSetAbility(a,c)}),G.timeline[0].call(function(){p.is_show_coating_value=q.is_show_coating_value,b.each(p.player.param,function(a,b){1==p.player.param[b].alive&&i.mConditionPlayer(a.condition,b)}),i.mConditionBoss(kb)}),stage.addChild(stage.gFieldCondition);var Q=q.field_effect||[];if(b.isEmpty(Q)||i.mConditionField(Q),C>1&&1===J.length&&i.changeFieldConditionPosition(0,!0),q.is_defendorder){stage.addChild(stage.gAssistUnitCondition);var R=q.effect_unit||[];b.isEmpty(R)||i.mConditionAssistUnit(R)}if(f.mWaitAll([E,F,G],{playtime:3}),1==q.battle.count){var S=b.isUndefined(q.player.init_motion)?p.defaultmotion[0]:q.player.init_motion;f.mChangeMotionAll(stage.gAryRootAvatar,E.timeline,{motion:S,mc:p.player.param,type:"player",is_alive:"on",wait:1})}else{for(var x=0,z=A;z>x;x++)f.mChangeMotion(E.timeline[x],{motion:"setup",pos:x,type:"player",is_alive:"on"}),f.mMoveTo(stage.gAryCntnAvatar,E,{index:x,x:-o.relative.offscreen.player,playtime:6,ease:"quartOut"},{tween:[F,G],adjust:-5,wait:8}),f.mChangeMotion(E.timeline[x],{motion:"stbwait",pos:x,type:"player",is_alive:"on"});f.mWaitAll([E,F,G],{playtime:6});for(var x=0,z=w.player.length;z>x;x++)w.player[x].x-=o.relative.offscreen.player}for(var x=0,z=q.boss.param.length;z>x;x++)1!=q.boss.param[x].alive&&(stage.gAryCntnBoss[x].visible=!1,kb[x].isAlive=!1,q.key_enemy_mode!==o.key_enemy.mode_3&&(stage.gAryRootBoss[x].visible=!1));for(var x=0,z=p.boss.param.length;z>x;x++)1!=p.boss.param[x].alive&&void 0!==p.boss.param[x].dropped&&p.boss.param[x].dropped.length>=1&&(stage.gAryCntnBoss[x].visible=!0,h.mGetTreasure(F.timeline[x],stage.gAryCntnBoss[x],p.boss.param[x].dropped,!0,!1),f.mWaitAll([E,F,G],{playtime:2}));if(!b.isUndefined(q.treasure)){var T=this.$el.find(".prt-treasure-wrapper");T.find(".txt-get-value.type1").html(""+q.treasure.treasure_type_1),T.find(".txt-get-value.type2").html(""+q.treasure.treasure_type_2),T.find(".txt-get-value.type3").html(""+q.treasure.treasure_type_3)}for(var x=0,z=stage.gAryRootBoss.length;z>x;x++)stage.gAryRootBoss[x][p.boss.param[x].cjs].gotoAndStop(0);G.timeline[0].call(function(){i.mBossSetup(G.timeline[0],p.boss.param,{size:q.boss.type,force:!0})}),b.isUndefined(q.potion)||(p.potion=q.potion),b.isUndefined(q.temporary)||(p.temporary=q.temporary),i.mUpdateTemporaryItem(),b.isUndefined(q.event)?b.isUndefined(q.defendorder)?q.is_arcarum&&(stage.gGameStatus.arcarum=q.arcarum,p.arcarum_item_flg=!1):(p.event_item_flg=!1,stage.pJsnData.event={event_type:3},stage.gGameStatus.event={event_type:3,item:q.defendorder.defendorder_temporary,isDefendOrder:!0}):(p.event=q.event,p.event_item_flg=!1),p.stone=q.stone,p.shopLowestPrice=q.shop_lowest_price,p.shopPotionId=q.shop_potion_id,p.dispHpPercent=stage.pJsnData.disp_hp_percent_disp,p.abilityRailUse=stage.pJsnData.ability_rail_use;var U=this.$el.find(".prt-ability-rail-overlayer");p.abilityRailUse!==Qa.SMALL||U.hasClass("small")||U.addClass("small"),p.abilityRailDisp=stage.pJsnData.ability_rail_disp,stage.gSpecialSkipSetEffect=new B.components.SpecialSkipSetEffect(Game.lang,w.player),stage.addChild(stage.gSpecialSkipSetEffect),stage.gAttackCancelButton=new B.components.AttackCancelButton,stage.addChild(stage.gAttackCancelButton),p.voiceStamp=stage.pJsnData.voice_stamp;for(var V=!1,x=0,z=q.player.param.length;z>x;x++)if(0!=q.player.param[x].alive){V=!0;break}if((!V||+p.is_escorted_character_dead===la||Nb)&&G.timeline[0].call(function(){p.clear=!1,p.finish=!0;var a=!1,b={popCheer_cancel:y.get("popCheer_cancel"),cheer_pop_flg:y.get("cheer_pop_flg"),lose_pop_flg:y.get("lose_pop_flg"),cheer_already:y.get("cheer_already")};p.reload_flg&&null!=b.popCheer_cancel&&null==b.cheer_pop_flg?"true"==b.popCheer_cancel?a=!0:"false"==b.popCheer_cancel&&"1"!=b.lose_pop_flg&&(a=!1):null!=b.cheer_already&&null==b.cheer_pop_flg?"1"==b.cheer_already&&(a=!0):null!=b.cheer_pop_flg&&("1"==b.cheer_pop_flg&&"1"==b.lose_pop_flg&&(a=!0),y.remove("cheer_pop_flg")),y.remove("popCheer_cancel"),y.set("popCheer_cancel",a),q.is_multi&&q.cheer_status&&!a&&!q.is_semi?j.popCheer():q.is_multi||j.LosePopShow()}),b.isUndefined(q.is_boss)||""==q.is_boss)1===+q.is_rare?j.rareEnemyAppearEffectDeferred.done(function(){stage.gGameStatus.cutinDeferred.resolve()}):stage.gGameStatus.cutinDeferred.resolve();else{if(1==q.battle.count&&f.mWaitAll([E,F,G],{playtime:1}),1!==Game.isSandbox||b.isUndefined(lib[q.is_boss])===!1){var W=new lib[q.is_boss],X=new createjs.Container,Y=W[q.is_boss][q.is_boss].timeline.duration;G.timeline[0].wait(3).call(function(){X.addChild(W),createjs.denaVersion&&(X._layer=1),stage.gMasterContainer.addChild(X),e.mRemove(Y,X,stage.gMasterContainer)}),f.mWaitAll([E,F,G],{playtime:Y})}G.timeline[0].call(function(){stage.gGameStatus.cutinDeferred.resolve()})}1!=q.battle.count||!b.isUndefined(q.is_boss)&&""!=q.is_boss||f.mWaitAll([E,F,G],{playtime:6}),G.timeline[0].call(function(){e.mShow(stage.gAryCntnBoss,p.boss.param)});var Z=!1,$=[];q.key_enemy_mode===o.key_enemy.mode_3&&b.each(q.boss.param,function(a,c){1!==a.alive&&(b.isUndefined(a.force_setin)===!0||1!==+a.force_setin?"enemy_9101273"!==a.cjs&&"enemy_9101353"!==a.cjs&&f.mChangeMotion(F.timeline[c],{motion:"down",pos:c,type:"boss",is_alive:"off",delay:8}):(Z=!0,$.push(+c)))});var _=null;b.some(stage.pJsnData.boss.param,function(a){return b.has(za,a.enemy_id)===!0?(_=za[a.enemy_id],k.css(_),stage.gPlayerContainer.visible=!1,stage.gMasterContainer.setChildIndex(stage.gPlayerContainer,0),stage.gMasterContainer.setChildIndex(stage.gBossContainer,1),!0):void 0}),f.mWaitAll([F],{playtime:8});var aa=[];b.each(q.boss.param,function(a,c){var d=a.motion_link_list||null;b.each(d,function(a,b){a.motion_link.setin=a.motion_link.setin||"setin",stage.gGameStatus.boss.param[c].motion_link_list[b].motion_link=a.motion_link;var d=q.boss.param[a.target_pos];d.is_key_enemy||aa.push(+a.target_pos)})}),aa=b.uniq(aa);var ba=null;b.each(q.boss.param,function(a,c){if(!b.contains(aa,+c)&&(a.alive||a.force_setin)){var d=f.mChangeMotion(F.timeline[c],{motion:"setin",pos:c,type:"boss",setin_voice:p.boss.param[c].setin_voice||null});ba=ba||d}}),f.mWaitAll([E,F,G],{playtime:ba}),F.timeline[0].call(function(){stage.gMasterContainer.setChildIndex(stage.gPlayerContainer,1),stage.gMasterContainer.setChildIndex(stage.gBossContainer,0)}),b.each(q.boss.param,function(a,c){2==a.modechange?p.waitmode[c]="wait_2":3==a.modechange?p.waitmode[c]="wait_3":p.waitmode[c]="wait",Z===!0&&b.contains($,+c)===!0?f.mChangeMotion(F.timeline[c],{motion:"down",pos:c,type:"boss",is_alive:"off"}):f.mChangeMotion(F.timeline[c],{motion:p.waitmode[c],pos:c,type:"boss",is_alive:"on",wait:1})}),b.each(q.boss.param,function(a,c){b.isUndefined(a.gauge)?i.mBreakGauge(G.timeline[0],kb[c],{gauge:a.modegauge}):""!=a.gauge&&i.mBreakGauge(G.timeline[0],kb[c],{gauge:a.gauge})}),!q.arcade||q.arcade&&!q.arcade.is_bonus?G.timeline[0].call(function(){l.css("display","block"),b.each(kb,function(a,b){a.show()})}):(this.$el.find(".prt-gauge-area").remove(),stage.gGameStatus.isShowBossGauge=!1);var ca=a("#prt-total-human"),da=a("#prt-remain-time"),ea=a("#prt-battle-num");if(1==q.multi)q.is_semi&&ca.find("span.num-info-slash, span.max").remove(),ca.show(),da.show(),b.isUndefined(c.cmd)&&i.mFellowTimer(G.timeline[0],0,function(){return j.fellowTimeup()});else if(q.battle){if(q.is_arcarum)this.updateArcarumTp();else if(q.is_board)this.updateTp(this.restTp);else{var fa=ea.find(".txt-info-num"),ha=String(q.battle.count).split(""),ia="";if(b.each(ha,function(a){ia+='<div class="num-info'+a+'"></div>'}),ia+='<span class="num-info-slash"></span>',q.is_dungeon&&q.dungeon.endless_flag)ia+='<div class="num-info-infinity"></div>';else{var ja=String(q.battle.total).split("");b.each(ja,function(a){ia+='<div class="num-info'+a+'"></div>'})}fa.append(ia)}ea.show(),ca.css("display","none"),q.is_sequence===!0||q.is_ascendant===!0?(da.css({display:"block"}),b.isUndefined(c.cmd)&&i.mFellowTimer(G.timeline[0],0,function(){j.fellowTimeup()}),ea.addClass("sequence")):da.css("display","none")}var ka=!1;if(!b.isUndefined(q.scenario)&&(b.some(q.scenario,function(a){return ka="arcarum_stage_effect"===a.cmd}),j.showArcarumStageEffect=ka,ka===!0)){j.updateBeforeAutoAttackStatus(Ia.ARCARUM_STAGE_EFFECT,Ha.WAIT),this.$el.find(".prt-sub-command>div").addClass("black"),1==q.battle.count&&f.mWaitAll([E,F,G],{playtime:12});var ma=this.arcarumBattleStart.cjs,W=new lib[ma],X=new createjs.Container,Y=W[ma][ma].timeline.duration;G.timeline[0].wait(8).call(function(){X.addChild(W),createjs.denaVersion&&(X._layer=1),stage.gMasterContainer.addChild(X),e.mRemove(Y,X,stage.gMasterContainer)}),f.mWaitAll([E,F,G],{playtime:Y});var t=this;G.timeline[0].call(function(){var b=t.$el.find(".prt-battle-condition");b.find(".txt-title").html(D.getMessage("arcarum_stage_effect_1")),b.find(".txt-body").html(t.arcarumBattleStart.msg),b.show(),j.listenToOnce(j,Aa,function(){b.one("tap",function(){a(this).hide(),j.battleAutoType!==Va.FULL||!stage.gGameStatus.auto_attack_display_flag||stage.gGameStatus.diagram||stage.gGameStatus.player.all_dead||(j.showAutoButton(),p.auto_attack&&j._onAutoButton()),stage.gGameStatus.arcarumStageEffectDeferred.resolve(),j.updateBeforeAutoAttackStatus(Ia.ARCARUM_STAGE_EFFECT,Ha.FINISHED),j.startAutoAttackIfCompletePreparation(!1)})})})}q.balloon&&i.mBalloon(G.timeline[0]);var na=a("#prt-force-attack-mask");b.isEmpty(q.dummy_push_attack_cjs)===!1?(this.isForceAttackNavi=!0,stage.gGameStatus.assignHpSuperDamageSoon=!0,na.addClass("show")):na.remove(),this.isForceAttackNavi===!0&&b.isEmpty(q.dummy_navi_information)===!1&&1===q.turn&&(q.navi_information=b.clone(q.dummy_navi_information));var oa=this.$el.find(".cnt-raid-chat").find(".btn-chat");G.timeline[0].call(function(){p.auto_attack_display_flag=q.auto_attack_display_flag,j.battleAutoType=q.battle_auto_type,window.tmpAutoBtnDisplayFlg===!0&&(window.tmpAutoBtnDisplayFlg=!1,j.tmpAutoBtnDisplayFlg=!0),j.tmpAutoBtnDisplayFlg===!0&&(stage.gGameStatus.auto_attack_display_flag=1),window.auto_flag===!0&&(window.auto_flag=!1,p.auto_attack=!0),j.isImpossibleAutoAttack()===!0&&(window.auto_flag=!1,p.auto_attack=!1);var b=j.getFirstNaviIndex();if(b>=0){q.navi_index=b;var c=q.navi_information[b];c&&(j.updateBeforeAutoAttackStatus(Ia.NAVI_INFORMATION,Ha.WAIT),p.naviInfoDeferred.done(function(){j.NaviShow(c)}))}if(!(1!=q.multi||q.is_semi&&q.is_defendorder)){p.chat_button=q.chat_button_flag,p.chat_receive=q.chat_receive_flag,p.chat_button?(oa.css("display","block").addClass("display-on"),q.suddenly_attack_flag&&0!==+q.mini_chat_stamp&&j.showSmallChatIcon()):oa.css("display","block").addClass(ga);var d=0==q.chat_temporary_flag&&!q.is_arcarum;d&&oa.find(".ico-attention").css("display","block")}a("#cnt-raid-information").show(),a("#prt-command-top").show();var e=u[0][o.cjs.parts[0]];if(v[0].visible=!0,p.is_escorted_character_dead||1==q.is_multi&&p.player.all_dead)v[0].visible=!1,e.gotoAndPlay("out"),setTimeout(function(){v[0].visible=!0},500),stage.pJsnData.is_watching!==!0&&stage.gGameStatus.finish===!0&&j.$el.find(".btn-revival").show();else if(j.canStartAutoAttack()===!0){j._controlDomAttackButton(!1),e.gotoAndPlay("out");e[o.cjs.parts[0]+"_out"].timeline.duration;j._inAutoButton(),j._onAutoButton(),j._showAutoButton(),j.activateMask(),j._interactiveAutoButton(),q.suddenly_attack_flag?(p.is_normal_attack=!0,j.battleAutoType===Va.FULL&&j.showAttackButton()):j.battleAutoType===Va.NORMAL?j.AttackSwitch():(j.showAttackButton(),j.runFullAuto({showTurnFlag:!0}))}else j.showAttackButton(),q.suddenly_attack_flag||i.mTurn(p.turn);if(ka===!0&&(v[0].visible=!1,j._controlDomAttackButton(!1),j.arcarumStageEffect()),q.suddenly_attack_flag?(p.is_normal_attack=!0,j.updateBeforeAutoAttackStatus(Ia.SUDDENLY_ATTACK,Ha.WAIT),a.when(p.preemptiveDeferred,p.cutinDeferred,j.revengeBonusPUDeferred).done(function(){q.is_start_battle_navi_first_priority===!0?(window.auto_flag=!1,p.auto_attack=!1,j._offAutoButton(),p.naviInfoDeferred.resolve(),p.suddenlyAttackDeferred.done(function(){v[0].visible=!1,j.preemptiveAttack().done(function(){j.isJustAfterPreemptiveAtkWhileAuto=!0})})):(v[0].visible=!1,j.preemptiveAttack().done(function(){j.isJustAfterPreemptiveAtkWhileAuto=!0}))})):p.naviInfoDeferred.resolve(),p.diagram=q.diagram_flag,!p.diagram||q.suddenly_attack_flag||stage.gGameStatus.auto_attack||j.naviInfoCompleteFlag&&j.retainedAutoSetting&&j.battleAutoType===Va.FULL?p.diagram||j.battleAutoType!==Va.FULL||p.player.all_dead||ka===!0||(j.showAutoButton(),p.auto_attack&&j._onAutoButton()):n.addClass("display-on"),Ca&&j._removeAutoButton(),"undefined"!=typeof q.survival){var f=j.$el.find(".img-score");switch(+q.survival.score_buff){case 13:case 14:case 16:f.addClass("score-2times"),q.suddenly_attack_flag||stage.gGameStatus.auto_attack||f.addClass("display-on");break;case 15:case 17:f.addClass("score-3times"),q.suddenly_attack_flag||stage.gGameStatus.auto_attack||f.addClass("display-on");break;case 18:f.addClass("score-5times"),q.suddenly_attack_flag||stage.gGameStatus.auto_attack||f.addClass("display-on");break;default:f.addClass("display-off")}}p.others_effect_display_flag=q.others_effect_display_flag,p.ability_popup=q.ability_popup_flag,j.$el.find(".prt-ability-skip").attr({active:p.ability_popup}),j.showEnemyInfo()}),G.timeline[0].call(function(){j.TutorialInit()}),1==q.tutorial_flag&&(j._controlDomAttackButton(!1),v[0].visible=!1,j._hideAutoButton(),j._hideChatButtons(),j.$el.find(".prt-temporary").css("display","none")),G.timeline[0].call(function(){q.battle.count>=2&&1==q.is_rare&&j.$el.find(".prt-rare-direction").show().addClass("anim-rare-direction").oneAnimationEnd(function(){a(this).css("display","none")},1600)});var pa=new a.Deferred;if(b.contains([103011,731121],+q.quest_id)&&(q.battle_condition={title:D.getMessage("battle_condition_special_1"),body:D.getMessage("battle_condition_special_2")}),!b.isUndefined(q.battle_condition)&&1==q.turn&&1==q.battle.count){j.updateBeforeAutoAttackStatus(Ia.BATTLE_CONDITION,Ha.WAIT);var qa=j.$el.find(".prt-battle-condition");b.isUndefined(q.battle_condition.title)||b.isEmpty(q.battle_condition.title)||b.isNull(q.battle_condition.title)?qa.addClass("is-no-title"):qa.find(".txt-title").html(q.battle_condition.title),qa.find(".txt-body").html(q.battle_condition.body),G.timeline[0].call(function(){p.naviInfoDeferred.done(function(){var b=function(){qa.show().one("tap",function(){a(this).css("display","none"),pa.resolve(),j.updateBeforeAutoAttackStatus(Ia.BATTLE_CONDITION,Ha.FINISHED),j.startAutoAttackIfCompletePreparation(!1)})};j.naviInfoCompleteFlag===!1?b():j.listenToOnce(j,"naviInfoComplete",function(){b()})})})}j.setAssistParam(),q.suddenly_attack_flag&&!q.is_semi&&!q.is_trialbattle&&(1==q.is_coopraid||1!=q.invite_enable||q.fellow>=q.limit_number||1==q.is_skip_to_request_assistance)&&(ka===!0?stage.gGameStatus.arcarumStageEffectDeferred.done(function(){stage.gGameStatus.preemptiveDeferred.resolve()}):stage.gGameStatus.preemptiveDeferred.resolve());var ra=1==this.$el.find(".cnt-raid-stage").data("has-revenge-bonus")&&1==q.turn&&1==q.battle.count&&V;ra||j.revengeBonusPUDeferred.resolve(),ra?(this.updateBeforeAutoAttackStatus(Ia.REVENGE_BONUS,Ha.WAIT),q.is_rare?j.rareEnemyAppearEffectDeferred.done(function(){j.popRevengeBonus()}):b.isUndefined(q.battle_condition)?G.timeline[0].call(function(){j.popRevengeBonus()}):pa.done(function(){j.popRevengeBonus()})):q.is_restrict_assist===!0?j.$el.find(".btn-assist").addClass("disable is-restrict-assist"):1==q.is_coopraid||1==q.is_watching||q.is_semi||q.is_special_battle||(1==q.invite_enable&&q.fellow<q.limit_number?(0==q.assist[1].on&&(p.assist.all=0),0==q.assist[2].on&&(p.assist.friend=0),0==q.assist[3].on&&(p.assist.guild=0),V?q.is_authority?(b.isUndefined(q.battle_condition)&&pa.resolve(),q.assist[3].is_enable&&1==q.turn&&1==q.battle.count&&(j.assistGuildForceDeferred=new a.Deferred,j.postAssistGuildForce()),m.addClass("disable")):1!=q.is_skip_to_request_assistance?q.is_host||q.is_allowed_to_requesting_assistance?b.isUndefined(q.battle_condition)?(j.updateBeforeAutoAttackStatus(Ia.REQUEST_ASSIST,Ha.WAIT),G.timeline[0].call(function(){var a=location.hash.split("/");"#raid_multi"===a[0]&&j.popShowAssist("first")})):(j.updateBeforeAutoAttackStatus(Ia.REQUEST_ASSIST,Ha.WAIT),pa.done(function(){j.popShowAssist("first")})):(j.updateBeforeAutoAttackStatus(Ia.UNAUTHORIZED_ASSIST,Ha.WAIT),G.timeline[0].call(function(){j.setAssistButtonUnauthorized(),j.popUnauthorizedAssist()})):q.is_host||q.is_allowed_to_requesting_assistance||1!=q.is_skip_to_request_assistance||j.setAssistButtonUnauthorized():q.is_host||q.is_allowed_to_requesting_assistance||j.setAssistButtonUnauthorized()):(i.mAssistAgain(),m.addClass("disable"))),q.is_semi&&q.is_watching!==!0?(this.$el.find(".prt-multi-buttons").remove(),this.$el.find(".prt-multi-mene").addClass("damage-rank").css("display","none"),(!q.is_defendorder&&1==q.turn&&1==q.battle.count||q.is_defendorder&&q.pop_up_flg)&&(b.isUndefined(q.battle_condition)?G.timeline[0].call(function(){j.popShowSemiNotice()}):pa.done(function(){j.popShowSemiNotice()}))):q.is_trialbattle&&!q.is_watching&&1==q.turn&&1==q.battle.count&&(this.updateBeforeAutoAttackStatus(Ia.TRIAL_BATTLE_NOTICE,Ha.WAIT),b.isUndefined(q.battle_condition)?G.timeline[0].call(function(){j.popShowTrialBattleNotice()}):pa.done(function(){j.popShowTrialBattleNotice()})),1==q.is_coopraid?(m.addClass("disable"),j.$el.find(".lis-lead-prev").each(function(){a(this).children(".atx-lead-link").text()==D.getMessage("raid_4")&&a(this).remove()}),a(".prt-alliance-number .btn-more").remove(),a(".prt-alliance-number .txt-alliance").css("padding-top","19px")):q.is_special_battle&&m.addClass("disable"),q.suddenly_attack_flag||this.getForceNaviIndex()>=0||!(b.isUndefined(q.navi_information)===!0||q.navi_information.length<=0||1!==+stage.gGameStatus.serif)||G.timeline[0].call(function(){j.inactivateMask()}),p.menu="top",p.chara_select=1,H.push(new createjs.Timeline([].concat(E.timeline,F.timeline,G.timeline),{start:0},{useTicks:!0,paused:!0}));for(var x=0,z=H.length;z>x;x++)H[x].setPaused(!1);if(t.setRtnMode(!0),!b.isUndefined(c.cmd)){var sa=j.baseFps*(99!=c.fwd?c.fwd:1);o.spf=Math.round(1e3/sa*100)/100,createjs.Ticker.setFPS(sa),createjs.Ticker.addEventListener("tick",stage);var ta=(new a.Deferred).resolve();setTimeout(function(){b.some(q.rep,function(b){ta=ta.then(function(){var b=new a.Deferred;return p.rep>=c.trn-1?(b.resolve(),b):(99!=c.fwd?j.Attack(void 0,{},c,p.rep,b):(p.rep++,b.resolve()),b)})}),a.when(ta).done(function(){createjs.Ticker.setFPS(j.baseFps),createjs.Ticker.addEventListener("tick",stage)})},2e3)}if(q.is_semi&&q.ranking&&j.updateDamageRanking(q.ranking),stage.pJsnData.is_watching===!0){j.$el.find(".watching-mask").css("display","block"),oa.css("display","block").addClass("display-off"),n.removeClass("display-on").addClass("display-off"),stage.gPartsContainer.removeChild(stage.gAryCntnParts[0]);var ua=a("body"),va=a(document).scrollTop();Game.ua.isJssdk()&&(ua=a(Game.gameContainer.selector),va=a(Game.gameContainer.selector).parent().scrollTop()),ua.hasClass("pc")||j.setBodyPreventDefault(ua),va>1&&window.scrollTo(0,0)}if(stage.pJsnData.is_watching===!0){var wa=!1;stage.gGameStatus.timer.watchingMode=setInterval(function(){if(!wa){wa=!0;var c=new d;c.save({raid_id:stage.pJsnData.raid_id},{url:c.urlRoot("watching","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){},success:function(d){var e=c.toJSON();if(b.isUndefined(e.synchro)||b.each(e.synchro,function(a){a.special_skill_flag!==stage.gGameStatus.lock&&j.CommandLock({}),a.hp<stage.gGameStatus.boss.param[a.pos].hp&&(i.mBossGaugeHpForLog(kb,stage.pJsnData.boss.type,{pos:a.pos,param:{hp:a.hp,hpmax:stage.gGameStatus.boss.param[a.pos].hpmax}}),stage.gGameStatus.boss.param[a.pos].hp=a.hp,stage.pJsnData.boss.param[a.pos].hp=a.hp),pLooksMode=stage.gGameStatus.bossmode.looks.mode[a.pos],pLooksGauge=stage.gGameStatus.bossmode.looks.gauge[a.pos],((1===pLooksMode||3===pLooksMode)&&pLooksGauge<a.gauge||2===pLooksMode&&pLooksGauge>a.gauge)&&(i.mBreakGaugeForLog(kb[a.pos],{pos:a.pos,gauge:a.gauge}),j.changeBossMode(a.pos,a.mode),stage.gGameStatus.bossmode.looks.mode[a.pos]=a.mode,stage.gGameStatus.bossmode.looks.gauge[a.pos]=a.gauge)}),"undefined"!=typeof e.watching&&e.watching.length>0){var f=(new a.Deferred).resolve();b.some(e.watching,function(b){f=f.then(function(){"undefined"!=typeof b.status&&b.status.turn!==stage.gGameStatus.turn&&(i.mTurn(stage.gGameStatus.turn),1!==+stage.pJsnData.no_disp_turn&&(stage.gAryRootParts[2][stage.gGameParam.cjs.parts[2]].gotoAndPlay("in"),stage.gAryCntnParts[2].visible=!0),j._fadeChatButtons());var c=new a.Deferred;return j.playScenarios(b,null,null,{},c,null),c})}),a.when(f).done(function(){wa=!1})}else wa=!1}})}},stage.gGameParam.interval.watching)}var xa=!1;this.$el.find("div").off("tap").on("tap",function(){xa!==!1||b.isNull(stage.gGameStatus)||(stage.gGameStatus.tnum+=1,xa=!0,setTimeout(function(){xa=!1},0))})},events:{"tap .prt-summon-list .prt-list-top":"CommandChangeSummon",'tap .prt-command-top [class^="lis-character"]':"CommandChangeAbility","tap .btn-command-back":"CommandBackTop","touchstart .prt-command-chara":"setCharCommandFlick","mousedown .prt-command-chara":"setCharCommandFlick","tap .prt-slide-icon .ico-pre":"slidePre","tap .prt-slide-icon .ico-next":"slideNext","tap .btn-attack-start":"AttackSwitch","tap .btn-attack-cancel":"AttackCancel","tap .btn-lock":"CommandLock","tap .btn-summon-use":"AddSummonAttackQueue","tap .btn-ability-use":"AddAbilityQueue","tap .btn-command-attack":"Attack","tap .prt-command-chara .btn-skip-special":"postSetSkipSpecialOne","tap #prt-set-special-skip .prt-skip-special-stage":"postSetSkipSpecialOne","tap #prt-sub-command-group .btn-set-skip-special-all:not(.disabled)":"postSetSkipSpecialAll","tap .btn-targeting":"enemyTargeting","tap .prt-info-mask":"showEnemyInfo","tap .prt-targeting-area .prt-info-mask-targeting":"showEnemyInfo","tap .btn-enemy-gauge:not(.disable)":"ConditionPopBoss","tap #prt-field-conditions":"fetchFieldCondition","tap #prt-assist-unit-conditions":"fetchAssistUnitCondition","tap .btn-temporary":"UseTempItem","tap .pop-raid-item .item-potion":"popShowItem","tap .prt-select-item .item-small":"ConfirmTempItemSmall","tap .prt-select-item .item-large":"ConfirmTempItemLarge","tap .prt-event-item .btn-event-item":"ConfirmEventItem","tap .pop-event-item:not(.arcarum) .btn-usual-ok":"UseEventItem",
"tap .pop-raid-item .btn-usual-cancel":"CancelTempItemUse","tap .pop-raid-item .btn-usual-use":"UseTempItemLarge","tap .pop-raid-item .btn-arcarum-item:not(.disable)":"ConfirmArcarumItem","tap .pop-event-item.arcarum .btn-usual-ok":"UseArcarumItem","tap .pop-continue-arcarum .btn-arcarum-item:not(.disable)":"ConfirmArcarumItem","tap .pop-continue-arcarum .btn-usual-ok":"Withdraw","tap .pop-arcarum-game-over .btn-arcarum-item:not(.disable)":"ConfirmArcarumItem","tap .pop-arcarum-game-over .btn-retire":"Withdraw","tap .pop-arcarum-dead-no-tp .btn-retire":"Withdraw","tap .pop-arcarum-dead-no-tp .btn-use-item":"popConfirmRecoverTpResurrection","tap .pop-confirm-arcarum-dead-no-tp .btn-usual-cancel":"LosePopShow","tap .pop-confirm-arcarum-dead-no-tp .btn-use-item":"onUseItemForDeadNoTp","tap .pop-event-item.continue .btn-usual-cancel":"LosePopShow","tap .pop-raid-item.continue .btn-usual-cancel":"LosePopShow","tap .btn-raid-menu.menu":"popShowMenu","tap .btn-assist:not(.unauthorized-assist, .is-restrict-assist)":"popAssistCheck","tap .btn-assist.unauthorized-assist":"popUnauthorizedAssist","tap .pop-start-assist .btn-check":"AssistSelect","tap .pop-start-assist .btn-usual-text":"handleAssistOn","tap .pop-unauthorized-assist .btn-usual-ok":"onFinishUnauthorizedAssistPU","tap .pop-enable-assist .btn-usual-ok":"popRemove","tap #pop-scroll, .btn-raid-menu.close":"scrollPopHide","tap .pop-raid-menu .btn-recover":"UseTempItem","tap .pop-raid-menu .btn-mypage":"popShowMypage","tap .pop-raid-menu .btn-event-top":"popConfirmLocationEvent","tap .pop-raid-menu .btn-event-top-do":"popConfirmLocationDo","tap .pop-raid-menu .btn-setting-battle-options":"handleBattleOptionSetting","change .pop-raid-menu .set-auto-type":"changeAutoType","tap .btn-withdrow":"popShowithdraw","tap .pop-riddle-batle-menu .btn-riddle-mypage":"popShowMypage","tap .pop-riddle-batle-menu .btn-riddle-retire":"popShowithdraw","tap .pop-riddle-batle-menu .btn-usual-close":"popRemoveDefault","tap .pop-result-withdraw .btn-usual-ok":"Withdraw","tap .pop-result-withdraw .btn-withdraw":"Withdraw","tap .pop-limit-over .btn-withdraw-single":"Withdraw","tap .pop-result-withdraw .btn-usual-cancel":"popWithdrawCancel","tap .pop-result-withdraw .btn-usual-close":"popWithdrawClose","tap .pop-result-withdraw-arcarum .btn-usual-ok":"Withdraw","tap .pop-result-withdraw-arcarum .btn-usual-cancel":"popWithdrawCancel","tap .pop-no-tp-must-retire .btn-usual-ok":"Withdraw","tap .pop-retire-selection .btn-usual-cancel":"LosePopShow","tap .pop-retire-selection .btn-retire":"Withdraw","tap .pop-location-event-withdraw .btn-usual-cancel":"popWithdrawCancel","tap .pop-location-defend-order-withdraw .btn-usual-cancel":"popWithdrawCancel","tap .pop-location-defend-order-withdraw .btn-usual-close":"popWithdrawClose","tap .pop-result-lose .btn-usual-cancel":"popLoseCancel","tap .pop-result-lose .btn-usual-ok":"popLoseOK","tap .pop-result-use-potion .btn-usual-cancel":"popItemCancel","tap .pop-limit-over .btn-close":"popItemCancel","tap .pop-result-use-potion .btn-usual-ok, .pop-item-confirm .btn-usual-ok":"ItemUseOk","tap .btn-shop":"locationShop","tap .btn-stone":"popShowExchange","tap .pop-exchange .btn-usual-cancel":"LosePopShow","tap .pop-exchange .btn-usual-exchange":"buyItem","tap .pop-exchange .btn-usual-ok":"LosePopShow","change .num-set":"setBuyNum",'tap .prt-ability-list [class^="lis-ability"]':"popShowAbility","tap .prt-ability-dialog .btn-usual-cancel":"popHideAbility","tap .prt-ability-stamped .btn-usual-close":"popHideAbilityStamped","tap .pop-ability-mark .btn-usual-cancel":"popHideAbilityMark","tap .pop-ability-hiddenweapon .btn-usual-cancel":"popHideAbilityHiddenweapon","tap .pop-ability-lupiflip .btn-usual-cancel":"popHideAbilityLupiFlip",'tap [class^="lis-summon"]':"popShowSummon","tap .pop-summon-detail .btn-usual-cancel":"popHideSummon","tap .pop-setting-display .set-diagram .btn-check":"settingChangeSingle","tap .pop-setting-display .btn-usual-close":"popRemove","tap .pop-setting-display .btn-set-setting":"handleSettingPostData",'change .pop-setting-display input[name="battle-speed"]':"ChangeSpeed","tap .pop-setting-assist .btn-usual-close":"popRemove","tap .pop-setting-assist .btn-set-setting":"handleSettingPostData","tap .pop-setting-chat .btn-set-setting":"handleSettingPostData","tap .pop-rematch-fail .btn-usual-ok":"popHideRematchFail","tap .cnt-raid-chat .btn-chat:not(.display-off-opacity)":"popShowChat","cgtouchstart .cnt-raid-chat .btn-chat:not(.display-off-opacity)":"onTouchChatButton","cgtouchend   .cnt-raid-chat .btn-chat:not(.display-off-opacity)":"onTouchChatButton","tap .btn-category":"changeCategory","tap .pop-ready-stamp .lis-stamp:not(.empty), .pop-chat .lis-text":"ChatSend","tap .pop-summon-fail .btn-usual-ok":"popHideSummonFail","tap .pop-revenge-bonus .btn-usual-ok":"onFinishRevengeBonusPU","tap .pop-request-assist-over .btn-usual-ok":"onFinishRequestAssistOverPU","tap .ev-back, .pop-assist .btn-usual-ok, .pop-summon-no .btn-usual-ok, .pop-item-confirm .btn-usual-cancel, .btn-usual-close, .pop-mypage .btn-usual-cancel, .pop-event-item:not(.continue) .btn-usual-cancel, .pop-semi-notice .btn-usual-close, .pop-do-semi-notice .btn-usual-close, .pop-location-event .btn-usual-cancel, .pop-location-defend-order .btn-usual-cancel":"popRemove","tap .pop-start-assist .btn-usual-cancel":"onFinishRequestAssistPU","tap .pop-trialbattle-notice .btn-usual-close":"onFinishTrialBattleNoticePU","tap .prt-multi-buttons .btn-assist.is-restrict-assist":"popRestrictAssist","tap .pop-restrict-assist .btn-usual-ok":"popRemove","tap .pop-select-member .btn-usual-cancel":"popHideSelectMember",'tap .pop-select-member:not(".sub-selecter") [class^="lis-character"]':"SelectMember","tap .prt-supporter":"FriendPop","tap .btn-friend-use":"FriendAttack","tap .prt-command .prt-condition .img-ico-status-m":"ConditionPopPlayer","tap .pop-condition, .btn-raid-menu.close_condition":"ConditionPopHide","tap .prt-navi":"NaviNext",'tap .prt-tips[cheer="0"]':"LosePopShow",'tap .prt-tips[cheer="1"]':"popCheer","tap .pop-lose-help .btn-help-close":"popRemoveLoseHelp","tap .pop-retire-help .btn-help-close":"popHelpHide","tap .btn-cheer":"CheerSend","tap .pop-cheer .btn-usual-cancel":"LosePopShow","tap .pop-cheer .btn-usual-ok":"LosePopShow","tap .btn-logs":"BattleLog","tap .btn-alliance":"allianceList","tap .set-chat_receive>div":"settingChange","tap .prt-multilog-overlayer .bgm-change":"setBgmButton","tap .prt-raid-log":"hideLog","tap .prt-ability-skip":"settingChangeSingle","tap .btn-revival":"popShowRevival","tap .pop-continue-event .btn-usual-cancel":"popItemCancel","tap .pop-continue-event .btn-event-use":"UseEventRevivalItem","tap .pop-continue-event .btn-potion-use":"ItemUseOk","tap .pop-dungeon-item .lis-dungeon-item":"selectDungeonItem","tap .pop-dungeon-item-selected .btn-usual-ok":"locationResult","tap .pop-battle-service .btn-battle-service:not(.disable)":"selectBattleService","tap .pop-battle-service .btn-usual-ok":"sendBattleService","tap .rail-icon-over":"SelectAbilityRailIcon","tap .pop-info-message .btn-usual-ok":"popTriggerOk","tap .btn-auto":"changeAutoMode","tap #prt-sequence-info .btn-sequence-log":"getSequencePointLog","tap .pop-ability-mark .lis-ability-frame":"setAbilityMark","tap .pop-ability-mark .btn-usual-text":"exeAbilityMark","tap .pop-ability-mark .btn-ability-effect-info":"popShowAbilityEffect","tap .pop-ability-effect-info .btn-usual-ok":"previousShowAbility","tap .pop-ability-hiddenweapon .btn-box.enabled":"onAbilityHiddenweapon","tap .pop-ability-hiddenweapon .btn-usual-hiddenweapon":"exeAbilityHiddenweapon","tap .pop-ability-hiddenweapon .btn-skip":"setSettingHiddenweaponSkip","tap .pop-ability-lupiflip .prt-box.btn-lupiflip":"exeAbilityLupiFlip",'tap .pop-select-member.sub-selecter [class^="lis-character"]:not(".mask-black")':"exeAbilitySubSelecter","tap .pop-ability-orderchange .btn-usual-cancel":"popHideOrderChange","tap .pop-ability-orderchange .btn-command-character:not(.disable)":"setOrderChangeSelecter","tap .pop-ability-orderchange .btn-usual-orderchange:not(.disable)":"exeOrderChangeSelecter","tap #btn-twitter":"onPushTwitterIconRaid","tap .pop-status-check .btn-tweet-post":"handleOnPushPostTwitterButton","tap .pop-status-check .btn-usual-cancel":"onPushCloseTwitterPop","tap .pop-status-check .btn-oauth-ok":"onPushOauthButtonRaid","tap .pop-status-check .btn-pop-re-oauth":"onPushReOuthTwitterButton","tap .pop-status-check .btn-oauth-pin":"onPushPinCodeButton","tap .pop-success-post-twitter .btn-usual-ok":"onPushCloseTwitterPop","tap .pop-twitter-auth .btn-oauth-ok":"onPushOauthButtonRaid","tap .pop-twitter-auth .btn-usual-cancel":"onPushCloseTwitterPop","input #frm-pin":"onInputPinCode","tap .pop-twitter-auth .btn-oauth-pin":"onPushPinCodeButton","tap .pop-success-pin .btn-usual-ok":"onPushSuccessPinPopButton","tap .pop-chrome-app-version-check .btn-redirect-help":"location_href","tap .pop-chrome-app-version-check .btn-usual-cancel":"popRemove","tap .prt-command .btn-show-info":"showRaidInformation","tap .cnt-raid .prt-start-direction:not(.disable-ready-auto-setting)":"onTapStartDirection","tap .location-href":"locationHref"},onTapStartDirection:function(a){this.renderReadyAutoSetting(!1)},renderReadyAutoSetting:function(c){var d=0,e=2,f=0,g=!1;return function(c){var h=this.isShowAutoattackSettingText===e?1:2;if(this.isShowAutoattackSettingText!==d){if(0===f&&this.isShowAutoattackSettingText!==e)return void f++;if(!g){g=!0,window.auto_flag=!!window.auto_flag,c===!1&&f>=h&&(this.tmpAutoBtnDisplayFlg=!0,window.auto_flag=!window.auto_flag,p.playSE("se/btn_se/btn_se_03.mp3"));var i={renderedCount:f,canChangeSettingCount:h,isFromRender:c,isAutoOn:window.auto_flag},j=b.template(a("#tpl-ready-auto").html(),i);this.$el.find(".prt-auto-setting").html(j),f++,g=!1}}}}(),updateBeforeAutoAttackStatus:function(a,b){this.beforeAutoattackStatus[a]=b},onFinishRequestAssistPU:function(){this.updateBeforeAutoAttackStatus(Ia.REQUEST_ASSIST,Ha.FINISHED),this.startAutoAttackIfCompletePreparation(!0)},onFinishUnauthorizedAssistPU:function(){this.updateBeforeAutoAttackStatus(Ia.UNAUTHORIZED_ASSIST,Ha.FINISHED),this.startAutoAttackIfCompletePreparation(!0)},onFinishRequestAssistOverPU:function(){this.updateBeforeAutoAttackStatus(Ia.REQUEST_ASSIST_OVER,Ha.FINISHED),this.startAutoAttackIfCompletePreparation(!0)},onFinishRevengeBonusPU:function(){this.revengeBonusPUDeferred.resolve(),this.updateBeforeAutoAttackStatus(Ia.REVENGE_BONUS,Ha.FINISHED),this.startAutoAttackIfCompletePreparation(!0)},onFinishTrialBattleNoticePU:function(){this.updateBeforeAutoAttackStatus(Ia.TRIAL_BATTLE_NOTICE,Ha.FINISHED),this.startAutoAttackIfCompletePreparation(!0)},onFinishNaviInformation:function(){this.updateBeforeAutoAttackStatus(Ia.NAVI_INFORMATION,Ha.FINISHED),this.startAutoAttackIfCompletePreparation(!1)},startAutoAttackIfCompletePreparation:function(a){var c=["pop-chat","pop-ready-stamp"];this.popView&&this.popView.$el.children().length>0&&this.popView.isRemoved!==!0&&b.contains(c,this.popView.className)===!1&&(this.popRemove(),this.popView.isRemoved=!0,a=!0),a?this.listenToOnce(this.popView,"removeEnd",this.startAutoAttack):this.startAutoAttack()},startAutoAttack:function(){this.canStartAutoAttack()!==!1&&(this.battleAutoType===Va.FULL?this.runFullAuto():(this.hideAttackButton(),this.AttackSwitch(),this.activateMask()),this.changeAutoMode(),"ability"===stage.gGameStatus.menu||"summon"===stage.gGameStatus.menu?this._onAutoButton():(this._inAutoButton(),this._onAutoButton(),this._showAutoButton(),this._interactiveAutoButton()))},canStartAutoAttack:function(a){var c=this.retainedAutoSetting;return c===!0&&(stage.gGameStatus.auto_attack=c,this.retainedAutoSetting=!1),this.isImpossibleAutoAttack(a)===!0?(Ba===!1&&1===+stage.gGameStatus.auto_attack_display_flag&&stage.gGameStatus.auto_attack===!0&&this._offAutoButton(),!1):b.every(b.values(this.beforeAutoattackStatus),function(a){return a!==Ha.WAIT})},isImpossibleAutoAttack:function(a){var b=stage.gGameStatus;return!!b.auto_attack_display_flag!=!0||!!b.auto_attack==!1||!!b.battle_end==!0||!!b.player.all_dead==!0||!!b.finish==!0||!!b.force_lose==!0||!!b.is_escorted_character_dead==!0||this.isForceAttackNavi===!0||!!stage.gGameStatus.attackQueue.attackButtonPushed==!0||!!stage.gGameStatus.attacking==!0||!a&&Ba===!1?!0:!1},indexExists:function(a,b){for(var c=a.length,d=0;c>d;d++)if(a[d]===b)return!0;return!1},CommandChangeTop:function(a){var c=this,d=this.$el.find(".prt-command-top"),e=this.$el.find(".prt-navi");this.$el.find(".prt-command-chara").css("display","none"),this.$el.find(".prt-summon").css("display","none"),this.$el.find(".prt-command-summon").show().removeClass("summon-show"),stage.gMasterContainer.setChildIndex(stage.gBossContainer,0),stage.gMasterContainer.setChildIndex(stage.gPlayerContainer,1),this.$el.find("[class^='lis-character']").removeClass("invisible"),d.show().find("[class^='lis-character']").show(),this.$el.find(".prt-sub-command").show(),this.$el.find(".prt-summon-list").removeClass("opened"),e.hasClass("active")&&setTimeout(function(){e.addClass("display-on")},10);var g=stage.gGameStatus;stage.gGameStatus.auto_attack||1!==g.attackQueue.queue.length&&g.attackQueue.attackButtonPushed||(1!=g.diagram||stage.pJsnData.is_watching===!0||this.naviInfoCompleteFlag&&this.retainedAutoSetting&&this.battleAutoType===Va.FULL||this.$el.find(".img-diagram").removeClass("display-off").addClass("display-on"),stage.gGameStatus.auto_attack_display_flag&&(this.battleAutoType===Va.NORMAL||this.battleAutoType===Va.FULL&&stage.gGameStatus.diagram)&&(this._outAutoButton(),this._hideAutoButton(),this._noInteractiveAutoButton()),1!=g.chat_button||stage.pJsnData.is_watching===!0||stage.pJsnData.is_semi&&stage.pJsnData.is_defendorder||stage.gGameStatus.auto_attack||this.showChatIcon(),"undefined"!=typeof stage.pJsnData.survival&&stage.pJsnData.survival.score_buff&&!this.$el.find(".img-score").hasClass("display-off")&&this.$el.find(".img-score").addClass("display-on"),this.$el.find(".prt-temporary").removeClass("display-off").addClass("display-on")),this.battleAutoType!==Va.FULL||!stage.gGameStatus.auto_attack_display_flag||stage.gGameStatus.diagram||g.player.all_dead||this.$el.find(".prt-battle-condition").is(":visible")||(this._showAutoButton(),this._interactiveAutoButton());var h=g.boss.param;if(!stage.gGameStatus.boss.form_change_command)for(var i=0,j=stage.gAryCntnBoss.length-1;j>=i;i++)1==h[i].alive&&(stage.gAryCntnBoss[i].visible=!0);if(b.isUndefined(a)||!b.isUndefined(a)&&1==a.motion){for(var k=g.player.param,i=0,j=stage.gAryRootAvatar.length-1;j>=i;i++)1!=k[i].alive||g.player.isPlayingDeadMotion[i]===!0||1===stage.gGameStatus.usingAbility&&stage.gGameStatus.useAbilityPos===i||(parseInt(k[i].recast,10)>=+k[i].special_skill_recast&&k[i].special_skill_activate_flag&&1!=g.lock?f.mChangeMotionInstantly({motion:"ability",pos:i,type:"player"}):!function(a){c.setNamedTimeout("motionChangeTimeout_1",function(){(1!==stage.gGameStatus.usingAbility||stage.gGameStatus.useAbilityPos!==a)&&f.mChangeMotionInstantly({motion:g.defaultmotion[stage.pJsnData.formation[a]],pos:a,type:"player"})},500)}(i));if(!stage.gGameStatus.boss.form_change_command)for(var i=0,j=stage.gAryRootBoss.length-1;j>=i;i++)1==h[i].alive&&f.mChangeMotionInstantly({motion:g.waitmode[i],pos:i,type:"boss"})}stage.pJsnData.suddenly_attack_flag&&!this.showArcarumStageEffect&&(stage.gAryCntnParts[0].visible=!0),g.menu="top",clearInterval(g.timer.playerCondition)},CommandChangeSummon:function(){stage.gGameStatus.avmSummonFlag=!0;var a=this;if(!(stage.gGameStatus.is_escorted_character_dead||stage.gGameStatus.player.all_dead||2==stage.gGameStatus.chara_select||stage.gGameStatus.attackQueue.attackButtonPushed||stage.gGameStatus.auto_attack===!0&&this.battleAutoType===Va.NORMAL||this.isFullAutoAttacking()===!0&&"normal_attack_result"===stage.gGameStatus.attack_action)){if(stage.pJsnData.without_pc||stage.pJsnData.without_summon)return void this.popShowSummonNo(1);if(1!=stage.pJsnData.player.param[0].alive)return void this.popShowSummonNo(2);var b=this.GetHeroPos();if(stage.pJsnData.lyria_num>=0){var c=stage.pJsnData.lyria_num,d=stage.pJsnData.lyria_pos;if(1!=stage.pJsnData.player.param[c].alive)return void this.popShowSummonNo(3);if(0>d||0==stage.gGameStatus.player.param[d].condition.summon_available_flag)return void this.popShowSummonFail(!0);if(b>=0&&0==stage.gGameStatus.player.param[b].condition.summon_available_flag)return void this.popShowSummonFail(!1)}else if(0>b||0==stage.gGameStatus.player.param[b].condition.summon_available_flag)return void this.popShowSummonFail(!1);if(null!==stage.gGameStatus.player.posSizeL)return void this.popShowSummonFail(!1);if(stage.gGameStatus.balloon="summon",this.$el.find(".prt-command-top").css("display","none"),this.$el.find(".prt-summon-list").addClass("opened"),this.HideCommand(),this.$el.find(".prt-command-summon").show().removeClass("summon-hide").addClass("summon-show"),"summon"!==stage.gGameStatus.menu&&(a.BackButtonShow(),a.battleAutoType===Va.FULL&&(a._hideAutoButton(),a._noInteractiveAutoButton())),stage.gGameStatus.menu="summon",stage.gGameStatus.attackQueue.queue[0]&&"SummonAttack"!==stage.gGameStatus.attackQueue.queue[0].index)for(var e=0,g=stage.gAryRootAvatar.length-1;g>=e;e++)1!=stage.gGameStatus.player.param[e].alive||stage.gGameStatus.player.isPlayingDeadMotion[e]===!0||!(+stage.gGameStatus.player.param[e].recast<+stage.gGameStatus.player.param[e].special_skill_recast)&&stage.gGameStatus.player.param[e].special_skill_activate_flag&&1!==+stage.gGameStatus.lock||1===stage.gGameStatus.usingAbility&&stage.gGameStatus.useAbilityPos===e||f.mChangeMotionInstantly({motion:stage.gGameStatus.defaultmotion[stage.pJsnData.formation[e]],pos:e,type:"player"});if(!stage.gGameStatus.motion){var h=stage.pJsnData.lyria_pos>=0?stage.pJsnData.lyria_pos:b,i=stage.pJsnData.formation[h];stage.gGameStatus.player.isPlayingDeadMotion[h]!==!0&&(f.mChangeMotionInstantly({motion:"summon",pos:h,type:"player"}),stage.gGameStatus.defaultmotion[i]="stbwait",stage.gGameStatus.doneSetupMotionPlayer[i]=!0)}}},CommandChangeAbility:function(b){stage.gGameStatus.avmAbilityFlag=!0,-1!=Game.ua.ua.toLowerCase().indexOf("windows")&&"ontouchstart"in window&&"onmousedown"in window&&a(Game.gameContainer.selector).css({"-ms-touch-action":"pan-y","touch-action":"pan-y"});var c=this,d=this.$el.find(".prt-command-chara");if(!(stage.gGameStatus.is_escorted_character_dead||"ability"==stage.gGameStatus.menu||stage.gGameStatus.attackQueue.attackButtonPushed||stage.gGameStatus.auto_attack===!0&&this.battleAutoType===Va.NORMAL)){var e=a(b.currentTarget);if(!e.hasClass("blank"))if(2!==+stage.gGameStatus.chara_select){stage.gGameStatus.menu="ability",stage.gGameStatus.command_slide.now_pos=e.attr("pos"),d.removeClass("anim-slide-command-right slide_pre anim-slide-command-left slide_next"),stage.gGameStatus.command_slide.state=0,c.BackButtonShow(),c.battleAutoType===Va.FULL&&(c._hideAutoButton(),c._noInteractiveAutoButton()),stage.gGameStatus.balloon="ability";var f=d.eq(e.attr("pos"));"block"!=f.css("display")&&1==stage.gGameStatus.player.param[e.attr("pos")].alive&&(this.HideCommand(),this.$el.find(".prt-command-top, .prt-command-summon, .prt-sub-command").css("display","none"),f.show().addClass("anim-command-chara-show").oneAnimationEnd(function(){if(a(this).removeClass("anim-command-chara-show"),"ability"===stage.gGameStatus.menu){for(var b=0,d=0,e=stage.gGameStatus.player.number;e>=d;d++)1==stage.gGameStatus.player.param[d].alive&&b++;b>=2&&c.$el.find(".prt-slide-icon").addClass("show-icon")}},400),e.addClass("invisible"),this.motionChangeAbility(e.attr("pos"))),i.mSetIntervalPlayerConditions(Number(e.attr("pos"))+1)}else if(stage.gGameStatus.arcarum_item_flg){if(e.hasClass("mask-black")||e.hasClass("mask-black-size-l"))return;stage.gGameStatus.arcarum_character_num=e.attr("pos"),this.UseArcarumItem()}else stage.gGameStatus.event_item_flg?(stage.gGameStatus.event_character_num=e.attr("pos"),this.UseEventItem()):this.UseTempItemSmall(b)}},motionChangeAbility:function(a){for(var b=0,c=stage.gAryRootAvatar.length-1;c>=b;b++)1==stage.gGameStatus.player.param[b].alive&&(a==b||stage.gGameStatus.player.isPlayingDeadMotion[b]===!0||1===stage.gGameStatus.usingAbility&&stage.gGameStatus.useAbilityPos===b||(+stage.gGameStatus.player.param[b].recast<+stage.gGameStatus.player.param[b].special_skill_recast||!stage.gGameStatus.player.param[b].special_skill_activate_flag||1===+stage.gGameStatus.lock)&&(1===+stage.gGameStatus.turn?f.mChangeMotionInstantly({motion:stage.gGameStatus.defaultmotion[stage.pJsnData.formation[b]],pos:b,type:"player"}):f.mChangeMotionInstantly({motion:"stbwait",pos:b,type:"player"})));if("ability"===stage.gGameStatus.menu){var d=0,e=stage.pJsnData.formation[a];1===+stage.pJsnData.battle.count&&1===+stage.gGameStatus.turn&&stage.gGameStatus.doneSetupMotionPlayer[e]===!1&&(d=f.mChangeMotionInstantly({motion:"setup",pos:a,type:"player"}),stage.gGameStatus.doneSetupMotionPlayer[e]=!0,stage.gGameStatus.defaultmotion[e]="stbwait");var g=createjs.Tween.get({},{override:!0,useTicks:!0,paused:!0});g.wait(d).call(function(a){stage.gGameStatus.player.isPlayingDeadMotion[a]===!0||1===stage.gGameStatus.usingAbility&&stage.gGameStatus.useAbilityPos===+a||f.mChangeMotionInstantly({motion:"ability",pos:a,type:"player",is_alive:"on"})},[a]),g.setPaused(!1)}},CommandBackTop:function(c){-1!=Game.ua.ua.toLowerCase().indexOf("windows")&&"ontouchstart"in window&&"onmousedown"in window&&a(Game.gameContainer.selector).css({"-ms-touch-action":"","touch-action":""}),b.isUndefined(c)||"tap"!=c.type||(c=void 0),stage.gGameStatus.action.ab_select="",stage.gGameStatus.motion=!1,stage.gGameStatus.balloon="wait";var d=this.$el.find(".btn-command-back");d.removeClass("display-on").addClass("display-off"),stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]].gotoAndPlay("out"),this.battleAutoType===Va.FULL&&stage.gGameStatus.auto_attack_display_flag&&(this._showAutoButton(),this._interactiveAutoButton());var e=stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]][stage.gGameParam.cjs.parts[1]+"_out"].timeline.duration;setTimeout(function(){d.hasClass("display-on")||(stage.gAryCntnParts[1].visible=!1)},e*stage.gGameParam.spf),stage.pJsnData.is_watching===!0||stage.pJsnData.is_semi&&stage.pJsnData.is_defendorder||stage.gGameStatus.auto_attack||this.showChatIcon(),stage.pJsnData.is_watching===!0||stage.gGameStatus.auto_attack||stage.gGameStatus.diagram&&this.$el.find(".img-diagram").removeClass("display-off").addClass("display-on");var f=this.$el.find(".img-score");"undefined"!=typeof stage.pJsnData.survival&&stage.pJsnData.survival.score_buff&&!f.hasClass("display-off")&&f.addClass("display-on"),this.$el.find(".prt-command-chara").css("display","none"),this.$el.find(".prt-slide-icon").removeClass("show-icon"),this.CommandChangeTop(c)},BackButtonShow:function(){stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]].gotoAndPlay("in"),stage.gAryCntnParts[1].visible=!0,this.$el.find(".btn-command-back").addClass("display-on")},HideCommand:function(){var a=this;this.$el.find(".prt-ability-summon").removeClass("display-on"),this.$el.find(".img-diagram").removeClass("display-on").addClass("display-off"),this.$el.find(".prt-temporary").removeClass("display-on").addClass("display-off");var b=this.$el.find(".img-score");b.hasClass("display-on")&&b.removeClass("display-on"),setTimeout(function(){a.$el.find(".prt-battle, .prt-navi").removeClass("display-on")},1)},renewCharaList:function(c,d,e){c=c?c:0;for(var g=this,h=[],j=[],d=d||!1,e=e||!1,k=stage.gGameStatus.player.param,l=k.length,m=0;l>m;m++){var n=".prt-command-chara.chara"+(m+1),o=this.$el.find(n),q=o.find(".lis-ability").find("div");if(q.hasClass("shine0")?h[m]="raid_ability":h[m]="raid_normal",e)var r=9999,s=!1,t=b.isUndefined(stage.pJsnData.ability[m+1])===!1?stage.pJsnData.ability[m+1].list:null;var o=a(n);o.find(".lis-ability").each(function(c){if("undefined"!=typeof k[m].condition.ability_available_list&&k[m].condition.ability_available_list[c+1]===!1)a(this).addClass("ability-disable");else{if(e===!0&&b.isNull(t)===!1&&"undefined"!=typeof t[c+1]){var d=t[c+1][0];s=b.isUndefined(d["recaset-default"])===!1&&+d["recaset-default"]!==r&&b.isUndefined(d.start_skill_set_recast)===!1&&d.start_skill_set_recast>0,s===!0&&a(this).find(".prt-start-recast").addClass("start-recast-"+d.start_skill_set_recast)}a(this).removeClass("ability-disable")}}),0==k[m].condition.recast_down_flag?o.addClass("turn-disable"):o.removeClass("turn-disable"),+k[m].recast>=+k[m].special_skill_recast&&k[m].special_skill_activate_flag&&(j[m]=!0,1!=stage.gGameStatus.lock&&(h[m]="raid_special"))}var u=this.$el.find(".prt-command"),v=this.$el.find(".prt-command-chara"),w=this.$el.find(".prt-command-top"),x=this.$el.find(".prt-command-summon");u.find("[class^='lis-character']").children("img").attr("src",qa);for(var m=0;l>m;m++){var y=u.find(".lis-character"+m),z=w.find(".lis-character"+m);if(1==k[m].alive){1==k[m].leader?y.children("img").attr("src",Game.imgUri+"/sp/assets/leader/raid_normal/"+k[m].pid_image+".jpg"):y.children("img").attr("src",Game.imgUri+"/sp/assets/npc/raid_normal/"+k[m].pid_image+".jpg");var A=y.find(".txt-hp-value"),B=y.find(".txt-coating-value"),C=z.find(".prt-gauge-hp-inner"),D=y.find(".prt-gauge-hp-inner"),E=Math.ceil(+k[m].hp/+k[m].hpmax*100),F=25>=E?"red":"green";clearInterval(stage.gAryInterval[m]),i.changeCoatingDisplay(1,m,5,!1),A.html(""+k[m].hp).attr({color:F}),C.css("width",E+"%").attr({color:F}),D.css("width",E+"%").attr({color:F}),k[m].condition.hide_hp_flag?(A.addClass(ja),B.addClass(ja)):(A.removeClass(ja),B.removeClass(ja)),void 0!==k[m].condition.num&&(stage.pJsnData.player.param[k[m].condition.num].condition.hide_hp_flag=k[m].condition.hide_hp_flag);var G=v.eq(m),H=G.find(".txt-name"),I=G.find(".txt-comment"),J=k[m].special_skill,K=k[m].special_comment;H.html()!==J&&H.html(J),I.html()!==K&&I.html(K);var L=2===k[m].form&&k[m].extra_attr>0?k[m].extra_attr:k[m].attr;y.find(".ico-type").removeClass(function(a,b){return(b.match(/ico-attribute-\d*/)||[]).join(" ")}).addClass("ico-attribute-"+L)}var M=stage.pJsnData.without_pc?m+1:m;if(l>M){var N=this.$el.find(".pop-select-member").find(".lis-character"+m);1==stage.pJsnData.player.param[M].leader?N.children("img").attr("src",Game.imgUri+"/sp/assets/leader/raid_normal/"+stage.pJsnData.player.param[M].pid_image+".jpg"):N.children("img").attr("src",Game.imgUri+"/sp/assets/npc/raid_normal/"+stage.pJsnData.player.param[M].pid_image+".jpg")}}for(var m=0;l>m;m++){var q=u.find(".prt-gauge-special.character"+m);q.find(".prt-shine").css("display","none"),0==m&&x.find('div[class^="lis-summon"]').removeClass("on")}var O=stage.gGameStatus.menu;if("ability"!=O&&"summon"!=O&&"temporary"!=O&&1!==stage.gGameStatus.attacking)for(var m=0;l>m;m++)if("raid_special"==h[m]&&1!=stage.gGameStatus.lock&&1==k[m].alive){var P=0;!function(a){setTimeout(function(){if(1!=stage.gGameStatus.lock){f.mChangeMotionInstantly({motion:"ability",pos:a,type:"player"});var b=stage.pJsnData.formation[a];stage.gGameStatus.doneSetupMotionPlayer[b]===!1&&(stage.gGameStatus.doneSetupMotionPlayer[b]=!0,stage.gGameStatus.defaultmotion[b]="stbwait")}},(P+c)*stage.gGameParam.spf)}(m)}setTimeout(function(){for(var a=!1,b=0;l>b;b++){var c=u.find(".prt-gauge-special.character"+b);k[b].alive&&(1==j[b]&&("undefined"==typeof k[b].condition.seal_flag||0==k[b].condition.seal_flag)&&(c.find(".prt-shine").show(),a||d===!0||(p.playRecastMaxSE(),a=!0)),"undefined"==typeof k[b].condition.seal_flag||0==k[b].condition.seal_flag?c.find(".prt-black-mask").css("display","none"):c.find(".prt-black-mask").show())}},0);var Q=this.GetHeroPos(),R=!1,S=!1,T=this.$el.find(".prt-list-top");if(stage.pJsnData.lyria_num>=0){var U=stage.pJsnData.lyria_num,V=stage.pJsnData.lyria_pos;stage.pJsnData.summon_enable>=1&&(1==stage.pJsnData.player.param[0].alive&&1==stage.pJsnData.player.param[U].alive?(b.where(stage.pJsnData.summon,{recast:"0"}).length||0===parseInt(stage.pJsnData.supporter.recast,10))&&(R=!0):S=!0),S||0>V||0==k[V].condition.summon_available_flag||Q>=0&&0==k[Q].condition.summon_available_flag||stage.pJsnData.without_summon?(T.addClass("summon-disable"),S=!0,R&&(R=!1),this.$el.find(".pop-summon-detail").css("display","none"),"summon"===stage.gGameStatus.menu&&this.CommandBackTop()):T.removeClass("summon-disable")}else stage.pJsnData.summon_enable>=1&&(1==stage.pJsnData.player.param[0].alive?(b.where(stage.pJsnData.summon,{recast:"0"}).length||0===parseInt(stage.pJsnData.supporter.recast,10))&&(R=!0):S=!0),0>Q||0==k[Q].condition.summon_available_flag||!k[Q].alive||stage.pJsnData.without_summon?(T.addClass("summon-disable"),S=!0,R&&(R=!1),this.$el.find(".pop-summon-detail").css("display","none"),"summon"===stage.gGameStatus.menu&&this.CommandBackTop()):T.removeClass("summon-disable");var q=x.find(".prt-list-top");q.removeClass("summon-on summon-off"),R?q.addClass("summon-on"):q.addClass("summon-off"),this.removeOthersCjsAll(),x.find('div[class^="lis-summon"]').each(function(c){if(!b.isUndefined(stage.pJsnData.summon[c])&&""!=stage.pJsnData.summon[c].id){var d=a(this);0==S&&stage.pJsnData.summon_enable>=1&&0===parseInt(stage.pJsnData.summon[c].recast,10)?(d.removeClass("off non-reusable").addClass("on"),d.removeClass("btn-summon-unavailable").addClass("btn-summon-available")):(stage.pJsnData.summon[c].recast>aa?d.removeClass("on off").addClass("non-reusable"):d.removeClass("on non-reusable").addClass("off"),d.removeClass("btn-summon-available").addClass("btn-summon-unavailable")),d.find("span").removeClass().addClass("num-recast-s"+stage.pJsnData.summon[c].recast),d.attr("summon-recast",stage.pJsnData.summon[c].recast),d.removeClass("has-canvas-effect"),b.isUndefined(stage.pJsnData.summon_special_effect)===!1&&+stage.pJsnData.summon_special_effect.pos===+d.attr("pos")&&g.showLisSummonCjsEffect(stage.pJsnData.summon_special_effect)}});var W=x.find(".lis-summon.supporter");0==S&&stage.pJsnData.summon_enable>=1&&0===parseInt(stage.pJsnData.supporter.recast,10)?W.removeClass("off non-reusable btn-summon-unavailable").addClass("on btn-summon-available"):(stage.pJsnData.supporter.recast>aa?W.removeClass("on off").addClass("non-reusable"):W.removeClass("on non-reusable").addClass("off"),W.removeClass("btn-summon-available").addClass("btn-summon-unavailable")),W.attr("summon-recast",stage.pJsnData.supporter.recast).removeClass("has-canvas-effect").find("span").removeClass().addClass("num-recast-s"+stage.pJsnData.supporter.recast),b.isUndefined(stage.pJsnData.summon_special_effect)===!1&&"supporter"===stage.pJsnData.summon_special_effect.pos&&g.showLisSummonCjsEffect(stage.pJsnData.summon_special_effect);var X=w.find(".prt-member"),q=X.find("div[class^='lis-character']");q.addClass("blank");for(var m=0,Y=stage.gGameStatus.player.number;Y>=m;m++)1==k[m].alive&&X.find(".lis-character"+m).removeClass("blank");stage.pJsnData.is_arcade&&stage.pJsnData.arcade.is_bonus&&this.updateBonusStageTurn()},checkSummonLimitCount:function(){var a=stage.pJsnData.summon_enable;if(0!=a){var c;c=stage.gGameStatus.attacking||stage.gGameStatus.usingAbility?b.rest(stage.gGameStatus.attackQueue.queue,1):stage.gGameStatus.attackQueue.queue;var d=b.filter(c,function(a){return"SummonAttack"===a.index}).length;d>=a&&(a=0)}return a},updateBonusStageTurn:function(){var b=a("#prt-arcade-countdown"),c=b.find(".prt-arcade-number-box"),d=stage.gGameStatus.remain_turn+"",e=d.length,f=[],g="";e>1?f=d.split(""):f.push(stage.gGameStatus.remain_turn);for(var h=0;e>h;h++)g+='<div class="prt-turn-num'+f[h]+'"></div>';c.html(g),b.css("display","block")},setCharCommandFlick:function(b){if(("mousedown"!==b.type||Game.ua.isPcPlatformHasTouch)&&1!=stage.gGameStatus.command_slide.state){var c=this,d=a(b.currentTarget);c.startPageX=0,c.startPageY=0,c.startTimestamp=0,c.startScrollY=0,c.commandSlideDirection="";var e=function(b){"mousedown"===b.type?(c.startPageX=b.originalEvent.pageX,c.startPageY=b.originalEvent.pageY):(c.startPageX=b.originalEvent.changedTouches[0].pageX,
c.startPageY=b.originalEvent.changedTouches[0].pageY),c.startTimestamp=b.originalEvent.timeStamp,c.startScrollY=a(document).scrollTop(),Game.ua.isJssdk()&&(c.startScrollY=a(Game.gameContainer.selector).parent().scrollTop())},f=function(b){var d,e,g=b.originalEvent.timeStamp,h=a(document).scrollTop(),i=a(b.currentTarget);if("mouseup"===b.type?(d=b.originalEvent.pageX,e=b.originalEvent.pageY):(d=b.originalEvent.changedTouches[0].pageX,e=b.originalEvent.changedTouches[0].pageY,i.off("touchend touchcancel",f)),"ability"===stage.gGameStatus.menu){Game.ua.isJssdk()&&(h=a(Game.gameContainer.selector).parent().scrollTop());var j=+g-+c.startTimestamp,k=+d-+c.startPageX,l=+e-+c.startPageY,m=+h-+c.startScrollY;Game.ua.isChromeApp()&&(m=0),Math.abs(k)<Math.abs(l)||Math.abs(m)>pa||na>j&&Math.abs(k)>oa&&(c.commandSlideDirection=k>0?"prev":"next",c.slideCommand())}};"mousedown"===b.type&&Game.ua.isPcPlatformHasTouch?(e(b),d.one("mouseup",f)):"touchstart"===b.type&&(e(b),d.one("touchend",f),d.one("touchcancel",f))}},slideCommand:function(){if(1!=stage.gGameStatus.command_slide.state){for(var a=0,b=0,c=stage.gGameStatus.player.number;c>=b;b++)1==stage.gGameStatus.player.param[b].alive&&a++;a>=2&&("prev"===this.commandSlideDirection?this.slidePre():this.slideNext())}},slidePre:function(){if(1!=stage.gGameStatus.command_slide.state&&"ability"===stage.gGameStatus.menu){stage.gGameStatus.command_slide.state=1;var b=this,c=0,d=parseInt(stage.gGameStatus.command_slide.now_pos)-1;0>d&&(d=stage.gGameStatus.player.number);for(var e=d;e>=0;e--){if(1==stage.gGameStatus.player.param[e].alive){c=e;break}0==e&&(e=stage.gGameStatus.player.number+1)}var f=c+1,g=parseInt(stage.gGameStatus.command_slide.now_pos)+1,h=this.$el.find(".prt-command"),j=h.find(".chara"+g);j.addClass("anim-slide-command-right"),h.find(".chara"+f).addClass("slide_pre anim-slide-command-right").show().oneAnimationEnd(function(){j.css("display","none").removeClass("anim-slide-command-right"),a(this).removeClass("anim-slide-command-right slide_pre"),stage.gGameStatus.command_slide.now_pos=c,stage.gGameStatus.command_slide.state=0,b.motionChangeAbility(stage.gGameStatus.command_slide.now_pos)},250),i.mSetIntervalPlayerConditions(f)}},slideNext:function(){if(1!=stage.gGameStatus.command_slide.state&&"ability"===stage.gGameStatus.menu){stage.gGameStatus.command_slide.state=1;var b=this,c=0,d=parseInt(stage.gGameStatus.command_slide.now_pos)+1;d>stage.gGameStatus.player.number&&(d=0);for(var e=d,f=stage.gGameStatus.player.number;f>=e;e++){if(1==stage.gGameStatus.player.param[e].alive){c=e;break}e==stage.gGameStatus.player.number&&(e=-1)}var g=c+1,h=parseInt(stage.gGameStatus.command_slide.now_pos)+1,j=this.$el.find(".prt-command"),k=j.find(".chara"+h);k.addClass("anim-slide-command-left"),j.find(".chara"+g).addClass("slide_next anim-slide-command-left").show().oneAnimationEnd(function(){k.css("display","none").removeClass("anim-slide-command-left"),a(this).removeClass("anim-slide-command-left slide_next"),stage.gGameStatus.command_slide.now_pos=c,stage.gGameStatus.command_slide.state=0,b.motionChangeAbility(stage.gGameStatus.command_slide.now_pos)},250),i.mSetIntervalPlayerConditions(g)}},hideLog:function(b){var c=this.$el.find(".prt-raid-log");c.css("display","none");var d=a(document.elementFromPoint(b.x,b.y)).closest(".lis-ability");d.hasClass("lis-ability")&&(d.addClass("on"),p.playSE("se/btn_se/btn_se_03.mp3"),this.popShowAbility({currentTarget:d[0]}))},SelectSummon:function(){stage.gGameStatus.motion=!0,this.SummonUse()},hideMask:function(){Game.footer&&Game.footer.mainView&&Game.footer.mainView.isTreasurePUOpen||this.getMask().css("display","none")},showMask:function(){this.getMask().css("display","block")},getMask:function(){var b=a(".mask");return this.getMask=function(){return b},this.getMask()},InvokeAttackQueue:function(a){function c(c){var e=null;switch(c){case"NormalAttack":e=function(){var c=d.$el.find(".btn-attack-start");b.isUndefined(a)||a!==!0||c.hasClass("display-on")!==!0||(stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"),d._controlDomAttackButton(!1));var e=0;(1===stage.gGameStatus.turn&&1===+stage.pJsnData.battle.count||stage.gGameStatus.abilityRailUse!==Qa.OFF)&&(e=Kb),d.setNamedTimeout("normalAttackTimeout",function(){return a===!0&&stage.gGameStatus.auto_attack===!1?(d.ResetAllAttackQueue(),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),void d._controlDomAttackButton(!0)):(stage.gGameStatus.attackQueue.attackButtonPushed=!0,void d.AttackSwitch())},e)};break;case"SummonAttack":e=function(){d.SelectSummon()};break;case"itemUse":e=function(){d.itemUse()};break;default:e=function(){d.SelectAbility()}}return e}var d=this;if(0===stage.gGameStatus.attackQueue.queue.length)return void this.ResetAllAttackQueue();var e=null;stage.gGameStatus.isPlayingScenariosImmediately===!0?stage.gGameStatus.hasHandlerScenariosImmediatelyFinished||(stage.gGameStatus.hasHandlerScenariosImmediatelyFinished=!0,stage.gAryCntnParts[7].visible||this.cjsTurnWaitingShow(),this.listenToOnce(this,"finishPlayScenariosImmediately",function(){stage.gGameStatus.hasHandlerScenariosImmediatelyFinished=!1,0===d.abilityRailTurnWaiting&&d.cjsTurnWaitingHide(),0!==stage.gGameStatus.attackQueue.queue.length&&(e=c(stage.gGameStatus.attackQueue.queue[0].index))()})):(e=c(stage.gGameStatus.attackQueue.queue[0].index))()},SelectAbility:function(){stage.gGameStatus.action.ab_select=stage.gGameStatus.attackQueue.queue[0].index,stage.gGameStatus.motion=!0,stage.gGameStatus.usingAbility=1,stage.gGameStatus.useAbilityPos=+stage.gGameStatus.action.ab_select.num,this.AbilityUse()},AddNormalAttackQueue:function(c){if(!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0;var d=this.getIsReadyToPlayScenario(),e=stage.gGameStatus.attackQueue.queue;if(e.push({index:"NormalAttack",param:{tnum:stage.gGameStatus.tnum}}),stage.gGameStatus.tnum=0,b.isUndefined(c)===!1&&a(c.currentTarget).hasClass("btn-attack-start")){var f=10104,g=20206;b.extend(stage.gGameStatus.attackQueue.queue[stage.gGameStatus.attackQueue.queue.length-1].param,{g:[f+c.x,g+c.y]})}stage.gGameStatus.btn_lock=!1,1!=stage.gGameStatus.diagram||stage.pJsnData.is_watching===!0||stage.gGameStatus.auto_attack||this.$el.find(".img-diagram").removeClass("display-on").addClass("display-off"),d?this.AttackSwitch():(this.AddAttackQueueUI("normal_attack"),this.battleAutoType===Va.FULL&&stage.gGameStatus.auto_attack||this.showAutoButton(),this.showAttackCancelButton(),stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue())}},AddAbilityQueue:function(a,c){if(!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0;var d=a&&a.is_by_auto===!0;if(stage.gGameStatus.abilityRailUse===Qa.OFF){var e=this.$el.find(".prt-ability-dialog");if(e.hasClass("disable")&&!d)return void(stage.gGameStatus.btn_lock=!1);e.addClass("disable"),this._controlDomAttackButton(!1),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("out")}1==stage.gGameStatus.ability_popup&&a&&a.is_by_auto!==!0&&(this.$el.find(".prt-ability-dialog").css("display","none"),this.hideMask());var f=stage.gGameStatus.attackQueue.$useAbilityTmp;d&&(f=this.$el.find(".prt-ability-list").find('[ability-id="'+a.ability_id+'"]').parent());var g,h=this.$el.find(".btn-ability-use"),i=h.attr("ability-character-num"),j=h.attr("ability-name"),k=h.attr("ability-id");g=void 0!==a&&c===!0?a:{raid_id:stage.pJsnData.raid_id,target_num:stage.gGameStatus.$target,lock:stage.gGameStatus.lock,ability_id:k,ability_character_num:i,ability_sub_param:stage.gGameStatus.ability_sub_param,ability_aim_num:stage.gGameStatus.ability_aim_num},g.tnum=d===!0?Na:stage.gGameStatus.tnum,stage.gGameStatus.tnum=0;var l=stage.gGameStatus.attackQueue.gUseAbility,m=b.some(stage.pJsnData.ability,function(a){return"player"===a.mode&&+a.list[1][0]["ability-id"]===+k});m===!0&&l.length>0&&(g.g=l,stage.gGameStatus.attackQueue.gUseAbility=[]),stage.gGameStatus.avmAbilityFlag===!0&&(g.avm=stage.pJsnData.avm);var n=this.getIsReadyToPlayScenario();stage.gGameStatus.attackQueue.queue.push({index:{num:i,name:j},$useAbility:f,param:g});var o=f.find('[class^="ico-ability"]'),p=o.attr("class").split(" ")[0].split("ico-ability")[1];this.AddAttackQueueUI(p),("0"!=o.attr("recaset-default")||stage.gGameStatus.ability_sub_param.length>0)&&f.addClass("tmp-mask").find(".ico-ability-shine").attr("style","display : block"),stage.gGameStatus.ability_sub_param=[],stage.gGameStatus.ability_aim_num=null,this.abilityEmphasis=g.emphasis||this.abilityEmphasis||!1,stage.gGameStatus.btn_lock=!1,n?this.SelectAbility():stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue()}},AddSummonAttackQueue:function(b){if(!stage.gGameStatus.btn_lock&&(stage.gGameStatus.btn_lock=!0,!a(b.currentTarget).parents(".pop-summon-detail").hasClass("disable")&&1==stage.pJsnData.player.param[0].alive)){var c=this.GetHeroPos();if(stage.pJsnData.lyria_num>=0){var d=stage.pJsnData.lyria_num,e=stage.pJsnData.lyria_pos;if(1!=stage.pJsnData.player.param[d].alive)return;if(0>e||0==stage.gGameStatus.player.param[e].condition.summon_available_flag)return stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),this._controlDomAttackButton(!0),this.CommandBackTop(),void this.popShowSummonFail(!0);if(c>=0&&0==stage.gGameStatus.player.param[c].condition.summon_available_flag)return stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),this._controlDomAttackButton(!0),this.CommandBackTop(),void this.popShowSummonFail(!1)}else if(0>c||0==stage.gGameStatus.player.param[c].condition.summon_available_flag)return stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),this._controlDomAttackButton(!0),this.CommandBackTop(),void this.popShowSummonFail(!1);if(this.$el.find(".pop-summon-detail").css("display","none"),this.hideMask(),stage.gGameStatus.abilityRailUse===Qa.OFF)this._controlDomAttackButton(!1),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"),stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]].gotoAndPlay("out");else{var f=this.checkSummonLimitCount();1==f&&this.CommandBackTop()}var g=stage.gGameStatus.attackQueue.$useAbilityTmp,h=g.attr("summon-id"),i={raid_id:stage.pJsnData.raid_id,target_id:stage.gGameStatus.target,lock:stage.gGameStatus.lock,summon_id:h};stage.gGameStatus.tnum=0;var j=stage.gGameStatus.attackQueue.gUseSummon;"supporter"===h&&j.length>0&&(i.g=j,stage.gGameStatus.attackQueue.gUseSummon=[]),stage.gGameStatus.avmSummonFlag===!0&&(i.avm=stage.pJsnData.avm);var k=this.getIsReadyToPlayScenario();stage.gGameStatus.attackQueue.queue.push({index:"SummonAttack",param:i,$useAbility:g});var l="summon_"+g.attr("summon-attribute");this.AddAttackQueueUI(l),"0"!=g.attr("summon-require")&&g.addClass("tmp-mask"),stage.gGameStatus.btn_lock=!1,k?this.SelectSummon():stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue()}},runFullAuto:function(a){function b(){f?(a.showTurnFlag&&i.mTurn(stage.gGameStatus.turn),d.AddAbilityQueue(e,!0)):d.AttackSwitch()}function c(a){e.ability_id=a["ability-id"],e.ability_character_num=a["ability-character-num"],e.abilityNumber=a["class"].substr(-1),e.emphasis=a.emphasis,f=!0}if(+this.abilityRailTurnWaiting>0)return void(stage.gAryCntnParts[7].visible||this.cjsTurnWaitingShow());var d=this,e={lock:stage.gGameStatus.lock,raid_id:stage.pJsnData.raid_id,is_by_auto:!0};stage.gGameStatus.avmAbilityFlag||(stage.gGameStatus.avmAbilityFlag=!0);var f=!1,g=this.getAvailableAbilityList(),h=stage.gGameStatus.attackQueue.abilityRailUI;a=a||{},g[Ua.STRENGTHEN][0]?c(g[Ua.STRENGTHEN][0]):g[Ua.WEAKEN][0]?c(g[Ua.WEAKEN][0]):g[Ua.DAMAGE][0]&&c(g[Ua.DAMAGE][0]),h&&h.removing?h.addEventListener("removeEnd",function j(){h.removeEventListener("removeEnd",j),1!==stage.gGameStatus.attacking&&b()}):b()},getAvailableAbilityList:function(){var a={};a[Ua.DAMAGE]=[],a[Ua.WEAKEN]=[],a[Ua.STRENGTHEN]=[];var c=b.filter(stage.gGameStatus.player.param,function(a){return 1===a.alive});return b.each(stage.pJsnData.ability,function(d,e){b.each(d.list,function(d,f){var g=c[e-1].condition.ability_available_list,h=d[0]["ability-character-num"]+"_"+d[0]["class"].substr(-1);g&&!g[f]||!d[0]["full-auto-permit-flag"]||b.contains(Zb,h)||a[d[0]["icon-type"]].push(d[0])})}),a},SelectAbilityRailIcon:function(b){var c=a(b.currentTarget),d=parseInt(c.attr("index"));(0!==d||stage.gAryCntnParts[7].visible&&0===d)&&stage.gGameStatus.attackQueue.queue[d]&&(p.playSE("se/btn_se/btn_se_03.mp3"),this.RemoveAttackQueueUI(d),this.RemoveAttackQueue(d))},AttackCancel:function(){var a=stage.gGameStatus.attackQueue.queue.length-1;0>a||"NormalAttack"!==stage.gGameStatus.attackQueue.queue[a].index||(this.RemoveAttackQueueUI(a),this.RemoveAttackQueue(a),+this.abilityRailTurnWaiting>0&&stage.gGameStatus.diagram&&this.battleAutoType===Va.FULL&&!stage.gGameStatus.auto_attack&&this.$el.find(".img-diagram").removeClass("display-off").addClass("display-on"),this.battleAutoType===Va.FULL&&0===stage.gGameStatus.attackQueue.queue.length&&(stage.gGameStatus.attacking=0,this.isFullAutoAttacking()&&this.runFullAuto()))},RemoveAttackQueue:function(a){var b=this,c=stage.gGameStatus.attackQueue.queue[a];switch(c.index){case"NormalAttack":stage.gGameStatus.attackQueue.attackButtonPushed=!1,this.clearTimeoutOne("normalAttackTimeout"),this._controlDomAttackButton(!0),this.hideAttackCancelButton(function(){b.$el.find(".btn-attack-start").hasClass("display-on")===!0&&stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in")}),this.isFullAutoAttacking()||(stage.gGameStatus.auto_attack_display_flag&&this._offAutoButton(),(this.battleAutoType===Va.NORMAL||this.battleAutoType===Va.FULL&&stage.gGameStatus.diagram)&&this.hideAutoButton()),+this.abilityRailTurnWaiting>0&&stage.gGameStatus.diagram&&this.battleAutoType===Va.FULL&&stage.gGameStatus.auto_attack&&stage.gGameStatus.auto_attack_display_flag&&(this._offAutoButton(),this.hideAutoButton()),this.showChatIcon(),1!=stage.gGameStatus.diagram||stage.pJsnData.is_watching===!0||stage.gGameStatus.auto_attack||this.$el.find(".img-diagram").removeClass("display-off").addClass("display-on"),this.$el.find(".prt-command-top .prt-member div[class^='lis-character']").removeClass("mask-black-fade");break;case"SummonAttack":c.$useAbility.removeClass("tmp-mask");break;case"itemUse":break;default:c.$useAbility.removeClass("tmp-mask"),c.$useAbility.find(".ico-ability-shine").removeAttr("style")}stage.gGameStatus.attackQueue.queue.splice(a,1),stage.gGameStatus.isPlayingScenariosImmediately&&0===stage.gGameStatus.attackQueue.queue.length&&(stage.gAryCntnParts[7].visible&&0===b.abilityRailTurnWaiting&&this.cjsTurnWaitingHide(),this.stopListening(this,"finishPlayScenariosImmediately"),stage.gGameStatus.hasHandlerScenariosImmediatelyFinished=!1),0===+a&&this.abilityRailTurnWaiting>0&&stage.gGameStatus.attackQueue.queue[0]&&"itemUse"===stage.gGameStatus.attackQueue.queue[0].index&&this.InvokeAttackQueue()},ResetAllAttackQueue:function(){this.RemoveAttackQueueUI("all");var a=this.$el.find(".lis-ability.tmp-mask");a.removeClass("tmp-mask"),a.find(".ico-ability-shine").removeAttr("style");var b=this.$el.find(".lis-summon.tmp-mask");b.removeClass("tmp-mask"),this.hideAttackCancelButton(),this.updateItemNum(),stage.gGameStatus.attackQueue={queue:[],$useAbilityTmp:stage.gGameStatus.attackQueue.$useAbilityTmp,attackButtonPushed:!1,abilityRailUI:stage.gGameStatus.attackQueue.abilityRailUI,charaChangeFlag:!1,pause:!1,itemNumTmp:{Potion:null,TemporarySmall:null,TemporaryLarge:null,EventItem:{},ArcarumItem:{}},gUseAbility:[],gUseSummon:[]},stage.gGameStatus.ability_aim_num=null,stage.gAryCntnParts[7].visible&&0===self.abilityRailTurnWaiting&&this.cjsTurnWaitingHide(),this.stopListening(this,"finishPlayScenariosImmediately"),stage.gGameStatus.hasHandlerScenariosImmediatelyFinished=!1},updateItemNum:function(){var a=stage.gGameStatus.attackQueue.itemNumTmp;b.isNull(a.Potion)||(stage.gGameStatus.potion.count=a.Potion),b.isNull(a.TemporarySmall)||(stage.gGameStatus.temporary.small=a.TemporarySmall),b.isNull(a.TemporaryLarge)||(stage.gGameStatus.temporary.large=a.TemporaryLarge),b.isEmpty(a.ArcarumItem)||b.each(a.ArcarumItem,function(a,b){stage.pJsnData.arcarum.item[b].number=a}),b.isEmpty(a.EventItem)||b.each(a.EventItem,function(a,b){stage.gGameStatus.event.item[b].number=a}),a={Potion:null,TemporarySmall:null,TemporaryLarge:null,EventItem:{},ArcarumItem:{}}},AddAttackQueueUI:function(a){if(stage.gGameStatus.abilityRailUse!==Qa.OFF){this.$el.find(".prt-ability-rail-overlayer").removeClass("hide");var b=stage.gGameStatus.attackQueue.queue;if(!(b.length>5)){var c=null!==stage.gGameStatus.attackQueue.abilityRailUI;c||(stage.gGameStatus.attackQueue.abilityRailUI=this.createAbilityRailComponent()),stage.gGameStatus.attackQueue.abilityRailUI.addIcon(b.length-1,a)}}},RemoveAttackQueueUI:function(a){if(stage.gGameStatus.abilityRailUse!==Qa.OFF&&!(a>=5)){var b=null!==stage.gGameStatus.attackQueue.abilityRailUI;if(b){var c=stage.gGameStatus.attackQueue.queue,d=c.length;if("all"==a||0===d)return void(b&&(stage.gGameStatus.attackQueue.abilityRailUI.hide(),this.$el.find(".prt-ability-rail-overlayer").addClass("hide")));void 0===a&&(a=0);for(var e=[],c=stage.gGameStatus.attackQueue.queue,f=0;6>f&&d>f;f++){var g="";switch(c[f].index){case"NormalAttack":g="normal_attack";break;case"SummonAttack":g="summon_"+c[f].$useAbility.attr("summon-attribute");break;case"itemUse":g=c[f].iconPath;break;default:g=c[f].$useAbility.find('[class^="ico-ability"]').attr("class").split(" ")[0].split("ico-ability")[1]}if(!g)return;e.push(g)}stage.gGameStatus.attackQueue.abilityRailUI.removeIcon(a,e)}}},cjsTurnWaitingShow:function(){stage.gAryCntnParts[7].visible=!0,stage.gAryRootParts[7][stage.gGameParam.cjs.parts[7]].gotoAndPlay("in")},cjsTurnWaitingHide:function(){stage.gAryRootParts[7][stage.gGameParam.cjs.parts[7]].gotoAndPlay("out");var a=stage.gAryRootParts[7][stage.gGameParam.cjs.parts[7]][stage.gGameParam.cjs.parts[7]+"_out"].timeline.duration,b=a*stage.gGameParam.spf,c="cjsTurnWaitingEnd";this.clearTimeoutOne(c),this.setNamedTimeout(c,function(){stage.gAryCntnParts[7].visible=!1},b)},abilityRailTurnWaitingStart:function(){stage.gAryCntnParts[7].visible||this.cjsTurnWaitingShow(),stage.gGameStatus.attackQueue.attackButtonPushed===!0&&1===stage.gGameStatus.attackQueue.queue.length&&(this.AddAttackQueueUI("normal_attack"),this.showAttackCancelButton(),this.inactivateMask()),this.trigger(Mb)},handleDisabledAttack:function(){var a=this,b="";Ca===!0?b=D.getMessage("raid_quest1254"):this.attackDisableComment&&(b=this.attackDisableComment),""!==b&&(p.playSE(Fa),this.showBattleCondition(!1,"",b,function(){a.isFullAutoAttacking()===!0&&a.changeAutoMode()}))},AttackSwitch:function(a){if(Ba===!1)return void this.handleDisabledAttack();if(stage.gGameStatus.is_normal_attack=!0,"ability"===stage.gGameStatus.menu||"summon"===stage.gGameStatus.menu){this.$el.find(".prt-command-chara").css("display","none"),this.$el.find(".prt-slide-icon").removeClass("show-icon"),this.$el.find(".prt-navi").removeClass("active display-on"),this.$el.find(".btn-command-back").removeClass("display-on"),this.CommandChangeTop({motion:!1});for(var b=0,c=stage.gAryRootAvatar.length-1;c>=b;b++)1!=stage.gGameStatus.player.param[b].alive||1===stage.gGameStatus.usingAbility&&stage.gGameStatus.useAbilityPos===b||(parseInt(stage.gGameStatus.player.param[b].recast)>=parseInt(stage.gGameStatus.player.param[b].special_skill_recast)&&stage.gGameStatus.player.param[b].special_skill_activate_flag&&1!=stage.gGameStatus.lock?f.mChangeMotionInstantly({motion:"ability",pos:b,type:"player"}):f.mChangeMotionInstantly({motion:stage.gGameStatus.defaultmotion[stage.pJsnData.formation[b]],pos:b,type:"player"}));stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"),stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]].gotoAndPlay("out"),stage.gGameStatus.diagram&&this.$el.find(".img-diagram").removeClass("display-on").addClass("display-off");var d=stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]][stage.gGameParam.cjs.parts[1]+"_out"].timeline.duration;setTimeout(function(){stage.gAryCntnParts[1].visible=!1},d*stage.gGameParam.spf)}if(!stage.gGameStatus.attackQueue.attackButtonPushed)return stage.gGameStatus.attackQueue.attackButtonPushed=!0,this.AddNormalAttackQueue(a),void(stage.gGameStatus.auto_attack&&this.battleAutoType===Va.NORMAL||(this._controlDomAttackButton(!1),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out")));if(1===+stage.pJsnData.multi&&stage.gGameStatus.node_finish===!0)return void this.ResetAllAttackQueue();stage.gGameStatus.attacking=1,this.RemoveAttackQueueUI("all"),stage.gGameStatus.auto_attack||stage.pJsnData.is_multi===!0||this.trigger(Lb),this.AttackHide(),stage.gGameStatus.auto_attack||(+this.abilityRailTurnWaiting>0?this.showAutoButton():this.battleAutoType===Va.NORMAL&&this.hideAutoButton()),+this.abilityRailTurnWaiting>0?this.showSmallChatIcon():this.hideSmallChatIcon(),stage.gGameStatus.auto_attack!==!0||stage.pJsnData.is_arcade&&(!stage.pJsnData.is_arcade||stage.pJsnData.arcade.is_bonus)||0!==+this.abilityRailTurnWaiting||i.mTurn(stage.gGameStatus.turn),this.hideAttackCancelButton(),Zb.length>0&&(Zb.length=0);var e={};stage.gGameStatus.auto_attack===!0?(e={tnum:Na},stage.gGameStatus.tnum=0):e=stage.gGameStatus.attackQueue.queue[0].param,this.Attack("normal_attack_result",e)},AttackHide:function(){this.$el.find(".btn-command-back").removeClass("display-on"),this._controlDomAttackButton(!1),this.$el.find(".prt-temporary").removeClass("display-on").addClass("display-off"),this.$el.find(".img-diagram").removeClass("display-on").addClass("display-off");var a=this.$el.find(".img-score");a.hasClass("display-on")&&a.removeClass("display-on");var b=this.$el.find(".cnt-raid-chat").find(".btn-chat");b.removeClass("display-on").addClass(ga)},playScenarios:function(c,d,e,f,h,i){var j=this,k=i||null;d=d||0,e=e||0,b.isUndefined(stage.pJsnData.rep)||(c=stage.pJsnData.rep[stage.gGameStatus.rep],stage.gGameStatus.rep++),j.preprocessOnPlayScenarios(c);var l=g.mInit("avatar"),m=g.mInit("boss"),n=g.mInit("common"),o=j.coreprocessOnPlayScenarios(l,m,n,c,d,e,f,h,k),p=new a.Deferred;return o.done(function(a){j.postprocessOnPlayScenarios(l,m,n,c,h),a.push(new createjs.Timeline([].concat(l.timeline,m.timeline,n.timeline),{start:0},{useTicks:!0,paused:!0}));for(var b=0,d=a.length-1;d>=b;b++)a[b].setPaused(!1);p.resolve()}),p},preprocessOnPlayScenarios:function(c){"block"===a("#pop .pop-usual").css("display")&&0===stage.gGameStatus.attackQueue.queue.length&&(a("#pop .pop-usual").css("display","none").removeClass("pop-show pop-hide"),this.hideMask(),b.isUndefined(this.popView)||this.popView.popOff()),"block"===a(".pop-usual").css("display")&&0===stage.gGameStatus.attackQueue.queue.length&&(a(".pop-usual").css("display","none").removeClass("pop-hide"),this.hideMask()),1!==+stage.pJsnData.multi&&stage.pJsnData.is_sequence!==!0&&stage.pJsnData.is_ascendant!==!0||b.isUndefined(c.status)||(c.status.fellow&&1===+stage.pJsnData.multi&&(stage.pJsnData.fellow=c.status.fellow),c.status.timer&&(stage.pJsnData.timer=c.status.timer));for(var d=null,e=!1,f=0,g=c.scenario.length-1;g>=f;f++){if("attack"===c.scenario[f].cmd||"special"===c.scenario[f].cmd||"special_npc"===c.scenario[f].cmd){d=c.scenario[f].pos;break}"arcarum_stage_effect"===c.scenario[f].cmd&&(e=!0)}if("ability"!==stage.gGameStatus.menu&&"summon"!==stage.gGameStatus.menu&&"temporary"!==stage.gGameStatus.menu&&stage.gGameStatus.attackQueue.queue[0]&&"SummonAttack"!=stage.gGameStatus.attackQueue.queue[0].index&&e===!1&&2!==stage.gGameStatus.chara_select)for(var f=0,h=stage.gGameStatus.player.number;h>=f;f++){var i=this.$el.find(".prt-command-top").find(".lis-character"+f);f!=d&&i.addClass("mask-black-fade")}for(var f=0,j=stage.gAryCntnBoss.length-1;j>=f;f++)1==stage.gGameStatus.boss.param[f].alive&&(stage.gAryCntnBoss[f].visible=!0);this.hideEnemyInfo()},coreprocessOnPlayScenarios:function(c,d,e,h,i,j,k,n,o){var p=this,q=[],r=b.size(h.scenario)-1,s=[],t=[];q=q.concat(b.pluck(h.scenario,"kind")),q=q.concat(b.pluck(h.scenario,"effect"));for(var u=0;r>=u;u++){var v=h.scenario[u];if(b.isUndefined(h.scenario[u])!==!0){if("object"==typeof h.scenario[u].list)for(var w=0,x=h.scenario[u].list.length-1;x>=w;w++)q=q.concat(b.pluck(h.scenario[u].list[w].damage,"kind")),q=q.concat(b.pluck(h.scenario[u].list[w].damage,"effect"));if("formchange"===h.scenario[u].cmd&&(q=q.concat(h.scenario[u].param.cjs),q=q.concat(h.scenario[u].param.effect)),"attack"===h.scenario[u].cmd&&b.each(h.scenario[u].damage,function(a){b.isUndefined(a[0].additional)||b.each(a[0].additional,function(a){a.effect&&(q=q.concat(a.effect.kind))})}),"arcarum_stage_effect_release"===h.scenario[u].cmd){var y=[];b.each(h.scenario[u].arcarum_stage_effect_release,function(a){var b=p.getReleaseArcarumStageEffectCjsName(a);null!==b&&y.push(b)}),q=q.concat(y)}if("bg_change"===v.cmd&&(s.push(v.bg_image),m.loadFile(Game.imgUri+v.bg_image,!1),v.cjs&&q.push(v.cjs)),"win"===v.cmd&&b.isUndefined(v.cjs)===!1&&q.push(v.cjs),"doubleup"===h.scenario[u].cmd){var z=[{src:Game.imgUri+"/sp/casino/poker/card/card_"+h.scenario[u].card.left+".png",id:Ta+"_dammy_01",type:"image"},{src:Game.imgUri+"/sp/casino/poker/card/card_"+h.scenario[u].card.right+".png",id:Ta+"_dammy_02",type:"image"}];q.push(Ta),t=t.concat(z)}}}q=b.filter(q,function(a){return a}),q.length<1&&stage.pJsnData.player.param[0].effect&&(q=[stage.pJsnData.player.param[0].effect]);var A=new a.Deferred;return setTimeout(b.partial(l.loadFiles,q,!0),0),l.once("complete",function(){if(m.once("complete",function(){b.each(s,function(a){var b=a.replace(/.*\/([^.]*)\..*/,"$1");stage.gGameStatus.backImage[b]=new createjs.Bitmap(Game.imgUri+a)});for(var l=0,m=stage.gAryCntnAvatar.length-1;m>=l;l++)c.timeline[l]=createjs.Tween.get(stage.gAryCntnAvatar[l],{override:!0,paused:!0});for(var l=0,o=stage.gAryCntnBoss.length-1;o>=l;l++)d.timeline[l]=createjs.Tween.get(stage.gAryCntnBoss[l],{override:!0,paused:!0});e.timeline[0]=createjs.Tween.get({},{override:!0,paused:!0});var q=[],r=new Date-j,t=parseInt(r/stage.gGameParam.spf+.5);i>t&&f.mWaitAll([c,d,e],{playtime:t-i}),stage.gGameStatus.balloon="attack",f.mWaitAll([c,d,e],{playtime:6});var u=new a.Deferred;p.setupScenarios(h,c,d,e,k,n).done(function(){u.resolve()}),u.done(function(){q.push(new createjs.Timeline([].concat(c.timeline,d.timeline,e.timeline),{start:0},{useTicks:!0,paused:!0}));var a=g.mResetTimeline(q,[c,d,e]);c=a[0],d=a[1],e=a[2],p.oTweenCommon=e,A.resolve(q)})}),stage.pJsnData.player.job_is_formchange){var l={src:Game.imgUri+"/sp/cjs/"+stage.pJsnData.weapon.weapon+".png",id:"weapon",type:"image"};t.push(l)}m.loadManifest(t)}),A},postprocessOnPlayScenarios:function(c,d,e,g,h){if(!this.isDestroyed){var j=this,k=(this.$el.find(".btn-attack-start"),this.$el.find(".prt-command-summon")),l=this.$el.find(".prt-navi");if(this.prevRemainEnemyNum=this.getRemainEnemyPosIdList().length,this.tmpCjsIndex=null,e.timeline[0].call(function(){if(j.isDestroyed!==!0&&!stage.gGameStatus.retire&&!g.tutorial_pause){if(!b.isUndefined(g.status)){if(b.isUndefined(g.status.summon)||k.find('div[class^="lis-summon"]').each(function(a){if(!b.isUndefined(stage.pJsnData.summon[a])){var c=g.status.summon.recast[a];stage.pJsnData.summon[a].recast=b.isNull(c)===!0?null:String(c)}}),!b.isUndefined(g.status.supporter)){var c=g.status.supporter.recast;stage.pJsnData.supporter.recast=b.isNull(c)===!0?null:String(c)}b.isUndefined(g.status.summon_enable)||(stage.pJsnData.summon_enable=g.status.summon_enable),b.isUndefined(g.status.summon_special_effect)===!1?stage.pJsnData.summon_special_effect=g.status.summon_special_effect:stage.pJsnData.summon_special_effect=void 0,b.isUndefined(g.status.ability)||(stage.pJsnData.ability=g.status.ability,b.each(stage.pJsnData.ability,function(a){var c=b.indexOf(stage.pJsnData.formation,""+a.pos);b.isNull(j.naviEmphasis)||j.naviEmphasis.charaIndex!==c||(a.list[j.naviEmphasis.abilityIndex][0].emphasis=!0),i.mSetAbility(a,c)})),b.isUndefined(g.status.treasure)||(stage.pJsnData.treasure.treasure_type_1=g.status.treasure.treasure_type_1,stage.pJsnData.treasure.treasure_type_2=g.status.treasure.treasure_type_2,stage.pJsnData.treasure.treasure_type_3=g.status.treasure.treasure_type_3,stage.pJsnData.treasure.treasure_type_4=g.status.treasure.treasure_type_4,stage.pJsnData.treasure.treasure_type_5=g.status.treasure.treasure_type_5),b.isUndefined(g.status.balloon)||(stage.pJsnData.balloon.boss=g.status.balloon.boss,i.mBalloon(e.timeline[0])),b.isUndefined(g.status.lupi)||(stage.pJsnData.lupi=g.status.lupi),b.isUndefined(g.status.turn)||(stage.gGameStatus.turn=g.status.turn),stage.pJsnData.is_arcade&&stage.pJsnData.arcade.is_bonus&&(stage.gGameStatus.remain_turn=+stage.pJsnData.arcade.bonus_maxtrun-+g.status.turn+1),j.isTrainingBattle&&j.updateSpecialConditionTurn(g.status.turn);for(var d=0,f=stage.pJsnData.player.param.length;f>d;++d)1==stage.pJsnData.battle.count&&1==stage.gGameStatus.turn&&stage.gGameStatus.doneSetupMotionPlayer[d]===!1?stage.gGameStatus.defaultmotion[d]="wait":stage.gGameStatus.defaultmotion[d]="stbwait";b.each(stage.pJsnData.boss.param,function(a,b){stage.gGameStatus.bossmode.already_changed[b]=!1}),!stage.gGameStatus.field.hasFieldEffect&&a("#prt-field-conditions").hasClass("show")&&i.mRemoveConditionField(),b.isUndefined(g.lyria_pos)||(stage.pJsnData.lyria_pos=g.lyria_pos),b.isUndefined(g.status.ability_turn)||(stage.gGameStatus.abilityTurn=g.status.ability_turn)}stage.gGameStatus.action={ab_select:""},"normal_attack_result"===stage.gGameStatus.attack_action&&b.each(stage.gGameStatus.player.param,function(a,b){i.changeCoatingDisplay(1,b,2,!1)});var h=j.getRemainEnemyPosIdList();1===h.length&&h.length<j.prevRemainEnemyNum&&(j.changeEnemyStatusSize(h[0],"l1",0),i.changeFieldConditionPosition(0)),j.tmpCjsIndex=null,stage.gGameStatus.isNodeBossKillScenarios&&(stage.gGameStatus.isNodeBossKillScenarios=!1,stage.gGameStatus.isPlayingScenariosImmediately=!1,j.trigger("finishPlayScenariosImmediately"))}}),f.mWaitAll([c,d,e],{playtime:15}),1==stage.pJsnData.is_multi&&stage.gGameStatus.attack_count>0&&stage.gGameStatus.attack_count%j.attackCount==0&&!stage.gGameStatus.finish&&!stage.gGameStatus.retire&&!stage.gGameStatus.lose&&!stage.gGameStatus.clear&&0===Game.setting.cjs_mode){e.timeline[0].call(function(){i.mHideBossGauge(kb)}),c.timeline[0].pause(),d.timeline[0].pause(),e.timeline[0].pause();var m=i.mBattleReload(e.timeline[0],{kind:stage.gGameParam.cjs.raid_reload});f.mWaitAll([c,d,e],{playtime:m+6}),e.timeline[0].call(function(){i.mSlideOut(),setTimeout(function(){var a=stage.pJsnData.is_semi?"#raid_semi/"+stage.pJsnData.raid_id:"#raid_multi/"+stage.pJsnData.raid_id+"/"+(j.currentFps/6-1)+"/"+stage.gGameStatus.lock;j.content_close(),w.hash(a,{refresh:!0})},500*(j.currentFps/j.baseFps))}),f.mWaitAll([c,d,e],{playtime:120})}e.timeline[0].call(function(){if(j.isDestroyed!==!0){stage.gGameStatus.already_finish||j.inactivateMask();var c=a("body");Game.ua.isJssdk()&&(c=a(Game.gameContainer.selector)),j.offBodyPreventDefault(c),j.checkPlayerAllDead(),stage.gGameStatus.pop_limit=!1,stage.gGameStatus.btn_lock=!1,g.status&&b.each(g.status.special_skill_activate,function(a){stage.gGameStatus.player.param[+a.pos].special_skill_activate_flag=a.special_skill_activate_flag}),j.updateItemNum();var d=g.battleFinishedByThisScenarios||stage.gGameStatus.finish;if(!(d||stage.gGameStatus.retire||stage.gGameStatus.lose||g.tutorial_pause||stage.gGameStatus.node_finish)){if(2!==stage.gGameStatus.chara_select&&(j.$el.find(".prt-member").find("div[class^='lis-character']").removeClass("mask-black mask-black-fade"),j.$el.find(".prt-sub-command>div").removeClass("black"),k.find(".prt-list-top").removeClass("mask-black mask-black-fade")),"none"!==(((g.navi_information||{})[0]||{}).navi||"none")){stage.pJsnData.navi_information=g.navi_information;var e=j.getForceNaviIndex(stage.pJsnData.navi_information),h=!(0==stage.gGameStatus.serif&&0==stage.pJsnData.is_riddle)||e>=0;
if(h){stage.pJsnData.navi_index=e>=0?e:0;var m=stage.pJsnData.navi_information[stage.pJsnData.navi_index];if(m){var n=j.hasForceShowNaviFlag(stage.pJsnData.navi_information);stage.gGameStatus.auto_attack===!0&&n&&(j.retainedAutoSetting=stage.gGameStatus.auto_attack,stage.gGameStatus.auto_attack=!1,j.updateBeforeAutoAttackStatus(Ia.NAVI_INFORMATION,Ha.WAIT)),stage.gGameStatus.auto_attack===!1&&j.NaviShow(m),n&&b.each(Wa,function(a){j.hidePUAndTreasurePU(a.selector,a.popHideFunctionName)})}}else l.removeClass("active")}else l.removeClass("active");"normal_attack_result"==stage.gGameStatus.attack_action?(j.showEnemyInfo(),stage.gGameStatus.attackQueue.attackButtonPushed=!1):j.showEnemyInfo({targetedEnemyOnly:!0}),g.status&&g.status.voice&&j._playStatusVoice(g.status.voice),j.$el.find(".prt-ability-dialog").removeClass("disable"),null!==stage.gGameStatus.player.posSizeL&&null===j._getLsizePlayerPos()&&i.resetLsizePlayerDisplay(),j.renewCharaList(),stage.gGameStatus.pop_revival=!1;var o=stage.pJsnData.suddenly_attack_flag===!0&&j.showArcarumStageEffect===!1,p=stage.pJsnData.suddenly_attack_flag===!0&&j.showArcarumStageEffect===!0;if(stage.gGameStatus.auto_attack&&+this.battleAutoType===Va.NORMAL||!(stage.gGameStatus.attackQueue.queue.length<=1)||p||(stage.gGameStatus.attackQueue.attackButtonPushed||(stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),j._controlDomAttackButton(!0)),("normal_attack_result"===stage.gGameStatus.attack_action||o||j.isRematchAtAllDead===!0)&&i.mTurn(stage.gGameStatus.turn)),j.isRematchAtAllDead=!1,(o||stage.pJsnData.is_start_battle_navi_first_priority===!0)&&(stage.pJsnData.is_start_battle_navi_first_priority===!1&&stage.gGameStatus.naviInfoDeferred.resolve(),j.updateBeforeAutoAttackStatus(Ia.SUDDENLY_ATTACK,Ha.FINISHED)),stage.pJsnData.is_start_battle_navi_first_priority=!1,p||(stage.gAryCntnParts[0].visible=!0),o&&(stage.pJsnData.suddenly_attack_flag=!1),g.status&&stage.pJsnData.is_semi&&g.status.ranking&&j.updateDamageRanking(g.status.ranking),Ca===!1&&g.status&&(b.isUndefined(g.status.is_attack_disable)===!1&&Ba===g.status.is_attack_disable||g.status.attack_disable_comment!==j.attackDisableComment)&&j.switchAttackStatus(!g.status.is_attack_disable,g.status.attack_disable_comment),"ability"===stage.gGameStatus.menu){stage.gGameStatus.balloon="ability",stage.gGameStatus.motion=!1,stage.gGameStatus.attacking=0;var q=b.isUndefined(stage.gGameStatus.useAbilityPos)?+stage.gGameStatus.command_slide.now_pos:stage.gGameStatus.useAbilityPos,r=j.$el.find(".prt-command-chara").eq(q);b.isUndefined(stage.gGameStatus.player.param[q])||1!==stage.gGameStatus.player.param[q].alive?(stage.gGameStatus.usingAbility=0,stage.gGameStatus.menu="top",j.inactivateMask()):q!==+stage.gGameStatus.command_slide.now_pos||!r.find("[class^='lis-ability'] div").hasClass("shine0")&&(parseInt(stage.gGameStatus.player.param[q].recast)<parseInt(stage.gGameStatus.player.param[q].recastmax)||1==stage.gGameStatus.lock)?f.mChangeMotionInstantly({motion:"stbwait",pos:q,type:"player"}):b.isUndefined(stage.gGameStatus.hide_ability_pos)&&f.mChangeMotionInstantly({motion:"ability",pos:q,type:"player"}),stage.pJsnData.is_semi&&stage.pJsnData.is_defendorder||j.showChatIcon()}else if("summon"===stage.gGameStatus.menu)if(stage.gGameStatus.balloon="summon",stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]].gotoAndPlay("in"),stage.gGameStatus.usingAbility){stage.gGameStatus.usingAbility=0;for(var s=stage.gGameStatus.player.param,t=0;t<=stage.gAryRootAvatar.length-1;t+=1)if(1===+s[t].alive&&stage.gGameStatus.player.isPlayingDeadMotion[t]!==!0){var u=stage.pJsnData.lyria_pos>=0?stage.pJsnData.lyria_pos:j.GetHeroPos();u===t?f.mChangeMotionInstantly({motion:"summon",pos:t,type:"player"}):parseInt(s[t].recast,10)>=+s[t].special_skill_recast&&s[t].special_skill_activate_flag&&1!==stage.gGameStatus.lock?f.mChangeMotionInstantly({motion:"ability",pos:t,type:"player"}):f.mChangeMotionInstantly({motion:stage.gGameStatus.defaultmotion[stage.pJsnData.formation[t]],pos:t,type:"player"})}}else 0==stage.pJsnData.summon_enable&&j.CommandBackTop();else"rematch"===stage.gGameStatus.menu?(stage.pJsnData.bgm&&ha(stage.pJsnData.bgm),i.mShowBossGauge(kb),j.renewCharaList(),stage.gGameStatus.attackQueue.charaChangeFlag===!0||"top"===stage.gGameStatus.menuBeforeRematch?j.CommandBackTop():stage.gGameStatus.menu=stage.gGameStatus.menuBeforeRematch):"temporary"===stage.gGameStatus.menu?(stage.gGameStatus.balloon="wait",stage.gGameStatus.motion=!1,stage.gGameStatus.menu="top",stage.gGameStatus.abilityRailUse===Qa.OFF&&j.CommandBackTop()):(stage.gGameStatus.balloon="wait",stage.gGameStatus.motion=!1,stage.gGameStatus.usingAbility=0,j.CommandChangeTop())}"normal_attack_result"==stage.gGameStatus.attack_action&&stage.pJsnData.is_arcarum&&"undefined"!=typeof g.status&&0!==+g.status.length&&(j.arcarumRestTp=g.status.arcarum.rest_tp,j.arcarumHasRetireTp=g.status.arcarum.has_retire_tp,j.updateArcarumTp()),"normal_attack_result"==stage.gGameStatus.attack_action&&stage.pJsnData.is_board&&"undefined"!=typeof g.status&&0!==+g.status.length&&(j.restTp=+g.status.board.rest_tp,j.hasRetireTp=!!g.status.board.has_retire_tp,j.updateTp(j.restTp)),1==stage.pJsnData.tutorial_flag&&j.TutorialTurnEnd()}}),e.timeline[0].call(function(){j.isDestroyed!==!0&&(stage.gGameStatus.tutorial_state=g.tutorial_pause)}),e.timeline[0].call(function(){j.isDestroyed!==!0&&(stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,j.showArcarumStageEffect=!1)}),e.timeline[0].call(function(){j.isDestroyed!==!0&&(b.isUndefined(g.duplicate_key)||(stage.pJsnData.duplicate_key=g.duplicate_key))}),e.timeline[0].call(function(){j.isDestroyed!==!0&&(jb(),j.invokeAttackPendingQueue(),j.invokeAbilityPendingQueue())}),b.isUndefined(h)||e.timeline[0].call(function(){h.resolve()}),e.timeline[0].call(function(){if(j.isDestroyed!==!0){var a=stage.gGameStatus.is_normal_attack&&stage.gGameStatus.auto_attack&&!stage.gGameStatus.attacking&&!stage.gGameStatus.finish&&!stage.gGameStatus.retire&&!stage.gGameStatus.lose&&!g.tutorial_pause&&!stage.gGameStatus.node_finish;if(j.isJustAfterPreemptiveAtkWhileAuto&&(delete j.isJustAfterPreemptiveAtkWhileAuto,j.updateBeforeAutoAttackStatus(Ia.SUDDENLY_ATTACK,Ha.FINISHED),a))return j.ResetAllAttackQueue(),void j.startAutoAttackIfCompletePreparation(!1);if(stage.gGameStatus.finish||stage.gGameStatus.already_finish)return void j.ResetAllAttackQueue();if(stage.gGameStatus.attackQueue.pause)return void(stage.gGameStatus.attackQueue.pause=!1);var c=stage.gGameStatus.attackQueue,d=j.isFullAutoAttacking(),e=!1;if(d){var f=j.getAvailableAbilityList();e=b.some(f,function(a){return a.length>0})}if(c.queue[0])switch(c.queue[0].index){case"NormalAttack":if(a&&!e)j.InvokeAttackQueue(a);else{if(e){j.showChatIcon();break}j.ResetAllAttackQueue()}return;case"SummonAttack":j.RemoveAttackQueueUI(0);break;default:j.RemoveAttackQueueUI(0)}if(c.charaChangeFlag&&c.queue.length>1&&"NormalAttack"!==c.queue[1].index)return j.popShowAbilityRailError("raid_84","raid_85"),stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,stage.gGameStatus.btn_lock=!1,j._offAutoButton(),j.ResetAllAttackQueue(),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),j._controlDomAttackButton(!0),void j.CommandBackTop();c.charaChangeFlag&&(2===stage.gGameStatus.chara_select&&j.CancelTempItemUse(),j.$el.find(".pop-usual").css("display","none"),j.hideMask(),c.charaChangeFlag=!1),j.canStartAutoAttack(e)&&d&&c.queue.length<=1&&j.runFullAuto(),c.queue[0]&&j.RemoveAttackQueue(0),j.InvokeAttackQueue(),j.trigger(Aa)}})}},playScenariosImmediately:function(a,b,c,d,e){b=b||0,c=c||0;var f=this;stage.gGameStatus.isPlayingScenariosImmediately=!0,stage.pJsnData.ability_rail_use===Qa.OFF&&this.activateMask();var h=g.mInit("avatar"),i=g.mInit("boss"),j=g.mInit("common"),k=this.coreprocessOnPlayScenarios(h,i,j,a,b,c,d,e,null);k.done(function(a){j.timeline[0].call(function(){f.inactivateMask(),stage.gGameStatus.isPlayingScenariosImmediately=!1,f.trigger("finishPlayScenariosImmediately")}),a.push(new createjs.Timeline([].concat(h.timeline,i.timeline,j.timeline),{start:0},{useTicks:!0,paused:!0}));for(var b=0,c=a.length-1;c>=b;b++)a[b].setPaused(!1)})},setupScenarios:function(g,k,l,q,r,s){var u=this,v=window.stage,x=(new a.Deferred).resolve(),y=g.scenario,z=g.status,A=g.ability_id,B=!1,C=0,E=0,F=[],G=[],H=!1,I="TIMEOUT_REDISPLAY_CHARACTER_",J={},K=-1,L=function(){},M=[];b.each(v.gGameStatus.player.param,function(a,b){var c=f.mIsSpecialMotion({type:"player",motion:"stbwait",pos:b});M[b]=1==a.alive&&c===!1&&parseInt(a.recast,10)>=+a.special_skill_recast&&a.special_skill_activate_flag}),v.global={},v.gGameStatus.hide_ability_pos=void 0,v.gGameStatus.hide_ability_all=!1,v.gGameStatus.field.hasFieldEffect=!1,v.gGameStatus.player.attackMotionWait=[0,0,0,0],v.gGameStatus.player.stbwaitAfterAttack2=[!1,!1,!1,!1];var N=!1;if(b.isUndefined(z)||b.isUndefined(z.bossmode)||b.each(z.bossmode,function(a,c){if(null!=z.bossmode[c].modechange){var d=!1,e=!1,f=!1,g=null;b.some(y,function(a,b){"turn"===a.cmd&&(e=!0),e&&"modechange"===a.cmd&&c===a.pos&&(d=!0,g=a.mode)}),(!d||g&&g!=z.bossmode[c].modechange)&&(f=!0),f&&v.gGameStatus.bossmode.looks.mode[c]!=z.bossmode[c].modechange&&(u.executeModeChange(z.bossmode[c].modechange,[k,l,q],z.bossmode[c].special_gauge,null,z.bossmode[c].log_type,c,null,null,null),i.mBreakGauge(q.timeline[0],kb[c],{pos:z.bossmode[c].pos,gauge:z.bossmode[c].modegauge}),v.gGameStatus.bossmode.looks.mode[c]=z.bossmode[c].modechange,v.gGameStatus.bossmode.already_changed[c]=!0,N=!0)}}),N&&f.mWaitAll([k,l,q],{playtime:12}),z&&z.voice){var O="";z.voice.special_skill_gauge_voice?O=z.voice.special_skill_gauge_voice:z.voice.dying_voice?O=z.voice.dying_voice:z.voice.enemy_debuff_voice?O=z.voice.enemy_debuff_voice:z.voice.turnend_voice&&(O=z.voice.turnend_voice),b.isEmpty(O)===!1&&p.loadVoice(O)}var P=v.gAryRootParts[2][v.gGameParam.cjs.parts[2]].raid_parts_turn_in.timeline.duration;"normal_attack_result"!=v.gGameStatus.attack_action||v.gGameStatus.already_finish||v.gGameStatus.node_finish||v.gGameStatus.player.all_dead||1===+v.pJsnData.no_disp_turn||this.setNamedTimeout("setup:setupScenarios",function(){if(v.gGameStatus.attackQueue.attackButtonPushed||v.gGameStatus.auto_attack){var a=u.$el.find(".btn-auto");"none"===a.css("display")&&v.gGameStatus.auto_attack_display_flag&&(v.gGameStatus.auto_attack?u._onAutoButton():u._inAutoButton(),u._showAutoButton(),u._interactiveAutoButton()),u.showSmallChatIcon()}},P*v.gGameParam.spf);var Q=["die","stop","formchange","effect"],R=["drop","boss_gauge","battlelog","modechange"];return"normal_attack_result"===v.gGameStatus.attack_action&&q.timeline[0].call(function(){b.each(v.gGameStatus.player.param,function(a,b){i.changeCoatingDisplay(0,b,1,!1)})}),b.some(y,function(N,O){return!v.gGameStatus.finish||v.gGameStatus.node_finish||v.gGameStatus.already_finish||v.gGameStatus.retire||!(b.isUndefined(s)||"rematch"!==N.cmd&&v.pJsnData.is_watching===!0)||v.gGameStatus.finish&&!v.gGameStatus.node_finish&&v.pJsnData.is_multi&&(v.gGameStatus.isNodeBossKillScenarios||v.gGameStatus.isPlayingScenariosImmediately)&&(b.contains(Q,N.cmd)&&"boss"===N.to||b.contains(R,N.cmd))?void(x=x.then(function(){function x(a,b){var c=1==v.pJsnData.player.param[v.pJsnData.formation[N.pos]].leader?"mortal_A":"short_attack",d=1===+b?"attack":c;if(+b>1)switch(+a){case 1:d="double";break;case 2:d="triple";break;case 3:d="quadruple"}return d}var P=new a.Deferred,Q=[],R=new a.Deferred;switch(N.voice&&(b.isArray(N.voice)?Q=Q.concat(b.compact(N.voice)):Q.push(N.voice)),N.damage&&(Q=Q.concat(b.chain(N.damage).pluck("voice").compact().value())),N.list&&(Q=Q.concat(b.chain(N.list).pluck("damage").flatten().compact().pluck("voice").compact().value())),N.kill_voice&&N.kill_voice.path&&Q.push(N.kill_voice.path),b.isEmpty(Q)?R.resolve():(o.once("complete",function(){R.resolve()}),o.loadFiles(Q),R.resolve()),v.global=b.extend(v.global,N.global),N.cmd){case"turn":"boss"===N.mode&&1!==+v.pJsnData.no_disp_turn&&q.timeline[0].call(function(){v.gAryRootParts[2][v.gGameParam.cjs.parts[2]].gotoAndPlay("change"),u._fadeChatButtons()}),B=!0,P.resolve();break;case"attack":if("player"===N.from){var S=0;q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,0),v.gMasterContainer.setChildIndex(v.gPlayerContainer,1)}),v.gGameStatus.replacehit[N.pos]&&(v.gGameStatus.player.param[N.pos].effect=v.gGameStatus.replacehit[N.pos],v.gGameStatus.replacehit[N.pos]=""),i.mDisplayStrip(q.timeline[0],{mode:"on",pos:N.pos});var T=0,U=N.damage.length;b.each(N.damage,function(a){if(0==N.single_motion_flag){var c=0;b.each(a,function(a){T>0&&T==U-1&&q.timeline[0].call(function(){var a=u.getAttackMessage(U,v.gGameStatus.player.param[N.pos].name)||"",b={"class":"log-battle",title:D.getMessage("raid_8"),body:a};i.mLog(b)});var d=N.motion||x(T,U);c=f.mChangeMotion(k.timeline[N.pos],{motion:d,pos:N.pos,type:"player",voice:N.voice?N.voice[T]:null}),T==U-1&&(S=c,N.standby===!0&&(f.mChangeMotion(k.timeline[N.pos],{delay:c,motion:"stbwait",pos:N.pos,type:"player",isAttackStbwait:!0}),k.timeline[N.pos].call(function(a){var b=v.pJsnData.formation[a.pos];v.gGameStatus.doneSetupMotionPlayer[b]===!1&&(v.gGameStatus.doneSetupMotionPlayer[b]=!0,v.gGameStatus.defaultmotion[b]="stbwait")},[N])));var e=N.companion_weapon_flag?Ra[b.random(Ra.length-1)]:[null,null],g=u._getHitEffect(N.pos,N.companion_weapon_flag||!1,N.effect||null);if(h.mHitEffect(l.timeline[a.pos],v.gAryCntnBoss[a.pos],{kind:g[0],size:v.pJsnData.boss.type,type:"boss",pos:a.pos,adjustValues:e[0]}),null!==g[1]&&h.mHitEffect(l.timeline[a.pos],v.gAryCntnBoss[a.pos],{kind:g[1],size:v.pJsnData.boss.type,type:"boss",pos:a.pos,delay:Sa,adjustValues:e[1]}),b.isUndefined(a.miss)||1!=a.miss&&4!=a.miss)var j=f.mChangeMotion(l.timeline[a.pos],{motion:"damage",pos:a.pos,type:"boss",delay:2});f.mWaitAll([k,l,q],{playtime:2}),h.mDamageRattle(q.timeline[0]);var m=a.color||N.color||v.gGameStatus.player.param[N.pos].attr,n=u.createDamageComponent(a,"boss",U>1,m,void 0,0);l.timeline[a.pos].call(function(){n.show()}),(b.isUndefined(a.miss)||1!=a.miss&&4!=a.miss)&&(i.mBossGaugeHp(l.timeline[a.pos],kb,v.pJsnData.boss.type,{pos:a.pos,param:{hp:a.hp,hpmax:v.gGameStatus.boss.param[a.pos].hpmax}}),f.mChangeMotion(l.timeline[a.pos],{motion:v.gGameStatus.waitmode[a.pos],pos:a.pos,type:"boss",delay:j})),a.additional&&b.each(a.additional,function(a){a.message&&u.executeMessage([k,l,q],a.message),a.effect&&u.executeEffect([k,l,q],a.effect)})}),Yb([k,l,q],{playtime:9}),T==U-1&&(S-=9)}else{T>0&&T==U-1&&q.timeline[0].call(function(){var a=u.getAttackMessage(U,v.gGameStatus.player.param[N.pos].name)||"",b={"class":"log-battle",title:D.getMessage("raid_8"),body:a};i.mLog(b)});var d=N.motion||x(T,U),e=f.mChangeMotion(k.timeline[N.pos],{motion:d,pos:N.pos,type:"player",voice:N.voice&&N.voice[T]?N.voice[T]:null});f.mWaitAll([k,l,q],{playtime:2}),T==U-1&&(S=e,N.standby===!0&&(f.mChangeMotion(k.timeline[N.pos],{delay:e,motion:"stbwait",pos:N.pos,type:"player",isAttackStbwait:!0}),k.timeline[N.pos].call(function(a){var b=v.pJsnData.formation[a.pos];v.gGameStatus.doneSetupMotionPlayer[b]===!1&&(v.gGameStatus.doneSetupMotionPlayer[b]=!0,v.gGameStatus.defaultmotion[b]="stbwait")},[N])));var g=0;b.each(a,function(c){var d=c.concurrent_attack_count;if(N.concurrent_attack_flag===!1||0===d){var e=N.companion_weapon_flag?Ra[b.random(Ra.length-1)]:[null,null],j=u._getHitEffect(N.pos,N.companion_weapon_flag||!1,null);g=h.mHitEffect(l.timeline[c.pos],v.gAryCntnBoss[c.pos],{kind:j[0],size:v.pJsnData.boss.type,type:"boss",pos:c.pos,adjustValues:e[0]}),null!==j[1]&&h.mHitEffect(l.timeline[c.pos],v.gAryCntnBoss[c.pos],{kind:j[1],size:v.pJsnData.boss.type,type:"boss",pos:c.pos,delay:Sa,adjustValues:e[1]})}if(N.concurrent_attack_flag===!0&&0===d||N.concurrent_attack_flag===!1&&(b.isUndefined(c.miss)||1!=c.miss&&4!=c.miss))var m=f.mChangeMotion(l.timeline[c.pos],{motion:"damage",pos:c.pos,type:"boss"});h.mDamageRattle(q.timeline[0]);var n=c.color||N.color||v.gGameStatus.player.param[N.pos].attr,o=u.createDamageComponent(c,"boss",U>1,n,N.concurrent_attack_flag===!0?d:void 0,0);if(l.timeline[c.pos].call(function(){o.show()}),b.isUndefined(c.wait)===!1?f.mWaitAll([k,l,q],{playtime:+c.wait}):N.concurrent_attack_flag===!0&&0===d&&f.mWaitAll([k,l,q],{playtime:3}),b.isUndefined(c.miss)||1!=c.miss&&4!=c.miss){var p=N.concurrent_attack_flag&&a.length==d+1;i.mBossGaugeHp(l.timeline[c.pos],kb,v.pJsnData.boss.type,{pos:c.pos,param:{hp:c.hp,hpmax:v.gGameStatus.boss.param[c.pos].hpmax,isConcurrentLastAttack:p}}),(N.concurrent_attack_flag===!0&&0===d||N.concurrent_attack_flag===!1)&&f.mChangeMotion(l.timeline[c.pos],{motion:v.gGameStatus.waitmode[c.pos],pos:c.pos,type:"boss",delay:m})}c.additional&&b.each(c.additional,function(a){a.message&&u.executeMessage([k,l,q],a.message),a.effect&&u.executeEffect([k,l,q],a.effect)})}),N.concurrent_attack_flag===!1&&T!==U-1&&f.mWaitAll([k,l,q],{playtime:4});var j;U>=2?(j=6,f.mWaitAll([k,l,q],{playtime:j})):(j=9,f.mWaitAll([k,l,q],{playtime:j})),T==U-1&&(S-=j)}T++}),C++,v.gGameStatus.player.attackMotionWait[N.pos]=S,v.gGameStatus.player.stbwaitAfterAttack2[N.pos]=N.standby,i.mDisplayStrip(q.timeline[0],{mode:"off",pos:N.pos})}else if("boss"==N.from){f.mWaitAll([k,l,q],{playtime:2}),0==E&&f.mWaitAll([k,l,q],{playtime:6}),q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,1),v.gMasterContainer.setChildIndex(v.gPlayerContainer,0)}),f.mWaitAll([k,l,q],{playtime:4});var T=0,U=b.size(N.damage),V=15,W=1;b.each(N.damage,function(a){T>0&&T==U-1&&q.timeline[0].call(function(){var a=D.replaceMessage(2==U?"raid_6":"raid_7",[v.gGameStatus.boss.param[N.pos].name[Game.lang]]),b={"class":"log-battle",title:D.getMessage("raid_8"),body:a};4>U&&i.mLog(b)}),l.timeline[N.pos].call(function(){p.setPlayingVoice(!1)});var c=null;("enemy_4100663"===v.gGameStatus.boss.param[N.pos].cjs||"enemy_4100753"===v.gGameStatus.boss.param[N.pos].cjs)&&(c=b.random(1));var d="attack";b.isNull(c)===!1&&l.timeline[N.pos].call(function(){window.attack_num=c});var e=f.mChangeMotion(l.timeline[N.pos],{motion:d,pos:N.pos,type:"boss",voice:N.voice?N.voice[T]:null,notUndoLinkMotion:T!==U-1}),g=e;if(U-1>+T&&g>V){var j=f._getMotionIrregular(v.gGameStatus.waitmode[N.pos],d,N.pos),m=window.ignoreSkipAttackFrame[v.gGameStatus.boss.param[N.pos].cjs]||{},o=m[j]||!1;o!==!0&&(g=V)}var r=v.gGameStatus.waitmode[N.pos];T===U-1&&l.timeline[N.pos].call(function(a,b){var c=createjs.denaVersion?createjs.Ticker.getInterval():v.gGameParam.spf;setTimeout(function(){1==v.gGameStatus.boss.param[a.pos].alive&&f.mChangeMotionInstantly({motion:r,pos:a.pos,type:"boss"})},b*c)},[N,g]);var s=!1,t=!1;b.isUndefined(v.gGameStatus.boss.param[N.pos].timing)||(s=v.gGameParam.timing[v.gGameStatus.boss.param[N.pos].timing.effect]||!1,t=v.gGameParam.timing[v.gGameStatus.boss.param[N.pos].timing.damage]||!1,s&&(f.mWaitAll([k,l,q],{playtime:s}),g-=s));var w=3;b.each(a,function(d,e){var j=N.concurrent_attack_flag,m=d.concurrent_attack_count,o=j===!1||0===m;b.isNull(c)===!1&&k.timeline[d.pos].call(function(){window.attack_num=c});var r=1===+v.gGameStatus.boss.param[N.pos].effect_all;r&&0!==e||o!==!0||h.mHitEffect(k.timeline[d.pos],v.gAryCntnAvatar[d.pos],{kind:v.gGameStatus.boss.param[N.pos].effect,type:"player",isAllAttackEffect:r}),t&&o===!0&&(t=0===e?t:w,f.mWaitAll([k,l,q],{playtime:t}),g-=t),h.mDamageRattle(q.timeline[0]);var s=u.createDamageComponent(d,"player",U>1,v.gGameStatus.boss.param[N.pos].attr,j===!0?m:void 0,0);if(k.timeline[d.pos].call(function(){s.show(),d.voice&&(n.isShellAppAndroid()?p.isPlayingVoice()||p.playVoice(d.voice):p.playVoice(d.voice,{alias:"voice"+d.pos}))}),(b.isUndefined(d.miss)||1!=d.miss&&4!=d.miss)&&(i.mPlayerGaugeHp(k.timeline[d.pos],{pos:d.pos,param:{hp:d.hp,hpmax:v.gGameStatus.player.param[d.pos].hpmax}}),o===!0)){var x=f.mChangeMotion(k.timeline[d.pos],{motion:"damage",pos:d.pos,type:"player"}),y=+v.pJsnData.player.param[v.pJsnData.formation[d.pos]].motion_conf===f.CHARA_MOTION_TYPE.KEEP_KNOCK_BACK;d.hp>0&&!y&&f.mResetMotion(k.timeline[d.pos],{delay:x,motion:v.gGameStatus.defaultmotion[v.pJsnData.formation[d.pos]],pos:d.pos,type:"player"})}!r&&a.length>e+1&&b.isUndefined(d.wait)===!1&&+d.wait>0&&j===!1&&(f.mWaitAll([k,l,q],{playtime:+d.wait}),g-=+d.wait)}),g>0&&f.mWaitAll([k,l,q],{playtime:g}),f.mWaitAll([k,l,q],{playtime:W}),T++}),Yb([k,l,q],{playtime:6}),E++}a.when(R).done(function(){P.resolve()});break;case"damage":case"loop_damage":var X=0;if(N.list.length<=0){v.gGameStatus.is_summon_simple&&q.timeline[0].call(function(){for(var a=0,b=v.gAryCntnAvatar.length-1;b>=a;a++)1==v.gGameStatus.player.param[a].alive&&(v.gAryCntnAvatar[a].visible=!0)}),P.resolve();break}if("player"===N.to&&(q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,1),v.gMasterContainer.setChildIndex(v.gPlayerContainer,0)}),b.each(N.list,function(a){if(N.effect){var c=h.mHitEffect(k.timeline[a.pos],v.gAryCntnAvatar[a.pos],{kind:N.effect,type:"player"}),d=b.isEmpty(N.wait)===!1||b.isNumber(N.wait)===!0?+N.wait:c;f.mWaitAll([k,l,q],{playtime:d})}h.mDamageRattle(q.timeline[0]);var e=u.createDamageComponent(a,"player",N.list.length>1,a.color||N.color,void 0,0);if(k.timeline[a.pos].call(function(){e.show()}),b.isUndefined(a.miss)||1!=a.miss&&4!=a.miss){var g=b.isUndefined(a.no_damage_motion)===!0||a.no_damage_motion===!1;k.timeline[a.pos].call(function(){i.mPlayerGaugeHpForLog({pos:a.pos,param:{hp:a.hp,hpmax:v.gGameStatus.player.param[a.pos].hpmax}})}),f.mWaitAll([k,l,q],{playtime:3}),g===!0&&(c=f.mChangeMotion(k.timeline[a.pos],{motion:"damage",pos:a.pos,type:"player"}));var j=+v.pJsnData.player.param[v.pJsnData.formation[a.pos]].motion_conf,m=!!N.is_attack,n=m&&j===f.CHARA_MOTION_TYPE.KEEP_KNOCK_BACK;a.hp>0&&!n&&g===!0&&f.mResetMotion(k.timeline[a.pos],{delay:c,motion:v.gGameStatus.defaultmotion[v.pJsnData.formation[a.pos]],pos:a.pos,type:"player"})}})),"boss"===N.to){q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,0),v.gMasterContainer.setChildIndex(v.gPlayerContainer,1)});var $=function(a,c,d,e){var g=0!==e,j=44,m=d===!0&&c>1?(c-1)*(j/2):0;b.each(a,function(a){if(N.effect&&(d===!1||g===!1)){var e=h.mHitEffect(l.timeline[a.pos],v.gAryCntnBoss[a.pos],{kind:N.effect,size:v.pJsnData.boss.type,type:"boss",pos:a.pos});f.mWaitAll([k,l,q],{playtime:"undefined"!=typeof N&&0!==+N.wait?+N.wait:e}),q.timeline[0].call(function(){b.isUndefined(v.gGameStatus.hide_ability_pos)||setTimeout(function(){v.gAryCntnAvatar[v.gGameStatus.hide_ability_pos].visible=!0},e*v.gGameParam.spf)}),d===!0&&(g=!0)}h.mDamageRattle(q.timeline[0]);var n=u.createDamageComponent(a,"boss",d===!1&&(c>1||N.is_rengeki),a.color||0===a.color?a.color:N.color,void 0,m);l.timeline[a.pos].call(function(){n.show()}),(b.isUndefined(a.miss)||1!=a.miss&&4!=a.miss)&&(i.mBossGaugeHp(l.timeline[a.pos],kb,v.pJsnData.boss.type,{pos:a.pos,param:{hp:a.hp,hpmax:v.gGameStatus.boss.param[a.pos].hpmax}}),f.mWaitAll([k,l,q],{playtime:3}),e=f.mChangeMotion(l.timeline[a.pos],{motion:"damage",pos:a.pos,type:"boss"}),a.hp>0&&f.mResetMotion(l.timeline[a.pos],{delay:e,motion:v.gGameStatus.waitmode[a.pos],pos:a.pos,type:"boss"})),d===!0&&(m-=j)})};if("loop_damage"===N.cmd){var _=0,aa=8,ba=[8,6,4][+v.pJsnData.boss.number-1]||4,ca=99;b.each(N.list,function(a,c){for(var d=b.values(b.groupBy(a,function(a,b){return Math.floor(b/ba)})),e=0,g=d.length;g>e;e++)$(d[e],d[e].length,!0,e),e!==g-1&&f.mWaitAll([k,l,q],{playtime:aa});_=c}),b.isEmpty(N.total)===!1&&b.each(N.total,function(a){if(+a.attr!==ca){var b=u.createTotalDamageComponent(a,a.attr,"l",a.count,!0);l.timeline[_].call(function(){b.show()})}})}else $(N.list,N.list.length,!1,0)}v.gGameStatus.is_summon_simple&&(f.mWaitAll([k,l,q],{playtime:10}),q.timeline[0].call(function(){for(var a=0,b=v.gAryCntnAvatar.length-1;b>=a;a++)1==v.gGameStatus.player.param[a].alive&&(v.gAryCntnAvatar[a].visible=!0)})),f.mWaitAll([k,l,q],{playtime:4}),P.resolve();break;case"effect":N.kind&&u.executeEffect([k,l,q],N),P.resolve();break;case"windoweffect":if(N.kind){var X=i.mWindowEffect(q.timeline[0],N);q.timeline[0].call(function(){if(!b.isUndefined(v.gGameStatus.hide_ability_pos)){var a=v.gGameStatus.hide_ability_pos;u.setNamedTimeout(I+a,function(){v.gAryCntnAvatar[a].visible=!0},X*v.gGameParam.spf)}}),void 0===N.wait?Yb([k,l,q],{playtime:X}):parseInt(N.wait)>0&&Yb([k,l,q],{playtime:parseInt(N.wait)}),q.timeline[0].call(function(){if(v.gGameStatus.hide_ability_all===!0)for(var a=0;a<v.gAryCntnAvatar.length;a++)1==v.gGameStatus.player.param[a].alive&&(v.gAryCntnAvatar[a].visible=!0)})}P.resolve();break;case"heal":var X=0;if("player"===N.to){"true"===N.cutin&&j.mPlayer(q.timeline[0],{text:D.getMessage("raid_9"),playtime:24,delay:0});var da=0;b.each(N.list,function(a){if(N.kind&&(X=h.mEffect(k.timeline[a.pos],v.gAryCntnAvatar[a.pos],N)),i.mPlayerGaugeHp(k.timeline[a.pos],{pos:a.pos,param:{hp:a.hp,hpmax:v.gGameStatus.player.param[a.pos].hpmax}}),"1"===a.motion_type){var c=b.isUndefined(a.no_damage_motion)===!0||a.no_damage_motion===!1;f.mWaitAll([k,l,q],{playtime:12}),c===!0&&(da=f.mChangeMotion(k.timeline[a.pos],{motion:"damage",pos:a.pos,type:"player",current_hp:a.hp}));var d=u.createDamageComponent(a,"player",N.list.length>1,0,void 0,0);k.timeline[a.pos].call(function(){setTimeout(function(){d.show()},v.gGameParam.spf)}),0<a.hp?c===!0&&f.mResetMotion(k.timeline[a.pos],{delay:da,motion:v.gGameStatus.defaultmotion[v.pJsnData.formation[a.pos]],pos:a.pos,type:"player"}):"ability"===v.gGameStatus.menu&&(u.CommandBackTop(),u.activateMask())}else{var e=u.createHealComponent(a.split,"player",a.pos);if(k.timeline[a.pos].call(function(){setTimeout(function(){e.show()},X*v.gGameParam.spf)}),1!==+a.no_motion){var g=a.motion_label?a.motion_label:v.gGameStatus.defaultmotion[v.pJsnData.formation[a.pos]];f.mChangeMotion(k.timeline[a.pos],{motion:g,pos:a.pos,type:"player",current_hp:a.hp})}}f.mWaitAll([k,l,q],{playtime:3})}),da>3&&f.mWaitAll([k,l,q],{playtime:da-3}),q.timeline[0].call(function(){if(b.isEmpty(N.voice)===!1&&p.playVoice(N.voice),K>-1)for(var a=K+1,c=v.gAryRootAvatar.length-1;c>=a;a++)M[a]===!0&&f.mChangeMotionInstantly({motion:"ability",pos:a,type:"player",is_alive:"on"})})}"boss"===N.to&&b.each(N.list,function(a){if(N.kind&&(b=h.mEffect(l.timeline[a.pos],v.gAryCntnBoss[a.pos],{kind:N.kind,delay:N.delay,pos:a.pos,to:N.to,list:N.list,cjs_param:N.cjs_param})),i.mBossGaugeHp(l.timeline[a.pos],kb,v.pJsnData.boss.type,{pos:a.pos,param:{hp:a.hp,hpmax:v.gGameStatus.boss.param[a.pos].hpmax}}),"1"===a.motion_type){f.mWaitAll([k,l,q],{playtime:12});var b=f.mChangeMotion(l.timeline[a.pos],{motion:"damage",pos:a.pos,type:"boss",current_hp:a.hp}),c=u.createDamageComponent(a,"boss",N.list.length>1,0,void 0,0);l.timeline[a.pos].call(function(){setTimeout(function(){c.show()},v.gGameParam.spf)}),0<a.hp&&f.mResetMotion(l.timeline[a.pos],{delay:b,motion:v.gGameStatus.waitmode[a.pos],pos:a.pos,type:"boss"})}else{var d=u.createHealComponent(a.split,"boss",a.pos);l.timeline[a.pos].call(function(){setTimeout(function(){d.show()},b*v.gGameParam.spf)})}f.mWaitAll([k,l,q],{playtime:3})}),P.resolve();break;case"hp":"player"===N.to?i.mPlayerGaugeHp(k.timeline[N.pos],{pos:N.pos,param:{hp:N.value,hpmax:N.max}}):"boss"===N.to&&i.mBossGaugeHp(l.timeline[N.pos],kb,v.pJsnData.boss.type,{pos:N.pos,param:{hp:N.value,hpmax:N.max}}),P.resolve();break;case"recast":if("player"===N.to){var ea=y[O+1];i.mPlayerGaugeRecast(k.timeline[N.pos],{pos:N.pos,param:{recast:N.value,split:N.split,recastmax:v.gGameStatus.player.param[N.pos].recastmax},alive:!(ea&&"die"===ea.cmd&&ea.pos==N.pos)})}else"boss"===N.to&&i.mBossGaugeRecast(l.timeline[N.pos],kb,v.pJsnData.boss.type,{pos:N.pos,param:{recast:N.value,split:N.split,recastmax:N.max}});P.resolve();break;case"lupi":var fa=b.isUndefined(N.delay)?26:N.delay,ia=u.createEnemyRewardComponent(N.value,"lupi",N.pos);l.timeline[N.pos].call(function(){setTimeout(function(){ia.show()},fa*v.gGameParam.spf)}),P.resolve();break;case"drop":h.mGetTreasure(l.timeline[N.pos],v.gAryCntnBoss[N.pos],N.get,!1,N.is_multiple),f.mWaitAll([k,l,q],{playtime:2}),v.gGameStatus.last_drop=N.pos,P.resolve();break;case"item":q.timeline[0].call(function(a){var b={"class":"log-ability",title:a.title,body:a.body};i.mLog(b)},[N]),h.mGetItem(l.timeline[N.pos],v.gAryCntnBoss[N.pos],N.get),f.mWaitAll([k,l,q],{playtime:2}),v.gGameStatus.last_drop=N.pos,P.resolve();break;case"contribution":var ja=1===+v.pJsnData.multi&&"normal_attack_result"===v.gGameStatus.attack_action?Math.ceil(.75*u.currentFps):0;i.mContribution(q.timeline[0],N,ja),v.gGameStatus.finishAfterContribution&&(v.gGameStatus.finish=!0,v.gGameStatus.finishAfterContribution=!1),P.resolve();break;case"sequence_point":q.timeline[0].call(function(){i.setQueueSequencePoint(function(){i.showSequencePoint({name:N.name,point:+N.point,color:N.color}),u.updateSequencePoint([{point:N.point,category:N.category,total:null}])})}),1==v.gGameStatus.finishAfterContribution&&v.gGameStatus.finish!==!0&&b.isUndefined(u.finishAfterSequencePointLength)===!1&&(u.finishAfterSequencePointLength>1?u.finishAfterSequencePointLength--:(v.gGameStatus.finish=!0,v.gGameStatus.finishAfterContribution=!1)),P.resolve();break;case"ability":b.isUndefined(A)||"on"!==N.motion||(v.gGameStatus.usingAbility=1,v.gGameStatus.useAbilityPos=+N.pos),q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,0),v.gMasterContainer.setChildIndex(v.gPlayerContainer,1)});var ka=null,la=null,ma=v.gGameStatus.player.param[N.pos];if("player"===N.to?(ka=k.timeline[N.pos],la=v.gAryCntnAvatar[N.pos]):"boss"===N.to&&(ka=l.timeline[N.pos],la=v.gAryCntnBoss[N.pos]),N.to&&(N.show_ability_name===!0||!b.isUndefined(A)||N.force_motion===!0||v.pJsnData.is_watching===!0)){if("on"===N.motion&&"player"===N.to){var na=N.motion_label&&(b.isUndefined(A)||"attack_2"===N.motion_label)?!0:!1,oa="l"===ma.type&&3040182e3===+ma.pid&&"ab_motion_3"===N.motion_label,pa=3040017e3===+ma.pid&&"ab_motion_2"===N.motion_label;if((N.ability_wait===!1||0===v.gGameStatus.player.attackMotionWait[N.pos])&&ka.call(function(a){a.voice&&p.playVoice(a.voice)},[N]),!N.comment||na&&!N.show_ability_name||Ca||q.timeline[0].call(function(a){if(3!==v.gGameStatus.abilityRailDisp){var b,c,d;2===v.gGameStatus.abilityRailDisp?(b="log-ability simple",c=D.getMessage("raid_87"),d=D.replaceMessage("raid_88",[a.name])):(b="log-ability",c=D.getMessage("raid_10"),d=D.replaceMessage("raid_73",[a.name,a.comment]));var e={"class":b,title:c,body:d};i.mLog(e)}},[N]),!N.name||na&&!N.show_ability_name||j.mPlayer(q.timeline[0],{text:N.name,playtime:24,delay:0}),"2"===N.ability_effect_type)q.timeline[0].call(function(a){u.clearTimeoutOne(I+a.pos),v.gAryCntnAvatar[a.pos].visible=!1,v.gGameStatus.hide_ability_pos=a.pos},[N]);else if("3"===N.ability_effect_type)q.timeline[0].call(function(){v.gGameStatus.hide_ability_all=!0;for(var a=0;a<v.gAryCntnAvatar.length;a++)1==v.gGameStatus.player.param[a].alive&&(v.gAryCntnAvatar[a].visible=!1)});else{var sa=N.motion_label?N.motion_label:"attack";1==v.pJsnData.battle.count&&1==v.gGameStatus.turn&&"stbwait"===sa&&(sa=v.gGameStatus.defaultmotion[v.pJsnData.formation[N.pos]]),N.ability_wait===!0&&v.gGameStatus.player.attackMotionWait[N.pos]>0&&(f.mWaitAll([k,l,q],{playtime:v.gGameStatus.player.attackMotionWait[N.pos]}),ka.call(function(a){a.voice&&p.playVoice(a.voice)},[N]));var X=f.mChangeMotion(k.timeline[N.pos],{motion:sa,pos:N.pos,type:"player"});"attack_2"===sa&&v.gGameStatus.player.stbwaitAfterAttack2[N.pos]===!0&&(f.mChangeMotion(k.timeline[N.pos],{delay:X,motion:"stbwait",pos:N.pos,type:"player"}),v.gGameStatus.player.stbwaitAfterAttack2[N.pos]=!1)}if(N.ability_effect_type||na&&!N.show_ability_name||"charge"==N.motion_label||oa!==!1||N.no_effect!==!1)"charge"==N.motion_label?f.mWaitAll([k,l,q],{playtime:X}):oa===!0&&(f.mWaitAll([k,l,q],{playtime:X}),f.mChangeMotion(k.timeline[N.pos],{motion:"stbwait",pos:N.pos,type:"player"}));else{h.mEffect(k.timeline[N.pos],v.gAryCntnAvatar[N.pos],{
kind:"ab_start"})}pa===!0&&f.mWaitAll([k,l,q],{playtime:X}),f.mWaitAll([k,l,q],{playtime:2})}else"on"===N.motion&&"boss"===N.to&&N.name&&N.show_ability_name&&j.mBoss(q.timeline[0],{text:N.name,playtime:24,delay:0});if(N.kind){var X=h.mAbility(ka,la,N);f.mWaitAll([k,l,q],{playtime:X+3})}}u.abilityEmphasis&&(u.$el.find(".prt-member").find(".btn-command-character").removeClass("is-emphasis"),u.naviEmphasis=null,u.abilityEmphasis=!1),a.when(R).done(function(){P.resolve()});break;case"show_ability_name":N.name&&j.mPlayer(q.timeline[0],{text:N.name,playtime:24,delay:0}),P.resolve();break;case"special":case"special_npc":case"super":case"friend":var ka=null,la=null,ta=u.$el.find(".prt-target"),ua="hideEnemyAtSpecial";"special"===N.cmd||"special_npc"===N.cmd?(ka=k.timeline[N.pos],la=v.gAryCntnAvatar[N.pos]):"super"===N.cmd&&(ka=l.timeline[N.pos],la=v.gAryCntnBoss[N.pos]),("special"===N.cmd||"special_npc"===N.cmd)&&(("npc_3840028007_01"===v.gGameStatus.player.param[N.pos].cjs||"nsp_3840028007_01_s2"===N.kind)&&(H=!0,N.skip_flag=!1,a("#canvas").off(ua).one(ua,function(){u.hideEnemyBeforeDie()})),i.mDisplayStrip(q.timeline[0],{mode:"on",pos:N.pos}),v.gGameStatus.player.param[N.pos].recast<=100&&(v.gGameStatus.player.param[N.pos].recast=100),i.mPlayerGaugeRecast(ka,{pos:N.pos,param:v.gGameStatus.player.param[N.pos]}),q.timeline[0].call(function(){K=N.pos})),"end"!==N.chain&&"mid"!==N.chain&&h.mBrightnessOut(ka,{duration:"0.3s",count:1}),q.timeline[0].call(function(){ta.css("display","none")}),ka.call(function(){p.setPlayingVoice(!1)}),v.gScenarioParam=N;var va=v.gScenarioParam.skip_flag,wa=new a.Deferred,za=[];if(N.name&&"end"!==N.chain&&"mid"!==N.chain)if("super"!==N.cmd){if(j.mPlayer(q.timeline[0],{text:N.name,playtime:24,delay:0,voice:N.voice}),va===!1){var Aa=1==v.gGameStatus.player.param[N.pos].leader?"leader":"npc",Ba=v.gGameStatus.player.param[N.pos].pid,Da=N.cutin_image;za.push({src:Game.imgUri+"/sp/assets/"+Aa+"/cutin_special/"+Da+".jpg",id:"cutin_"+Ba,type:"image"}),j.mSpecial(q.timeline[0],{pid:Ba}),f.mWaitAll([k,l,q],{playtime:12})}}else if(j.mBoss(q.timeline[0],{text:N.name,playtime:24,delay:0}),1==parseInt(v.gGameStatus.boss.param[N.pos].cutin_flag)){var Ea=v.gGameStatus.boss.param[N.pos].cjs.match(/enemy_(\d+)/);za.push({src:Game.imgUri+"/sp/assets/enemy/cutin_super/"+Ea[1]+".jpg",id:"cutin_"+Ea[1],type:"image"}),j.mSuper(q.timeline[0],{bid:Ea[1]}),f.mWaitAll([k,l,q],{playtime:20})}if(m.once("complete",function(){wa.resolve()}),m.loadManifest(za),q.timeline[0].call(function(){ta.show()}),"super"===N.cmd?q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,1),v.gMasterContainer.setChildIndex(v.gPlayerContainer,0)}):q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gSkipContainer,0),v.gMasterContainer.setChildIndex(v.gNspContainer,0),v.gMasterContainer.setChildIndex(v.gBossContainer,0),v.gMasterContainer.setChildIndex(v.gPlayerContainer,1)}),Yb([k,l,q],{playtime:10}),"1"==N.window_effect_mode||"2"==N.window_effect_mode){var Fa="enemy_8100973"===v.gGameStatus.boss.param[N.pos].cjs&&"esp_8100973_03"===N.kind;i.mSuperWindowEffectStart(q.timeline[0],kb),q.timeline[0].call(function(){b.each(v.gGameStatus.boss.param,function(a,b){v.gAryCntnBoss[b].visible&&N.pos!==b&&Fa!==!0&&(v.gAryCntnBoss[b].visible=!1,v.gAryCntnBoss[b].visibleAfterEffect=!0)})})}va===!0&&ka.call(function(){p.skipVoice()});var X=h.mSpecial(ka,N,{size:v.pJsnData.boss.type});Yb([k,l,q],{playtime:X}),va===!0&&ka.call(function(){p.unskipVoice()}),("1"==N.window_effect_mode||"2"==N.window_effect_mode)&&(i.mSuperWindowEffectEnd(q.timeline[0],kb),q.timeline[0].call(function(){b.each(v.gGameStatus.boss.param,function(a,b){!v.gAryCntnBoss[b].visible&&v.gAryCntnBoss[b].visibleAfterEffect&&N.pos!==b&&(v.gAryCntnBoss[b].visible=!0,delete v.gAryCntnBoss[b].visibleAfterEffect)})})),"super"===N.cmd&&f.mChangeMotion(l.timeline[N.pos],{motion:v.gGameStatus.waitmode[N.pos],pos:N.pos,type:"boss",isReplay:!0});var Ga=u.$el.find(".prt-special-chain"),Ha=Ga.find(".prt-chain"),Ia=Ga.find(".prt-over-chain"),Ja=Ha.children("div");N.count>=2&&"start"!==N.chain&&q.timeline[0].call(function(a){5>a?(Ha.show(),Ia.css("display","none"),Ja.removeClass().addClass("chain"+a)):(Ha.css("display","none"),Ia.show()),Ga.show().addClass("anim-chain").oneAnimationEnd(function(){Ga.removeClass("anim-chain")},400),setTimeout(function(){Ga.css("display","none")},1200)},[N.count,N.name]);var ca=99,Ka=("special"===N.cmd||"special_npc"===N.cmd)&&N.attr===ca&&va===!0;if("start"===N.chain||"mid"===N.chain||ca===N.attr&&!Ka||N.total&&N.total.length>=1&&(b.each(N.total,function(a){var c=u.createTotalDamageComponent(a,a.attr,N.total.size,a.count,!1);ka.call(function(){setTimeout(function(){if(c.show(),va===!0){var a=N.list[N.list.length-1].damage;b.each(a,function(a){+v.gGameStatus.boss.param[a.pos].hp!==+a.hp&&i.mBossGaugeHpForLog(v.gEnemyStatus,v.pJsnData.boss.type,{pos:a.pos,param:{hp:a.hp,hpmax:v.gGameStatus.boss.param[a.pos].hpmax}})})}},10*v.gGameParam.spf)}),f.mWaitAll([k,l,q],{playtime:3})}),Yb([k,l,q],{playtime:12})),"start"!==N.chain&&"mid"!==N.chain&&(h.mBrightnessIn(ka,{duration:"0.3s",count:1}),"undefined"!=typeof v.gGameStatus.player.param[N.pos]&&"1"!==v.gGameStatus.player.param[N.pos].formchange_type&&("special"===N.cmd||"special_npc"===N.cmd))){var sa="stbwait";N.return_motion_label&&(sa=N.return_motion_label,v.gGameStatus.player.param[N.pos].condition.special_motion=N.return_motion_label),f.mChangeMotion(k.timeline[N.pos],{motion:sa,pos:N.pos,type:"player"})}("special"===N.cmd||"special_npc"===N.cmd)&&i.mDisplayStrip(q.timeline[0],{mode:"off",pos:N.pos});var La="start"!==N.chain&&"mid"!==N.chain?12:3;if("super"!==N.cmd&&"undefined"!=typeof v.gGameStatus.player.param[N.pos]&&"1"!==v.gGameStatus.player.param[N.pos].formchange_type)Yb([k,l,q],{playtime:La});else if("super"===N.cmd){if(N.is_activate_counter_damaged){var Na=3,Oa=!1,Pa=0;b.each(N.list,function(a){b.each(a.damage,function(a,b){if(Oa=Oa||1!=a.miss&&4!=a.miss){var c=v.gGameStatus.player.param[a.pos].cjs,d=v.gAryRootAvatar[a.pos][c],e=d[c+"_damage"].timeline.duration,f=b*Na,g=e+f;Pa=g>Pa?g:Pa}})}),Oa&&(La=La>Pa?La:Pa)}Yb([k,l,q],{playtime:La})}a.when(R,wa).done(function(){P.resolve()});break;case"special_change":q.timeline[0].call(function(){v.gGameStatus.player.param[N.pos].special_skill=N.name,v.gGameStatus.player.param[N.pos].special_comment=N.text,v.pJsnData.player.param[v.pJsnData.formation[N.pos]].special_skill=N.name,v.pJsnData.player.param[v.pJsnData.formation[N.pos]].special_comment=N.text}),P.resolve();break;case"chain_cutin":for(var Ua=[],Wa=0,Xa=N.images.length;Xa>Wa;Wa++)Ua.push({src:Game.imgUri+N.images[Wa],id:"raid_chain_dummy_img_0"+(Wa+1),type:"image"});m.once("complete",function(){var a=h.mChainCutin(q.timeline[0],N);f.mWaitAll([k,l,q],{playtime:a}),P.resolve()}),m.loadManifest(Ua);break;case"summon_cutin":var Ua=[{src:Game.imgUri+"/sp/assets/summon/cutin/"+N.image1,id:Ma[0],type:"image"},{src:Game.imgUri+"/sp/assets/summon/cutin/"+N.image2,id:Ma[1],type:"image"}];m.once("complete",function(){i.mSummonStart(q.timeline[0],kb),h.mSummonCutin(q.timeline[0],N),f.mWaitAll([k,l,q],{playtime:12}),q.timeline[0].call(function(){for(var a=0,b=v.gAryCntnAvatar.length-1;b>=a;a++)1==v.gGameStatus.player.param[a].alive&&(v.gAryCntnAvatar[a].visible=!1)}),f.mWaitAll([k,l,q],{playtime:18}),P.resolve()}),m.loadManifest(Ua);break;case"summon_simple":var Ya=v.gAryCntnAvatar.length-1;i.mSummonStart(q.timeline[0],kb),q.timeline[0].call(function(){for(var a=0;Ya>=a;a++)1==v.gGameStatus.player.param[a].alive&&(v.gAryCntnAvatar[a].visible=!1);if(3!=v.gGameStatus.summon_speed){var b=u.$el.find(".prt-party, .prt-summon-list");b.hasClass("fusion")||u.hideRaidInformation(),b.addClass("btn-show-info"),"off"===N.change&&b.addClass("fusion")}}),q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,0),v.gMasterContainer.setChildIndex(v.gPlayerContainer,1)});for(var Za=0;Ya>=Za;Za++)f.mMoveTo(v.gAryCntnAvatar,k,{index:Za,x:v.gGameParam.relative.summon_simple.x,playtime:0},{tween:[l,q],adjust:0});f.mMoveTo(v.gAryCntnAvatar,k,{index:0,y:v.gGameParam.relative.summon_simple.y,playtime:0},{tween:[l,q],adjust:0}),q.timeline[0].call(function(){1==v.gGameStatus.player.param[0].alive&&(v.gAryCntnAvatar[0].visible=!0)});var $a=v.gAryRootAvatar[0],bb=v.gGameStatus.player.param[0].cjs;k.timeline[0].call(function(a){var b=new lib[a.kind];v.gAryCntnAvatar[0].removeChild(v.gAryRootAvatar[0]),v.gAryRootAvatar[0]=b,v.gAryCntnAvatar[0].addChild(b),v.gGameStatus.player.param[0].cjs=a.kind},[N]),h.mBrightnessOut(k.timeline[0],{duration:"0.3s",count:1}),N.name&&j.mSummon(q.timeline[0],{text:N.name,playtime:24,delay:0}),f.mWaitAll([k,l,q],{playtime:5}),f.mChangeMotion(k.timeline[0],{motion:"chara_in",pos:0,type:"player"}),f.mMoveTo(v.gAryCntnAvatar,k,{index:0,x:-v.gGameParam.relative.summon_simple.x,playtime:4,ease:"quintOut"},{tween:[l,q],adjust:0}),f.mChangeMotion(k.timeline[0],{motion:"attack",pos:0,type:"player"},{tween:[k,l,q]}),f.mChangeMotion(k.timeline[0],{motion:"chara_out",pos:0,type:"player"},{tween:[k,l,q]}),f.mMoveTo(v.gAryCntnAvatar,k,{index:0,x:v.gGameParam.relative.summon_simple.x,playtime:0,ease:"quintOut"},{tween:[l,q],adjust:0}),q.timeline[0].call(function(){1==v.gGameStatus.player.param[0].alive&&(v.gAryCntnAvatar[0].visible=!1)}),h.mBrightnessIn(k.timeline[0],{duration:"0.3s",count:1}),"on"===N.change&&(v.gGameStatus.is_summon_simple=1),k.timeline[0].call(function(a){v.gAryCntnAvatar[0].removeChild(v.gAryRootAvatar[0]),v.gAryRootAvatar[0]=$a,v.gAryCntnAvatar[0].addChild($a),v.gGameStatus.player.param[0].cjs=bb},[N]);for(var Za=0;Ya>=Za;Za++)f.mSetTo(v.gAryCntnAvatar,k,{index:Za,x:v.gGameParam.grid.player[Za].x,y:v.gGameParam.grid.player[Za].y});f.mWaitAll([k,l,q],{playtime:7}),"on"===N.change&&3!=v.gGameStatus.summon_speed&&q.timeline[0].call(function(){var a=u.$el.find(".prt-party, .prt-summon-list");u.showRaidInformation(u.isFullAutoAttacking()),a.hasClass("btn-show-info")&&a.removeClass("btn-show-info"),a.hasClass("fusion")&&a.removeClass("fusion")}),i.mSummonEnd(q.timeline[0],kb),P.resolve();break;case"summon":if(!b.isUndefined(v.gGameStatus.summon_speed)&&3==v.gGameStatus.summon_speed&&N.kind.match(/_attack$/)){N.name&&j.mSummon(q.timeline[0],{text:N.name,playtime:24,delay:0}),P.resolve();break}i.mSummonStart(q.timeline[0],kb),q.timeline[0].call(function(){if(b.some(v.gGameStatus.player.param,function(a,b){1==a.alive&&(v.gAryCntnAvatar[b].visible=!1)}),N.name&&3!=v.gGameStatus.summon_speed){var a=u.$el.find(".prt-party, .prt-summon-list");a.hasClass("fusion")||u.hideRaidInformation(),a.addClass("btn-show-info"),"off"===N.change&&a.addClass("fusion")}}),N.name&&j.mSummon(q.timeline[0],{text:N.name,playtime:24,delay:0});var X=h.mSummon([k,l,q],N,{size:v.pJsnData.boss.type,speed:v.gGameStatus.summon_speed});Yb([k,l,q],{playtime:X}),"on"===N.change&&q.timeline[0].call(function(){if(b.some(v.gGameStatus.player.param,function(a,b){1==a.alive&&(v.gAryCntnAvatar[b].visible=!0)}),3!=v.gGameStatus.summon_speed){var a=u.$el.find(".prt-party, .prt-summon-list");u.showRaidInformation(u.isFullAutoAttacking()),a.hasClass("btn-show-info")&&a.removeClass("btn-show-info"),a.hasClass("fusion")&&a.removeClass("fusion")}}),i.mSummonEnd(q.timeline[0],kb),P.resolve();break;case"condition":q.timeline[0].call(function(a){if(a.pos=parseInt(a.pos),"player"===a.to)v.gGameStatus.player.param[a.pos].condition=a.condition,i.mConditionPlayer(a.condition,a.pos),"ability"===v.gGameStatus.menu&&i.mSetIntervalPlayerConditions(Number(v.gGameStatus.command_slide.now_pos)+1);else if("boss"===a.to)b.isEmpty(a.condition.debuff)===!1&&(a.condition.debuff=u._removePersonalCondition(a.condition.debuff,"debuff",!1)),b.isEmpty(a.condition.buff)===!1&&(a.condition.buff=u._removePersonalCondition(a.condition.buff,"buff",!1)),kb[a.pos].condition.setCondition(a.condition,v.gGameStatus.bossmode.looks.mode[a.pos]),i.mConditionBoss(kb);else if("field_effect"!==a.to||v.gGameStatus.finish){if("effect_unit"===a.to&&v.pJsnData.is_defendorder&&!v.gGameStatus.finish){var c=a.condition||[];b.isEmpty(c)||i.mConditionAssistUnit(c)}}else{v.gGameStatus.isPlayingScenariosImmediately||(v.gGameStatus.field.tmpPersonalField=[]);var d=a.condition;b.isEmpty(d)||(u.setTmpPersonalField(d),i.mConditionField(d))}},[N]),P.resolve();break;case"boss_gauge":var db=N,Wa=db.pos;l.timeline[Wa].call(function(){var a=v.gGameStatus.boss.param[Wa];b.each(db,function(b,c){void 0!==b&&(a[c]=b)})}),i.mBossGaugeHp(l.timeline[Wa],kb,v.pJsnData.boss.type,{pos:Wa,param:v.gGameStatus.boss.param[Wa]}),i.mBossGaugeRecast(l.timeline[Wa],kb,v.pJsnData.boss.type,{pos:Wa,param:v.gGameStatus.boss.param[Wa]}),i.mBossGaugeName(l.timeline[Wa],v.pJsnData.boss.type,{pos:Wa,param:v.gGameStatus.boss.param[Wa]}),P.resolve();break;case"modechange":if(B||1==N.ability_or_summon||9===N.mode){if(N.ability_or_summon===!0){var gb=u.getIsLinkedDamageMotion();gb&&f.mWaitAll([k,l,q],{playtime:2})}q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,1),v.gMasterContainer.setChildIndex(v.gPlayerContainer,0)}),Yb([k,l,q],{playtime:8}),N.mode=Number(N.mode),v.gGameStatus.bossmode.already_changed[N.pos]&&v.gGameStatus.bossmode.looks.mode[N.pos]==N.mode||(1!=N.additional||v.gGameStatus.bossmode.looks.mode[N.pos]!=N.mode)&&u.executeModeChange(N.mode,[k,l,q],N.special_gauge,N.ability_or_summon,N.log_type,N.pos,N.synchronize_pos||null,N.voice,N.no_motion);var hb=9===N.mode?1:N.mode;v.gGameStatus.bossmode.looks.mode[N.pos]=hb,v.gGameStatus.bossmode.looks.gauge[N.pos]=N.gauge}b.isUndefined(N.gauge)||1!==v.pJsnData.boss.param[N.pos].modeflag||i.mBreakGauge(q.timeline[0],kb[N.pos],{pos:N.pos,gauge:N.gauge}),P.resolve();break;case"formchange":var ib=u.$el.find(".btn-attack-start");u.$el.find(".cnt-raid-chat").find(".btn-chat");if("player"===N.to){var jb=N.param.cjs;k.timeline[N.pos].call(function(){v.gGameStatus.motion_lock=!0});var lb=function(){v.clone=a.extend(!0,v.gAryRootAvatar[N.pos],{});var b=new lib[jb];v.gAryCntnAvatar[N.pos].addChild(b),v.gAryRootAvatar[N.pos]=b},mb=function(){v.gAryCntnAvatar[N.pos].removeChild(v.clone),v.clone=null},nb=function(){b.isEmpty(v.gGameStatus.replacehit[N.pos])===!1&&(v.gGameStatus.replacehit[N.pos]="");var a=v.pJsnData.formation[N.pos];b.each(N.param,function(b,c){v.gGameStatus.player.param[N.pos][c]=b,v.pJsnData.player.param[a][c]=b}),v.gGameStatus.player.param[N.pos].form=N.form,v.pJsnData.player.param[a].form=N.form};if(N.no_motion)1===+N.no_motion&&N.is_large_dead===!0&&k.timeline[N.pos].call(function(){L=function(){nb(),lb(),mb()}});else{var ob=N.current_form?N.current_form.label:"change_1",pb=N.next_form?N.next_form.label:"change_2";N.no_change_motion||k.timeline[N.pos].call(function(){f.mChangeMotionInstantly({motion:ob,pos:N.pos,type:"player",is_alive:"on"})});var qb=function(a,b,c){var d,e="_"+c;if(-1!==e.indexOf("_change_2")){var f=new lib[jb];return d=+f[jb][jb+e].timeline.duration}var g=v.gGameStatus.player.param[b].cjs,h=g+e;return d=v.gAryRootAvatar[b][g]&&v.gAryRootAvatar[b][g][h]?v.gAryRootAvatar[b][g][h].timeline.duration:v.gGameStatus.form_change_frame[a][e]},rb=qb(N.param.name,N.pos,ob);Yb([k,l,q],{playtime:rb}),k.timeline[N.pos].call(function(){nb()}),k.timeline[N.pos].call(function(){var a=u._getLsizePlayerPos(),b=null===v.gGameStatus.player.posSizeL&&null!==a&&a===+N.pos,c=null!==v.gGameStatus.player.posSizeL&&null===a;if(b===!0&&(i.visiblePlayerDisplay(a),"ability"===v.gGameStatus.menu&&u.CommandBackTop()),lb(),b===!0){for(var d=0,e=v.gAryRootAvatar.length;e>d;d+=1)d!==a&&f.mChangeMotionInstantly({motion:v.gGameStatus.defaultmotion[v.pJsnData.formation[d]],pos:d,type:"player",delay:0,is_alive:"on"});i.setLsizePlayerDisplay(a),v.gGameStatus.attackQueue.charaChangeFlag=!0}else c===!0&&i.resetLsizePlayerDisplay()}),N.no_change_motion||k.timeline[N.pos].call(function(){f.mChangeMotionInstantly({motion:pb,pos:N.pos,type:"player",delay:0,is_alive:"on"})}),f.mWaitAll([k,l,q],{playtime:1}),k.timeline[N.pos].call(function(){mb()});var sb=qb(N.param.name,N.pos,pb);Yb([k,l,q],{playtime:sb})}k.timeline[N.pos].call(function(){v.gGameStatus.motion_lock=!1}),k.timeline[N.pos].call(function(){v.pJsnData.player.param[v.pJsnData.formation[N.pos]].cjs=N.param.cjs;var a=u.$el.find(".prt-command"),b=a.find(".lis-character"+N.pos);v.pJsnData.player.param[v.pJsnData.formation[N.pos]].alive&&(1==v.gGameStatus.player.param[N.pos].leader?b.children("img").attr("src",Game.imgUri+"/sp/assets/leader/raid_normal/"+v.gGameStatus.player.param[N.pos].pid_image+".jpg"):b.children("img").attr("src",Game.imgUri+"/sp/assets/npc/raid_normal/"+v.gGameStatus.player.param[N.pos].pid_image+".jpg")),1===N.type&&f.mChangeMotionInstantly({motion:"stbwait",pos:N.pos,type:"player",delay:0,is_alive:"on"})})}else if("boss"===N.to&&v.gGameStatus.boss.param[N.pos].form!=N.form&&v.gGameStatus.boss.form_change_command===!1){q.timeline[0].call(function(){v.gGameStatus.boss.form_change_command=!0,u.setStageTouchable(!1)});var tb=b.isEmpty(N.synchronize_pos)===!1?N.synchronize_pos:null;if("1"==N.fullscreen&&(i.mSuperWindowEffectStart(q.timeline[0],kb),q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,1),v.gMasterContainer.setChildIndex(v.gPlayerContainer,0),v.pJsnData.ability_rail_use===Qa.OFF&&u.$el.find(".watching-mask").css("display","block"),u.hideMask(),u.$el.find(".pop-usual").css("display","none"),a("#pop-chat .pop-usual").css("display","none"),a("#pop-scroll").empty().css("display","none"),a("#pop").empty(),v.gAryRootParts[0][v.gGameParam.cjs.parts[0]].gotoAndPlay("out"),b.each(v.gGameStatus.boss.param,function(a,b){v.gAryCntnBoss[b].visible&&N.pos!==b&&(v.gAryCntnBoss[b].visible=!1,v.gAryCntnBoss[b].visibleAfterEffect=!0)}),"enemy_4100643"!==N.param.cjs&&b.each(v.gGameStatus.player.param,function(a,b){1==a.alive&&(v.gAryCntnAvatar[b].visible=!1)}),u.showSmallChatIcon()})),v.gGameStatus.boss.form_change_tween===!1){v.gGameStatus.boss.form_change_tween=!0,Yb([k,l,q],{playtime:12}),f.mChangeMotion(l.timeline[N.pos],{motion:"form_change",pos:N.pos,type:"boss",synchronizePos:tb,voice:N.voice,notUndoLinkMotion:!0},{tween:[k,l,q]});var jb=N.param.cjs,ub=new lib[jb],vb=+ub[jb][jb+"_setin_4"].timeline.duration;l.timeline[N.pos].call(function(){b.each(N.param,function(a,b){"effect"!=b&&(v.gGameStatus.boss.param[N.pos][b]=a)}),v.gGameStatus.boss.param[N.pos].runaway_motion_flg=N.runaway_motion_flg,v.gGameStatus.boss.param[N.pos].fatigue_motion_flg=N.fatigue_motion_flg,v.gGameStatus.boss.param[N.pos].motion_link_list=N.motion_link_list||null}),v.gGameStatus.boss.param[N.pos].form=N.form,b.isUndefined(N.param.effect)===!1&&(v.gGameStatus.boss.param[N.pos].effect=N.param.effect),v.gGameStatus.boss.param[N.pos].effect_all=N.effect_all;var wb=v.gAryRootBoss[N.pos],xb=v.pJsnData.boss.param[N.pos].enemy_id;1!=N.form&&(xb=xb+"_"+N.form),kb[N.pos].changeThumbnail(xb);var yb={x:ub.x,y:ub.y};ub.x=-2e3,ub.y=-2e3,ub.visible=!1,v.addChild(ub),l.timeline[N.pos].call(function(){v.removeChild(ub),ub.x=yb.x,ub.y=yb.y,ub.visible=!0;var a=ub;v.gAryRootBoss[N.pos]=a,v.gAryCntnBoss[N.pos].addChild(a),f.mChangeMotionInstantly({motion:"setin_4",pos:N.pos,type:"boss",synchronizePos:tb});var c=v.pJsnData.boss.param[N.pos].enemy_id;1!=N.form&&(c=c+"_"+N.form),kb[N.pos].changeThumbnail(c);u.$el.find(".prt-bg-stage-distant");1!=N.form&&v.gGameStatus.isBackImageUpdated===!0&&0===b.size(v.gGameStatus.field.tmpPersonalField)&&(u.replaceBG(N.bg_image),v.update()),"1"==N.fullscreen&&(i.mSuperWindowEffectEnd(createjs.Tween.get({}),kb),v.gGameStatus.attackQueue.attackButtonPushed||(v.gAryRootParts[0][v.gGameParam.cjs.parts[0]].gotoAndPlay("in"),ib.hasClass("display-on")===!1&&u._controlDomAttackButton(!0)),b.each(v.gGameStatus.boss.param,function(a,b){!v.gAryCntnBoss[b].visible&&v.gAryCntnBoss[b].visibleAfterEffect&&N.pos!==b&&(v.gAryCntnBoss[b].visible=!0,delete v.gAryCntnBoss[b].visibleAfterEffect)}),b.each(v.gGameStatus.player.param,function(a,b){1==a.alive&&(v.gAryCntnAvatar[b].visible=!0)}),(v.gGameStatus.attackQueue.attackButtonPushed===!1||0===+v.pJsnData.mini_chat_stamp)&&u.showChatIcon(),u.$el.find(".watching-mask").css("display","none"))}),f.mWaitAll([k,l,q],{playtime:3}),l.timeline[N.pos].call(function(){v.gAryCntnBoss[N.pos].removeChild(wb),v.gGameStatus.boss.form_change_tween=!1}),Yb([k,l,q],{playtime:vb});var zb=10;q.timeline[0].call(function(){f.mChangeMotionInstantly({motion:v.gGameStatus.waitmode[N.pos],pos:N.pos,type:"boss",synchronizePos:tb})}),Yb([k,l,q],{playtime:zb})}q.timeline[0].call(function(){v.gGameStatus.boss.form_change_command=!1,u.setStageTouchable(!0)})}P.resolve();break;case"tmpdie":if("boss"==N.to){i.mBossGaugeHp(l.timeline[N.pos],kb,v.pJsnData.boss.type,{pos:N.pos,param:{hp:0,hpmax:v.gGameStatus.boss.param[N.pos].hpmax}});var Ab=N.play_cjs_label;f.mChangeMotion(l.timeline[N.pos],{motion:Ab,pos:N.pos,type:"boss",delay:10},{tween:[k,l,q]}),f.mChangeMotion(l.timeline[N.pos],{motion:"setin",pos:N.pos,type:"boss",delay:10},{tween:[k,l,q]}),i.mBossGaugeHp(l.timeline[N.pos],kb,v.pJsnData.boss.type,{pos:N.pos,param:{hp:v.gGameStatus.boss.param[N.pos].hpmax,hpmax:v.gGameStatus.boss.param[N.pos].hpmax}}),f.mWaitAll([k,l,q],{playtime:8})}P.resolve();break;case"die":case"stop":if("player"===N.to){v.gGameStatus.attackQueue.charaChangeFlag=!0,v.gGameStatus.player.isPlayingDeadMotion[N.pos]=!0;var Bb=N.voice?u._stopDamageVoice:null;Yb([k,l,q],{playtime:15}),f.mChangeMotion(k.timeline[N.pos],{motion:"dead",pos:N.pos,type:"player",voice:N.voice,se:"se/chara_dead_se_1.mp3",stopVoiceFunc:Bb},{tween:[k,l,q]}),k.timeline[N.pos].call(function(a){null!==v.gGameStatus.player.posSizeL&&u._getLsizePlayerPos()===+N.pos&&(L(),i.resetLsizePlayerDisplay())}),k.timeline[N.pos].call(function(a){v.gGameStatus.player.param[a].alive=0,v.pJsnData.player.param[v.pJsnData.formation[a]].alive=0,v.pJsnData.player.param[v.pJsnData.formation[a]].hp=0,v.gGameStatus.player.isPlayingDeadMotion[N.pos]=!1,u.$el.find(".prt-command").find(".lis-character"+a).children("img").attr("src",qa),i.mConditionPlayer({buff:null,debuff:null,coating_value:0},a),i.mSetAbility({list:{}},a),u.$el.find(".prt-command-top").find(".lis-character"+a).addClass("blank"),"ability"===v.gGameStatus.menu&&(u.popHideAbility(),u.CommandBackTop()),i.mUnsetSpecialSkip(a)},[N.pos])}else if("boss"==N.to){l.timeline[N.pos].call(function(a){v.gGameStatus.boss.param[a].alive=0,v.pJsnData.boss.param[a].alive=0,N.is_hp_keep||(v.pJsnData.boss.param[a].hp=0)},[N.pos]),l.timeline[N.pos].call(function(a){v.gGameStatus.boss.all_dead=!0;for(var b=0;b<v.pJsnData.boss.param.length;b++)if(0!=v.pJsnData.boss.param[b].alive){v.gGameStatus.boss.all_dead=!1;break}v.gGameStatus.boss.all_dead===!0&&(u.$el.find(".prt-navi").hasClass("active")&&u.setNamedTimeout("prtNaviDisplayNoneTimeout",function(){u.$el.find(".prt-navi").removeClass("active display-on")},1),u.$el.find(".btn-attack-start").hasClass("display-off")===!0&&u.showSmallChatIcon())}),N.kill_voice&&null!=N.kill_voice.id&&N.kill_voice.path&&(b.has(J,N.kill_voice.id)||(J[N.kill_voice.id]=!0,l.timeline[N.pos].call(function(){p.playVoice(N.kill_voice.path)}))),N.is_hp_keep||i.mBossGaugeHp(l.timeline[N.pos],kb,v.pJsnData.boss.type,{pos:N.pos,param:{hp:0,hpmax:v.gGameStatus.boss.param[N.pos].hpmax}});var Ab=N.play_cjs_label||("stop"===N.cmd?"down":"dead"),Gb=[];"dead"===Ab&&q.timeline[0].call(function(){v.gMasterContainer.setChildIndex(v.gBossContainer,1),v.gMasterContainer.setChildIndex(v.gPlayerContainer,0)}),v.gGameStatus.isVersusView&&f.mWaitAll([k,l,q],{playtime:6});var Hb=function(a){var b=a+1;u.$el.find(".btn-enemy-gauge[target="+b+"]").addClass("btn-silent-se disable"),u.$el.find(".prt-stage-area").find(".btn-targeting[data-target="+b+"]").css("display","none").removeClass("lock-on").addClass("btn-silent-se disable"),b===+v.gGameStatus.target&&(v.gGameStatus.target=0,kb[a].unmarkTarget())};v.gGameStatus.key_enemy_dead===!1&&N.chain?(l.timeline[N.pos].call(function(){b.each(v.pJsnData.boss.param,function(a,b){N.pos!==b&&(v.gGameStatus.boss.param[b].alive=0,v.pJsnData.boss.param[b].alive=0,v.pJsnData.boss.param[b].hp=0,Hb(b),f.mChangeMotionInstantly({motion:Ab,pos:b,type:"boss",delay:10}),Gb.push(b))})}),N.die_type&&"dead"===Ab||(l.timeline[N.pos].call(function(){Hb(N.pos)}),f.mChangeMotion(l.timeline[N.pos],{motion:Ab,pos:N.pos,type:"boss",delay:10},{tween:[k,l,q]})),v.gGameStatus.key_enemy_dead=!0):v.gGameStatus.key_enemy_dead||N.die_type&&"dead"===Ab||H!==!1||(l.timeline[N.pos].call(function(){Hb(N.pos)}),f.mChangeMotion(l.timeline[N.pos],{motion:Ab,pos:N.pos,type:"boss",delay:10,voice:N.voice},{tween:[k,l,q]})),l.timeline[N.pos].call(function(b){v.gGameStatus.boss.all_dead===!0&&(u.ResetAllAttackQueue(),u.activateMask(),u.$el.find(".pop-usual").css("display","none"),a("#pop-chat").find(".pop-usual").css("display","none"),u.hideMask())});var Jb=!1;if(!b.isUndefined(N.rp)&&""!=N.rp){Jb=!0;var Kb=u.createEnemyRewardComponent(N.rp,"rp",N.pos);l.timeline[N.pos].call(function(){Kb.show()})}if(!b.isUndefined(N.exp)&&""!=N.exp){var fa=Jb?200:0,Lb=u.createEnemyRewardComponent(N.exp,"exp",N.pos);l.timeline[N.pos].call(function(){setTimeout(function(){Lb.show()},fa)})}Yb([k,l,q],{playtime:10}),"dead"!==Ab||1===+v.pJsnData.boss.param[N.pos].visible_after_dead||v.pJsnData.is_arcade&&(!v.pJsnData.is_arcade||v.pJsnData.arcade.is_bonus)||l.timeline[N.pos].call(function(a){v.gAryRootBoss[N.pos].visible=!1,b.each(Gb,function(a){v.gAryRootBoss[a].visible=!1}),b.contains(ya,+v.pJsnData.quest_id)===!0&&u.trigger("showHideCharacter")},[N.pos]);var Mb=u.$el.find(".prt-enemy-gauge");l.timeline[N.pos].call(function(){Mb.find(".lis-enemy").eq(N.pos).css("display","none");var a=kb[N.pos];a.isAlive=!1,a.hide(),v.removeChild(a),u.$el.find(".btn-enemy-gauge.prt-enemy-percent[target="+(N.pos+1)+"]").removeClass("alive").css("display","none"),u.$el.find(".prt-enemy-area").find(".btn-targeting").eq(N.pos).addClass("disable")}),v.gGameStatus.boss.last_die=N.pos,l.timeline[N.pos].call(function(a){Mb.find(".prt-pointer").eq(a).removeClass("lock-on")},[N.pos])}if(N.is_show_popup){var Ob=u.popInfoMessage({title:N.die_information_title,message:N.die_information_body});Ob.on("onOk",function(){Ob.popRemove(),P.resolve()})}else P.resolve();break;case"die_back":var Pb=N.index;G.push(+Pb),q.timeline[0].call(function(){v.pJsnData.player.param[Pb].hp=0,v.pJsnData.player.param[Pb].alive=0,u.trigger("completeDieBack"+Pb)}),P.resolve();break;case"resurrection":if("boss"==N.to)f.mChangeMotion(l.timeline[N.pos],{motion:N.motion,pos:N.pos,type:"boss",delay:10},{tween:[k,l,q]}),l.timeline[N.pos].call(function(a){v.gGameStatus.boss.param[a].alive=1,v.pJsnData.boss.param[a].alive=1,v.pJsnData.boss.param[a].hp=v.gGameStatus.boss.param[a].hpmax,v.gAryRootBoss[a].visible=!0,u.$el.find(".btn-enemy-gauge.prt-enemy-percent[target="+(a+1)+"]").addClass("alive"),u.$el.find(".btn-enemy-gauge[target="+(a+1)+"]").css("display","block").removeClass("btn-silent-se disable"),u.$el.find(".prt-stage-area").find(".btn-targeting[data-target="+(a+1)+"]").css("display","block");var b=kb[a];b.isAlive=!0,b.initialize(b.spriteSheet,v.pJsnData.boss.param[a],a,v.pJsnData.disp_hp_percent_disp);var c=u.$el.find(".prt-targeting-area").attr("type");b.x=Ib[v.pJsnData.boss.param[a].type][c][a].x,b.y=Ib[v.pJsnData.boss.param[a].type][c][a].y,v.addChild(b),b.show()},[N.pos]),i.mBossGaugeHp(l.timeline[N.pos],kb,v.pJsnData.boss.type,{pos:N.pos,param:{hp:v.gGameStatus.boss.param[N.pos].hpmax,hpmax:v.gGameStatus.boss.param[N.pos].hpmax}}),f.mWaitAll([k,l,q],{playtime:8});else{var Qb=N.pos,Pb=N.index,Rb=b.isUndefined(N.resurrection_type)===!1&&1===+N.resurrection_type;if(N.cjs&&(k.timeline[N.pos].call(function(){v.clone=a.extend(!0,v.gAryRootAvatar[N.pos],{});var b=new lib[N.cjs];v.gAryCntnAvatar[N.pos].addChild(b),v.gAryRootAvatar[N.pos]=b,v.gGameStatus.player.param[Qb].cjs=N.cjs}),k.timeline[N.pos].call(function(){v.gAryCntnAvatar[N.pos].removeChild(v.clone),v.clone=null})),Rb===!0)var Sb=1;else{if(h.mBrightnessOut(k.timeline[0],{duration:"0.3s",count:1}),f.mWaitAll([k,l,q],{playtime:12}),j.mPlayer(q.timeline[0],{text:N.name,playtime:24,delay:0}),b.isUndefined(N.no_motion)||!N.no_motion)var X=f.mChangeMotion(k.timeline[N.performer],{motion:"attack",pos:N.performer,type:"player"});if(i.mWindowEffect(q.timeline[0],{kind:N.kind}),b.isUndefined(N.no_motion)||!N.no_motion){f.mWaitAll([k,l,q],{playtime:X});var X=f.mChangeMotion(k.timeline[N.performer],{motion:"stbwait",pos:N.performer,type:"player"})}var Sb=b.isUndefined(N.no_motion)||!N.no_motion?24:36}f.mWaitAll([k,l,q],{playtime:Sb}),""!==Qb&&f.mChangeMotion(q.timeline[0],{motion:v.gGameStatus.defaultmotion[v.pJsnData.formation[Qb]],pos:Qb,type:"player",current_hp:N.hp}),q.timeline[0].call(function(){v.pJsnData.player.param[Pb].hp=N.hp,N.hpmax&&(v.pJsnData.player.param[Pb].hpmax=N.hpmax),v.pJsnData.player.param[Pb].condition.buff=[],v.pJsnData.player.param[Pb].condition.debuff=[],v.pJsnData.player.param[Pb].condition.hide_hp_flag=!1,"number"==typeof Qb&&(v.gGameStatus.player.param[Qb].hp=N.hp,N.hpmax&&(v.gGameStatus.player.param[Qb].hpmax=N.hpmax),v.gGameStatus.player.param[Qb].condition.buff=[],v.gGameStatus.player.param[Qb].condition.debuff=[])}),""!==Qb&&(F.push(+Qb),i.mPlayerGaugeHp(q.timeline[0],{pos:Qb,param:{hp:N.hp,hpmax:N.hpmax||v.pJsnData.player.param[Pb].hpmax}}),i.mPlayerGaugeRecast(q.timeline[0],{pos:Qb,param:v.gGameStatus.player.param[Qb]}),i.mPlayerGaugeAttr(q.timeline[0],{pos:Qb,param:v.gGameStatus.player.param[Qb]}),k.timeline[Qb].call(function(){i.mSetSpecialSkip(v.pJsnData.player.param[Pb].skip_flag===!0,!1,Qb,!1)})),Rb===!0?(f.mSetTo(v.gAryCntnAvatar,k,{index:Qb,x:v.gGameParam.grid.player[Qb].x+=v.gGameParam.relative.offscreen.player}),f.mMoveTo(v.gAryCntnAvatar,k,{index:Qb,x:-v.gGameParam.relative.offscreen.player,playtime:6,ease:"quartOut"},{tween:[l,q],adjust:-5,wait:8}),f.mWaitAll([k,l,q],{playtime:1}),v.gGameParam.grid.player[Qb].x-=v.gGameParam.relative.offscreen.player):h.mBrightnessIn(k.timeline[0],{duration:"0.3s",count:1}),q.timeline[0].call(function(){v.pJsnData.player.param[Pb].alive=1,"number"==typeof Qb&&(v.gGameStatus.player.param[Qb].alive=1)}),Rb===!1&&q.timeline[0].call(function(a){var b={"class":"log-ability",title:a.title,body:a.comment};i.mLog(b)},[N])}P.resolve();break;case"resurrection_back":var Pb=N.index,Tb="completeDieBack"+Pb;u.stopListening(u,Tb),u.listenToOnce(u,Tb,function(){v.pJsnData.player.param[Pb].hp=N.hp,N.hpmax&&(v.pJsnData.player.param[Pb].hpmax=N.hpmax),v.pJsnData.player.param[Pb].condition.buff=[],v.pJsnData.player.param[Pb].condition.debuff=[],v.pJsnData.player.param[Pb].condition.hide_hp_flag=!1,v.pJsnData.player.param[Pb].alive=1}),b.contains(G,+Pb)===!1&&u.trigger(Tb),P.resolve();break;case"resurrection_available":var Pb=N.npc;v.pJsnData.player.param[Pb].resurrection_availble_flag=N.resurrection_available_flag,P.resolve();break;case"replace":var Ub=-1===b.indexOf(F,+N.pos);v.gGameStatus.attackQueue.charaChangeFlag=!0;var Vb=new lib[v.pJsnData.player.param[N.npc].cjs];if(null!==v.pJsnData.player.param[N.npc].formchange_type){var Wb=v.pJsnData.player.param[N.npc].name,Xb=function(a,b){var c=v.pJsnData.player.param[N.npc].cjs,d=c+b,e=Vb[c][d].timeline.duration;v.gGameStatus.form_change_frame[a][b]=e};v.gGameStatus.form_change_frame[Wb]={},Xb(Wb,"_change_1"),Xb(Wb,"_change_2")}"undefined"!=typeof v.gGameStatus.player.param[N.pos].condition.special_motion&&(v.gGameStatus.player.param[N.pos].condition.special_motion=void 0),k.timeline[N.pos].call(function(c){v.gAryCntnAvatar[c.pos].x+=9999;var d=b.clone(v.pJsnData.player.param);a.each(v.gGameStatus.player.param[c.pos],function(a,b){v.gGameStatus.player.param[c.pos][a]=d[c.npc][a]});var e=new lib[d[c.npc].cjs];v.gAryCntnAvatar[c.pos].removeChild(v.gAryRootAvatar[c.pos]),v.gAryRootAvatar[c.pos]=e,v.gAryCntnAvatar[c.pos].addChild(e)},[N]),N.hide&&(f.mChangeMotion(k.timeline[N.pos],{motion:"hide",pos:N.pos,type:"player"}),f.mWaitAll([k,l,q],{playtime:3}));var Zb=u.$el.find(".prt-command").find(".lis-character"+N.pos);
k.timeline[N.pos].call(function(a){v.gGameStatus.player.param[a.pos].alive=1,v.pJsnData.formation[a.pos]=String(a.npc);var b=v.pJsnData.formation[a.pos];1==v.gGameStatus.player.param[a.pos].leader?Zb.children("img").attr("src",Game.imgUri+"/sp/assets/leader/raid_normal/"+v.gGameStatus.player.param[a.pos].pid_image+".jpg"):Zb.children("img").attr("src",Game.imgUri+"/sp/assets/npc/raid_normal/"+v.gGameStatus.player.param[a.pos].pid_image+".jpg"),u.$el.find(".prt-command-top").find(".lis-character"+a.pos).removeClass("blank"),i.mSetSpecialSkip(v.pJsnData.player.param[b].skip_flag===!0,!1,a.pos,!1),N.hide||(v.gGameStatus.doneSetupMotionPlayer[b]=!0,v.gGameStatus.defaultmotion[b]="stbwait")},[N]),v.gGameStatus.replacehit[N.pos]=v.pJsnData.player.param[N.npc].effect,Ub===!0&&(i.mPlayerGaugeHp(k.timeline[N.pos],{pos:N.pos,param:{hp:v.pJsnData.player.param[N.npc].hp,hpmax:v.pJsnData.player.param[N.npc].hpmax}}),i.mPlayerGaugeRecast(k.timeline[N.pos],{pos:N.pos,param:v.pJsnData.player.param[N.npc]}),i.mPlayerGaugeAttr(k.timeline[N.pos],{pos:N.pos,param:v.pJsnData.player.param[N.npc]})),N.hide||(f.mWaitAll([k,l,q],{playtime:3}),f.mChangeMotion(k.timeline[N.pos],{motion:"chara_in",pos:N.pos,type:"player",voice:N.voice})),k.timeline[N.pos].call(function(a){v.gAryCntnAvatar[a.pos].x-=9999},[N]),N.hide||f.mChangeMotion(k.timeline[N.pos],{motion:"stbwait",pos:N.pos,type:"player",is_replace:"on"}),P.resolve();break;case"win":(b.isUndefined(N.dungeon_item_exist)||1!=N.dungeon_item_exist)&&(y[O+1]&&"contribution"===y[O+1].cmd&&v.pJsnData.is_defendorder||b.some(y.slice(O+1,y.length),function(a){return"sequence_point"===a.cmd})?(u.finishAfterSequencePointLength=b.filter(y.slice(O+1,y.length),function(a){return"sequence_point"===a.cmd}).length,v.gGameStatus.finishAfterContribution=!0):(v.gGameStatus.finish=!0,g.battleFinishedByThisScenarios=!0)),v.gGameStatus.shouldPlayFixedBGM=!0,q.timeline[0].call(function(){u.$el.find(".prt-condition").css("display","none"),i.mHideBossGauge(kb),i.mRemoveConditionField(),i.mUnsetSpecialSkipAll(),v.pJsnData.is_defendorder&&i.mRemoveConditionAssistUnit(),(1===v.gGameStatus.dispHpPercent&&N.win_message_flag===!0&&b.isUndefined(v.pJsnData.win_type)===!1&&2===v.pJsnData.win_type.lose_no_message||b.some(kb,function(a){return a.isAlive}))&&(u.$el.find(".prt-enemy-percent").css("display","none"),u.$el.find(".prt-targeting-area").css("display","none"))}),q.timeline[0].call(function(){u.$el.find(".prt-battle-num").css("display","none"),u.$el.find(".prt-total-human").css("display","none"),u.$el.find(".prt-remain-time").css("display","none"),u.$el.find(".prt-treasure").css("display","block")}),q.timeline[0].call(function(){b.each(v.gGameStatus.timer,function(a,b,c){clearInterval(a)})}),u.isSfvSurvivalResult=!1,u.isArcarumResult=!1;var $b=v.pJsnData.survival&&v.pJsnData.survival.stage_number==Y[v.pJsnData.survival.difficult],_b=+v.pJsnData.collabo_type===ra,ac=2==N.mode||3==N.mode||1==N.mode&&v.gGameStatus.isVersusView||1==N.mode&&_b===!0||$b,bc=!0;if(f.mWaitAll([k,l,q],{playtime:2}),q.timeline[0].call(function(){v.gAryCntnParts[2].removeChild(v.gAryRootParts[2]),ac===!0?(u._removeAutoButton(),u._noInteractiveAutoButton()):u.battleAutoType===Va.FULL&&u._removeAutoButton(),u._removeChatButtons()}),f.mWaitAll([k,l,q],{playtime:6}),null!=v.gGameStatus.last_drop&&v.gGameStatus.last_drop==v.gGameStatus.boss.last_die?f.mWaitAll([k,l,q],{playtime:12}):f.mWaitAll([k,l,q],{playtime:12}),v.gGameStatus.dropped.length>0){var cc={},dc=0;f.mWaitAll([k,l,q],{playtime:3}),b.each(v.gGameStatus.dropped,function(a){dc=h.mOpenTreasure(q.timeline[0],a),b.each(a[0],function(a){var c=parseInt(a);cc[c]=b.isUndefined(cc[c])?1:cc[c]+1})});var Sb=5,ec=u.$el.find(".prt-treasure-wrapper"),fc=ec.find(".txt-get-value.type1"),gc=ec.find(".txt-get-value.type2"),hc=ec.find(".txt-get-value.type3");f.mWaitAll([k,l,q],{playtime:Sb}),q.timeline[0].call(function(){var b=fc.html(),c=gc.html(),d=hc.html();b<z.treasure.treasure_type_1&&ec.find(".lis-treasure.type1").find(".anim-shine").show().oneAnimationEnd(function(){a(this).css("display","none")},1600),c<z.treasure.treasure_type_2&&ec.find(".lis-treasure.type2").find(".anim-shine").show().oneAnimationEnd(function(){a(this).css("display","none")},1600),d<z.treasure.treasure_type_3&&ec.find(".lis-treasure.type3").find(".anim-shine").show().oneAnimationEnd(function(){a(this).css("display","none")},1600),fc.html(""+z.treasure.treasure_type_1),gc.html(""+z.treasure.treasure_type_2),hc.html(""+z.treasure.treasure_type_3)}),f.mWaitAll([k,l,q],{playtime:dc-Sb})}if(ac===!0)if(v.gGameStatus.clear=!0,N.win_message_flag===!0&&b.isUndefined(v.pJsnData.win_type)===!1&&2===v.pJsnData.win_type.lose_no_message)q.timeline[0].call(function(){v.gGameStatus.is_clear=!0;var b=u.$el.find(".prt-battle-condition");b.removeClass("is-no-title"),b.find(".txt-title").empty().css("padding-bottom",0),b.find(".txt-body").html(v.pJsnData.win_type.lose_escape_text),b.show().one("tap",function(){a(this).css("display","none")})});else{var ic=new a.Deferred,jc=new a.Deferred,kc=new a.Deferred,lc=2==N.mode?v.gGameParam.cjs.quest_clear:v.gGameParam.cjs.win,mc=b.isUndefined(N.cjs)===!1;mc===!0&&(lc=N.cjs,v.gGameParam.relative.win.y=0,bc=!1,v.pJsnData.bgm_setting=null);var Vb=new lib[lc];!mc&&(v.pJsnData.is_arcarum||v.pJsnData.is_board||v.pJsnData.is_sequence)&&(Vb.se="se/arcarum_victory.mp3",v.pJsnData.is_board&&v.pJsnData.event_code&&(Vb.se="se/"+v.pJsnData.event_code+"_win_se_1.mp3"));var nc=new createjs.Container;nc.addChild(Vb),nc.x=v.gGameParam.relative.win.x,nc.y=v.gGameParam.relative.win.y,nc.visible=!1,v.gMasterContainer.addChild(nc);var oc=Vb[lc][lc+"_end"].timeline.duration;q.timeline[0].call(function(a){a.visible=!0,Vb[lc].gotoAndPlay("start"),u.$el.find(".prt-command-battle").css("display","none"),v.gAryCntnParts[2].visible=!1,$b&&Z&&!v.pJsnData.is_arcarum&&p.playBGM(Z)},[nc]),f.mWaitAll([k,l,q],{playtime:3}),b.times(v.gGameStatus.player.param.length,function(a){f.mChangeMotion(k.timeline[a],{motion:N.win_motion_label&&N.win_motion_label[a]||"win",pos:a,type:"player",is_alive:"on"})}),f.mWaitAll([k,l,q],{playtime:9}),q.timeline[0].call(function(){Vb[lc].gotoAndPlay("end"),3==N.mode&&p.stopBGM()},[]),q.timeline[0].call(function(){v.gGameStatus.isVersusView||_b===!0?kc.done(function(){_b&&2===+N.mode?u.setNamedTimeout("winVoiceStartTimeout",function(){jc.resolve()},300):jc.resolve()}):jc.resolve(),jc.done(function(){if(u.clearTimeoutOne("winVoiceStartTimeout"),p.playVoice(N.voice),!N.voice||n.isShellAppAndroid()||0===Game.setting.sound_flag)ic.resolve();else{var a=!1,b=function(){a||(a=!0,ic.resolve())};u.setNamedTimeout("voiceCompleteTimeout",b,8e3),o.once(N.voice,"complete",function(){u.clearTimeoutOne("voiceCompleteTimeout"),b()})}})},[]),f.mWaitAll([k,l,q],{playtime:oc}),q.timeline[0].call(function(){var a=v.pJsnData.is_sequence&&b.isUndefined(v.pJsnData.sequence)===!1&&2===+v.pJsnData.sequence.type;mc===!1&&(v.pJsnData.is_arcarum||v.pJsnData.is_board||v.pJsnData.is_sequence&&!a)&&N.bgm?(v.pJsnData.bgm_setting=N.bgm,p.playBGM(N.bgm)):(mc===!1&&3==N.mode||a===!0)&&p.playResultBGM(),v.gGameStatus.is_clear=!0});var pc=Vb[lc][lc+"_end"];pc.stop=function(){bc===!0&&v.gMasterContainer.removeChild(nc),delete pc.stop,pc.stop(),kc.resolve()}}else if(4==N.mode||5==N.mode){5==N.mode&&(v.gGameStatus.remain_turn="0",u.updateBonusStageTurn());var lc=v.gGameParam.cjs.quest_failed,Vb=new lib[lc],nc=new createjs.Container;nc.addChild(Vb),nc.x=v.gGameParam.relative.lose.x,nc.y=v.gGameParam.relative.lose.y,v.gMasterContainer.addChild(nc);var X=Vb[lc][lc+"_end"].timeline.duration;q.timeline[0].call(function(){Vb[lc].gotoAndPlay("end")},[nc]),f.mWaitAll([k,l,q],{playtime:X+12}),q.timeline[0].call(function(){v.gMasterContainer.removeChild(nc)})}else 6==N.mode&&(u.isSfvSurvivalResult=!0,q.timeline[0].call(function(){var a=u.$el.find(".btn-attack-start");a.hasClass("display-on")&&(u._controlDomAttackButton(!1),v.gAryRootParts[0][v.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out")),window.score_start=+v.pJsnData.survival.score_point,window.score_plus_1=+v.pJsnData.survival.add_point,window.score_plus_2=+v.pJsnData.survival.bonus_point,window.score_plus=score_plus_1+score_plus_2,window.stage_num=+v.pJsnData.survival.stage_number,window.stage_mode=4===+v.pJsnData.survival.difficult?3:+v.pJsnData.survival.difficult;var b=v.gGameParam.cjs.vs_result;u.suvivalResultContainer=new createjs.Container,window.exportRoot=new lib[b],u.suvivalResultContainer.addChild(window.exportRoot),u.suvivalResultContainer.x=0,u.suvivalResultContainer.y=0,v.gMasterContainer.addChild(u.suvivalResultContainer)}),f.mWaitAll([k,l,q],{playtime:90}),q.timeline[0].call(function(){v.gMasterContainer.removeChild(u.suvivalResultContainer),u.popBattleService(N)}));1==v.pJsnData.is_multi&&q.timeline[0].call(function(){v.gAryCntnParts[0].visible=!1,v.pJsnData.is_watching===!0||v.pJsnData.is_semi&&v.pJsnData.is_defendorder||u.showChatIcon()});var qc=function(){v.gAryRootParts[4][v.gGameParam.cjs.parts[4]].gotoAndPlay("in"),v.gAryCntnParts[4].visible=!0,u.$el.find(".prt-command-end").css("display","block"),u.$el.find(".prt-mask-other").show()};q.timeline[0].call(function(d){"top"!==v.gGameStatus.menu&&u.CommandBackTop({motion:!1});var e=v.pJsnData.arcarum||v.pJsnData.board||null;b.isNull(u.subArcarumTutorialRaidView)===!1&&e&&b.isEmpty(e.tutorial.end_battle_comment)===!1?u.subArcarumTutorialRaidView.trigger("battleWin",qc):6!=N.mode&&7!=N.mode&&b.isUndefined(r)&&qc();var f="",g=!1,j=location.hash.split("/");if("#tutorial"===j[0]){var k=parseInt(j[1])+1;f="#tutorial/"+k}else v.pJsnData.is_arcarum&&N.bgm?f="#result/"+d.raid_id+"/"+(u.currentFps/6-1)+"/1":""!=N.next_url?f=N.next_url:N.is_last_raid?N.is_endless_quest?f="#quest/index":1==v.pJsnData.is_multi?(f="#result_multi/"+d.raid_id+"/"+(u.currentFps/6-1),((v.pJsnData.bgm_setting||{}).is_change_bgm||mc===!0)&&(f+="/1")):$b?f="#result_survival/"+d.raid_id+"/1":(f="#result/"+d.raid_id+"/"+(u.currentFps/6-1),((v.pJsnData.bgm_setting||{}).is_change_bgm||mc===!0||v.pJsnData.is_sequence===!0)&&(f+="/1")):(g=!0,f="#raid/"+d.raid_id+"/"+(u.currentFps/6-1)+"/"+v.gGameStatus.lock);u.$el.find(".btn-result").one("tap",function(){g===!0&&v.gGameStatus.auto_attack===!0?(u.isSfvSurvivalResult||u.isArcarumResult||0==v.pJsnData.is_dungeon)&&(window.auto_flag=!0):window.auto_flag=!1,window.tmpAutoBtnDisplayFlg=u.tmpAutoBtnDisplayFlg===!0,v.gAryRootParts[4][v.gGameParam.cjs.parts[4]].gotoAndPlay("out"),u.$el.find(".btn-result").off(),u.off(),u.undelegateEvents(),u.stopListening(),u.clearTimeoutOne("raidAutoLocationNext");var a=function(){},b=500*(u.currentFps/u.baseFps);N.is_last_raid?a=function(){bc===!1&&v.gMasterContainer.removeChild(nc),$b?(u.content_close(),c.history.navigate(f,!0)):location.hash=f}:1==N.mode?(i.mSlideOut(),a=function(){h.mDeleteTreasure(v.gGameStatus.dropped,{delay:12}),location.hash=f}):a=function(){location.hash=f},u.setNamedTimeout("raidTapNextLocationTimeout",a,b)}),1==v.pJsnData.is_multi&&u.$el.find(".btn-assist").addClass("disable"),u.inactivateMask(),0===u.$el.find(".pop-battle-service").length&&(u.$el.find(".pop-usual").css("display","none"),a("#pop-chat .pop-usual").css("display","none"),u.hideMask()),u.removeFooterTreasurePop(),u.ResetAllAttackQueue();var l=u.$el.find(".btn-attack-start");if(l.hasClass("display-on")&&(u._controlDomAttackButton(!1),v.gAryRootParts[0][v.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out")),v.pJsnData.is_dungeon===!0&&!N.dungeon_item_exist&&2!=N.mode){var m=a(Game.ua.isJssdk()?Game.gameContainer.selector:"body");u.offBodyPreventDefault(m),location.hash=f}if(g===!0&&v.gGameStatus.auto_attack&&u.isSfvSurvivalResult)window.auto_flag=!0;else if(v.gGameStatus.auto_attack&&0==v.pJsnData.is_dungeon){g===!0&&(window.auto_flag=!0),window.tmpAutoBtnDisplayFlg=u.tmpAutoBtnDisplayFlg===!0;var m=a(Game.ua.isJssdk()?Game.gameContainer.selector:"body");u.offBodyPreventDefault(m),2==N.mode?a.when(ic,kc).done(function(){u.setNamedTimeout("raidAutoLocationNext",function(){location.hash=f},500)}):location.hash=f}},[N]),P.resolve();break;case"finished":v.gGameStatus.finish=!0,v.gGameStatus.already_finish=!0,q.timeline[0].call(function(){u.popShowRematchFail()}),P.resolve();break;case"rematch":v.gGameStatus.finish=!1,v.gGameStatus.retire=!1,v.gGameStatus.shouldPlayFixedBGM=!1;var rc=b.isUndefined(N.is_revival)||1!=N.is_revival?!1:!0,sc=b.clone(v.gGameStatus.player.param);v.gGameStatus.attackQueue.charaChangeFlag=v.gGameStatus.player.all_dead||v.gGameStatus.battle_end,q.timeline[0].call(function(){rc||v.pJsnData.is_arcarum||(v.gGameStatus.attackQueue.itemNumTmp.Potion=N.potion.count),b.isUndefined(N.potion)||(v.gGameStatus.potion.limit_remain=N.potion.limit_remain);var c=b.clone(v.pJsnData.formation);v.pJsnData.formation=[];for(var d=0,e=v.gGameStatus.player.number;e>=d;d++)v.gGameStatus.attackQueue.charaChangeFlag===!1&&(b.isUndefined(c[d])||c[d]!==String(d))&&(v.gGameStatus.attackQueue.charaChangeFlag=!0),v.pJsnData.formation.push(String(d));for(var d=0,e=v.pJsnData.player.number;e>d;d++){if(b.contains(v.pJsnData.formation,String(d))||(v.pJsnData.player.param[d].hp=rc?N.hp[d]:v.pJsnData.player.param[d].hpmax),!rc){var f=v.pJsnData.player.param[d].recastmax;f>100&&f-100>v.pJsnData.player.param[d].recast&&(f=v.pJsnData.player.param[d].recast+100),v.pJsnData.player.param[d].recast=f}v.pJsnData.player.param[d].alive=1,v.pJsnData.player.param[d].condition.buff=[],v.pJsnData.player.param[d].condition.debuff=[],v.pJsnData.player.param[d].condition.coating_value=0}var g=a.extend(!0,{},v.pJsnData);v.gGameStatus.player.param=[];for(var d=0,e=v.gGameStatus.player.number;e>=d;d++)v.gGameStatus.player.param.push(g.player.param[g.formation[d]]),v.gGameStatus.replacehit[g.formation[d]]=v.pJsnData.player.param[g.formation[d]].effect;u.isRematchAtAllDead=v.gGameStatus.player.all_dead}),f.mWaitAll([k,l,q],{playtime:1});var X=0,La=2;b.each(b.range(v.gGameStatus.player.number+1),function(c){q.timeline[0].call(function(a){if(1!==+sc[a].alive||sc[a].pid!==v.gGameStatus.player.param[a].pid){v.gAryCntnAvatar[a].removeChild(v.gAryRootAvatar[a]);var b=new lib[v.pJsnData.player.param[a].cjs];v.gAryRootAvatar[a]=b,v.gAryCntnAvatar[a].addChild(b),f.mChangeMotionInstantly({motion:"chara_in",pos:a,type:"player"})}var c=u.$el.find(".lis-character"+a).children("img");0==a?c.attr("src",Game.imgUri+"/sp/assets/leader/raid_normal/"+v.pJsnData.player.param[a].pid_image+".jpg"):c.attr("src",Game.imgUri+"/sp/assets/npc/raid_normal/"+v.pJsnData.player.param[a].pid_image+".jpg"),i.mSetSpecialSkip(v.pJsnData.player.param[v.pJsnData.formation[a]].skip_flag===!0,!1,a,!1)},[c]),q.timeline[0].call(function(a){u.$el.find(".prt-member").find(".lis-character"+a).removeClass("blank mask-black-fade");for(var b=0,c=v.gGameStatus.player.param.length;c>b;b++)u.$el.find(".prt-gauge-special.character"+b).find(".prt-shine").css("display","none")},[Wa]),i.mPlayerGaugeHp(k.timeline[c],{pos:c,param:{hp:rc?N.hp[c]:v.pJsnData.player.param[c].hpmax,hpmax:v.pJsnData.player.param[c].hpmax}});var d=a.extend(!0,{},v.pJsnData.player.param[c]);i.mPlayerGaugeRecast(k.timeline[c],{pos:c,param:d}),i.mPlayerGaugeAttr(k.timeline[c],{pos:c,param:v.pJsnData.player.param[c]}),X=h.mEffect(k.timeline[c],v.gAryCntnAvatar[c],{kind:"ab_3000"}),f.mWaitAll([k,l,q],{playtime:La});var e=0;if(rc){var g=/^-\d+$/;e=g.test(N.hp[c]-sc[c].hp)?String(N.hp[c]).split(""):String(N.hp[c]-sc[c].hp).split("")}else e=String(b.clone(v.pJsnData.player.param[c].hpmax)-sc[c].hp).split("");var j=u.createHealComponent(e,"player",c);k.timeline[c].call(function(){j.show()})}),q.timeline[0].call(function(){v.gGameStatus.menuBeforeRematch=v.gGameStatus.menu,v.gGameStatus.menu="rematch"}),q.timeline[0].call(function(){u.$el.find(".prt-condition").css("display","block")}),q.timeline[0].call(function(){v.gGameStatus.lose=!1}),v.gGameStatus.player.all_dead&&!v.gGameStatus.diagram&&u.battleAutoType===Va.FULL&&q.timeline[0].call(function(){u.showAutoButton()}),f.mWaitAll([k,l,q],{playtime:3}),P.resolve();break;case"lose":case"force_lose":case"survival_lose":if("survival_lose"===N.cmd){var ib=u.$el.find(".btn-attack-start");ib.hasClass("display-on")&&(u._controlDomAttackButton(!1),v.gAryRootParts[0][v.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"))}if(0!==v.gFieldCondition.getNumChildren()&&(v.gGameStatus.field.hasFieldEffect=!0),v.gGameStatus.finish=!0,v.gGameStatus.lose=!0,v.gGameStatus.shouldPlayFixedBGM=!0,q.timeline[0].call(function(){v.gGameStatus.auto_attack&&u.changeAutoMode(),u._outAutoButton(),u._noInteractiveAutoButton(),u._outChatButtons(),u.$el.find(".cnt-raid-chat").find(".btn-chat").removeClass("display-on").addClass(ga),2===v.gGameStatus.chara_select&&u.CancelTempItemUse(),u.ResetAllAttackQueue(),i.mUnsetSpecialSkipAll()}),v.pJsnData.is_multi||q.timeline[0].call(function(){u.$el.find(".prt-condition").css("display","none"),1===v.gGameStatus.dispHpPercent&&u.$el.find(".prt-enemy-percent").css("display","none"),"force_lose"===N.cmd&&u.$el.find(".prt-targeting-area").css("display","none"),i.mHideBossGauge(kb),i.mRemoveConditionField()}),b.isUndefined(v.pJsnData.lose_type)===!1&&1===v.pJsnData.lose_type.lose_no_message){var X=0;q.timeline[0].call(function(){var b=u.$el.find(".prt-battle-condition");b.removeClass("is-no-title"),b.find(".txt-title").empty().css("padding-bottom",0),b.find(".txt-body").html(v.pJsnData.lose_type.lose_escape_text),b.show().one("tap",function(){a(this).css("display","none")})})}else{var lc=v.gGameParam.cjs.quest_failed,Vb=new lib[lc],nc=new createjs.Container;nc.addChild(Vb),nc.x=v.gGameParam.relative.lose.x,nc.y=v.gGameParam.relative.lose.y,v.gMasterContainer.addChild(nc);var X=Vb[lc][lc+"_end"].timeline.duration;q.timeline[0].call(function(){Vb[lc].gotoAndPlay("end")},[nc])}l.timeline[0].call(function(){var a=((((v||{}).gGameStatus||{}).bossmode||{}).looks||{}).mode;a&&b.each(a,function(a,b){var c=v.gGameStatus.boss.param[b];c.alive&&u.changeBossMode(b,a)})}),f.mWaitAll([k,l,q],{playtime:X+12}),q.timeline[0].call(function(){b.isUndefined(v.pJsnData.is_trialbattle)!==!0&&v.pJsnData.is_trialbattle===!0||b.isUndefined(v.pJsnData.lose_type)===!1&&1===v.pJsnData.lose_type.lose_no_message||p.unsetBGM()}),1!=v.pJsnData.multi&&q.timeline[0].call(function(){b.each(v.gGameStatus.timer,function(a){clearInterval(a)})});var tc=u.$el.find(".prt-tips");(b.isUndefined(s)||v.gGameStatus.rep+1==r.trn)&&q.timeline[0].call(function(){if("force_lose"==N.cmd||"survival_lose"==N.cmd){v.gGameStatus.force_lose=!0,v.gAryRootParts[4][v.gGameParam.cjs.parts[4]].gotoAndPlay("in"),v.gAryCntnParts[4].visible=!0,u.$el.find(".prt-command-end").css("display","block");var a;a=1==v.pJsnData.is_multi?"#result_multi/"+v.pJsnData.raid_id+"/"+(u.currentFps/6-1):"#result/"+v.pJsnData.raid_id+"/"+(u.currentFps/6-1),u.$el.find(".btn-result").one("tap",function(){p.stopBGM(v.pJsnData.bgm),v.gAryRootParts[4][v.gGameParam.cjs.parts[4]].gotoAndPlay("out"),u.content_close(),c.history.navigate(a,!0)})}else b.isUndefined(N.lose_special_tips)===!1?u.popHelpShow(N.cmd,N.lose_special_tips):b.isUndefined(N.tips)?u.LosePopShow():(v.pJsnData.is_multi&&v.pJsnData.cheer_status&&!v.pJsnData.is_semi?tc.attr({cheer:"1"}):tc.attr({cheer:"0"}),tc.find(".txt-title").html(N.tips.title),tc.find(".txt-body").html(N.tips.body),tc.show())}),b.isUndefined(nc)===!1&&q.timeline[0].call(function(){v.gMasterContainer.removeChild(nc)}),P.resolve();break;case"temporary":q.timeline[0].call(function(){v.gGameStatus.attackQueue.itemNumTmp.TemporarySmall=N.small||0,v.gGameStatus.attackQueue.itemNumTmp.TemporaryLarge=N.large||0}),P.resolve();break;case"event_temporary":case"defendorder_temporary":case"arcarum_temporary":q.timeline[0].call(function(){v.pJsnData.is_arcarum?v.gGameStatus.attackQueue.itemNumTmp.ArcarumItem[N.item_id]=N.number:v.gGameStatus.attackQueue.itemNumTmp.EventItem[N.item_id]=N.number}),P.resolve();break;case"message":u.executeMessage([k,l,q],N,function(){P.resolve()});break;case"information":u.MultiLog({message:N.text,language:N.language}),P.resolve();break;case"serif":var ka=null;"player"===N.to?ka=k.timeline[N.pos]:"boss"===N.to&&(ka=l.timeline[N.pos]),i.mBalloonMessage(ka,N),a.when(R).done(function(){P.resolve()});break;case"arcarum_game_over":case"board_game_over":var uc=null,lc=null;switch(N.cmd){default:case"arcarum_game_over":uc=Db,lc=v.gGameParam.cjs.arcarum_battle_end;break;case"board_game_over":uc=Eb,lc=v.gGameParam.cjs.board_battle_end}var Vb=new lib[lc],nc=new createjs.Container,X=Vb[lc][lc+"_end"].timeline.duration;nc.addChild(Vb),nc.x=v.gGameParam.relative.lose.x,nc.y=v.gGameParam.relative.lose.y,p.loadSE(uc),v.gGameStatus.finish=!0,v.gGameStatus.battle_end=!0,q.timeline[0].call(function(){b.each(v.gGameStatus.timer,function(a){clearInterval(a)}),v.gGameStatus.auto_attack&&u.changeAutoMode(),u._outAutoButton(),u._noInteractiveAutoButton(),u._outChatButtons(),u.$el.find(".cnt-raid-chat .btn-chat").removeClass("display-on").addClass(ga),u.ResetAllAttackQueue(),i.mUnsetSpecialSkipAll(),u.$el.find(".prt-condition").css("display","none"),1===v.gGameStatus.dispHpPercent&&u.$el.find(".prt-enemy-percent").css("display","none"),i.mHideBossGauge(kb),i.mRemoveConditionField(),f.mChangeMotionAll(v.gAryRootAvatar,k.timeline,{motion:"hide",mc:v.gGameStatus.player.param,type:"player",is_alive:"on"}),v.gMasterContainer.addChild(nc),Vb[lc].gotoAndPlay("end"),p.stopBGM(v.pJsnData.bgm),p.playSE(uc)}),f.mWaitAll([k,l,q],{playtime:X}),q.timeline[0].call(function(){if("arcarum_game_over"===N.cmd){if(b.isNull(u.subArcarumTutorialRaidView)===!1){var a=function(){u.content_close(),w.hash("#arcarum2/tutorial/stage",{refresh:!1})};return void u.subArcarumTutorialRaidView.popLoseWithdraw(a)}u.popShowArcarumGameOver()}else"board_game_over"===N.cmd&&u.popShowBoardGameOver()}),P.resolve();break;case"time_up":case"retire":if(v.gGameStatus.finish){var vc=!!N.next_url;g.hasCollectItemUrl=!!g.ap&&!!g.ap.treasurequest&&!!g.ap.treasurequest.url,u.isEventQuestRetire=vc&&-1!==N.next_url.indexOf("#event/"),u.isSidestoryQuestRetire=vc&&-1!==N.next_url.indexOf("#sidestory/"),u.popQuestRetire(g,function(){var a="#quest";g.hasCollectItemUrl?a=g.ap.treasurequest.url:vc?a=N.next_url:(v.pJsnData.is_coopraid||v.pJsnData.is_lobby===!0)&&(a=v.pJsnData.event_coopraid_name?"#"+v.pJsnData.event_coopraid_name+"/coopraid":"#coopraid"),u.content_close(),w.hash(a,{refresh:!0})})}else{v.gGameStatus.finish=!0,v.gGameStatus.battle_end=!0,q.timeline[0].call(function(){b.each(v.gGameStatus.timer,function(a){clearInterval(a)}),u.destroySocket()});var wc=v.gGameStatus.player.param;if("retire"!==N.cmd)for(var Wa=0,xc=wc.length;xc>Wa;Wa++)b.isUndefined(wc[Wa])===!1&&1===+wc[Wa].alive&&f.mChangeMotion(k.timeline[Wa],{motion:v.gGameStatus.defaultmotion[v.pJsnData.formation[Wa]],pos:Wa,type:"player"});else f.mChangeMotionAll(v.gAryRootAvatar,k.timeline,{motion:"hide",mc:wc,type:"player",is_alive:"on"});q.timeline[0].call(function(){u.$el.find(".prt-condition").css("display","none"),i.mHideBossGauge(kb),i.mRemoveConditionField(),i.mUnsetSpecialSkipAll(),v.pJsnData.is_defendorder&&i.mRemoveConditionAssistUnit(),u.$el.find(".img-diagram").removeClass("display-on").addClass("display-off"),u.$el.find(".prt-temporary").removeClass("display-on").addClass("display-off"),u.$el.find(".cnt-raid-information").find(".btn-chat").removeClass("display-on").addClass("display-off"),u.$el.find(".btn-command-back").css("display","none"),u._controlDomAttackButton(!1),u.$el.find(".prt-targeting-area").remove();var a=u.$el.find(".img-score");a.hasClass("display-on")&&a.removeClass("display-on"),"retire"===N.cmd&&(v.gAryRootParts[0][v.gGameParam.cjs.parts[0]].gotoAndPlay("out"),v.gAryRootParts[1][v.gGameParam.cjs.parts[1]].gotoAndPlay("out"),v.gAryCntnParts[2].removeChild(v.gAryRootParts[2])),u._removeAutoButton(),u._removeChatButtons()});var X=v.gAryRootParts[0][v.gGameParam.cjs.parts[0]][v.gGameParam.cjs.parts[0]+"_out"].timeline.duration;f.mWaitAll([k,l,q],{playtime:X}),v.pJsnData.is_arcarum?(v.gGameParam.cjs.quest_failed=v.gGameParam.cjs.arcarum_battle_end,p.loadSE(Db)):v.pJsnData.is_board?(v.gGameParam.cjs.quest_failed=v.gGameParam.cjs.board_battle_end,p.loadSE(Eb)):v.pJsnData.is_sequence&&(v.gGameParam.cjs.quest_failed=v.gGameParam.cjs.sequence_battle_end,p.loadSE(Fb));var lc=v.gGameParam.cjs.quest_failed,Vb=new lib[lc],nc=new createjs.Container;nc.addChild(Vb),nc.x=v.gGameParam.relative.lose.x,nc.y=v.gGameParam.relative.lose.y,v.gMasterContainer.addChild(nc);var X=Vb[lc][lc+"_end"].timeline.duration;q.timeline[0].call(function(a){v.pJsnData.is_arcarum?(p.stopBGM(v.pJsnData.bgm),p.playSE(Db)):v.pJsnData.is_board?(p.stopBGM(v.pJsnData.bgm),p.playSE(Eb)):v.pJsnData.is_sequence&&(p.stopBGM(v.pJsnData.bgm),p.playSE(Fb)),Vb[lc].gotoAndPlay("end")},[nc]),f.mWaitAll([k,l,q],{playtime:X}),q.timeline[0].call(function(){(b.isUndefined(v.pJsnData.is_trialbattle)===!0||v.pJsnData.is_trialbattle!==!0)&&p.unsetBGM()});var yc=!1;q.timeline[0].call(function(){u.$el.find(".prt-command-end").css("display","block").addClass("retire"),"retire"===N.cmd&&(v.gAryRootParts[4][v.gGameParam.cjs.parts[4]].gotoAndPlay("in"),v.gAryCntnParts[4].visible=!0),b.isUndefined(N.lose_special_tips)===!1?u.popHelpShow(N.cmd,N.lose_special_tips):"time_up"===N.cmd&&u.popShowTimeUp(),u.$el.find(".btn-result, .pop-time-up .btn-usual-ok").click(function(){if(!yc)if(yc=!0,"time_up"===N.cmd){var a=new d,b={raid_id:v.pJsnData.raid_id};a.save(b,{url:a.urlRoot("time_up","",v.pJsnData.is_multi,v.pJsnData.is_semi),silent:!0,error:function(){yc=!1},success:function(){if(u.off(),u.undelegateEvents(),u.stopListening(),v.pJsnData.is_multi)var a="#result_multi/"+v.pJsnData.raid_id;else var a="#result/"+v.pJsnData.raid_id;Game.baseUri+a;location.hash=a}})}else if("retire"===N.cmd){var c=!!N.next_url;g.hasCollectItemUrl=!!g.ap&&!!g.ap.treasurequest&&!!g.ap.treasurequest.url,v.gAryRootParts[4][v.gGameParam.cjs.parts[4]].gotoAndPlay("out"),u.isEventQuestRetire=c&&-1!==N.next_url.indexOf("#event/"),u.isSidestoryQuestRetire=c&&-1!==N.next_url.indexOf("#sidestory/"),u.popQuestRetire(g,function(){var a="#quest";g.hasCollectItemUrl?a=g.ap.treasurequest.url:c&&"#event/sky"!=N.next_url?a=N.next_url:(v.pJsnData.is_coopraid||v.pJsnData.is_lobby===!0)&&(a=v.pJsnData.event_coopraid_name?"#"+v.pJsnData.event_coopraid_name+"/coopraid":"#coopraid");Game.baseUri+a;u.content_close(),w.hash(a,{refresh:!0})})}})})}P.resolve();break;case"wait":f.mWaitAll([k,l,q],{playtime:N.fps}),P.resolve();break;case"bgm":(!v.gGameStatus.shouldPlayFixedBGM||v.gGameStatus.shouldPlayFixedBGM===!0&&N.fix_bgm===!1)&&(v.gGameStatus.shouldPlayFixedBGM=N.fix_bgm,q.timeline[0].call(function(){var a=v.pJsnData.bgm=N.value;a&&ha(a)})),P.resolve();break;case"battlelog":N.no_message_flag||Ca||q.timeline[0].call(function(){var a=b.isObject(N.title)?N.title[Game.lang]:N.title,c=b.isObject(N.body)?N.body[Game.lang]:N.body,d=N.wait,e={"class":"log-battle",title:a,body:c,wait:+d};i.mLog(e)}),P.resolve();break;case"dungeon_item":v.gGameStatus.finish=!0,u.dungeonItems=N.items,q.timeline[0].call(function(){var c=new t({className:"pop-dungeon-item",title:D.getMessage("raid_11"),body:b.template(a("#tpl-dungeon-item").html(),{name:N.name,items:N.items}),flagBtnCancel:0,flagBtnOk:0});c.render().popShow(!0,50)}),P.resolve();break;case"image_change":k.timeline[N.pos].call(function(){v.pJsnData.player.param[v.pJsnData.formation[N.pos]].pid_image=N.image_id,v.gGameStatus.player.param[N.pos].pid_image=N.image_id}),q.timeline[0].call(function(){u.renewCharaList(null,!0)}),P.resolve();break;case"hide":a("#canvas").one("enemyDeadStart",function(){v.gAryCntnAvatar[N.pos].visible=!1}),u.listenToOnce(u,"showHideCharacter",function(){v.gAryCntnAvatar[N.pos].visible=!0}),P.resolve();break;case"threeact_type_aura_reset":q.timeline[0].call(function(){f.mChangeMotionInstantly({motion:"attack",pos:N.pos,type:"player"})}),P.resolve();break;case"arcarum_stage_effect":P.resolve();break;case"voice":b.isEmpty(N.voice)===!1&&q.timeline[0].call(function(){p.playVoice(N.voice)}),P.resolve();break;case"arcarum_tp_recovery":u.arcarumRestTp=+N.rest_tp,u.arcarumHasRetireTp=g.status.arcarum.has_retire_tp,Nb=!1,p.loadSE(Cb),v.gGameStatus.attackQueue.charaChangeFlag=v.gGameStatus.player.all_dead||v.gGameStatus.battle_end,v.gGameStatus.finish=!1,v.gGameStatus.battle_end=!1,q.timeline[0].call(function(){u.updateArcarumTp(),p.playSE(Cb),v.gGameStatus.menu="rematch"}),P.resolve();break;case"arcarum_stage_effect_release":var zc=N.arcarum_stage_effect_release;b.each(zc,function(a){var b=u.getReleaseArcarumStageEffectCjsName(a);if(null!==b){var c=new lib[b],d=c[b][b].timeline.duration;q.timeline[0].call(function(){v.gMasterContainer.addChild(c),e.mRemove(d,c,v.gMasterContainer)}),f.mWaitAll([k,l,q],{playtime:d})}}),P.resolve();break;case"bg_change":var Ac=N.cjs||null,Bc=N.bg_image;if(Ac){var Cc=new lib[Ac],X=Cc[Ac][Ac+"_end"].timeline.duration;a(v.canvas).one(xa,function(){u.replaceBG(Bc)}),q.timeline[0].call(function(){v.gMasterContainer.addChild(Cc),e.mRemove(X,Cc,v.gMasterContainer)}),f.mWaitAll([k,l,q],{playtime:X})}else q.timeline[0].call(function(){u.replaceBG(Bc)});P.resolve();break;case"motion_link":l.timeline[N.pos].call(function(){v.gGameStatus.boss.param[N.pos].motion_link_list=N.motion_link_list||null}),P.resolve();break;case"doubleup":v.gGameStatus.useAbilityPos=N.pos;var Dc={0:Ta+"_win",1:Ta+"_lose",2:Ta+"_draw"},Ec=window.highlow_result=N.highlow_result,Vb=new lib[Ta],nc=new createjs.Container,X=Vb[Ta][Ta+"_end"][Dc[Ec]].timeline.duration;q.timeline[0].call(function(){nc.addChild(Vb),v.gMasterContainer.addChild(nc),e.mRemove(X,nc,v.gMasterContainer)}),f.mWaitAll([k,l,q],{playtime:X}),q.timeline[0].call(function(){delete window.highlow_result}),P.resolve();break;default:P.resolve()}if(g.microtime)switch(N.cmd){case"rematch":_a(g.microtime),ab(g.microtime);break;case"attack":N.from&&(N.from.indexOf("player")>=0?cb(g.microtime):N.from.indexOf("boss")>=0&&_a(g.microtime));break;case"damage":case"effect":case"heal":case"ability":case"die":case"resurrection":case"replace":N.to&&(N.to.indexOf("player")>=0?_a(g.microtime):N.to.indexOf("boss")>=0&&cb(g.microtime));break;case"special":case"special_npc":case"super":case"friend":N.target&&(N.target.indexOf("player")>=0?_a(g.microtime):N.target.indexOf("boss")>=0&&cb(g.microtime));break;case"summon":case"summon_simple":cb(g.microtime);break;case"condition":N.to&&(N.to.indexOf("player")>=0?ab(g.microtime):N.to.indexOf("boss")>=0&&cb(g.microtime));break;case"modechange":cb(g.microtime);break;case"win":case"finished":case"time_up":case"retire":eb(g.microtime);break;case"bgm":fb(g.microtime)}return P})):!0}),x},_playStatusVoice:function(a){var c="";b.isEmpty(a.special_skill_gauge_voice)===!1?c=a.special_skill_gauge_voice:b.isEmpty(a.dying_voice)===!1?c=a.dying_voice:b.isEmpty(a.enemy_debuff_voice)===!1?c=a.enemy_debuff_voice:b.isEmpty(a.turnend_voice)===!1&&(c=a.turnend_voice),b.isEmpty(c)===!1&&(this._stopDamageVoice(),p.playVoice(c))},_stopDamageVoice:function(){for(var a=0,b=stage.pJsnData.formation.length,c="";b>a;a++)c="voice"+a,p.isPlayingVoice(c)===!0&&p.stopVoice(c)},_getHitEffect:function(a,b,c){var d=c||stage.gGameStatus.player.param[a].effect,e=b===!0&&stage.gGameStatus.player.param[a].companion_effect?stage.gGameStatus.player.param[a].companion_effect:null;return[d,e]},createDamageComponent:function(a,c,d,e,f,g){var h={},i=12*(a.split.length-1);if("player"===c){var j=stage.gGameParam.grid.player[a.pos];h.x=j.x-i,h.y=j.y-100}else{var k=this.convertBossPositionToContainerIndex(a.pos),l=stage.gBossContainer.getChildAt(k);"l"===stage.pJsnData.boss.type?(h.x=l.x+i,h.y=l.y-270):(h.x=l.x+i,h.y=l.y-150),h.x=h.x+ +stage.pJsnData.boss.param[a.pos].damage_position_plus.x,h.y=h.y+ +stage.pJsnData.boss.param[a.pos].damage_position_plus.y}if(!b.isUndefined(a.miss)&&(1==a.miss||4==a.miss)){var m=4==a.miss?"dodge":"miss",n=new B.components.OverheadMessage(this.spriteSheetManager.getById(H),m,"",!1);return"dodge"==m?n.x=h.x-80:n.x=h.x,n.y=h.y,n.addEventListener("animationEnd",function r(){n.parent.removeChild(n),
n.removeEventListener("animationEnd",r)}),stage.addChild(n),n}var e=b.isUndefined(a.attr)?e||0:a.attr,o=a.size||"m",p={attributeId:e,num:a.split,size:o,isCritical:a.critical,isGuard:a.guard},q=new B.components.Damage(this.spriteSheetManager.getById(H),p);return q.x=h.x,q.y=h.y,b.isUndefined(f)||(0===f?q.y+=50:(q.x+=70*(f%2),q.y+=-50*(f%2))),d||!b.isUndefined(f)&&f>0?"player"===c?(q.x+=Math.round(30*Math.random())-20,q.y+=Math.round(100*Math.random())-40):(q.x+=Math.round(80*Math.random())-20,q.y+=Math.round(80*Math.random())-40):b.isUndefined(g)===!1&&0!==+g&&(q.y+=+g),q.addEventListener("animationEnd",function s(){q.parent.removeChild(q),q.removeEventListener("animationEnd",s)}),stage.addChild(q),q},createTotalDamageComponent:function(a,b,c,d,e){var f=99,b=b||0,g=c||"l",h={attributeId:b,num:a.split,size:g,isTotal:b!==f},d=d||0,i=new B.components.Damage(this.spriteSheetManager.getById(H),h);if(b===f){var j=12*(a.split.length-1),k=this.convertBossPositionToContainerIndex(a.pos),l=stage.gBossContainer.getChildAt(k);"l"===stage.pJsnData.boss.type?(i.x=l.x+j,i.y=l.y-270):(i.x=l.x+j,i.y=l.y-150),i.x=i.x+ +stage.pJsnData.boss.param[a.pos].damage_position_plus.x,i.y=i.y+ +stage.pJsnData.boss.param[a.pos].damage_position_plus.y}else if("l"===stage.pJsnData.boss.type||e===!0)i.x=400+50*d,i.y=350+60*d;else{var k=this.convertBossPositionToContainerIndex(a.pos),l=stage.gBossContainer.getChildAt(k);i.x=l.x+50+50*d,i.y=l.y-150+60*d}return i.addEventListener("animationEnd",function m(){i.parent.removeChild(i),i.removeEventListener("animationEnd",m)}),stage.addChild(i),i},createHealComponent:function(a,b,c){var d=new B.components.Heal(this.spriteSheetManager.getById(H),a),e=12*(a.length-1);if("player"===b){var f=stage.gGameParam.grid.player[c];d.x=f.x-e,d.y=f.y-160}else{var g=this.convertBossPositionToContainerIndex(c),h=stage.gBossContainer.getChildAt(g);"l"===stage.pJsnData.boss.type?(d.x=h.x+e,d.y=h.y-330):(d.x=h.x+e,d.y=h.y-210),d.x=d.x+ +stage.pJsnData.boss.param[c].damage_position_plus.x,d.y=d.y+ +stage.pJsnData.boss.param[c].damage_position_plus.y}return d.addEventListener("animationEnd",function i(){d.parent.removeChild(d),d.removeEventListener("animationEnd",i)}),stage.addChild(d),d},createOverheadMessageComponent:function(a,c,d){var e=this._toMissType(a.miss,a.status),f=a.type?parseInt(a.type,10):b.isUndefined(a.dispel)===!1?"dispel":"",g=new B.components.OverheadMessage(this.spriteSheetManager.getById(H),e,a.text,f);if("player"===c){var h=stage.gGameParam.grid.player[a.pos];g.x=h.x+stage.gGameParam.grid.message.player.x-g.getBounds().width,g.y=h.y+stage.gGameParam.grid.message.player.y+d}else{var i=this.convertBossPositionToContainerIndex(a.pos),j=stage.gBossContainer.getChildAt(i);g.x=j.x+parseInt(stage.pJsnData.boss.param[a.pos].message_position.x,10),g.y=j.y+parseInt(stage.pJsnData.boss.param[a.pos].message_position.y,10)+d}return g.scaleX=.9,g.scaleY=.9,g.addEventListener("animationEnd",function k(){g.parent.removeChild(g),g.removeEventListener("animationEnd",k)}),stage.addChild(g),g},createEnemyRewardComponent:function(a,b,c){var d=new B.components.EnemyReward(this.spriteSheetManager.getById(H),b,a),e=this.convertBossPositionToContainerIndex(c),f=stage.gBossContainer.getChildAt(e);switch(b){case"rp":"l"===stage.pJsnData.boss.type?(d.x=f.x,d.y=f.y-330):(d.x=f.x,d.y=f.y-230);break;case"exp":"l"===stage.pJsnData.boss.type?(d.x=f.x,d.y=f.y-280):(d.x=f.x,d.y=f.y-180);break;case"lupi":"l"===stage.pJsnData.boss.type?(d.x=f.x,d.y=f.y-250):(d.x=f.x+20,d.y=f.y-150)}return d.addEventListener("animationEnd",function g(){null!=d.parent&&d.parent.removeChild(d),d.removeEventListener("animationEnd",g)}),stage.addChild(d),d},createFieldConditionComponent:function(b){stage.gFieldCondition=new B.components.FieldCondition(b);var c=b||1;a("#prt-field-conditions").addClass("position"+c),i.mCheckFieldNum()},createAssistUnitConditionComponent:function(){stage.gAssistUnitCondition=new B.components.AssistUnitCondition,a("#prt-assist-unit-conditions").addClass("show")},createAbilityRailComponent:function(){var a=new B.components.abilityRail(stage.gGameStatus.abilityRailUse);return a.addEventListener("animationEnd",function b(){a.parent.removeChild(a),a.removeEventListener("animationEnd",b)}),stage.addChild(a),a},loadStatusIcons:function(a,c){var d=[];b.each(a,function(a){var b="icon_status_"+a;if(!window.images||!window.images[b]){var c=Game.imgUri+"/sp/ui/icon/status/x64/status_"+a+".png";d.push({src:c,id:b,type:createjs.LoadQueue.IMAGE})}}),this.loadIconQueue.push({iconManifest:d,callback:c}),this.dequeueLoadIcon()},dequeueLoadIcon:function(){if(this.loadIconQueue.length>0&&this.isRunningLoadIcon===!1){var a=this,b=this.loadIconQueue.shift();this.isRunningLoadIcon=!0,m.once("complete",function(){b.callback(),a.isRunningLoadIcon=!1,a.dequeueLoadIcon()}),m.loadManifest(b.iconManifest,!0)}},convertBossPositionToContainerIndex:function(a){var b=a;return 3===stage.pJsnData.boss.number&&(1==a?b=2:2==a&&(b=1)),b},Attack:function(c,e,g,h,i){var j=!("retire"===c||"reward"===c||"arcarum_temporary_item_result_all_dead_game_over"===c),k=!("user_recovery"===c||"temporary_item_result"===c||"event_temporary_item_result"===c||"arcarum_temporary_item_result"===c);if(this.abilityRailTurnWaiting>0&&j===!0&&k===!0)return void this.abilityRailTurnWaitingStart();var l=this;stage.gGameStatus.attacking=1;var m="normal_attack_result",n={},o={raid_id:stage.pJsnData.raid_id,target_num:stage.gGameStatus.target,lock:stage.gGameStatus.lock,turn:+stage.gGameStatus.turn,summon_recast:this.getSummonRecast()};b.isUndefined(stage.gGameStatus.abilityTurn)===!1&&(o.ability_turn=stage.gGameStatus.abilityTurn),b.isUndefined(c)||"normal_attack_result"===c?n=e?b.defaults(o,e):o:(m=c,n=e||o,"ability_result"===m&&b.isUndefined(stage.gGameStatus.abilityTurn)===!1&&b.defaults(n,{turn:+stage.gGameStatus.turn,ability_turn:stage.gGameStatus.abilityTurn})),b.contains(["normal_attack_result","ability_result","summon_result"],m)===!0&&(n.skip_special_motion_setting=[],b.each(stage.pJsnData.player.param,function(a){n.skip_special_motion_setting.push({setting_id:a.setting_id,skip_flag:a.skip_flag})})),b.contains(["normal_attack_result","ability_result","summon_result","temporary_item_result","reward"],m)===!0&&(n.pca=a(".prt-command-chara").length),stage.gGameStatus.attack_action=m,b.isUndefined(stage.pJsnData.duplicate_key)||(n.duplicate_key=stage.pJsnData.duplicate_key),stage.pJsnData.bgm&&(n.playing_bgm=stage.pJsnData.bgm),b.isUndefined(stage.pJsnData.rep)||(l.AttackHide(),m="rep"),"normal_attack_result"===m&&stage.gGameStatus.attack_count++,stage.gGameStatus.node_finish||stage.gGameStatus.is_clear||"ability"===stage.gGameStatus.menu||stage.gGameStatus.abilityRailUse!==Qa.OFF&&("summon"===stage.gGameStatus.menu||"temporary"===stage.gGameStatus.menu)||stage.gGameStatus.isNodeBossKillScenarios||(l.activateMask(),stage.pJsnData.is_multi&&a("#multi-btn-mask").css({display:"none"}));var p=a("body"),q=p,r=a(document).scrollTop();Game.ua.isJssdk()&&(p=a(Game.gameContainer.selector),r=a(Game.gameContainer.selector).parent().scrollTop());var s=q.hasClass("pc")||q.hasClass("jssdk");s||l.setBodyPreventDefault(p),r>1&&window.scrollTo(0,0),this.$el.find(".prt-battle, .prt-navi").removeClass("display-on"),clearInterval(stage.gGameStatus.timer.mBalloon);var t=this.$el.find(".prt-sub-command");if(b.contains(["ability_result","summon_result","temporary_item_result","user_recovery","event_temporary_item_result","defendorder_temporary_item_result","arcarum_temporary_item_result"],m)!==!1||stage.gGameStatus.isNodeBossKillScenarios?stage.gGameStatus.abilityRailUse===Qa.OFF&&(t.children("div.btn-temporary").addClass("black"),a("#okugi-btn-mask, #speed-btn-mask").css("display","none")):t.children("div").addClass("black"),stage.pJsnData.tutorial_flag&&stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"),stage.gGameStatus.node_finish&&this.$el.find(".btn-revival").css("display","none"),"ability"!==stage.gGameStatus.menu&&"summon"!==stage.gGameStatus.menu&&"temporary"!==stage.gGameStatus.menu&&!stage.gGameStatus.tutorial_state&&"reward"!==stage.gGameStatus.attack_action){this.$el.find(".prt-command-chara").css("display","none");var u=a("#okugi-btn-mask"),t=a("#prt-sub-command-group");if(u.css("display","block"),t.find(".btn-lock").addClass("black"),setTimeout(function(){u.css("display","none"),t.find(".btn-lock").removeClass("black")},1250),!stage.gGameStatus.node_finish&&1!==+stage.pJsnData.no_disp_turn){var v=stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]][stage.gGameParam.cjs.parts[0]+"_out"].timeline.duration;l.setNamedTimeout("setup:Attack:turnchange",function(){stage.gAryRootParts[2][stage.gGameParam.cjs.parts[2]].gotoAndPlay("in"),stage.gAryCntnParts[2].visible=!0;var a=l.$el.find(".cnt-raid-chat .btn-chat");(stage.gGameStatus.auto_attack||a.hasClass("sub-left")||a.hasClass("sub-right"))&&l._fadeChatButtons()},v*stage.gGameParam.spf)}}if("temporary"!==stage.gGameStatus.menu&&!stage.gGameStatus.tutorial_state){var w=0,x=0;if(!stage.gGameStatus.motion){for(var v=0,y=0,z=stage.gAryCntnAvatar.length;z>y;y++)if(1==stage.gGameStatus.player.param[y].alive&&1==stage.pJsnData.battle.count&&1==stage.gGameStatus.turn&&"reward"!==stage.gGameStatus.attack_action&&(parseInt(stage.gGameStatus.player.param[y].recast)<parseInt(stage.gGameStatus.player.param[y].special_skill_recast)||1==stage.gGameStatus.lock)){var A=stage.pJsnData.formation[y];stage.gGameStatus.doneSetupMotionPlayer[A]===!1&&(v=f.mChangeMotionInstantly({motion:"setup",pos:y,type:"player",delay:x*y}),stage.gGameStatus.doneSetupMotionPlayer[A]=!0,stage.gGameStatus.defaultmotion[A]="stbwait"),stage.pJsnData.tutorial_flag!==!0&&f.mChangeMotionInstantly({motion:"stbwait",pos:y,type:"player",delay:v+x*y})}w=x*(stage.gAryCntnAvatar.length-1)+v+x}}if(l.isFullAutoAttacking()&&"normal_attack_result"===m){var B=l.$el.find(".pop-usual");b.each(Wa,function(a){l.hidePUAndTreasurePU(a.selector,a.popHideFunctionName)}),l.popView&&!(B.hasClass("pop-ready-stamp")||B.hasClass("pop-chat")||B.hasClass("pop-start-assist"))&&l.hidePUAndTreasurePU(".pop-usual","popRemove")}var C=new Date,D=new d,E=this;D.save(n,{url:D.urlRoot(m,n.mode,stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){2===stage.gGameStatus.chara_select&&(l.popView&&(l.popView.destroy(),l.popView.popDelete()),l.CancelTempItemUse()),E.inactivateMask(),stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,l._offAutoButton(),l.ResetAllAttackQueue(),l.CommandChangeTop()},success:function(){E.trigger(Mb);var a=D.toJSON();if(b.isUndefined(a.scenario)||!0===a.errorPopFlag)if(b.isUndefined(stage.pJsnData.rep))if(a.ability_skip_flag===!0){var c=n.ability_character_num+"_"+n.abilityNumber;Zb.push(c),l.RemoveAttackQueueUI(0),l.RemoveAttackQueue(0),stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,stage.gGameStatus.motion=!1,stage.gGameStatus.btn_lock=!1,setTimeout(function(){l.runFullAuto()},1)}else l.inactivateMask(),l.$el.find(".prt-sub-command>div").removeClass("black"),stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,l._offAutoButton(),2===stage.gGameStatus.chara_select&&l.CancelTempItemUse(),l.$el.find(".pop-usual:not(.common-pop-error)").css("display","none").removeClass("pop-show pop-hide"),l.ResetAllAttackQueue(),l.CommandBackTop(),l.offBodyPreventDefault(p),l._controlDomAttackButton(!0),l.hideAttackCancelButton(function(){l.$el.find(".btn-attack-start").hasClass("display-on")===!0&&stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in")}),b.isUndefined(a.is_fail_use_elixir)===!1&&a.is_fail_use_elixir===!0&&(stage.gGameStatus.pop_limit=!1,stage.gGameStatus.potion.isNoLongerAllowedElixir=!0,l.popPotionLimitOver()),"ability_result"!==m||b.isUndefined(stage.gGameStatus.$use_cancel_ability)||(l.$el.find(".prt-ability-dialog").removeClass("disable"),stage.gGameStatus.$use_cancel_ability.children().attr("ability-recast",0)),stage.gGameStatus.btn_lock=!1;else l.playScenarios(a,w,C,g,i,m);else{if(l.RejectSameTimeAttack(a),!window.dmode&&(isNaN(stage.gGameParam.fps)||createjs.Ticker.getFPS()>24)&&createjs.Ticker.setFPS(24),!b.isUndefined(a.status)){if(!b.isUndefined(a.status.is_multi_ability_notification)&&a.status.is_multi_ability_notification===!0&&n.is_by_auto!==!0)return 2===stage.gGameStatus.chara_select&&l.CancelTempItemUse(),l.inactivateMask(),stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,void l.popConfirmMultiAbiliry();stage.gGameStatus.is_escorted_character_dead=b.isUndefined(a.status.is_escorted_character_dead)?0:a.status.is_escorted_character_dead,b.isUndefined(a.status.summon_enable)||(stage.pJsnData.summon_enable=a.status.summon_enable)}l.playScenarios(a,w,C,g,i,m)}}})},hidePUAndTreasurePU:function(a,b){this.$el.find(a).is(":visible")&&(Game.footer&&Game.footer.mainView&&Game.footer.mainView.isTreasurePUOpen&&Game.footer.mainView.popRemove(),this[b]())},RejectSameTimeAttack:function(a){var c=!1;if(b.each(a.scenario,function(a){"win"!==a.cmd||a.is_finisher||(c=!0)}),c){var d=[];b.each(a.scenario,function(a){("stop"===a.cmd||"hide"===a.cmd||"die"===a.cmd||"drop"===a.cmd||"win"===a.cmd)&&d.push(a)}),a.scenario=d}},checkPlayerAllDead:function(){stage.gGameStatus.player.all_dead=!0;for(var a=0,b=stage.gGameStatus.player.param.length;b>a;a++)if(0!=stage.gGameStatus.player.param[a].alive){stage.gGameStatus.player.all_dead=!1;break}},AbilityUse:function(){if(1===+stage.pJsnData.multi&&stage.gGameStatus.node_finish===!0)return void this.ResetAllAttackQueue();if(stage.gGameStatus.action.ab_select){var a=stage.gGameStatus.attackQueue.queue[0].$useAbility,c=a.children().attr("ability-character-num"),d=(b.indexOf(stage.pJsnData.formation,String(c)),a.hasClass("ability-disable")),e="",f="",g=parseInt(a.find('[class^="ico-ability"]').attr("ability-pick")),h=stage.gGameStatus.attackQueue.queue[0].param.ability_aim_num;if(b.contains([1,2,4,5,7,10,11],+g)&&!h)e="raid_82",f="raid_89";else if(d!==!0&&a.hasClass("btn-ability-available")){var i=+a.children().attr("ability-attribute").split(",")[0],j=this.checkAbilityTargetError(g,h,i);if(j)switch(j){case V.ALIVE:e="raid_82",f="raid_ability_error_revive";break;case V.FULLHP:e="raid_82",f="raid_86"}}else e="raid_82",f="raid_83";if(""!=e&&""!=f)this.popShowAbilityRailError(e,f),stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,stage.gGameStatus.btn_lock=!1,this._offAutoButton(),this.ResetAllAttackQueue(),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),this._controlDomAttackButton(!0),this.CommandBackTop();else{var k=stage.gGameStatus.menu;stage.gGameStatus.menu="ability",stage.gGameStatus.attackQueue.queue[0].param.target_num=stage.gGameStatus.target,stage.gGameStatus.attackQueue.queue[0].param.summon_recast=this.getSummonRecast(),this.Attack("ability_result",stage.gGameStatus.attackQueue.queue[0].param),stage.gGameStatus.menu=k}}},SummonUse:function(){if(1===+stage.pJsnData.multi&&stage.gGameStatus.node_finish===!0)return void this.ResetAllAttackQueue();var a=stage.gGameStatus.attackQueue.queue[0].param;b.defaults(a,{turn:+stage.gGameStatus.turn,ability_turn:stage.gGameStatus.abilityTurn,summon_recast:this.getSummonRecast()});var c=stage.gGameStatus.menu;stage.gGameStatus.menu="summon",this.Attack("summon_result",a),stage.gGameStatus.menu=c},itemUse:function(){function a(a){var c=b.indexOf(stage.pJsnData.formation,a+"");return 0!==stage.gGameStatus.player.param[c].alive?null==stage.gGameStatus.player.param[c].condition.debuff||0===stage.gGameStatus.player.param[c].condition.debuff.length?!1:b.some(stage.gGameStatus.player.param[c].condition.debuff,function(a){return!a.is_unusable_harb}):!1}function c(){var a,b;for(a=0,b=stage.pJsnData.formation.length;b>a;a++){var c=stage.pJsnData.formation[a];if(1==stage.pJsnData.player.param[c].alive&&stage.pJsnData.player.param[c].hp<stage.pJsnData.player.param[c].hpmax)return!0}return!1}if(1===+stage.pJsnData.multi&&stage.gGameStatus.node_finish===!0)return void this.ResetAllAttackQueue();stage.gGameStatus.abilityRailUse===Qa.OFF&&stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("out");var d=stage.gGameStatus.attackQueue.queue[0],e=d.param,f=stage.gGameStatus.attackQueue.queue.length<=1,g=!1,h="raid_84",i="abilityrail_item_error";switch(d.itemType){case"TemporarySmall":this.checkAbilityTargetError(2,e.character_num)&&(g=!0,f===!0&&(h="raid_item_use",i="item_error_1"));break;case"TemporaryLarge":c()===!1&&(g=!0,f===!0&&(h="raid_item_use",i="item_error_1"));break;case"Potion":y.remove("lose_pop_flg"),y.remove("cheer_compleate"),y.remove("cheer_effect_text"),this.$el.find(".cnt-raid-chat").find(".btn-chat").css({display:"block"}),this.$el.find(".btn-revival").css("display","none"),stage.gGameStatus.finish=!1;for(var j=b.clone(stage.pJsnData.player.param),k=j.length,l=0;k>l;l+=1){var m=j[l];b.isUndefined(m)||(m.condition.hide_hp_flag=!1)}break;case"EventItem":stage.gGameStatus.finish=!1;var n=+d.param.event_type,o=+d.param.item_id;if((3===n&&3===o||4===n&&5===o)&&this.$el.find(".btn-revival").css("display","none"),d.param.character_num)a(d.param.character_num)===!1&&(g=!0,f===!0&&(h="raid_item_use",i="item_error_2"));else if(1===o)c()===!1&&(g=!0,f===!0&&(h="raid_item_use",i="item_error_1"));else if(3===o||4===n&&5===o){for(g=!0,l=0,len=stage.pJsnData.player.number;l<len;l++)1!=stage.pJsnData.player.param[l].alive&&(g=!1);g===!0&&f===!0&&(h="raid_item_use",i="item_error_3")}break;case"ArcarumItem":if(stage.gGameStatus.arcarum_item_flg=!1,stage.gGameStatus.finish=!1,d.param.character_num)a(d.param.character_num)===!1&&(g=!0,f===!0&&(h="raid_item_use",i="item_error_2"));else{var o=+d.param.item_id;switch(g=!0,+o){case 1:g=!1,c()===!1&&(g=!0,f===!0&&(h="raid_item_use",i="item_error_1"));break;case 3:stage.gGameStatus.arcarum.item[o].is_resurrection===!0&&(g=!1);break;case 4:stage.gGameStatus.arcarum.item[o].is_resurrection===!0&&(g=!1);break;case 20:g=!1}}}if(g)return this.popShowAbilityRailError(h,i),stage.gGameStatus.attacking=0,stage.gGameStatus.usingAbility=0,stage.gGameStatus.btn_lock=!1,this._offAutoButton(),this.ResetAllAttackQueue(),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),this._controlDomAttackButton(!0),void this.CommandBackTop();b.defaults(e,{turn:+stage.gGameStatus.turn,ability_turn:stage.gGameStatus.abilityTurn,summon_recast:this.getSummonRecast(),recovery_items:this.getRecoveryItemsInfo()});var p=stage.gGameStatus.menu;stage.gGameStatus.menu="temporary",this.Attack(stage.gGameStatus.attackQueue.queue[0].action,e),stage.gGameStatus.menu=p},getSummonRecast:function(){var a=[];return b.each(stage.pJsnData.summon,function(b){a.push(b.recast||"")}),a.push(stage.pJsnData.supporter.recast||""),a},ConditionPopBoss:function(b){var c=parseInt(a(b.currentTarget).attr("target"))-1;this.ConditionPop(1,c,c)},ConditionPopPlayer:function(b){var c=a(b.currentTarget).parent("div"),d=c.attr("target"),e=c.attr("pos"),f=c.attr("pos");this.ConditionPop(d,e,f)},ConditionPop:function(c,d,e){if(!stage.gGameStatus.is_escorted_character_dead&&!stage.gGameStatus.player.all_dead){var f=this,g=0==c?stage.gGameStatus.player.param[d].name:stage.gGameStatus.boss.param[d].name[Game.lang];0==c&&(d=stage.pJsnData.formation[d]),this.scrollPopShow("<div class='pop-condition'>"+D.getMessage("raid_12")+"</div>");var h=new q;h.fetch({url:h.urlRoot("condition/"+stage.pJsnData.raid_id+"/"+c+"/"+d,"",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){},success:function(){var j=h.toJSON();"undefined"==typeof j.condition.buff&&(j.condition.buff=[]),"undefined"==typeof j.condition.debuff&&(j.condition.debuff=[]),+_!==+stage.gGameStatus.bossmode.looks.mode[d]&&(j.condition.debuff=b.reject(j.condition.debuff,function(a){return b.some($,function(b){return+b===+a.status})})),a("#pop-scroll").find(".pop-condition").html(b.template(a("#tpl-condition-effect-list").html(),b.extend(j,{pos:d+1,tgt:c}))),f.$el.find(".pop-condition").find(".prt-condition-title").html(g);var k=f.$el.find(".pop-condition"),l=f.$el.find(".cnt-raid");if(f.popScrollHeightDelta=+l.outerHeight()-+k.outerHeight(),0>f.popScrollHeightDelta){var m=+l.css("padding-bottom").replace(/px/g,"")+Math.abs(f.popScrollHeightDelta);l.css("padding-bottom",m+"px")}var n=0==c?"player":"boss";stage.gGameStatus[n].param[e].condition.buff=[],stage.gGameStatus[n].param[e].condition.debuff=[],b.each(j.condition.buff,function(a){stage.gGameStatus[n].param[e].condition.buff.push({status:a.status})}),b.each(j.condition.debuff,function(a){stage.gGameStatus[n].param[e].condition.debuff.push({status:a.status,is_unusable_harb:a.is_unusable_harb})}),0==c?i.mConditionPlayer(j.condition,e):(kb[d].condition.setCondition(stage.gGameStatus[n].param[e].condition,stage.gGameStatus.bossmode.looks.mode[d]),i.mConditionBoss(kb))}})}},fetchFieldCondition:function(){this.scrollPopShow("<div class='pop-condition'>"+D.getMessage("raid_12")+"</div>");var a=new(x.extend({urlRoot:Game.baseUri+this.getRaidType()+"/field_effect/"+stage.pJsnData.raid_id}));this.stopListening(a),this.listenTo(a,"sync",this.popFieldCondition),this.fetchFieldCondition=function(){a.fetch()},this.fetchFieldCondition()},popFieldCondition:function(c){var d=c.toJSON();b.isEmpty(d)?i.mRemoveConditionField():(this.setTmpPersonalField(d),i.mConditionField(d));var e=a("#pop-scroll").find(".pop-condition");e.html(b.template(a("#tpl-pop-field-condition").html(),{field_effect:d})).find(".prt-field-condition-title").text(D.getMessage("raid_81"))},fetchAssistUnitCondition:function(){this.scrollPopShow("<div class='pop-condition'>"+D.getMessage("raid_12")+"</div>");var a=new(x.extend({urlRoot:Game.baseUri+this.getRaidType()+"/unit_effect/"+stage.pJsnData.raid_id}));this.stopListening(a),this.listenTo(a,"sync",this.popAssistUnitCondition),this.fetchAssistUnitCondition=function(){a.fetch()},this.fetchAssistUnitCondition()},popAssistUnitCondition:function(c){var d=c.toJSON(),e=a("#pop-scroll").find(".pop-condition");e.html(b.template(a("#tpl-pop-assist-unit-condition").html(),{assist_unit:d})).find(".prt-assist-unit-condition-title").text(D.getMessage("raid_do_3"))},enemyTargeting:function(c){var d=parseInt(a(c.currentTarget).attr("data-target")),e=d-1;0!=stage.gGameStatus.boss.param[e].alive&&(this.$el.find(".btn-targeting").removeClass("lock-on"),stage.gGameStatus.target==d?(stage.gGameStatus.target=0,kb[e].unmarkTarget()):(b.each(kb,function(a){a.unmarkTarget()}),stage.gGameStatus.target=d,this.$el.find('.btn-targeting[data-target="'+d+'"]').addClass("lock-on"),kb[e].markTarget()),this.showEnemyInfo())},CommandLock:function(b){if(!this._isCommandLockDisallowed()&&!a(b.currentTarget).hasClass("disabled")){var c=stage.gGameStatus;if(1===+c.lock)c.lock=0;else if(0===+c.lock&&(c.lock=1,"ability"!==c.menu&&"summon"!==c.menu&&1!==c.attacking))for(var d=c.player.param,e=0,g=stage.gAryRootAvatar.length;g>e;++e)1===+d[e].alive&&f.mChangeMotionInstantly({motion:c.defaultmotion[stage.pJsnData.formation[e]],pos:e,type:"player"});this._setting_model||(this._setting_model=new(u.extend({urlRoot:Game.baseUri+"rest/raid/setting"}))),this._setting_model.save({set:"special_skill",value:c.lock},{success:function(){},error:function(){},silent:!0}),this.$el.find(".btn-lock").removeClass().addClass("btn-lock lock"+c.lock),stage.gGameStatus.attacking||this.renewCharaList()}},_isCommandLockDisallowed:function(){this.commandLockTime||(this.commandLockTime=0);var a=Date.now();return a-this.commandLockTime<1e3?!0:(this.commandLockTime=a,!1)},ItemUseOk:function(){if(stage.gGameStatus.node_finish||this.HideCommand(),!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0,stage.gGameStatus.pop_limit=!0,this.popView.popClose(),this.hideMask();var a={raid_id:stage.pJsnData.raid_id},b="item_"+stage.gGameStatus.potion.battle_icon_type,c={index:"itemUse",param:a,action:"user_recovery",itemType:"Potion"},d=this.getIsReadyToPlayScenario();stage.gGameStatus.lose===!1&&(c.iconPath=b,this.AddAttackQueueUI(b)),stage.gGameStatus.attackQueue.queue.push(c),stage.gGameStatus.btn_lock=!1,d?this.itemUse():stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue()}},UseTempItem:function(c){if(!a(c.currentTarget).hasClass("disabled")&&stage.gGameStatus.attackQueue.attackButtonPushed!==!0&&!(stage.gGameStatus.auto_attack===!0&&this.autoType===Va.NORMAL||b.isUndefined(stage.gGameStatus.temporary)||b.isUndefined(stage.gGameStatus.temporary.small)||b.isUndefined(stage.gGameStatus.temporary.large)||stage.gGameStatus.abilityRailUse===Qa.OFF&&1===stage.gGameStatus.attacking)){stage.gGameStatus.event_item_flg=!1,stage.gGameStatus.arcarum_item_flg=!1;var d=this.countItemOnRail(),e=stage.gGameStatus.temporary.small-(d.TemporarySmall||0),f=stage.gGameStatus.temporary.large-(d.TemporaryLarge||0),g=stage.gGameStatus.potion.count-(d.Potion||0),h={temporary_potion_one_count_before:e,temporary_potion_one_count_after:0>=e?0:e-1,temporary_potion_all_count_before:f,temporary_potion_all_count_after:0>=f?0:f-1,potion_count_before:g,potion_count_after:0>=g?0:g-1,temporary_potion_one_name:stage.pJsnData.temporary_potion_one_name,temporary_potion_all_name:stage.pJsnData.temporary_potion_all_name,event:b.isUndefined(stage.gGameStatus.event)?!1:stage.gGameStatus.event,can_use_event_item:stage.pJsnData.event_coopraid_name?!1:!0,arcarumItemList:stage.pJsnData.is_arcarum?stage.pJsnData.arcarum.item:!1,itemSumOnRail:d||{}},i="pop-raid-item";stage.pJsnData.is_arcarum&&(i+=" arcarum"),this.popView=new t({className:i,title:D.getMessage("raid_13"),body:b.template(this._getTplPopRecover(),h),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow(!0,"50px"),this.$el.find(".prt-command").css({"z-index":"5"}),this.$el.find(".prt-item-small, .prt-item-large, .btn-usual-use").css("display","none");var j=this.$el.find(".pop-raid-item");stage.gGameStatus.player.all_dead&&j.find(".item-large, .item-small").addClass("dead")}},countItemOnRail:function(){var a={};return b.each(stage.gGameStatus.attackQueue.queue,function(c,d){b.isUndefined(c.itemType)||("EventItem"===c.itemType||"ArcarumItem"===c.itemType?(a[c.itemType]=a[c.itemType]||{},a[c.itemType][c.param.item_id]=b.isUndefined(a[c.itemType][c.param.item_id])?1:a[c.itemType][c.param.item_id]+1):a[c.itemType]=b.isUndefined(a[c.itemType])?1:a[c.itemType]+1)}),a},_getTplPopRecover:function(){var b=a("#tpl-pop-recover").html();return this._getTplPopRecover=function(){return b},this._getTplPopRecover()},ConfirmTempItemSmall:function(a){var c=this.countItemOnRail(),d=stage.gGameStatus.temporary.small-(c.TemporarySmall||0);if(0!=d&&!stage.gGameStatus.player.all_dead){"top"!==stage.gGameStatus.menu&&this.CommandBackTop(),this.$el.find(".prt-sub-command>div").addClass("black disabled prt-silent-se");var e={temporary_potion_one_count_before:d,temporary_potion_one_count_after:0>=d?0:d-1,temporary_potion_one_name:stage.pJsnData.temporary_potion_one_name};this.popView.popClose(),this.popView=new t({className:"pop-raid-item",title:D.getMessage("raid_13"),body:b.template(this._getTplTemporarySmall(),e),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow(!0,"50px"),i.mPlayerBannerList(),this.$el.find(".prt-member").find(".btn-command-character.mask-black, .btn-command-character.mask-black-size-l, .btn-command-character.blank").addClass("prt-silent-se"),this.$el.find(".prt-command-summon").find(".btn-command-summon, .lis-summon").addClass("prt-silent-se")}},_getTplTemporarySmall:function(){var b=a("#tpl-temporary-small").html();return this._getTplTemporarySmall=function(){return b},this._getTplTemporarySmall()},ConfirmTempItemLarge:function(){var a=this.countItemOnRail(),c=stage.gGameStatus.temporary.large-(a.TemporaryLarge||0);if(0!=c&&!stage.gGameStatus.player.all_dead){var d={temporary_potion_all_count_before:c,temporary_potion_all_count_after:0>=c?0:c-1,temporary_potion_all_name:stage.pJsnData.temporary_potion_all_name};this.popView.popClose(),this.popView=new t({className:"pop-raid-item",title:D.getMessage("raid_13"),body:b.template(this._getTplTemporaryLarge(),d),flagBtnCancel:1,flagBtnOk:0});var e=this;setTimeout(function(){e.popView.render().popShow(!0,"50px");for(var a=!1,b=0,c=stage.pJsnData.formation.length;c>b;b++){var d=stage.pJsnData.formation[b];1==stage.pJsnData.player.param[d].alive&&stage.pJsnData.player.param[d].hp<stage.pJsnData.player.param[d].hpmax&&(a=!0)}a?e.$el.find(".pop-raid-item").find(".prt-popup-footer").append('<div class="btn-usual-use"></div>'):e.$el.find(".txt-select-chara").html(D.getMessage("raid_14"))},1)}},_getTplTemporaryLarge:function(){var b=a("#tpl-temporary-large").html();return this._getTplTemporaryLarge=function(){return b},this._getTplTemporaryLarge()},CancelTempItemUse:function(){stage.gGameStatus.chara_select=1,stage.gGameStatus.event_item_flg=!1,stage.gGameStatus.arcarum_item_flg=!1,this.$el.find(".prt-command").css({"z-index":"5"}),this.$el.find(".prt-command-top [class^='lis-character']").removeClass("mask-black prt-silent-se"),this.$el.find(".prt-summon-list>div").removeClass("mask-black prt-silent-se"),this.$el.find(".prt-sub-command>div").removeClass("black disabled prt-silent-se"),this.popView&&0===this.popView.$el.find(".common-pop-error").length&&this.popView.popRemove()},UseTempItemSmall:function(b){var c=a(b.currentTarget).attr("pos"),d=this.$el.find(".prt-command-top").find(".lis-character"+c);if(!d.hasClass("mask-black")&&!d.hasClass("mask-black-size-l")&&!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0,stage.gGameStatus.finish=!1,stage.gGameStatus.node_finish||this.HideCommand();var e={raid_id:stage.pJsnData.raid_id,character_num:stage.pJsnData.formation[c]},f="item_"+stage.gGameStatus.temporary.temporary_potion_one_battle_icon_type,g=this.getIsReadyToPlayScenario();stage.gGameStatus.attackQueue.queue.push({index:"itemUse",param:e,action:"temporary_item_result",iconPath:f,itemType:"TemporarySmall"}),this.AddAttackQueueUI(f),stage.gGameStatus.btn_lock=!1,this.CancelTempItemUse(b),g?this.itemUse():stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue()}},UseTempItemLarge:function(){var a=this;if(stage.gGameStatus.node_finish||a.HideCommand(),!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0,stage.gGameStatus.finish=!1;var b={raid_id:stage.pJsnData.raid_id},c="item_"+stage.gGameStatus.temporary.temporary_potion_all_battle_icon_type,d=this.getIsReadyToPlayScenario();stage.gGameStatus.attackQueue.queue.push({index:"itemUse",param:b,action:"temporary_item_result",iconPath:c,itemType:"TemporaryLarge"}),this.AddAttackQueueUI(c),stage.gGameStatus.btn_lock=!1,a.popView.popRemove(),d?this.itemUse():stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue(),stage.pJsnData.tutorial_flag===!0&&setTimeout(function(){a.hideMask()},240)}},ConfirmEventItem:function(b){var c=a(b.currentTarget).attr("item-id"),d=this.countItemOnRail(),e=stage.gGameStatus.event.item[c].number-(d.EventItem&&d.EventItem[c]||0);0>=e||(stage.gGameStatus.event_item_flg=!0,stage.gGameStatus.event_use_item_id=c,stage.gGameStatus.event_character_num=!1,2==stage.gGameStatus.event.item[c].target?this.ConfirmPopEventItemAll(c,e):this.ConfirmPopEventItemOne(c,e))},ConfirmPopEventItemAll:function(a,c){var d=b.clone(stage.gGameStatus.event.item[a]);d.number=c,this.popView.popClose(),this.popView=new t({className:"pop-event-item",title:D.getMessage("raid_13"),body:b.template(this._getTplTemporaryEvent(),d),flagBtnCancel:1,flagBtnOk:1}),this.popView.render();var e=this.$el.find(".txt-select-chara"),f=this.$el.find(".pop-event-item").find(".btn-usual-ok");if(1==a){for(var g=!1,h=0,i=stage.pJsnData.formation.length;i>h;h++){var j=stage.pJsnData.formation[h];1==stage.pJsnData.player.param[j].alive&&stage.pJsnData.player.param[j].hp<stage.pJsnData.player.param[j].hpmax&&(g=!0)}g||(e.html(D.getMessage("raid_14")),f.remove())}else if(3==a||4==stage.pJsnData.event.event_type&&5==a){for(var g=!1,h=0,i=stage.pJsnData.player.number;i>h;h++)1!=stage.pJsnData.player.param[h].alive&&(g=!0);g||(e.html(D.getMessage("raid_14")),
f.remove())}this.popView.popShow()},_getTplTemporaryEvent:function(){var b=a("#tpl-temporary-event").html();return this._getTplTemporaryEvent=function(){return b},this._getTplTemporaryEvent()},ConfirmPopEventItemOne:function(a,c){var d=b.clone(stage.gGameStatus.event.item[a]);d.number=c,"top"!==stage.gGameStatus.menu&&this.CommandBackTop(),this.$el.find(".prt-sub-command").children().addClass("black disabled prt-silent-se"),this.popView.popClose(),this.popView=new t({className:"pop-raid-item",title:D.getMessage("raid_13"),body:b.template(this._getTplTemporaryEvent(),d),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow(!0,"50px"),i.mPlayerBannerList({type:"condition"})},UseEventItem:function(){var a=this.$el.find(".prt-command-top").find(".lis-character"+stage.gGameStatus.event_character_num);if(!a.hasClass("mask-black")&&!a.hasClass("mask-black-size-l")&&!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0;var b={raid_id:stage.pJsnData.raid_id,event_type:stage.pJsnData.event.event_type,item_id:stage.gGameStatus.event_use_item_id,character_num:stage.pJsnData.formation[stage.gGameStatus.event_character_num]},c="item_"+stage.gGameStatus.event.item[stage.gGameStatus.event_use_item_id].battle_icon_type,d="temporary_item_result";3==stage.pJsnData.event.event_type&&(d=stage.pJsnData.is_defendorder?"defendorder_temporary_item_result":"event_temporary_item_result");var e=this.getIsReadyToPlayScenario();stage.gGameStatus.attackQueue.queue.push({index:"itemUse",param:b,action:d,iconPath:c,itemType:"EventItem"}),this.AddAttackQueueUI(c),stage.gGameStatus.btn_lock=!1,this.CancelTempItemUse(),e?this.itemUse():stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue()}},UseEventRevivalItem:function(b){if(!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0;var c=a(b.currentTarget).attr("item_id"),d={raid_id:stage.pJsnData.raid_id,event_type:stage.pJsnData.event.event_type,item_id:c,character_num:null},e="temporary_item_result";3==stage.pJsnData.event.event_type&&(e=stage.pJsnData.is_defendorder?"defendorder_temporary_item_result":"event_temporary_item_result");var f=this.getIsReadyToPlayScenario();stage.gGameStatus.attackQueue.queue.push({index:"itemUse",param:d,action:e,itemType:"EventItem"}),stage.gGameStatus.btn_lock=!1,this.$el.find(".btn-revival").css("display","none"),this.popRemove(),f?this.itemUse():stage.gGameStatus.isPlayingScenariosImmediately&&this.InvokeAttackQueue()}},getRecoveryItemsInfo:function(){var a=[{item_kind:"11",item_id:"1",amount:stage.gGameStatus.temporary.small},{item_kind:"11",item_id:"2",amount:stage.gGameStatus.temporary.large},{item_kind:"4",item_id:"1",amount:stage.gGameStatus.potion.count}];return b.isUndefined(stage.gGameStatus.event)||b.isUndefined(stage.gGameStatus.event.item)||(stage.gGameStatus.event.item[1]&&a.push({item_kind:"25",item_id:"1",amount:stage.gGameStatus.event.item[1].number}),stage.gGameStatus.event.item[2]&&a.push({item_kind:"25",item_id:"2",amount:stage.gGameStatus.event.item[2].number}),stage.gGameStatus.event.item[3]&&a.push({item_kind:"25",item_id:"3",amount:stage.gGameStatus.event.item[3].number})),a},getFirstNaviIndex:function(){var a=stage.pJsnData,b=stage.gGameStatus,c=-1;if(void 0===a.navi_information)return c;if(1===+b.serif&&b.auto_attack===!1||1===+a.is_riddle)return 0;var d=this.getForceNaviIndex();return d>=0?d:c},getForceNaviIndex:function(a,c){a=a||stage.pJsnData.navi_information,c=c||0;var d=b.find(b.range(c,b.size(a)),function(b){return 1===+a[b].is_force});return void 0===d&&(d=-1),d},hasForceShowNaviFlag:function(a){var c="1";return b.some(a,function(a){return a.is_force===c})},NaviShow:function(a){a.navi_type&&+a.navi_type===ba&&this.activateMask();var c=a.text||"";"en"===Game.lang&&Game.ua.isIOS()&&Game.ua.versionCompare(Game.ua.os.version,"12")>=0&&(n.isShellApp()||"Mobile Safari"===Game.ua.browser.name)&&(c+="<br>"),Ba===!1&&Ca===!0&&a.is_attack&&(this.doAttackWhenCompleteNavi=!0);var d=this.$el.find(".prt-navi");if(d.find(".img-chara").attr({src:Game.imgUri+"/sp/raid/navi_face/"+a.navi+".png"}),d.find(".prt-advice").html(c),"block"!=d.css("display")&&d.css("display","block"),d.addClass("active display-on"),a.emphasis_character&&a.emphasis_ability){this.naviEmphasis={abilityIndex:a.emphasis_ability,charaIndex:stage.pJsnData.formation.indexOf(a.emphasis_character)};var e=b.find(stage.pJsnData.ability,function(b){return+b.pos===+a.emphasis_character});e.list[a.emphasis_ability][0].emphasis=!0,i.mSetAbility(e,this.naviEmphasis.charaIndex)}this.naviInfoCompleteFlag=!0},NaviNext:function(){var a=this,c=stage.pJsnData.navi_information,d=++stage.pJsnData.navi_index;0==stage.gGameStatus.serif&&0==stage.pJsnData.is_riddle&&(d=this.getForceNaviIndex(c,d)),this.inactivateMask();var e=(c||{})[d];return this.isForceAttackNavi===!0?void this.forceAttackNaviNext(e,d):void(e?(stage.pJsnData.navi_index=d,this.NaviShow(e)):(this.$el.find(".prt-navi").removeClass("active display-on"),this.trigger("naviInfoComplete"),this.naviInfoCompleteFlag=!1,b.isNull(this.naviEmphasis)||this.$el.find(".prt-member").find(".btn-command-character.lis-character"+this.naviEmphasis.charaIndex).addClass("is-emphasis"),this.onFinishNaviInformation(),stage.pJsnData.is_start_battle_navi_first_priority===!0&&stage.gGameStatus.suddenlyAttackDeferred.resolve(),this.doAttackWhenCompleteNavi===!0&&(Ca===!0&&a.switchAttackStatus(!0),a.AttackSwitch())))},forceAttackNaviNext:function(a,b){var c=this,d=this.$el.find(".btn-attack-start"),e=this.$el.find(".prt-attack-start-dummy"),f=function(){},g="display-on",h="display-off",i=1e3,j="se/btn_se_05_dummy_01.mp3";this.$el.find(".prt-navi").removeClass("active "+g),d.hasClass(g)===!1&&stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),this._controlDomAttackButton(!1),a?(stage.pJsnData.navi_index=b,e.off().removeClass(h).addClass(g).one("tap",function(){p.playSE(j),e.removeClass(g).addClass(h),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"),c.NaviShow(a)})):(this.updateBeforeAutoAttackStatus(Ia.NAVI_INFORMATION,Ha.FINISHED),f=function(){d.trigger("tap")},this.playForceTapCjs(f,i))},playForceTapCjs:function(a,b){var c=this,d=stage.pJsnData.dummy_push_attack_cjs,e="canv-force-attack",f={width:640,height:640},g="stageForceAttack",h="containerForceAttack",i={x:300,y:460},j="forceTapCjsTimeout",k=12,l="tap_out";this.playOthersCjs(d,e,f,g,h,i,!1),this.clearTimeoutOne(j),this.setNamedTimeout(j,function(){createjs.Ticker.addEventListener("tick",window[g]),createjs.Tween.get({},{useTicks:!0}).wait(k).call(function(){window[h].children[0][d].gotoAndPlay(l),a()}).wait(window[h].children[0][d][d+"_"+l].timeline.duration).call(function(){c.removeOthersCjsAll()})},b)},popShowMenu:function(){if(!stage.gGameStatus.battle_end){if(!stage.gGameStatus.is_escorted_character_dead&&!stage.gGameStatus.player.all_dead&&stage.gGameStatus.finish)return!0;if(!stage.gGameStatus.force_lose&&!stage.gGameStatus.auto_attack){if(b.has(da,stage.pJsnData.quest_id))return this.popRiddleBattleMenu();var c=[],d={image:qa,alive:"",canNotRevive:!1};c[0]={},c[0].image=Game.imgUri+"/sp/assets/leader/raid_normal/"+stage.pJsnData.player.param[0].pid_image+".jpg",c[0].alive=1==stage.pJsnData.player.param[0].alive?"alive":"dead",c[0].canNotRevive=!stage.pJsnData.player.param[0].resurrection_availble_flag;for(var e=1;6>e;e++)c[e]={},b.isUndefined(stage.pJsnData.player.param[e])?c[e]=d:(c[e].image=Game.imgUri+"/sp/assets/npc/raid_normal/"+stage.pJsnData.player.param[e].pid_image+".jpg",c[e].alive=1==stage.pJsnData.player.param[e].alive?"alive":"dead",c[e].canNotRevive=!stage.pJsnData.player.param[e].resurrection_availble_flag);stage.pJsnData.without_pc&&(c=b.reject(c,function(a,b){return 0==b}),c.push(d));var f=this.countItemOnRail(),g=stage.gGameStatus.temporary.small-(f.TemporarySmall||0),h=stage.gGameStatus.temporary.large-(f.TemporaryLarge||0),i=stage.gGameStatus.potion.count-(f.Potion||0),j={temporary_small:g,temporary_large:h,potion:i,multi:stage.pJsnData.multi,member:c,diagram:stage.gGameStatus.diagram,serif:stage.gGameStatus.serif,effect:stage.gGameStatus.others_effect_display_flag,auto:stage.gGameStatus.auto_attack_display_flag,isSemi:stage.pJsnData.is_semi,isDefendOrder:stage.pJsnData.is_defendorder||!1,isArcarum:stage.pJsnData.is_arcarum||!1,isCoopraid:stage.pJsnData.is_coopraid,isLobby:stage.pJsnData.is_lobby,hideRecover:this.hideRecoverAtMenu,autoType:this.battleAutoType};j.battleOptionsDisplayFlag=!0,j.battleOptionsAssistFlag=stage.pJsnData.multi&&!stage.pJsnData.is_coopraid&&!stage.pJsnData.is_semi,j.battleOptionsChatFlag=(stage.pJsnData.multi||0!=Game.setting.chat_active_notice)&&!stage.pJsnData.is_semi,j.battleOptionsButtonCount=b.reduce([j.battleOptionsDisplayFlag,j.battleOptionsAssistFlag,j.battleOptionsChatFlag],function(a,b){return a+Boolean(b)},0),this.popView=new t({className:"pop-raid-menu",title:D.getMessage("raid_15"),body:b.template(a("#tpl-pop-menu").html(),j),flagBtnCancel:0,flagBtnOk:0}),this.popView.render(),this.$el.find(".pop-raid-menu").find(".prt-popup-footer").append('<div class="btn-usual-close ev-back"></div>'),this.popView.popShow(!0,"5px");var k=this.popView.$el.find(".menu-command-area").find(".btn-withdrow");1==stage.pJsnData.is_coopraid||stage.pJsnData.is_lobby===!0?k.addClass("breakaway"):(stage.pJsnData.is_arcade&&stage.pJsnData.arcade&&stage.pJsnData.arcade.is_bonus||stage.pJsnData.is_special_battle)&&k.remove()}}},popRiddleBattleMenu:function(){var c={questTitle:D.getMessage(da[stage.pJsnData.quest_id].getMessageId)};this.popView=new t({className:"pop-riddle-batle-menu",title:D.getMessage("raid_15"),body:b.template(a("#tpl-pop-riddle-batle-menu").html(),c),flagBtnClose:1}),this.popView.render().popShow(!0,"5px")},AssistSelect:function(b){var c=a(b.currentTarget),d=this.$el.find(".prt-select-assist"),e=this.$el.find(".pop-start-assist").find(".prt-popup-footer").find(".btn-usual-text");c.hasClass("disable")||(1==c.attr("active")?(c.attr({active:0}),stage.gGameStatus.assist[c.attr("type")]=0):(c.attr({active:1}),stage.gGameStatus.assist[c.attr("type")]=1),d.find('.btn-check[active="1"]').length>0&&!stage.pJsnData.is_authority?e.removeClass("disable"):e.addClass("disable"))},checkAllowedRequestAssist:function(a,b){if(stage.pJsnData.is_multi){var c=this,d=new(u.extend({urlRoot:Game.baseUri+"rest/multiraid/assist_check"}));c.stopListening(d),c.listenToOnce(d,"sync",function(a){a.get("is_allowed_to_requesting_assistance")?b():(c.setAssistButtonUnauthorized(),c.popUnauthorizedAssist())}),d.set({raid_id:stage.pJsnData.raid_id}).save()}},handleAssistOn:function(a){var b=this;this.checkAllowedRequestAssist(a,function(){b.AssistOn(a)})},AssistOn:function(c){if(!a(c.currentTarget).hasClass("disable")&&1!=this.assist_flg){this.assist_flg=!0;var e=this;p.playAssistSE();var f=new a.Deferred;this.popView=new t({className:"pop-raid-assist",title:D.getMessage("raid_16"),body:a("#tpl-pop-raid-assist").html(),flagBtnCancel:0,flagBtnOk:1}),this.listenToOnce(this.popView,"ok",function(){e.onFinishRequestAssistPU(),f.resolve(),stage.pJsnData.suddenly_attack_flag&&"resolved"!==stage.gGameStatus.preemptiveDeferred.state()&&stage.gGameStatus.preemptiveDeferred.resolve()}),this.popView.render().popShow(),stage.gGameStatus.assist.all&&(stage.pJsnData.assist[1].is_enable=!1),stage.gGameStatus.assist.friend&&(stage.pJsnData.assist[2].is_enable=!1),stage.gGameStatus.assist.guild&&(stage.pJsnData.assist[3].is_enable=!1),stage.pJsnData.assist.is_first=!1,stage.pJsnData.assist[1].is_enable||stage.pJsnData.assist[2].is_enable||stage.pJsnData.assist[3].is_enable||(this.$el.find(".btn-assist").addClass("disable"),i.mAssistAgain(),stage.pJsnData.invite_enable=0);var g=new d,h={raid_id:stage.pJsnData.raid_id,is_all:stage.gGameStatus.assist.all,is_friend:stage.gGameStatus.assist.friend,is_guild:stage.gGameStatus.assist.guild,is_update_state:1};b.isUndefined(stage.pJsnData.duplicate_key)||(h.duplicate_key=stage.pJsnData.duplicate_key);var j=this;a(c.currentTarget);g.save(h,{url:g.urlRoot("assist","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){j.assist_flg=!1,j.popRemove()},success:function(a){if(j.assist_flg=!1,a.get("finished"))return stage.gGameStatus.finish=!0,stage.gGameStatus.already_finish=!0,void j.popShowRematchFail();var c=a.get("scenario");b.each(c,function(a){switch(a.cmd){case"information":f.done(function(){e.MultiLog({message:a.text,language:a.language})});break;case"temporary":stage.gGameStatus.temporary.small=a.small||0,stage.gGameStatus.temporary.large=a.large||0,stage.gGameStatus.attackQueue.itemNumTmp.TemporarySmall=+stage.gGameStatus.temporary.small,stage.gGameStatus.attackQueue.itemNumTmp.TemporaryLarge=+stage.gGameStatus.temporary.large,i.mUpdateTemporaryItem()}});var d=g.toJSON();b.isUndefined(d.duplicate_key)||(stage.pJsnData.duplicate_key=d.duplicate_key)}})}},postAssistGuildForce:function(){var a=this,b=new d,c={raid_id:stage.pJsnData.raid_id,is_all:0,is_friend:0,is_guild:1,is_update_state:0,duplicate_key:stage.pJsnData.duplicate_key};b.save(c,{url:b.urlRoot("assist","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){a.assistGuildForceDeferred.resolve()},success:function(c){stage.gGameStatus.assist.guild=1,stage.pJsnData.assist[3].is_enable=!1;var d=b.toJSON();stage.pJsnData.duplicate_key=d.duplicate_key,a.assistGuildForceDeferred.resolve()}})},scrollPopShow:function(b){a("#pop-scroll").html(b).show(),this.$el.find(".prt-enemy-gauge").css({"z-index":"20"}),this.$el.find(".btn-raid-menu").removeClass("menu").addClass("close"),window.scrollTo(0,0)},scrollPopHide:function(){a("#pop-scroll").css("display","none").empty(),this.$el.find(".prt-enemy-gauge").css({"z-index":"30"}),this.$el.find(".btn-raid-menu").removeClass("close").addClass("menu");var b=this.$el.find(".cnt-raid");if(0>this.popScrollHeightDelta){var c=+b.css("padding-bottom").replace(/px/g,"")-Math.abs(this.popScrollHeightDelta);b.css("padding-bottom",c+"px"),this.popScrollHeightDelta=0}window.scrollTo(0,0)},handleBattleOptionSetting:function(b){var c=a(b.currentTarget);if(!(stage.gGameStatus.attackQueue.queue.length>0)){var d=this,e=new(x.extend({urlRoot:Game.baseUri+this.getRaidType()+"/setting"}));this.handleBattleOptionSetting=function(){var a=function(a){d.popSettingBattleDisplay(a)};c.hasClass("assist")?a=function(a){d.popSettingBattleAssist(a)}:c.hasClass("chat")&&(a=function(a){d.popSettingBattleChat(a)}),d.stopListening(e),d.listenToOnce(e,"sync",a),e.fetch()},this.handleBattleOptionSetting()}},changeAutoType:function(){var b=this,c=new(u.extend({urlRoot:Game.baseUri+"/rest/raid/auto_setting"})),d=+a("#frm-auto-type").find("input:checked").val();this.trigger(Lb),this._outAutoButton(),this._noInteractiveAutoButton(),c.save({value:d,is_multi:!!stage.pJsnData.is_multi,raid_id:stage.pJsnData.raid_id}).done(function(){b.battleAutoType=d,stage.gGameStatus.diagram||d!==Va.FULL||stage.gGameStatus.player.all_dead||b.showAutoButton(),b.trigger(Mb)})},popSettingBattleDisplay:function(c){this.popView&&this.popRemove();var d=c.toJSON();d.diagram=stage.gGameStatus.diagram,d.serif=stage.gGameStatus.serif,d.effect=stage.gGameStatus.others_effect_display_flag,d.cjs_mode=Game.setting.cjs_mode,d.currentFps=this.currentFps,d.coating=stage.gGameStatus.is_show_coating_value,stage.pJsnData.is_multi&&(d.notification=Game.setting.rtn_mode),d.auto=stage.gGameStatus.auto_attack_display_flag,this.popView=new t({className:"pop-setting-display",title:D.getMessage("raid_setting_1"),body:b.template(a("#tpl-pop-setting-display").html(),d),flagBtnClose:1}),this.popView.render().popShow()},popSettingBattleAssist:function(c){this.popView&&this.popRemove();var d=c.toJSON();this.popView=new t({className:"pop-setting-assist",title:D.getMessage("raid_setting_2"),body:b.template(a("#tpl-pop-setting-assist").html(),d),flagBtnClose:1}),this.popView.render().popShow()},popSettingBattleChat:function(c){this.popView&&this.popRemove();var d=c.toJSON();d.chat_active_notice=Game.setting.chat_active_notice,d.chat_active_notice_onbattle=Game.setting.chat_active_notice_onbattle,d.voice_stamp=stage.gGameStatus.voiceStamp,this.popView=new t({className:"pop-setting-chat",title:D.getMessage("raid_setting_3"),body:b.template(a("#tpl-pop-setting-chat").html(),d),flagBtnClose:1}),this.popView.render().popShow()},handleSettingPostData:function(b){this.trigger("xhrStart");var c=a(b.currentTarget),d={},e="";if(c.hasClass("assist"))e=this.$el.find(".pop-setting-assist"),d.is_skip_to_request_assistance=+e.find('input[name="assist-pop-force"]:checked').val(),d.is_guests_allowed_to_request_assistance=+e.find('input[name="allow-assist"]:checked').val();else if(c.hasClass("chat")){e=this.$el.find(".pop-setting-chat");var f,g=e.find('input[name="show-others-stamp"]');f=0===g.length?Game.setting.chat_stamp:g.prop("checked")===!0?1:0;var h=+e.find('input[name="guild-chat-active-notice-onbattle"]:checked').val();h=0===h||1===h?h:Game.setting.chat_active_notice_onbattle;var i,j=e.find('input[name="voice-stamp"]');i=0===j.length?stage.gGameStatus.voiceStamp:j.prop("checked")===!0?1:0,d.voice_stamp=i,d.chat_stamp=f,d.guild_chat_active_notice_onbattle=h}else e=this.$el.find(".pop-setting-display"),d.summon_speed=+e.find('input[name="summon-speed"]:checked').val(),stage.pJsnData.is_multi&&(d.rtn_mode=+e.find('input[name="realtime-notification"]:checked').val(),d.is_multi_ability_notification=+e.find('input[name="multi-ability-notification"]:checked').val());this.postBattleSetting(d,0)},postBattleSetting:function(b,c){var d=this,e=Object.keys(b),f=e[c],g=b[f],h=new(u.extend({urlRoot:Game.baseUri+this.getRaidType()+"/setting"}));d.stopListening(h),d.listenToOnce(h,"sync",function(){switch(f){case"summon_speed":stage.gGameStatus[f]=g;break;case"rtn_mode":Game.setting[f]=g,d.setRtnMode();break;case"voice_stamp":stage.gGameStatus.voiceStamp=g;break;case"chat_stamp":Game.setting[f]=g;break;case"guild_chat_active_notice_onbattle":Game.setting.chat_active_notice_onbattle=g,1===g?Game.chatView.openGuildChannelForActiveNotice():(Game.chatView.resetActiveNoticeQueue(),Game.chatView.destroyActiveNoticeSocket())}e.length<=c+1?(d.popRemove(),d.trigger("xhrEnd")):a(document).one("ajaxStop",function(){d.postBattleSetting(b,c+1)})}),h.set({set:f,value:g}).save()},popShowMypage:function(){var b;b=1==stage.pJsnData.is_coopraid?a("#tpl-mypage-coop").html():stage.pJsnData.is_defendorder?a("#tpl-mypage-defend-order").html():stage.pJsnData.is_semi?a("#tpl-mypage-semi").html():1==stage.pJsnData.multi?a("#tpl-mypage-multi").html():a("#tpl-mypage").html(),this.popView.popClose(),this.popView=new t({className:"pop-mypage",title:D.getMessage("raid_18"),body:b,flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),this.$el.find(".pop-mypage").find(".btn-usual-ok").attr({"data-href":"mypage"}),this.popView.popShow()},popConfirmLocationEvent:function(){this.popView.popClose(),this.popView=new t({className:"pop-location-event",title:D.getMessage("raid_19"),body:a("#tpl-pop-location-event").html(),flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),this.popView.$el.find(".btn-usual-ok").attr("data-href","surprise/limited_battle"),this.popView.popShow()},popConfirmLocationEventWithdraw:function(){this.popView.popClose(),this.popView=new t({className:"pop-location-event-withdraw",title:D.getMessage("raid_19"),body:a("#tpl-pop-location-event").html(),flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),this.popView.$el.find(".btn-usual-ok").attr("data-href","surprise/limited_battle"),this.popView.popShow()},popConfirmLocationDo:function(){this.popView.popClose(),this.popView=new t({className:"pop-location-defend-order",title:D.getMessage("raid_do_1"),body:a("#tpl-pop-location-defend-order").html(),flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),this.popView.$el.find(".btn-usual-ok").attr("data-href","defend_order/island/"+stage.pJsnData.defendorder_location_id+"/"+stage.pJsnData.defendorder_id),this.popView.popShow()},popConfirmLocationDoWithdraw:function(){var b=stage.pJsnData.is_defendorder?[1,0]:[0,1];this.popView.popClose(),this.popView=new t({className:"pop-location-defend-order-withdraw",title:D.getMessage("raid_do_1"),body:a("#tpl-pop-location-defend-order").html(),flagBtnClose:b[0],flagBtnCancel:b[1],flagBtnOk:1}),this.popView.render(),this.popView.$el.find(".btn-usual-ok").attr("data-href","defend_order/island/"+stage.pJsnData.defendorder_location_id+"/"+stage.pJsnData.defendorder_id),this.popView.popShow()},popShowithdraw:function(a){stage.gGameStatus.attackQueue.queue.length>0||(b.isNull(this.subArcarumTutorialRaidView)===!1?this.subArcarumTutorialRaidView.trigger("tapWithdraw"):stage.pJsnData.is_arcarum?this.popConfirmArcarumWithdraw():stage.pJsnData.is_board?this.popShowithdrawSingle():stage.pJsnData.is_sequence?this.popConfirmSequenceWithdraw():stage.pJsnData.is_lobby?this.getLobbyRoomData():stage.pJsnData.is_defendorder?this.popConfirmLocationDoWithdraw():1!=stage.pJsnData.multi||stage.pJsnData.is_semi?stage.pJsnData.is_semi?this.popConfirmLocationEventWithdraw():this.popShowithdrawSingle():this.popShowithdrawMulti())},popShowithdrawSingle:function(){var c,d={lupi:stage.pJsnData.lupi,treasure1:stage.pJsnData.treasure.treasure_type_1,treasure2:stage.pJsnData.treasure.treasure_type_2,treasure3:stage.pJsnData.treasure.treasure_type_3,treasure4:stage.pJsnData.treasure.treasure_type_4,treasure5:stage.pJsnData.treasure.treasure_type_5,temporary_small:stage.gGameStatus.temporary.small,temporary_large:stage.gGameStatus.temporary.large,multi:stage.pJsnData.multi,use_ap:this.use_ap};if(c=stage.pJsnData.is_trialbattle?a("#tpl-pop-withdraw-trialbatle").html():b.template(a("#tpl-pop-withdraw").html(),d),a("#next-revenge-bonus-action-param").length>0&&(c+=b.template(a("#tpl-revenge-bonus-pop-retire").html(),{revengeBonusParam:a("#next-revenge-bonus-action-param").val(),revengeBonusMax:a("#next-revenge-bonus-max-param").val()||"200",revengeBonusCount:a("#next-revenge-bonus-count").val(),isUseAp:!1,useAp:null,isRetired:!1})),this.popView&&this.popView.popClose(),this.popView=new t({className:"pop-result-withdraw single",title:D.getMessage("raid_20"),body:c,flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow(!0,"50px"),1==stage.pJsnData.is_coopraid){var e=this.$el.find(".pop-result-withdraw"),f=e.html().replace(new RegExp(D.getMessage("raid_21"),"g"),D.getMessage("raid_22"));e.html(f).find(".btn-usual-ok").addClass("coop")}},popShowithdrawMulti:function(){if(this.popView.popClose(),this.popView=new t({className:"pop-result-withdraw",title:D.getMessage("raid_20"),body:b.template(a("#tpl-pop-withdraw-multi").html(),{isSemi:stage.pJsnData.is_semi||!1}),flagBtnClose:1,flagBtnOk:0}),this.popView.render().popShow(!0,"50px"),1==stage.pJsnData.is_coopraid){var c=this.$el.find(".pop-result-withdraw"),d=c.html().replace(new RegExp(D.getMessage("raid_21"),"g"),D.getMessage("raid_22"));c.html(d).find(".btn-usual-ok").addClass("coop")}},popConfirmArcarumWithdraw:function(){this.popView&&this.popView.popClose(),this.popView=new t({className:"pop-result-withdraw-arcarum",title:D.getMessage("raid_20"),body:a("#tpl-pop-withdraw-arcarum").html(),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow(!0,"50px")},popConfirmSequenceWithdraw:function(){this.popView&&this.popView.popDelete(),this.popView=new t({className:"pop-result-withdraw sequence",title:D.getMessage("raid_20"),body:b.template(a("#tpl-pop-result-withdraw-sequence").html(),{isOpenEvent:+stage.pJsnData.event_status===G.EVENT_STATUS.START}),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow(!0,"50px")},getLobbyRoomData:function(){var a=this,b=new(x.extend({urlRoot:Game.baseUri+"rest/multiraid/lobby_room_data/"+stage.pJsnData.raid_id}));this.stopListening(b,"sync"),this.listenTo(b,"sync",function(b){var c=b.toJSON();a.popConfirmLobbyWithdraw(c),a.trigger("xhrEnd")}),this.getLobbyRoomData=function(){a.trigger("xhrStart"),b.fetch()},this.getLobbyRoomData()},popConfirmLobbyWithdraw:function(c){var d=this,e=null,f=0,g="";c.is_continuequest===!0&&c.lobby_room_data.is_decrement_quest_daily===!0&&(g=" is-decrement-quest-daily",e="btn-mypage",f=1),this.popView.popClose(),this.popView=new t({className:"pop-result-withdraw"+g,title:D.getMessage("raid_20"),body:b.template(a("#tpl-pop-withdraw-multi-lobby").html(),{lobbyRoomData:c}),flagBtnClose:1,flagBtnOk:f,btnOkClassName:e,showStartCallback:function(){c.is_continuequest===!0&&c.lobby_room_data.is_decrement_quest_daily===!0&&d.popView.$el.find(".btn-usual-ok").removeClass("btn-usual-ok").attr("data-href","mypage")}}),this.popView.render().popShow(!0,"50px")},Withdraw:function(){var a=this;if(!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0,stage.gGameStatus.menu="temporary",stage.gGameStatus.retire=!0,this.popView&&this.popView.popRemove(),this.setNamedTimeout(W,a.hideMask(),240);var b={raid_id:stage.pJsnData.raid_id};a.Attack("retire",b)}},popWithdrawCancel:function(){!stage.gGameStatus.clear&&stage.gGameStatus.finish?(this.popView.popClose(),this.LosePopShow()):this.popView.popRemove()},popWithdrawClose:function(){if(stage.gGameStatus.is_escorted_character_dead||stage.gGameStatus.player.all_dead){!stage.gGameStatus.clear&&stage.gGameStatus.finish&&a(".btn-revival").show(),!stage.pJsnData.is_multi||stage.pJsnData.is_semi&&stage.pJsnData.is_defendorder||this.showChatIcon(),stage.pJsnData.is_multi&&stage.gGameStatus.diagram&&this.$el.find(".img-diagram").removeClass("display-off").addClass("display-on");var b=this.$el.find("img-score");"undefined"!=typeof stage.pJsnData.survival&&stage.pJsnData.survival.score_buff&&!b.hasClass("display-off")&&b.addClass("display-on"),ha(stage.pJsnData.bgm),stage.gGameStatus.shouldPlayFixedBGM=!1}},popShowItem:function(){if(stage.gGameStatus.abilityRailUse!==Qa.OFF||1!==stage.gGameStatus.attacking){var c=this.countItemOnRail(),d=stage.gGameStatus.potion.count-(c.Potion||0);if(stage.pJsnData.is_trialbattle||!(0>=d)){if(stage.gGameStatus.potion.limit_flg&&stage.gGameStatus.potion.limit_remain<=0)return void this.popPotionLimitOver();var c=this.countItemOnRail(),e=stage.gGameStatus.potion.count-(c.Potion||0),f={confirm:"normal",before:e,after:e-1,item_name:stage.pJsnData.is_trialbattle?D.getMessage("raid_trial_1"):stage.gGameStatus.potion.item_name,cheer:!1,potion_limit:{number:stage.gGameStatus.potion.limit_number,remain:stage.gGameStatus.potion.limit_remain}};this.popView.popClose(),this.popView=new t({className:"pop-item-confirm",title:D.getMessage("raid_23"),body:b.template(a("#tpl-pop-use-item").html(),f),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow(!0,"50px");for(var g=!1,h=0,i=stage.pJsnData.player.param.length;i>h;h++){if(1!=stage.pJsnData.player.param[h].alive){g=!0;break}stage.pJsnData.player.param[h].hp<stage.pJsnData.player.param[h].hpmax&&(g=!0)}0==g&&a(".pop-item-confirm .txt-notice").show()}}},popPotionLimitOver:function(){var c={potion_limit:{number:stage.gGameStatus.potion.limit_number,remain:stage.gGameStatus.potion.limit_remain},lose_pop_flg:y.get("lose_pop_flg"),isNoLongerAllowedElixir:!!stage.gGameStatus.potion.isNoLongerAllowedElixir};this.popView=new t({className:"pop-limit-over",title:D.getMessage("raid_24"),body:b.template(a("#tpl-pop-potion-limit").html(),c),flagBtnCancel:0,flagBtnOk:0}),this.popView.render();var d=this.$el.find(".pop-limit-over"),e=d.find(".prt-popup-footer");stage.pJsnData.is_multi?e.append('<a href="javascript:void(0);" class="btn-close">'+D.getMessage("raid_25")+"</a>"):(d.find(".txt-single").show(),stage.gGameStatus.player.all_dead||!b.isUndefined(stage.pJsnData.battle_condition)&&1==stage.gGameStatus.lose||+stage.gGameStatus.is_escorted_character_dead===la?e.append('<a href="javascript:void(0);" class="btn-withdraw-single">'+D.getMessage("raid_26")+"</a>"):e.append('<a href="javascript:void(0);" class="btn-close">'+D.getMessage("raid_25")+"</a>")),this.popView.popShow(!0,"50px")},popCheer:function(){this.$el.find(".prt-tips").css("display","none"),this.popView&&this.popView.popRemove(),this.popView=new t({className:"pop-cheer",title:D.getMessage("raid_27"),body:b.template(a("#tpl-cheer").html(),{cheer_effect_text:stage.pJsnData.cheer_effect_text}),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.$el.find(".pop-cheer").find(".prt-popup-footer").append('<a href="javascript:void(0);" class="btn-cheer">'+D.getMessage("raid_28")+"</a>"),this.popView.popShow(!0,"50px"),y.set("cheer_pop_flg","1"),this.temp_cheer_pop_flg=!0},CheerSend:function(){this._sendCheer()},_sendCheer:function(){var a=new(u.extend({urlRoot:Game.baseUri+this.getRaidType()+"/cheer"}));this._sendCheer=function(){var b=this;a.save({raid_id:stage.pJsnData.raid_id},{success:function(){b.broadcastChatLog({userId:stage.pJsnData.user_id,viewerId:stage.pJsnData.viewer_id,chatId:O,categoryId:O}),b.popCheerComplete()},error:function(){b.LosePopShow()},silent:!0})},this._sendCheer()},popCheerComplete:function(){var b=new t({className:"pop-cheer",title:D.getMessage("raid_29"),body:a("#tpl-cheer-compleate").html(),flagBtnCancel:0,flagBtnOk:1});this.popCheerComplete=function(){stage.pJsnData.cheer_status=!1,b.render().popShow(!0,"50px"),this.popView=b,stage.gGameStatus.cheer_compleate=!0,y.set("cheer_already","1"),this.temp_cheer_already=!0},this.popCheerComplete()},LosePopShow:function(){var c=this,d=window.stage,e=d.gGameStatus;if(b.isNull(this.subArcarumTutorialRaidView)===!1){var f=function(){c.Withdraw()};return void this.subArcarumTutorialRaidView.popLoseWithdraw(f)}y.set("lose_pop_flg","1"),null!=y.get("cheer_compleate")?("true"==y.get("cheer_compleate")?e.cheer_compleate=!0:e.cheer_compleate=!1,d.pJsnData.cheer_effect_text=y.get("cheer_effect_text")):"1"==y.get("cheer_already")&&1!=this.temp_cheer_already&&(e.cheer_compleate=!1),null!=this.lose_cheer_flg&&this.stone_change_flg&&(e.cheer_compleate=this.lose_cheer_flg);var g=e.cheer_compleate;if(this.lose_cheer_flg=g,y.set("cheer_compleate",g),y.set("cheer_effect_text",d.pJsnData.cheer_effect_text),this.lose_cheer_flg&&this.stone_change_flg&&(this.lose_cheer_flg=!1),this.stone_change_flg=!1,e.cheer_compleate=!1,this.$el.find(".prt-tips").css("display","none"),e.pop_limit=!1,d.pJsnData.is_arcarum){Nb=0===+this.arcarumRestTp;var h=d.gGameStatus.player.all_dead;if(Nb&&h)this.popArcarumDeadNoTp();else if(Nb)this.popShowArcarumGameOver();else{var i={arcarum:d.pJsnData.arcarum};this.popView=new t({className:"pop-continue-arcarum",title:D.getMessage("raid_30"),body:b.template(a("#tpl-pop-continue-arcarum").html(),i),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow(!0,"50px")}}else{if(d.pJsnData.is_board&&(Nb=0===+this.restTp))return void this.popShowBoardGameOver();var j,k,l=!1,m=e.event;b.isUndefined(m)||(j=3==m.event_type?3:5,k=m.item[j],k.number>0&&(l=!0));var n=e.potion,o=!1;if(n.limit_flg&&n.limit_remain<=0){if(o=!0,d.pJsnData.no_recovery_popup)return void this.showNextWithoutRecoveryPopup();if(!d.pJsnData.is_defendorder||!l)return void this.popPotionLimitOver()}if(!d.pJsnData.is_trialbattle&&0==n.count){var p=!1;if(b.isUndefined(m)?p=!0:m.item[j].number<=0&&(p=!0),p)return this.popView=new t({className:"pop-result-use-potion",title:D.getMessage("raid_30"),body:b.template(a("#tpl-pop-no-item").html(),{cheer:g,cheer_effect_text:y.get("cheer_effect_text")}),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow(!0,"50px"),void(e.stone<parseInt(e.shopLowestPrice)&&this.$el.find(".btn-stone").addClass("disable"))}if(!b.isUndefined(m)){var i={before:n.count,after:n.count>0?n.count-1:0,item_name:n.item_name,event_item:k,isLimitedPotion:o,potionLimitNumber:n.limit_number,can_use_event_item:d.pJsnData.event_coopraid_name?!1:!0};return this.popView=new t({className:"pop-continue-event",title:D.getMessage("raid_30"),body:b.template(a("#tpl-pop-continue-event").html(),i),flagBtnCancel:1,flagBtnOk:0}),void this.popView.render().popShow(!0,"50px")}var i={confirm:"lose",before:n.count,after:n.count-1,item_name:d.pJsnData.is_trialbattle?D.getMessage("raid_trial_1"):n.item_name,cheer:g,cheer_effect_text:y.get("cheer_effect_text"),
potion_limit:{number:n.limit_number,remain:n.limit_remain}};this.popView=new t({className:"pop-result-use-potion",title:D.getMessage("raid_30"),body:b.template(a("#tpl-pop-use-item").html(),i),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow(!0,"50px")}},popShowRevival:function(){stage.gGameStatus.pop_revival=!0,this.LosePopShow()},popLoseCancel:function(){this.popView.popClose(),this.popShowithdraw()},popShowExchange:function(c){if(!a(c.currentTarget).hasClass("disable")){var d=stage.gGameStatus.shopPotionId;this.article=new(x.extend({urlRoot:Game.baseUri+"shop/article/"+d}));var e=this;this.article.listenToOnce(this.article,"sync",function(c){var d=c.attributes;e.popView=new t({className:"pop-exchange",title:D.getMessage("raid_31"),body:"",flagBtnCancel:1,flagBtnOk:0}),e.popView.render(),e.popView.$el.find(".prt-popup-footer").append("<div class='btn-usual-exchange'></div>"),e.popView.$el.find(".txt-popup-body").html(b.template(a("#tpl-pop-exchange").html(),d)),e.popView.popShow(!0,"50px"),e.setBuyNum(),e.trigger(Mb)}),this.article.fetch(),this.stone_change_flg=!0,this.trigger(Lb)}},buyItem:function(){var a=this,b=new(u.extend({urlRoot:Game.baseUri+"shop/purchase/"}));this.buyItem=function(){this.trigger(Lb);var c=a.$el.find(".num-set").find(":selected").val(),d=stage.gGameStatus.shopPotionId,e=a.$el.find(".pop-exchange").find(".txt-popup-body").html(),f=a.$el.find(".cnt-confirm").data("duplicate-key")+"_"+d+"_"+c;b.set({article_id:d,duplicate_key:f,num:c}),this.listenToOnce(b,"sync",function(a){this.popView&&this.popView.popRemove(),this.stopListening(this.purchase),this.purchase.stopListening(),this.render_result(a,e)}),this.listenToOnce(b,"error",function(){this.popView&&this.popView.popRemove(),this.stopListening(this.purchase),this.purchase.stopListening(),this.error_message()}),b.save(),this.purchase=b},this.buyItem()},error_message:function(){var a=this,b=new t({className:"pop-exchange",title:D.getMessage("raid_32"),body:"",flagBtnCancel:1,flagBtnOk:0});this.error_message=function(){b.render(),a.$el.find(".pop-confirm").find(".txt-popup-body").html(D.getMessage("raid_33")),b.popShow(),this.popView=b,this.trigger(Mb)},this.error_message()},render_result:function(a,b){var c=new t({className:"pop-exchange",title:D.getMessage("raid_34"),body:b,flagBtnCancel:0,flagBtnOk:1});c.render();var d=a.attributes,e=c.$el;this.$el.find(".pop-result").find(".item-explain").css("display","none"),e.find(".cnt-confirm").children("div").slice(2,5).css("display","none"),e.find(".btn-usual-cancel").css("display","none"),e.find(".result").html(D.replaceMessage("raid_35",[d.num])),c.popShow(!0,"50px"),this.popView=c;var f=stage.gGameStatus;f.potion.count=d.num,f.stone-=+e.find(".item-price").attr("price"),this.trigger(Mb)},setBuyNum:function(){var a=this.$el.find(".pop-exchange").find(".item-price").attr("price"),b=stage.gGameStatus.stone;this.$el.find(".before-money").html(""+b),this.$el.find(".after-money").html(""+(b-a*this.$el.find(".num-set").children(":selected").val()))},popItemCancel:function(a){1!=stage.gGameStatus.pop_limit&&(stage.gGameStatus.is_escorted_character_dead?(this.popView.popClose(),this.popShowithdraw(a)):stage.gGameStatus.pop_revival||!stage.gGameStatus.is_multi&&!stage.gGameStatus.player.all_dead?this.popView.popRemove():stage.pJsnData.is_special_battle?(this.popView.popRemove(),this.popWithdrawClose()):stage.pJsnData.is_board?(this.popView.popClose(),this.popBoardRetire()):(this.popView.popClose(),this.popShowithdraw(a)))},locationShop:function(){y.set("return_raid_url",location.hash),this.content_close(),w.hash("#shop",{refresh:!0})},popHideSelectMember:function(a){var b=this.$el.find(".pop-select-member");this.hideMask(),b.css("display","none").trigger("hide")},SelectMember:function(b){var c=a(b.currentTarget).attr("pos"),d=pCharacterPos;stage.pJsnData.without_pc&&(d=stage.gGameStatus.abilityCharacterNum);var e=+stage.gGameStatus.attackQueue.$useAbilityTmp.children().attr("ability-attribute").split(",")[0];if(!this.checkAbilityTargetError(stage.gGameStatus.ability_pick,c,e,d)){stage.gGameStatus.motion=!0;var f=this.$el.find(".btn-ability-use"),g={raid_id:stage.pJsnData.raid_id,ability_aim_num:c,ability_id:f.attr("ability-id"),ability_character_num:f.attr("ability-character-num")};this.AddAbilityQueue(g,!0),this.popHideSelectMember()}},popShowAbility:function(c){function d(a){(parseInt(a,10)>0||m.hasClass("tmp-mask"))&&n.$el.find(".btn-ability-use").css("display","none"),M.find(".hideable").css("display","none"),n.$el.find(".txt-select-chara").html(D.getMessage("raid_41"))}function e(a){a=b.reject(a,function(a,b){return 0==b});var c=a.length,d=c+1,e=M.find(".prt-character").find(".lis-character"+c);e.children(".img-chara-command").attr("src",qa),e.children(".ico-type").removeClass().addClass("ico-type");for(var f=0;d>f;f++)M.find(".prt-character").find(".lis-character"+f).attr("pos",f+1);return a}function f(a,b){var c=2===a.form&&a.extra_attr>0?a.extra_attr:a.attr;b.find(".ico-type").removeClass(function(a,b){return(b.match(/ico-attribute-\d*/)||[]).join(" ")}).addClass("ico-attribute-"+c)}function g(a,c,d){var e=Math.ceil(a.hp/a.hpmax*100),f=25>=e?"red":"green",g=d.find(".txt-hp-value"),h=d.find(".txt-coating-value"),i=d.find(".prt-gauge-hp-inner");i.css("width",e+"%").attr({color:f}),g.html(""+a.hp).attr({color:f}),!a.condition.hide_hp_flag||1!=a.alive||b.indexOf(stage.pJsnData.formation,String(c))<0?(g.removeClass(ja),h.removeClass(ja)):(g.addClass(ja),h.addClass(ja))}function h(a,b,c){var d=parseInt(a.recast,10);c.find(".prt-gauge-special-inner").css("width",d+"%"),b&&c.find(".prt-percent").html('<span class="txt-gauge-value">'+d+"</span>%"),c.find(".hideable").show()}function i(a,b){1==a.leader?b.children("img").attr("src",Game.imgUri+"/sp/assets/leader/raid_normal/"+a.pid_image+".jpg"):b.children("img").attr("src",Game.imgUri+"/sp/assets/npc/raid_normal/"+a.pid_image+".jpg")}function j(a,c){b.indexOf(stage.pJsnData.formation,String(a))<0?M.find(".prt-sub-character").append(c):M.find(".prt-character.main ").append(c)}function k(a,b,c){c.toggleClass(b,a)}function l(a,c){for(var d=b.find(stage.pJsnData.ability,function(b){return+b.pos===a}),e=null,f=1;4>=f;f+=1)e=c.find(".prt-ability-state").find(".ability"+f),d&&d.list[f]?e.attr({state:0===+d.list[f][0]["ability-recast"]?"2":"1",type:d.list[f][0]["icon-type"]}):e.attr({state:0}).removeAttr("type")}if(2!=stage.gGameStatus.chara_select){var m=a(c.currentTarget),n=this,o=m.children().attr("ability-attribute"),p=0,q=0,r=0;if(!(this.isFullAutoAttacking()===!0&&"normal_attack_result"===stage.gGameStatus.attack_action||(m||n.popShowAbilityRailError("raid_82","raid_83"),m.find("div:first").hasClass("ico-ability")||(stage.gGameStatus.$use_ability=m,stage.gGameStatus.$use_cancel_ability=m,stage.gGameStatus.btn_lock)))){stage.gGameStatus.attackQueue.$useAbilityTmp=m;var s=m.children().attr("ability-name"),t=m.children().attr("text-data"),u=m.children().attr("ability-id"),v=m.children().attr("ability-character-num"),w=m.children().attr("ability-recast"),x=m.children().attr("ability-pick"),y=m.children().attr("recaset-default"),z=m.children().attr("duration"),A=m.children().attr("duration-second"),B=m.children().attr("duration-type"),C=m.children().attr("start_skill_set_recast")||null,E=m.children().attr("recaset-default")||null,F=m.children().attr("recast-additional-comment"),G=m.children().attr("emphasis"),H=!1,I="undefined"!=typeof o?+o.split(",")[0]:null,J=m.hasClass("ability-disable");stage.gGameStatus.ability_pick=x,pCharacterPos=b.indexOf(stage.pJsnData.formation,String(v)),stage.gGameStatus.abilityCharacterNum=v,stage.gGameStatus.abilityAttribute=I,this.abilityEmphasis=G||!1;var K=b.some(stage.pJsnData.ability,function(a){return"player"===a.mode&&+a.list[1][0]["ability-id"]===+u});K===!0&&(stage.gGameStatus.attackQueue.gUseAbility=[Oa+c.x,Pa+c.y]);var L=null;if(J===!0)L=".prt-ability-stamped";else if(b.contains([Ka.RESURRECTION,Ka.SINGLE_HEALING,Ka.SINGLE_BUFF,Ka.CHARGE_BAR_ASSIGNMENT,Ka.HOSTILITY_ASSIGNMENT,Ka.ATTRIBUTE_SINGLE,Ka.ATTRIBUTE_SINGLE_EXCEPT_OWN],+x)&&1>w&&!m.hasClass("tmp-mask"))L=".pop-select-member",a(L+" .prt-percent").empty();else if(x==Ka.NINJA_JITSU||x==Ka.MAGIC_CIRCLE)L=".pop-ability-mark";else if(x==Ka.SECRET_GEAR&&1>w&&!m.hasClass("tmp-mask"))L=".pop-ability-hiddenweapon",this.abilityHiddenweaponDetail={name:s,effect:t};else if(x==Ka.USE_LUPIE)L=".pop-ability-lupiflip";else if(x==Ka.SWITCH_POSITION&&1>w&&!m.hasClass("tmp-mask"))L=".pop-ability-orderchange";else{if(0==stage.gGameStatus.ability_popup&&(w>0||m.hasClass("tmp-mask")))return;L=".prt-ability-dialog"}var M=this.$el.find(L);M.removeClass("sub-selecter");var N=stage.pJsnData.player.param[v];if(stage.gGameStatus.abilityRailUse!==Qa.OFF||!stage.gGameStatus.attacking||!b.contains(Ka,+x)){if(m.children().attr("ability-multi")&&(t+='<br><span class="red">'+D.getMessage("raid_36")+"</span>"),M.attr("type","ability"),u>0){var O=t.split("（"),P=O[0],Q="",R="";b.isNull(C)===!1&&C>0&&b.isNull(E)===!1?(+E!==ka?Q=D.replaceMessage("start_recast_1",[C],+C):(Q=D.getMessage("start_recast_3"),L=".prt-ability-stamped",H=!0,M=this.$el.find(L),M.removeClass("sub-selecter").attr("type","ability")),R="has-start-recast"):b.isNull(C)===!1&&0===+C&&b.isNull(E)===!1&&+E===ka?(Q=D.getMessage("start_recast_2"),R="has-start-recast"):Q=D.getMessage("raid_37")+y+D.getMessage("raid_78",y),F&&(Q+=F),M.find(".time").toggleClass("has-recast-additional-comment",!!F);var S=M.find(".duration");M.find(".name").html(s),M.find(".effect").html(t),M.find(".recast").html(Q).removeClass("has-start-recast").addClass(R),""!=z&&""!=A?S.html(D.getMessage("raid_38")+z+D.getMessage("raid_78",z)+"/"+A+D.getMessage("raid_79")):""!=z?""!==B?S.html(D.getMessage("raid_38")+z+B):S.html(D.getMessage("raid_38")+z+D.getMessage(z>1?"raid_78":"raid_39")):""!=A?S.html(D.getMessage("raid_38")+A+D.getMessage("raid_79")):S.html(""),a(".btn-ability-use").attr({"ability-id":u,"ability-character-num":v,"ability-name":P});var T=m.children();M.find(".prt-icon>div").removeClass().addClass(T.attr("class")).html(T.html())}var U=M.find(".txt-used-start-recast"),V=M.find(".txt-ability-stamped");if(U.removeClass("show"),V.removeClass("hide"),J===!0||H===!0)M.find(".prt-icon").removeClass("ability-disable").addClass("ability-disable"),H===!0&&(U.addClass("show"),V.addClass("hide"));else if(x==Ka.RESURRECTION)for(d(w),p=0,q=stage.pJsnData.player.param.length;q>p;p++){var W=stage.pJsnData.player.param[p];if(!b.isUndefined(W)){var X=this.$el.find(".prt-character").find(".lis-character"+p);f(W,X),X.find(".hideable").css("display","none"),i(W,X),k(1==W.alive,"mask-black",X),X.toggleClass("mask-can-not-revive",!W.resurrection_availble_flag)}}else if(b.contains([Ka.SINGLE_HEALING,Ka.SINGLE_BUFF,Ka.ATTRIBUTE_SINGLE,Ka.ATTRIBUTE_SINGLE_EXCEPT_OWN],+x)){d(w);var Y,Z,$=b.clone(stage.pJsnData.player.param);for(stage.pJsnData.without_pc&&($=e($)),p=0,r=$.length;r>p;p++){var W=$[p];if(!b.isUndefined(W)){var X=M.find(".prt-character").find(".lis-character"+p);Z=stage.pJsnData.without_pc?+p+1:p,f(W,X),g(W,Z,X),h(W,!1,X),i(W,X),l(Z,X),Y=!!(b.indexOf(stage.pJsnData.formation,String(Z))<0),Y=Y||0==W.alive||W.hp<1,Y=Y||+x===Ka.SINGLE_HEALING&&W.hp>=W.hpmax,Y=Y||+x===Ka.ATTRIBUTE_SINGLE&&+W.attr!=I,Y=Y||+x===Ka.ATTRIBUTE_SINGLE_EXCEPT_OWN&&(+v===Z||+W.attr!=I),k(Y,"mask-black",X)}}}else if(x==Ka.NINJA_JITSU||x==Ka.MAGIC_CIRCLE){var _=this.$el.find(".pop-ability-mark");this.setActionAbility(u);var aa=3===+x?"prt-ninja-mark":"prt-magic-circle",ba=3===+x?D.getMessage("raid_ability_mark_1"):D.getMessage("raid_ability_mark_3"),ca=3===+x?D.getMessage("raid_ability_mark_2"):D.getMessage("raid_ability_mark_4");_.find(".prt-ability-mark").addClass(aa),_.find(".txt-info").html(ca),_.find(".btn-usual-text").html(ba),this.isKeepAbilitySubParam||(_.find(".prt-ability-mark div").removeClass("active first second"),_.find(".btn-usual-text").addClass("disable")),this.isKeepAbilitySubParam=!1,parseInt(w)>0||m.hasClass("tmp-mask")?_.find(".btn-usual-text, .prt-ability-mark, .txt-info").css("display","none"):_.find(".btn-usual-text, .prt-ability-mark, .txt-info").show()}else if(x==Ka.CHARGE_BAR_ASSIGNMENT||x==Ka.HOSTILITY_ASSIGNMENT){d(w);var $=b.clone(stage.pJsnData.player.param);for(stage.pJsnData.without_pc&&($=e($)),p=0,r=$.length;r>p;p++){var W=$[p],Z=stage.pJsnData.without_pc?+p+1:p;if(!b.isUndefined(W)){var X=M.find(".prt-character").find(".lis-character"+p);f(W,X),g(W,Z,X),h(W,!0,X),i(W,X),l(Z,X),k(b.indexOf(stage.pJsnData.formation,String(Z))<0||0==W.alive||x!=Ka.HOSTILITY_ASSIGNMENT&&W.recast>=W.recastmax||x!=Ka.HOSTILITY_ASSIGNMENT&&pCharacterPos==Z||x==Ka.HOSTILITY_ASSIGNMENT&&v==Z,"mask-black",X)}}}else if(x==Ka.USE_LUPIE){parseInt(w)>0||m.hasClass("tmp-mask")?this.$el.find(".prt-lupiflip").css("display","none"):this.$el.find(".prt-lupiflip").css("display","block");var _=this.$el.find(".pop-ability-lupiflip");stage.gGameStatus.ability_sub_param=[],a.when(n.getLupiFlip({raid_id:stage.pJsnData.raid_id})).done(function(c){_.css("display","block").find(".prt-lupiflip").html(b.template(a("#tpl-lupiflip").html(),{list:c}))}),L=null}else if(x==Ka.SECRET_GEAR&&1>w&&!m.hasClass("tmp-mask")){var _=this.$el.find(".pop-ability-hiddenweapon"),da=_.find(".txt-trialbattle-comment");stage.gGameStatus.ability_sub_param=[],a.when(n.getHiddenWeapon({raid_id:stage.pJsnData.raid_id,pid:N.pid})).done(function(c){n.isHiddenweaponSkip=c.is_skip_hiddenweapon_confirm,_.find(".btn-skip").attr("data-active",+n.isHiddenweaponSkip).removeClass("is-disable").end().find(".prt-item-box").html(b.template(a("#tpl-item-hiddenweapon").html(),{list:c})),c.hiddenweapon_info.is_trialbattle&&!da.hasClass("show")?da.addClass("show"):!c.hiddenweapon_info.is_trialbattle&&da.hasClass("show")&&da.removeClass("show"),_.css("display","block")}),_.find(".prt-popup-footer").find(".btn-usual-hiddenweapon").addClass("disable-hiddenweapon").removeClass("btn-usual-hiddenweapon"),L=null}else if(x==Ka.SWITCH_POSITION)if(parseInt(w)>0||m.hasClass("tmp-mask"))this.$el.find(".btn-ability-use").css("display","none");else{stage.gGameStatus.ability_sub_param=[],M.find(".btn-usual-orderchange").addClass("disable"),M.find(".txt-select-chara").html(D.getMessage("raid_ability_2")),M.find(".txt-info").empty();var Z,$=b.clone(stage.pJsnData.player.param);for(stage.pJsnData.without_pc&&($=e($)),p=0,r=$.length;r>p;p++){var W=$[p];if(!b.isUndefined(W)){var X=M.find(".prt-character").find(".lis-character"+p);Z=stage.pJsnData.without_pc?+p+1:p,f(W,X),g(W,Z,X),h(W,!1,X),i(W,X),l(Z,X),k(0==W.alive||W.hp<1,"disable mask-black",X),j(Z,X),X.removeClass("select").find(".prt-mask").empty()}}for(;5>=p;p++){var X=M.find(".prt-character").find(".lis-character"+p);Z=stage.pJsnData.without_pc?+p+1:p,j(Z,X),X.removeClass("mask-black").find(".prt-mask").empty()}stage.pJsnData.formation.forEach(function(a){var b=+a;stage.pJsnData.without_pc&&b--,M.find(".prt-character.main").append(n.$el.find(".prt-character.main").find(".lis-character"+b))})}else{if(1!=stage.gGameStatus.ability_popup)return void(0!=parseInt(w)||m.hasClass("tmp-mask")||this.AddAbilityQueue());var ea=M.find(".prt-switch-special");+x===Ka.SWITCH_SPECIAL&&N.companion_special_skill&&N.companion_special_comment?ea.html(b.template(a("#tpl-prt-switch-special").html(),{name:N.companion_special_skill,comment:N.companion_special_comment})).addClass("show"):ea.empty().removeClass("show"),parseInt(w)>0||m.hasClass("tmp-mask")?this.$el.find(".btn-ability-use").css("display","none"):this.$el.find(".btn-ability-use").show()}a(L).show(),this.showMask()}}}},setActionAbility:function(a){var c=b.find(stage.pJsnData.ability,function(a){return+a.pos===+stage.gGameStatus.abilityCharacterNum});this.actionAbility=b.find(c.list,function(b){return+b[0]["ability-id"]===+a})},popShowAbilityEffect:function(){this.popHideAbilityMark();var c=this,d=this.actionAbility[0].ability_detail,e=new t({className:"pop-ability-effect-info",title:D.getMessage("raid_ability_effect_1"),body:b.template(a("#tpl-condition-list").html(),{condition:d,isIOS:Game.ua.isIOS(),isBattle:!0}),flagBtnClose:0,flagBtnOk:1});e.render(),b.reduce(d,function(a,b){return a+=b.length},0)>8&&e.$el.find(".prt-condition-list").flexslider({selector:".prt-condition-wrapper > .lis-condition-slider",animation:"slide",animationLoop:!1,slideshow:!1,prevText:"",nextText:"",start:function(){c.onFlexSliderStart()}}),e.popShow(),this.popView=e},onFlexSliderStart:function(){var a;this.popView.$el.find(".prt-condition-wrapper .lis-condition-slider").css("display","block"),a=this.popView.$el.find(".flex-viewport").height(),this.popView.$el.find(".flex-direction-nav").height(a),this.popView.$el.find(".flex-nav-next").css("opacity",1)},previousShowAbility:function(){var a=this;this.isKeepAbilitySubParam=!0,this.listenToOnce(this.popView,"removeEnd",function(){a.popShowAbility({currentTarget:stage.gGameStatus.$use_ability[0]})}),this.popRemove()},popHideAbility:function(){this.$el.find(".prt-ability-dialog").css("display","none"),this.hideMask()},popHideAbilityStamped:function(){this.$el.find(".prt-ability-stamped").css("display","none"),this.hideMask()},popHideAbilityMark:function(){this.$el.find(".pop-ability-mark").css("display","none"),this.hideMask()},popHideAbilityHiddenweapon:function(){this.$el.find(".pop-ability-hiddenweapon").css("display","none"),this.hideMask()},popHideAbilityLupiFlip:function(){this.$el.find(".pop-ability-lupiflip").css("display","none"),this.hideMask()},popHideOrderChange:function(a){this.$el.find(".pop-ability-orderchange").css("display","none"),this.hideMask(),stage.gGameStatus.ability_sub_count=0},popShowSummon:function(b){if("top"!=stage.gGameStatus.menu&&2!=stage.gGameStatus.chara_select){var c=3,d=a(b.currentTarget),e=d.attr("summon-id");if(e){stage.gGameStatus.attackQueue.$useAbilityTmp=d;var f=d.attr("summon-name"),g=d.attr("summon-skill-name"),h=d.attr("summon-comment"),i=d.attr("summon-recast"),j=d.attr("summon-start-recast"),k=d.attr("summon-once-flg"),l=d.attr("summon-require"),m=d.attr("summon-protection-name"),n=d.attr("summon-protection"),o=d.attr("summon-quality"),p=Number(d.attr("summon-evolution")),q=!!d.attr("summon-sub-skill-flag"),r=p-(c-1);"supporter"===e&&(stage.gGameStatus.attackQueue.gUseSummon=[Oa+b.x,Pa+b.y]),this.showMask();var s="",t=this.$el.find(".txt-summon-protection"),u=this.$el.find(".prt-summon-detail"),v=u.find(".prt-icon"),w=this.$el.find(".btn-summon-use");t.removeClass("bless-rank1-style bless-rank2-style bless-rank3-style"),1==e||"supporter"==e&&(1==stage.pJsnData.supporter.friend||stage.pJsnData.supporter.available_skill)||q===!0?(u.removeClass("disenable").addClass("enable"),p>=c&&t.addClass("bless-rank"+r+"-style")):(u.removeClass("enable").addClass("disenable"),s="supporter"==e?D.getMessage("raid_42"):D.getMessage("raid_43"));var x=this.checkSummonLimitCount();parseInt(i,10)>=1||0==x||d.hasClass("tmp-mask")?w.css("display","none"):("true"===k?w.attr({"data-text":D.getMessage("raid_summon_once")}):w.attr({"data-text":""}),w.show()),w.attr({"summon-id":e,"summon-skill-name":g}),u.find(".img-summon").attr("src",d.find("img").attr("src")),v.find(".prt-detail-quality").remove(),o>0&&v.append('<div class="prt-detail-quality">+'+o+"</div>"),this.$el.find(".txt-summon-name").html(f),this.$el.find(".txt-summon-skill").html(g),this.$el.find(".txt-summon-effect").html(h),this.$el.find(".start-recast").empty(),this.$el.find(".recast").empty(),""!==j?(this.$el.find(".start-recast").html(D.getMessage("raid_summon_first_call_title")+j+D.getMessage("raid_summon_first_call_unit",j)),this.$el.find(".recast").html(D.getMessage("raid_37")+l+D.getMessage("raid_78",l))):"true"===k?this.$el.find(".recast").html(D.replaceMessage("start_recast_1",[l],+l)):this.$el.find(".recast").html(D.getMessage("raid_37")+l+D.getMessage("raid_78",l)),this.$el.find(".txt-summon-protection-name").html(m),t.html(n),this.$el.find(".txt-disenable").html(s),this.$el.find(".pop-summon-detail").show()}}},popHideSummon:function(){this.$el.find(".pop-summon-detail").css("display","none"),this.hideMask()},popShowSummonNo:function(a){var b="raid_45";switch(a){case 1:b="cannot_summon_1";break;case 3:b="summon_lyria_2"}var c=new t({className:"pop-summon-no",title:D.getMessage("raid_44"),body:D.getMessage(b),flagBtnCancel:0,flagBtnOk:1});c.render().popShow(!0,"50px"),this.popView=c},popAssistCheck:function(){if(!stage.gGameStatus.clear&&!(1==stage.pJsnData.is_coopraid||1==stage.pJsnData.is_semi||1==stage.pJsnData.is_authority||stage.pJsnData.is_defendorder||stage.pJsnData.is_arcarum||stage.pJsnData.is_special_battle)){var a=this,b=this.$el.find(".btn-assist"),c=new(u.extend({urlRoot:Game.baseUri+this.getRaidType()+"/assist_check"}));c.save({raid_id:stage.pJsnData.raid_id},{success:function(c){a.trigger(Mb),stage.pJsnData.assist=c.changed.assist,a.setAssistParam(),1==stage.pJsnData.invite_enable?b.removeClass("disable"):b.addClass("disable"),a.popShowAssist()},error:function(){a.trigger(Mb)}}),this.trigger(Lb)}},popShowSemiNotice:function(){var b=stage.pJsnData.is_defendorder?"#tpl-pop-semi-notice-do":"#tpl-pop-semi-notice",c=stage.pJsnData.is_defendorder?"pop-do-semi-notice":"pop-semi-notice",d=a(b).html(),e=new t({className:c,title:D.getMessage("raid_46"),body:d,flagBtnClose:1,flagBtnOk:0});e.render().popShow(),this.popView=e},popShowTrialBattleNotice:function(){var b=new t({className:"pop-trialbattle-notice",title:D.getMessage("raid_trial_2"),body:a("#tpl-pop-trialbattle-notice").html(),flagBtnClose:1});b.render().popShow(),this.popView=b},popShowAssist:function(c){var d=c,e=a("#tpl-pop-assist").html();this.popShowAssist=function(a){d!=a&&(d=a);var c=stage.pJsnData;if(c.fellow>=c.limit_number)return void this.popShowAssistOver();this.inactivateMask();var f="first"===d?!0:!1,g=stage.pJsnData.temporary_potion_all.assist>=1&&stage.pJsnData.assist.is_first===!0,h=new t({className:"pop-start-assist",title:D.getMessage("raid_16"),body:b.template(e,{guildFlag:c.guild,firstView:f,isDefendOrder:c.is_defendorder||!1}),flagBtnCancel:1,flagBtnOk:0,showStartCallback:function(){h.$el.find(".btn-usual-text").toggleClass("with-potion",g)}});h.render();var i=this.$el.find(".pop-start-assist"),j=i.find(".prt-popup-footer"),k="btn-usual-text",l=stage.gGameStatus.assist,m=c.assist;0!=l.all&&0!=m[1].is_enable||0!=l.friend&&0!=m[2].is_enable||0!=l.guild&&0!=m[3].is_enable||(k+=" disable"),j.append('<a href="javascript:void(0);" class="'+k+'">'+D.getMessage("raid_16")+"</a>"),c.is_authority&&j.find(".btn-usual-text").addClass("disable"),h.popShow(),this.popView=h},this.popShowAssist(c)},popShowAssistOver:function(){var a=new t({className:"pop-notice pop-request-assist-over",title:D.getMessage("raid_16"),body:D.getMessage("raid_47"),flagBtnCancel:0,flagBtnOk:1});this.popShowAssistOver=function(){this.updateBeforeAutoAttackStatus(Ia.REQUEST_ASSIST,Ha.NONE),this.updateBeforeAutoAttackStatus(Ia.REQUEST_ASSIST_OVER,Ha.WAIT),a.render().popShow(),this.popView=a},this.popShowAssistOver()},popUnauthorizedAssist:function(){this.popView=new t({className:"pop-unauthorized-assist",title:D.getMessage("raid_16"),body:a("#tpl-pop-unauthorized-assist").html(),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()},popRestrictAssist:function(){this.popView=new t({className:"pop-restrict-assist",title:"救援依頼",body:"このマルチバトルは特殊なクエストです。<br>救援を送ることはできません。",flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()},popEnableAssist:function(){this.popView=new t({className:"pop-enable-assist",title:D.getMessage("raid_16"),body:a("#tpl-pop-enable-assist").html(),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()},setAssistButtonUnauthorized:function(){this.$el.find(".btn-assist").addClass("disable unauthorized-assist")},unsetAssistButtonUnauthorized:function(){this.$el.find(".btn-assist").removeClass("disable unauthorized-assist")},setEnableAssist:function(){0==stage.pJsnData.invite_enable||stage.pJsnData.fellow>=stage.pJsnData.limit_number||(this.unsetAssistButtonUnauthorized(),this.popView&&b.size(this.popView.$el.find(".pop-unauthorized-assist"))>0&&(this.popView.popDelete(),this.popView=null,this.updateBeforeAutoAttackStatus(Ia.UNAUTHORIZED_ASSIST,Ha.FINISHED),this.startAutoAttackIfCompletePreparation(!1)),this.popEnableAssist())},settingChange:function(b){var c=a(b.currentTarget),d=this.$el.find(".prt-setting"),e=c.attr("set"),f=c.attr("value");d.find(".set-"+e+">div").removeClass("active"),d.find(".set-"+e+">div[value="+f+"]").addClass("active"),""!=c.attr("change_class")&&"top"==stage.gGameStatus.menu&&(1==f?a(c.attr("change_class")).removeClass("display-off").addClass("display-on"):a(c.attr("change_class")).removeClass("display-on").addClass("display-off")),stage.gGameStatus[e]=f;var g=new(u.extend({urlRoot:Game.baseUri+"rest/raid/setting"}));g.save({set:e,value:f},{success:function(){},error:function(){},silent:!0})},settingChangeSingle:function(c){var d=this,e=a(c.currentTarget),f=e.attr("set"),g=e.attr("active"),h=1==g?0:1;e.attr({active:h}),""!=e.attr("targets")&&a(e.attr("targets")).attr({active:h});var j=e.attr("change_class"),k=a(j);if(1==e.attr("display_type"))if(e.hasClass("auto")&&(stage.gGameStatus.auto_attack_display_flag=h),1==h)k.show(),d.battleAutoType!==Va.FULL||!e.hasClass("auto")||stage.gGameStatus.player.all_dead||stage.gGameStatus.diagram||d.showAutoButton();else{if(".prt-navi"===j)if(1==stage.pJsnData.is_riddle);else{var l=stage.pJsnData.navi_information,m=stage.pJsnData.navi_index,n=this.getForceNaviIndex(l,m);if(n>=0){stage.pJsnData.navi_index=n;var o=l[n];this.NaviShow(o)}else k.css("display","none")}else k.css("display","none");d.battleAutoType===Va.FULL&&e.hasClass("auto")&&d.hideAutoButton()}else""!==e.attr("change_class")&&"top"===stage.gGameStatus.menu&&(1==h?(a(e.attr("change_class")).removeClass("display-off").addClass("display-on"),d.battleAutoType===Va.FULL&&e.hasClass("diagram")&&d.hideAutoButton()):(a(e.attr("change_class")).removeClass("display-on").addClass("display-off"),d.battleAutoType===Va.FULL&&e.hasClass("diagram")&&!stage.gGameStatus.player.all_dead&&d.showAutoButton()));({rtn_mode:!0})[f]?Game.setting[f]=h:stage.gGameStatus[f]=h;var p=new(u.extend({urlRoot:Game.baseUri+"rest/raid/setting"}));p.save({set:f,value:h},{success:function(){switch(f){case"rtn_mode":d.setRtnMode();break;case"is_show_coating_value":b.each(stage.gGameStatus.player.param,function(a,b){i.changeCoatingDisplay(1===+h?1:0,b,0,!0)})}},error:function(){},silent:!0})},setBgmButton:function(a){this.$el.find(".btn-bgm-change").trigger("tap")},popShowChat:function(c){function d(){i="pop-ready-stamp";var a={0:55,1:140,2:140},c=a[+stage.pJsnData.chat.stampPageMode];f=b.filter(stage.pJsnData.chat[h],function(a){return+a.priority<=c}),f=b.sortBy(f,function(a){return+a.priority}),k.enabledRecentStamps=y.isSupported(),k.enabledRecentStamps?(k.recentStamps=g.getRecentStamps(),k.showRecentStamps=g.judgeShowRecentStamp(k.recentStamps)):k.showRecentStamps=!1,e()}function e(){var c={0:5,1:20,2:0};k.category=h,k.chatList=f,k.recentStampMax=c[+stage.pJsnData.chat.stampPageMode],k.getPotionText=D.replaceMessage("raid_get_potion_text",{"%s":+stage.pJsnData.temporary_potion_all.chat},+stage.pJsnData.temporary_potion_all.chat),g.popView=new t({className:i,title:j,body:b.template(a("#tpl-chat-pop").html(),k),flagBtnCancel:0,flagBtnOk:0}),g.popView.render();var d=g.popView.$el;if("9999"==h){var e=d.find(".prt-stamp-wrapper .lis-stamp-slider");e.css("display","none").addClass("invisible"),d.find(".prt-stamp-image").flexslider({selector:".prt-stamp-wrapper > .lis-stamp-slider",animation:"slide",animationLoop:!1,slideshow:!1,prevText:"",nextText:"",startAt:stage.gGameStatus.stampPage,start:function(){if(0!=stage.gGameStatus.stampPage){var a=-268*stage.gGameStatus.stampPage;d.find(".prt-stamp-wrapper").css({transform:"translate3d("+a+"px, 0px, 0px)","-webkit-transform":"translate3d("+a+"px, 0px, 0px)"})}e.css("display","block").removeClass("invisible")},after:function(){var b=d.find(".flex-control-paging a").index(a(".flex-control-paging .flex-active"));b>=0&&(stage.gGameStatus.stampPage=b)}})}d.find(".pop-chat .prt-popup-footer").append('<div class="btn-usual-close ev-back"></div>'),d.find(".pop-ready-stamp .prt-popup-footer").append('<div class="btn-usual-close ev-back"></div>'),g.popView.popShow(),0==stage.pJsnData.chat_temporary_flag&&(d.find(".pop-chat .txt-notice").css("display","block"),d.find(".pop-ready-stamp .txt-notice").css("display","block"))}var f,g=this,h=a(c.currentTarget).attr("category"),i="pop-chat",j=D.getMessage("raid_48"),k={};this.stopEventPropagation(c,!0),"-1"==h&&(h=stage.gGameStatus.chat_category,j=D.getMessage("raid_49")),9999!==+h?(f=stage.pJsnData.chat[h],e()):stage.gGameStatus.stampGet?d():g.getStampList(d)},getStampList:function(a){var b=this;this.trigger(Lb);var c=new(x.extend({urlRoot:Game.baseUri+"rest/multiraid/stamp_list"}));this.listenToOnce(c,"sync",function(c){var d=c.toJSON();stage.pJsnData.chat[P]=d.stamp,stage.pJsnData.chat.stampPageMode=+d.stamp_page_mode,stage.gGameStatus.stampGet=!0,a&&a(),b.trigger(Mb)}),c.fetch()},judgeShowRecentStamp:function(a){var c=b.find(a,function(a){return+a.chat_id>0});return"undefined"!=typeof c},getRecentStamps:function(){var a,c,d=[];if(this.recentStamps=this.recentStamps||[],a=y.getItem("recentStamps"),a&&(a=JSON.parse(a)),!a){for(c=0;Q>c;c++)d[c]=0;y.setObject("recentStamps",d),a=d}for(c=0;Q>c;c++)this.recentStamps[c]=b.find(stage.pJsnData.chat[9999],function(b){return+b.chat_id===a[c]}),void 0===this.recentStamps[c]&&(this.recentStamps[c]={chat_id:"0"});return this.recentStamps},prepareLatestStamp:function(a){this.preparedLatestStamp=a},setLatestStamp:function(){var a,c,d,e,f=[];if(a=this.preparedLatestStamp||null,null!==a){for(d=this.getRecentStamps(),c=b.filter(d,function(b){return+b.chat_id!==a}),e=Q;e--;)void 0===c[e]&&(c[e]={chat_id:"0"}),f[e+1]=+c[e].chat_id;f[0]=a,y.setObject("recentStamps",f)}},changeCategory:function(c){var d=a(c.currentTarget).attr("category"),e=this.$el.find(".pop-chat"),f=D.replaceMessage("raid_get_potion_text",{"%s":+stage.pJsnData.temporary_potion_all.chat},+stage.pJsnData.temporary_potion_all.chat);stage.gGameStatus.chat_category=d,e.find(".txt-popup-body").html(b.template(a("#tpl-chat-pop").html(),{category:d,chatList:stage.pJsnData.chat[d],getPotionText:f})),0==stage.pJsnData.chat_temporary_flag&&e.find(".txt-notice").css("display","block")},ChatSend:function(b){var c=this;if(this.chat_limited!==!0){this.chat_limited=!0,this.clearTimeoutOne("chatLimited"),this.setNamedTimeout("chatLimited",function(){c.chat_limited=!1},3500);var d=a(b.currentTarget),e=d.attr("chatId"),f=d.attr("category");this.notifyFirstChat(function(){c.doChatSend(e,f)})}},doChatSend:function(a,b){b||(b=9999),this.popRemove();var c=this;9999===+b&&y.isSupported()&&(this.prepareLatestStamp(+a),this.setLatestStamp());var d=stage.pJsnData.user_id,e=stage.pJsnData.viewer_id,f=(stage.pJsnData.nickname,a),g=b;c.broadcastChatLog({userId:d,viewerId:e,chatId:f,categoryId:g})},checkAbilityTargetError:function(a,c,d,e){if(!stage.pJsnData.player.param[c])return V.EMPTY;e||(e=stage.gGameStatus.abilityCharacterNum);var f={isDead:null,isSubMember:null,isFullHP:null,isFullGauge:null,isSelf:null,isDifferentAttr:null,isRevive:null};switch(f.isRevive=stage.pJsnData.player.param[c].resurrection_availble_flag,f.isDead=0==stage.pJsnData.player.param[c].alive||stage.pJsnData.player.param[c].hp<1,f.isSubMember=b.indexOf(stage.pJsnData.formation,String(c))<0,f.isFullHP=stage.pJsnData.player.param[c].hp>=stage.pJsnData.player.param[c].hpmax,f.isFullGauge=stage.pJsnData.player.param[c].recast>=stage.pJsnData.player.param[c].recastmax,f.isSelf=5==a&&e==c||5!=a&&stage.gGameStatus.abilityCharacterNum==c,f.isDifferentAttr=d&&+stage.pJsnData.player.param[c].attr!==d,11===+a&&+stage.gGameStatus.abilityCharacterNum===+c&&(f.isDifferentAttr=!0),+a){case 1:return f.isRevive?f.isDead?!1:V.ALIVE:V.CAN_NOT_REVIVE;case 2:return f.isDead?V.DEAD:f.isSubMember?V.SUBMEMBER:f.isFullHP?V.FULLHP:!1;case 4:return f.isDead?V.DEAD:f.isSubMember?V.SUBMEMBER:!1;
case 5:return f.isDead?V.DEAD:f.isSubMember?V.SUBMEMBER:f.isSelf?V.SELF:f.isFullGauge?V.FULLGAUGE:!1;case 7:return f.isDead?V.DEAD:f.isSubMember?V.SUBMEMBER:f.isSelf?V.SELF:!1;case 10:case 11:return f.isDead?V.DEAD:f.isSubMember?V.SUBMEMBER:f.isDifferentAttr?V.DIFFERENT_ATTR:!1;default:return!1}},popShowAbilityRailError:function(a,b){2===stage.gGameStatus.chara_select&&this.CancelTempItemUse(),this.$el.find(".pop-usual").css("display","none"),this.hideMask();var c=new t({className:"pop-raid-ability-error",title:D.getMessage(a),body:D.getMessage(b),flagBtnCancel:0,flagBtnOk:1});c.on("ok",function(){this.popRemove(),this.off()}),c.render().popShow(),this.popView=c},popConfirmMultiAbiliry:function(){var b=this;this.$el.find(".pop-usual").css("display","none"),this.hideMask();var c=new t({className:"pop-raid-multi-ability-confirm",title:D.getMessage("raid_82"),body:D.getMessage("multi_ability_confirm"),flagBtnCancel:1,flagBtnOk:1});this.listenToOnce(c,"ok",function(){this.popRemove(),b.stopListening(c),b.InvokeAttackQueue()}),this.listenToOnce(c,"cancel",function(){this.popRemove(),b.stopListening(c),b.ResetAllAttackQueue(),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in"),b._controlDomAttackButton(!0),b._offAutoButton(),b.CommandBackTop(),b.offBodyPreventDefault(a("body"))}),c.render().popShow(),this.popView=c},popRemove:function(){stage.pJsnData.suddenly_attack_flag&&stage.gGameStatus.preemptiveDeferred.resolve(),b.isUndefined(this.popView)||this.popView.popRemove()},invokeAttackPendingQueue:function(){var a=this;if(a.attackPendingQueue){var c=b.clone(a.attackPendingQueue||[]);a.attackPendingQueue=[],b.each(c,function(a){a()})}},invokeAbilityPendingQueue:function(){var a=this;if(a.abilityPendingQueue){var c=b.clone(a.abilityPendingQueue||[]);a.abilityPendingQueue=[],b.each(c,function(a){a()})}},setRtnMode:function(a){if(b.isUndefined(stage.pJsnData.cmd)&&stage.pJsnData.multi)if(Game.setting.rtn_mode)if(this.initSocket(stage.pJsnData.raid_id),b.isUndefined(a)||a!==!0)this.getLatestMultiMemberInfo();else{var c=this;this.updateMvpInfo(),this.setNamedTimeout("firstMvpUpdate",function(){c.getMvpInfo()},2e3)}else this.destroySocket(),this.displayMVP()},initSocket:function(c){function d(a){window.stage&&stage.gGameStatus&&stage.gGameStatus.attacking&&stage.gGameStatus.attackQueue.queue.length>0?f.attackPendingQueue.push(a):a()}function e(a,b){$a(b,function(){f.resetAllianceMember(a)})}var f=this;f.destroySocket(),f.attackPendingQueue=[],f.abilityPendingQueue=[];var g=f.socket=new r({room:"raid"+c,socketUriController:""}),h=f.chatSocket=new r({room:"raid"+c,socketUriController:"chat/raid"});g.multiLog={},g.boss={param:{},status:{},recast:{}},g.user={param:{},status:{},recast:{}};var j=!1;g.onSocket("connect_failed",function(){j===!1&&(j=!0,f.clearTimeoutOne("firstMvpUpdate"),f.getMvpInfo())});var k={};k.memberJoin=function(a){a.member.user_id!=Game.userId&&(Ya(a.timestamp,function(){f.addAllianceMember(a.member)}),Za(a.member.user_id,a.timestamp,function(){f.MultiLog(a.member)}),p.playAssistJoinedSE())},k.memberRetire=function(a){var c=a.member;c.retired_flag=!0,c.hp_ratio=0;var d=f.getAllianceData({userId:c.user_id});Ya(a.timestamp,function(){f.updateAllianceMember(c)}),a.member.user_id!=Game.userId&&(Za(a.member.user_id,a.timestamp,function(){f.MultiLog(b.defaults(c,d))}),e(a.mvpList,a.timestamp),a.isHost!==!0||stage.pJsnData.is_allowed_to_requesting_assistance||f.setEnableAssist())},k.mvpReset=function(a){e(a.mvpList,a.timestamp)},k.mvpUpdate=function(a){f.clearTimeoutOne("firstMvpUpdate"),e(a.mvpList,a.timestamp)},k.userParam=function(a){Ya(a.timestamp,function(){f.resetAllianceMember(a.member)});var c=a.membersParams[Game.userId];b.isEmpty(c)||d(function(){_a(a.timestamp,function(){f.updateUserParam(c)})})},k.userCondition=function(a){var c=a.membersConditions[Game.userId];b.isEmpty(c)||d(function(){ab(a.timestamp,function(){f.updateUserStatus(c)})})},k.bossRecast=function(a){var c=a.membersRecasts[Game.userId];b.isEmpty(c)||d(function(){bb(a.timestamp,function(){f.updateBossRecast(c)})})},k.bossUpdate=function(a){d(function(){cb(a.timestamp,function(){if(b.isUndefined(stage.pJsnData.teamraid_bgm_hp)===!1){var c=!1,d=a.param.boss1_hp/stage.pJsnData.boss.param[0].hpmax*100;if(b.every(stage.pJsnData.teamraid_bgm_hp,function(a){return+a>=d?void(stage.gGameStatus.teamraidBossHp!==+a&&(stage.gGameStatus.teamraidBossHp=+a,c=!0)):!1}),c){var e=new(x.extend({urlRoot:Game.baseUri+"rest/sound/raid_bgm_for_teamraid/"+stage.pJsnData.raid_id}));e.fetch().done(function(a){ia(a.bgm)})}}f.updateBossParam(a.param)})})},k.fieldEffect=function(a){var c=a.param;d(function(){if(b.size(stage.gGameStatus.field.tmpPersonalField)>0){var d=b.size(c);b.each(stage.gGameStatus.field.tmpPersonalField,function(a){c[d]=a,d++})}gb(a.timestamp,function(){i.mConditionField(c)})})},k.summonUpdate=function(a){a.user_id!=Game.userId&&db(a.timestamp,function(){f.FusionChance(a.summon_id,a.summon_image_id)})},k.battleFinish=function(b){b.log.user_id!=Game.userId&&d(function(){eb(b.timestamp,function(){f.MultiLog(b.log),stage.gGameStatus.node_finish=!0,stage.gGameStatus.finish?stage.gGameStatus.player.all_dead&&f.Attack("normal_attack_result",{tnum:Na}):(f._controlDomAttackButton(!1),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out"),stage.gAryRootParts[1][stage.gGameParam.cjs.parts[1]].gotoAndPlay("out"),f.$el.find(".pop-usual").css("display","none"),a("#pop-chat .pop-usual").css("display","none"),f.hideMask(),f.AttackHide(),f.Attack("normal_attack_result",{tnum:Na}))})})},k.battleLose=function(a){if(a.log.user_id!=Game.userId){var b=a.log;Ya(a.timestamp,function(){var a=f.getAllianceData({userId:b.user_id});a.hp_ratio=0,f.updateAllianceMember(a)}),Za(b.user_id,a.timestamp,function(){f.MultiLog(b)})}},k.battleRematch=function(a){if(a.log.user_id!=Game.userId){var b=a.log;Za(b.user_id,a.timestamp,function(){f.MultiLog(b)})}};var l={};k.logPop=function(a){var c=Game.userId;b.each(a.log,function(e){if(e.user_id!=c){var g=function(a){var c=window.stage;c&&c.gGameStatus&&c.gGameStatus.retire||(f.MultiLog(a),c.gGameStatus.others_effect_display_flag&&b.each(a.scenario,function(a){var b=a.kind;if(l[b]=l[b]||0,!(l[b]+1>K)){++l[b];var d=createjs.Tween.get({}),e=i.mWindowEffect(d,a),f=e*(c.gGameParam.spf||M);d.wait(f),d.call(function(){l[b]--})}}))};switch(e.type){case"heal":d(function(){_a(a.timestamp,!0,function(){g(e)})});break;case"buff":d(function(){ab(a.timestamp,!0,function(){g(e)})});break;case"debuff":d(function(){cb(a.timestamp,!0,function(){g(e)})});break;default:g(e)}}})},k.logAdd=function(a){var c=a.log;b.isArray(c)?b.each(c,function(a){f.prependMultiBattleLog(a)}):f.prependMultiBattleLog(c)},k.scenarioPlay=function(a){a.user_id!=Game.userId&&d(function(){f.playScenariosImmediately(a)})},k.bossKill=function(a){a.user_id!=Game.userId&&d(function(){cb(a.timestamp,function(){var b=a.data.pos;stage.gGameStatus.boss.param[b].alive&&(stage.gGameStatus.isNodeBossKillScenarios=!0,stage.gGameStatus.isPlayingScenariosImmediately=!0,stage.gGameStatus.attackQueue.pause=!0,f.checkReward(),f.MultiLog(a.data))})})},k.bgmPlay=function(a){a.user_id!=Game.userId&&d(function(){fb(a.timestamp,function(){window.stage.gGameStatus.shouldPlayFixedBGM||b.isUndefined(stage.pJsnData.teamraid_bgm_hp)!==!0||ia(a.bgm)})})},g.onSocket("raid",function(a){b.each(a,function(a,b){var c=k[b]||function(){};c.call(this,a)})});var m={};m.raidPost=function(a){return a&&a.user_comment?void(1*Game.setting.chat_mode!==0&&(a.user_comment.is_stamp?(Game.setting.chat_stamp||a.user_id==Game.userId)&&f.insertStamp(a.user_comment.stamp_id,a.platform_id):f.insertComment(a.user_comment.text,a.platform_id))):void 0},m.chatAdd=function(a){(!a.commentData.isStamp||Game.setting.chat_stamp||a.userId==Game.userId)&&f.displayChat(a)},h.onSocket("chat",function(a){b.each(a,function(a,b){var c=m[b]||function(){};c.call(this,a)})}),h.onSocket("raid",function(a){b.each(a,function(a,b){var c=m[b]||function(){};c.call(this,a)})})},destroySocket:function(){this.socket&&(this.socket.destroy(),delete this.socket),this.chatSocket&&(this.chatSocket.destroy(),delete this.chatSocket)},destroy:function(){this.isDestroyed=!0,i.resetDisplayedTurn(),this.off(),this.undelegateEvents(),this.stopListening(),this.removeOthersCjsAll(),delete window.ignoreSkipAttackFrame;var c=a(Game.ua.isJssdk()?Game.gameContainer.selector:"body");this.offBodyPreventDefault(c),a("#canvas").off(),b.each([".active-mask",".mask","#opaque-mask"],function(b){a(b).css("display","none")}),this.oTweenCommon&&this.oTweenCommon.timeline&&this.oTweenCommon.timeline[0]&&createjs.Tween.removeTweens(this.oTweenCommon.timeline[0]),k.mSetInterval(),k.mCreateJS(),k.mRaidStageParams(),p.unsetVoice(F.VOICE_ENEMY_ALIAS);var d=this;d.socket&&(d.socket.destroy(),delete d.socket),d.chatSocket&&(d.chatSocket.destroy(),delete d.chatSocket)},displayLog:function(b){var c=this;return c.deferredDisplayLog=c.deferredDisplayLog||(new a.Deferred).resolve(),b&&(c.deferredDisplayLog=c.deferredDisplayLog.then(function(){var c=new a.Deferred;if(b.log){var d={"class":"log-multipop",title:D.getMessage("raid_50"),body:b.log};i.mLog(d),setTimeout(function(){c.resolve()},2e3)}else c.resolve();return c})),c.deferredDisplayLog},updateUserParam:function(a,c){var d=window.stage;if(d&&d.pJsnData&&d.gGameStatus&&d.gGameStatus.player&&d.gGameStatus.player.param){var e={};b.each(d.pJsnData.formation,function(a,b){e[a]=b}),b.each(a,function(a){if(b.has(e,a.num)){var g=a.pos=e[a.num],h=d.gGameStatus.player.param[g];h&&a.param&&(c||h.hp<a.param.hp)&&(null===d.gGameStatus.player.posSizeL||d.gGameStatus.player.posSizeL===+g)&&(i.mPlayerGaugeHpForLog(a),1!=d.gGameStatus.attacking&&!b.isUndefined(g)&&h.alive&&f.mChangeMotionInstantly({motion:"stbwait",pos:g,type:"player"}))}})}},updateUserStatus:function(c){var d=this,e=window.stage;if(e&&e.pJsnData&&e.gGameStatus&&e.gGameStatus.player&&e.gGameStatus.player.param){var f={};b.each(e.pJsnData.formation,function(a,b){f[a]=b}),b.each(c,function(a){if(b.has(f,a.num)){var c=a.pos=f[a.num],d=e.gGameStatus.player.param[c];if(d&&(null===e.gGameStatus.player.posSizeL||e.gGameStatus.player.posSizeL===+c)){b.isUndefined(a.condition.coating_value)===!0&&(a.condition.coating_value=b.clone(d.condition.coating_value||0));var g=d.condition=a.condition;if(i.mConditionPlayer(g,c),a.param&&a.param.recast_plus){var h=hb(c,a.param.recast_plus),j=0|d.recast,k=0|d.recastmax,l=Math.max(Math.min(j+h,k),0);i.mPlayerGaugeRecastForLog({pos:c,param:{recast:l,recastmax:k}}),ib(c,a.param.recast_plus)}}}}),d.renewCharaList(null,!1,!0)}return new a.Deferred},updateBossRecast:function(c){return window.stage&&stage.pJsnData&&stage.pJsnData.boss&&stage.gGameStatus&&stage.gGameStatus.boss&&b.each(c,function(a,b){i.mBossGaugeRecastForLog(kb,stage.pJsnData.boss.type,{pos:b,param:{recast:a.recast,recastmax:a.recastmax}})}),new a.Deferred},changeBossMode:function(a,b){var c=window.stage,d=c.gGameStatus;if(d){var e=d.bossmode;e&&(e.already_changed&&(e.already_changed[a]=!0),e.looks&&e.looks.mode&&(e.looks.mode[a]=b));var f=kb[a];f&&f.mode&&f.mode.changeMode(b);var g=1==b?"wait":"wait_"+b;d.waitmode&&(d.waitmode[a]=g);var h=c.gAryRootBoss,i=d.boss&&d.boss.param;if(h&&h[a]&&i&&i[a]){var j=h[a][i[a].cjs];j.gotoAndPlay(g)}3==b?kb[a].recast.disableRecast():kb[a].recast.enableRecast()}},updateBossParam:function(c){var d=this,e=new a.Deferred;return window.stage&&stage.gGameStatus&&stage.gGameStatus.boss&&(b.each(stage.gGameStatus.boss.param,function(a,f){var g="boss"+(f+1);a.hp=c[g+"_hp"],i.mBossGaugeHpForLog(kb,stage.pJsnData.boss.type,{pos:f,param:{hp:a.hp,hpmax:a.hpmax}});var h=c[g+"_mode"];1==h&&"wait"!==stage.gGameStatus.waitmode[f]?(d.changeBossMode(f,h),e.resolve()):2==h&&"wait_2"!==stage.gGameStatus.waitmode[f]?(d.changeBossMode(f,h),d.displayLog({log:D.getMessage("raid_51"),"class":"over"}).always(function(){e.resolve()})):3==h&&"wait_3"!==stage.gGameStatus.waitmode[f]?(d.changeBossMode(f,h),d.displayLog({log:D.getMessage("raid_52"),"class":"break"}).always(function(){e.resolve()})):e.resolve();var j=c[g+"_mode_gauge"];i.mBreakGaugeForLog(kb[f],{pos:f,gauge:j});var k=c[g+"_condition"];b.isEmpty(k)===!1&&(b.isEmpty(k.debuff)===!1&&(k.debuff=d._removePersonalCondition(k.debuff,"debuff",!0)),b.isEmpty(k.buff)===!1&&(k.buff=d._removePersonalCondition(k.buff,"buff",!0)),stage.gGameStatus.boss.param[f].condition=k,kb[f].condition.setCondition(k,stage.gGameStatus.bossmode.looks.mode[f]))}),i.mConditionBoss(kb),6053610===+stage.gGameStatus.boss.param[0].enemy_id&&i.hideHudFlag===!0&&i.showHUD()),e},_removePersonalCondition:function(a,c,d){if(a.length<1)return a;var e="",f="",g=[];return"debuff"===c?(e="personal_debuff_user_id",f="personal_debuff_end_turn"):(e="personal_buff_user_id",f="personal_buff_end_turn"),b.each(a,function(a,c){var h=!1,i=!1,j={};b.isUndefined(a[e])===!0||a[e]===!1?h=!0:+a[e]===+Game.userId&&(h=!0,d===!0&&(+a[f]<=stage.gGameStatus.turn?h=!1:i=!0)),h===!0&&(j=a,i===!0&&+a[f]<1e3&&b.isUndefined(a.icon_add_turn_flag)===!1&&1===+a.icon_add_turn_flag&&(j.status=a.personal_status+(+a[f]-+stage.gGameStatus.turn)),g.push(j))}),g},getRemainEnemyPosIdList:function(){var a=[];return b.each(stage.gGameStatus.boss.param,function(b,c){+b.alive>0&&a.push(c)}),a},changeEnemyStatusSize:function(c,d,e,f){function g(){var a=b.clone(stage.gGameStatus.boss.param[c]),f=b.clone(j.condition.conditions),g=j.thumbnail.image.src.replace(/.*assets\/enemy\/s\/(.+)\.png/g,"$1"),k=!!a.modeflag;a.type=l,a.enemy_id=g,a.overdrive_image=stage.pJsnData.overdrive_image,a.is_semi=stage.pJsnData.is_semi,a.isSamurai=+stage.pJsnData.collabo_type===ra,a.switching_hp_gauge=stage.pJsnData.switching_hp_gauge||!1,a.condition=b.defaults(a.condition,{debuff:[],buff:[]}),k===!0&&(a.modechange=stage.gGameStatus.bossmode.looks.mode[c],a.modegauge=100*j.mode.modeGauge.scaleX),j.initialize(j.spriteSheet,a,c,stage.pJsnData.disp_hp_percent_disp),j.hp.change(a.hp,a.hpmax,!1,c,!0),j.condition.setCondition(f,a.modechange),i.mConditionBoss(stage.gEnemyStatus),"undefined"!=typeof j.mode&&j.mode.changeMode(a.modechange),stage.gGameStatus.target===+c+1&&j.markTarget(),j.x=Ib[l][d][e].x,j.y=Ib[l][d][e].y,j.show(),h.$el.find('.btn-enemy-gauge[target="'+(+c+1)+'"]').addClass("gauge-mode-override gauge-mode-"+d+"-"+(+e+1))}var h=this,j=stage.gEnemyStatus[c],k=a("#enemy-hp"+c).closest(".prt-enemy-percent"),l=d.substr(0,1),m=400,n=f||!1;n?g():(k.css("opacity",0),createjs.Tween.get(j).to({alpha:0},m,createjs.Ease.cubicIn).call(function(){h.isDestroyed!==!0&&(g(),j.alpha=0,k.css("opacity",1),createjs.Tween.get(j).to({alpha:1},m,createjs.Ease.cubicOut))}))},changeEnemyStatusLayout:function(a,b){switch(a){case Jb.LUCILIUS:this.changeEnemyStatusSize(b[0],"s3",2,!0),this.changeEnemyStatusSize(b[1],"s3",1,!0)}},createChat:function(b){var c=this,d=b.categoryId,e=b.chatId,f=b.viewerId,g=b.date,h=new a.Deferred,i=new a.Deferred;i.done(function(){var a=c.getAllianceData({viewerId:f});j&&a?h.resolve({chat:j,name:a.nickname,image:a.pc_image,date:g}):(c.getLatestMultiMemberInfo(),h.resolve(null))});var j;if(b.text)j={category:d,chat_id:e,text:b.text},i.resolve();else if(+d!=P||stage.gGameStatus.stampGet)j=this.pJsnData.chat&&this.pJsnData.chat[d]&&this.pJsnData.chat[d][e],i.resolve();else{var k=new(x.extend({urlRoot:Game.baseUri+"rest/multiraid/stamp_list"}));this.listenToOnce(k,"sync",function(a){var b=a.toJSON();stage.pJsnData.chat[d]=b.stamp,stage.pJsnData.chat.stampPageMode=+b.stamp_page_mode,stage.gGameStatus.stampGet=!0,j=this.pJsnData.chat&&this.pJsnData.chat[d]&&this.pJsnData.chat[d][e],i.resolve()}),k.fetch()}return h},displayChat:function(c,d){function e(){return d?d.chat.category!==P?void f():void(stage.gGameStatus.stampGet?(f(),g(d.chat.chat_id)):this.getStampList(function(){f(),g(d.chat.chat_id)})):void 0}function f(){var c=i.$el.find(".prt-history"),e=c.children("div");if(e.size()>=3){var f=e.last();clearTimeout(f.attr("data-timer")),f.remove()}var g=b.template(a("#tpl-chat-parts").html(),d),j=Math.round(220*Math.random()),k=Math.round(50*Math.random());if(a("body").hasClass("android2")){c.prepend(g).find("div:first").addClass("pop-comment-show").css({top:k+"px",left:j+"px"});var l=c.find(".pop-comment-show"),m=setTimeout(function(){h(l),clearTimeout(m)},1e3)}else c.prepend(g).find("div:first").addClass("pop-comment-show").css({top:k+"px",left:j+"px"}).oneAnimationEnd(function(){var b=a(this);h(b)},1100)}function g(a){var c=stage.pJsnData.chat[P][a].stamp_voice;if(1===stage.gGameStatus.voiceStamp&&b.isEmpty(c)!==!0){var d=b.random(0,c.length-1),e="voice/"+c[d]+".mp3";b.isEmpty(stage.gGameStatus.loadedStampVoice)&&(stage.gGameStatus.loadedStampVoice=new Array(F.MAX_NUM_LOAD_VOICE_STAMP));var f=stage.gGameStatus.loadedStampVoice,g=0,h=b.contains(f,e);if(h===!0){if(g=b.indexOf(f,e),0!==g){var i=f[g-1];f[g-1]=f[g],f[g]=i,g-=1}}else{for(var j=0;j<F.MAX_NUM_LOAD_VOICE_STAMP&&!b.isUndefined(f[j]);j++);g=j>F.MAX_NUM_LOAD_VOICE_STAMP-1?F.MAX_NUM_LOAD_VOICE_STAMP-1:j,f[g]&&p.unsetVoice(F.VOICE_STAMP_ALIAS+g)}var k=F.VOICE_STAMP_ALIAS+g;p.playVoice(e,{alias:k}),f[g]=e}}function h(b){b.removeClass("pop-comment-show"),clearTimeout(b.attr("data-timer"));var c=setTimeout(function(){a("body").hasClass("android2")?(b.addClass("pop-comment-hide"),b.remove()):b.addClass("pop-comment-hide").oneAnimationEnd(function(){b.remove()},300)},2e3);b.attr("data-timer",c)}var i=this;if(d)e();else{var j=this.createChat(c);j.done(function(a){d=a,e()})}},insertComment:function(a,b){var c={categoryId:0,chatId:0,text:a,viewerId:b};this.displayChat(c)},insertStamp:function(a,b){var c={categoryId:9999,chatId:a,viewerId:b};this.displayChat(c)},isMulti:function(){return window.stage&&stage.pJsnData&&1==stage.pJsnData.multi},broadcastChatLog:function(a){var c=this;stage.pJsnData.is_semi?c.chatSemiraidModel.postChatModel.save(b.extend({raidId:stage.pJsnData.raid_id},a),{patch:!0,success:function(){Game.chatView.updateSemiraidCommentList()}}):c.isMulti()&&c.socket&&(a.type="chatAdd",c.chatSocket.emit("raid",a))},TutorialPreRender:function(){},TutorialInit:function(){},TutorialTurnEnd:function(){},fellowTimeup:function(){stage.gGameStatus.finish=!1,stage.gGameStatus.menu="temporary",this.Attack("normal_attack_result",{tnum:Na})},ChangeSpeed:function(a){if(!this._isChangeSpeedDisallowed()){this.trigger(Lb);var b=this,c=this.$el.find(a.currentTarget).val();this.currentFps=3===+c?2*this.baseFps:1.5*this.baseFps,this._setting_model||(this._setting_model=new(u.extend({urlRoot:Game.baseUri+"rest/raid/setting"}))),this._setting_model.save({set:"battle_speed",value:c}).done(function(){stage.gGameParam.spf=Math.round(1e3/b.currentFps*100)/100,createjs.Ticker.setFPS(b.currentFps),b.trigger(Mb)})}},_isChangeSpeedDisallowed:function(){this.changeSpeedTime||(this.changeSpeedTime=0);var a=Date.now();return a-this.changeSpeedTime<1e3?!0:(this.changeSpeedTime=a,!1)},BattleLog:function(){if(!stage.pJsnData.is_semi){this.scrollPopShow("<div class='pop-log-window'>"+D.getMessage("raid_12")+"</div>");var a=this,b=new d;b.save({raid_id:stage.pJsnData.raid_id},{url:b.urlRoot("multi_battle_log","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){},success:function(b){var c=b.get("multi_battle_log");a.displayBattleLog(c)}})}},displayBattleLog:function(c){var d=this,e=a("#tpl-multi-log").html(),f=this.$el.find(".pop-log-window");if(f.empty(),0===c.length)f.html(D.getMessage("raid_53"));else{var g=!1,h="";b.each(c,function(a){var c=d.getAllianceData({userId:a.user_id});c?h=b.template(e,b.defaults(b.defaults(a,c),{my_user_id:stage.pJsnData.user_id}))+h:g=!0}),f.prepend(h),g&&d.getLatestMultiMemberInfo()}},allianceList:function(){if(!stage.pJsnData.is_semi){var c=this;this.scrollPopShow("<div class='pop-alliance-window'></div>");var d=this.$el.find(".pop-alliance-window"),e=this.pJsnData.user_id||Game.userId,f=b.reject(this.pJsnData.multi_raid_member_info,function(a){return a.user_id!=e&&a.retired_flag});d.html(b.template(a("#tpl-alliance-list").html(),{user_list:b.first(f,N),excess:this.pJsnData.fellow-N}));var g=d.find('[data-id="'+stage.pJsnData.user_id+'"]');g.addClass("player").prependTo(d),b.each(f,function(a){var b=d.find('[data-id="'+a.user_id+'"]');b.addClass("rank"+a.rank),stage.pJsnData.user_id&&(c.pJsnData.guild_member_ids&&c.pJsnData.guild_member_ids[a.user_id]?b.addClass("guild-member"):c.pJsnData.friend_ids&&c.pJsnData.friend_ids[a.user_id]&&b.addClass("friend"))})}},popShowRematchFail:function(){var b=new t({className:"pop-rematch-fail",title:D.getMessage("raid_rematch_fail"),body:a("#tpl-pop-rematch-fail").html(),flagBtnCancel:0,flagBtnOk:1});this.popShowRematchFail=function(){b.render().popShow(!0,"50px"),this.popView=b},this.popShowRematchFail()},popHideRematchFail:function(){this.hideMask(),this.popView&&this.popView.popRemove(),stage.gGameStatus.boss.all_dead?stage.gGameStatus.node_finish&&!stage.gGameStatus.is_clear&&this.activateMask():this.Attack("normal_attack_result",{tnum:Na})},popShowTimeUp:function(){var a=new t({className:"pop-time-up",title:D.getMessage("raid_54"),body:D.getMessage("raid_80"),flagBtnCancel:0,flagBtnOk:1});this.popShowTimeUp=function(){a.render().popShow(!0,"50px"),this.popView=a},this.popShowTimeUp()},popShowArcarumGameOver:function(){this.popView=new t({className:"pop-arcarum-game-over",title:D.getMessage("arcarum_9"),body:b.template(a("#tpl-pop-lack-tp").html(),{item:Pb}),flagBtnCancel:0,flagBtnOk:1,btnOkClassName:"btn-retire"}),this.popView.render().popShow(!0,"50px")},popShowBoardGameOver:function(){this.popView=new t({className:"pop-no-tp-must-retire",title:D.getMessage("arcarum_13"),body:a("#tpl-pop-no-tp-must-retire").html(),flagBtnCancel:0,flagBtnOk:1,btnOkClassName:"btn-retire"}),this.popView.render().popShow(!0,"50px")},popBoardRetire:function(){this.popView=new t({className:"pop-retire-selection",title:D.getMessage("arcarum_13"),body:a("#tpl-pop-retire-selection").html(),flagBtnCancel:1,flagBtnOk:1,btnOkClassName:"btn-retire"}),this.popView.render().popShow(!0,"50px")},popArcarumDeadNoTp:function(){var c=+Pb.number>0&&+Ob.number>0;this.popView=new t({className:"pop-arcarum-dead-no-tp",title:D.getMessage("arcarum_9"),body:b.template(a("#tpl-pop-arcarum-dead-no-tp").html(),{arcarumItemList:stage.pJsnData.arcarum.item}),flagBtnCancel:1,flagBtnOk:1,btnCancelClassName:"btn-retire",btnOkClassName:c?"btn-use-item":"btn-use-item disable"}),this.popView.render().popShow(!0,"50px")},popConfirmRecoverTpResurrection:function(){this.popView=new t({className:"pop-confirm-arcarum-dead-no-tp",title:D.getMessage("raid_13",2),body:b.template(a("#tpl-pop-confirm-arcarum-dead-no-tp").html(),{arcarumItemList:stage.pJsnData.arcarum.item}),flagBtnCancel:1,flagBtnOk:1,btnOkClassName:"btn-use-item"}),this.popView.render().popShow(!0,"50px")},onUseItemForDeadNoTp:function(a){stage.gGameStatus.btn_lock||(stage.gGameStatus.btn_lock=!0,this.postUseItemForDeadNoTp())},postUseItemForDeadNoTp:function(){this.useArcarumItemProcess();var a={raid_id:this.pJsnData.raid_id,resurrection_item_id:Ob.id,tp_recovery_item_id:Pb.id};this.Attack("arcarum_temporary_item_result_all_dead_game_over",a),this.CancelTempItemUse()},isPlayerAlive:function(){return 1==stage.pJsnData.player.param[0].alive},isLyriaAlive:function(){return stage.pJsnData.lyria_num<0?!0:1==stage.pJsnData.player.param[stage.pJsnData.lyria_num].alive},FusionChance:function(a,b){var c=this.$el.find(".prt-fusion"),d=b||a;a&&this.isPlayerAlive()&&this.isLyriaAlive()?(c.css("display","block").find(".img-summon").attr({src:Game.imgUri+"/sp/assets/summon/raid_normal/"+d+".jpg"}).css({display:"block"}),clearTimeout(stage.gGameStatus.timer.mFusion),stage.gGameStatus.timer.mFusion=setTimeout(function(){c.css("display","none")},4700)):(clearTimeout(stage.gGameStatus.timer.mFusion),c.css("display","none"))},MultiLog:function(a){var c,d=window.stage;if(!(d.gGameStatus.logtimer>0)){d.gGameStatus.logtimer=2,a.viewer_id=a.viewer_id||d.pJsnData.viewer_id,a.user_id=a.user_id||d.pJsnData.user_id,c=+a.user_id!==+d.pJsnData.user_id&&0===+d.pJsnData.skin_node?a.pc_image_original||a.pc_image:a.pc_image;var e=a.nickname,f=a.message;b.isObject(f)&&(f=f[Game.lang]);var g=a.priority||0;if(!(g<(this.multilogPriority||0))){if(!(c&&e&&f)){var h=this.getAllianceData({userId:a.user_id});if(!h)return void this.getLatestMultiMemberInfo();c||(c=+a.user_id!==+d.pJsnData.user_id&&0===+d.pJsnData.skin_node?h.pc_image_original||h.pc_image:h.pc_image),e=e||h.nickname}var i=this.$el.find(".prt-multilog");i.css("display","none"),c?i.find(".img-user").attr({src:Game.imgUri+"/sp/assets/leader/raid_log/"+c+".png"}):i.find(".img-user").attr({src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABmJLR0QA/wD/AP+gvaeTAAAADUlEQVQI12NgYGBgAAAABQABXvMqOgAAAABJRU5ErkJggg=="}),i.find(".txt-body").html(f),i.show(),clearTimeout(this.multilogTimer);var j=this;this.multilogTimer=setTimeout(function(){i.css("display","none"),j.multilogTimer=null,delete j.multilogTimer,j.multilogPriority=null,delete j.multilogPriority},2300),this.multilogPriority=g,delete a.message}}},getAllianceData:function(a){return b.find(this.pJsnData.multi_raid_member_info,function(b){return b.user_id==a.userId||b.viewer_id==a.viewerId})},initializeMVP:function(a,c){var d=this;a?this.pJsnData.multi_raid_member_info=a:a=this.pJsnData.multi_raid_member_info,c?this.pJsnData.mvp_info=c:c=this.pJsnData.mvp_info,b.each(a,function(a){var e=b.find(c,function(b){return b.user_id==a.user_id});e?b.extend(a,e):(a.rank=a.rank||c.length+1,a.point=a.point||0),d.updateMemberType(a.user_id,a)}),this.calculateMVP(),this.displayMVP()},calculateMVP:function(){var a=this.pJsnData.multi_raid_member_info;a.sort(function(a,b){return b.point-a.point||a.rank-b.rank}),this.updateMVPRank()},updateMVPRank:function(){var a=this,c=this.pJsnData.multi_raid_member_info,d=this.pJsnData.user_id||Game.userId,e=stage&&stage.gGameStatus&&stage.gGameStatus.retire,f=1;b.each(c,function(b){b.retired_flag||b.user_id==d&&e?b.rank=null:b.rank=f++,a.updateMemberType(b.user_id,b)})},updateMemberType:function(a,b){var c=this.pJsnData.guild_member_ids||[],d=this.pJsnData.friend_ids||[];b.isGuildMember=!1,b.isFriend=!1,c[a]?b.isGuildMember=!0:d[a]&&(b.isFriend=!0)},updateAllianceNumber:function(){this.pJsnData.fellow=b.size(this.pJsnData.multi_raid_member_info)},updateAllianceMember:function(a){var c,d=a.user_id;(c=this.getAllianceData({userId:d}))&&b.extend(c,a),this.calculateMVP(),this.displayMVP()},addAllianceMember:function(a){if(a){var b=a.user_id,c=this.pJsnData.multi_raid_member_info=this.pJsnData.multi_raid_member_info||[];this.getAllianceData({userId:b})||(a.rank=a.rank||c.length+1,a.point=a.point||0,this.updateMemberType(b,a),c.push(a)),this.updateAllianceMember(a),this.updateAllianceNumber()}},removeAllianceMember:function(a){var c=a.user_id||a;c&&(this.pJsnData.multi_raid_member_info=b.reject(this.pJsnData.multi_raid_member_info,function(a){return a.user_id==c}),this.updateMVPRank(),this.displayMVP(),this.updateAllianceNumber())},resetAllianceMember:function(a){var c=this,d=this.pJsnData.multi_raid_member_info,e=!1;return b.each(a,function(a){var c;(c=b.find(d,function(b){return b.user_id==a.user_id}))?b.extend(c,a):e=!0}),e?void this.getLatestMultiMemberInfo():(this.calculateMVP(),this.displayMVP(),void c.updateAllianceNumber())},displayMVP:function(){if(!stage.pJsnData.is_defendorder){var c=this,d=this.$el.find(".prt-mvp"),e=this.pJsnData.user_id||Game.userId;if(d.css("display","none"),Game.setting.rtn_mode){var f=d.children().removeClass("player"),g=0,h=this.getAllianceData({userId:e});if(h){var i=a(f[g++]),j=c.displayMVPElement(i,h);j.addClass("player"),i&&i.length||d.prepend(j)}var k=b.reject(this.pJsnData.multi_raid_member_info,function(a){return a.retired_flag}),l=b.filter(b.first(k,J),function(a){return a.user_id!=e});b.each(b.range(g,J),function(b){var e=a(f[b]),g=l.shift();if(g&&!g.retired_flag){var h=c.displayMVPElement(e,g);e&&e.length||d.append(h),h.show()}else e.css("display","none")}),d.show()}}},displayMVPElement:function(c,d){if(d.point=d.point?Math.floor(d.point):0,c&&c.length){var e=function(){var a=c.find(".prt-rank");b.isNaN(parseInt(d.rank,10))?a.text(""):(c.addClass("rank"+d.rank),a.text(D.replaceMessage("raid_1",[d.rank])))},f=function(){b.isNaN(parseInt(d.point,10))||c.find(".txt-point").text(d.point+"pt")};if(+d.user_id===+this.pJsnData.user_id||+d.user_id===+c.data("id"))c.removeClass(b.filter(c.attr("class").split(" "),function(a){return 0===a.indexOf("rank")}).join(" ")),e(),f();else{c.removeClass().addClass("lis-user"),e(),f(),c.data("id",+d.user_id);var g=d.isGuildMember?"guild-member":d.isFriend?"friend":"";""!==g&&c.addClass(g);var h=0===+this.pJsnData.skin_node&&d.pc_image_original?d.pc_image_original:d.pc_image;if(h){var i=c.find(".img-character"),j=i.attr("src"),k=pb(j,h);j!==k&&i.attr("src",k)}d.nickname&&c.find(".txt-name").text(d.nickname)}}else try{c=a(b.template(a("#tpl-mvp-user").html(),d))}catch(l){}return c},updateMvpInfo:function(){var a=new(u.extend({urlRoot:Game.baseUri+this.getRaidType()+"/update_mvp_info"}));a.save({raid_id:this.pJsnData.raid_id})},getMvpInfo:function(){var a=this,b=new(u.extend({urlRoot:Game.baseUri+this.getRaidType()+"/mvp_info"}));b.save({raid_id:a.pJsnData.raid_id}).done(function(){var c=b.get("mvp_info");void 0!==c&&(a.initializeMVP(!1,c),a.displayMVP(),a.updateAllianceNumber())})},getLatestMultiMemberInfo:function(){var a=this,b=1e3,c=Date.now();if(!(a._prevConnectionTime&&c<a._prevConnectionTime+b)){a._prevConnectionTime=c;var d=new(u.extend({urlRoot:Game.baseUri+this.getRaidType()+"/multi_member_info"}));d.save({raid_id:a.pJsnData.raid_id}).done(function(){var b=d.get("multi_raid_member_info"),c=d.get("mvp_info");void 0!==b&&void 0!==c&&(a.initializeMVP(b,c),a.displayMVP(),a.updateAllianceNumber())})}},updateDamageRanking:function(c){var d=this.$el.find(".prt-mvp");d.hasClass("damage-rank")||d.addClass("damage-rank"),this.$el.find(".prt-multi-mene.damage-rank").css("display","block");var e=b.template(a("#tpl-damage-ranking").html());this.updateDamageRanking=function(a){var c=b.clone(a),f=!0,g=!0,h=!0,i=c.personal||null,j=c.total||null,k=c.turn||null;i&&i.job_id&&i.weapon&&i.sex&&i.nickname?c.personal.pc_image=i.pc_image:f=!1,c.isDisplayPersonal=f,j&&j.job_id&&j.weapon&&j.sex&&j.nickname?c.total.pc_image=j.pc_image:g=!1,c.isDisplayTotal=g,k&&k.job_id&&k.weapon&&k.sex&&k.nickname?c.turn.pc_image=k.pc_image:h=!1,c.isDisplayTurn=h,d.html(e(c))},this.updateDamageRanking(c)},notifyFirstChat:function(a){if(!stage.pJsnData.is_defendorder){var c=this;if(this.alreadySentChat)a&&a();else{this.alreadySentChat=!0;var e=new d;e.save({raid_id:stage.pJsnData.raid_id},{url:e.urlRoot("chat_result","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,ignoreError:!0,error:function(){},success:function(d){b.each(d.get("scenario"),function(a){switch(a.cmd){case"information":c.MultiLog({message:a.text,language:a.language});break;case"temporary":stage.gGameStatus.temporary.small=a.small||0,stage.gGameStatus.temporary.large=a.large||0,stage.gGameStatus.attackQueue.itemNumTmp.TemporarySmall=+stage.gGameStatus.temporary.small,stage.gGameStatus.attackQueue.itemNumTmp.TemporaryLarge=+stage.gGameStatus.temporary.large,i.mUpdateTemporaryItem(),stage.pJsnData.chat_temporary_flag=1,c.$el.find(".cnt-raid-chat").find(".ico-attention").css("display","none")}}),a&&a()}})}}},checkReward:function(){this.Attack("reward")},appendMultiBattleLog:function(a,c){var d=stage.pJsnData.user_id||Game.userId;a.user_id!=d&&this.MultiLog(b.defaults(a,{message:a.comment}))},prependMultiBattleLog:function(a){this.appendMultiBattleLog(a,!0)},activateMask:function(){this.getActiveMask().css("display","block")},inactivateMask:function(){this.getActiveMask().css("display","none")},getActiveMask:function(){var a=this.$el.find(".active-mask");return this.getActiveMask=function(){return a},this.getActiveMask()},executeModeChange:function(a,c,d,e,g,h,j,k,l){var m=b.isEmpty(j)===!1?j:null;if(9===a||1==a&&("wait"!==stage.gGameStatus.waitmode[h]||1!=e))l||f.mChangeMotion(c[1].timeline[h],{
motion:"wait",pos:h,type:"boss",is_alive:"on",synchronizePos:m}),stage.gGameStatus.waitmode[h]="wait",b.isArray(m)===!0&&m.length>0&&b.each(m,function(a){stage.gGameStatus.waitmode[a]="wait"}),c[1].timeline[h].call(function(a){1===stage.pJsnData.boss.param[a].modeflag&&kb[a].mode.changeMode(1),kb[a].recast.enableRecast()},[h]);else if(2!=a||"wait_2"===stage.gGameStatus.waitmode[h]&&1==e)3!=a||"wait_3"===stage.gGameStatus.waitmode[h]&&1==e||("enemy_8101403"===stage.gGameStatus.boss.param[h].cjs&&c[1].timeline[h].call(function(){stage.gGameStatus.motion_lock=!0}),l||f.mChangeMotion(c[1].timeline[h],{motion:"setin_3",pos:h,type:"boss",is_alive:"on",synchronizePos:m,voice:k},{tween:c}),"enemy_8101403"===stage.gGameStatus.boss.param[h].cjs&&c[1].timeline[h].call(function(){stage.gGameStatus.motion_lock=!1}),l||f.mChangeMotion(c[1].timeline[h],{motion:"wait_3",pos:h,type:"boss",is_alive:"on",synchronizePos:m}),stage.gGameStatus.waitmode[h]="wait_3",b.isArray(m)===!0&&m.length>0&&b.each(m,function(a){stage.gGameStatus.waitmode[a]="wait_3"}),c[1].timeline[h].call(function(a){1===stage.pJsnData.boss.param[a].modeflag&&kb[a].mode.changeMode(3),kb[a].recast.disableRecast()},[h]),c[2].timeline[0].call(function(){var a={"class":"log-battle",title:D.getMessage("raid_8"),body:D.getMessage("raid_59")};i.mLog(a)}));else{"enemy_8101403"===stage.gGameStatus.boss.param[h].cjs&&c[1].timeline[h].call(function(){stage.gGameStatus.motion_lock=!0}),l||f.mChangeMotion(c[1].timeline[h],{motion:"setin_2",pos:h,type:"boss",is_alive:"on",synchronizePos:m,voice:k},{tween:c}),"enemy_8101403"===stage.gGameStatus.boss.param[h].cjs&&c[1].timeline[h].call(function(){stage.gGameStatus.motion_lock=!1}),l||f.mChangeMotion(c[1].timeline[h],{motion:"wait_2",pos:h,type:"boss",is_alive:"on",synchronizePos:m}),stage.gGameStatus.waitmode[h]="wait_2",b.isArray(m)===!0&&m.length>0&&b.each(m,function(a){stage.gGameStatus.waitmode[a]="wait_2"}),c[1].timeline[0].call(function(a){1===stage.pJsnData.boss.param[a].modeflag&&kb[a].mode.changeMode(2)},[h]);var n=d?D.getMessage("rai_56"):"",o=b.isUndefined(g)||1!=g?"":D.getMessage("raid_57");c[2].timeline[0].call(function(){var a={"class":"log-battle",title:D.getMessage("raid_8"),body:D.replaceMessage("raid_58",[o,n])};i.mLog(a)})}},popShowSummonFail:function(a){var b=a?"summon_lyria_1":"raid_61";this.popView=new t({className:"pop-summon-fail",title:D.getMessage("raid_60"),body:D.getMessage(b),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow(!0,"50px")},popHideSummonFail:function(){this.$el.find(".pop-summon-fail").css("display","none"),this.hideMask()},GetHeroPos:function(){var a=b.indexOf(stage.pJsnData.formation,"0");return a},setAssistParam:function(){var a=stage.pJsnData;(a.is_defendorder||a.is_restrict_assist)&&(a.assist[1].is_enable=!1,a.assist[2].is_enable=!1,a.assist[3].is_enable=!1);var c=!1;b.each(a.assist,function(a,b){a.is_enable&&(c=!0)}),c?a.invite_enable=1:a.invite_enable=0},showEnemyInfo:function(c){if(!stage.gGameStatus.attackQueue.queue[0]||"SummonAttack"!==stage.gGameStatus.attackQueue.queue[0].index){for(var d,e=this,f=0,g=stage.gGameStatus.boss.param.length-1;g>=f;f++)if(1==stage.gGameStatus.boss.param[f].alive){var h=f+1;d=this.$el.find(".btn-targeting[data-target="+h+"]"),this.$el.find(".btn-enemy-gauge[target="+h+"]").css({display:"block"}),d.show();var i=a(".btn-enemy-gauge[target="+h+"].prt-enemy-percent");stage.gGameStatus.dispHpPercent?i.addClass("alive"):i.css({display:"none"}),(b.isUndefined(c)||1!=c.targetedEnemyOnly||h==stage.gGameStatus.target)&&d.removeClass("invisible")}clearTimeout(this.hideInfoTimer),this.hideInfoTimer=setTimeout(function(){e.$el.find(".prt-stage-area").find(".btn-targeting:not(.lock-on)").addClass("invisible")},3e3)}},hideEnemyInfo:function(){this.$el.find(".btn-targeting, .btn-enemy-gauge:not(.prt-enemy-percent)").css("display","none")},hideEnemyBeforeDie:function(){for(var a=0,b=stage.gGameStatus.boss.param.length;b>a;a++)1===+stage.gGameStatus.boss.param[a].alive&&1!==+stage.pJsnData.boss.param[a].visible_after_dead&&(stage.gAryRootBoss[a].visible=!1)},selectDungeonItem:function(c){if(null==this.selectedDungeonItem){var d=this,e=a(c.currentTarget);this.selectedDungeonItem=e.attr("key");var f=e.attr("item-id"),g=new(u.extend({urlRoot:Game.baseUri+"rest/raid/dungeon_item"}));g.save({item_id:f,raid_id:stage.pJsnData.raid_id},{success:function(c){var e=new t({className:"pop-dungeon-item-selected",title:D.getMessage("raid_62"),body:b.template(a("#tpl-dungeon-item-selected").html(),{item:d.dungeonItems[d.selectedDungeonItem]}),flagBtnCancel:0,flagBtnOk:1});e.render().popShow(!0,50),p.playSE("se/ab_0060_se_1.mp3")},silent:!0})}},locationResult:function(){var a="result/"+stage.pJsnData.raid_id+"/"+(this.currentFps/6-1);this.content_close(),c.history.navigate(a,!0)},popBattleService:function(c){var d=this;this.survival=c.survival||stage.pJsnData.survival,this.scorePoint=this.survival.is_score_buff?parseInt(this.survival.score_point,10):parseInt(this.survival.score_point,10)+parseInt(this.survival.add_point,10)+parseInt(this.survival.bonus_point,10),this.popView=new t({className:"pop-battle-service",title:D.getMessage("pop_skill_boost_1"),body:b.template(a("#tpl-battle-service").html(),{items:this.survival,score:this.scorePoint}),flagBtnCancel:0,flagBtnOk:1,showStartCallback:function(){d.popView.$el.find(".btn-usual-ok").attr({"raid-id":c.raid_id})}}),this.popView.render().popShow(!0,50)},selectBattleService:function(c){var d=this,e=a(c.currentTarget),f=this.popView.$el.find(".prt-popup-frame"),g=this.popView.$el.find(".prt-skill-boost-group1"),h=this.popView.$el.find(".prt-skill-boost-group2"),i=f.find(".txt-not-use");if(b.isUndefined(this.afterScorePoint)===!0&&(this.afterScorePoint=this.scorePoint),this.popView.$el.find(".btn-usual-ok").addClass("use-item"),i.css("display","none"),e.hasClass("active"))e.removeClass("active"),0===this.$el.find(".img-boost-thumb.active").length?(this.afterScorePoint=this.scorePoint,this.$el.find(".img-boost-thumb").removeClass("item-overlay"),this.popView.$el.find(".btn-usual-ok").removeClass("use-item"),i.css("display","block")):!!e.data("overlap-flag")==!1&&(this.afterScorePoint=this.afterScorePoint+e.data("consume-point")),!!e.data("overlap-flag")==!1&&g.find(".prt-boost-item").each(function(){var b=a(this),c=b.find(".img-boost-thumb");c.data("consume-point")<=d.afterScorePoint&&(c.removeClass("disable").addClass("btn-battle-service"),b.find(".prt-consume-point").removeClass("not-use"))}),f.find(".service-id"+e.data("service-id")).remove();else if(e.hasClass("use-single"))this.afterScorePoint=this.scorePoint-e.data("consume-point"),this.$el.find(".img-boost-thumb").removeClass("active"),e.addClass("active").removeClass("item-overlay"),h.find(".img-boost-thumb:not(.disable, .active)").addClass("item-overlay"),g.find(".prt-boost-item").each(function(){var b=a(this),c=b.find(".img-boost-thumb");c.data("consume-point")<=d.scorePoint&&(c.addClass("item-overlay").removeClass("disable").addClass("btn-battle-service"),b.find(".prt-consume-point").removeClass("not-use"))}),f.find("[class^=txt-service-comment]").remove(),f.append('<div class="txt-service-comment2 service-id'+e.data("service-id")+'">'+e.data("service-comment")+"</div>");else{var j=h.find(".img-boost-thumb.active");j.length>0?this.afterScorePoint=this.scorePoint-e.data("consume-point"):this.afterScorePoint=this.afterScorePoint-e.data("consume-point"),h.find(".img-boost-thumb").removeClass("active").each(function(){var b=a(this);b.hasClass("disable")||b.addClass("item-overlay")}),e.addClass("active"),g.find(".prt-boost-item").each(function(){var b=a(this),c=b.find(".img-boost-thumb");c.removeClass("item-overlay"),c.data("consume-point")>d.afterScorePoint&&!c.hasClass("active")&&(c.addClass("disable").removeClass("btn-battle-service"),b.find(".prt-consume-point").addClass("not-use"))}),f.find(".txt-service-comment2").remove(),f.append('<div class="txt-service-comment1 service-id'+e.data("service-id")+'">'+e.data("service-comment")+"</div>")}this.popView.$el.find(".txt-after-point").find("span").html(this.afterScorePoint)},sendBattleService:function(b){this.trigger("xhrStart");var d=this,e=[];this.popView.$el.find(".img-boost-thumb").each(function(){$self=a(this),$self.hasClass("active")&&e.push($self.data("service-id"))});var f=a(b.currentTarget).attr("raid-id"),g=new(u.extend({urlRoot:Game.baseUri+"rest/raid/battle_service"}));this.listenToOnce(g,"sync",function(){if(d.survival.is_score_buff)location.reload();else{var a="#raid/"+f;d.content_close(),c.history.navigate(a,!0)}}),g.save({service_id:e,raid_id:f})},changeAutoMode:function(){stage.gGameStatus.enable_auto_button&&(stage.gGameStatus.auto_attack?stage.gGameStatus.attackQueue.attackButtonPushed||this.battleAutoType===Va.FULL?this._offAutoButton():(stage.gGameStatus.auto_attack=!1,this._outAutoButton()):(this._onAutoButton(),this.battleAutoType===Va.FULL&&0===stage.gGameStatus.attacking&&this.runFullAuto()))},_removeAutoButton:function(){stage.gAryCntnParts[this._getAutoBtnIndex()].removeChild(stage.gAryRootParts[this._getAutoBtnIndex()]),this.$el.find(".btn-auto").remove()},_removeChatButtons:function(){stage.gAryCntnParts[5].removeChild(stage.gAryRootParts[5]),stage.gAryCntnParts[6].removeChild(stage.gAryRootParts[6])},_showAutoButton:function(){stage.gAryCntnParts[this._getAutoBtnIndex()].visible=!0},_hideAutoButton:function(){stage.gAryCntnParts[this._getAutoBtnIndex()].visible=!1},_showChatButtons:function(){0===+stage.pJsnData.mini_chat_stamp||1!=stage.gGameStatus.chat_button||stage.pJsnData.is_watching===!0||stage.pJsnData.is_semi&&stage.pJsnData.is_defendorder||(stage.gAryCntnParts[5].visible=!0,stage.gAryCntnParts[6].visible=!0)},_hideChatButtons:function(){stage.gAryCntnParts[5].visible=!1,stage.gAryCntnParts[6].visible=!1},_onAutoButton:function(){stage.gGameStatus.auto_attack=!0,stage.gAryRootParts[this._getAutoBtnIndex()][stage.gGameParam.cjs.parts[this._getAutoBtnIndex()]].gotoAndPlay("on")},_offAutoButton:function(){stage.gGameStatus.auto_attack=!1,stage.gAryRootParts[this._getAutoBtnIndex()][stage.gGameParam.cjs.parts[this._getAutoBtnIndex()]].gotoAndPlay("off")},_outAutoButton:function(){stage.gGameStatus.enable_auto_button=!1,stage.gAryRootParts[this._getAutoBtnIndex()][stage.gGameParam.cjs.parts[this._getAutoBtnIndex()]].gotoAndPlay("out")},_inAutoButton:function(){stage.gGameStatus.enable_auto_button=!0,stage.gAryRootParts[this._getAutoBtnIndex()][stage.gGameParam.cjs.parts[this._getAutoBtnIndex()]].gotoAndPlay("in")},_getAutoBtnIndex:function(){return+this.battleAutoType===Va.NORMAL?3:8},_outChatButtons:function(){stage.gAryRootParts[5][stage.gGameParam.cjs.parts[5]].gotoAndPlay("out"),stage.gAryRootParts[6][stage.gGameParam.cjs.parts[6]].gotoAndPlay("out")},_inChatButtons:function(){stage.gAryRootParts[5][stage.gGameParam.cjs.parts[5]].gotoAndPlay("in"),stage.gAryRootParts[6][stage.gGameParam.cjs.parts[6]].gotoAndPlay("in")},_fadeChatButtons:function(){0===+stage.pJsnData.mini_chat_stamp||1!=stage.gGameStatus.chat_button||stage.pJsnData.is_watching===!0||stage.pJsnData.is_semi&&stage.pJsnData.is_defendorder||(stage.gAryRootParts[5][stage.gGameParam.cjs.parts[5]].gotoAndPlay("fade"),stage.gAryRootParts[6][stage.gGameParam.cjs.parts[6]].gotoAndPlay("fade"))},_noInteractiveAutoButton:function(){this.$el.find(".btn-auto").css("display","none")},_interactiveAutoButton:function(){this.$el.find(".btn-auto").show()},_controlDomAttackButton:function(a){var b=this.$el.find(".btn-attack-start");this._controlDomAttackButton=function(a){b.removeClass("display-on display-off").addClass(a===!0?"display-on":"display-off")},this._controlDomAttackButton(a)},_toMissType:function(a,b){var c=b;switch(a){case 1:c=R;break;case 2:c=S;break;case 3:c=T;break;case 4:c=U}return c},setAbilityMark:function(b){var c=+stage.gGameStatus.ability_pick===Ka.NINJA_JITSU?"se/btn_se/btn_se_06.mp3":"se/ab_8051_se_1_2.mp3",d="se/btn_se/btn_se_02.mp3",e=a(b.currentTarget),f=e.parent(),g=f.parent().find(".first").length+f.parent().find(".second").length;0==g?(p.playSE(c),f.addClass("first").find('[class^="ico-ability-mark"]').addClass("active")):1==g?(p.playSE(c),f.addClass("second").find('[class^="ico-ability-mark"]').addClass("active"),this.$el.find(".pop-ability-mark").find(".btn-usual-text").removeClass("disable")):f.hasClass("second")&&(p.playSE(d),f.removeClass("second"),f.hasClass("first")||f.find('[class^="ico-ability-mark"]').removeClass("active"),this.$el.find(".pop-ability-mark").find(".btn-usual-text").addClass("disable"))},exeAbilityMark:function(b){if(!a(b.currentTarget).hasClass("disable")){var c=this.$el.find(".pop-ability-mark");c.css("display","none"),this.hideMask(),stage.gGameStatus.ability_sub_param=[c.find(".first").find("[mark]").attr("mark"),c.find(".second").find("[mark]").attr("mark")],this.AddAbilityQueue()}},onAbilityHiddenweapon:function(b){var c=this.$el.find(".pop-ability-hiddenweapon"),d=c.find(".prt-ability-detail");this.onAbilityHiddenweapon=function(b){var e,f=a(b.currentTarget);return this.isHiddenweaponSkip?(f.addClass("active"),void this.exeAbilityHiddenweapon()):f.hasClass("active")?(c.find(".btn-box").removeClass("invalid active"),c.find(".name").html(this.abilityHiddenweaponDetail.name),c.find(".effect").html(this.abilityHiddenweaponDetail.effect),c.find(".btn-usual-hiddenweapon").addClass("disable-hiddenweapon").removeClass("btn-usual-hiddenweapon"),void c.find(".btn-skip").removeClass("is-disable")):(e=d.find(".text-blue").length?'<br><span class="text-blue">'+d.find(".text-blue").html()+"</span>":null,c.find(".btn-box").addClass("invalid").removeClass("active"),c.find(".btn-skip").addClass("is-disable"),f.addClass("active").removeClass("invalid"),c.find(".disable-hiddenweapon").addClass("btn-usual-hiddenweapon").removeClass("disable-hiddenweapon"),d.find(".name").html(f.data("name")),void d.find(".effect").html(f.data("comment")+e))},this.onAbilityHiddenweapon(b)},exeAbilityHiddenweapon:function(){var a=this,b=this.$el.find(".pop-ability-hiddenweapon");this.exeAbilityHiddenweapon=function(){var c=b.find(".btn-box.active");return stage.gGameStatus.ability_sub_param.push(c.data("pos")),b.find(".btn-skip").removeClass("is-disable").end().css("display","none"),this.hideMask(),"2"==c.data("pick")||"5"==c.data("pick")?void a.popAbilitySubSelecter(null,c):void a.AddAbilityQueue()},this.exeAbilityHiddenweapon()},setSettingHiddenweaponSkip:function(b){var c,d=a(b.currentTarget);d.hasClass("is-disable")||(this.isHiddenweaponSkip=!this.isHiddenweaponSkip,d.attr("data-active",+this.isHiddenweaponSkip),c=new(u.extend({urlRoot:Game.baseUri+"rest/raid/setting"})),c.save({set:"is_skip_hiddenweapon_confirm",value:this.isHiddenweaponSkip}))},exeAbilityLupiFlip:function(b){var c=a(b.currentTarget);stage.gGameStatus.ability_sub_param.push(c.data("id")),this.$el.find(".pop-ability-lupiflip").css("display","none"),this.hideMask(),this.AddAbilityQueue()},popAbilitySubSelecter:function(c,d){var e=d||a(c.currentTarget),f=".pop-select-member",g=this.$el.find(f),h=0,i=e.data("pick");(parseInt(h)>0||e.hasClass("tmp-mask"))&&this.$el.find(".btn-ability-use").css("display","none"),g.find(".hideable").css("display","none"),this.$el.find(".txt-select-chara").html(D.getMessage("raid_41"));var j=g.find(".prt-ability-detail").html(),k={img:e.find(".prt-thum").html(),name:e.data("name"),effect:e.data("comment"),num:e.data("number"),limit:e.data("limit")};g.find(".prt-ability-detail").html(b.template(a("#tpl-ability-detail").html(),k));for(var l=0,m=stage.pJsnData.player.param.length;m>l;l++){var n=stage.pJsnData.player.param[l];if(!b.isUndefined(n)){var o=g.find(".prt-character").find(".lis-character"+l),p=2===n.form&&n.extra_attr>0?n.extra_attr:n.attr;o.find(".ico-type").removeClass(function(a,b){return(b.match(/ico-attribute-\d*/)||[]).join(" ")}).addClass("ico-attribute-"+p);var q=Math.ceil(n.hp/n.hpmax*100),r=25>=q?"red":"green",s=o.find(".txt-hp-value"),t=o.find(".txt-coating-value"),u=o.find(".prt-gauge-hp-inner");u.css("width",q+"%").attr({color:r}),s.html(""+n.hp).attr({color:r}),n.condition.hide_hp_flag?(s.addClass(ja),t.addClass(ja)):(s.removeClass(ja),t.removeClass(ja));var v=parseInt(n.recast/n.recastmax*n.recastmax);o.find(".prt-gauge-special-inner").css("width",v+"%"),o.find(".hideable").show(),1==n.leader?o.children("img").attr("src",Game.imgUri+"/sp/assets/leader/raid_normal/"+n.pid_image+".jpg"):o.children("img").attr("src",Game.imgUri+"/sp/assets/npc/raid_normal/"+n.pid_image+".jpg"),b.indexOf(stage.pJsnData.formation,String(l))<0||0==n.alive||n.hp<1||4!=i&&n.hp>=n.hpmax||5==i&&l==stage.gGameStatus.pCharacterPos?o.addClass("mask-black"):o.removeClass("mask-black")}}g.addClass("sub-selecter"),g.bind("hide",function(){g.find(".prt-ability-detail").html(j)}),g.show(),this.showMask()},exeAbilitySubSelecter:function(c){var d=a(c.currentTarget),e=d.attr("pos");b.indexOf(stage.pJsnData.formation,String(e))<0||(stage.gGameStatus.ability_aim_num=e,this.popHideSelectMember(),this.AddAbilityQueue())},setOrderChangeSelecter:function(a){var b=this.$el.find(".pop-ability-orderchange"),c=b.find(a.currentTarget),d=c.parent().hasClass("prt-sub-character"),e=b.find(".prt-sub-character").find(".btn-command-character"),f=e.hasClass("select"),g=b.find(".btn-command-character.select").length;if(c.hasClass("select"))c.removeClass("mask-black select").find(".prt-mask").empty(),g--,d&&(e.removeClass("mask-black"),b.find(".txt-info").empty());else{if(g>=2||d&&f)return;c.addClass("mask-black select").find(".prt-mask").html(D.getMessage("raid_ability_1")),g++,d&&(e.addClass("mask-black"),b.find(".txt-info").html(D.getMessage("raid_ability_4")))}0==g?(b.find(".txt-select-chara").html(D.getMessage("raid_ability_2")),b.find(".btn-usual-orderchange").addClass("disable")):1==g?(b.find(".txt-select-chara").html(D.getMessage("raid_ability_3")),b.find(".btn-usual-orderchange").addClass("disable")):(b.find(".txt-select-chara").empty(),b.find(".btn-usual-orderchange").removeClass("disable"))},exeOrderChangeSelecter:function(b){if(!a(b.currentTarget).hasClass("disable")){var c=this.$el.find(".pop-ability-orderchange");c.css("display","none"),this.hideMask();var d=c.find(".btn-command-character.select");stage.gGameStatus.ability_sub_param=[d.eq(0).attr("pos"),d.eq(1).attr("pos")],this.AddAbilityQueue()}},popQuestRetire:function(c,d){this.popView&&this.popRemove();var e=!!c.start_bonus_revenge_action_param&&!!c.start_bonus_revenge_count;if((!c.ap||"undefined"==typeof c.ap.before)&&e===!1)return void d();this.clearTimeoutOne(W);var f,g,h=D.getMessage("raid_63"),i=this.use_ap||!1,j=null,k=D.getMessage("revenge_bonus_2"),l="btn-usual-questlist";c.ap&&"undefined"!=typeof c.ap.before&&(f=c.ap.before,g=c.ap.after,j=g-f,k=D.replaceMessage("raid_64",[j,f,g])),this.isEventQuestRetire?l="btn-usual-eventtop":this.isSidestoryQuestRetire?l="btn-usual-storytop":c.hasCollectItemUrl&&(l="btn-usual-select-quest"),c.start_bonus_revenge_action_param&&c.start_bonus_revenge_action_param>0&&(k+=b.template(a("#tpl-revenge-bonus-pop-retire").html(),{revengeBonusParam:c.start_bonus_revenge_action_param,revengeBonusMax:"undefined"!=typeof c.start_bonus_revenge_max_param?c.start_bonus_revenge_max_param:"200",revengeBonusCount:c.start_bonus_revenge_count,isUseAp:i,useAp:j,isRetired:!0}));var m=new t({className:"pop-retire",title:h,body:k,flagBtnCancel:0,flagBtnOk:1});m.render().popShow(),this.popView=m,m.$el.find(".btn-usual-ok").addClass(l).removeClass("btn-usual-ok"),m.$el.find("."+l).one("tap",function(){d()})},popRevengeBonus:function(){this.popView=new t({className:"pop-revenge-bonus",title:D.getMessage("revenge_bonus_1"),body:a("#tpl-pop-revenge-bonus").html(),flagBtnOk:1}),this.popView.render().popShow()},preemptiveAttack:function(){stage.gGameStatus.attacking=1,this.activateMask();var c=a("body"),d=a(document).scrollTop();Game.ua.isJssdk()&&(c=a(Game.gameContainer.selector),d=a(Game.gameContainer.selector).parent().scrollTop()),a("body").hasClass("pc")||this.setBodyPreventDefault(c),d>1&&window.scrollTo(0,0),clearInterval(stage.gGameStatus.timer.mBalloon),this.$el.find(".prt-sub-command>div").addClass("black");var e=this,f=new a.Deferred,g=e.playScenarios({scenario:b.reject(stage.pJsnData.scenario,function(a){return"arcarum_stage_effect"===a.cmd}),status:stage.pJsnData.status});return g.done(function(){f.resolve()}),f},getRaidType:function(){var a="raid";switch(stage.pJsnData.is_multi){case!0:a=stage.pJsnData.is_semi===!0?"semiraid":"multiraid"}return"rest/"+a},checkOauthTwitterRaid:function(a){a=a||{},a.success=a.success||function(){},a.error=a.error||function(){};var b=this,c=new(x.extend({urlRoot:Game.baseUri+"twitter/twitter_info/"+I+"/"+stage.pJsnData.twitter.battle_id+"/"+stage.pJsnData.twitter.enemy_id}));this.stopListening(c,"sync"),this.listenToOnce(c,"sync",function(c){var d=c.toJSON();b.chromeAppFlag=!1,d.chromeapp&&d.chromeapp.version&&(b.chromeAppFlag=!0),d.chromeapp&&d.chromeapp.error?b.popupAttentionChromeApp(d.chromeapp):d.twitter.screen_name?a.success(d):a.error(d)}),c.fetch()},onPushTwitterIconRaid:function(a){var b=this;b.checkOauthTwitterRaid({success:function(a){b.campaign_id=a.twitter.campaign_info.campaign_id,b.popTwitterRaid(a)},error:function(a){b.campaign_id=a.twitter.campaign_info.campaign_id,b.popOauthTwitterRaid()}})},popTwitterRaid:function(c){var d=c.twitter,e=d.screen_name,f=d.default_message,g=d.forced_message.replace(/\/n/g,"<br>"),h=d.rest_tweet_mes_length;this.restCharaNum=h;var i=(d.campaign_info,"");this.popView=new t({className:"pop-status-check",title:D.getMessage("raid_65"),body:b.template(a("#tpl-pop-post-twitter").html(),{name:e,defaultText:f,addText:g,text:i,restCharaNum:h-f.length}),flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),this.popView.$el.find(".pop-status-check .btn-usual-ok").removeClass().addClass("btn-tweet-post"),this.addEventTwitterTextArea(),this.popView.popShow()},addEventTwitterTextArea:function(){var b=this,c=13,d=3,e=1,f=a("#frm-post-tweet");f.keyup(function(a){return b.textPostTweetPattern(f),a.keyCode==c?!1:void 0}),f.keypress(function(a){return a.keyCode==c?!1:void 0}),f.focus(function(a){f.attr("rows",d)}),f.focusout(function(b){a(b.currentTarget).val()||f.attr("rows",e)})},textPostTweetPattern:function(b){var c=b.val().length,d=this.restCharaNum-c,e=a(".twitter-mes-counter"),f=10,g=0,h=0>=c?1:3,i=0>=c?"":d,j="max",k="disable";e.html(i),b.attr("rows",h),e.toggleClass(j,f>=d),a(".btn-tweet-post").toggleClass(k,g>d)},popOauthTwitterRaid:function(){var c=this,d=new(x.extend({urlRoot:Game.baseUri+"twitter/twitter_redirect"}));c.stopListening(d,"sync"),c.listenToOnce(d,"sync",function(d){var e=d.toJSON();c.requestUrl=e.request_url,c.popView=new t({className:"pop-twitter-auth",title:D.getMessage("raid_66"),body:b.template(a("#tpl-pop-twitter-auth").html(),{}),flagBtnCancel:1,flagBtnOk:0}),c.popView.render(),c.popView.popShow()}),d.fetch()},handleOnPushPostTwitterButton:function(a){var b=this;this.checkAllowedRequestAssist(a,function(){b.onPushPostTwitterButtonRaid()})},onPushPostTwitterButtonRaid:function(){var b=this,c=+this.restCharaNum,d=a("#frm-post-tweet").val().length;0>c-d||this.postTwitterRaid({comment:a("#frm-post-tweet").val(),message_id:null,raid_id:stage.pJsnData.twitter.raid_id,enemy_id:stage.pJsnData.twitter.enemy_id,battle_id:stage.pJsnData.twitter.battle_id,success:function(a){b.popSuccessPostTwitterRaid(a)},error:function(a,c){b.checkOauthTwitterRaid({success:function(d){b.popSelectOauthOrPostRaid(d,a,c)},error:function(a){b.popOauthTwitterRaid()}})}})},popSuccessPostTwitterRaid:function(a){var b=this,c=D.getMessage("raid_67");b.popView=new t({className:"pop-success-post-twitter",title:D.getMessage("raid_68"),body:c,flagBtnCancel:0,flagBtnOk:1,showEndCallback:function(){p.playRecoverySE()}}),b.popView.render(),b.popView.popShow()},popSelectOauthOrPostRaid:function(c,d,e){var f=c.twitter,g=f.screen_name,h=f.default_message,i=f.forced_message,j=f.rest_tweet_mes_length;this.restCharaNum=j;var k=(f.campaign_info,"");this.popView=new t({className:"pop-status-check",title:D.getMessage("raid_65"),body:b.template(a("#tpl-pop-re-post-twitter").html(),{name:g,defaultText:h,addText:i,text:k,restCharaNum:j-h.length}),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this._addErrorCodePopup(d,e),this.addEventTwitterTextArea(),this.popView.popShow()},_addErrorCodePopup:function(b,c){if(""!==c){var d='<div class="txt-error-code">'+D.replaceMessage("raid_90",[b,c])+"</div>";a(".pop-status-check .txt-failed-post").append(d)}},postTwitterRaid:function(a){var b=new(u.extend({urlRoot:Game.baseUri+"twitter/tweet"}));this.stopListening(b,"sync"),this.listenToOnce(b,"sync",function(b){var c=b.toJSON(),d=2;c.result===d?a.success(c.reward_status):a.error(c.error_code,c.error_message)});var c={comment:a.comment,message_id:a.message_id,calling_id:I,raid_id:a.raid_id,enemy_id:a.enemy_id,battle_id:a.battle_id};b.set(c),b.save()},onPushOauthButtonRaid:function(){this.openUrl(this.requestUrl)},openUrl:function(a){n.isShellApp()?n.openBrowser(a):this.chromeAppFlag?location.href=a:window.open(a)},onInputPinCode:function(c){var d=a(c.currentTarget).val(),e=7;return b.isNaN(+d)||d.length!==e?void this.disableButton(a(".btn-oauth-pin")):void this.enableButton(a(".btn-oauth-pin"))},enableButton:function(a){a.removeClass("disable")},disableButton:function(a){a.addClass("disable")},checkPin:function(a){var b=new(u.extend({urlRoot:Game.baseUri+"twitter/oauth"}));this.stopListening(b,"sync"),this.listenToOnce(b,"sync",function(b){var c=b.toJSON(),d=4;c.result===d?a.success():a.error(c.reseted)}),b.set({pin:a.pin}),b.save()},onPushPinCodeButton:function(b){if(!a(b.currentTarget).hasClass("disable")){var c=this,d=a("#frm-pin").val()||"error";this.checkPin({pin:d,success:function(){c.popSuccessPin()},error:function(b){if(a(".prt-pin-error-text").css({display:"block"}),b){var d=new(x.extend({urlRoot:Game.baseUri+"twitter/twitter_redirect"}));c.stopListening(d,"sync"),c.listenToOnce(d,"sync",function(a){var b=a.toJSON();c.requestUrl=b.request_url}),d.fetch(),a(".prt-pin-error-text").css({display:"none"}),a(".txt-popup-title").css({display:"none"}),a(".txt-popup-title-error").css({display:"block"}),c.disableButton(a(".btn-oauth-pin"))}}})}},popSuccessPin:function(){this.popView=new t({className:"pop-success-pin",title:D.getMessage("raid_69"),body:D.getMessage("raid_70"),flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.$el.find(".btn-usual-ok").addClass("btn-assist"),this.popView.popShow()},onPushSuccessPinPopButton:function(){this.popView.popRemove()},onPushReOuthTwitterButton:function(){this.popOauthTwitterRaid()},onPushCloseTwitterPop:function(){this.onFinishRequestAssistPU()},popPcDisabled:function(){this.popView=new t({className:"pop-pc-disabled",title:D.getMessage("raid_71"),body:D.getMessage("raid_72"),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()},popRemoveDefault:function(){this.popView.popRemove()},executeMessage:function(c,d,e){d.nowait||d.nodamage_ability_nowait||f.mWaitAll(c,{playtime:10});var g=this,h=function(f){var h=new a.Deferred;if(b.isUndefined(d.data[f])===!0||b.isEmpty(d.data[f])===!0)h.resolve(0);else if(e){var i=[];b.each(d.data[f],function(a){i=b.union(i,b.chain(a).pluck("status").compact().uniq().value())}),g.loadStatusIcons(i,function(){h.resolve(g._executeMessage(c,d,f))})}else h.resolve(g._executeMessage(c,d,f));return h.promise()};b.isUndefined(d.data)===!1&&a.when(h("player"),h("boss")).done(function(a,d){var g=0,h=0,i=0;a>=d?(g=1,i=a,h=a-d):(i=d,h=d-a),i>0&&c[2].timeline[0].wait(i),h>0&&f.mWaitAll([c[g]],{playtime:h}),b.isUndefined(e)===!1&&b.isFunction(e)===!0&&e()})},_executeMessage:function(a,c,d){var e=this,f={player:4,boss:7},g=20,h=9,i=3,j=function(d){var j=[],k=[],l="boss"===d?1:0;b.each(c.data[d],function(c,k){j[k]=0;for(var m=b.values(b.groupBy(c,function(a,b){return Math.floor(b/f[d])})),n=0,o=m.length;o>n;n++){var p=b.size(m[n]),q=-(g*(p-1));b.each(m[n],function(c,f){var m=e.createOverheadMessageComponent(c,d,q),o=0===n&&0===f?0:0===f?h:i;a[l].timeline[k].wait(o).call(function(){b.isUndefined(c.dispel)===!1?e._showDispelEffect(a,d,c.pos).done(function(){m.show()}):m.show()}),j[k]+=o,q+=2*g})}}),k=b.compact(j);var m=b.isEmpty(k)===!1?b.max(k):0;return b.each(a[l].timeline,function(a,b){var c=j[b]||0;m>c&&a.wait(m-c)}),m};return j(d)},_showDispelEffect:function(b,c,d){var e=this,g=new a.Deferred,i="ab_3100",j=function(a,b,c){var d,e=createjs.Tween.get({}),g={kind:i,delay:0,pos:c,to:b,list:[1],cjs_param:{}};"player"===b?d=stage.gAryCntnAvatar[c]:"boss"===b&&(d=stage.gAryCntnBoss[c]);var j=h.mEffect(e,d,g);f.mWaitAll(a,{playtime:j})};return this.listenToOnce(l,"complete",function(){g.resolve(),j(b,c,d),e._showDispelEffect=function(a,b,c){return g.resolve(),j(a,b,c),g}}),l.loadFiles([i],!0),g},executeEffect:function(a,c){var d=0;if("player"===c.to||"player_fullscreen"===c.to){if(c.name&&j.mBoss(a[2].timeline[0],{text:c.name,playtime:24,delay:0}),c.list.length>0)for(var e=0,g=c.list.length-1;g>=e;e++)d=h.mEffect(a[0].timeline[c.list[e]],stage.gAryCntnAvatar[c.list[e]],c),"serial"===c.mode&&b.isUndefined(c.wait)&&f.mWaitAll(a,{playtime:d-6});else d=h.mEffect(a[2].timeline[0],stage.gPlayerContainer,c);+c.wait>=0?f.mWaitAll(a,{playtime:+c.wait}):"serial"===c.mode?f.mWaitAll(a,{playtime:6}):"parallel"!==c.mode||c.nowait||f.mWaitAll(a,{playtime:d})}if("boss"===c.to||"boss_fullscreen"===c.to){if(c.name&&j.mPlayer(a[2].timeline[0],{text:c.name,playtime:24,delay:0}),c.list.length>0)for(var e=0,i=c.list.length-1;i>=e;++e)d=h.mEffect(a[1].timeline[c.list[e]],stage.gAryCntnBoss[c.list[e]],{kind:c.kind,delay:c.delay,pos:c.list[e],to:c.to,list:c.list,cjs_param:c.cjs_param}),"serial"===c.mode&&b.isUndefined(c.wait)&&f.mWaitAll(a,{playtime:d-6});else d=h.mEffect(a[2].timeline[0],stage.gBossContainer,{kind:c.kind,delay:c.delay,pos:0,to:c.to,list:c.list,cjs_param:c.cjs_param});+c.wait>=0?f.mWaitAll(a,{playtime:+c.wait}):"serial"===c.mode?f.mWaitAll(a,{playtime:6}):"parallel"!==c.mode||c.nowait||f.mWaitAll(a,{playtime:d})}},getHiddenWeapon:function(b){var c=null,d=new(x.extend({urlRoot:Game.baseUri+this.getRaidType()+"/get_hiddenweapon"}));return d.set(b),this.listenTo(d,"sync",function(a){c.resolve(a.toJSON())}),this.getHiddenWeapon=function(){return c=a.Deferred(),d.save(),c},this.getHiddenWeapon()},popQuestMessage:function(a){this.popView&&this.popRemove();var b=new t({className:"pop-quest-message",title:a.title,body:a.message,flagBtnCancel:0,flagBtnOk:1});b.render(),b.$el.find(".btn-usual-ok").addClass("location-href").attr("data-location-href",a.url),b.popShow(),this.popView=b},locationHref:function(a){var b=this.$el.find(a.currentTarget).data("location-href");this.content_close(),c.history.navigate(b,!0)},popTriggerOk:function(){!!this.popView&&this.popView.trigger("onOk"),this.$el.find(".cnt-raid").trigger("onOk")},getLupiFlip:function(b){var c=null,d=new(x.extend({urlRoot:Game.baseUri+this.getRaidType()+"/get_lupiflip"}));return d.set(b),this.listenTo(d,"sync",function(a){c.resolve(a.toJSON())}),this.getLupiFlip=function(){return c=a.Deferred(),d.save(),c},this.getLupiFlip()},popInfoMessage:function(a){this.popView&&this.popRemove();var b=new t({className:"pop-info-message",title:a.title,body:a.message,flagBtnCancel:0,flagBtnOk:1});return b.render().popShow(),this.popView=b,this.popView},hideRaidInformation:function(){if(stage.gGameStatus.abilityRailUse!==Qa.OFF&&stage.gGameStatus.attackQueue.abilityRailUI&&(this.$el.find(".prt-ability-rail-overlayer").addClass("hide"),stage.gGameStatus.attackQueue.abilityRailUI.invisualize()),!stage.gGameStatus.attackQueue.attackButtonPushed){var a=this.$el.find(".btn-attack-start");a.hasClass("display-on")&&(this._controlDomAttackButton(!1),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("tap_out")),stage.gGameStatus.diagram&&this.$el.find(".img-diagram").removeClass("display-on").addClass("display-off");var b=this.$el.find(".img-score");b.hasClass("display-on")&&b.removeClass("display-on");
}this.$el.find(".cnt-raid-chat").find(".btn-chat").removeClass("display-on").addClass(ga)},showRaidInformation:function(a){if(stage.gGameStatus.abilityRailUse!==Qa.OFF&&stage.gGameStatus.attackQueue.abilityRailUI&&(this.$el.find(".prt-ability-rail-overlayer").removeClass("hide"),stage.gGameStatus.attackQueue.abilityRailUI.visualize()),!stage.gGameStatus.attackQueue.attackButtonPushed){var b=this.$el.find(".btn-attack-start");b.hasClass("display-on")||(this._controlDomAttackButton(!0),stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("in")),stage.gGameStatus.diagram&&"ability"!==stage.gGameStatus.menu&&"summon"!==stage.gGameStatus.menu&&a!==!0&&this.$el.find(".img-diagram").removeClass("display-off").addClass("display-on"),"undefined"!=typeof stage.pJsnData.survival&&stage.pJsnData.survival.score_buff&&!this.$el.find(".img-score").hasClass("display-off")&&this.$el.find(".img-score").addClass("display-on")}this.$el.find(".cnt-raid-chat").find(".btn-chat").removeClass(ga).addClass("display-on"),this.$el.find(".prt-party, .prt-summon-list").removeClass("btn-show-info on")},showChatIcon:function(){this.$el.find(".cnt-raid-chat").find(".btn-chat").removeClass(ga).addClass("display-on"),this.hideSmallChatIcon()},showSmallChatIcon:function(){var a=this.$el.find(".cnt-raid-chat").find(".btn-chat");if(0!==+stage.pJsnData.mini_chat_stamp&&!a.hasClass("sub-left")&&!a.hasClass("sub-right")){var b=2===+stage.pJsnData.mini_chat_stamp?"sub-left":"sub-right";a.removeClass(ga).addClass("display-on "+b),this._inChatButtons(),this._showChatButtons()}},hideSmallChatIcon:function(){var a=this.$el.find(".cnt-raid-chat").find(".btn-chat"),b="sub-left",c="sub-right";if(0!==+stage.pJsnData.mini_chat_stamp&&(a.hasClass(b)===!0||a.hasClass(c)===!0)){var d=2===+stage.pJsnData.mini_chat_stamp?b:c;a.removeClass(d),this._outChatButtons()}},showAutoButton:function(){stage.gGameStatus.auto_attack_display_flag&&(this._inAutoButton(),this._showAutoButton(),this._interactiveAutoButton())},hideAutoButton:function(){this._outAutoButton(),this._hideAutoButton(),this._noInteractiveAutoButton()},isFullAutoAttacking:function(){return stage.gGameStatus.auto_attack&&this.battleAutoType===Va.FULL},showLisSummonCjsEffect:function(a){var b=a.pos,c=a.effect,d="canv-summon-pos-"+b,e={width:128,height:200},f="lisSummonEffectStage"+b,g="lisSummonEffectContainer"+b,h={x:15,y:0},i="supporter"===b?6:b;this.$el.find(".prt-command-summon").find('.lis-summon[pos="'+i+'"]').addClass("has-canvas-effect"),this.playOthersCjs(c,d,e,f,g,h,!0)},playOthersCjs:function(c,d,e,f,g,h,i){var j={canvasIdName:d,stageName:f,containerName:g},k=b.some(this.playingOthersCjsList,function(a){return j.canvasIdName==a.canvasIdName&&j.stageName==a.stageName&&j.containerName==a.containerName});k!==!0&&(this.playingOthersCjsList.push(j),require(["view/raid/_play_cjs_others"],function(b){b.setParams(c,d,e,f,g,h,i),a("#"+d).addClass("show")}))},removeOthersCjsAll:function(){if(!(this.playingOthersCjsList.length<1)){var c=this,d=b.clone(c.playingOthersCjsList);this.playingOthersCjsList=[],require(["view/raid/_play_cjs_others"],function(c){b.each(d,function(b){c.removeCjs(b.stageName,b.containerName),a("#"+b.canvasIdName).removeClass("show")})})}},updateArcarumTp:function(){var a=this.arcarumRestTp||stage.pJsnData.arcarum.rest_tp;this.updateTp(a)},updateTp:function(a){var c=this.$el.find(".prt-battle-num .txt-info-num");c.empty();var d=String(a).split("");b.each(d,function(a){c.append('<div class="num-info'+a+'"><div class="num-info'+a+' light"></div></div>')})},ConfirmArcarumItem:function(b){var c=a(b.currentTarget).attr("item-id"),d=this.countItemOnRail(),e=stage.gGameStatus.arcarum.item[c].number-(d.ArcarumItem&&d.ArcarumItem[c]||0);if(!(0>=+e)){stage.gGameStatus.arcarum_item_flg=!0,stage.gGameStatus.arcarum_use_item_id=c,stage.gGameStatus.arcarum_character_num=null;var f=+stage.gGameStatus.arcarum.item[c].target;switch(f){case Ga.CHARA_SINGLE:this.ConfirmPopArcarumItemOne(c,e);break;case Ga.CHARA_ALL:this.ConfirmPopArcarumItemAll(c,e);break;case Ga.GAME_PARAM:this.ConfirmPopArcarumItemAll(c,e)}}},ConfirmPopArcarumItemAll:function(a,c){this.popView.popClose();var d="pop-event-item arcarum",e=this.getArcarumItemConfirmPopupData(+a);e.itemNum=c,!stage.gGameStatus.clear&&stage.gGameStatus.finish&&(d+=" continue"),this.popView=new t({className:d,title:D.getMessage("raid_13"),body:b.template(this._getTplTemporaryArcarum(),e),flagBtnCancel:1,flagBtnOk:1}),this.popView.render();var f=!1;switch(+a){case 1:for(var g=0;g<stage.pJsnData.formation.length;g++){var h=stage.pJsnData.formation[g];1==stage.pJsnData.player.param[h].alive&&stage.pJsnData.player.param[h].hp<stage.pJsnData.player.param[h].hpmax&&(f=!0)}break;case 3:stage.gGameStatus.arcarum.item[a].is_resurrection===!0&&(f=!0);break;case 4:stage.gGameStatus.arcarum.item[a].is_resurrection===!0&&(f=!0);break;case 20:f=!0}f===!1&&(this.popView.$el.find(".txt-select-chara").html(D.getMessage("raid_14")),this.popView.$el.find(".prt-popup-footer .btn-usual-ok").remove()),this.popView.popShow(!0,50)},ConfirmPopArcarumItemOne:function(a,c){"top"!==stage.gGameStatus.menu&&this.CommandBackTop(),this.$el.find(".prt-sub-command").children().addClass("black disabled prt-silent-se"),this.popView.popClose();var d="pop-raid-item arcarum",e=this.getArcarumItemConfirmPopupData(+a);e.itemNum=c,!stage.gGameStatus.clear&&stage.gGameStatus.finish&&(d+=" continue"),this.popView=new t({className:d,title:D.getMessage("raid_13"),body:b.template(this._getTplTemporaryArcarum(),e),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.popView.popShow(!0,50),i.mPlayerBannerList({type:"condition"})},getArcarumItemConfirmPopupData:function(a){function c(a){var b={POTION:1,HERB:2,CURE_ALL:4,TP_POTION:20},c=null,e=stage.gGameStatus.arcarum.item;switch(+a){default:return null;case b.TP_POTION:c={label:D.getMessage("arcarum_param_1"),before:d.arcarumRestTp,after:+d.arcarumRestTp+ +e[b.TP_POTION].effect_value}}return c}var d=this;return{arcarumItemList:b.clone(stage.gGameStatus.arcarum.item),selectedItemId:a,paramChangeInfo:c(+a)}},UseArcarumItem:function(){if(!stage.gGameStatus.btn_lock){stage.gGameStatus.btn_lock=!0;var a={raid_id:stage.pJsnData.raid_id,item_id:stage.gGameStatus.arcarum_use_item_id,character_num:stage.pJsnData.formation[stage.gGameStatus.arcarum_character_num]||null},b="item_"+stage.gGameStatus.arcarum.item[stage.gGameStatus.arcarum_use_item_id].battle_icon_type;stage.gGameStatus.attackQueue.queue.push({index:"itemUse",param:a,action:"arcarum_temporary_item_result",iconPath:b,itemType:"ArcarumItem"}),this.AddAttackQueueUI(b),stage.gGameStatus.btn_lock=!1,this.CancelTempItemUse(),1===stage.gGameStatus.attackQueue.queue.length&&this.itemUse()}},useArcarumItemProcess:function(){stage.gGameStatus.arcarum_item_flg=!1,stage.gAryRootParts[0][stage.gGameParam.cjs.parts[0]].gotoAndPlay("out"),stage.gGameStatus.node_finish||this.HideCommand(),stage.gGameStatus.menu="temporary",stage.gGameStatus.finish=!1},_getTplTemporaryArcarum:function(){var b=a("#tpl-temporary-arcarum").html();return this._getTplTemporaryArcarum=function(){return b},this._getTplTemporaryArcarum()},arcarumStageEffect:function(){stage.gGameStatus.attacking=1;var c=a("body"),d=a(document).scrollTop();Game.ua.isJssdk()&&(c=a(Game.gameContainer.selector),d=a(Game.gameContainer.selector).parent().scrollTop()),a("body").hasClass("pc")||this.setBodyPreventDefault(c),d>1&&window.scrollTo(0,0),clearInterval(stage.gGameStatus.timer.mBalloon),this.playScenarios({scenario:b.filter(stage.pJsnData.scenario,function(a){return"arcarum_stage_effect"===a.cmd})})},getReleaseArcarumStageEffectCjsName:function(a){var b="arcarum_battle_cancel_";switch(a){default:return null;case Ja.SEAL_CHARGE_ATTACK:return b+2;case Ja.POISON:return b+1;case Ja.DOUBLE_ATTACK_DOWN:case Ja.TRIPPLE_ATTACK_DOWN:return b+4;case Ja.SEAL_ABILITY:return b+3}},switchAttackStatus:function(a,b){Ba=a,this.$el.find(".btn-attack-start").toggleClass(Ea,!a),b=b||stage.pJsnData.attack_disable_comment,a===!1&&b?this.attackDisableComment=b:this.attackDisableComment=""},postSetSkipSpecialOne:function(c){var e,f=this,g=this.$el.find(c.currentTarget),h=g.data("pos"),j=1e3,k="holdSetSkipSpecialButton",l=g.hasClass("prt-skip-special-stage"),m=this._getLsizePlayerPos();if(b.isUndefined(h)!==!0&&this.isHoldSetSkipSpecial!==!0){if(null!==m&&l===!0&&(h=m),e=stage.pJsnData.player.param[stage.pJsnData.formation[h]],l===!0){if(b.isUndefined(e)===!0||0===+e.alive)return;p.playSE("se/btn_se/btn_se_03.mp3")}Game.loading.xhrStartNoImage(),this.isHoldSetSkipSpecial=!0,this.clearTimeoutOne(k);var n=new d,o={setting_id:e.setting_id,skip_flag:e.skip_flag===!0?0:1};n.save(o,{url:n.urlRoot("skip_special_motion_setting","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){Game.loading.xhrEndNoImage()},success:function(){e.skip_flag=e.skip_flag===!1,i.mSetSpecialSkip(e.skip_flag===!0,null===m||h===m,h,!0),a("#prt-sub-command-group").find(".btn-set-skip-special-all").removeClass("set-on set-off").addClass(f._getSkipSpecialAllClassName()),f.setNamedTimeout(k,function(){Game.loading.xhrEndNoImage(),f.isHoldSetSkipSpecial=!1},j)}})}},postSetSkipSpecialAll:function(a){var c=this,e=this.$el.find(a.currentTarget),f=e.hasClass("set-on"),g=[],h=1e3,j="holdSetSkipSpecialButton";if(this.isHoldSetSkipSpecial!==!0){Game.loading.xhrStartNoImage(),this.isHoldSetSkipSpecial=!0,this.clearTimeoutOne(j),b.each(stage.pJsnData.player.param,function(a){g.push(a.setting_id)});var k=f===!0,l=new d,m={setting_ids:g.join(","),skip_flag:f===!0?1:0};l.save(m,{url:l.urlRoot("skip_special_motion_setting_all","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){Game.loading.xhrEndNoImage()},success:function(){b.each(stage.pJsnData.player.param,function(a,b){stage.pJsnData.player.param[b].skip_flag=k}),i.mSetSpecialSkipAll(f),c.setNamedTimeout(j,function(){Game.loading.xhrEndNoImage(),c.isHoldSetSkipSpecial=!1},h)}})}},_getSkipSpecialAllClassName:function(){var a=!1,c=b.some(stage.pJsnData.player.param,function(c,d){return a=-1!==b.indexOf(stage.pJsnData.formation,""+d),a===!0&&1===+c.alive&&c.skip_flag===!1});return c===!0?"set-on":"set-off"},_getLsizePlayerPos:function(){var a=null;return b.some(stage.gGameStatus.player.param,function(b,c){return"l"===b.type?(a=c,!0):void 0}),a},_removeSubCommand:function(){1!==+stage.pJsnData.multi&&(a("#prt-sub-command-group").empty(),this.hideRecoverAtMenu=!0,this.$el.find(".prt-command-chara").find(".btn-skip-special").remove(),a("#prt-set-special-skip").empty())},updateSequencePoint:function(c){var d=this,e="limit",f=0,g=a("#prt-sequence-info"),h=g.find(".txt-current-point"),i=g.find(".txt-current-point-bonus"),j=g.find(".txt-limit-point-bonus");this.updateSequencePoint=function(a){b.each(a,function(a){switch(+a.category){case 1:d.currentDamageSequencePoint+=+a.point,h.html(d.numberFormat(d.currentDamageSequencePoint));break;case 2:d.currentBonusSequencePoint+=+a.point,i.html(d.numberFormat(d.currentBonusSequencePoint)),a.total&&(f=+a.total,j.html(d.numberFormat(f))),i.hasClass(e)===!1&&f===d.currentBonusSequencePoint&&i.addClass(e)}})},this.updateSequencePoint(c)},getSequencePointLog:function(){var a=this,b=new d;b.set({raid_id:stage.pJsnData.raid_id},{url:b.urlRoot("sequence_log","",stage.pJsnData.is_multi,stage.pJsnData.is_semi)}),this.getSequencePointLog=function(){b.save().done(function(b){a.scrollPopShow("<div class='pop-sequence-log'>"+D.getMessage("raid_12")+"</div>"),a.showSequencePointLog(b.log)})},this.getSequencePointLog()},showSequencePointLog:function(c){var d=this.$el.find(".pop-sequence-log"),e="";if(0===c.length)e=D.getMessage("raid_53");else{var f={playerImage:stage.pJsnData.player.param[0].pid_image,logList:b.sortBy(c,function(a,b){return-b})};e=b.template(a("#tpl-sequence-point-log").html(),{data:f})}d.html(e)},setSpecialConditionInfo:function(){a("#prt-special-condition").addClass("prt-show-condition").html(b.template(a("#tpl-special-condition").html(),stage.pJsnData.special_condition))},updateSpecialConditionTurn:function(c){var d=+stage.pJsnData.special_condition.turn-+c+1,e=D.replaceMessage("raid_training_battle_1",{"%s":d},d);a("#prt-special-condition-turn").html(b.template(a("#tpl-special-condition-turn").html(),{turnTxt:e}))},requireIndividual:function(b){var c=new a.Deferred;return require([b],function(a){c.resolve(a)}),c.promise()},showBattleCondition:function(a,c,d,e){if(d&&(!a||c)){var f=this.$el.find(".prt-battle-condition"),g=f.find(".txt-title"),h=f.find(".txt-body");a&&c?g.html(c):f.addClass("is-no-title"),h.html(d),f.css("display","block").off().one("tap",function(){f.css("display","none").removeClass("is-no-title"),g.empty(),h.empty(),e&&b.isFunction(e)&&e()})}},setBodyPreventDefault:function(a){ea===!0?fa.addEventListener(Game.cgtouchstartEvent,this.handlerPreventDefault,{capture:!1,passive:!1}):a.on("cgtouchstart",this.handlerPreventDefault)},offBodyPreventDefault:function(a){ea===!0?fa.removeEventListener(Game.cgtouchstartEvent,this.handlerPreventDefault,!1):a.off("cgtouchstart")},handlerPreventDefault:function(a){a.preventDefault()},onTouchChatButton:function(b){var c=b.type,d="mousedown"===c||"touchstart"===c?"on":"in",e=a(b.currentTarget),f=e.hasClass("sub-left")||e.hasClass("sub-right"),g=+e.attr("category"),h=9999;f&&(g===h?stage.gAryRootParts[6][stage.gGameParam.cjs.parts[6]].gotoAndPlay(d):stage.gAryRootParts[5][stage.gGameParam.cjs.parts[5]].gotoAndPlay(d))},removeFooterTreasurePop:function(){!b.isUndefined(Game.footer)&&Game.footer.mainView.popView&&Game.footer.mainView.popRemove()},getAttackMessage:function(a,b){var c=null;switch(+a){case 2:c="raid_6";break;case 3:c="raid_7";break;case 4:c="raid_attack_4times";break;default:return null}return D.replaceMessage(c,[b])},replaceBG:function(a){if(stage.gGameStatus.isDrawBgImgByCjs){if(stage.pJsnData.background!==a){var b=a.replace(/.*\/([^.]*)\..*/,"$1");stage.gGameStatus.backImage.firstImg.image=stage.gGameStatus.backImage[b].image,stage.pJsnData.background=a}}else this.$el.find(".prt-bg-stage-distant").css("background-image","url("+Game.imgUri+a+")")},setTmpPersonalField:function(a){stage.gGameStatus.field.tmpFieldNum=b.size(a),stage.gGameStatus.field.tmpPersonalField=b.filter(a,function(a){return a.is_personal===!0})},getIsLinkedDamageMotion:function(){var a=!1;return b.some(stage.gGameStatus.boss.param,function(c){return b.some(c.motion_link_list,function(b){return a=!!b.motion_link.damage})}),a},popHelpShow:function(a,b){var c=[b],d="retire"===a?"pop-retire-help":"pop-lose-help";this.helpView=new s({className:d,list:c}),this.helpView.render().popShow()},popHelpHide:function(){this.helpView.popRemove()},popRemoveLoseHelp:function(){this.popHelpHide(),this.LosePopShow()},showNextWithoutRecoveryPopup:function(){var a=this;stage.gGameStatus.finish=!0,stage.gGameStatus.battle_end=!0,this.$el.find(".prt-enemy-percent").css("display","none"),this.$el.find(".prt-targeting-area").css("display","none"),stage.gAryRootParts[4][stage.gGameParam.cjs.parts[4]].gotoAndPlay("in"),stage.gAryCntnParts[4].visible=!0,this.$el.find(".prt-command-end").css("display","block"),this.$el.find(".btn-result").one("tap",function(){stage.gAryRootParts[4][stage.gGameParam.cjs.parts[4]].gotoAndPlay("out"),a.Withdraw()})},getIsReadyToPlayScenario:function(){var a=stage.gGameStatus,b=0===a.attackQueue.queue.length&&!a.isPlayingScenariosImmediately;return b},setStageTouchable:function(a){var c=this.$el.find(".cnt-raid-stage");this.setStageTouchable=function(a){b.isBoolean(a)&&c.css("pointer-events",a?"":"none")},this.setStageTouchable(a)}});return $b});