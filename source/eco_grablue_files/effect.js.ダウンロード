define(["underscore","lib/raid/draw"],function(a,b){var c={x:490,y:540},d={$viewContents:$("#wrapper").find(".contents"),mBrightnessOut:function(a,b){b.duration=b.duration?b.duration:"0.3s",b.count=b.count?b.count:"1",a.call(function(){var a=d.$viewContents.find(".prt-bg-effect-brightness");a.addClass("to-black-stop").css({"animation-duration":b.duration,"-webkit-animation-duration":b.duration,"animation-iteration-count":b.count,"-webkit-animation-iteration-count":b.count})})},mBrightnessIn:function(a,b){b.duration=b.duration?b.duration:"0.3s",b.count=b.count?b.count:"1",a.call(function(){var a=d.$viewContents.find(".prt-bg-effect-brightness");a.removeClass("to-black-stop").addClass("to-black-start").css({"animation-duration":b.duration,"-webkit-animation-duration":b.duration,"animation-iteration-count":b.count,"-webkit-animation-iteration-count":b.count}).on("animationend webkitAnimationEnd",function(){$(this).removeClass("to-black-start").attr("style","")})})},mDamageRattle:function(a,b){var c=this;b=b?b:0,a.call(function(a){setTimeout(function(){var a=25,b=2;c.mCommonShake(stage.gAryCntnAvatar,a,b),c.mCommonShake(stage.gAryCntnBoss,a,b)},a)},[b])},mCommonShake:function(b,c,d){var e=1;a.each(b,function(b){b.beforeY=b.beforeY||b.y,b.y=b.beforeY;var f=createjs.Tween.get(b,{override:!0});a.each(a.range(d),function(){f=f.wait(c).set({y:b.y+e}).wait(c).set({y:b.y-e}).wait(c).set({y:b.y})})})},mHitEffect:function(a,d,e){e.kind=e.kind?e.kind:"",e.delay=e.delay?e.delay:0,e.isAllAttackEffect=e.isAllAttackEffect||!1;var f=e.pos||0,g=new lib[e.kind],h=new createjs.Container,i=g[e.kind][e.kind+"_effect"].timeline.duration;return h.addChild(g),a.call(function(a,d,e){var i=d.type,j=stage.gGameStatus.union_enemy,k=j&&"boss"===i||d.isAllAttackEffect===!0&&"player"===i;setTimeout(function(){k===!0?stage.gBossContainer.addChild(h):a.addChild(h);var b=stage.gGameParam.grid.hit;if("player"===i)d.isAllAttackEffect===!1?(h.x+=b[i].x,h.y+=b[i].y):(h.x=c.x,h.y=c.y);else if("boss"===i){var e=stage.pJsnData.boss.param[f].effect_position||{x:0,y:0};j?(h.x=190+(+e.x||0),h.y=540+(+e.y||0)):(h.x+=b[i][d.size].x+(+e.x||0),h.y+=b[i][d.size].y+(+e.y||0)),d.adjustValues&&(h.x+=d.adjustValues.x,h.y+=d.adjustValues.y)}g[d.kind].gotoAndPlay(6)},d.delay*stage.gGameParam.spf),k===!0?b.mRemove(e+d.delay,h,stage.gBossContainer):b.mRemove(e+d.delay,h,a)},[d,e,i]),i},mEffect:function(a,d,e){e.kind=e.kind?e.kind:"",e.delay=e.delay?e.delay:0;var f=e.pos||0,g=new lib[e.kind](void 0,void 0,void 0,e.cjs_param),h=new createjs.Container,i=g[e.kind][e.kind+"_effect"].timeline.duration;return h.addChild(g),a.call(function(a,d,e){setTimeout(function(){var b=stage.gGameStatus.union_enemy,e=d.to;if(!b||"boss"!==e&&"boss_fullscreen"!==e?a.addChild(h):stage.gBossContainer.addChild(h),"player_fullscreen"!==e&&"boss_fullscreen"!==e){var g=d.list?d.list.length:0;if("player"===e)if(g>0){var i=stage.gGameParam.grid.effect[e];h.x+=i.x,h.y+=i.y}else h.x=c.x,h.y=c.y;else if("boss"===e){var j=stage.pJsnData.boss.param[f].effect_position||{x:0,y:0};if(b)h.x=190+(+j.x||0),h.y=540+(+j.y||0);else if(g>0){var i=stage.gGameParam.grid.effect[e][stage.pJsnData.boss.type];h.x+=i.x+(+j.x||0),h.y+=i.y+(+j.y||0)}else h.x=190,h.y=540}}},d.delay*stage.gGameParam.spf),!stage.gGameStatus.union_enemy||"boss"!==d.to&&"boss_fullscreen"!==d.to?b.mRemove(e+d.delay,h,a):b.mRemove(e+d.delay,h,stage.gBossContainer)},[d,e,i]),i},mAbility:function(a,c,d){d.kind=d.kind?d.kind:"";var e=new lib[d.kind],f=new createjs.Container,g=e[d.kind][d.kind+"_effect"].timeline.duration;return f.addChild(e),a.call(function(a,c,d){a.addChild(f),"player"===c.to?(f.x+=stage.gGameParam.grid.effect[c.to].x,f.y+=stage.gGameParam.grid.effect[c.to].y):"boss"===c.to&&(f.x+=stage.gGameParam.grid.effect[c.to][stage.pJsnData.boss.type].x,f.y+=stage.gGameParam.grid.effect[c.to][stage.pJsnData.boss.type].y),b.mRemove(d,f,a)},[c,d,g]),g},mSpecial:function(d,e,f){f.size=f.size?f.size:"";var g,h=new lib[e.kind](void 0,void 0,void 0,e.cjs_param),i=new createjs.Container,j=h[e.kind][e.kind+"_special"].timeline.duration,k=a.contains(["esp_8101983_01"],e.kind),l=a.isUndefined(e.force_top_flag)===!1&&1===+e.force_top_flag,m=a.clone(stage.gGameStatus.waitmode),n=5;if(e.skip_flag===!0){var o=0,p=0,q=!1,r=!1,s=e.kind.match(/^sp_/);a.isNull(s)||(q=!0,p=parseInt(stage.gGameStatus.defaultWeaponSkipFrame,10),j>p&&(r=!0));var s=e.kind.match(/^esp_/);a.isNull(s)||(p=parseInt(stage.gGameStatus.defaultEnemySkipFrame,10));var s=e.kind.match(/^nsp_/);a.isNull(s)||(p=parseInt(stage.gGameStatus.defaultNpcSkipFrame,10)),e.skip_frame_nsp&&(p=e.skip_frame_nsp),e.nsp_skip_frame&&(p=e.nsp_skip_frame),1===Game.isSandbox&&""!==$("#debug_skip_frame_nsp").val()&&(p=e.skip_frame_nsp=parseInt($("#debug_skip_frame_nsp").val(),10)),(e.skip_frame_nsp||j>+p)&&(o=j-+p,j=+p),o+=n,j-=n,0>o&&(j+=o,o=0)}if(i.addChild(h),e.skip_flag===!0){var t=new lib.raid_mortal_skip(void 0,void 0,void 0,e.cjs_param),u=new createjs.Container,v=2;u.addChild(t);var w=t.raid_mortal_skip.raid_mortal_skip_special.timeline.duration,x=w-v}return d.call(function(a,d,e){if(stage.gScenarioParam=a,stage.gScenarioParam.bossWaitMode=m,"player"===a.target||k===!0){if(g=l===!1?stage.gPlayerContainer:stage.gBossContainer,g.addChild(i),0!==a.to&&!a.to||1===+a.effect_all)i.x=c.x,i.y=c.y;else{var f=30;i.x=stage.gAryCntnAvatar[a.to].x,i.y=stage.gAryCntnAvatar[a.to].y+f}b.mRemove(e,i,g)}else if("boss"===a.target){if(a.skip_flag===!0){var j=createjs.Tween.get({},{useTicks:!0});stage.gSkipContainer.addChild(u),b.mRemove(w,u,u.parent)}a.full_screen_flag===!0?(stage.gNspContainer.addChild(i),a.skip_flag===!0&&j.wait(x).call(function(){h[a.kind][a.kind+"_special"].gotoAndPlay(o),a.skip_label_nsp&&h[a.kind][a.kind+"_special"][a.skip_label_nsp].gotoAndPlay(o)})):(a.fixed_pos_owner_bg?stage.gAryCntnAvatar[a.pos].addChildAt(i,0):stage.gBossContainer.addChild(i),a.skip_flag===!0&&(q===!0?r===!0&&j.wait(x).call(function(){h[a.kind][a.kind+"_special"].gotoAndPlay(o,1),a.skip_label_nsp&&h[a.kind][a.kind+"_special"][a.skip_label_nsp].gotoAndPlay(o,1)}):j.wait(x).call(function(){h[a.kind][a.kind+"_special"].gotoAndPlay(o,1),a.skip_label_nsp&&h[a.kind][a.kind+"_special"][a.skip_label_nsp].gotoAndPlay(o,1)})));var n={s:0,m:0,l:80},p={s:160,m:100,l:0},s=n[d.size],f=p[d.size];if(a.fixed_pos_owner_bg){stage.update();var t=stage.gNspContainer.localToGlobal(0,0),v=i.globalToLocal(t.x,t.y);0===+Game.setting.cjs_mode&&(v.x/=Game.cjsScale,v.y/=Game.cjsScale),i.x=v.x,i.y=v.y}else 0===a.to||a.to?a.full_screen_flag===!0?(i.x=0,i.y=0):(i.x=stage.gAryCntnBoss[a.to].x+s,i.y=stage.gAryCntnBoss[a.to].y+f):(i.x=190,i.y=540);var y=e;a.skip_flag===!0&&(y+=x),b.mRemove(y,i,i.parent)}},[e,f,j]),e.skip_flag===!0?j+x:j},mChainCutin:function(a,c){window.chain_num=Number(c.chain_num);var d=c.images.length,e="raid_"+d+"chain",f="raid_chain_"+d+"chain",g=new lib[stage.gGameParam.cjs.raid_chain],h=g[stage.gGameParam.cjs.raid_chain][f].timeline.duration,i=new createjs.Container;return i.addChild(g),stage.gMasterContainer.addChild(i),a.call(function(){if(createjs.denaVersion){i._layer=1;for(var a=stage.gMasterContainer.getNumChildren()-1;a>=0;--a){var c=stage.gMasterContainer.getChildAt(a);c!==i&&(c._passive=1)}}g[stage.gGameParam.cjs.raid_chain].gotoAndPlay(e),b.mRemove(h,i,stage.gMasterContainer)},[c]),h},mSummonCutin:function(a,c){a.call(function(a){stage.gGameStatus.raid_union_summon_name=a.name;var c=new lib[stage.gGameParam.cjs.raid_union_summon],d=c[stage.gGameParam.cjs.raid_union_summon].ui_parts.timeline.duration,e=new createjs.Container;e.addChild(c),e.x=stage.gGameParam.relative.summon_union.x,e.y=0,stage.gMasterContainer.addChild(e),b.mRemove(d,e,stage.gMasterContainer)},[c])},mSummon:function(c,d,e){e.size=e.size?e.size:"",d.target="boss",e.speed=e.speed?e.speed:"";var f=new lib[d.kind],g=new createjs.Container,h=f[d.kind][d.kind].timeline.duration;g.addChild(f);var i,j,k,l=a.clone(stage.gGameStatus.waitmode);if("undefined"!=typeof e.speed&&2==e.speed&&d.kind.match(/_attack$/)){if(10>=h)return 0;i=8,j=4,k=12;var m=h-i-k,n=parseInt(m/(j-1)),o=m%(j-1);h=i+k+k*(j-1)+o}if(c[2].timeline[0].call(function(a,c,d){if(stage.gScenarioParam=a,stage.gScenarioParam.bossWaitMode=l,createjs.denaVersion){g._layer=1;for(var e=stage.gMasterContainer.getNumChildren()-1;e>=0;--e){var f=stage.gMasterContainer.getChildAt(e);f._passive=1}}stage.gMasterContainer.addChild(g),g.x=stage.gGameParam.relative.summon.x,g.y=stage.gGameParam.relative.summon.y,b.mRemove(d,g,stage.gMasterContainer)},[d,e,h]),"undefined"!=typeof e.speed&&2==e.speed&&d.kind.match(/_attack$/)){for(var p=0;1>=p;p++)for(var q=0,r=c[p].timeline.length-1;r>=q;q++)c[p].timeline[q].wait(i);c[2].timeline[0].wait(i);for(var s=i,p=0,t=j-1;t>p;p++){for(var q=0;1>=q;q++)for(var u=0,v=c[q].timeline.length-1;v>=u;u++)c[q].timeline[u].wait(k);c[2].timeline[0].wait(k).call(function(a,b){s+=n,b[a.kind][a.kind].gotoAndPlay(s)},[d,f])}h=k+o}return h},mGetTreasure:function(b,c,d,e,f){var g=f===!0?d:[d],h=g.length;a.each(g,function(d,g){var i=new lib.treasure_get(null,null,null,d.length,a.map(d,function(a){return parseInt(a,10)})),j=new createjs.Container;j.addChild(i),f===!0&&h>1?(j.x+=stage.gGameParam.relative.treasure_multiple[h][g].x,j.y+=stage.gGameParam.relative.treasure_multiple[h][g].y):(j.x+=stage.gGameParam.relative.treasure[stage.pJsnData.boss.type].x,j.y+=stage.gGameParam.relative.treasure[stage.pJsnData.boss.type].y),c.addChild(j),stage.gGameStatus.dropped.push([d,i,j]),b.call(function(a){a?i.treasure_get.gotoAndPlay("wait"):i.treasure_get.gotoAndPlay("start")},[e])})},mOpenTreasure:function(a,b){a.call(function(a){a[1].treasure_get.gotoAndPlay("end")},[b]);var c=b[1].treasure_get.timeline.duration;return c},mDeleteTreasure:function(c,d){a.each(c,function(a){b.mRemove(d.delay,a[1],a[2])})},mGetItem:function(a,c,d){var e=new lib.item_get(null,null,null,parseInt(d[0])),f=new createjs.Container;f.addChild(e),f.x+=stage.gGameParam.relative.item[stage.pJsnData.boss.type].x,f.y+=stage.gGameParam.relative.item[stage.pJsnData.boss.type].y,c.addChild(f),a.call(function(a){e.item_get.gotoAndPlay("start");var c=60;b.mRemove(c,f,a)},[c])}};return d});