define(["backbone","view/content","view/popup","model/data","model/token-data","util/language-message"],function(a,b,c,d,e,f){var g=["halloween","christmas","newyear","valentine","valentine2","white","white2","birthday"],h=0,i=1,j=5,k=0,l=1,m=1,n=2,o={valentine:m,valentine2:m,white:n,white2:n},p=200,q=1,r=1,s=2,t=3,u=1,v=3030135e3,w={HALLOWEEN:"seasonmessage_halloween_title",CHRISTMAS:"seasonmessage_christmas_title",NEWYEAR:"seasonmessage_newyear_title",VALENTINE:"seasonmessage_valentine_title",VALENTINE2:"seasonmessage_valentine_title",WHITE:"seasonmessage_white_title",WHITE2:"seasonmessage_white_title",BIRTHDAY:"seasonmessage_birthday_title"},x={HALLOWEEN:"seasonmessage_halloween_message_title",CHRISTMAS:"seasonmessage_christmas_message_title",NEWYEAR:"seasonmessage_newyear_message_title",VALENTINE:"seasonmessage_valentine_message_title",VALENTINE2:"seasonmessage_valentine_message_title",WHITE:"seasonmessage_white_message_title",WHITE2:"seasonmessage_white_message_title",BIRTHDAY:"seasonmessage_birthday_message_title"},y=[20201,20202,20203,20204,20223,20224,20240],z=b.extend({modelJSON:null,eventName:null,eventType:null,vwTypeString:"",events:{"tap .btn-season-message.scenelist":"getScenarioList","tap .btn-season-message.navigate-scene":"navigateScene","tap .btn-play-eventepisode":"locationHref","tap .pop-seasonmessage-select .btn-usual-close":"popRemove","tap .btn-season-message.vw-samesex":"popSameSex","tap .btn-season-message.vw-present-keyitem-comfirm":"popConfirmPresentKeyitem","tap .btn-season-message.vw-no-keyitem":"popNoKeyItem","tap .pop-vw-present-confirm .btn-usual-ok":"navigateScene","tap .pop-vw-purchase-confirm .btn-usual-ok":"purchaseKeyitem","change .pop-vw-purchase-confirm .num-set":"updateLupiPreview","tap .pop-vw-no-keyitem .btn-usual-ok:not(.disabled)":"fetchPurchaseKeyitemData","tap .btn-valentine-banner, .btn-whiteday-banner":"fetchPurchaseKeyitemData","tap .pop-vw-purchase-success .btn-usual-close":"locationSameHash",'tap [class*="pop-vw-"] .btn-usual-cancel':"popRemove",'tap [class*="pop-vw-"] .btn-usual-close':"popRemove","tap .pop-vw-first-login .btn-about-gender":"popAboutGender","tap .pop-vw-purchase-confirm .btn-about-gender":"popAboutGender","tap .pop-vw-about-gender .btn-usual-close":"popRemoveAboutGender","tap .btn-season-message.pop-season-message-single":"popMessage","tap .pop-season-message-single .btn-usual-close":"popRemove"},initialize:function(){void 0!==this.model&&(this.modelJSON=this.model.toJSON(),this.seasonMessageArray=this.createRenderData(),this.render())},render:function(){Game.isReceivedSeasonMessageItem&&_.isEmpty(this.vwTypeString)===!1&&""!==this.modelJSON[this.vwTypeString].item_id&&(Game.isReceivedSeasonMessageItem=!1,this.popReceiveItem())},createRenderData:function(){var a,b=this,c=[],d=g,e=d.length;for(a=0;e>=a;a++){var f=d[a],h=b.modelJSON[f],i=o[f]||null;if("undefined"!=typeof h&&h.has_present){var j=+h.view_count,k=h.all_view_flag,l="";if(h.button_status)switch(h.button_status){case r:l="btn-valentine-1";break;case s:l="btn-valentine-2";break;case t:l="btn-valentine-off"}else l="btn-"+f+(j>1&&!k?"-2":"-1");c.push({type:f,actionName:this.getClassName(h,f),btnStyleName:l,messageEventType:i}),_.isEmpty(this.vwTypeString)===!0&&_.isNull(i)===!1&&(this.vwTypeString=f)}else"undefined"!=typeof h&&h.has_present===!1&&h.message&&c.push({type:f,actionName:"pop-season-message-single",btnStyleName:"btn-"+f+"-3",messageEventType:i})}return c},getClassName:function(a,b){var c=(+a.view_count,a.all_view_flag);if("valentine"===b||"valentine2"===b||"white"===b||"white2"===b){var d="",e=+a.choco_amount||0,f=a.button_status,h=+a.present_type,i=a.need_present,j=a.recieved_choco;return d=f===t?"vw-samesex":h!=u||1!=i||j?c===!0?"scenelist":"navigate-scene":e>=q?"vw-present-keyitem-comfirm":"vw-no-keyitem"}return _.contains(g,b)?c===!0?"scenelist":"navigate-scene":void 0},popSameSex:function(){if(_.isEmpty(this.vwTypeString)!==!0){var a="";switch(this.eventType="valentine"===this.vwTypeString?m:n,+this.modelJSON[this.vwTypeString].sex){case l:a=+this.eventType===m?"seasonmessage_valentine_1":"seasonmessage_white_5";break;case k:a=+this.eventType===m?"seasonmessage_valentine_2":"seasonmessage_white_6"}this.popView=new c({className:"pop-vw-samesex type-"+this.eventType,title:f.getMessage("seasonmessage_valentine_3"),body:f.getMessage(a),flagBtnClose:1}),this.popView.render().popShow()}},popReceiveItem:function(){if(_.isEmpty(this.vwTypeString)!==!0){this.eventType="valentine"===this.vwTypeString?m:n;var a=this.modelJSON[this.vwTypeString],b={npcName:a.chara_name,itemName:a.item_name,itemId:a.item_id,itemKind:a.item_kind,eventType:this.eventType};+a.unique_id===v&&(b.npcName=+this.eventType===m?f.getMessage("seasonmessage_3"):f.getMessage("seasonmessage_2"));var d=+this.eventType===m?"seasonmessage_valentine_5":"seasonmessage_white_7";if("en"==Game.lang){b.itemLowerName=b.itemName.toLowerCase();var e=y;_.contains(e,+b.itemId)&&(b.itemLowerName=b.itemLowerName.charAt(0).toUpperCase()+b.itemLowerName.slice(1))}this.popView=new c({className:"pop-vw-present-confirm type-"+this.eventType,title:f.getMessage(d),body:_.template($("#tpl-pop-vw-receiveitem").html(),b),flagBtnClose:1}),this.popView.render().popShow()}},popNoKeyItem:function(a){this.eventType=$(a.currentTarget).data("type"),this.popView=new c({className:"pop-vw-no-keyitem type-"+this.eventType,title:f.getMessage("seasonmessage_valentine_4"),body:_.template($("#tpl-pop-give-vw-item-deny").html(),{eventType:this.eventType}),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow(),this.popView.$el.find(".btn-usual-ok").attr("data-type",this.eventType)},popConfirmPresentKeyitem:function(a){if(_.isEmpty(this.vwTypeString)!==!0){this.eventType=$(a.currentTarget).data("type");var b=$(a.currentTarget).data("event-name"),d=this.modelJSON[b],e={npcName:d.chara_name,keyItemCount:+d.choco_amount,eventType:this.eventType};+d.unique_id===v&&(e.npcName=+this.eventType===m?f.getMessage("seasonmessage_2"):f.getMessage("seasonmessage_3")),this.popView=new c({className:"pop-event-valentine pop-vw-present-confirm type-"+this.eventType,title:f.getMessage("seasonmessage_valentine_4"),body:_.template($("#tpl-pop-give-vw-item-confirm").html(),e),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow(),this.popView.$el.find(".btn-usual-ok").attr("data-event-name",b)}},fetchPurchaseKeyitemData:function(a){this.eventType=$(a.currentTarget).data("type");var b=new(d.extend({urlRoot:Game.baseUri+"shop/item_chocolate/"+this.eventType}));this.listenToOnce(b,"sync",this.popConfirmKeyItem),b.fetch()},popConfirmKeyItem:function(a){this.shopChocoJSON=a.toJSON();var b=this.shopChocoJSON.remain_number>0,d={maxBuyCount:+this.shopChocoJSON.max_number,price:this.shopChocoJSON.price||p,eventType:+this.eventType,isRemained:b},e=this.shopChocoJSON.lupi,g=e<d.price||b===!1?0:1,h=+this.eventType===m?"seasonmessage_valentine_6":"seasonmessage_white_1";this.popView=new c({className:"pop-vw-purchase-confirm type-"+this.eventType,title:f.getMessage(h),body:_.template($("#tpl-pop-vw-purchase-confirm").html(),d),flagBtnCancel:1,flagBtnOk:g}),this.popView.render().popShow(),this.updateLupiPreview()},updateLupiPreview:function(){var a=(this.$el.find(".prt-popup-footer .btn-usual-buy"),this.shopChocoJSON.price||p),b=this.shopChocoJSON.lupi,c=+$("#purchase-count-choco").children(":selected").val(),d=b-c*a;this.$el.find(".current-money").html(b),this.$el.find(".after-money").html(d)},purchaseKeyitem:function(){var a={num:+$("#purchase-count-choco").children(":selected").val(),type:this.eventType};this.chocoPurchaseModel=new(e.extend({urlRoot:Game.baseUri+"shop/chocolate_purchase"})),this.chocoPurchaseModel.set(a),this.stopListening(this.chocoPurchaseModel),this.listenToOnce(this.chocoPurchaseModel,"sync",this.popSuccessPurchaseKeyitem),this.listenToOnce(this.chocoPurchaseModel,"error",this.popErrorPurchaseKeyitem),this.chocoPurchaseModel.save()},popSuccessPurchaseKeyitem:function(){var a=this.chocoPurchaseModel.toJSON(),b={purchaseCount:+a.num,eventType:+a.type},d=+b.eventType===m?"seasonmessage_valentine_7":"seasonmessage_white_2";this.popView=new c({className:"pop-vw-purchase-success type-"+this.eventType,title:f.getMessage(d),body:_.template($("#tpl-pop-vw-purchase-success").html(),b),flagBtnClose:1}),this.popView.render().popShow(),this.$el.find(".prt-lupi").html(a.lupi)},popErrorPurchaseKeyitem:function(){var a=+this.eventType===m?["seasonmessage_valentine_8","seasonmessage_valentine_9"]:["seasonmessage_white_3","seasonmessage_white_4"];this.popView=new c({className:"pop-vw-purchase-error type-"+this.eventType,title:f.getMessage(a[0]),body:f.getMessage(a[1]),flagBtnClose:1}),this.popView.render().popShow()},locationSameHash:function(){a.history.fragment="",a.history.navigate(location.hash,!0)},createSceneParams:function(a){this.eventName=$(a.currentTarget).data("event-name"),this.eventObj=this.model.get(this.eventName),this.isStoryNpc=+this.eventObj.is_story_npc===i?i:h},navigateScene:function(b){this.createSceneParams(b),this.content_close();var c=_.isUndefined(this.eventObj.sex)?"":"/"+this.eventObj.sex,d=this.eventObj.scene_id+"/"+this.isStoryNpc+"/"+this.eventObj.season_event_id+"/"+this.eventObj.unique_id+"/"+this.eventObj.view_count,e="quest/season_event_scene/"+d+"/"+j+c;a.history.navigate(e,!0)},getScenarioList:function(a){var b=this;this.createSceneParams(a);var c=_.isUndefined(this.eventObj.sex)?"":"/"+this.eventObj.sex,e=this.eventObj.unique_id+"/"+this.eventObj.season_event_id+"/"+this.eventObj.view_count,f=Game.baseUri+"npc/season_event_scenario_list/"+e+c;this.eventScenarioListModel=new(d.extend({urlRoot:f})),this.listenToOnce(this.eventScenarioListModel,"sync",function(a){b.popSeasonEventList(a.toJSON())}),this.eventScenarioListModel.fetch()},popSeasonEventList:function(a){var b=this.eventObj.chara_short_name||this.eventObj.chara_name;+this.eventObj.unique_id===v&&(b=this.eventObj.chara_name,this.eventObj.button_status===r?b=f.getMessage("seasonmessage_3"):this.eventObj.button_status===s&&(b=f.getMessage("seasonmessage_2")));var d={scenarioList:a,sceneData:{isStoryNpc:this.isStoryNpc,seasonEventId:this.eventObj.season_event_id,viewCount:this.eventObj.view_count,uniqueId:this.eventObj.unique_id,sceneReturnId:j,sex:_.isUndefined(this.eventObj.sex)?!1:this.eventObj.sex},charaName:b};this.popView=new c({className:"pop-seasonmessage-select",title:f.getMessage(w[this.eventName.toUpperCase()]),body:_.template(this.$el.find("#tpl-scene-select").html(),d),flagBtnClose:1}),this.popView.render().popShow()},popRemove:function(){this.popView.popRemove()},popRemoveAboutGender:function(){this.popRemove(),this.trigger("popRemoveAboutGender")},popAboutGender:function(a){this.eventType="valentine"===this.vwTypeString||1===+$(a.currentTarget).data("event-type")?m:n,this.popView=new c({className:"pop-vw-about-gender type-"+this.eventType,title:f.getMessage("seasonmessage_4"),body:$("#tpl-pop-about-gender").html(),flagBtnCancel:0,flagBtnClose:1}),this.popView.render().popShow()},popMessage:function(a){var b=$(a.currentTarget).data("eventName");this.popView=new c({className:"pop-season-message-single type-"+this.eventType,title:f.getMessage(x[b.toUpperCase()]),body:this.modelJSON[b].message,flagBtnCancel:0,flagBtnClose:1}),this.popView.render().popShow()}});return z});