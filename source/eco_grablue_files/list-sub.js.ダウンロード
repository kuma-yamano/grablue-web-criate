define(["backbone","model/token-data","model/quest/cjs/list/list-model","model/content","view/quest/index-sub","view/quest/select-sub","view/quest/list-abstract","view/popup","view/quest/sub/_sub_get_drop_item_list","view/common/airspace_config","model/data","model/token-data","model/cjs-loader","model/manifest-loader","util/navigate","util/language-message"],function(a,b,c,d,e,f,g,h,i,j,k,b,l,m,n,o){var p=h.extend({events:_.defaults({"tap .btn-synopsis-event":"onPushSynopsis"},h.prototype.events),onPushSynopsis:function(){this.trigger("synopsis")}}),q={TYPE_ARRAY:["BATTLE"],SUBVIEW_READY_EVENT:"readyTutorialMovie",TARGET_QUEST_ID:12},r="completeRenderList",s=g.extend({layerView:null,bookmarId:null,isQuestReleaseFlg:!1,el:".prt-quest-index",beginner_flag:!1,treasureraid_name:"treasureraid011",setTarget:null,setCallback:null,shouldShowSynopsis:!1,shouldShowUseAp:!1,listedSomeQuest:!1,currentTargetClass:null,enableCommonPopClose:!0,isShowAirSpacePop:!1,isSideStory:!1,startQuestEvent:null,CLOSE_PAIR_QUEST_TRIGGER:"closePopPairQuest",tutorialMovieDeferred:$.Deferred(),suggestMainQuestFlg:!1,rank250QuestInfo:null,isNotSelectEpisode:!1,tapPairQuestData:{},isPairQuest:!1,events:{"tap .btn-synopsis":"popSynopsis","tap .prt-list-contents .btn-bookmark-info":"btnBookmarkInfo","tap .prt-list-contents .btn-quest-release":"popQuestRelease","tap .pop-quest-release-comfirm .btn-usual-ok":"btnQuestRelease","tap .pop-quest-release-comfirm .btn-usual-cancel":"popRemove","tap .lis-quest-list.ico-clear:not('.disable'):not(.sidestory-escort):not(.pair-quest)":"clearedEpisode","tap .lis-quest-list:not('.ico-clear'):not('.disable'):not(.sidestory-escort):not(.pair-quest)":"questRestartListTouch","tap .lis-quest-list.disable":"questDisable","tap .btn-treasure-raid:not(.rank-250-quest):not(.pair-quest)":"questTreasureRaid","tap .popRestartQuest .btn-usual-ok":"questRestartPopupOk","tap .popRestartQuest .btn-usual-cancel":"questRestartPopupCancel","tap .pop-quest-clear .btn-usual-cancel, .pop-quest-clear:not(.sidestory) .btn-usual-close":"popRemove","tap .pop-treasure-raid .btn-offer":"consumeTreasureHandler","tap .pop-treasure-raid .btn-usual-cancel":"popRemove","tap .pop-cleared-episode label":"labelfunc","change #skip-setting":"skipSetting","tap .pop-cleared-episode .btn-cleard-episode":"clearedEpisodeSelect","tap .pop-cleared-episode .btn-episode-event":"locationEpisodeChapter","tap .pop-cleared-episode .btn-usual-cancel":"popRemoveUpdateBookmark","tap .pop-can-not-multi-battle .btn-usual-close":"popRemove","tap .pop-continue-quest-comfirm .btn-usual-ok":"nextQuest","tap .pop-continue-quest-comfirm:not(.sidestory) .btn-usual-cancel":"popRemove","tap .pop-cleared-quest-comfirm .btn-usual-ok":"nextQuest","tap .pop-cleared-quest-comfirm .btn-usual-cancel":"popClearedEpisode","tap .pop-confirm-battle .btn-usual-cancel":"popRemove","tap .pop-confirm-battle .btn-usual-ok":"startQuest","tap .pop-confirm-use-item .btn-usual-cancel":"popRemove","tap .pop-confirm-use-item .btn-usual-ok":"apCheck","tap .pop-retire-multi .btn-usual-ok":"popMultiBattleRetireOk","tap .pop-half-list .btn-usual-close":"popRemove","tap .btn-campaign-banner":"popHalfList","tap .pop-go-air-space .btn-usual-close":"popRemove","tap .popRestartQuest .btn-withdraw":"getRrewardInfo","tap .pop-result-withdraw .btn-usual-cancel":"removeConfirmRetire","tap .pop-result-withdraw:not(.retire) .btn-usual-ok":"questRetire","tap .pop-result-withdraw.retire .btn-usual-ok":"questArcarumRetire","tap .pop-arcarum-retire .btn-usual-ok":"questRetire","tap .pop-arcarum-retire .btn-usual-cancel":"removeConfirmRetire","tap .pop-retire .prt-popup-footer .btn-usual-ok":"popupQuestRetireRemove","tap .prt-assault-time":"popAboutAssault","tap .pop-about-assault .btn-usual-ok":"popRemove","tap .btn-event.incentive .img-event-banner":"pop_help_beginner","tap .btn-usual-close:not('.event-treasureraid')":"popRemoveCommon","tap .pop-extra-hell .btn-usual-close":"popRemove","tap .pop-event-hell .btn-usual-close":"popRemove","tap .location-href":"location_href",'tap .pop-bookmark-info .btn-bookmark-register:not(".enable")':"btnBookmarkRegisterResult",'tap .pop-synopsis .btn-bookmark-register:not(".enable")':"btnBookmarkRegisterResult",'tap .pop-cleared-quest-comfirm .btn-bookmark-register:not(".enable")':"btnBookmarkRegisterResult","tap .pop-bookmark-info .btn-bookmark-register.enable":"btnBookmarkReleaseResult","tap .pop-synopsis .btn-bookmark-register.enable":"btnBookmarkReleaseResult","tap .pop-cleared-quest-comfirm .btn-bookmark-register.enable":"btnBookmarkReleaseResult","tap .pop-bookmark-info .btn-usual-ok":"popRemoveUpdateBookmark","tap #prt-bookmark-pagination .btn-page-number":"btnBookmarkPage","tap .pop-synopsis .btn-drop-item-list":"btnDropItemList","tap .pop-bookmark-info .btn-drop-item-list":"btnDropItemList","tap .prt-quest-list .btn-treasure-raid.rank-250-quest":"onTapRank250Quest","tap .pop-rank-250-quest .btn-usual-cancel":"popRemove","tap .pop-rank-250-quest .btn-offer":"consumeTreasureHandler","tap .pop-rank-250-quest .btn-sacred-treasure":"popSacredTreasure","tap .pop-rank-250-hint .btn-usual-close":"getRank250QuestInfo","tap .lis-quest-list.pair-quest":"getPairQuest","tap .btn-treasure-raid.pair-quest":"getPairQuest"},initialize:function(a){this.on("timerOff",this.limitOver),this.EXCLUDED_AREA_ID="100000",this.QUEST_TYPE_EXTRA_QUEST_WEEK=4,this.QUEST_TYPE_EXTRA_QUEST_TIME=5,this.RAID_KIND_SINGLE=0,this.RAID_KIND_MULTI=1,this.SYNOPSIS_QUEST_CONTINUE=0,this.SYNOPSIS_CLEARED_QUEST=1,this.isSceneSkipFlg=null,this.clearedQuestEvent=null,this.isProgressPopupStopFlg=a.is_progress_popup_stop_flg||!1,this.selectedAreaId=a.selected_area_id,this.completedQuestId=parseInt(a.completed_quest_id),this.calledView=a.called_view,this.beginner_flag=a.beginner_flag,this.isQuestIndex=a.isQuestIndex||!1,this.questContentData=a.questContentData||{},this.contentPopupData=a.contentPopupData||{},this.isAirshipFixed=a.isAirshipFixed||!1,this.suggestMainQuestFlg=a.suggestMainQuestFlg||!1,this.isShowAirSpacePop=!!a.isShowAirSpacePop,this.content_model=new d({controller:"quest",action:"list"}),this.isQuestIndex?(this.content_model.set({data:this.questContentData.content_list,option:{isSubView:!0}}),this.render(this.content_model)):this.getListContent(this.content_model)},getListContent:function(){this.stopListening(this.content_model,"sync"),this.listenToOnce(this.content_model,"sync",this.render),this.content_model.fetch()},render:function(){var a=this;if(this.content_render(this.content_model),this.init(),this.isQuestIndex){if(!_.isEmpty(this.contentPopupData))return void Game.view.trigger("popup_error",{data:this.contentPopupData});this.questListInitModel.set(this.questContentData.init_list),this.canvasRender(this.questListInitModel),this.setTutorialMovieSubView(q,function(){a.tutorialMovieDeferred.done(function(){a._showTutorialMoviePopup()===!0&&a.tutorialMovieSubView.popNoticeMovie(q.TYPE_ARRAY[0])})})}else this.stopListening(this.questListInitModel,"sync"),this.listenToOnce(this.questListInitModel,"sync",this.canvasRender),this.questListInitModel.fetch();var b=this.limitTime($("#server-time").val(),$("#limit-time").val());return this.countDownTime(b,this.$el.find(".prt-assault-time")),this.timerOn(b,this.$el.find(".prt-assault-time")),this},canvasRender:function(a){var b=[];b.push(a.get("cjs_name")),this.isAirshipFixed&&b.push("quest_map_ship");var c=this;l.once("complete",function(){var d=_.flatten(_.filter(_.map(b,function(a){return l.manifest(a)}),_.identity)),e=a.get("map_effect").ship_image;if(e){var f="quest_map_"+a.get("location_id")+"_ship_1",g=_.find(d,function(a){return a.id==f}),h=Game.imgUri+"/sp/cjs/"+e+".png";g?g.src=h:c.isAirshipFixed?d.push({id:"quest_map_ship_ship_1",src:h}):d.push({id:f,src:h})}m.once("complete",function(){window.stage&&c.destroyStage(),window.stageAirship&&c.destroyStage(window.stageAirship);var a=document.getElementById("canvas");if(window.stage=new createjs.Stage(a),createjs.Ticker.setFPS(12),createjs.Ticker.addEventListener("tick",window.stage),c.isAirshipFixed){var b=document.getElementById("canv-fixed-airship");window.stageAirship=new createjs.Stage(b);var d=new createjs.Container,e=new lib.quest_map_ship;d.addChild(e),e.x=0,e.y=0,e.scaleX=1,e.scaleY=1;window.stageAirship.addChildAt(e,0);createjs.Ticker.addEventListener("tick",window.stageAirship)}c.after_initialize()}),m.loadManifest(d)});var d=!1;"20001"==a.get("location_id")&&(a.get("area_by_quest")[1].is_open&&a.get("area_by_quest")[2].is_open||(d=!0)),$("#beginner_flg").val(d),l.loadFiles(b)},after_initialize:function(){var a=this;$("canvas").on("requestQuestList",function(b,c){a.renderQuestList(c,!1)}),$("canvas").on("initMove",function(b){a.initMove()}),20006==this.questListInitModel.get("location_id")?(this.sunny_check=new(k.extend({urlRoot:Game.baseUri+"quest/cleared_by_quest_id/244"})),this.listenTo(this.sunny_check,"sync",this.renderIndex),this.sunny_check.fetch()):this.renderIndex()},renderIndex:function(){this.location_id=this.questListInitModel.get("location_id"),this.canMultiBattle=this.questListInitModel.get("can_multi_battle"),this.isSceneSkipFlg=this.questListInitModel.get("is_scene_skip_flg");var b=this.questListInitModel.get("next_area_open_value"),d=this.questListInitModel.get("next_area_open_line"),f=b?!0:!1,g=this.selectedAreaId.substring(0,5),h=function(a){switch(+a){case 20010:case 20013:case 20109:return!0;default:return!1}},i=this;"0"==this.selectedAreaId?(this.returnPoint="1",this.subView=new e({isRecommendMenuShowFlg:0,isBookmarkMenuShowFlg:1,location_id:this.location_id,sceneSkipFlg:this.sceneSkipFlg,beginner_flag:this.beginner_flag,isQuestIndex:this.isQuestIndex,questContentData:this.questContentData,suggestMainQuestFlg:this.suggestMainQuestFlg}),this.addSubView(this.subView)):this.selectedAreaId&&this.selectedAreaId!==this.EXCLUDED_AREA_ID&&(g==this.location_id||h(g))?(this.returnPoint="2",this.renderQuestList(this.selectedAreaId,!0)):(this.returnPoint="0",this.subView=new e({isRecommendMenuShowFlg:1,isBookmarkMenuShowFlg:0,location_id:this.location_id,sceneSkipFlg:this.sceneSkipFlg,beginner_flag:this.beginner_flag,isQuestIndex:this.isQuestIndex,questContentData:this.questContentData,suggestMainQuestFlg:this.suggestMainQuestFlg}),this.addSubView(this.subView)),this.isQuestIndex?this.trigger(r):this.subView.on(e.EVENT_COMPLETE_RENDER,function(){i.trigger(r)});var j=Array(),k=Array(),l=Array(),m=!1,n=-1,o=0,p=null,q=0,s=[20011],t=_.contains(s,+this.location_id)?6:4;this.isProgress=this.questListInitModel.get("is_progress"),this.progressQuestidsArr=this.questListInitModel.get("progress_quest_ids"),p=this.questListInitModel.get("map_effect"),_.each(this.questListInitModel.get("area_by_quest"),function(a){j.push(a.is_next),k.push(a.is_open),l.push(a.not_clear_count_area)});var u=t-k.length;if(0!==u)for(var v=0;u>v;v++)k.push(q);if(this.selectedAreaId&&"2"===this.returnPoint){var w=this.selectedAreaId.length;switch(o=this.selectedAreaId.substring(w-1,w),this.selectedAreaId){case"200047":case"200086":case"100015":case"100016":case"100017":case"100018":case"100019":case"200104":case"200096":case"210027":case"200015":o=1;break;case"200046":case"200088":case"200103":case"200114":case"200089":case"200097":case"200131":case"210045":case"200016":o=2;break;case"200045":case"200087":case"200102":case"200105":case"210046":case"210055":case"200017":o=3;break;case"200085":case"200101":case"200115":case"200095":case"210047":case"210056":o=4;break;case"200048":case"200116":case"200117":o=5;break;case"200106":case"200118":case"200132":o=6}}var i=this;_.each(k,function(a,b){1===parseInt(a)||2===parseInt(a)?n++:10001==i.location_id&&1==b&&1==parseInt(k[0])&&1==parseInt(k[2])&&n++});var x=Number(this.questListInitModel.attributes.last_clear_chapter),y=!1;if(f){var z=this,A=500;if(1==d&&n>0&&(A=2500,m=!0),y=this.questListInitModel.get("luminous_flag"),(44==x||45==x||46==x||47==x||63==x)&&(y=!0),y)switch(A=1500,m=!0,x){case 38:case 41:case 51:case 69:case 114:case 131:n=1;break;case 37:case 43:case 50:case 57:case 64:case 70:case 71:case 105:case 115:case 129:n=2;break;case 42:case 49:case 52:case 62:case 116:n=3;break;case 40:case 48:case 99:case 117:n=4;break;case 60:n=5;break;case 72:n=6}this.calledView&&this.calledView.setUmdelegateEvents(A),setTimeout(function(){z.areaOpenPopup(b)},A)}if(quest_map_found_flag=m,quest_map_way_effect=!y,quest_map_way=n,quest_map_point_num=this.questListInitModel.get("area_by_quest").length+1,quest_map_mode_array=k,quest_map_text_array=j,quest_map_nummber_array=l,quest_map_select=o,quest_map_key_on=!0,quest_map_weather=p.quest_map_weather,quest_map_ship_crash=p.quest_map_ship_crash,quest_map_ship=p.quest_map_ship,quest_map_clear_number=x,20006==this.location_id){var B=this.sunny_check.toJSON();B.is_clear?quest_map_clear_flag=1:quest_map_clear_flag=0}this.list=new c({instanceName:"quest_map_"+this.location_id,x:0,y:0,index:0}),this.questListInitModel.get("retired_single_raid_id")?a.history.navigate("result/"+this.questListInitModel.get("retired_single_raid_id"),!0):this.questListInitModel.get("retire_flag")?this.questListInitModel.get("retired_multi_raid_id")?(this.content_close(),a.history.navigate("result_multi/"+this.questListInitModel.get("retired_multi_raid_id"),!0)):this.popMultiBattleRetire():this.isProgress&&!this.isProgressPopupStopFlg?this.comfirmRestartQuest():this.questListInitModel.get("expired_retire_info").is_expired_retire_flg?(this.expiredRetireInfo=this.questListInitModel.get("expired_retire_info"),this.popExpiredRetire(this.questListInitModel.get("expired_retire_info").expired_retire_chapter_name)):this.isShowAirSpacePop?this.popAirspace():this.tutorialMovieDeferred.resolve()},_showTutorialMoviePopup:function(){return 0===this.$el.find(".lis-quest-list.ico-current."+q.TARGET_QUEST_ID).length?!1:this.isQuestIndex===!0&&this.enableTutorialMovie===!0&&this.tutorialMovieSubView.isShowedPopup(q.TYPE_ARRAY[0])===!1},initMove:function(){this.returnPoint="0",this.isQuestReleaseFlg=!1,this.subView&&this.subViewClose(this.subView),Game.loading.xhrStart(),this.subView=new e({isRecommendMenuShowFlg:1,isBookmarkMenuShowFlg:0,location_id:this.location_id,sceneSkipFlg:this.sceneSkipFlg,suggestMainQuestFlg:this.suggestMainQuestFlg}),this.addSubView(this.subView);var a=this;this.subView.on(e.EVENT_COMPLETE_RENDER,function(){a.trigger(r)})},initMoves:function(a){this.returnPoint="1",this.isQuestReleaseFlg=!1,this.subView&&this.subViewClose(this.subView),Game.loading.xhrStart(),this.subView=new e({isRecommendMenuShowFlg:0,isBookmarkMenuShowFlg:1,location_id:this.location_id,sceneSkipFlg:this.sceneSkipFlg,suggestMainQuestFlg:this.suggestMainQuestFlg,page:a||1}),this.addSubView(this.subView);var b=this;this.subView.on(e.EVENT_COMPLETE_RENDER,function(){b.trigger(r)})},popRemove:function(){this.popView&&this.popView.popRemove()},popRemoveCommon:function(){this.enableCommonPopClose!==!1&&this.popRemove()},renderQuestList:function(a,b){this.returnPoint="2",this.isQuestReleaseFlg=!1,this.areaId=a,this.subView&&this.subViewClose(this.subView);var c=this,d=null;this.completedQuestId&&(d=function(){$(".lis-quest-list").each(function(){c.completedQuestId+1===parseInt($(this).data("quest-id"))&&(c.questId=parseInt($(this).data("quest-id")),c.questType=parseInt($(this).data("type")),c.continueChaptername=$(this).find(".txt-quest-title").text(),c.synopsis=$(this).data("synopsis"),c.sceneId=$(this).data("scene-id"),c.isSceneOnly=$(this).data("scene-only")||0,c.isStartAtOnce=$(this).data("start-at-once")||0,c.isGetDropItem=!!$(this).data("get-drop-item"),c.continueQuestComfirm())})}),Game.loading.xhrStart();var e=b&&this.isQuestIndex;this.subView=new f({location_id:this.location_id,areaId:a,sceneSkipFlg:this.sceneSkipFlg,completed_quest_id:this.completedQuestId,call_back:d,isQuestIndex:e,questContentData:this.questContentData}),e?this.trigger(r):this.subView.on(f.EVENT_COMPLETE_RENDER,function(){c.trigger(r)}),this.addSubView(this.subView)},subViewClose:function(a){a.off(),a.undelegateEvents(),a.stopListening(),this.removeSubView(a)},renderDeck:function(){this.layerView&&this.layerView.content_close(),this.layerView=new deckSubView},requestClearedQuestList:function(){this.questClearedQuestListModel.setAreaId(this.areaId),this.questClearedQuestListModel.fetch()},renderClearedQuestList:function(a){_.each(a.get("quest_list"),function(a){var b=o.replaceMessage("quest_67",[a.quest_id,a.level,a.quest_image,a.level,a.action_point,a.area_quest_count,a.clear_quest_count,a.reward_type]);$(".prt-quest-intro").append(b)}),this.listenToOnce(this.questClearedQuestListModel,"sync",this.renderClearedQuestList)},questRestartListTouch:function(a){var b=$(a.currentTarget),c=b.data("quest-id"),d=parseInt(b.data("type")),e=parseInt(b.data("raid-kind")),f=b.data("scene-id"),g=b.data("raid-id"),h=b.hasClass("ico-progress"),i=b.data("scene-only")||0,j=b.data("start-at-once")||0;this.selectedQuestId=c;var k=this;if(!this.isQuestReleaseFlg){var l=function(){k.questRestart(a,c,d,f,g,h,!1,i,j)},m=l;this.shouldShowSynopsis===!0&&(m=function(){k.popSynopsis(a,l)}),e===this.RAID_KIND_MULTI?0<=this.progressQuestidsArr.indexOf(String(c))||0<=this.progressQuestidsArr.indexOf(c)?this.questRestart(a,c,d,f,g,h,!0,i,j):this.canMultiBattle?this.startQuestCheck(a,function(){k.questRestart(a,c,d,f,g,h,!0,i,j)}):this.comfirmRestartQuest(d):h?l():this.startQuestCheck(a,function(){m()})}},questTreasureRaid:function(a){if(!this.isQuestReleaseFlg){var b=$(a.currentTarget),c=b.data("chapter-id"),d=b.data("quest-id"),e=b.hasClass("ico-progress");if(this.isDispStartPopup=!!b.data("is-disp-start-popup"),this.startPUType=b.data("start-popup-type"),this.isSceneOnly=+b.data("scene-only")||0,this.sceneId=b.data("scene-id"),e===!0){var f=+b.data("raid-kind")===this.RAID_KIND_MULTI,g=+b.data("type"),h=+b.data("raid-id"),i=+b.data("start-at-once")||0;return void this.questRestart(a,d,g,this.sceneId,h,e,f,this.isSceneOnly,i)}var j=new(k.extend({urlRoot:Game.baseUri+"quest/treasure_raid/"+c+"/"+d}));this.stopListening(j,"sync"),this.listenToOnce(j,"sync",this.popTreasureRaid),Game.loading.xhrStart(),this.isNoSkillBattle=b.data("no-skill-battle")||0,this.startPUType&&!this.isDispStartPopup&&(this.eventQuestTreasureRaid=a),j.fetch()}},popTreasureRaid:function(a){Game.loading.xhrEnd();var b=a.toJSON();if(b.numPurchaseOptions=1,_.isArray(b.treasure_name)&&(b.numPurchaseOptions=b.treasure_name.length),b.purchaseStyle="",2===+b.use_item_type?b.purchaseStyle="_quadruple":b.numPurchaseOptions>1&&(b.purchaseStyle="_double"),b.isNoSkillBattle=this.isNoSkillBattle,this.isDispStartPopup)return b.startPUType=this.startPUType,b.isOnlySceneScenario=this.isSceneOnly,b.sceneId=this.sceneId,this.popView=new h({className:"pop-treasure-raid single-battle",title:b.chapter_name,body:_.template($("#tpl-use-treasure").html(),b),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.popView.$el.find(".prt-popup-footer").append(_.template($("#tpl-button-use-treasure").html(),b)),void this.popView.popShow();if(this.startPUType){var c={chapterId:b.chapter_id,questType:b.type,useItemType:b.use_item_type};return this.treasureId=b.treasure_id[0],void this.eventpointCheck(this.eventQuestTreasureRaid,c)}b.isPairQuest=this.isPairQuest,this.popView=new h({className:"pop-treasure-raid",title:o.replaceMessage("quest_68",[b.raid_name]),body:_.template($("#tpl-treasure-raid").html(),b),flagBtnCancel:1,flagBtnOk:0});var d=_.some(b.num,function(a,c){return a<+b.consume[c]});2==+b.use_item_type?(this.popView.render(),this.popView.$el.find(".prt-popup-footer").append(_.template($("#tpl-button-battle").html(),{data:b,isInsufficient:d})),this.popView.popShow()):b.numPurchaseOptions>1?this.popView.render().popShow():(this.popView.render(),this.popView.$el.find(".prt-popup-footer").append(_.template($("#tpl-button-battle").html(),{data:b,isInsufficient:d})),this.popView.popShow()),this.isPairQuest=!1},consumeTreasureHandler:function(a){this.eventpointCheck(a)},eventpointCheck:function(a,b){this.questType=1;var c=this,d=a,e=$(a.currentTarget);this.treasureId=e.data("treasure-id");var f=e.data("chapter-id"),g=e.data("use-item-type")||1,h=e.data("type");_.isUndefined(b)||(f=b.chapterId,g=b.useItemType,h=b.questType);var i=Game.baseUri+"quest/treasure_check_item/"+f+"/"+g;void 0!=this.treasureId&&(i+="/"+this.treasureId);var j=new(k.extend({urlRoot:i}));this.stopListening(j,"sync"),this.listenToOnce(j,"sync",function(b){1==b.get("result")?c.startQuestCheck(d,function(){c.actionpointCheck(a,function(a){_.isUndefined(a)!==!0&&a.ap_over===!0?c.popShortageAp():c.locationSupporter(c.treasureId)})}):"progress"===b.get("result")&&c.comfirmRestartQuest(h)}),j.fetch()},startQuest:function(){this.popRemove();var a=this.startQuestEvent||_e;this.startQuestEvent=null;var b=$(a.currentTarget),c=b.hasClass("ico-clear"),d=b.hasClass("multi");if(c&&!d)this.viewClearedEpisode(a);else{var e=this,f=function(a){_.isUndefined(a)!==!0&&a.ap_over===!0?e.popShortageAp():e.locationSupporter()};this.actionpointCheck(a,f)}},nextQuest:function(){this.popRemove();var a=this,b=function(b){_.isUndefined(b)!==!0&&b.ap_over===!0?a.popShortageAp():a.locationSupporter()},c={currentTarget:".lis-quest-list"},d=null;this.clearedQuestEvent?(c=this.clearedQuestEvent,d=$(".pop-cleared-quest-comfirm .prt-popup-header").text()):(this.listedSomeQuest===!0?c={currentTarget:this.currentTargetClass}:3===+this.questType&&(c.currentTarget+='[data-quest-id="'+(this.completedQuestId+1)+'"]'),d=$(".pop-continue-quest-comfirm .prt-popup-header").text());var e=$(c.currentTarget),f=e.data("quest-id")||0,g=e.data("ap"),i=!_.isNaN(e.data("type"))&&_.isNumber(e.data("type"))?e.data("type"):null,j=!!e.data("sceneOnly"),l=!!e.data("is-riddle"),m=Game.baseUri+"quest/check_quest_start_attribute/"+f;_.isNull(i)||(m=m+"/"+i);var n=new(k.extend({urlRoot:m}));this.stopListening(n,"sync"),this.listenToOnce(n,"sync",function(a){this.setTarget=c,this.setCallback=b;var e={id:a.get("use_item_id"),name:a.get("use_item_name"),num:a.get("use_item_num"),consume:a.get("use_item_consume"),enable:a.get("use_item_enable"),quest_ap:g,quest_name:d};if("error_start_attribute"===a.get("result")){var i=a.toJSON(),k=o.getMessage("quest_69"),m=i.condition.split(",");for(var n in m)k+="<br>"+m[n];k+="</div>",this.showChapterMessageFlg=_.isUndefined(i.message)===!1&&""!==i.message,this.showChapterMessageFlg&&(k+='<div class="txt-chapter-msg">'+o.replaceMessage("pop_can_not_multi_battle_1",{"%s1":i.message,"%s2":i.condition})+"</div>"),this.cautionPop(k)}else!this.isProgress&&e.id?(this.popView=new h({className:"pop-confirm-use-item",title:o.getMessage("quest_70"),body:_.template($("#tpl-quest-use-item").html(),e),flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),e.id&&!e.enable&&this.popView.$el.find(".btn-usual-ok").removeClass().addClass("prt-usual-ng"),this.popView.popShow()):"error_event_skip"===a.get("result")?this.cautionPop(o.getMessage("quest_71")):"error_deal_lock"===a.get("result")||"error_deal_unconfirmed"===a.get("result")?(this.cautionPopTitle=o.getMessage("deal_rock_popup_1"),this.cautionPop(o.getMessage("deal_rock_popup_2"),"deal_unconfirmed")):this.clearedQuestEvent&&j&&!l?this.locationClearedScene(this.sceneId,f):this.actionpointCheck(c,b)}),n.fetch()},apCheck:function(){this.actionpointCheck(this.setTarget,this.setCallback)},locationClearedScene:function(b,c){this.content_close(),a.history.navigate("quest/cleared_scene/"+b+"/"+c,!0)},clearedEpisode:function(a){var b=$(a.currentTarget);if(this.selectedTarget=b,this.locationId=b.data("location-id"),!this.isQuestReleaseFlg){var c=this;this.startQuestCheck(a,function(){c.isPairQuest?(c.isPairQuest=!1,c.startQuestEvent=a,c.startQuest()):c.viewClearedEpisode(a)})}},viewClearedEpisode:function(a){var b=$(a.currentTarget),c=this.$el.find("#area_id").val()||b.data("area_id");b.parent(".prt-list-contents").data("bookmark-id")?c=b.parent(".prt-list-contents").data("area-id"):""!=c||b.data("type")!=this.QUEST_TYPE_EXTRA_QUEST_WEEK&&b.data("type")!=this.QUEST_TYPE_EXTRA_QUEST_TIME||(c=1e5),this.targetChpaterId=b.attr("data-chapter-id"),this.clearedLocationId=b.parent(".prt-list-contents").data("location-id")||this.location_id;var d=k.extend({urlRoot:Game.baseUri+"quest/cleared_list/"+c+"/"+this.targetChpaterId});this.clearedQuestEvent=a,this.questClearedModel=new d,this.stopListening(this.questClearedModel,"sync"),this.listenToOnce(this.questClearedModel,"sync",this.popClearedEpisode),Game.loading.xhrStart(),this.questClearedModel.fetch()},popClearedEpisode:function(a){var b=this.questClearedModel.toJSON(),c=this;if(1!==b.episode.length&&this.isNotSelectEpisode!==!0){Game.loading.xhrEnd();var d=0==this.isSceneSkipFlg?!1:!0,e=_.template($("#tpl-cleared-episode").html(),{item:b.episode,skipFlag:d,chapterName:b.quest_name}),f=1,g=b.episode[0].quest_type;if(3==g&&(f=0),this.popView=new h({className:"pop-cleared-episode",title:b.quest_name,body:e,flagBtnCancel:1,flagBtnOk:f}),this.popView.render(),this.$el.find(".prt-popup-footer>.btn-usual-ok").removeClass().addClass("btn-episode-event"),this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var i=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-cleared-episode").css("top"));$(".pop-cleared-episode").css("top",i+"px")}}else{var j=b.episode[0];if(this.isNotSelectEpisode===!0&&this.collectItemQuestId&&+j.quest_id!==+this.collectItemQuestId&&(j=_.find(b.episode,function(a){return+a.quest_id===+c.collectItemQuestId})),j.is_only_scene_scenario&&!j.is_riddle)this.locationClearedScene(j.scene_id,j.quest_id);else{var k=function(a){_.isUndefined(a)!==!0&&a.ap_over===!0?c.popShortageAp():c.locationSupporter()};this.actionpointCheck(this.clearedQuestEvent,k)}}},areaOpenPopup:function(a){var b={intro:"",quest:a};this.popView=new h({className:"pop-quest-clear",title:o.getMessage("quest_72"),body:_.template($("#tpl-quest-open").html(),b),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),$(".pop-quest-clear .btn-usual-cancel").text(o.getMessage("quest_73")),this.popView.popShow()},continueQuestComfirm:function(a){a=a||this.SYNOPSIS_QUEST_CONTINUE,"undefined"==typeof this.isSkipSynopsis&&(this.isSkipSynopsis=!1);var b="";switch(this.questType){case 0:b=o.getMessage("quest_74");break;case 1:b=o.getMessage("quest_75");break;case 2:b=o.getMessage("quest_76");break;case 3:b=o.getMessage("quest_75");break;case 4:b=o.getMessage("quest_77")}var c={next:b,synopsis:this.synopsis,ng_names:this.ng_names,start_names:this.start_names,questId:this.questId,isGetDropItem:this.isGetDropItem},b="",d="";if(a===this.SYNOPSIS_CLEARED_QUEST){if(3==this.questType&&!this.freeQuestSummaryFlg&&!this.exStory||this.isSkipSynopsis)return this.nextQuest();b=_.template($("#tpl-synopsis-cleared-quest").html(),c),d="pop-cleared-quest-comfirm"}else b=_.template($("#tpl-synopsis-next").html(),c),d="pop-continue-quest-comfirm";if(this.popView=new h({className:d,title:this.continueChaptername,body:b,flagBtnCancel:1,flagBtnOk:1}),this.popView.render(),this.bookmarkInfo(this.locationId,this.questId,!0),this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var e=-$(".prt-event-fv").outerHeight()+parseInt($("."+d).css("top"));$("."+d).css("top",e+"px")}this.setGetDropItemListSubView()},labelfunc:function(){},skipSetting:function(a){Game.loading.xhrStart(),this.skip_label=$(a.currentTarget),this.skip_input=$("#"+this.skip_label.attr("for"));var c=new(b.extend({urlRoot:Game.baseUri+"quest/setting_scene_skip"}));this.stopListening(c,"sync"),this.listenToOnce(c,"sync",this.skipSettingResult);var d=1==this.isSceneSkipFlg?"0":"1";c.set("skip_flg",d),c.save()},skipSettingResult:function(a){this.isSceneSkipFlg=1==a.get("after_scene_skip_flg")?1:0,1==a.get("after_scene_skip_flg")?this.skip_input.prop("checked",!0):this.skip_input.prop("checked",!1),Game.loading.xhrEnd()},clearedEpisodeSelect:function(a){this.clearedQuestEvent=a;var b=$(a.currentTarget);this.questId=parseInt(b.data("quest-id")),this.questType=parseInt(b.data("type")),this.sceneId=b.data("scene-id"),this.isSceneOnly=b.data("scene-only")||0,this.isStartAtOnce=b.data("start-at-once")||0,this.continueChaptername=this.questClearedModel.get("quest_name"),this.synopsis=b.data("synopsis"),this.isSkipSynopsis=b.hasClass("skip-synopsis")||!1,this.freeQuestSummaryFlg=b.data("free-quest-summary-flg"),this.isSideStory&&(this.exStory=b.data("ex-story")),this.isGetDropItem=!!b.data("get-drop-item");var c="",d="",e=b.data("ng-attribute-names");if(e){var f=e.split(",");_.each(f,function(a){c+=o.replaceMessage("quest_14",[a])})}var g=b.data("ng-npc-names");if(g){var h=g.split(",");_.each(h,function(a){c+=a+"<br>"})}var i=b.data("start-attribute-names");if(i){var j=i.split(",");_.each(j,function(a){d+=o.replaceMessage("quest_14",[a])})}var k=b.data("start-npc-names");if(k){var l=k.split(",");_.each(l,function(a){d+=a+"<br>"})}var m=b.data("start-rarity-names");if(m){var n=m.split(",");_.each(n,function(a){d+=a+"<br>"})}var p=b.data("start-tribe-names");if(p){var q=p.split(",");_.each(q,function(a){d+=a+"<br>"})}var r=b.data("start-job-names");r&&(d+=r+"<br>"),1==b.data("quest-once-flag")&&(""!=c&&(c+=o.getMessage("quest_21")),""!=d&&(d+=o.getMessage("quest_21"))),this.ng_names=c,this.start_names=d,this.continueQuestComfirm(this.SYNOPSIS_CLEARED_QUEST)},locationScene:function(b){this.list.remove(),!b.get("scene_id"),this.content_close(),a.history.navigate("quest/scene/"+b.get("scene_id")+"/3",!0)},locationMultiRaid:function(b){this.content_close(),a.history.navigate("raid_multi/"+b,!0)},popSynopsis:function(a,b){var c=this,d=[1,1],e=$(a.currentTarget),f=e.parent(".prt-list-contents"),g=f.find(".js-quest-list"),h=g.data("event-name")?g.data("event-name"):null,i=!!b&&_.isFunction(b),j=this.shouldShowUseAp||!1,k="",l="",m=g.data("ng-attribute-names");if(m){var n=m.split(",");_.each(n,function(a){k+=o.replaceMessage("quest_14",[a])})}var q=g.data("ng-npc-names");if(q){var r=q.split(",");_.each(r,function(a){k+=a+"<br>"})}var s=g.data("start-attribute-names");if(s){var t=s.split(",");_.each(t,function(a){l+=o.replaceMessage("quest_14",[a])})}var u=g.data("start-npc-names");if(u){var v=u.split(",");_.each(v,function(a){l+=a+"<br>"})}var w=g.data("start-rarity-names");if(w){var x=w.split(",");_.each(x,function(a){l+=a+"<br>"})}var y=g.data("start-tribe-names");if(y){var z=y.split(",");_.each(z,function(a){l+=a+"<br>"})}var A=g.data("start-job-names");A&&(l+=A+"<br>"),1==g.data("quest-once-flag")&&(""!=k&&(k+=o.getMessage("quest_21")),""!=l&&(l+=o.getMessage("quest_21")));var B=e.data("quest-id"),C=!!e.data("get-drop-item"),D={synopsis:g.data("synopsis"),rank:g.data("rank"),use_money:g.data("use_money"),use_item_name:g.data("use-item-name"),use_item_consume:g.data("use-item-consume"),limited_count:g.data("limited_count"),limited_count_type:g.data("limited_count_type"),type:g.data("type"),limit_potion:g.data("limit_potion"),start_main_weapon_names:g.data("start-main-weapon-names"),start_npc_weapon_names:g.data("start-npc-weapon-names"),ng_names:k,start_names:l,event_name:h,no_skill_battle:g.data("no-skill-battle")||0,isBeforeStartQuest:i,isSideStory:this.isSideStory,shouldShowUseAp:j,userAp:+g.data("ap"),nextEpisodeNum:+g.data("clear-quest-count")+1,maxLimitedCount:+g.data("max-limited-count")||0,synopsisWhite:+g.data("synopsis-white")||0,jobLevel:g.data("job-level")||null,jobName:g.data("job-name")||null,weaponName:g.data("weapon-name")||null,questId:B,isGetDropItem:C},E=g.data("clear-quest-count")||0,F=g.data("chapter-id")||0,G=71100,H=e.data("location-id");_.contains([1,3,4,5,7,12,15,18,21,24],+D.type)===!0?d[0]=0:1>E&&(70671==+F||70672==+F||70951==+F||70952==+F)?d[0]=0:+H===G&&(d[0]=0);var I=i?g.data("quest-name"):g.find(".txt-quest-title").text();i===!0&&j===!0&&(d[1]=0),1===+g.data("ex-story")&&(d[0]=1);var J=_.template($("#tpl-quest-information").html(),D);if(this.popView=new p({className:"pop-synopsis",title:I,body:J,flagBtnCancel:d[0],flagBtnOk:d[1]}),this.popView.render(),this.stopListening(this.popView),i?(j===!0&&this.popView.$el.find(".btn-next-episode").on("tap",function(){
$(this).off(),c.popView.trigger("ok")}),this.popView.listenToOnce(this.popView,"ok",function(){this.stopListening(this).popRemove(),b()}),this.popView.listenToOnce(this.popView,"cancel",function(){this.stopListening(this).popRemove(),c.updateBookmarkQuestList()})):(this.popView.$el.find(".btn-usual-cancel").removeClass().addClass("btn-synopsis-event"),this.popView.listenToOnce(this.popView,"ok",function(){this.stopListening(this,"ok").stopListening(this,"synopsis").popRemove(),c.updateBookmarkQuestList()}),this.popView.listenToOnce(this.popView,"synopsis",function(){this.stopListening(this,"ok").stopListening(this,"synopsis").popRemove(),c._locationChapter(H)})),this.bookmarkInfo(H,B,!0),this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var K=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-synopsis").css("top"));$(".pop-synopsis").css("top",K+"px")}this.setGetDropItemListSubView()},setGetDropItemListSubView:function(){_.isUndefined(this.getDropItemListSubView)!==!1&&(this.getDropItemListSubView=new i,this.addSubView(this.getDropItemListSubView))},popBookmarkInfo:function(a){g.prototype.popBookmarkInfo.call(this,a),this.setGetDropItemListSubView()},btnDropItemList:function(a){this.getDropItemListSubView.btnDropItemList(a)},popQuestRelease:function(a){var b=$(a.currentTarget).parent("div.prt-list-contents"),c=b.attr("data-quest-name");this.bookmarId=b.attr("data-bookmark-id"),this.popView=new h({className:"pop-quest-release-comfirm",title:o.getMessage("quest_79"),body:o.replaceMessage("quest_80",[c]),flagBtnCancel:1,flagBtnOk:1}),this.popView.render().popShow()},btnQuestRelease:function(){this.deleteBookmarkQuestList()},deleteBookmarkQuestList:function(){Game.loading.xhrStart();var a=new(b.extend({urlRoot:Game.baseUri+"rest/bookmark/delete_bookmark_quest"}));this.stopListening(a,"sync"),this.listenToOnce(a,"sync",this.renderDeleteBookmarkQuestList),a.set("bookmark_id",+this.bookmarId),a.save()},renderDeleteBookmarkQuestList:function(a){var b=a.toJSON().result;b!==!1&&(Game.loading.xhrEnd(),this.bookmarId=null,this.bookmarkCount=+b.bookmark_count,this.bookmarkMaxCount=+b.bookmark_max_count,this.popView.popRemove(),this.updateBookmarkQuestList())},btnRecordOpen:function(){$(".btn-bookmark-record").removeClass("open"),$(".btn-bookmark-record").addClass("close"),$(".btn-quest-release").css("display","block"),this.isQuestReleaseFlg=!0},btnRecordClose:function(){$(".btn-bookmark-record").addClass("open"),$(".btn-bookmark-record").removeClass("close"),$(".btn-quest-release").css("display","none"),this.isQuestReleaseFlg=!1},questDisable:function(){},btnBookmarkPage:function(a){var b=+$(a.currentTarget).attr("page"),c=+$("#bookmark_page_current").val();b!==c&&this.initMoves(b)},updateBookmarkQuestList:function(){if(1===+this.returnPoint){var a=+$("#bookmark_page_current").val(),b=+$("#bookmark_pre_page").val(),c=Math.ceil(this.bookmarkCount/b),d=a>c?c:a;this.initMoves(d)}},popRemoveUpdateBookmark:function(){this.popView&&this.popRemove(),this.updateBookmarkQuestList()},locationEpisode:function(){this._locationChapter()},_locationChapter:function(b){this.content_close();var b=b||this.location_id;a.history.navigate("archive/story/chapter/"+b+"/null",!0)},locationEpisodeChapter:function(b){var c="archive/story/play_list/"+this.clearedLocationId+"/"+this.targetChpaterId+"/null";_.isObject(this.param)&&this.param.storyId&&(c+="/"+this.param.storyId),this.content_close(),a.history.navigate(c,!0)},popMultiBattleRetire:function(){if(this.popView=new h({className:"pop-retire-multi",title:o.getMessage("quest_81"),body:o.getMessage("quest_82"),flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow(),0!=$(".prt-event-quest-intro").length){var a=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-retire-multi").css("top"));$(".pop-retire-multi").css("top",a+"px")}},popExpiredRetire:function(a){var b=o.replaceMessage("quest_83",a);if("undefined"!=typeof this.expiredRetireInfo.arcarum&&this.expiredRetireInfo.arcarum&&(b=this.expiredRetireInfo.arcarum.has_retire_tp===!0?o.replaceMessage("arcarum_quest_1",{"%s1":a,"%s2":this.expiredRetireInfo.arcarum.retire_tp}):o.replaceMessage("arcarum_quest_2",a)),this.popView=new h({className:"pop-retire",title:o.getMessage("quest_142"),body:b,flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow(),0!=$(".prt-event-quest-intro").length){var c=-$(".prt-event-fv").outerHeight()+parseInt($(".pop-retire").css("top"));$(".pop-retire").css("top",c+"px")}},popMultiBattleRetireOk:function(){this.popRemove(),this.isProgress?this.comfirmRestartQuest():this.isShowAirSpacePop?this.popAirspace():(this.tutorialMovieDeferred.resolve(),this.completeSideStoryQuestPop())},removeConfirmRetire:function(){var a=null;this.progressQuestInfo&&(a=this.progressQuestInfo.quest_type),this.comfirmRestartQuest(a)},limitOver:function(){this.$el.find(".prt-assault-time").hide()},popupQuestRetireRemove:function(){this.popView&&this.popRemove(),this.content_close(),n.hash(location.hash,{refresh:!0})},popAboutAssault:function(){this.popView=new h({className:"pop-about-assault",title:o.getMessage("quest_84"),body:$("#tpl-about-assault").html(),flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow()},popHalfList:function(a){var b=$(a.currentTarget),c=b.data("banner"),d=$("#tpl-pop-half-btn");this.popView=new h({className:"pop-half-list",title:o.getMessage("campaign_title_1"),body:_.template($("#tpl-pop-half").html(),{targetBanner:c}),flagBtnClose:1}),this.popView.render(),d&&this.popView.$el.find(".prt-popup-footer").append(d.html()),this.popView.popShow()},pop_help_beginner:function(a){var b,c;$(a.currentTarget).data("title")?(b=o.getMessage("quest_86"),c=_.template($("#tpl-help-incentive").html(),{comment:$(a.currentTarget).data("title"),pop:$(a.currentTarget).data("pop"),type:$(a.currentTarget).data("type")})):(b=o.getMessage("quest_87"),c=_.template($("#tpl-help-guild").html(),{comment:$(a.currentTarget).data("title")})),this.popView=new h({className:"pop-help-guild",title:b,body:c,flagBtnCancel:0,flagBtnClose:1,flagBtnOk:0}),this.popView.render(),this.popView.popShow()},popExtraHell:function(a){var b=null,c=null,d={id:this.questListInitModel.get("appearance").event_id,title:this.questListInitModel.get("appearance").quest_name,extra_hell_id:this.questListInitModel.get("appearance").chapter_id};"7"==d.extra_hell_id.substring(0,1)?(b="pop-event-hell",c=_.template($("#tpl-event-hell").html(),{event_name:this.treasureraid_name})):(b="pop-extra-hell",c=_.template($("#tpl-extra-hell").html(),{extra_hell_id:d.extra_hell_id})),this.popView=new h({className:b,title:o.getMessage("quest_88"),body:c,flagBtnCancel:0,flagBtnClose:1,flagBtnOk:0}),this.popView.render(),this.popView.popShow(),$(".pop-extra-hell").css("top","60px")},popAirspace:function(){var a=j.getAirSpaceInfo(this.questListInitModel.get("last_clear_chapter")),c={name:o.getMessage(a.airspaceNameKey),showTutorial:a.showTutorial};this.popView=new h({className:"pop-go-air-space",title:o.getMessage(a.popupTitleKey),body:_.template($("#tpl-pop-go-air-space").html(),{data:c}),flagBtnClose:1}),this.popView.render().popShow();var d=new(b.extend({urlRoot:Game.baseUri+"quest/pop_airspace_notified"}));d.save()},getPairQuest:function(a){var b=$(a.currentTarget);this.isPairQuest=!0,this.tapPairQuestData={isTreasureConsume:b.hasClass("btn-treasure-raid")||b.hasClass("use-treasure"),isDispStartPopup:b.data("is-disp-start-popup"),startPopupType:b.data("start-popup-type")||"",isProgress:b.hasClass("ico-progress"),locationId:b.data("location-id")};var c=new(k.extend({urlRoot:Game.baseUri+"quest/pair_quest_data/"+b.data("chapterId")+"/"+b.data("type")+"/"+b.data("questId")}));this.stopListening(c,"sync"),this.listenToOnce(c,"sync",this.checkPairQuestCount),Game.loading.xhrStart(),c.fetch()},checkPairQuestCount:function(a){Game.loading.xhrEnd();var b=a.toJSON();0===+b.base_side_quest_limited_count?this.cautionPop(o.getMessage("quest_101"),this.CAUTION_FLAGMENT_OVER_LIMIT):this.popSelectPairQuest(b)},popSelectPairQuest:function(a){var b=[{questInfo:a.base_side_quest},{questInfo:a.released_side_quest}];b[0].questInfo.currentLimitedCount=a.base_side_quest_limited_count,b[1].questInfo.currentLimitedCount=a.released_side_quest_limited_count;var c=this,d=new h({className:"pop-select-pair-quest",title:a.base_side_quest.chapter_name,body:_.template($("#tpl-pop-select-pair-quest").html(),{displayData:b,locationId:this.tapPairQuestData.locationId}),flagBtnCancel:1});d.render();var e=d.$el.find(".btn-select-pair-quest");this.listenToOnce(d,"cancel",function(){e.off(),c.isPairQuest=!1,d.popRemove(),c.trigger(c.CLOSE_PAIR_QUEST_TRIGGER)}),e.one("tap",function(a){var e=$(this),f=b[0].questInfo.difficulty_name,g=b[1].questInfo.difficulty_name;c.stopListening(d,"cancel"),e.hasClass("disabled")===!0?(d.popDelete(),0===+e.data("index")&&(f=b[1].questInfo.difficulty_name,g=b[0].questInfo.difficulty_name),c.cautionPop(o.replaceMessage("caution_pop_1",{"%s1":f,"%s2":g}))):c.tapPairQuestData.isTreasureConsume?(d.popDelete({isHideMask:!1}),e.attr({"data-is-disp-start-popup":c.tapPairQuestData.isDispStartPopup,"data-start-popup-type":c.tapPairQuestData.startPopupType}),c.tapPairQuestData.isProgress&&e.addClass("ico-progress"),c.questTreasureRaid(a)):(d.popRemove(),c.clearedEpisode(a))}),d.popShow()},questRestartPopupCancel:function(){this.popRemove(),this.isShowAirSpacePop?this.popAirspace():(this.tutorialMovieDeferred.resolve(),this.completeSideStoryQuestPop())},location_href:function(b){var c=$(b.currentTarget).data("location-href");this.content_close(),$(b.currentTarget).hasClass("event-select")?n.href(c):a.history.navigate(c,!0)},onTapRank250Quest:function(a){var b=$(a.currentTarget);this.isSceneOnly=b.data("scene-only")||0,this.sceneId=b.data("scene-id"),this.getRank250QuestInfo(a)},getRank250QuestInfo:function(a){var b=this,c=$(a.currentTarget);$.Deferred(function(d){if(b.rank250QuestInfo)d.resolve();else{var e=new(k.extend({urlRoot:Game.baseUri+"quest/treasure_raid/10313/103131"}));b.listenToOnce(e,"sync",function(e){b.rank250QuestInfo=_.defaults({isSceneOnly:b.isSceneOnly,sceneId:b.sceneId},e.toJSON()),b.trigger("xhrEnd"),c.data("is-disp-start-popup")?d.resolve():b.eventpointCheck(a,{chapterId:b.rank250QuestInfo.chapter_id,questType:b.rank250QuestInfo.type,useItemType:b.rank250QuestInfo.use_item_type})}),b.trigger("xhrStart"),e.fetch()}}).then(this.popRank250Quest.bind(this))},popRank250Quest:function(){var a=[],b=this;this.rank250QuestInfo.num.forEach(function(c,d){a.push({num:b.rank250QuestInfo.num[d],itemId:b.rank250QuestInfo.treasure_id[d],name:b.rank250QuestInfo.treasure_name[d]})}),this.popView=new h({className:"pop-rank-250-quest",title:o.getMessage("pop_title_rank_250"),body:_.template($("#tpl-pop-rank-250-quest").html(),{rank250Treasures:a}),flagBtnCancel:1}),this.popView.render(),this.popView.$el.find(".prt-popup-footer").append(_.template($("#tpl-button-battle").html(),{data:this.rank250QuestInfo,isInsufficient:_.where(a,{num:0}).length>0})),this.popView.popShow()},popSacredTreasure:function(a){var b=$(a.currentTarget),c=b.data("index");this.popView=new h({className:"pop-rank-250-hint",title:b.data("item-name"),body:_.template($("#tpl-pop-rank-250-hint").html(),{itemId:b.data("item-id"),text:o.getMessage("rank_250_hint_"+c),textVyrn:o.getMessage("rank_250_vyrn_"+c),textLyria:o.getMessage("rank_250_lyria_"+c)}),flagBtnClose:1}),this.popView.render().popShow()},completeSideStoryQuestPop:function(){this.isSideStory&&this.sideStoryQuestPopDeferred&&"pending"===this.sideStoryQuestPopDeferred.state()&&(this.sideStoryQuestPopDeferred.resolve(),this.sideStoryQuestPopDeferred=null)}},{EVENT_COMPLETE_RENDER_LIST:r});return s});