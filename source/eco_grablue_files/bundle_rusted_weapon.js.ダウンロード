define(["backbone","model/data","model/token-data","model/sound","constant/inventory","view/popup","view/content","util/language-message"],function(a,b,c,d,e,f,g,h){var i={LIST_ALL:"listall",CONTAINER:"container",DETAIL:"detail"},j={RUSTED_WEAPON:1},k=g.extend({pageName:"",containerId:"",containerNum:"",callbackFunc:{},events:{"tap .pop-unload-rusted .btn-rusted-move":"checkContainerList","tap .pop-unload-rusted .btn-rusted-uncap":"locationBundleEvolution","tap .pop-unload-rusted .btn-usual-cancel":"popRemove",'tap .pop-container-list.rusted .lis-container:not(".disabled")':"postRustedWeapon","tap .pop-container-list.rusted .lis-container.disabled":"popMoveContainerError","tap .pop-container-list.rusted .btn-usual-cancel":"popRemove","tap .pop-move-rusted-empty .btn-usual-ok":"locationShop","tap .pop-move-rusted-empty .btn-usual-cancel":"popRemove","tap .pop-move-rusted-container-error .btn-usual-ok":"errorMoveContainer","tap .pop-rusted-result .btn-usual-ok":"closeRustedResult"},setPageName:function(a){this.pageName=a},setContainerId:function(a){this.containerId=a},setContainerNum:function(a){this.containerNum=a},setResultCallBack:function(a){this.callbackFunc=a},errorMoveContainer:function(){this.popView.popDelete(),this.popContainerList()},popUnloadRusted:function(){this.popView=new f({className:"pop-unload-rusted",title:h.getMessage("rusted_weapons_1"),body:_.template($("#tpl-pop-unload-rusted").html(),{pageName:this.pageName}),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow()},checkContainerList:function(a){var b=this;this.trigger("xhrStart"),a.preventDefault(),this.getPossessContainer().done(function(a){""!==b.containerId&&delete a.list[b.containerId],b.resultPossessContainer(a)})},resultPossessContainer:function(a){return this.trigger("xhrEnd"),"undefined"==typeof a?void this.popContainerEmpty():(this.resultContainer=a,void this.popContainerList())},getPossessContainer:function(){var a;switch(this.pageName){case i.CONTAINER:a=new(c.extend({urlRoot:Game.baseUri+"rest/container/popup_move_list/weapon"}));break;default:a=new(c.extend({urlRoot:Game.baseUri+"container/containers/weapon"}))}return a.fetch()},popContainerEmpty:function(){this.popView=new f({className:"pop-move-rusted-empty",title:h.getMessage("rusted_weapons_3"),body:$("#tpl-no-container").html(),flagBtnOk:1,flagBtnCancel:1}),this.popView.render(),this.popView.$el.find(".btn-usual-ok").html(h.getMessage("rusted_weapons_4")),this.popView.popShow()},locationShop:function(){this.content_close(),a.history.navigate("shop",!0)},popContainerList:function(){var a="";switch(this.pageName){case i.LIST_ALL:a=this.$el.find(".prt-4tabs .active").html();break;default:a=h.getMessage("rusted_weapons_11")}this.popView=new f({className:"pop-container-list rusted",title:h.getMessage("rusted_weapons_5"),body:_.template($("#tpl-pop-container").html(),_.extend(this.resultContainer,{name:a.toLowerCase()})),flagBtnCancel:1}),this.popView.render().popShow()},popMoveContainerError:function(){var a=this.pageName===i.CONTAINER?h.getMessage("rusted_weapons_13"):h.getMessage("rusted_weapons_7");this.popView=new f({className:"pop-move-rusted-container-error",title:h.getMessage("rusted_weapons_6"),body:a,flagBtnOk:1}),this.popView.render().popShow()},postRustedWeapon:function(a){var b=$(a.currentTarget),d=b.data("containerId"),e=b.find(".txt-container-name").html(),f="",g={};switch(this.pageName){case i.CONTAINER:f="rest/container/weapon/tidy/move_execute_for_filter_type",g={container_id:this.containerId,to:0===+d?"list":"container",to_container_id:d,filter_type:j.RUSTED_WEAPON};break;default:f="distribution/container/execute_for_filter_type",g={type:2,item_kind:1,filter_type:j.RUSTED_WEAPON,container_id:d}}var h=new(c.extend({urlRoot:Game.baseUri+f}));this.trigger("xhrStart"),this.stopListening(h,"sync"),this.listenToOnce(h,"sync",function(a){this.popRustedResult(e,a.toJSON())}),h.set(g).save()},popRustedResult:function(a,b){var c=parseInt(b.count,10)>0,g="",j="";c?this.pageName===i.CONTAINER?(g=h.getMessage("rusted_weapons_12"),j=h.replaceMessage("rusted_weapons_14",{"%s":b.count},+b.count)):(g=h.getMessage("rusted_weapons_8"),j=h.replaceMessage("rusted_weapons_9",{"%s":b.count},+b.count)):(g=h.getMessage("rusted_weapons_5"),j=h.getMessage("rusted_weapons_10"));var k={isMoved:c,result:b,resultMoveTxt:j,containerName:a};this.popView.popDelete(),this.popView=new f({className:"pop-rusted-result",title:g,body:_.template($("#tpl-move-rusted-weapon-result").html(),k),flagBtnOk:1,showEndCallback:function(){c&&d.playSE(e.SE.MOVE_ITEM)}}),this.popView.render().popShow(),this.trigger("xhrEnd")},locationBundleEvolution:function(){var b="";switch(this.pageName){case i.CONTAINER:b="evolution/bundle/container/"+this.containerId+"/"+this.containerNum;break;default:b="evolution/bundle/list"}a.history.navigate(b,!0)},closeRustedResult:function(){this.popRemove(),"function"==typeof this.callbackFunc&&this.callbackFunc()},popRemove:function(){this.popView.popRemove()}});return k});