define(["backbone","constant","model/data","model/content","view/content","view/quest/list-sub","view/popup","model/data","model/sound","util/language-message"],function(a,b,c,d,e,f,g,h,i,j){var k="100000",l={21002:640,22001:500},m=e.extend({param:null,dispFlag:0,selectedAreaId:null,raidId:null,nextMainQuestChapterId:null,suggestMainQuestFlg:!1,events:{"tap .btn-display-control":"party_control","tap .btn-main-quest":"quest_render","tap .btn-free-or-multi-quest":"quest_render","tap .btn-multi-quest":"multi_raid_render","tap .btn-character-quest":"characterQuestLocation","tap .btn-bookmark-record.open":"renderRecordOpen","tap .btn-bookmark-record.close":"renderRecordClose","tap #prt-scroll-btn-wrapper .btn-left-icon":"canvasMoveLeft","tap #prt-scroll-btn-wrapper .btn-right-icon":"canvasMoveRight","touchstart .prt-canvas-wrapper":"canvasMove","mousedown .prt-canvas-wrapper":"canvasMove","tap #prt-defend-order-info .btn-do-underway":"checkReleaseStatus","tap .pop-unreleased-island .btn-usual-close":"popRemoveDefendOrder","tap .pop-check-defend-order .btn-usual-close":"popRemoveDefendOrder","tap #initMove":"renderInitMove","tap #initMoves":"renderInitMoves"},initialize:function(a){this.content_bind(),this.raidId=a.raid_id||null,this.locationId=a.locationId,this.isShowAirSpacePop=a.isShowAirSpacePop||!1,this.param={area_id:a.selected_area_id},this.selectedAreaId=a.selected_area_id,this.completedQuestId=a.completed_quest_id,this.bookmarkPage=a.bookmarkPage||"";var b=new(c.extend({urlRoot:Game.baseUri+"rest/quest/redirect_check"}));this.listenToOnce(b,"sync",this.contentFetch),b.fetch()},contentFetch:function(b){var c=b.toJSON();if(c.tutorial_id)this.locationTutorial(c.tutorial_id);else if(c.is_unshow_island_open_flash_location_id)this.locationIslandOpenFlash(c.is_unshow_island_open_flash_location_id,c.is_open_airspace);else if(this.raidId)this.locationReward(this.raidId,!0);else if(c.raid_id)this.locationReward(c.raid_id,c.is_multi);else if(c.url)a.history.navigate(c.url,!0);else{var e=_.isEmpty(this.selectedAreaId)||0!==+this.selectedAreaId?1:0,f=this.selectedAreaId&&this.selectedAreaId!==k,g={is_recommend_show:e,area_id:f?this.selectedAreaId:"",page:this.bookmarkPage},h="newindex";this.locationId&&(g={location_id:this.locationId},h="move_town_quest_top");var i=new d({controller:"quest",action:h,param:g});this.listenToOnce(i,"sync",this.render),i.fetch()}},render:function(a){this.content_render(a),$(".prt-head-current").html(j.getMessage("quest_32")),i.playQuestMapBGM("normal");var b=a.toJSON().option;this.suggestMainQuestFlg=!!b.quest.init_list.suggest_main_quest_flag,this.nextMainQuestChapterId=+b.quest.init_list.last_clear_chapter+1,this.isWide=b.quest.init_list.is_island_section_flg,this.locationId=b.quest.init_list.location_id,this.subView=new f({selected_area_id:this.selectedAreaId,completed_quest_id:this.completedQuestId,called_view:this,isQuestIndex:!0,questContentData:b.quest||{},contentPopupData:b.popup||{},isAirshipFixed:this.isWide,isShowAirSpacePop:this.isShowAirSpacePop,suggestMainQuestFlg:this.suggestMainQuestFlg});var c=this;return this.subView.on(f.EVENT_COMPLETE_RENDER_LIST,function(){c.appealQuestBanner(c.nextMainQuestChapterId,c.suggestMainQuestFlg)}),this.addSubView(this.subView),this.status_render(b.user_status),this.isWide===!0&&this.prepareToScrollX(b),this.trigger("loadEnd"),this},renderInitMove:function(a){window.quest_map_select=0,window.exportRoot.children[0].gotoAndPlay("noselect"),this.subView.initMove()},renderInitMoves:function(a){window.quest_map_select=0,window.exportRoot.children[0].gotoAndPlay("noselect"),this.subView.initMoves()},renderRecordOpen:function(){this.subView.btnRecordOpen()},renderRecordClose:function(){this.subView.btnRecordClose()},setUmdelegateEvents:function(a){this.undelegateEvents();var b=this;setTimeout(function(){b.delegateEvents()},a)},party_control:function(){0==this.dispFlag?(this.$el.find(".prt-current-deck").addClass("show"),this.dispFlag=1):(this.$el.find(".prt-current-deck").removeClass("show"),this.dispFlag=0)},status_render:function(a){this.$el.find(".prt-user-status").html(_.template($("#status").html(),a)),this.numRepStatus($(".txt-stamina-value"),"num-stamina"),this.bp_replace($(".prt-user-bp-value"),$(".prt-user-bp-value").attr("title"))},quest_render:function(a){var b=$(a.currentTarget),c=h.extend({urlRoot:Game.baseUri+"quest/recomment_quest_area/"+b.data("quest-type")}),d=new c,e=this;this.listenToOnce(d,"sync",function(a){e.subViewClose(this.subView),e.subView=new f({is_progress_popup_stop_flg:!0,selected_area_id:a.get("area_id"),called_view:this}),e.addSubView(e.subView)}),d.fetch()},checkReleaseStatus:function(a){var b=this,c=Game.baseUri+"defendorder/location_release_status/",d=new(h.extend({urlRoot:c}));this.stopListening(d,"sync"),this.listenTo(d,"sync",function(a){var c=a.toJSON();c.is_released_of_location?b.popDefendOrderItems():b.popUnreleasedIsland(c.need_clear_chapter)}),this.checkReleaseStatus=function(a){b.trigger("xhrStart"),d.urlRoot=c+$(a.currentTarget).data("do-location"),d.fetch()},this.checkReleaseStatus(a)},popUnreleasedIsland:function(a){this.popView=new g({className:"pop-unreleased-island",title:j.getMessage("quest_do_2"),body:_.template($("#tpl-pop-unreleased-island").html(),{needClearChapter:a}),flagBtnClose:1,flagBtnOk:0}),this.popView.render().popShow(),this.trigger("xhrEnd")},popDefendOrderItems:function(){this.popView=new g({className:"pop-check-defend-order",title:j.getMessage("quest_do_1"),body:$("#tpl-pop-do-underway").html(),flagBtnCancel:0,flagBtnClose:1,flagBtnOk:0}),this.popView.render(),this.popView.$el.find(".prt-popup-footer").append($("#tpl-btn-location-island").html()),this.popView.popShow(),this.trigger("xhrEnd")},popRemoveDefendOrder:function(){this.popView&&this.popView.popRemove()},multi_raid_render:function(){this.content_close(),a.history.navigate("quest/assist",!0)},characterQuestLocation:function(){this.content_close(),a.history.navigate("quest/fate",!0)},locationTutorial:function(b){this.content_close(),a.history.navigate("tutorial/"+b,!0)},locationReward:function(b,c){this.content_close(),c?a.history.navigate("result_multi/"+b,!0):a.history.navigate("result/"+b,!0)},locationIslandOpenFlash:function(b,c){var d=c?"/1":"";this.content_close(),a.history.navigate("quest/island/release/"+b+d,!0)},subViewClose:function(a){a.off(),a.undelegateEvents(),a.stopListening(),this.destroySubViews()},prepareToScrollX:function(a){$("#prt-scroll-btn-wrapper").html($("#tpl-btn-scroll").html()),this.$el.find(".prt-canvas-wrapper").append($("#tpl-canv-fixed-airship").html()),this.$el.find(".prt-canvas-wrapper").append($("#tpl-canv-gradation").html()),this.dispIndex=+a.quest.init_list.progress_island_section,this.rightMostIndex=2,this.$canvas=$("#canvas"),this.$btnL=this.$el.find(".btn-left-icon"),this.$btnR=this.$el.find(".btn-right-icon"),this.$canvas.css("width",l[this.locationId]+"px"),this.zoom=Game.getZoom(),this.hiddenIslandWidth=l[this.locationId]-320;var b=-70*this.zoom;$("#canv-fixed-airship").css({left:b}),this.autoScroll(!0)},canvasMoveLeft:function(){this.dispIndex>1&&this.dispIndex--,this.autoScroll()},canvasMoveRight:function(){this.dispIndex<this.rightMostIndex&&this.dispIndex++,this.autoScroll()},autoScroll:function(a){var b=this,c=this.rightMostIndex-this.dispIndex;this.$canvas.addClass("prt-canvas-transition"),this.$canvas.css("right",-(this.hiddenIslandWidth*c*this.zoom)+"px"),this.$canvas.oneTransitionEnd(function(){b.$canvas.removeClass("prt-canvas-transition"),b.updateBtnVisibility()},100),a&&(b.$canvas.removeClass("prt-canvas-transition"),b.updateBtnVisibility())},canvasMove:function(a){if(this.isWide){if("mousedown"===a.type&&!Game.ua.isPcPlatformHasTouch)return void a.preventDefault();var b=this,c=$(a.currentTarget),d=function(a){a.preventDefault(),"mousedown"===a.type?b.touchStartX=a.originalEvent.pageX*b.zoom:b.touchStartX=a.originalEvent.changedTouches[0].pageX,b.rightStartX=b.$canvas.css("right")},e=function(a){a.preventDefault(),b.$btnL.removeClass("hide"),b.$btnR.removeClass("hide");var c;c="mousemove"===a.type?a.originalEvent.pageX*b.zoom:a.originalEvent.changedTouches[0].pageX;var d=b.touchStartX-c,e=b.rightStartX.replace("px",""),f=Math.floor(+e+ +d);f<-(b.hiddenIslandWidth*b.zoom)?(f=-(b.hiddenIslandWidth*b.zoom),b.updateBtnVisibility()):f>0&&(f=0,b.updateBtnVisibility()),f<-160*b.zoom?b.dispIndex=1:b.dispIndex=2,b.$canvas.css("right",f+"px")};c.off(),"mousedown"===a.type&&Game.ua.isPcPlatformHasTouch?(d(a),c.on("mousemove",e),c.one("mouseup mouseleave",function(){c.off()})):"touchstart"===a.type&&(d(a),c.on("touchmove",e),c.one("touchend",function(){c.off()}))}},updateBtnVisibility:function(){var a=1===this.dispIndex,b=this.dispIndex===this.rightMostIndex;this.$btnL.toggleClass("hide",a),this.$btnR.toggleClass("hide",b)},appealQuestBanner:function(a,b){var c=this.$el.find('.prt-quest-list .btn-quest-list[data-chapter-id="'+a+'"]')||null;c&&(c.parent().addClass("is-next-chapter"),c.toggleClass("is-lighting",b))}});return m});