define(["flexslider","view/footer/popup","model/token-data","model/sound","view/content","view/common/validate","lib/shellapp","lib/andapp","util/local-storage","util/navigate","util/language-message"],function(a,b,c,d,e,f,g,h,i,j,k){var l=10,m=3,n=42,o=$(Game.gameContainer.selector).find(".mask"),p="",q=250001,r="footerPopRegistrationNum",s=Backbone.View.extend({el:"#treasure-footer-wrapper",isTreasurePUOpen:!1,isHidingOtherPUs:!1,isLoading:!1,registrationNum:0,events:{"tap .prt-treasure-wrapper":"popTreasure","tap .pop-treasure .btn-treasure-registration":"onTapRegisterBtn","tap .pop-treasure .btn-usual-cancel":"popRemove","tap .pop-registration-treasure-num .btn-usual-cancel":"popRemove","tap .pop-registration-treasure-num .btn-usual-ok":"onTapRegistrationNum"},initialize:function(){this.prepareGameTreasure(),Game.treasure.init(),Game.shellAppFlag===!0&&Game.ua.isAndroid()===!0&&Game.ua.versionCompare(Game.ua.os.version,"4.4")<0&&this.toggleTreasureFooterOnWindowResize()},toggleTreasureFooterOnWindowResize:function(){var a=$(window),b=a.height(),c=0;a.resize(function(){c=a.height(),b>c?Game.treasure.hide():c===b&&Game.treasure.show()})},popTreasure:function(a){d.playSE("se/btn_se/btn_se_03.mp3");var c=!!Game.view.isItemPage&&!!Game.view.popView&&!!Game.view.popView.$el.children().length;c&&Game.view.popView.destroy();var e=$(a.currentTarget).data("item-id"),f=_.findWhere(Game.treasure.list,{item_id:e.toString()}),g={name:f.name,comment:f.comment,item_id:f.item_id,is_display_select_item:!0,kind:"article"};this.popView=new b({className:"pop-treasure",title:k.getMessage("pop_treasure_title"),body:_.template($("#tpl-pop-body-treasure").html(),g),flagBtnCancel:1,flagBtnOk:0}),this.commonPopProcess(c)},popRegistrationNum:function(a,c){var d=!!Game.view.isItemPage&&!!Game.view.popView&&!!Game.view.popView.$el.children().length;d&&Game.view.popView.destroy(),this.popView&&this.popView.$el.find(".pop-usual").hasClass("pop-show")&&this.popView.popDelete(),this.popView=new b({className:"pop-registration-treasure-num",title:k.getMessage("pop_treasure_title_2"),body:_.template($("#tpl-pop-registration-treasure-num").html(),{itemId:a,itemName:c}),flagBtnCancel:1,flagBtnOk:1}),this.commonPopProcess(d)},commonPopProcess:function(a){var b=this;p="",o.is(":visible")===!0&&0===$("#treasure-pop").children().length&&a===!1&&(this.isHidingOtherPUs=!0,o.attr("style").indexOf("z-index")>0&&(p=o.css("z-index")),o.css({"z-index":q-1})),$("#loading").css({"z-index":q+1}),this.popView.render().popShow(),this.popView.stopListening(),this.popView.listenToOnce(Game.router,"route",function(){b.popRemove()}),this.isTreasurePUOpen=!0},onTapRegistrationNum:function(){this.registrationNum=f.validateTreasureNum($("#favorite-treasure-num").val()),this.trigger(r)},popRemove:function(){if(this.isLoading!==!0){this.stopListening(this,r);var a=this.isHidingOtherPUs===!0?1:0;this.popView.popRemove(a),this.popView.stopListening(),this.isHidingOtherPUs&&(this.isHidingOtherPUs=!1,o.css({"z-index":p}),this.trigger("treasurePopupClose")),$("#loading").css("z-index",""),this.isTreasurePUOpen=!1}},destroy:function(){this.isTreasurePUOpen=!1,this.popView.destroy()},onTapRegisterBtn:function(a){a.preventDefault(),a.stopPropagation();var b=this.popView.$el.find(".cnt-treasure-footer-confirm");this.handleRegistration($(a.currentTarget),+b.attr("item_id"),b.attr("item_name"))},handleRegistration:function(a,b,c){var d=this,e=function(){d.registrateTreasure(a,b)};this.registrationNum=0,a.hasClass("selected")?e():(this.stopListening(this,r),this.listenToOnce(this,r,e),this.popRegistrationNum(b,c))},registrateTreasure:function(a,b){function d(b){var d=new(c.extend({urlRoot:Game.baseUri+"item/"+g}));e.stopListening(d),e.listenToOnce(d,"sync",function(){Game.view.trigger("xhrEnd"),e.isLoading=!1,a.toggleClass("selected",!f),f===!1&&e.popRemove()}),d.save(b)}var e=this,f=a.hasClass("selected"),g=f?"remove_display_select_item":"add_display_select_item",h={item_id:b,item_kind_id:l};if(Game.view.trigger("xhrStart"),this.isLoading=!0,f===!1)Game.treasure.isAddingNow=!0,h.registration_number=this.registrationNum,d(h);else{var i=this.$el.find('.prt-treasure-wrapper[data-item-id="'+b+'"]').parent();i.addClass("fadeout").oneAnimationEnd(function(){$(this).remove(),d(h)},550)}if(Game.view.isItemPage===!0)if(Game.view.isItemListFilter){var j=_.findWhere(Game.view.allTreasureItemList,{item_id:b.toString()});"undefined"!=typeof j&&(j.is_display_select_item=!f)}else for(var k=Game.view.treasure_item_list.models,m=0,n=k.length;n>m;m+=1)if(k[m].get("item_id")===b.toString()){k[m].set("is_display_select_item",!f);break}},prepareGameTreasure:function(){var a=this,b=$("#treasure-list"),c=$("#prt-treasure-slider"),d=$("#treasure-footer"),e=$("#general-chat");Game.treasure={init:function(){this.max=b.data("treasureMax"),this.currentPage=0,i.isSupported()&&(this.currentPage=+i.getItem("treasure-current-page")||0),g.isShellApp()===!0?a.$el.hasClass("shellapp-beginner")===!1&&g.hideBackground():Game.ua.isAndApp()===!0&&h.hideBackground()},list:[],isAddingNow:!1,isSetMax:function(){return this.currentLength>=this.max},updateList:function(a){this.list=_.toArray(_.sortBy(a,"id")),this.currentLength=_.size(this.list),this.pageLength=Math.ceil(this.currentLength/3),this.renderFooter(),this.updateBackground()},renderFooter:function(){var a=this;if(b.html(_.template($("#tpl-treasure-list").html(),{treasures:this.list})),this.initFlexslider(),this.isAddingNow===!0){this.isAddingNow=!1;var c=b.find(".lis-treasure").eq(a.currentLength-1);c.addClass("hide"),this.slideToTheLastPage(function(){c.addClass("fadein").removeClass("hide").oneAnimationEnd(function(){$(this).removeClass("fadein")},650)})}},initFlexslider:function(){var d=0;this.currentLength%m>0&&(d=m-this.currentLength%m);for(var e="",f=0;d>f;f+=1)e+='<li class="lis-treasure empty">';b.append(e),Math.floor((this.currentLength-1)/m)<this.currentPage&&(this.currentPage=Math.max(--this.currentPage,0),this.updateLS()),c.init(),c.removeData("flexslider"),this.slider=c.flexslider({selector:"#treasure-list > .lis-treasure",prevText:"",nextText:"",animation:"slide",controlNav:!1,slideshow:!1,itemWidth:n,itemMargin:0,maxItems:m,minItems:1,move:m,animationLoop:!1,startAt:this.currentPage,init:function(){var b=a.$el.find(".flex-viewport");b.length>1&&(b.eq(0).remove(),a.$el.find(".flex-direction-nav").eq(0).remove())},after:function(){Game.treasure.currentPage=Game.treasure.getCalculatedCurrentPage(),Game.treasure.updateLS()}})},slideToTheLastPage:function(a){return a=a||function(){},this.pageLength===this.currentPage+1?void a():(c.flexslider(this.pageLength-1),void c.oneTransitionEnd(function(){a()},650))},slideToTargetPage:function(a){for(var b=-1,d=0,e=this.list.length;e>d;d+=1)if(this.list[d].item_id===a.toString()){b=d;break}if(!(0>b)){var f=Math.floor(b/m);c.flexslider(f)}},updateBackground:function(){a.$el.find(".cnt-treasure-footer").toggleClass("plain",this.currentLength>0)},getCalculatedCurrentPage:function(){var a=Math.abs(+b.css("transform").split(",")[4]);return a/(n*m)},updateLS:function(){i.isSupported()&&i.setItem("treasure-current-page",this.currentPage)},show:function(){d.removeClass("hide"),e.addClass("shell")},hide:function(){d.addClass("hide"),e.removeClass("shell")}}},validateTreasure:function(a){return a.kind&&a.id?+a.kind!==l?null:1===+a.disable?null:a.unique_article_id?a.unique_article_id:a.id:null}});return s});