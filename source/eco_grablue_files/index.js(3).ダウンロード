define(["backbone","model/content","model/data","model/token-data","view/content","lib/jquery.tabs","model/user/weapon","model/user/summon","model/user/npc","view/common/evo_star","view/common/sort_filter","view/common/sell_stash_filter","view/common/list","view/common/bundle_rusted_weapon","view/popup","view/help","util/navigate","util/page-slider","util/language-message"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=p.extend({events:{"tap .btn-help-close":"onpushclose"},onpushclose:function(){this.trigger("pushclose")}}),u="skin",v=4,w=m.extend({content_model:null,page:1,sort:-1,selected_item:"weapon",selected_collection:null,selected_model:null,container_list_model:{},change_list:{},change_options:null,events:{"tap #tab-weapon":"weapon_tab","tap #tab-summon":"summon_tab","tap #tab-npc":"npc_tab","tap #tab-skin":"skinTab","complete_set_sort #pop":"completeSortSetting","tap .prt-order .btn-sort-change":"startSortSetting","tap .prt-order .btn-custom-filter":"popCustomFilter","tap .prt-weapon-category div":"weapon_pre_render","tap .pop-detail .btn-usual-cancel":"popDetailRemove","tap .pop-detail .btn-enhance":"locationEnhance","tap .pop-detail .img-target":"popDetailImage","tap .pop-detail .btn-cancel":"popDetailRemove","tap .pop-detail .btn-item":"locationItem","tap .pop-detail .btn-costume":"locationCostume","tap .image-up":"popClose","tap #lis-weapon .lis-item":"selectWeapon","tap #lis-summon .lis-item":"selectSummon","tap #lis-npc .lis-item":"selectNpc","tap #lis-skin .lis-item":"selectSkinCharacter","tap .skin-list-pop-up .btn-usual-close":"popRemove","tap .skin-list-pop-up .lis-item":"selectSkin","tap .skin-pop-up .btn-usual-close":"repopSelectSkinCharacter","tap .btn-usual-tips":"popShowSkinTips","tap .prt-container .btn-container":"popContainerList","tap .pop-container-list.line-up .lis-container":"selectContainer","tap .pop-container-list.line-up .btn-usual-cancel":"popRemove","tap .prt-sell .btn-sell":"location_href","tap .pop-container-over .btn-usual-ok":"popRemove","tap .pop-move-container-empty .btn-usual-ok":"locationShop","tap .pop-move-container-empty .btn-usual-cancel":"popRemove","tap .btn-prev-top":"pagination","tap .btn-prev":"pagination","tap .btn-forward":"pagination","tap .btn-forward-last":"pagination","tap .btn-page-number":"pagination","tap .prt-param-icon .btn-current-sort":"setNextStatusInfo","tap .prt-list-tidy .btn-list-tidy":"popListTidy","tap .pop-list-tidy .btn-usual-close":"popRemove","tap .pop-list-tidy .btn-unload-rusted":"popUnloadRusted"},initialize:function(a){this.content_bind(),this.container_list_model={},a?(this.sort_num=a.deck_num,this.page_num=a.set_num,this.param_id=a.param_id,this.active_tab=a.active_tab,this.from_detail_flg=1):(this.sort_num=-1,this.page_num=1,this.param_id=0,this.active_tab=1),this.destroySubViews(),this.sortSettingSubView=new k,this.addSubView(this.sortSettingSubView),this.content_model=new b({controller:"listall",action:"index"}),this.listenToOnce(this.content_model,"change",this.render),this.weapon_model=new g,this.summon_model=new h,this.npc_model=new i,this.listenTo(this.weapon_model,"change",this.popItemShow),this.listenTo(this.summon_model,"change",this.popItemShow),this.listenTo(this.npc_model,"change",this.popItemShow),this.sellStashFilterView=new l;var c=this;this.sellStashFilterView.setSendType(2),this.sellStashFilterView.setListName("listall"),this.sellStashFilterView.setListUpdate(function(){"weapon"===c.selected_item?c.weapon_pre_render():c.summon_pre_render()}),this.addSubView(this.sellStashFilterView),this.bundleRustedWeaponSubView=new n,this.bundleRustedWeaponSubView.setPageName("listall"),this.bundleRustedWeaponSubView.setResultCallBack(function(){c.weapon_pre_render()}),this.addSubView(this.bundleRustedWeaponSubView),this.content_model.fetch()},render:function(){this.content_render(this.content_model),this.$el.find(".prt-4tabs").tabs({tabClass:"btn-tabs",tabTarg:"prt-list"}),this.$el.find(".btn-tabs").removeClass("active"),this.$el.find(".prt-list").removeClass("active");var a={1:"weapon",2:"summon",3:"npc",4:"skin"}[this.active_tab];return $("#tab-"+a).addClass("active"),$("#prt-list-"+a).parent("div").addClass("active"),this[a+"_pre_render"](),$(".prt-head-current").html(s.getMessage("listall_5")),this.trigger("loadEnd"),this},popClose:function(){this.popView.popClose(),$(".mask").attr("style","").show()},popDetailRemove:function(){$(".mask").hide(),$(".pop-detail").removeClass("pop-show").addClass("pop-hide")},popSortShow:function(){$(".pop-sort, .mask").show()},weapon_tab:function(){this.sortSettingSubView.changeSelectSortOK=!1,this.trigger("xhrStart"),this.$el.find(".frm-select-simple-sort").blur(),window.scrollTo(0,1),this.weapon_pre_render(),this.sortSettingSubView.changeSelectSortOK=!0},summon_tab:function(){this.sortSettingSubView.changeSelectSortOK=!1,this.trigger("xhrStart"),this.$el.find(".frm-select-simple-sort").blur(),window.scrollTo(0,1),this.summon_pre_render(),this.sortSettingSubView.changeSelectSortOK=!0},npc_tab:function(){this.sortSettingSubView.changeSelectSortOK=!1,this.trigger("xhrStart"),this.$el.find(".frm-select-simple-sort").blur(),window.scrollTo(0,1),this.npc_pre_render(),this.sortSettingSubView.changeSelectSortOK=!0,this.isFetchedNpcLbClass=!1},skinTab:function(){this.sortSettingSubView.changeSelectSortOK=!1,this.trigger("xhrStart"),this.$el.find(".frm-select-simple-sort").blur(),window.scrollTo(0,1),this.skin_pre_render(),this.sortSettingSubView.changeSelectSortOK=!0},weapon_pre_render:function(){this.selected_item="weapon",this.sort=-1,this.page=this.page_num,this.page_num=1,this.active_tab=1,(this.from_detail_flg=1)&&(this.from_detail_flg=0),this.setListModel()},summon_pre_render:function(){this.selected_item="summon",this.sort=-1,this.page=this.page_num,this.page_num=1,this.active_tab=2,(this.from_detail_flg=1)&&(this.from_detail_flg=0),this.setListModel()},npc_pre_render:function(){this.selected_item="npc",this.sort=-1,this.page=this.page_num,this.page_num=1,this.active_tab=3,(this.from_detail_flg=1)&&(this.from_detail_flg=0),this.setListModel()},skin_pre_render:function(){this.selected_item=u,this.sort=-1,this.page=this.page_num,this.active_tab=v,this.setListModel()},setListModel:function(a){this.trigger("xhrStart");var b=new(d.extend({urlRoot:Game.baseUri+this.selected_item+"/list/"+this.page}));if(this.stopListening(b,"sync"),this.listenToOnce(b,"sync",this.item_render),this.selected_item===u)return void b.fetch();var c=this.$el.find(".prt-list.active .btn-current-sort").data("id");c?this.sortSettingSubView.changeSelectSortOK===!1&&(c=""):c="";var e={is_new:!0};a?e=_.defaults({is_new:!0},a):e.status=c,b.set(e).save()},num_render:function(a,b,c){var d=this.selected_item;$(".prt-possessed-"+d+", .txt-possessed-"+d).html(_.template($(c).html(),{total:a,max:b}))},item_render:function(a){var b=a.toJSON();if(0!=b.last&&this.page>1&&b.last<this.page)return this.trigger("xhrStart"),this.page=this.page-1,void this.setListModel();var c,d={},e=0,f=0,g=0,h=0,i=this.selected_item;d=b.list,e=b.first,f=b.prev,g=b.next,h=b.last,c=b.options,i!==u&&(this.change_list=d,this.change_options=c.status,this.sortFilterData={sort:c.sort,filter:c.filter},this.sortSettingSubView.setFilterParam("#"+this.selected_item+"-order .txt-select-name",this.selected_item,this.sortFilterData),_.each(d,function(a){var c=+a.master.max_evolution_level,d=+a.master.release_max_evolution_level,e=+a.param.evolution,f={1:"attack",2:"level",3:"hp",4:"total",5:"skill_level",6:"lb_class",7:"specialty"};a.param.status=a.param[f[b.options.status]];var g=j.listStarHtml("prt-star","prt-ultimate-star","prt-archaic-star","prt-temporary-summon-star",e,c,d,a.master.archaic||0,a.master.is_temporary||0,i,a.master.is_group||0);a.starHtml=g})),this.listItemParams={dir:i,item:d,options:c,obj:{imageDirectory:i===u?"npc/m/":i+"/m/",jobSkinImageDirectory:"leader/m/"}},i!==u?$("#lis-"+i).html(_.template($("#list-item").html(),this.listItemParams)):(d.length>0&&$("#prt-list-skin").find(".prt-list-info").removeClass("is-hidden"),$("#lis-"+i).html(_.template($("#tpl-skin-list-item").html(),this.listItemParams))),d.length>0?this.$el.find(".prt-move-container."+i).css("display","block"):this.$el.find(".prt-move-container."+i).css("display","none");var k={page:Math.max(Math.min(Number(this.page),h),1),first:e,prev:f,next:g,last:h},l={paging:this.$el.find("#prt-list-"+i).siblings(".prt-pager"),text:this.$el.find("#prt-list-"+i+" .prt-pager-text")};this.$el.find(".prt-pager").empty(),r.render(k,!0,l);var m;i!==u&&(m=void 0===c.max_number?null:c.max_number,this.num_render(c.number,m,"#tpl-list-count-"+i)),void 0!==c.sort_type&&this.$el.find(".prt-param-icon").html(_.template($("#tpl-current-param").html(),{status:c.status})),("weapon"===i||"summon"===i)&&this.renderRecycleInfo(i,b.options),this.isFetchedNpcLbClass=!1,this.trigger("xhrEnd")},renderRecycleInfo:function(a,b){var c=b["recycling_item_"+a];this.$el.find(".cnt-recycle-info."+a).html(_.template($("#tpl-recycle-info").html(),{item:c,locationHref:"recycle/"+("weapon"===a?1:2)})).addClass("show")},selectWeapon:function(b){var c=$(b.currentTarget),d=c.data("item-id"),e=this.sort_num,f=this.page,g=this.active_tab;this.content_close(),a.history.navigate("list/detail_weapon/"+e+"/"+f+"/"+d+"/"+g,!0)},selectSummon:function(b){var c=$(b.currentTarget),d=c.data("item-id"),e=this.sort_num,f=this.page,g=this.active_tab;this.content_close(),a.history.navigate("list/detail_summon/"+e+"/"+f+"/"+d+"/"+g,!0)},selectNpc:function(b){var c=$(b.currentTarget),d=c.data("item-id"),e=this.sort_num,f=this.page,g=this.active_tab;this.content_close(),a.history.navigate("list/detail_npc/"+e+"/"+f+"/"+d+"/"+g,!0)},selectSkinCharacter:function(a){var b,c=this,d=$(a.currentTarget),e=+d.data("index"),f=this.listItemParams.item[e],g=_.map(f.list_data,function(a){return{thumbnail:(a.master.is_job_skin?"leader/m/":"npc/m/")+a.master.image_id,itemId:a.param.id,charaId:f.id}});this.currentCharaSkinList=f.list_data,this.popView=new o({className:"skin-list-pop-up",title:f.name,body:_.template($("#tpl-pop-skin-list").html(),{skinList:g}),flagBtnClose:1,flagBtnOk:0}),this.popView.render().popShow(),this.repopSelectSkinCharacter=function(a){return function(){c.popRemove(),c.selectSkinCharacter(a)}}(_.clone(a)),g.length<=12||(b=this.popView.$el.find(".prt-skin-wrapper .lis-skin-slider"),this.popView.$el.find(".prt-skin-image").flexslider({selector:".prt-skin-wrapper > .lis-skin-slider",animation:"slide",animationLoop:!1,slideshow:!1,prevText:"",nextText:""}))},repopSelectSkinCharacter:function(){this.repopSelectSkinCharacter()},selectSkin:function(a){var b,c,d=$(a.currentTarget),e=d.data("item-id"),f=this.getSkinData(e);b=f.master.is_job_skin?"leader/skin/":"npc/skin/",c=new o({className:"skin-pop-up",title:f.master.name,body:_.template($("#tpl-pop-skin").html(),{obj:{image:b+f.master.image_id,flavorText:f.master.comment}}),flagBtnClose:1,flagBtnOk:0}),c.render().popShow()},getSkinData:function(a){return _.find(this.currentCharaSkinList,function(b){return+b.param.id===a})},popItemShow:function(){var a=this.$el.find(".pop-detail");item=this.selected_model.toJSON(),a.empty(),this.template=_.template($("#pop-"+this.selected_item).html()),a.html(this.template(item)),$(".mask").show(),a.show().removeClass("pop-hide").addClass("pop-show")},popDetailImage:function(){var a={imgDir:this.selected_item,imgId:this.selected_model.attributes.master.id};this.popView=new o({className:"image-up",title:this.selected_model.attributes.master.name,body:_.template($("#pop-image-up").html(),a),flagBtnCancel:0,flagBtnOk:0}),this.popView.render();var b=this;$(".img-list-up").one("load",this.$el,function(){b.popView.popShow()}),$(".mask").css("z-index","100100")},locationEnhance:function(){this.content_close(),a.history.navigate("enhancement",!0)},locationItem:function(){this.content_close(),a.history.navigate("item",!0)},locationCostume:function(){this.content_close(),a.history.navigate("party",!0)},popCustomFilter:function(a){this.sortSettingSubView.setSortFilterData("list",this.selected_item,this.sortFilterData),this.sortSettingSubView.popCustomFilter(a)},startSortSetting:function(a){this.sortSettingSubView.setSortFilterData("list",this.selected_item,this.sortFilterData),this.sortSettingSubView.popSortChange(a)},completeSortSetting:function(a,b,c){this.sortFilterData={sort:b,filter:c},this.page=1,this.setListModel(this.sortFilterData)},popContainerList:function(){var a,b;return this.container_list_model[this.selected_item]?(a=this.container_list_model[this.selected_item].attributes,a.list?(b=this.$el.find(".prt-4tabs .active").html(),this.popView=new o({className:"pop-container-list line-up",title:s.getMessage("listall_6"),body:_.template($("#tpl-pop-container").html(),_.extend(a,{name:b.toLowerCase()})),flagBtnCancel:1,flagBtnOk:0}),void this.popView.render().popShow()):void this.popContainerEmpty()):(this.container_list_model[this.selected_item]=new(c.extend({urlRoot:Game.baseUri+"container/containers/"+this.selected_item})),this.listenToOnce(this.container_list_model[this.selected_item],"sync",this.popContainerList),void this.container_list_model[this.selected_item].fetch())},popContainerEmpty:function(){this.popView=new o({className:"pop-move-container-empty",title:s.getMessage("listall_13"),body:$("#tpl-no-container").html(),flagBtnOk:1,flagBtnCancel:1}),this.popView.render().popShow()},locationShop:function(){this.content_close(),a.history.navigate("shop",!0)},popRemove:function(){this.popView.popRemove()},selectContainer:function(b){var c=$(b.currentTarget).attr("c_id"),d=this.container_list_model[this.selected_item].attributes.list[c];d.number!=d.max?(this.content_close(),a.history.navigate("list/move/"+this.selected_item+"/"+c,!0)):(this.popView=new o({className:"pop-container-over",title:s.getMessage("listall_6"),body:s.getMessage("listall_7"),flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow())},pagination:function(a){this.trigger("xhrStart"),this.page=$(a.currentTarget).attr("page"),this.setListModel(),this.stopEventPropagation(a,!0),this.updateHash()},location_href:function(b){var c=$(b.currentTarget).data("location-href");this.content_close(),a.history.navigate(c,!0)},popShowSkinTips:function(a){var b=new t({el:"#pop-help-main",className:"pop-help-main-tutorial",list:["tutorial/help/19.png"]});b.on("pushclose",function(){this.popRemove()}),b.render(),b.popShow(),a&&this.stopEventPropagation(a,!0)},setNextStatusInfo:function(a){this.toggleListStatus(a,this.listItemParams.item)},popListTidy:function(a){var b=$(a.currentTarget).hasClass("weapon")?s.getMessage("list_tidy_1"):s.getMessage("list_tidy_2");this.popView=new o({className:"pop-list-tidy",title:b,body:_.template($("#tpl-pop-list-tidy").html(),{type:this.selected_item}),flagBtnClose:1,flagBtnOk:0}),this.popView.render().popShow()},popUnloadRusted:function(){this.popView.popDelete(),this.bundleRustedWeaponSubView.popUnloadRusted()},updateHash:function(){var a="list/"+this.sort_num+"/"+this.page+"/0/"+this.active_tab;q.hash(a,{refresh:!1,trigger:!1})}});return w});