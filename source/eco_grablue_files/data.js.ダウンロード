define(["underscore","backbone","util/ajax","lib/shellapp","util/local-storage","util/language-message","lib/mobage-jssdk"],function(a,b,c,d,e,f,g){var h=[],i=!1,j=b.Model.extend({initialize:function(){this.listenTo(this,"error",this.error),this.error=this.getErrorStorageValue()},parse:function(c){function e(a){i=!1;var c=new(b.Model.extend({urlRoot:Game.baseUri+"authentication/greejs"}));c.set({id_token:a.id_token}),c.save(null,{success:function(){window.location.reload()},error:function(){location.href=Game.baseUri+"#error"}})}function j(a,b){a&&e(a,b),b&&window.location.reload()}if(c){var k=c.local_notification;d.isShellApp()&&!a.isEmpty(k)&&d.setLocalNotification(k);var l=c.redirect;l&&a.isString(l)&&(Game.view.stopListening(this),0===c.redirect.indexOf("#")?window.location.hash=l.slice(1):window.location.href=l,c.refresh&&window.location.reload());var m=c.auth_status,n=window.clientData;if("require_auth"===m)if(Game.ua.isMbga()){if(n&&n.state){var o=a.clone(n.state);h.push(c),g.mobageGetConnectedStatus({state:o}).done(function(b){var d=b;n.state=c.state,d.response.state=n.state,g.login(n,d,function(){h.shift(),a.isEmpty(h)&&window.location.reload()})}).fail(function(a){window.location.reload()})}}else if(Game.ua.isGreeLogin())i||(i=!0,GREE.oauth.getConnectedStatus(j));else if(Game.ua.isDMM()){if(!i){i=!0;var p=new(b.Model.extend({urlRoot:Game.baseUri+"authentication/dmm_already_logged_game_login"}));p.save(null,{success:function(){window.location.reload()},error:function(){location.href=Game.baseUri+"#error"}})}}else window.location.hash="#top";a.isUndefined(Game.treasure)===!1&&a.isUndefined(c.display_list)===!1&&Game.treasure.updateList(c.display_list);var q=c.popup;if(!a.isEmpty(q))return Game.view.trigger("loadEnd"),Game.view.trigger("popup_error",{data:q}),Game.view.stopListening(this),this.off(),{errorPopFlag:!0};var r=c.option;if(r){var s=r.iframes;if(!a.isEmpty(s)){var t=$("body");a.each(s,function(a){t.append(a)})}var u=r.analytics_conversions;a.isEmpty(u)||d.isShellApp()&&a.each(u,function(a){d.sendAnalyticsLtv(a.cvpoint,a.buid,a.params)})}r&&!a.isEmpty(r.langMsg)&&(r.submenu_view?require(["util/language-message-submenu"],function(a){a.setMessage(r.langMsg)}):f.setMessage(r.langMsg))}return c},error:function(b,d,f){if(!c.isManuallyAbortedXHR(d)&&(404===d.status&&null===d.getResponseHeader("Content-Length")&&(d.status=0),409!=d.status&&410!=d.status)){var g=("0000"+a.random(1,99999)).slice(-5),h="[DataModel] response status "+d.status,i=0===d.status?"F":"B";f.ignoreError?Game.reportError(h,b.url()||f.url):0===this.error&&e.isSupported()?(Game.reportError(h+this.getXHRErrorMsg(i,"POPUP",g),b.url()||f.url),Game.view.trigger("data_error",[d.status,g]),this.setErrorStorageValue(1)):(Game.reportError(h+this.getXHRErrorMsg(i,"PAGE",g),b.url()||f.url),Game.view.trigger("page_error"),this.removeErrorStorageValue())}},sync:function(a,c,d){return d=d||{},d.cache=d.cache||!1,b.Model.prototype.sync.apply(this,arguments)},setErrorStorageValue:function(a){var b=this.getStorageKey();e.set("model_error_hash",b),e.set(b,a)},getErrorStorageValue:function(){return e.get(this.getStorageKey())||0},removeErrorStorageValue:function(){e.remove("model_error_hash"),e.remove(this.getStorageKey())},getStorageKey:function(){return location.hash+"_model_error"},getXHRErrorMsg:function(a,b,c){return" error Type "+a+"-"+b+" random code "+c}});return j});