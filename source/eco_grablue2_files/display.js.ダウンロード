define(["underscore","model/sound","model/raid/setup","util/language-message"],function(a,b,c,d){var e=[],f=!1,g=!1,h=16,i=9999,j=999,k={ATTACK:0,BACK:1,TURN:2,AUTO:3,NEXT:4,CHAT_S:5,STAMP_S:6},l={HP:0,TOGGLE:1},m={KEEP:0,ATTACK_LOCKED:1,ATTACK_UNLOCKED:2,HP_LOCKED:3,HP_UNLOCKED:4,FORCE_HP_UNLOCKED:5},n="l",o="mask-black-size-l",p=[],q=2050,r=0,s={reqStartTime:0,$viewContents:$("#wrapper").find(".contents"),enableChangeCoating:[m.KEEP,m.KEEP,m.KEEP,m.KEEP],hasCoatingInterval:!1,originalPosLsizePlayer:null,logTimeoutId:null,hideHudFlag:!1,mBossSetup:function(a,b,c){c.size=c.size?c.size:"s",c.force=c.force?c.force:!1;var d=b.length-1;if(c.force)for(var e=0;d>=e;e++)1==b[e].alive&&(c.force=!1);s.$viewContents.find(".prt-targeting-area").attr({type:stage.pJsnData.boss.type+stage.pJsnData.boss.number});for(var e=0;d>=e;e++)(1==b[e].alive||c.force)&&(s.$viewContents.find(".lis-enemy").eq(e).addClass("enemy-"+stage.pJsnData.boss.type),a.call(function(a,b,c){if("s"===c.size||"m"===c.size){var d=a+1,e=s.$viewContents.find(".enemy-"+d);s.$viewContents.find(".prt-enemy-area.enemy-"+d).addClass("enemy-"+c.size).css({top:stage.gAryCntnBoss[a].y/2+"px",left:stage.gAryCntnBoss[a].x/2+"px"}),1==b[a].alive||c.force?e.show():e.css("display","none")}else"l"===c.size&&(s.$viewContents.find(".prt-enemy-area").css("display","none"),s.$viewContents.find(".prt-boss-area").show().css({top:stage.gAryCntnBoss[a].y/2+"px",left:stage.gAryCntnBoss[a].x/2+"px"}))},[e,b,c]))},mPlayerGaugeHp:function(a,b){a.call(function(a,b){s.mPlayerGaugeHpForLog(b)},[a,b])},mPlayerGaugeHpForLog:function(a){var b=Number(a.pos),c=Math.ceil(a.param.hp/a.param.hpmax*100),d=25>=c?"red":"green",e=s.$viewContents.find(".prt-command-top").find(".lis-character"+b).find(".prt-gauge-hp-inner"),f=s.$viewContents.find(".prt-command-chara").find(".lis-character"+b).find(".prt-gauge-hp-inner"),g=s.$viewContents.find(".prt-command").find(".lis-character"+b).find(".txt-hp-value");e.css("width",c+"%").attr({color:d}),f.css("width",c+"%").attr({color:d}),g.attr({color:d}),clearInterval(stage.gAryInterval[b]);var h=stage.gGameStatus.player.param[b].hp,i=a.param.hp;h==i?s.$viewContents.find(".prt-command .lis-character"+b+" .txt-hp-value").html(""+h):(this.changeCoatingDisplay(l.HP,b,m.HP_LOCKED,!1),stage.gAryInterval[b]=setInterval(s.mPlayerHpRenew,1e3/24,b,h,i)),stage.gGameStatus.player.param[b].hp=i,stage.pJsnData.player.param[stage.pJsnData.formation[b]].hp=i,+stage.gGameStatus.player.param[b].hpmax!==+a.param.hpmax&&(stage.gGameStatus.player.param[b].hpmax=a.param.hpmax,stage.pJsnData.player.param[stage.pJsnData.formation[b]].hpmax=a.param.hpmax)},mPlayerHpRenew:function(a,b,c){var d=s.$viewContents.find(".prt-command").find(".lis-character"+a).find(".txt-hp-value"),e=b>c?-1:1,f=Math.abs(parseInt((b-c)/12));1>=f&&(f=1);var g=parseInt(d.html(),10)+e*f;(-1==e&&c>=g||1==e&&g>=c)&&(g=c),d.html(""+g),(-1==e&&c>=g||1==e&&g>=c)&&(s.changeCoatingDisplay(l.TOGGLE,a,m.HP_UNLOCKED,!1),clearInterval(stage.gAryInterval[a]))},mPlayerGaugeRecast:function(a,b){a.call(function(a,b){s.mPlayerGaugeRecastForLog(b)},[a,b])},mPlayerGaugeRecastForLog:function(a){var b=s.$viewContents.find(".prt-command").find(".prt-gauge-special.character"+a.pos),c=b.find(".prt-gauge-special2-inner"),d=b.find(".prt-shine2"),e=parseInt(a.param.recast);if(b.find(".prt-gauge-special-inner").css("width",e+"%"),e>100){var f=e-100;c.css("width",f+"%"),e>=200?d.show():d.css("display","none")}else c.css("width","0%"),d.css("display","none");s.$viewContents.find(".prt-command").find(".lis-character"+a.pos).find(".prt-percent").find(".txt-gauge-value").html(""+e),stage.gGameStatus.player.param[a.pos].recast=a.param.recast,stage.pJsnData.player.param[stage.pJsnData.formation[a.pos]].recast=a.param.recast;var g=s.$viewContents.find(".prt-command-top").find(".lis-character"+a.pos);100>e&&g.find(".prt-shine").css("display","none")},mPlayerGaugeAttr:function(a,b){a.call(function(a,b){var c=Number(b.pos),d=s.$viewContents.find(".lis-character"+c).find(".ico-type");d.removeClass().addClass("ico-type"),b.param.attr>0&&d.addClass("ico-attribute-"+b.param.attr)},[a,b])},mBossGaugeHp:function(a,b,c,d){a.call(function(a,b,c){s.mBossGaugeHpForLog(a,b,c)},[b,c,d])},mBossGaugeHpForLog:function(a,b,c){var d=Number(c.pos),e=c.param.isConcurrentLastAttack||!1;a[d].hp.change(c.param.hp,c.param.hpmax,e,d),stage.gGameStatus.boss.param[d].hp=c.param.hp,stage.pJsnData.boss.param[d].hp=c.param.hp},mBossGaugeRecast:function(a,b,c,d){a.call(function(a,b,c){s.mBossGaugeRecastForLog(a,b,c)},[b,c,d])},mBossGaugeRecastForLog:function(a,b,c){var d=Number(c.pos);a[d].recast.colorRecast(c.param.recast,c.param.recastmax),stage.gGameStatus.boss.param[d].recast=c.param.recast,stage.pJsnData.boss.param[d].recast=c.param.recast},mBossGaugeName:function(a,b,c){a.call(function(a,b){var c=parseInt(b.pos)+1,d=s.$viewContents.find(".enemy-"+c),e=1===+b.param.no_attribute_flag?"98":b.param.attr;d.find(".name").html(b.param.name[Game.lang]),d.find(".attribute").removeClass().addClass("attribute ico-attribute-"+e),"1"==b.param.rare_flag&&d.find(".ico-rm").show()},[b,c])},mHideBossGauge:function(b){a.each(b,function(a){a.hide()}),s.$viewContents.find(".prt-enemy-gauge").find(".lis-enemy").css("display","none"),s.$viewContents.find(".prt-enemy-stage").find(".prt-target").css("display","none")},mShowBossGauge:function(b){stage.gGameStatus.isShowBossGauge&&(a.each(b,function(a){a.show()}),s.$viewContents.find(".prt-enemy-gauge").find(".lis-enemy").css("display","block"),s.$viewContents.find(".prt-enemy-stage").find(".prt-target").css("display","block"))},mConditionPlayer:function(b,c){var d=s.$viewContents.find(".prt-command-chara.chara"+(+c+1)),e=s.$viewContents.find(".prt-command-top").find(".lis-character"+c).find(".prt-status"),f=d.find(".lis-character"+c).find(".prt-status"),g=d.find(".prt-condition");this.updateCoatingDisplay(b.coating_value||0,c),e.css("display","none"),f.css("display","none"),g.css("display","none");var h=[];a.each(b.buff,function(a){h.push(a.status)}),h.reverse();var i=[];a.each(b.debuff,function(a){i.push(a.status)}),i.reverse();var j=h.concat(i);j=a.union(j),e.children().each(function(a,b){b.src=""}).remove(),f.children().each(function(a,b){b.src=""}).remove(),g.children().each(function(a,b){b.src=""}).remove();var k=[],l=[],m=[];a.each(j,function(a){k.push('<img class="img-ico-status-s" src="'+Game.imgUri+"/sp/ui/icon/status/x64/status_"+a+'.png" data-status="'+a+'">'),l.push('<img class="img-ico-status-s" src="'+Game.imgUri+"/sp/ui/icon/status/x64/status_"+a+'.png" data-status="'+a+'">'),m.push('<img class="img-ico-status-m" src="'+Game.imgUri+"/sp/ui/icon/status/x64/status_"+a+'.png" data-status="'+a+'">')}),a.isEmpty(k)||e.append(k.join("")),a.isEmpty(l)||f.append(l.join("")),a.isEmpty(m)||g.append(m.join(""));var n=e.find(".img-ico-status-s").length-4*Math.floor(e.find(".img-ico-status-s").length/4);n>0&&(e.find(".img-ico-status-s").eq(n).before("<br>"),f.find(".img-ico-status-s").eq(n).before("<br>")),e.show(),f.show(),g.show()},mSetIntervalPlayerConditions:function(a){var b=this,c=s.$viewContents.find(".prt-command-chara.chara"+a).find(".prt-condition"),d=c.find(".img-ico-status-m");clearInterval(stage.gGameStatus.timer.playerCondition),d.length>=8?(this.playerConditionGroupNum=1,stage.gGameStatus.timer.playerCondition=setInterval(function(){var a=c.find(".img-ico-status-m"),d=a.length;if(8>d)return clearInterval(stage.gGameStatus.timer.playerCondition),void a.show();b.playerConditionGroupNum++,Math.ceil(d/7)<b.playerConditionGroupNum&&(b.playerConditionGroupNum=1);var e=7*(b.playerConditionGroupNum-1),f=e+7;a.css("display","none").slice(e,f).show()},1500)):d.show()},mConditionBoss:function(b){a.each(b,function(a){a.condition.show(),a.condition.blinkCondition()})},updateCoatingDisplay:function(a,b){var c=l.HP,d=s.$viewContents.find(".prt-command").find(".lis-character"+b).find(".txt-coating-value");+a>0?(d.text(a),c=l.TOGGLE):d.text(0),this.changeCoatingDisplay(c,+b,m.KEEP,!1)},changeCoatingDisplay:function(b,c,d,e){var f=stage.gGameStatus,g=f.player.param[c];if(d===m.FORCE_HP_UNLOCKED&&this.enableChangeCoating[c]===m.HP_LOCKED&&(d=m.HP_UNLOCKED),!(e===!1&&1!==+f.is_show_coating_value||this.enableChangeCoating[c]===m.ATTACK_LOCKED&&d!==m.ATTACK_UNLOCKED||this.enableChangeCoating[c]===m.HP_LOCKED&&d!==m.HP_UNLOCKED&&d!==m.ATTACK_LOCKED||a.isUndefined(g)===!0)){var h=this,i={SHOW:"show",HIDE:"hide",TOGGLE:"toggle"},j=2e3,k=s.$viewContents.find(".prt-command"),n=k.find(".lis-character"+c),o=n.find(".txt-coating-value"),p=n.find(".txt-hp-value"),q=g.condition.coating_value||0;switch(d!==m.KEEP&&(this.enableChangeCoating[c]=d),(1!==+g.alive||0===+q)&&(b=l.HP),+b){case l.HP:o.removeClass(i.SHOW+" "+i.TOGGLE),p.removeClass(i.HIDE+" "+i.TOGGLE);break;case l.TOGGLE:o.addClass(i.SHOW+" "+i.TOGGLE),p.addClass(i.HIDE+" "+i.TOGGLE)}if(this.hasCoatingInterval===!1||!stage.gGameStatus.timer.updateCoating){this.hasCoatingInterval=!0;var r=1;stage.gGameStatus.timer.updateCoating=setInterval(function(){var a=k.find(".txt-coating-value."+i.TOGGLE),b=k.find(".txt-hp-value."+i.TOGGLE);return 0===a.length?(clearInterval(stage.gGameStatus.timer.updateCoating),o.removeClass(i.SHOW),p.removeClass(i.HIDE),void(h.hasCoatingInterval=!1)):(r%2===0?(a.addClass(i.SHOW),b.addClass(i.HIDE)):(a.removeClass(i.SHOW),b.removeClass(i.HIDE)),void r++)},j)}}},mConditionField:function(a){if(!stage.gGameStatus.finish||stage.gGameStatus.lose){stage.gFieldCondition.setCondition(a),stage.gGameStatus.field.hasFieldEffect=f=!0,this.mCheckFieldNum();var b=$("#prt-field-conditions");b.hasClass("show")||b.addClass("show")}},mRemoveConditionField:function(){stage.gFieldCondition.removeCondition(),stage.gGameStatus.field.hasFieldEffect=f=!1,$("#prt-field-conditions").removeClass("show")},mCheckFieldNum:function(){var a=$("#prt-field-conditions"),b=stage.gGameStatus.field.tmpFieldNum,c=2,d=3,e=16,f=16,g=32;if(b>2){var h=a.hasClass("position3")===!0?d:c,i=a.hasClass("position3")===!0?g:f,j=Math.floor(b/h);a.css("height",i+j*e+"px")}else a.css("height","")},changeFieldConditionPosition:function(a,b){function c(){var b=+a+1;stage.gFieldCondition.initialize(b),f.removeClass("position1 position2 position3").addClass("position"+b),d&&(stage.gFieldCondition.addConditionIcons(),f.addClass("show"))}if(!(0>+a||+a>2)){var d=0!==stage.gFieldCondition.getNumChildren(),e=400,f=$("#prt-field-conditions");f.removeClass("show");var g=d?b||!1:!0;g?c():createjs.Tween.get(stage.gFieldCondition).to({alpha:0},e,createjs.Ease.cubicIn).call(function(){c(),createjs.Tween.get(stage.gFieldCondition).to({alpha:1},e,createjs.Ease.cubicOut)})}},mConditionAssistUnit:function(b){stage.gAssistUnitCondition.setCondition(b),stage.gGameStatus.defend_order.hasAssistUnitEffect=g=!0;var c=$("#prt-assist-unit-conditions");c.hasClass("show")||c.addClass("show");var d=a.size(b)*h;c.css("width",d+"px")},mRemoveConditionAssistUnit:function(){stage.gAssistUnitCondition.removeCondition(),stage.gGameStatus.defend_order.hasAssistUnitEffect=g=!1,$("#prt-assist-unit-conditions").removeClass("show")},mSummonStart:function(b,c){var d=this;b.call(function(){s.$viewContents.find(".prt-enemy-stage").find('div[class^="prt-target"]').css("display","none"),s.$viewContents.find(".prt-enemy-gauge").css("display","none"),s.$viewContents.find(".btn-enemy-gauge.prt-enemy-percent.alive").css("display","none"),a.each(c,function(a,b){a.hide()}),stage.gAryCntnParts[2].visible=!1,f&&(stage.gFieldCondition.hide(),$("#prt-field-conditions").removeClass("show")),g&&(stage.gAssistUnitCondition.hide(),$("#prt-assist-unit-conditions").removeClass("show")),d.mHideSpecialSkipTapArea()})},mSummonEnd:function(b,c){var d=this;b.call(function(){stage.gGameStatus.isShowBossGauge&&(s.$viewContents.find(".prt-enemy-stage").find('div[class^="prt-target"]').show(),s.$viewContents.find(".prt-enemy-gauge").show(),s.$viewContents.find(".btn-enemy-gauge.prt-enemy-percent.alive").css("display","block"),a.each(c,function(a,b){a.show()}),f&&(stage.gFieldCondition.show(),$("#prt-field-conditions").addClass("show")),g&&(stage.gAssistUnitCondition.show(),$("#prt-assist-unit-conditions").addClass("show")),d.mShowSpecialSkipTapArea())})},mSuperWindowEffectStart:function(b,c){var d=this;b.call(function(){s.$viewContents.find(".prt-enemy-stage").find('div[class^="prt-target"]').css("display","none"),s.$viewContents.find(".prt-enemy-gauge").css("display","none"),s.$viewContents.find(".btn-enemy-gauge.prt-enemy-percent.alive").css("display","none"),a.each(c,function(a,b){a.hide()}),stage.gGameStatus.diagram&&s.$viewContents.find(".img-diagram").removeClass("display-on").addClass("display-off"),d.mHideSpecialSkipTapArea()})},mSuperWindowEffectEnd:function(b,c){var d=this;b.call(function(){stage.gGameStatus.isShowBossGauge&&(s.$viewContents.find(".prt-enemy-stage").find('div[class^="prt-target"]').css("display","block"),s.$viewContents.find(".prt-enemy-gauge").css("display","block"),s.$viewContents.find(".btn-enemy-gauge.prt-enemy-percent.alive").css("display","block"),a.each(c,function(a,b){a.show()})),!stage.gGameStatus.diagram||stage.gGameStatus.auto_attack||"top"!==stage.gGameStatus.menu||stage.gGameStatus.attackQueue.attackButtonPushed||s.$viewContents.find(".img-diagram").removeClass("display-off").addClass("display-on"),d.mShowSpecialSkipTapArea()})},mFellowTimer:function(b,c,d){b.call(function(b,c){var d=!1,e=!1,f=!0,g=setInterval(function(){if(stage.gGameStatus.timer.mFellowTimer=g,f&&(stage.pJsnData.timer+=s.reqStartTime-parseInt(new Date/1e3),f=!1),stage.pJsnData.timer<=0&&(e||d&&!(0>=d)||1==stage.gGameStatus.attacking?d&&d--:(e=!0,s._mGetRemain(function(a){e=!1,a.timer<=0?(clearInterval(g),c&&c()):d=a.timer}))),stage.pJsnData.timer>=0&&!f){if(!stage.pJsnData.is_sequence&&!stage.pJsnData.is_ascendant&&(stage.pJsnData.fellow||0==stage.pJsnData.fellow)){var b=s.$viewContents.find(".prt-total-human").find(".prt-human-value").find(".txt-info-num");if(b.css("display","block"),stage.pJsnData.fellow!==stage.pJsnData.previousFellow){var h=stage.pJsnData.fellow.toString().split(""),i=b.find(".current");i.removeClass(function(a,b){return(b.match(/num-info\d+/g)||[]).join(" ")}),h.reverse();var j=i.size();a.each(h,function(a,b){$(i[j-1-b]).addClass("num-info"+a)}),stage.pJsnData.previousFellow=stage.pJsnData.fellow}if(stage.pJsnData.limit_number!==stage.pJsnData.previousLimit){var k=stage.pJsnData.limit_number.toString().split(""),l=b.find(".max");l.removeClass(function(a,b){return(b.match(/num-info\d+/g)||[]).join(" ")}),k.reverse();var m=l.size();a.each(k,function(a,b){$(l[m-1-b]).addClass("num-info"+a)}),stage.pJsnData.previousLimit=stage.pJsnData.limit_number}}if(stage.pJsnData.timer||0==stage.pJsnData.timer){var n=s.$viewContents.find(".prt-remain-time").find(".prt-clocl-value").find(".txt-info-num");n.css("display","block");var o=parseInt(stage.pJsnData.timer/3600);o=10>o?"0"+o:o.toString();var p=o.split(""),q=n.find(".hour");q.removeClass(function(a,b){return(b.match(/num-info\d+/g)||[]).join(" ")}),p.reverse();var r=q.size();a.each(p,function(a,b){$(q[r-1-b]).addClass("num-info"+a)});var t=parseInt((stage.pJsnData.timer-3600*o)/60);t=10>t?"0"+t:t.toString();var u=t.split(""),v=n.find(".minute");v.removeClass(function(a,b){return(b.match(/num-info\d+/g)||[]).join(" ")}),u.reverse();var w=v.size();a.each(u,function(a,b){$(v[w-1-b]).addClass("num-info"+a)}),stage.pJsnData.timer--}}stage.gGameStatus.logtimer>0&&stage.gGameStatus.logtimer--},stage.gGameParam.interval.raidstate)},[c,d])},_mGetRemain:function(a){var b=new c,d={raid_id:stage.pJsnData.raid_id};b.save(d,{url:b.urlRoot("remain_time","",stage.pJsnData.is_multi,stage.pJsnData.is_semi),silent:!0,error:function(){},success:function(){a&&a(b.toJSON())}})},mBalloon:function(b){b.call(function(){if(a.isEmpty(stage.gGameParam)!==!0){var b=stage.gGameParam.interval.balloon,c="";stage.gGameStatus.timer.mBalloon&&clearInterval(stage.gGameStatus.timer.mBalloon),stage.gGameStatus.timer.mBalloon=setInterval(function(){var b=null,d=null,e=null;if("wait"===stage.gGameStatus.balloon){var f=[],g=[];if(a.each(stage.pJsnData.balloon.boss,function(a){a.serif&&(f[a.pos]={type:"boss",pos:a.pos,serif:a.serif},g.push(a.pos))}),g.length>0){var h=g.length>1&&"undefined"!=typeof c?a.without(g,c):[g[0]],i=parseInt(Math.random()*h.length);c=h[i],b=f[h[i]].type,d=f[h[i]].pos,e=f[h[i]].serif}if(e){var j=null;if("boss"===b){var b="l"===stage.pJsnData.boss.type?".prt-boss-area":".prt-enemy-area.enemy-"+(d+1)+".enemy-"+stage.pJsnData.boss.type;j=s.$viewContents.find(b).find(".prt-comment"),j.find(".txt-comment").html(e),j.show().addClass("anim-baloon pos-wait").on("animationend webkitAnimationEnd",function(){$(this).removeClass("anim-baloon pos-wait").css("display","none")})}}}},b)}})},mDisplayStrip:function(a,b){a.call(function(a){var b=s.$viewContents.find(".prt-command-top").find(".lis-character"+a.pos);"on"===a.mode?b.removeClass("mask-shine mask-black-fade").addClass("attack").find("prt-shine").css("display","none"):"off"===a.mode&&b.removeClass("attack").addClass("mask-black")},[b])},mUpdateTemporaryItem:function(){var a=s.$viewContents.find(".prt-select-item").find(".prt-item-info").find(".lis-item"),b=s.$viewContents.find(".prt-temporary"),c=s.$viewContents.find(".prt-item-small"),d=s.$viewContents.find(".prt-item-large"),e=s.$viewContents.find(".ico-temporary"),f=stage.gGameStatus.temporary.small,g=0;f>0&&(g=f-1);var h=a.eq(0);h.find('span[class^="having-num"]').html(""+f),h.find('span[class^="after-num"]').html(""+g),b.find(".img-item-small").html(""+f),c.find(".having-num").html(""+f),c.find(".after-num").html(""+g);var i=stage.gGameStatus.temporary.large,g=0;i>0&&(g=i-1);var j=a.eq(1);j.find('span[class^="having-num"]').html(""+i),j.find('span[class^="after-num"]').html(""+g),b.find(".img-item-large").html(""+i),d.find(".having-num").html(""+i),d.find(".after-num").html(""+g),0==f&&0==i?e.addClass("off"):e.removeClass("off")},mPlayerBannerList:function(b){stage.gGameStatus.chara_select=2,s.$viewContents.find(".prt-command").css({"z-index":"999999"}),s.$viewContents.find(".prt-summon-list>div").addClass("mask-black");var c,e=!1,f="undefined"==typeof b?"hp":b.type,g=s.$viewContents.find(".prt-command-top"),h=s.$viewContents.find(".txt-select-chara");if(s.$viewContents.find(".btn-command-character").removeClass("mask-black mask-black-fade"),"hp"===f)for(var i=0,j=stage.pJsnData.formation.length;j>i;i++){var k=stage.pJsnData.formation[i];c=g.find(".lis-character"+i),1!=stage.pJsnData.player.param[k].alive||stage.pJsnData.player.param[k].hp>=stage.pJsnData.player.param[k].hpmax?c.addClass("mask-black"):e=!0}else if("condition"===f)for(var i=0,j=stage.pJsnData.formation.length;j>i;i++)if(c=g.find(".lis-character"+i),0!=stage.gGameStatus.player.param[i].alive)if(null==stage.gGameStatus.player.param[i].condition.debuff||null!=stage.gGameStatus.player.param[i].condition.debuff&&0==stage.gGameStatus.player.param[i].condition.debuff.length)c.addClass("mask-black");else{var l=!1;a.each(stage.gGameStatus.player.param[i].condition.debuff,function(a){(null==a.is_unusable_harb||0==a.is_unusable_harb)&&(e=!0,l=!0)}),0==l&&c.addClass("mask-black")}e?h.html(d.getMessage("raid_74")):h.html(d.getMessage("raid_14"))},mSetAbility:function(b,c){var d=c+1,f=s.$viewContents.find(".prt-command-chara.chara"+d).find(".prt-ability-list"),g=s.$viewContents.find(".prt-command").find(".lis-character"+c).find(".prt-ability-state"),h=s.$viewContents.find(".pop-usual:visible");if(h.find(".prt-ability-state").length&&(g=g.add(h.find(".lis-character"+stage.pJsnData.ability[d].pos).find(".prt-ability-state"))),0===f.children().length){var j=$("#ability-list").html();f.html(a.template(j,{num:d}))}var k=f.find(".lis-ability");k.find(".is-emphasis").removeClass("is-emphasis");var l=b.list;k.each(function(b){var f=$(this),h=b+1,j=["ability-character-num",d,h].join("-"),k=["ability-icon-num",d,h].join("-"),m=l[h],n=g.find(".ability"+h);if(null!=m||"0"!==n.attr("state")){var o=f.find("."+j),p=f.find(".ico-ability-shine"),q=f.find(".prt-start-recast"),r=f.find("."+k),s=!1,t=!1;if(q.removeClass().addClass("prt-start-recast"),f.removeClass("used-start-recast-ability"),null==m)a.each(e,function(a){o.removeAttr(a).empty()}),o.removeClass().addClass("ico-ability").addClass(j),r.removeAttr("value").removeClass().addClass(k),p.removeClass().addClass("ico-ability-shine"),f.removeClass("btn-ability-available btn-ability-unavailable ability-disable"),n.removeAttr("type").attr({state:"0"});else{var u=m[0],v=m[1],w=stage.gGameStatus.player.param[c];if(s=a.isUndefined(u["recaset-default"])===!1&&+u["recaset-default"]!==i&&a.isUndefined(u.start_skill_set_recast)===!1&&u.start_skill_set_recast>0,t=a.isUndefined(u["recaset-default"])===!1&&+u["recaset-default"]===i&&a.isUndefined(u.start_skill_set_recast)===!1&&u.start_skill_set_recast>0,0===e.length&&(e=a.keys(u)),o.attr(u),!a.isUndefined(u["class"])){var x=u["class"].split(" ")[0].replace("ico-ability",""),y=Game.imgUri+"/sp/ui/icon/ability/m/"+x+".png",z='<img class="img-ability-icon" src="'+y+'">';o.html(z)}if(s===!1?(r.attr(v),t===!0&&f.addClass("used-start-recast-ability")):(a.isUndefined(w.condition.ability_available_list)===!0||w.condition.ability_available_list[b+1]===!0)&&(r.removeAttr("value").removeClass().addClass(k),q.addClass("start-recast-"+u.start_skill_set_recast)),null==u["ability-id"])return;var A=u["ability-recast"],B=u["icon-type"];p.removeClass().addClass("shine"+A).addClass("ico-ability-shine"),0==A?(f.removeClass("btn-ability-unavailable").addClass("btn-ability-available"),n.attr({state:"2",type:B}),u.emphasis&&o.addClass("is-emphasis")):(f.removeClass("btn-ability-available").addClass("btn-ability-unavailable"),n.attr({state:"1",type:B}))}}})},mBalloonMessage:function(a,c){a.call(function(a){if(a.serif){if("boss"===a.to){var c=null,d="l"===stage.pJsnData.boss.type?".prt-boss-area":".prt-enemy-area.enemy-"+(a.pos+1)+".enemy-"+stage.pJsnData.boss.type;c=s.$viewContents.find(d).find(".prt-comment"),c.css("display","none").find(".txt-comment").html(a.serif),c.show().addClass("anim-baloon pos-wait").on("animationend webkitAnimationEnd",function(){$(this).removeClass("anim-baloon pos-wait").css("display","none")})}a.voice&&b.playVoice(a.voice)}},[c])},mLog:function(a){function b(){clearTimeout(c.logTimeoutId),c.logTimeoutId=null}var c=this,d=s.$viewContents.find(".prt-raid-log");d.removeClass("simple"),d.addClass(a["class"]),d.find(".txt-title").html(a.title),d.find(".txt-body").html(a.body),d.show(),this.logTimeoutId&&b();var e=2e3+(a.wait||0);this.logTimeoutId=setTimeout(function(){d.css({display:"none"}),b()},e)},mTurn:function(a){if(!(r>=a)){r=+a;for(var b=s.$viewContents.find(".prt-turn-info"),c=b.find(".prt-number").children(),d=a>j?j.toString():a.toString(),e=0,f=d.length;f>e;e++)c.eq(e).removeClass().addClass("num-turn"+d.substring(e,e+1)).show();b.addClass("anim-on").on("animationend webkitAnimationEnd",function(){$(this).removeClass("anim-on")})}},resetDisplayedTurn:function(){r=0},mContribution:function(a,b,c){a.call(function(a,b){createjs.Tween.get({},{useTicks:!0}).wait(c).call(function(){if(b.limit_flag){var a=d.getMessage("raid_75");stage.pJsnData.is_defendorder&&(a=d.getMessage("raid_do_2"));var c={"class":"log-ability",title:d.getMessage("raid_8"),body:d.replaceMessage("raid_77",[a,a])};s.mLog(c)}else{var e=Math.floor(b.amount),f=s.$viewContents.find(".prt-contribution");f.find(".prt-value").html("+"+e),stage.pJsnData.is_defendorder&&!f.hasClass("defend-order")&&f.addClass("defend-order"),f.show().one("animationend webkitAnimationEnd",function(){$(this).css("display","none")})}})},[a,b])},setQueueSequencePoint:function(a){p.push(a),1===p.length&&this.dequeueSequencePoint()},dequeueSequencePoint:function(){var a=this;p[0](),Game.view.setNamedTimeout("dequeueSequencePoint"+(new Date).getTime(),function(){p.shift(),p.length>0&&a.dequeueSequencePoint()},q)},showSequencePoint:function(b){var c="hideSequencePoint",d=2e3,e=$("#prt-sequence-point");b.point=Game.view.numberFormat(b.point),e.find(".prt-gain-point").html(a.template($("#tpl-prt-gain-point").html(),{data:b})),Game.view.clearTimeoutOne(c),e.addClass("show"),Game.view.setNamedTimeout(c,function(){e.removeClass("show")},d)},mBreakGauge:function(a,b,c){a.call(function(a,b,c){s.mBreakGaugeForLog(b,c)},[a,b,c])},mBreakGaugeForLog:function(a,b){"undefined"!=typeof a.mode&&a.mode.changeGauge(b.gauge)},mSlideIn:function(){var a=s.$viewContents.find(".prt-slide-mask"),b=s.$viewContents.find(".cnt-raid-stage");a.addClass("slide-in").show(),b.addClass("anim-slide-in").find(".prt-slide-mask").oneAnimationEnd(function(){b.removeClass("anim-slide-in"),a.removeClass("slide-in").css("display","none"),s.$viewContents.find(".prt-start-direction").css("display","none"),$("#opaque-mask").css("display","none")},500)},mSlideOut:function(){s.$viewContents.find(".prt-slide-mask").removeClass("slide-in").addClass("slide-out").show(),s.$viewContents.find(".cnt-raid-stage").addClass("anim-slide-out")},mBattleProgress:function(a,b){var c=$("#img-start-be"),d=s.$viewContents.find(".prt-start-direction"),e=d.find(".prt-progress");c.attr({src:Game.imgUri+"/sp/raid/be.png"}),c.load(function(){e.ready(function(){var c=parseInt(a.battle.total),f=parseInt(a.battle.count),g="";e.find(".now").addClass("num-battle"+f),e.find(".all").addClass("num-battle"+c);for(var h=1,i="";c>=h;h++)i=1==h?"boss":f>c-h+1?"clear":1==a.is_rare&&f==c-h+1?"rare":"normal",g+="<div class='lis-spot "+i+"'><div class='icon-spot'></div></div>";e.find(".prt-position").append(g);var j=181/(c-1),k=228-(f-2)*j;d.find(".prt-be").css({left:k+"px"}),e.css({display:"block"}),b(j)})})},mBattleReload:function(a,b){return this.mWindowEffect(a,b)},mWindowEffect:function(a,b){var c=new lib[b.kind],d=new createjs.Container,e=c[b.kind][b.kind+"_end"],f=e.timeline.duration;return a.call(function(){d.addChild(c),stage.gMasterContainer.addChild(d),c[b.kind].gotoAndPlay("end");var a=3e4,g=window.setTimeout(function(){stage&&stage.gMasterContainer&&stage.gMasterContainer.removeChild(d)},f*stage.gGameParam.spf+a),h=createjs.MovieClip.prototype.stop;e.stop=function(){delete e.stop,window.clearTimeout(g),h.apply(this,arguments),stage.gMasterContainer.removeChild(d)}}),f},mAssistAgain:function(){if(stage.pJsnData.is_host){var b=3e5;a.each(stage.pJsnData.assist,function(a){var c=1e3*a.remain_time;0!=c&&b>c&&(b=c)}),clearTimeout(stage.gGameStatus.timer.assist_again),stage.gGameStatus.timer.assist_again=setTimeout(function(){s.$viewContents.find(".btn-assist").removeClass("disable")},b)}},mSetSpecialSkip:function(b,c,d,e){var f="set-on",g="set-off",h=0,i=stage.pJsnData.formation[d],j=d+1,k=$("#wrapper").find(".prt-command-chara.chara"+j).find(".btn-skip-special"),l=$("#prt-set-special-skip").find(".prt-skip-special-stage.chara"+j);a.isUndefined(i)!==!0&&(b===!0?k.removeClass(f).addClass(g):(k.removeClass(g).addClass(f),h=1),k.data("pos",d).attr("data-pos",d),l.data("pos",d).attr("data-pos",d),e===!0?c=c&&l.hasClass("show"):l.addClass("show"),c===!0&&stage.gSpecialSkipSetEffect.show(h,d))},mUnsetSpecialSkip:function(a){this._UnsetSpecialSkip(a)},mUnsetSpecialSkipAll:function(){for(var a=0;4>a;a++)this._UnsetSpecialSkip(a)},_UnsetSpecialSkip:function(a){var b=a+1,c=$("#wrapper").find(".prt-command-chara.chara"+b).find(".btn-skip-special"),d=$("#prt-set-special-skip").find(".prt-skip-special-stage.chara"+b);c.removeClass("set-on set-off").removeData("pos").removeAttr("data-pos"),d.removeClass("show").removeData("pos").removeAttr("data-pos")},mShowSpecialSkipTapArea:function(){var a=$("#prt-set-special-skip").find(".prt-skip-special-stage");a.each(function(){$(this).addClass("show")})},mHideSpecialSkipTapArea:function(){var a=$("#prt-set-special-skip").find(".prt-skip-special-stage");a.each(function(){$(this).removeClass("show")})},mSetSpecialSkipAll:function(a){var b="set-on",c="set-off",d=a===!0?c:b,e=a===!0?0:1,f=null,g=$("#prt-sub-command-group").find(".btn-set-skip-special-all"),h=$("#wrapper").find(".btn-skip-special");if(g.removeClass(b+" "+c).addClass(d),h.each(function(){f=$(this),f.removeClass(b+" "+c),1===e?f.addClass(b):f.addClass(c)}),$("#prt-set-special-skip").find(".prt-skip-special-stage.show").length>0)for(var i=0,j=stage.pJsnData.formation.length;j>i;i++)1!==+stage.pJsnData.player.param[stage.pJsnData.formation[i]].alive||null!==stage.gGameStatus.player.posSizeL&&stage.gGameStatus.player.param[i].type!==n||stage.gSpecialSkipSetEffect.show(e,i)},visiblePlayerDisplay:function(a){for(var b=0;b<stage.gGameStatus.player.param.length;b+=1)stage.gAryCntnAvatar[b].visible=!1,b!==a&&0!==stage.gGameStatus.player.param[b].alive&&(s.$viewContents.find(".prt-command-top").find(".lis-character"+b).addClass(o),s.$viewContents.find(".prt-command-chara").find(".lis-character"+b).addClass(o))},setLsizePlayerDisplay:function(b){stage.gGameStatus.player.posSizeL=b,stage.gGameParam.grid.player[b]=a.clone(stage.gGameParam.grid.playerL),stage.gAryCntnAvatar[b].x=stage.gAryCntnAvatar[b].beforeX=stage.gGameParam.grid.player[b].x,stage.gAryCntnAvatar[b].y=stage.gAryCntnAvatar[b].beforeY=stage.gGameParam.grid.player[b].y,stage.gSpecialSkipSetEffect.changePosition(b,a.clone(stage.gGameParam.grid.player[b])),stage.gAryCntnAvatar[b].visible=!0},resetLsizePlayerDisplay:function(){if(null!==stage.gGameStatus.player.posSizeL){var b=stage.gGameStatus.player.posSizeL;stage.gAryCntnAvatar[b].visible=!1,stage.gGameParam.grid.player[b]=a.clone(stage.gGameParam.grid.playerFixed[b]),stage.gAryCntnAvatar[b].x=stage.gAryCntnAvatar[b].beforeX=stage.gGameParam.grid.player[b].x,stage.gAryCntnAvatar[b].y=stage.gAryCntnAvatar[b].beforeY=stage.gGameParam.grid.player[b].y,stage.gSpecialSkipSetEffect.changePosition(b,a.clone(stage.gGameParam.grid.player[b]));for(var c=0;c<stage.gGameStatus.player.param.length;c+=1)stage.gAryCntnAvatar[c].visible=!0,s.$viewContents.find(".prt-command-top").find(".lis-character"+c).removeClass(o),s.$viewContents.find(".prt-command-chara").find(".lis-character"+c).removeClass(o);stage.gGameStatus.player.posSizeL=null}},hideHUD:function(a){this.hideHudFlag=!0,this.mHideBossGauge(stage.gEnemyStatus),this.hideEnemyTargetingArea(),this.hideFieldCondition(),a&&this.setDisplaySmallButtons(!1)},showHUD:function(a){this.hideHudFlag=!1,this.mShowBossGauge(stage.gEnemyStatus),this.showEnemyTargetingArea(),this.showFieldCondition(),a&&this.setDisplaySmallButtons(!0)},getBottomBtnCjsIndexes:function(){var a=[k.AUTO];return 1===+stage.pJsnData.multi&&(a.push(k.CHAT_S),a.push(k.STAMP_S)),a},setDisplaySmallButtons:function(b){var c=b?"block":"none";this.$viewContents.find(".cnt-raid-chat").css({display:c}),a.each(this.getBottomBtnCjsIndexes(),function(a){stage.gAryCntnParts[a].visible=b})},hideEnemyTargetingArea:function(){this.$viewContents.find(".prt-targeting-area").css("display","none"),this.$viewContents.find(".prt-info-mask").css("display","none")},showEnemyTargetingArea:function(){this.$viewContents.find(".prt-targeting-area").css("display","block"),this.$viewContents.find(".prt-info-mask").css("display","block")},hideFieldCondition:function(){stage.gFieldCondition.hide(),this.$viewContents.find(".btn-field-conditions").removeClass("show")},showFieldCondition:function(){stage.gFieldCondition.show(),this.$viewContents.find(".btn-field-conditions").addClass("show")},changePlayerCjsPos:function(b,c){if(stage.gGameStatus.player.param[b]&&1===+stage.gGameStatus.player.param[b].alive){stage.gGameParam.grid.player[b]=a.clone(stage.gGameParam.grid.playerFixed[c]),stage.gAryCntnAvatar[b].x=stage.gAryCntnAvatar[b].beforeX=stage.gGameParam.grid.player[b].x,stage.gAryCntnAvatar[b].y=stage.gAryCntnAvatar[b].beforeY=stage.gGameParam.grid.player[b].y,stage.gSpecialSkipSetEffect.changePosition(b,stage.gGameParam.grid.player[b]);var d=$("#prt-set-special-skip"),e=b+1,f=c+1,g=d.find(".prt-skip-special-stage.pos"+f),h=d.find(".prt-skip-special-stage.chara"+e),i="pos"+f,j="pos"+e;g.length>0&&g.removeClass(i).addClass(j),h.removeClass(j).addClass("show "+i).data("pos",b).attr("data-pos",b);
}}};return s});