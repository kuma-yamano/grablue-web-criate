define(["underscore","backbone","typist","view/quest/abstract-view"],function(a,b,c,d){var e=null,f=d.extend({el:".prt-message-area",render:function(b,c,d,f){var g=this;e&&clearTimeout(e),$(".prt-sel-area").hide(),f&&$(".ico-cursor-talk").css("display","none"),g.$el.html('<span class="txt-message"></span>');var h={height:"auto",fontFamily:"inherit",fontSize:0},i=g.$(".txt-message").typist(h),j=b.split(/<br.*?>/gi),k=g._countMessageLength(j),l=function(){f||$(".ico-cursor-talk").show()},m=function(){var b=d[4],c=a.initial(d,1);if(void 0!==c[0]&&""!==c[0]){$(".cnt-quest-scene .prt-sel-area").css("display","block").append('<div class="btn-sel-taparea"></div>');var e=$(".prt-scene-comment .btn-play-voice");$(".prt-sel-area .btn-sel-taparea").on("cgtouchstart",function(){e.addClass("on")}).on("cgtouchmove cgtouchend",function(){e.removeClass("on")}),$(".btn-skip").css("opacity","0.5"),g._renderSelect(c)}else if(void 0!==b[0]&&""!==b[0]){$(".cnt-quest-scene .prt-sel-area").css("display","block").append('<div class="btn-sel-taparea"></div>');var e=$(".prt-scene-comment .btn-play-voice");$(".prt-sel-area .btn-sel-taparea").on("cgtouchstart",function(){e.addClass("on")}).on("cgtouchmove cgtouchend",function(){e.removeClass("on")}),$(".btn-skip").css("opacity","0.5"),g._renderImageSelect(b)}};if(b.length<=0)return l(),void g.trigger("talkEnd",{message:b,talkLength:k,displayMode:"full"});var n=function(){$(j).each(function(a,b){i.typist("echo",b).typist("wait",500)}),i.typist("wait",600).typist("call",function(){l(),g.trigger("talkEnd",{message:b,talkLength:k,displayMode:"full"})})},o=Game.setting.effect_mode;c&&0!=o?($(".btn-skip").css("opacity","1"),$(".ico-cursor-talk").hide(),n()):(this.$(".txt-message").html(b),l(),$(".btn-skip").css("opacity","1"),d.length>0&&m(),e=setTimeout(function(){g.trigger("talkEnd",{message:b,talkLength:k,displayMode:"simple"})},this.getDurationMS(k)))},_renderSelect:function(b){this._initSelect();var c=$(".prt-sel-inner"),d=1===a.without(b,void 0,"").length;c.toggleClass("prt-one-sel",d),a(b).each(function(a,b){void 0!==a&&""!==a&&c.append('<div class="btn-select-baloon txt-sel'+(b+1)+'">'+a+"</div>")})},_renderImageSelect:function(b){this._initSelect();var c=$(".prt-sel-inner"),d=1===a.without(b,void 0,"").length;c.toggleClass("prt-one-sel",d),a(b).each(function(b,d){void 0!==b&&""!==b&&c.append(a.template($("#tpl-choice-img").html(),{itemId:b}))})},_initSelect:function(){$(".prt-sel-inner").html("")},_countMessageLength:function(a){var b=0,c=!0;for(var d in a)for(var e in a[d])"<"===a[d][e]?c=!1:">"===a[d][e]&&(c=!0),c&&b++;return b}});return f});