define(["underscore","backbone","collection/quest/scenario-collection","collection/quest/coop-scenario-collection","collection/quest/archaic-scenario-collection","collection/quest/archaic-job-scenario-collection","collection/quest/archaic-bahamut-scenario-collection","collection/quest/casino-scenario-collection","collection/quest/archive-scenario-collection","loadmanager","general","view/quest/abstract-view","view/quest/event-scene-talk-view","view/quest/event-scene/event-scene-log-view","view/cjs/cjs-phit_sw_0002","view/cjs/cjs-ehit_0001","view/cjs/cjs-ab_3000","view/cjs/cjs-scene-effect","view/cjs/cjs-scene-effect-load","view/cjs/cjs-scene-private","view/cjs/cjs-quest_encount","lib/quest/extension","lib/sound","model/sound","lib/shellapp","model/token-data","util/language"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){var B=null,C=null,D=[0,1,2],E={CAT:"3020072000"},F=l.extend({effectCjs:null,isForcefulNext:!1,el:".cnt-quest-scene",charaList:[],tutorialInputtedName:"",tutorialTempNameStatus:D[0],shouldReplaceTempName:!1,latestVoice:"",questId:0,DURATION_WAITING_MS:800,isArcarumScene:!1,redirectUrl:"",callbackSetRedirectUrl:null,events:{"tap canvas:not(#cjs-npc_get), .prt-scene-comment":"next","tap .img-skip":"end","tap .txt-sel1":"selNext1","tap .txt-sel2":"selNext2","tap .txt-sel3":"selNext3","tap .txt-sel4":"selNext4",'tap .prt-sel-area [class*="img-choice"]':"selImgNext","tap .prt-scene-comment .btn-play-voice":"playButtonVoice","tap .prt-sel-area .btn-sel-taparea":"dummyButtonVoice","tap .prt-comic-display":"next"},initialize:function(b){this.stopStageEvent(),this.content_bind(),this.init(),this.coop_flg=0,this.archaic_flg=0,this.casino_flg=0,this.archive_flg=0,this.isSelectedSelImg=!1;var j=b.seasonEventId||0,k=b.sex||!1,l=b.uniqueId||0,m=b.event_id||0,n=b.isBirthdayScenario||!1,o=b.isStoryNpc||0;b.coop_flg&&(this.coop_flg=b.coop_flg),b.archaic_flg&&(this.archaic_flg=b.archaic_flg),b.casino_flg&&(this.casino_flg=b.casino_flg),b.archive_flg&&(this.archive_flg=b.archive_flg);var p=b.skyScenarioController||!1,q=b.isDefendOrder||!1,r=b.isSolotreasure||!1,s=b.isEventScene||!1,t="",u="",v=b.isArchiveNpc||!1,w=b.questId||0,x=b.currentLocationId||null,y=b.questType||null,z=b.isSideStory||!1,A=null;this.clearedSceneOnly=!!b.clearedSceneOnly,this.callbackSetRedirectUrl=b.callbackSetRedirectUrl,this.forcefulOpt=!1,null!==C&&this._clearSceneTimeoutID(),1==this.coop_flg?this.scenarioCollection=new d:1==this.archaic_flg?this.scenarioCollection=new e:2==this.archaic_flg?this.scenarioCollection=new f:3==this.archaic_flg?this.scenarioCollection=new g:this.casino_flg?this.scenarioCollection=new h:this.archive_flg?this.scenarioCollection=new i:(this.scenarioCollection=new c,j&&(this.scenarioCollection.url=Game.baseUri+"npc/season_event_scenario/"),r&&(u=b.eventModuleName,this.scenarioCollection.url=Game.baseUri+u+"/quest/scenario/"),s&&(u=b.eventModuleName,t=b.eventController,this.scenarioCollection.url=Game.baseUri+u+"/"+t+"/scenario/"),4===this.archaic_flg&&(this.scenarioCollection.url=Game.baseUri+"archaic/seraphic/scenario/"),z===!0&&(this.scenarioCollection.url=Game.baseUri+"rest/sidestory/scenario/"),m&&(this.scenarioCollection.url=Game.baseUri+"quest/scenario_campaign/"),n&&(this.scenarioCollection.url=Game.baseUri+"archive/scenario_birthday/"),p&&(this.scenarioCollection.url=Game.baseUri+"sky/"+p+"/scenario/"),q&&(this.scenarioCollection.url=Game.baseUri+"defendorder/island/scenario/"),null!==x&&null!==y&&(this.scenarioCollection.url=Game.baseUri+"quest/scenario_epilogue/"+w+"/"+x+"/"+y+"/",A=b.firstClear||"0"),v?this.scenarioCollection.url=Game.baseUri+"quest/scenario_archive/"+w+"/":b.isArcarumScene&&(this.isArcarumScene=!0,this.scenarioCollection.url=Game.baseUri+"rest/arcarum/summon_scenario/"),this.clearedSceneOnly&&(this.scenarioCollection.url=Game.baseUri+"rest/quest/cleared_quest_scenario/"+w+"/")),this.questId=w,this.imageDownloadCompleted=!1,this.listenTo(this.scenarioCollection,"reset",this.checkScenarioData),this.scene_id=b.scene_id,this.forwardFlg=b.forwardFlg,this.nextUrl=b.nextUrl,this.areaId=b.areaId,this.completedQuestId=b.completed_quest_id,this.locationId=b.location_id,this.forceFirststoryPlay=b.forceFirststoryPlay,this.nextNumbersId=b.nextNumbersId,this.bookmarkPage=b.bookmarkPage,this.sex=$(this.el).data("sex"),this.branch_npcs=b.branch_npcs||null,this.open_scene_hash=null,this.isTutorialScene=b.isTutorialScene||!1,this.isComicSelectScene="scene_evt180531_cp3_q2_s10_b"===this.scene_id&&a.isUndefined(this.archiveStoryFlag)===!0,this.popupStyleType=b.popupStyleType||"",this.isComicSelectScene===!0&&this.$el.find(".btn-skip").addClass("disable"),this.baseUrl=this.scenarioCollection.url;var B=this.scenarioCollection.url+this.scene_id;this.cjsMessage=null,a.isNull(A)||(B+="/"+A),this.seasonEventParam="",j&&(this.seasonEventParam="/"+b.isStoryNpc+"/"+j+"/"+b.viewCount+"/"+l,k!==!1&&(this.seasonEventParam+="/"+k),B+=this.seasonEventParam),m&&(B=B+"/"+o+"/"+m),n&&(B=B+"/"+o),null!=this.branch_npcs&&(B=B+"/"+this.branch_npcs),this.forceFirststoryPlay&&(B=null!=this.branch_npcs?B+"/"+this.forceFirststoryPlay:B+"/0/"+this.forceFirststoryPlay),this.scenarioCollection.url=B,this.scenarioCollection.fetch({reset:!0}),this.$char1=$("#char1"),this.$char2=$("#char2"),this.$char3=$("#char3"),this.$char1.hide(),this.$char2.hide(),this.$char3.hide(),this.$bg1=$("#bg1"),this.$bg2=$("#bg2"),this.$bg1.hide(),this.$bg2.hide(),this.scenario_index=0,this.next_scenario_index=0,this.sel_next1="",this.sel_next2="",this.sel_next3="",this.sel_next4="",this.sel_next5="",this.sel_next6="",this.postflag=0,this.hasResponseChoices=!1,this.scenes=new Array},setEventSceneSkipView:function(a){this.eventSceneSkipView=a},start:function(){this.delegateEvents(this.events),this.trigger("loadEnd"),this.scenario_execute(this.scenario_index,!0),w.once("complete",function(){});var b=a.filter(a.uniq(a.map(this.scenarioCollection.models,function(a){return a.get("bgm")})),a.identity),c=a.filter(a.uniq(a.map(this.scenarioCollection.models,function(a){return a.get("se")})),a.identity);a.filter(a.uniq(a.map(this.scenarioCollection.models,function(a){return a.get("voice")})),a.identity);w.loadFiles(a.union(b,c))},next:function(a,b){var c,d=this,e=function(){};if(b=b===!0,c=b&&this.forcefulOpt,!this.isForcefulNext||!this.forcefulOpt||b){this.isForcefulNext||d._clearSceneTimeoutID(),d._clearNextSetTimeout();var f=this.scenarioCollection.at(this.scenario_index);if(""==f.get("sel1_txt")&&""==f.get("sel2_txt")&&""==f.get("sel3_txt")&&""==f.get("sel4_txt")&&f.get("sel_next1")&&f.get("sel_next2")&&f.get("sel_next3")&&f.get("sel_next4")&&f.get("sel_next5")&&f.get("sel_next6")&&(0==this.sex?this.scenario_index=f.get("sel_next1")-1:this.scenario_index=f.get("sel_next2")-1),this.imageDownloadCompleted&&"none"==$(".ico-cursor-talk").css("display")&&!c)this.scenario_execute(this.scenario_index,!1,null,!0);else if(this.imageDownloadCompleted&&"block"==$(".ico-cursor-talk").css("display")&&this.hasResponseChoices)this.scenario_execute(this.scenario_index,!1,!0,!0);else if(this.imageDownloadCompleted&&("block"==$(".ico-cursor-talk").css("display")||c))if(this.isVibrateCharStopNext&&(this.isVibrateCharStopSoon=!0,this.isVibrateCharStopNext=!1),this.isVibrateBgStopNext&&(this.isVibrateBgStopSoon=!0,this.isVibrateBgStopNext=!1),e=function(){"mute"!=a&&x.playNextSceneSE(),d.isForcefulNext&&(d.isForcefulNext=!1,d._clearSceneTimeoutID()),d.scenario_index++,d.scenario_execute(d.scenario_index,!0,null,!0),null!=document.getElementById("bt-storyencoder")&&document.getElementById("bt-storyencoder").setAttribute("data-scnene-id",d.scenario_index)},this.isTutorialScene===!0&&this.tutorialTempNameStatus===D[1]){var g=function(a){d.tutorialTempNameStatus=D[2],d.setNicknameFont(),d.tutorialInputtedName=a,e()};this.trigger("shouldPopInputName",g)}else e()}},_clearSceneTimeoutID:function(){C&&window.clearTimeout(C),this.forcefulOpt&&(this.forcefulOpt=!1,this.$el.find(".btn-header.logView").removeClass("disable btn-silent-se"),this.$el.find(".btn-bgm-change").off("tap.forcefulOpt"))},selNext1:function(){var b=this;this.isComicSelectScene===!0?this.postScenarioSeltext(1,function(){b.scenario_index=this.sel_next1-1,b.next("mute"),b.$el.find(".btn-skip").removeClass("disable")}):a.isUndefined(this.isTreasureraid056)||this.isTreasureraid056!==!0?(this.scenario_index=this.sel_next1-1,this.next("mute"),$(".btn-skip").show()):this.postScenarioSeltext(1,function(){b.scenario_index=b.sel_next1-1,b.next("mute")})},selNext2:function(){var b=this;this.isComicSelectScene===!0?this.postScenarioSeltext(2,function(){b.scenario_index=this.sel_next2-1,b.next("mute"),b.$el.find(".btn-skip").removeClass("disable")}):a.isUndefined(this.isTreasureraid056)||this.isTreasureraid056!==!0?(this.scenario_index=this.sel_next2-1,this.next("mute"),$(".btn-skip").show()):this.postScenarioSeltext(2,function(){b.scenario_index=b.sel_next2-1,b.next("mute")})},selNext3:function(){var b=this;this.isComicSelectScene===!0?this.postScenarioSeltext(3,function(){b.scenario_index=this.sel_next3-1,b.next("mute"),b.$el.find(".btn-skip").removeClass("disable")}):a.isUndefined(this.isTreasureraid056)||this.isTreasureraid056!==!0?(this.scenario_index=this.sel_next3-1,this.next("mute"),$(".btn-skip").show()):this.postScenarioSeltext(3,function(){b.scenario_index=b.sel_next3-1,b.next("mute")})},selNext4:function(){if(a.isUndefined(this.isTreasureraid056)||this.isTreasureraid056!==!0)this.scenario_index=this.sel_next4-1,this.next("mute"),$(".btn-skip").show();else{var b=this;this.postScenarioSeltext(4,function(){b.scenario_index=b.sel_next4-1,b.next("mute")})}},selImgNext:function(a){var b=this;this.isSelectedSelImg!==!0&&(this.isSelectedSelImg=!0,this.setNamedTimeout("imgNextTimeout",function(){var c=$(a.currentTarget);b.selimgNo=c.index()+1,b.scenario_index=+b["sel_next"+b.selimgNo]-1,b.next("mute")},500))},postScenarioSeltext:function(b,c){var d,e;this.isComicSelectScene===!0?(d="treasureraid069/rest/quest/select_branch",e={seltext_no:b}):a.isUndefined(this.isTreasureraid056)===!1&&this.isTreasureraid056===!0&&(d="treasureraid056/quest/scenario_seltext",e={scene_id:this.scene_id,selimage_no:this.selimgNo,seltext_no:b});var f=new(z.extend({urlRoot:Game.baseUri+d}));this.listenToOnce(f,"sync",c),f.save(e)},end:function(){cjs.stage.sceneEffect&&cjs.stage.sceneEffect.removeAllEventListeners("tick"),cjs.stage.scenePrivate&&cjs.stage.scenePrivate.removeAllEventListeners("tick"),this.open_scene_hash?(this.content_close(),b.history.navigate(this.open_scene_hash.join("/"),!0)):this.fowardTo(this.forwardFlg,this.areaId,this.completedQuestId,this.locationId,null,this.nextNumbersId,this.bookmarkPage,this.redirectUrl,this.scene_id)},click_on:function(){this.delegateEvents()},click_off:function(){this.$el.off("tap")},checkScenarioData:function(){this.clearedSceneOnly&&(this.redirectUrl=this.scenarioCollection.at(0).get("redirect_url"),this.callbackSetRedirectUrl(this.redirectUrl)),this.cjsMessage=a.clone(this.scenarioCollection.at(0).get("cjs_message")),this.eventSceneSkipView.cjsMessage=this.cjsMessage;var b=a.clone(this.scenarioCollection.at(0).get("scenario"));b&&(Game.isReceivedSeasonMessageItem=this.scenarioCollection.at(0).get("popup"),this.scenarioCollection.set(b));var c=a.clone(this.scenarioCollection.at(0).get("scene_list")),d=this.scenarioCollection.at(0).get("move_scrapbook_detail");this.popupStyleType||(this.popupStyleType=this.scenarioCollection.at(0).get("popup_style_type"));var e=this.scenarioCollection.at(0).get("choice_image");$("#img-preload").empty(),e&&(this.$el.find(".prt-sel-area").addClass("sel"+e),$("#img-preload").append($('<div class="sel'+e+'">'))),c&&(0==a.isUndefined(d)&&d===!0&&(this.eventSceneSkipView.forwardFlg=this.forwardFlg=26,this.eventSceneSkipView.completedQuestId=this.completedQuestId=this.questId),this.scenarioCollection.set(c)),this.image_download()},image_download:function(){var b=this,c=[];this.scenarioCollection.each(function(d,e){d.get("synopsis")&&b.eventSceneSkipView.setSynopsis(d.get("chapter_name"),d.get("synopsis"),{popupStyleType:b.popupStyleType}),a(["charcter1_big_image","charcter1_small_image","charcter2_big_image","charcter2_small_image","charcter3_big_image","charcter3_small_image","bg1","bg2"]).each(function(a){var e=d.get(a);b.isNotEmpty(e)&&c.push(e)})});var d=new j;d._queueArr=[],d._registerArr=[],d._successArr=[],d._errorArr=[],d._isStarted=!1,d._isRunning=!1,d._isFinished=!1,d._currentQueues=[],d._queueCount=0;for(var e=0;e<c.length;e++)c[e]&&d.add(Game.imgUri+c[e]);d.onComplete=function(a){b.imageDownloadCompleted=!0,A.isJapanese()&&b.webfontSet(b.scene_id),b.start()},a.isEmpty(d._registerArr)?d.onComplete():d.start()},scenario_execute:function(b,c,d,e){var f=this;c&&0!==this.next_scenario_index&&(b=this.scenario_index=this.next_scenario_index,this.next_scenario_index=0);var g=this.scenarioCollection.at(b);if(b==this.scenarioCollection.length)return void this.end();if(g){if("undefined"!=typeof g.get("open_scene_file")&&g.get("open_scene_file")&&this.open_scene(g),"undefined"!=typeof g.get("next_scene_file")&&""!=g.get("next_scene_file"))return this.next_scene(g),void this._clearNextSetTimeout();""!=g.get("next")&&(this.next_scenario_index=g.get("next")),this.sel_next1=g.get("sel_next1"),this.sel_next2=g.get("sel_next2"),this.sel_next3=g.get("sel_next3"),this.sel_next4=g.get("sel_next4"),this.sel_next5=g.get("sel_next5"),this.sel_next6=g.get("sel_next6"),this.postflag=g.get("postflag"),"undefined"!=typeof this.sel_next1&&""!==this.sel_next1&&(this.hasResponseChoices=!0);var h;if(1===+g.get("text_send")?h=!1:(h=$("#scene_fast_text_mode").data("scene-fast-text-mode"),h="off"===h?!0:!1),this.forcefulOpt=1===+g.get("forceful_opt"),this._initAutoNext(),d===!0){var i=g.get("se");return i&&this.se_delay&&x.playSE(i),void this._playEventSceneTalk(g,h?c:!1,!0)}if(this._playEventSceneTalk(g,h?c:!1),(e||0==c)&&this.charaList.forEach(function(a){-1!=["L-slidein","L-slideout","R-slidein","R-slideout","T-slidein","T-slideout","B-slidein","B-slideout"].indexOf(a.command)&&a.chara_obj.stop(!0,!0)}),0==c)return void(this.charaList=[]);-1==$.inArray(g.id,this.scenes)&&(this.scenes.push(g.id),a.isUndefined(this.eventSceneLogView)===!0&&(this.eventSceneLogView=new n,this.addSubView(this.eventSceneLogView)),this.eventSceneLogView.append(g));var j=[];a(3).times(function(a){var b=a+1,c={name:g.get("charcter"+b+"_name"),big_image:g.get("charcter"+b+"_big_image"),small_image:g.get("charcter"+b+"_small_image"),position:g.get("charcter"+b+"_position"),command:g.get("command"+b),effect:g.get("effect"+b),chara_obj:f["$char"+b]};f.char_setting(f["$char"+b],c),j.push(c),f.charaList.push(c)});var k=+this._getNextParameter(j);k&&this._clearNextDeferred();var l={name:"&nbsp;"};if(this.isNotEmpty(j[0].name)&&(l=j[0]),f.bg_setting(f.$bg1,{image:g.get("bg1")}),f.$bg1.show(),f.bg_setting(f.$bg2,{image:g.get("bg2")}),-1!==this.scene_id.indexOf("scene_evt180531_cp0_q2_s10_com")&&f.bg_setting($("#comic"),{image:"/sp/quest/scene/comic/"+this.scene_id+".jpg"}),this.isTutorialScene===!0&&!a.isEmpty(this.tutorialInputtedName)&&this.tutorialTempNameStatus===D[2]||this.shouldReplaceTempName===!0){var m=this.shouldReplaceTempName===!0?this.$el.data("nick-name"):this.tutorialInputtedName;l.name=l.name.replace("<span class='nickname'></span>",m)}this.$(".txt-character-name").html("<span>"+l.name+"</span>"),f.se_delay=!1,a.each(j,function(a,b){"play_se_choices"==a.command&&(f.se_delay=!0)});var o,i;o=g.get("bgm"),o&&x.playBGM(o),i=g.get("se"),i&&!f.se_delay&&x.playSE(i),x.stopVoice(),this.latestVoice&&"silent"!==this.latestVoice&&w.destroy(this.latestVoice);var p=g.get("voice")||"";if(this._playVoice(p),this.latestVoice=p,!Game.setting.effect_mode||w.isSupportedHTMLAudio()&&!w.isSupportedWebAudio()&&!w.isSupportedNativeAudio()){var q=this.$el.find(".btn-play-voice");"silent"==p&&(p=""),q.attr("data-voice",p);var r=p&&l.name&&!l.name.match(/^[\s　]$/)?"block":"none";q.css("display",r)}var s=this.scenarioCollection.at(b+1);s&&(o=s.get("bgm"),o&&x.loadBGM(o),i=s.get("se"),i&&x.loadSE(i),p=s.get("voice"),p&&x.loadVoice(p))}},open_scene:function(b){var c=this,d=b.get("open_scene_file"),e=location.hash.split("/");this.open_scene_hash=e,a.each(e,function(a,b){"scene_"==a.substr(0,6)&&(c.open_scene_hash[b]=d)}),this.eventSceneSkipView.setOpenScene(this.open_scene_hash.join("/"))},next_scene:function(b){var c=b.get("next_scene_file");this.scene_id=c,this.scenarioCollection.url=this.baseUrl+this.scene_id,a.isEmpty(this.seasonEventParam)||(this.scenarioCollection.url=this.scenarioCollection.url+this.seasonEventParam),null!=this.branch_npcs&&(this.scenarioCollection.url=this.scenarioCollection.url+"/"+this.branch_npcs),this.scenario_index=0,this.next_scenario_index=0,this.scenarioCollection.fetch({reset:!0}),this.scenes=[],this.trigger("xhrStart")},_getNextParameter:function(b){var c=this,d=0;return a(b).each(function(a){if("next"===c.getCommand(a.command)){var b=c.getParam(a.command);d=b[0]?b:d}}),d},_initAutoNext:function(a){var b=this,c=$.Deferred(),d=$.Deferred();this.voiceDeferred=c,this.EventSceneTalkDeferred=d,$.when(c,d).done(function(){b._clearNextSetTimeout(),0!==Game.setting.effect_mode&&($("#btn-auto").hasClass("off")||b.isForcefulNext||(B=window.setTimeout(function(){b._canTapCanvas()&&b.next()},b.DURATION_WAITING_MS)))})},_canTapCanvas:function(){return"none"===$(".prt-sel-area").css("display")},_clearNextDeferred:function(a){a=a||{},a.talk!==!0&&this.EventSceneTalkDeferred.reject(),this.voiceDeferred.reject(),this._clearNextSetTimeout()},_clearNextSetTimeout:function(){B&&window.clearTimeout(B),this.trigger("clearNextSetTimeout")},_playVoice:function(a){var b=this;b.voicePath=a,a&&"silent"!==a?0===Game.setting.sound_flag?b.voiceDeferred.resolve():y.isShellAppAndroid()?(x.playVoice(a),b.isVoiceComplete=!1,$(document).off("shellappAndroidSoundComplete"),$(document).one("shellappAndroidSoundComplete",function(){b.voiceDeferred.resolve(),b.isVoiceComplete=!0})):(x.playVoice(a),b.isVoiceComplete=!1,w.once(a,"complete",function(a){b.voiceDeferred.resolve(),b.isVoiceComplete=!0})):b.voiceDeferred.resolve()},_playEventSceneTalk:function(b,c,d){var e=this,f=[],g=new m,h=b.get("detail");if(this.addSubView(g),this._scenario_execute_exception(b),this.listenToOnce(g,"talkEnd",function(a){e.EventSceneTalkDeferred.resolve()}),d===!0&&(f=[b.get("sel1_txt"),b.get("sel2_txt"),b.get("sel3_txt"),b.get("sel4_txt"),[b.get("sel1_image"),b.get("sel2_image"),b.get("sel3_image"),b.get("sel4_image"),b.get("sel5_image"),b.get("sel6_image")]],this.hasResponseChoices=!1),this.isTutorialScene===!0&&!a.isEmpty(this.tutorialInputtedName)&&this.tutorialTempNameStatus===D[2]||this.shouldReplaceTempName===!0){var i=this.shouldReplaceTempName===!0?this.$el.data("nick-name"):this.tutorialInputtedName;h=h.replace("<span class='nickname'></span>",i)}g.render(h,c,f,this.forcefulOpt)},_scenario_execute_exception:function(a){var b=this.scenarioCollection.length,c=Number(a.get("id")),d=this.scene_id;"scene_fate_chr080_ep1"==d&&47==b&&44==c&&this._initItem(a),"scene_fate_chr026_ep1"==d&&52==b&&49==c&&this._initItem(a),"scene_fate_chr012_ep1"==d&&36==b&&33==c&&this._initItem(a),"scene_fate_chr064_ep1"==d&&35==b&&32==c&&this._initItem(a)},_initItem:function(a){a.attributes.sel1_txt="",a.attributes.sel2_txt="",a.attributes.sel3_txt="",a.attributes.sel4_txt="",a.attributes.sel_next1="",a.attributes.sel_next2="",a.attributes.sel_next3="",a.attributes.sel_next4="",a.attributes.sel_next5="",a.attributes.sel_next6=""},bg_setting:function(a,b){b.image&&a.attr("src",Game.imgUri+b.image)},char_setting:function(a,b){this.isNotEmpty(b.big_image)&&a.attr("src",Game.imgUri+b.big_image);var c=0;if(b.position)switch(b.position){case"R":c=60;break;case"C":c=-0;break;case"L":c=-60;break;case"R2":c=70;break;case"L2":c=-70}this.command(a,b,c)},canvasOff:function(){},command:function(a,b,c){var d=this,e="0px",f=this.getParam(b.command);if(this.timerId=0,"cjsOpening"==this.getCommand(b.command))return this.delegateEvents({"tap     canvas":"canvasOff","playEnd #cjs-scene-effect":"end"}),this.effectCjs&&(this.effectCjs=null),$("#cjs-scene-effect").siblings().hide(),void(this.effectCjs=new s({load:f[0]}));if(b.command)switch(this.getCommand(b.command)){case"L-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("left",-1*parseInt(a.css("width"))+"px"),a.show(),a.animate({top:e,left:c+"px"},300,function(){d.effect(a,b)});break;case"L-slideout":a.animate({top:e,left:-1*parseInt(a.css("width"))+"px"},1e3,function(){a.hide()});break;case"R-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("left",1*parseInt(a.css("width"))+"px"),a.show(),a.animate({top:e,left:c+"px"},300,function(){d.effect(a,b)});break;case"R-slideout":a.animate({top:e,left:1*parseInt(a.css("width"))+"px"},1e3,function(){a.hide()});break;case"T-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("top",-1*parseInt(a.css("height"))+"px"),a.show(),a.animate({top:e,left:c},300,function(){d.effect(a,b)});break;case"T-slideout":a.animate({top:-1*parseInt(a.css("height"))+"px",left:c},300,function(){a.hide()});break;case"B-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("top",parseInt(a.css("height"))+"px"),a.show(),a.animate({top:e,left:c},300,function(){d.effect(a,b)});break;case"B-slideout":a.animate({top:parseInt(a.css("height"))+"px",left:c},300,function(){a.hide()});break;case"fadein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.animate({top:e,left:c+"px"},0,function(){d.effect(a,b)}),a.hide(),a.fadeIn(300);break;case"fadeout":a.fadeOut(300);break;case"vague":a.css("z-index",1),a.css("opacity",.5);break;case"worsen":a.css("z-index",1);break;case"color_start":this.colorChange($(".onm-effect-layer"),f[0],f[1],f[2],f[3]);break;case"color_end":$(".onm-effect-layer").css({"background-color":"transparent"});break;case"color_fadein":this.colorFade($(".onm-effect-layer"),f[0],f[1],f[2],f[3],f[4]);break;case"color_fadeout":$(".onm-effect-layer").css({"background-color":"transparent"}).oneTransitionEnd(function(){$(this).removeClass("trans").attr("style","").off("transitionend webkitTransitionEnd")},1100);break;case"initialize":this.initializeEffect();break;case"vibrate":this.addEffect($(".prt-scene-stage"),"shake-regular","0.18s",f[0]);break;case"vibrate_loop_start":var g=f[0]||0;this.startVibrateLoop($(".prt-scene-stage"),180,g);break;case"vibrate_loop_end":this.stopVibrateLoop($(".prt-scene-stage"));break;case"flash":this.addEffect($(".onm-effect-layer"),"to-white-start","0.5s","1");break;case"jump":a.css({top:"10px"}).animate({top:"-25px"},110).animate({top:"10px"},110).animate({top:"0px"},30);break;case"jump_loop_start":this.addEffect(a,"jump-full","0.25s","infinite");break;case"jump_loop_end":this.removeEffect(a,"jump-full");break;case"char_vibrate":this.vibrate_regular(a,180,10,0);break;case"char_vibrate_one":this.vibrate_regular(a,180,10,1);break;case"bg_vibrate":this.vibrate_bg($(".prt-scene-bg"),180,10,0);break;case"bg_vibrate_one":this.vibrate_bg($(".prt-scene-bg"),180,10,1);break;case"phit_sw_0002":this.effectCjs&&this.effectCjs.removeChildren();var h=240+2*c;this.effectCjs=new o({posX:h});break;case"ehit_0001":this.effectCjs&&this.effectCjs.removeChildren();var h=330+2*c;this.effectCjs=new p({posX:h});break;case"ab_3000":this.effectCjs&&this.effectCjs.removeChildren();var h=340+2*c;this.effectCjs=new q({posX:h});break;case"blackin":null==this.effectCjs?this.effectCjs=new r({motion:"fadein"}):"fadeCjs"!=this.effectCjs.identifier?(this.effectCjs.removeChildren(),this.effectCjs=new r({motion:"fadein"})):this.effectCjs.motionCall("fadein");break;case"blackout":null==this.effectCjs?this.effectCjs=new r({motion:"fadeout"}):"fadeCjs"!=this.effectCjs.identifier?(this.effectCjs.removeChildren(),this.effectCjs=new r({motion:"fadeout"})):this.effectCjs.motionCall("fadeout");break;case"sceneCjs":this.effectCjs&&(this.effectCjs=null);var i=12,j=30,k=i;f[1]&&(k=f[1]>j?j:f[1]);var l=f[2]||this.scene_id;this.effectCjs=new t({motion:f[0]||0,fpsNum:k,scene_id:l,opacity:+f[3]||1,isBgEffect:+f[4]||0,posX:f[5]||0,posY:f[6]||0,rotate:f[7]||0,scaleX:f[8]||1,scaleY:f[9]||1,blendModeId:+f[10]||0});break;case"cjsLoad":this.effectCjs&&(this.effectCjs=null),this.effectCjs=new s({load:f[0],label:5});break;case"cjsEncount":$("#btn-auto").remove(),$(".ico-cursor-talk").show(),this.effectCjs&&(this.effectCjs=null),$("#cjs-scene-effect").siblings().hide(),this.effectCjs=new s({load:f[0]});break;case"cjsEncountAssignImage":$("#btn-auto").remove(),$(".ico-cursor-talk").show(),this.effectCjs&&(this.effectCjs=null),$("#cjs-scene-effect").siblings().hide(),this.effectCjs=new u({load:f[0]});break;case"cjsDelete":this.effectCjs&&this.effectCjs.removeChildren();break;case"inputTemporaryName":this.isTutorialScene===!0?this.tutorialTempNameStatus=D[1]:this.shouldReplaceTempName=!0;break;case"next":C=setTimeout(function(){d.next("mute")},1e3*f[0]);break;case"next_forceful":this.isForcefulNext=!0,this.forcefulOpt&&(this.$el.find(".btn-header.logView").addClass("disable btn-silent-se"),this.$el.find(".btn-bgm-change").on("tap.forcefulOpt",function(a){a.preventDefault(),a.stopPropagation()})),C=setTimeout(function(){d.isForcefulNext=!1,d.next("mute",!0)},1e3*f[0]);break;case"comic_show":x.playSE("se/page_se_1.mp3");var m=this.$el.find(".tap-blocker");m.css("display","block"),this.$el.find(".prt-comic-display").fadeIn(800,function(){var a=2e3,b="comicDisplay";d.setNamedTimeout(b,function(){m.css("display","none"),d.$el.find(".ico-cursor-talk-comic").css("display","block")},a)});break;case"comic_hide":x.playSE("se/page_se_1.mp3"),this.$el.find(".tap-blocker").css("display","none"),this.$el.find(".prt-comic-display").fadeOut(800),this.$el.find(".ico-cursor-talk-comic").css("display","none")}},effect:function(a,b){if(b.effect)switch(b.effect){case"up_and_down":a.addClass("up_and_down")}},initializeEffect:function(){$(".prt-scene-stage").removeClass().addClass("prt-scene-stage"),$(".onm-effect-layer").removeClass().addClass("onm-effect-layer"),$(".prt-scene-bg").removeClass().addClass("prt-scene-bg"),$(".img-scene-character").removeClass().addClass("img-scene-character")},vibrate_regular:function(a,b,c,d){var e=this,f=0,g=b/5;this.isVibrateCharStopSoon=!1;var h=setInterval(function(){setTimeout(function(){e.vibrateStyle(a,g,"2px")},4*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},3*g),setTimeout(function(){e.vibrateStyle(a,g,"2px")},2*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},g),e.vibrateStyle(a,g,"2px"),f++,(f>c||e.isVibrateCharStopSoon)&&(setTimeout(function(){e.vibrateStyle(a,1,0),e.isVibrateCharStopSoon=!1},5*g),clearInterval(h))},b);1==d&&(this.isVibrateCharStopNext=!0)},vibrate_bg:function(a,b,c,d){var e=this,f=0,g=b/5;this.isVibrateBgStopSoon=!1;var h=setInterval(function(){setTimeout(function(){e.vibrateStyle(a,g,"2px")},4*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},3*g),setTimeout(function(){e.vibrateStyle(a,g,"2px")},2*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},g),e.vibrateStyle(a,g,"2px"),f++,(f>c||e.isVibrateBgStopSoon)&&(setTimeout(function(){e.vibrateStyle(a,1,0),e.isVibrateBgStopSoon=!1},5*g),clearInterval(h))},b);1==d&&(this.isVibrateBgStopNext=!0)},vibrateStyle:function(a,b,c){a.css({"-webkit-transition-property":"-webkit-transform","-webkit-transition-duration":b,"-webkit-transform":"translateX("+c+")","transition-property":"transform","transition-duration":b,transform:"translateX("+c+")"})},startVibrateLoop:function(a,b,c){var d=this,e=0,f=b/4;this.isLoopVibrateY=!0;var g=function(){d.isLoopVibrateY&&(setTimeout(function(){0!==c&&e==c?d.stopVibrateLoop():(e++,g())},b),setTimeout(function(){d.vibrateStyleY(a,f,"-1px")},3*f),setTimeout(function(){d.vibrateStyleY(a,f,"1px")},2*f),setTimeout(function(){d.vibrateStyleY(a,f,"-1px")},f),d.vibrateStyleY(a,f,"1px"))};g()},stopVibrateLoop:function(a){this.isLoopVibrateY=!1,this.vibrateStyleY(a,0,"0px")},vibrateStyleY:function(a,b,c){this.isLoopVibrateY||(b=0,c="0px"),a.css({"-webkit-transition-property":"-webkit-transform","-webkit-transition-duration":b,"-webkit-transform":"translateY("+c+")","transition-property":"transform","transition-duration":b,transform:"translateY("+c+")"})},addEffect:function(a,b,c,d){var e=c.replace(/s/g,""),f=1e3*+e,g=a;g.addClass(b).css({"animation-duration":c,"-webkit-animation-duration":c,"animation-iteration-count":d,"-webkit-animation-iteration-count":d}).oneAnimationEnd(function(){$(this).removeClass(b).css("-webkit-animation","")},f+100)},removeEffect:function(a,b){var c=a;c.removeClass(b).css("-webkit-animation","")},colorChange:function(a,b,c,d,e){var f=a;f.css({"background-color":"rgba("+b+","+c+","+d+","+e+")"})},colorFade:function(a,b,c,d,e,f){var g=a;g.addClass("trans").css({"background-color":"rgba("+b+","+c+","+d+","+e+")","transition-duration":f,"-webkit-transition-duration":f})},getCommand:function(a){var b=a.indexOf("(");if(-1===b)return a;var c=a.substring(0,b);return c},getParam:function(a){var b=a.indexOf("(");if(-1===b)return Array;var c=a.substring(b+1,a.length-1),d=c.split(",");return d},webfontSet:function(a){var b="@font-face {font-family: "+a+";src: url("+Game.fontUri+"/scene/"+a+".woff);}",c=document.styleSheets[0],d=c.cssRules.length;c.insertRule(b,d);var e="";this.scenarioCollection.at(0).get("named_npc_id")===E.CAT&&(b="@font-face {font-family: cat_name;src: url("+Game.fontUri+"/cat_name.woff);}",c.insertRule(b,c.cssRules.length),e="cat_name, "),this.$el.find(".prt-scene-comment").add(".prt-log-display").css("font-family","nickname_scene, "+e+a+', "FOT-ニューシネマA Std D", "Average Sans", sans-serif')},setNicknameFont:function(){var a="@font-face{font-family: nickname_scene; src: url("+Game.baseUri+"/user/scene_nickname.woff);}",b=document.styleSheets[0],c=b.cssRules.length;b.insertRule(a,c)},playButtonVoice:function(a){a.stopPropagation();var b=$(a.currentTarget).attr("data-voice");x.playVoice(b,{force:!0})},dummyButtonVoice:function(){this.$el.find(".prt-scene-comment .btn-play-voice").trigger("tap")}});return F});