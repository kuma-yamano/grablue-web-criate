define(["underscore","backbone","lib/sound","view/quest/abstract-view","view/quest/event-scene/event-scene-log-view","view/quest/event-scene/event-scene-log-sound","view/quest/event-scene/event-scene-comment-view","view/quest/event-scene/event-scene-character-view","lib/shellapp"],function(a,b,c,d,e,f,g,h,i){var j=!1,k=!1,l=0,m=0,n="eventSceneFooterViewTimer",o=d.extend({el:".prt-quest-header",events:{"tap .btn-header.logView":"log_event","tap .btn-header.talkView":"back_event"},event_scene:null,initialize:function(a){this.event_scene=a.event_scene},back_event:function(){var b=new g;b.show();var c=new h;c.show(),a.isUndefined(this.eventSceneLogView)===!0&&(this.eventSceneLogView=new e),this.eventSceneLogView.hide(),this.$el.find(".btn-header").removeClass("talkView").addClass("logView"),$(".cnt-quest-scene").removeClass("log"),this.event_scene.click_on(),Game.get$ScrollParent().scrollTop(0),j&&this.onCloseLog(),k=!1},log_event:function(b){if(!$(b.currentTarget).hasClass("disable")){var c=new g;c.hide();var d=new h;d.hide(),j=0!==Game.setting.effect_mode&&!$("#btn-auto").hasClass("off"),a.isUndefined(this.eventSceneLogView)===!0&&(this.eventSceneLogView=new e),this.eventSceneLogView.show(),a.isUndefined(this.eventSceneLogSound)===!0&&(this.eventSceneLogSound=new f),this.$el.find(".btn-header").removeClass("logView").addClass("talkView"),$(".cnt-quest-scene").addClass("log"),this.event_scene.click_off(),this.event_scene._clearSceneTimeoutID(),this.isTyping="none"===$(".ico-cursor-talk").css("display"),j&&this.isTyping&&(l=$(".prt-message-area").find(".txt-message").text().length,this.event_scene.scenario_execute(this.event_scene.scenario_index,!1,null,!0)),this.clearTimeoutOne(n),this.trigger("pushLogButton"),k=!0}},onCloseLog:function(){var a=this,b=function(){a.$el.find(".btn-header").hasClass("logView")&&a.waitAndGoNext(a.event_scene.DURATION_WAITING_MS),a.event_scene.isVoiceComplete=!0};if(j){if(a.event_scene.isVoiceComplete===!1)return void(i.isShellAppAndroid()?($(document).off("shellappAndroidSoundComplete"),$(document).one("shellappAndroidSoundComplete",b)):c.once(a.event_scene.voicePath,"complete",b));if(this.eventSceneLogSound.isPlayingVoice())return void this.eventSceneLogSound.voiceDeferred.done(function(){!k&&a.waitAndGoNext(a.event_scene.DURATION_WAITING_MS)});var d="on"===$("#scene_fast_text_mode").data("scene-fast-text-mode");if(m=$(".prt-message-area").find(".txt-message").text().length,d)return void this.waitAndGoNext(this.getDurationMS(m));var e=m-l,f=a.isTyping?this.getDurationMS(e):this.event_scene.DURATION_WAITING_MS;this.waitAndGoNext(f)}},waitAndGoNext:function(a){var b=this;this.setNamedTimeout(n,function(){b.clearTimeoutOne(n),b.event_scene._canTapCanvas()&&b.event_scene.next()},a),this.stopListening(this.event_scene,"clearNextSetTimeout"),this.listenToOnce(this.event_scene,"clearNextSetTimeout",function(){b.clearTimeoutOne(n)})}});return o});