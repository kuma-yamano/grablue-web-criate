define(["lib/raid/display","lib/raid/effect","lib/raid/motion","lib/shellapp","model/sound"],function(a,b,c,d,e){var f=["mortal_A","mortal_B","mortal_C","mortal_D"],g={$viewContents:$("#wrapper").find(".contents"),hideHUD:function(b){a.hideHUD(b||!1)},showHUD:function(b){a.showHUD(b||!1)},mDamage:function(f,g){var h=stage.gScenarioParam;if("off"!==h.change&&"undefined"!=typeof h.list&&h.list[g]){var i=f.Tween.get({},{override:!0}),j="undefined"!=typeof h.attr?h.attr:stage.gGameStatus.player.param[h.pos].attr;_.each(h.list[g].damage,function(f){if(j="undefined"!=typeof f.attr?f.attr:"undefined"!=typeof h.attr?h.attr:stage.gGameStatus.player.param[h.pos].attr,"boss"===h.target){if(f.effect&&b.mHitEffect(i,stage.gAryCntnBoss[f.pos],{kind:f.effect,size:f.size,type:"boss",pos:f.pos}),_.isUndefined(h.skip_flag)||h.skip_flag===!1){var g=Game.view.setupView.createDamageComponent(f,"boss",h.list.length>1,j,void 0,0);i.call(function(){g.show()})}if(1!=f.miss&&4!=f.miss){var k=h.bossWaitMode||stage.gGameStatus.waitmode,l=c.mChangeMotion(i,{motion:"damage",pos:f.pos,type:"boss",originalBossWaitMode:k});c.mResetMotion(i,{delay:l,motion:k[f.pos],pos:f.pos,type:"boss"}),stage.gGameStatus.boss.param[f.pos].hp=f.hp,a.mBossGaugeHp(i,stage.gEnemyStatus,stage.pJsnData.boss.type,{pos:f.pos,param:stage.gGameStatus.boss.param[f.pos]})}}else if("player"===h.target){f.effect&&b.mHitEffect(i,stage.gAryCntnAvatar[f.pos],{kind:f.effect,type:"player"});var g=Game.view.setupView.createDamageComponent(f,"player",h.list.length>1,j,void 0,0);if(i.call(function(){g.show(),f.voice&&(d.isShellAppAndroid()?e.isPlayingVoice()||e.playVoice(f.voice):e.playVoice(f.voice,{alias:"voice"+f.pos}))}),1!=f.miss&&4!=f.miss){var l=c.mChangeMotion(i,{motion:"damage",pos:f.pos,type:"player"});stage.gGameStatus.assignHpSuperDamageSoon===!0&&(stage.gGameStatus.player.param[f.pos].hp=f.hp,stage.pJsnData.player.param[stage.pJsnData.formation[f.pos]].hp=f.hp);var m=stage.gGameStatus.defaultmotion[stage.pJsnData.formation[f.pos]]||"stbwait",n=+stage.pJsnData.player.param[stage.pJsnData.formation[f.pos]].motion_conf===c.CHARA_MOTION_TYPE.KEEP_KNOCK_BACK;n||c.mResetMotion(i,{delay:l,motion:m,pos:f.pos,type:"player",isReplay:!0});var o=$.extend(!0,{},stage.gGameStatus.player.param[f.pos]);o.hp=f.hp,a.mPlayerGaugeHp(i,{pos:f.pos,param:o})}}i.wait(3*stage.gGameParam.spf)}),new f.Timeline(i,{},{useTicks:!0})}},mChangeMotion:function(a){var b=stage.gScenarioParam.skip_flag,d="super"===stage.gScenarioParam.cmd?"enemy":"special"===stage.gScenarioParam.cmd?"job":"npc",e="";if(e=_.contains(c.pDownTarget,a)&&"player"===d&&stage.gGameStatus.player.param[stage.gScenarioParam.pos].hp/stage.gGameStatus.player.param[stage.gScenarioParam.pos].hpmax<=c.pDownThreshold?c.pDownLabel:a,"special"===stage.gScenarioParam.cmd||"special_npc"===stage.gScenarioParam.cmd){if(stage.gAryRootAvatar[stage.gScenarioParam.pos][stage.gGameStatus.player.param[stage.gScenarioParam.pos].cjs].gotoAndPlay(e),stage.gGameStatus.player.motion[stage.gScenarioParam.pos]=e,b===!0){var g=parseInt(stage.gGameStatus.defaultNpcSkipFrame,10);1===Game.isSandbox&&""!==$("#debug_skip_frame_npc").val()?g=parseInt($("#debug_skip_frame_npc").val(),10):stage.gScenarioParam.skip_frame&&(g=stage.gScenarioParam.skip_frame);var h=stage.gGameStatus.player.param[stage.gScenarioParam.pos].cjs,i=stage.gScenarioParam.kind,j=i.match(/^sp_/);if(!_.isNull(j)){var k=stage.gScenarioParam.skip_label;if(k){var l=stage.gGameStatus.player.param[stage.gScenarioParam.pos].cjs+"_mortal_B",m=stage.gAryRootAvatar[stage.gScenarioParam.pos][stage.gGameStatus.player.param[stage.gScenarioParam.pos].cjs][l],n=k.split("|");if(n.length>1){var o=parseInt(m.timeline.duration,10),p=0;o>g&&(p=o-g),1===Game.setting.cjs_mode?setTimeout(function(){m.gotoAndPlay(p)},70):m.gotoAndPlay(p),_.each(n,function(a){var b=a.split(".");if(b[0]){var c=m;_.each(b,function(a){var b="%s",d=" "+a;-1!==d.indexOf(" "+b)&&(a="npc_"+r+a.replace(/%s/g,"")),c=c[a]}),1===Game.setting.cjs_mode?setTimeout(function(){c.gotoAndPlay(p)},70):c.gotoAndPlay(p)}})}else if("mortal_B"===k){var o=parseInt(m.timeline.duration,10),p=0;o>g&&(p=o-g),1===Game.setting.cjs_mode?setTimeout(function(){m.gotoAndPlay(p)},70):m.gotoAndPlay(p)}}}if(_.isNull(j)){var q=i.match(/_[a-z]$/);if(_.isNull(q)){var r=h.replace("npc_","");q=null,q=h.match(/_f1$/),_.isNull(q)||(r=r.replace(q[0],""));var l=stage.gGameStatus.player.param[stage.gScenarioParam.pos].cjs+"_mortal_A"}else{var s="mortal_"+q[0].slice(-1).toUpperCase(),r=h.replace(q[0],"");r=r.replace("npc_","");var l=stage.gGameStatus.player.param[stage.gScenarioParam.pos].cjs+"_"+s}var m=stage.gAryRootAvatar[stage.gScenarioParam.pos][stage.gGameStatus.player.param[stage.gScenarioParam.pos].cjs][l],k=stage.gScenarioParam.skip_label;if(k){var n=k.split("|");if(n.length>1){var o=parseInt(m.timeline.duration,10),p=0;o>g&&(p=o-g),1===Game.setting.cjs_mode?setTimeout(function(){m.gotoAndPlay(p)},70):m.gotoAndPlay(p),_.each(n,function(a){var b=a.split(".");if(b[0]){var c=m;_.each(b,function(a){var b="%s",d=" "+a;-1!==d.indexOf(" "+b)&&(a="npc_"+r+a.replace(/%s/g,"")),c=c[a]}),1===Game.setting.cjs_mode?setTimeout(function(){c.gotoAndPlay(p)},70):c.gotoAndPlay(p)}})}else{var t="%s",u=" "+k;-1!==u.indexOf(" "+t)&&(k="npc_"+r+k.replace(/%s/g,""));var o=parseInt(m[k].timeline.duration,10),p=0;o>g&&(p=o-g),1===Game.setting.cjs_mode?setTimeout(function(){m[k].gotoAndPlay(p)},70):m[k].gotoAndPlay(p)}}else{var o=parseInt(m.timeline.duration,10),p=0;o>g&&(p=o-g),1===Game.setting.cjs_mode?setTimeout(function(){m.gotoAndPlay(p)},70):m.gotoAndPlay(p)}}}}else"super"===stage.gScenarioParam.cmd&&(stage.gAryRootBoss[stage.gScenarioParam.pos][stage.gGameStatus.boss.param[stage.gScenarioParam.pos].cjs].gotoAndPlay(e),_.contains(f,e)===!0&&c.mPlayVoiceSelection(e,{voice:stage.gScenarioParam.voice,voice_wait:stage.gScenarioParam.voice_wait}),stage.gGameStatus.boss.param[stage.gScenarioParam.pos].motion_link_list&&c.mPlayEnemyMotionTogether(stage.gScenarioParam.pos,e,null,!1))},mMoveTo:function(a,b,c,d,e){b=b?b:0,c=c?c:0,d=d?d:0,e=e?e:"linear",a.Tween.get(stage.gAryRootAvatar[stage.gScenarioParam.pos],{useTicks:!0}).to({x:b,y:c},d,createjs.Ease[e])},mAnimColor:function(a,b,c){var d=g.$viewContents.find(".prt-bg-effect-color");d.addClass(a).css({"animation-duration":b,"-webkit-animation-duration":b,"animation-iteration-count":c,"-webkit-animation-iteration-count":c}).on("animationend webkitAnimationEnd",function(){$(this).removeClass(a).attr("style","")})},mAnimBrightness:function(a,b,c){var d=g.$viewContents.find(".prt-bg-effect-brightness");d.addClass(a).css({"animation-duration":b,"-webkit-animation-duration":b,"animation-iteration-count":c,"-webkit-animation-iteration-count":c}).on("animationend webkitAnimationEnd",function(){$(this).removeClass(a).attr("style","")})},mAnimShake:function(a,c,d){var e,f=parseFloat(c);f*=12/stage.gGameParam.fps,e=1e3*f/4,b.mCommonShake(stage.gAryCntnAvatar,e,d),b.mCommonShake(stage.gAryCntnBoss,e,d)},mAnimZoomChara:function(a){var b=[];b[0]="940px 320px",b[1]="940px 600px",b[2]="1100px 180px",b[3]="1100px 480px",b[4]="1100px 760px";var c=g.$viewContents.find(".cnt-raid-stage"),d=2;c.css({"-webkit-transform":"scale("+d+")",transform:"scale("+d+")","-webkit-transform-origin":b[a],"transform-origin":b[a]})},mAnimZoomReset:function(){var a=g.$viewContents.find(".cnt-raid-stage");a.css({"-webkit-transform":"scale(1)",transform:"scale(1)"}).on("transitionend webkitTransitionEnd",function(){$(this).css({"-webkit-transform-origin":"0px 0px","transform-origin":"0px 0px"})}).off("transitionend webkitTransitionEnd")}};return g});