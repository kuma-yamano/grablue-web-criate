define(["backbone","model/content","model/quest/create-quest-model","view/quest/list-abstract","model/data","model/token-data","model/quest/actionpoint-model","view/popup","util/page-slider","util/language-message"],function(a,b,c,d,e,f,g,h,i,j){var k=1,l=d.extend({selectedRarity:1,shouldShowPickList:!1,events:{"tap .lis-quest-list:not('.ico-clear')":"onSelectQuest","tap .pop-numbers-continue .btn-usual-ok":"onSelectQuest","tap .pop-numbers-continue .btn-usual-cancel":"popRemove","tap .pop-treasure-raid .btn-offer":"eventpointCheck","tap .pop-treasure-raid .btn-usual-cancel":"popRemove","tap .btn-synopsis":"popSynopsis","tap .pop-synopsis .btn-usual-ok":"popRemove","tap .popRestartQuest .btn-usual-cancel":"popRemove","tap .popRestartQuest .btn-usual-ok":"questRestartPopupOk","tap .pop-npc .btn-usual-ok":"popRemove","change .pop-can-not-multi-battle .frm-check-caution":"toggleOKBtn","tap .pop-can-not-multi-battle .btn-usual-ok.start-fate:not(.disable)":"onStartFateEposode","tap .popRestartQuest .btn-withdraw":"getRrewardInfo","tap .pop-result-withdraw .btn-usual-cancel":"comfirmRestartQuest","tap .pop-result-withdraw:not(.retire) .btn-usual-ok":"questRetire","tap .pop-result-withdraw.retire .btn-usual-ok":"questArcarumRetire","tap .pop-arcarum-retire .btn-usual-ok":"questRetire","tap .pop-arcarum-retire .btn-usual-cancel":"removeConfirmRetire","tap .pop-retire .prt-popup-footer .btn-usual-ok":"popupQuestRetireRemove","selectedQuest .lis-quest-list":"onSelectQuest","tap .fate-continue .btn-usual-cancel":"continueFatePopCancel","tap .fate-continue .btn-usual-ok":"continueFatePopOk","change #prt-select-rarity .frm-list-select":"changeSort","tap .pop-added-episode .btn-usual-ok":"popRemove","tap .btn-prev-top":"pagination","tap .btn-prev":"pagination","tap .btn-forward":"pagination","tap .btn-forward-last":"pagination","tap .btn-page-number":"pagination"},initialize:function(a){this.content_bind(),_.extend(this,a),this.getContent()},getContent:function(a){var c={page:k};this.popArcarumNpcId&&(c.filter=null,c.character_id=this.popArcarumNpcId);var d=new b({controller:"quest",action:"newfate",param:c});this.stopListening(d,"sync"),this.listenToOnce(d,"sync",this.setInitList),d.fetch()},setInitList:function(a){var b=a.toJSON().option,c={};if(!b.popup){var d=b.quest.init_list;c=b.quest.fate_list,this.init(),this.questListInitModel.set(d)}this.render(a,c,b)},render:function(a,b,c){return this.content_render(a),$(".prt-head-current").html(j.getMessage("quest_91")),this.status_render(c.user_status),c.popup?this.popInitListErrorPop(c.popup):(this.fate_render(b),_.size(c.quest.pick_episode_intro_list.list)>0&&(this.shouldShowPickList=!0,this.renderPickEpisodeList(c.quest.pick_episode_intro_list),this.showPickEpisodeList(b.paging.page)),_.isUndefined(this.id)===!1&&+this.id>0?this.getFateContinue():this.nextEpisodeId&&this.getAbilityEpisodeData()),this.trigger("loadEnd"),this.popArcarumNpcId&&this.popAddedEpisode(c.quest.fate_list.fate_info),this},popInitListErrorPop:function(a){Game.view.trigger("popup_error",{data:a})},getFateList:function(a){var b=this,c=Game.baseUri+"quest/fate_list/",d=new(e.extend({urlRoot:c}));this.stopListening(d,"sync"),this.listenTo(d,"sync",function(a){b.fate_render(a.toJSON())}),this.getFateList=function(a){b.trigger("xhrStart"),d.urlRoot=c+a+"/"+b.selectedRarity,d.fetch()},this.getFateList(a)},fate_render:function(a){this.$el.find(".prt-fate-list").html(decodeURIComponent(a.tpl)),this.selectedRarity=a.filter_type,$("#prt-select-rarity").html(_.template($("#tpl-prt-select-rarity").html(),{selectedRarity:this.selectedRarity})),i.render(a.paging,!0),this.showPickEpisodeList(a.paging.page),this.trigger("xhrEnd")},renderPickEpisodeList:function(a){$("#prt-pick-episode").html(_.template($("#tpl-prt-pick-episode").html(),{episodeList:a.list,period:a.closest_end_data}))},showPickEpisodeList:function(a){var b=$("#prt-pick-episode");b.removeClass("show"),this.shouldShowPickList===!0&&+a===k&&b.addClass("show")},status_render:function(a){this.$el.find(".prt-user-status").html(_.template($("#status").html(),a)),this.numRepStatus($(".txt-stamina-value"),"num-stamina"),this.bp_replace($(".prt-user-bp-value"),$(".prt-user-bp-value").attr("title"))},ap_replace:function(a){a.html(""),a.each(function(){for(var a=$(this).attr("data-ap"),b=0;a>b;b++)$(this).append("<span class='ico-ap' />")})},changeSort:function(a){this.selectedRarity=+$(a.currentTarget).find("option:selected").val(),this.getFateList(1)},pagination:function(a){if("false"==$(a.currentTarget).attr("disable")){var b=$(a.currentTarget).attr("page");this.getFateList(b),this.stopEventPropagation(a,!0)}},onSelectQuest:function(a){this.reSelectQuest=a;var b=$(a.currentTarget);this.deck_id=null,this.chapterId=b.data("chapter-id"),this.chapterName=b.data("chapter-name"),this.questId=b.data("quest-id"),this.questType=b.data("type"),this.quest_ap=b.data("ap"),this.sceneId=b.data("scene-id"),this.returnId=b.data("return_id"),this.rank=b.data("rank"),this.isSceneOnly=b.data("scene-only"),this.isStartAtOnce=b.data("start-at-once"),this.useItemId=b.data("use-item-id"),this.clearCount=b.data("clear-count"),this.areaCount=b.data("area-count"),this.isSidestory=b.data("is-sidestory"),this.noSkillBattle=b.data("no-skill-battle"),this.noGuildSupportBattle=b.data("no-guild-support-battle");var c=b.data("ico-progress"),d=b.data("is-quest-open"),e=b.data("ignore-open-chapter"),f=b.data("open-chapter-name"),g=b.data("open-chapter-type"),h=b.data("open-chapter-id"),i=b.data("ignore-open-message");this.startNumbersName=b.data("start-numbers-name"),this.numbersBattleContinue=b.data("numbers-battle-continue"),this.numbersBattleId=b.data("numbers-battle-id"),this.isDispStartPopup=!!b.data("is-disp-start-popup"),this.startPUType=b.data("start-popup-type");var k=b.data("is-clear-recommend-chapter"),l=_.isUndefined(k)===!1,m=l===!0&&0===k,n=0===d;if((n===!0||m===!0)&&!c){this.cautionPopTitle=j.getMessage("quest_92");var o=b.data("is-open-event-chapter"),p=b.data("open-event-name");1!==o&&(e!==!0&&n===!1&&m===!0&&(e=!0),l===!0&&n===!0&&(e=!1));var q={isOpenEventChapter:o,openEventName:p,openEventComment:b.data("open-event-comment"),openChapterName:f,openChapterType:+g,openChapterId:+h,ignoreOpenMessage:i,isSidestory:""!==this.isSidestory,ignoreOpenChapterFlg:e,showRecommendChapter:m,showOpenChapter:n};m===!0&&(q.recommendChapterName=b.data("recommend-chapter-name"),q.recommendChapterId=b.data("recommend-chapter-id"),q.recommendChapterType=b.data("recommend-chapter-type"));var r=_.template($("#tpl-quest-condition-open").html(),q),s=e?"fate":void 0;return this.reSelectQuest.preventDefault(),void this.cautionPop(r,s)}this.startFateEposode(c)},onStartFateEposode:function(){this.startFateEposode()},startFateEposode:function(a){a=a||!1;var b=this;if(a)b.questRestart(this.reSelectQuest,this.questId,this.questType,this.sceneId,null,a,null,this.isSceneOnly,this.isStartAtOnce);else{if(this.isDispStartPopup)return void this.questTreasureRaid();if(this.numbersBattleId&&!this.numbersBattleContinue)return void this.numbersContinue();this.startQuestCheck(this.reSelectQuest,function(){Game.loading.xhrStart();var a=function(a){return _.isUndefined(a)!==!0&&a.ap_over===!0?(Game.loading.xhrEnd(),void b.popShortageAp()):void(b.scene_id?(this.check_npc_model=new(e.extend({urlRoot:Game.baseUri+"quest/check_temporary_npc"})),this.check_npc_model.on("sync",function(a){if(Game.loading.xhrEnd(),null==a.get("np_npc"))b.locationSupporter();else{var c="<div class='txt-caution'>"+j.getMessage("quest_15")+"</div><div class='prt-np'>"+j.replaceMessage("quest_95",[a.get("np_npc")])+"</div>";b.popView=new h({className:"pop-npc",title:j.getMessage("quest_135"),body:c,flagBtnCancel:0,flagBtnOk:1}),b.popView.render().popShow()}}),this.check_npc_model.fetch()):(Game.loading.xhrEnd(),b.locationSupporter()))};b.actionpointCheck(b.reSelectQuest,a)})}},continueAbilityEpisode:function(a){this.onSelectQuest(a)},getFateContinue:function(){this.trigger("xhrStart");var a=new(e.extend({urlRoot:Game.baseUri+"quest/fate_continue/"+this.id}));this.listenToOnce(a,"sync",this.continueFatePop),a.fetch()},continueFatePop:function(a){var b=this.fateDetail=a.toJSON();b.is_open&&(this.popView=new h({className:"fate-continue",title:b.chapter_name,body:_.template($("#tpl-fate-continue-pop").html(),{data:b}),flagBtnOk:1,flagBtnCancel:1}),this.popView.render(),this.popView.popShow()),this.trigger("xhrEnd")},continueFateActionpointCheck:function(a,b,c,d,e){this.continueFateActionpointCheck=new g({quest_id:b,progress:null,type:c,quest_ap:d,chapter_name:e}),this.continueFateActionpointCheck.check_quest(a),this.listenEventAndCall("completeUseRecoveryItems",$("#wrapper"),a)},continueFatePopOk:function(){var a=this;if(this.isStartAtOnce=this.fateDetail.next_start_at_once||0,this.isSceneOnly=this.fateDetail.is_only_scene_scenario||0,this.sceneId=this.fateDetail.scene_id,this.questId=this.fateDetail.next_id,this.questType=this.fateDetail.type,this.quest_ap=this.fateDetail.action_point,this.chapterId=this.fateDetail.chapter_id,this.chapterName=this.fateDetail.chapter_name,this.clearCount=this.fateDetail.clear_quest_count,this.areaCount=this.fateDetail.area_quest_count,this.noSkillBattle=this.fateDetail.no_skill_battle,this.noGuildSupportBattle=this.fateDetail.no_guild_support_battle,this.numbersBattleId=this.fateDetail.numbers_battle_id||0,this.numbersBattleId)return void this.numbersContinue();var b=new(e.extend({urlRoot:Game.baseUri+"quest/check_quest_start/"+this.fateDetail.chapter_id+"/"+this.fateDetail.type+"/"+this.fateDetail.next_id}));this.stopListening(b,"sync"),this.listenToOnce(b,"sync",function(b){var c=function(){a.locationSupporter()};a.continueFateActionpointCheck(c,a.questId,a.questType,a.quest_ap,a.fateDetail.chapter_name)}),b.fetch()},continueFatePopCancel:function(){this.popView.popRemove()},getAbilityEpisodeData:function(){this.trigger("xhrStart");var a=new(e.extend({urlRoot:Game.baseUri+"rest/quest/fate_list_ability_popup/"+this.nextEpisodeId}));this.listenToOnce(a,"sync",this.popAbilityEpisode),a.fetch()},popAbilityEpisode:function(a){var b=this.fateDetail=a.toJSON();this.popView=new h({className:"fate-continue",title:b.chapter_name,body:_.template($("#tpl-fate-continue-pop").html(),{data:b}),flagBtnOk:1,flagBtnCancel:1}),this.popView.render().popShow(),this.trigger("xhrEnd")},questTreasureRaid:function(){var a=new(e.extend({urlRoot:Game.baseUri+"quest/treasure_raid/"+this.chapterId+"/"+this.questId}));this.stopListening(a,"sync"),this.listenToOnce(a,"sync",this.renderTreasureRaid),Game.loading.xhrStart(),a.fetch()},renderTreasureRaid:function(a){Game.loading.xhrEnd();var b=a.toJSON();b.isOnlySceneScenario=this.isSceneOnly,b.startAtOnce=this.isStartAtOnce,b.noSkillBattle=this.noSkillBattle,b.noGuildSupportBattle=this.noGuildSupportBattle,this.popTreasureRaid(b)},popTreasureRaid:function(a){a.startPUType=this.startPUType,this.popView=new h({className:"pop-treasure-raid single-battle",title:a.chapter_name,body:_.template($("#tpl-use-treasure").html(),a),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.popView.$el.find(".prt-popup-footer").append(_.template($("#tpl-button-use-treasure").html(),a)),this.popView.popShow()},eventpointCheck:function(a){var b=this,c=a,d=$(c.currentTarget),f=new(e.extend({urlRoot:Game.baseUri+"quest/treasure_check_item/"+d.data("chapter-id")+"/"+d.data("use-item-type")}));this.stopListening(f,"sync"),this.listenToOnce(f,"sync",function(d){b.startQuestCheck(c,function(){b.actionpointCheck(a,function(a){_.isUndefined(a)!==!0&&a.ap_over===!0?b.popShortageAp():b.locationSupporter()})})}),f.fetch()},numbersContinue:function(){Game.loading.xhrEnd();var a={chapter_id:this.chapterId,chapter_name:this.chapterName,quest_id:this.questId,type:this.questType,action_point:this.quest_ap,level:this.rank||1,clearCount:this.clearCount,areaCount:this.areaCount,isOnlySceneScenario:this.isSceneOnly,startAtOnce:this.isStartAtOnce,noSkillBattle:this.noSkillBattle,noGuildSupportBattle:this.noGuildSupportBattle,numbersBattleId:this.numbersBattleId,numbersBattleContinue:1};this.popNumbersContinue(a)},popNumbersContinue:function(a){this.popView=new h({className:"pop-numbers-continue",title:a.chapter_name,body:_.template($("#tpl-numbers-continue").html(),a),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.popView.$el.find(".prt-popup-footer").append(_.template($("#tpl-button-numbers-continue").html(),a)),this.popView.popShow()},startAtOnceCreateQuest:function(){var a=$("#cnt-quest").data("duplicate-key")||$("#cnt-detail").data("duplicate-key"),b={deck_id:null,quest_id:this.questId,quest_type:this.questType,supporter_user_id:"",supporter_attribute_id:"",duplicate_key:a,use_item_id:this.useItemId||0},d=new c;this.stopListening(d,"sync"),this.listenToOnce(d,"sync",this.locationDirectQuest),d.set(b),d.save()},locationSupporter:function(){if(this.isSceneOnly||(this.isSceneOnly=0),this.isStartAtOnce||(this.isStartAtOnce=0),this.isWithoutSummon||(this.isWithoutSummon=0),this.noSkillBattle||(this.noSkillBattle=0),this.noGuildSupportBattle||(this.noGuildSupportBattle=0),this.noSkillBattle&&this.noGuildSupportBattle||this.startNumbersName){var a="pop-start-numbers-fate",b=j.getMessage("quest_10"),c=j.getMessage("quest_numbers_fate_1");this.startNumbersName&&(c=_.template($("#tpl-pop-start-numbers-name").html(),{startNumbersName:this.startNumbersName})),this.popQuestSupporter(a,b,c)}else if(1==this.isSceneOnly)if(+this.quest_ap>0){var a="pop-use-ap-scene",b=j.getMessage("quest_abstract_1"),c=j.replaceMessage("quest_abstract_3",[this.quest_ap]);this.popQuestSupporter(a,b,c)}else Game.loading.xhrStart(),this.sceneOnlyCreateQuest();else if(1==this.isStartAtOnce)if(+this.quest_ap>0){var d=0===+this.isWithoutSummon?"quest_abstract_2":"quest_without_summon_1",a="pop-startatonce",b=j.getMessage("quest_abstract_1"),c=j.replaceMessage(d,[this.quest_ap]);this.popQuestSupporter(a,b,c)}else Game.loading.xhrStart(),this.startAtOnceCreateQuest();else this.questSupporter()},popQuestSupporter:function(a,b,c){var d=this,e=new h({className:a,title:b,body:c,flagBtnCancel:1,flagBtnOk:1});e.render().popShow(),this.listenToOnce(e,"ok",function(){d.stopListening(e,"cancel"),1==d.isSceneOnly?d.sceneOnlyCreateQuest():1==d.isStartAtOnce?d.startAtOnceCreateQuest():d.questSupporter()}),this.listenToOnce(e,"cancel",function(){e.popRemove()})},questSupporter:function(){this.content_close(),this.treasureId?a.history.navigate("quest/supporter/"+this.questId+"/"+this.questType+"/0/"+this.treasureId,!0):a.history.navigate("quest/supporter/"+this.questId+"/"+this.questType,!0)},locationStage:function(){this.content_close(),a.history.navigate("quest/stage",!0)},popSynopsis:function(a){var b=$(a.currentTarget).parent(".prt-list-contents").find(".btn-quest-list"),c="",d="",e=b.data("ng-attribute-names");if(e){var f=e.split(",");_.each(f,function(a){c+=j.replaceMessage("quest_14",[a])})}var g=b.data("ng-npc-names");if(g){var i=g.split(",");_.each(i,function(a){c+=a+"<br>"})}var k=b.data("start-attribute-names");if(k){var l=k.split(",");_.each(l,function(a){d+=j.replaceMessage("quest_14",[a])})}var m=b.data("start-npc-names");if(m){var n=m.split(",");_.each(n,function(a){d+=a+"<br>"})}var o=b.data("start-rarity-names");if(o){var p=o.split(",");_.each(p,function(a){d+=a+"<br>"})}var q=b.data("start-tribe-names");if(q){var r=q.split(",");_.each(r,function(a){d+=a+"<br>"})}var s=b.data("start-job-names");s&&(d+=s+"<br>"),1==b.data("quest_once_flag")&&(c+=j.getMessage("quest_21"),d+=j.getMessage("quest_21"));var t={synopsis:b.data("synopsis"),rank:b.data("rank"),use_item_name:b.data("use-item-name"),use_item_consume:b.data("use-item-consume"),use_money:b.data("use_money"),limited_count:b.data("limited_count"),start_main_weapon_names:b.data("start-main-weapon-names"),start_npc_weapon_names:b.data("start-npc-weapon-names"),ng_names:c,start_names:d,startNumbersName:b.data("start-numbers-name"),no_skill_battle:b.data("no-skill-battle"),no_guild_support_battle:b.data("no-guild-support-battle"),synopsisWhite:+b.data("synopsis-white")||0},u=b.find(".txt-quest-title").text(),v=_.template($("#tpl-quest-information").html(),t);this.popView=new h({className:"pop-synopsis",title:u,body:v,flagBtnCancel:0,flagBtnOk:1}),this.popView.render(),this.popView.popShow()},questStart:function(a){var b=$(".btn-quest-list").data("duplicate-key"),d=new c;this.stopListening(d,"sync"),this.listenToOnce(d,"sync",this.location_scene),d.set("deck_id",this.deck_id),d.set("quest_id",this.questId),d.set("quest_type",this.questType),d.set("supporter_user_id",""),d.set("duplicate_key",b),d.save()},popRemove:function(){this.popView.popRemove()},location_scene:function(b){1==b.get("ng_summon_time_over")?this.faildCreateQuestPop(b):(this.content_close(),a.history.navigate("quest/scene/"+this.sceneId+"/3",!0))},popupQuestRetireRemove:function(){this.popView&&this.popRemove()},removeConfirmRetire:function(){var a=null;this.progressQuestInfo&&(a=this.progressQuestInfo.quest_type),this.comfirmRestartQuest(a)},toggleOKBtn:function(a){var b=this.popView.$el.find(".frm-check-caution").is(":checked");this.popView.$el.find(".btn-usual-ok").toggleClass("disable btn-silent-se",!b)},popAddedEpisode:function(a){this.popView=new h({className:"pop-added-episode",title:j.getMessage("pop_episode_added_title"),body:_.template($("#tpl-pop-added-episode").html(),a),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()}});return l});